# 密码盗窃。

> 原文：<https://dev.to/dwd/cryptoheist-37ej>

## 抢劫案

[![Security bypass technique in Hatton Garden](../Images/586525a6de5d013078fcdfe4671e452e.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--Dha5uB9f--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/evb0iamoy35j01kfq58s.jpg)

周二，一个犯罪团伙公布了公共加密货币钱包提供商“MyEtherWallet”的 DNS 服务器的 BGP 路由，重定向互联网上的流量，并允许它们响应对该服务的 web 请求。

用户点击通过证书警告，并让罪犯访问他们的钱包，失去了他们的钱。

作为一种区块链加密货币，这些转账已被记录到一个现有的身份中，该身份被分配了大约 1740 万美元。事实证明犯罪确实是有回报的。

## 这有多糟糕？

该网站已经使用 HTTPS，用户自愿忽略证书警告。但值得注意的是，犯罪分子证明了他们可以在互联网的 IP 路由层不受惩罚地行动——如此低水平的流量控制意味着许多基本的安全措施可能不起作用。

但是，其他人可能有——因此，如果您正在运行一个高安全性的服务，您能做些什么来防止这种攻击呢？

## BGP 劫持

边界网关协议是用于在 ISP 之间路由流量的协议(和系统)。每个 ISP 在内部以他们想要的方式路由流量，但是在他们网络的边缘，他们交换关于他们能处理什么流量的信息。

在某些情况下，这是去往他们运营的网络的流量，而在其他情况下，这是去往他们连接的网络的流量，并且愿意为其提供中转。在这两种情况下，它们都会通告路由(以及它们将使用的自治系统路径)。

在 BGP 劫持中，攻击者公布他们并不真正拥有的路由，然后拦截流量。流量仍然流向同一个 IP 地址，因为攻击者现在控制了该地址，所以他们可以以 IP 地址的任何方式响应该级别的流量。

这意味着传统的 IP 欺骗防御不再有效。

端点不容易检测到这种攻击，您必须依靠更高级别的保护。

在这个特殊的例子中，攻击者劫持了 MyEtherWallet 的 DNS 服务，因此可以提供虚假的响应——但是他们也可以劫持服务本身，让用户连接到同一个 IP 地址。

那么，如何保护您的服务呢？系上你的安全呼吸管，让我们来一次深潜到一些字母汤里。

## HTTPS

放入一个适当的、合法的证书是你的第一步。在这种情况下，这样做了。

的确，用户不应该点击安全警告，但在这种情况下，他们显然是这样做的。

## HSTS

HTTP 严格传输安全允许网站运营商指示网站将在一段时间内使用有效证书，通常很长。

如果 MyEtherWallet 使用了这一行标题，这种特殊的攻击就会被阻止——启用了 HSTS 的站点将不再允许用户点击通过安全警告。

但是更糟糕的是，因为罪犯能够控制 BGP 路由，他们可以从真实的 CA 获得合法的证书。在这种情况下，根本不会有任何警告。

他们可以这样做，因为低级的“域名验证”会检查他们是否控制了 DNS *和*服务器——他们可以这样做——然后给他们颁发一个完全真实的证书。如果攻击者控制了真实服务器的 IP 地址，HSTS 和明智的用户都不会有所帮助。

## CAA

证书颁发机构授权记录是 DNS 记录，它告诉 CA 允许哪些 CA 为域颁发证书。要求为 MyEtherWallet 提供证书的 CA 将查找该域的 CAA 记录，并检查是否允许它这样做。

CAA 记录是由为 CAs 工作的人开发的，所以它们得到了很好的支持——尽管你需要一个支持它们的 DNS 提供商。

显然，这是一个好主意，但在这种情况下还不够——攻击者实际上破坏了整个 DNS 服务，这意味着 CAA 记录即使存在，也会在攻击者的控制之下。

## [数据](#dane)

DANE 记录也是 DNS 记录，这一次它告诉客户可以从 TLS 证书中得到什么。它们是强大的记录，将补充或取代传统的 CA。

然而，浏览器或 DNS 提供商并不支持它们；如果是这样的话，这些显然是有用的。

但是，再次，DNS 是完全颠覆了这里——然而，丹麦记录依赖于 DNSSEC，所以也许不是所有的损失。

## DNSSEC

DNSSEC 是一套保护 DNS 的标准。他们是记录安全，而不是传输安全-所以你可以看看 DNS 记录，知道它是不是真的。

DNSSEC 将使攻击者很难破坏 DNS，即使是 BGP 劫持。一旦做到这一点，这也意味着 CAA 记录和 DANE 记录都是可靠的，使得攻击者即使劫持 BGP 也很难破坏 TLS。

不幸的是，现在许多注册商、DNS 提供商，甚至顶级域名都不支持 DNSSEC，甚至许多域名解析商也懒得检查。在这种情况下，攻击者将流量重新路由到亚马逊的 Route53，它不支持 DNSSEC。

## CT

证书透明性是另一个有用的技巧。这意味着 CA 会发布一个日志，记录它们颁发的证书，这样网站所有者就可以监控 CA 颁发的他们不知道的证书。

这是一个有用的审计工具，虽然它不会阻止任何事情，但它确实意味着犯罪活动的窗口变小了。

## HPKP

网站还可以在标题中提供有关哪些证书有效以及证书可能如何变化的信息。HTTP 公钥密码意味着您网站的常规访问者可以验证您(网站所有者)希望他们看到的证书。

有些浏览器会自动缓存这些数据，并拒绝这些数据；但是事情是这样的——谷歌 Chrome 正在放弃对此的支持，转而支持基于 CT 的系统。老实说，我不知道 CT 如何取代它。我就当是我在安全方面不懂的很多事情之一吧。

## 其他协议

到目前为止，我们实际上只看了 HTTP。但是还有其他协议...这些在 BGP 劫持攻击中有多安全？

HTTP 基本上所有的安全性都依赖于 TLS，虽然该协议支持身份验证，但传统上身份验证是在 webapp 内部以定制的方式实现的，而不是在协议层实现的。但是，其他协议倾向于将身份验证作为一个强制性的首要功能，因此从中获得了很大的安全性——尤其是因为许多旧的身份验证机制是基于 TLS 可能根本不存在的基础上设计的，因此如果 TLS 受到威胁，可以更好地应对。

例如，XMPP 需要带有有效证书的 TLS(现在，大多数人都是这样部署的)。但是它也要求服务器实现“SCRAM ”,它自己验证连接的两端。SCRAM 是一种 SASL 机制，而 SASL 是除 HTTP 之外的每个协议或多或少用来执行身份验证的子协议。

这意味着攻击者不能作为替代端点，而是作为中间人，允许用户通过他们进行身份验证，然后接管连接。当然，这完全在攻击者的能力范围之内。

但是，急停有两种形式——“急停-SHA-1”和“急停-SHA-1-PLUS”。提供后者的服务器可以通过一种称为通道绑定的机制来检测是否存在 MITM。(顺便说一下，它们之间的降级攻击也受到保护。

不严格地说，信道绑定通过在 SASL 机制中包含 TLS 协商流量来工作，因此两端都知道它们协商了同一个 TLS 会话。因此，攻击者不能再充当 MITM——他们不能与真实的服务器建立与客户端看到的相同的新 TLS 会话。

遗憾的是，通道绑定没有很好地实现——HTTP 不支持它，因此 TLS 栈并不总是提供所需的数据。举个例子，你根本不能在浏览器中这样做，在 Java 中也不行(因此在 Android 上也不行)。但是在它工作的地方，XMPP(以及其他 SASL 使用的协议，如 IMAP、SMTP、LDAP，甚至 PostgresQL 数据库)可以相对容易地得到保护——甚至可能已经可以抵御 BGP 劫持攻击。

## 告诫

一如既往，我(真的)不是安全专家。下面的任何评论都是这篇文章的一部分，而且很可能(希望！)包括更正和澄清。