# æƒ¯ç”¨çš„ JavaScript åç«¯ã€‚ç¬¬äºŒéƒ¨åˆ†

> åŸæ–‡:[https://dev . to/k1r0s/idiomatic-JavaScript-back end-part-2-4 lhe](https://dev.to/k1r0s/idiomatic-javascript-backend-part-2-4lhe)

å¤§å®¶å¥½ï¼ç³»åˆ—çš„è¿™ä¸€éƒ¨åˆ†**æƒ¯ç”¨ JavaScript åç«¯**ã€‚

[1/3 éƒ¨åˆ†](https://dev.to/k1r0s/idiomatic-javascript-backend-part-1-4g0b)
3/3 éƒ¨åˆ†

### [](#important-information)é‡è¦ä¿¡æ¯

ä¸ºäº†è·å¾—æœ€ä½³ä½“éªŒï¼Œè¯·å¤åˆ¶æ­¤å›è´­:[https://github.com/k1r0s/ritley-tutorial](https://github.com/k1r0s/ritley-tutorial)ã€‚å®ƒåŒ…å«äº† **git æ ‡ç­¾**ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥éå†ä¸åŒçš„æäº¤ï¼Œä»¥ä¾¿æ­£ç¡®åœ°éµå¾ªæœ¬æ•™ç¨‹:

```
$ git tag

1.preparing-the-env
2.connecting-a-persistance-layer
3.improving-project-structure
4.creating-entity-models
5.handling-errors
6.creating-and-managing-sessions
7.separation-of-concerns
8.everybody-concern-scalability 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è½¬åˆ°ç‰¹å®šæ ‡ç­¾

```
$ git checkout 1.preparing-the-env 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è½¬åˆ°æœ€è¿‘ä¸€æ¬¡æäº¤

```
$ git checkout master 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æŸ¥çœ‹æ–‡ä»¶å¤¹`src`
ä¸Šæ ‡ç­¾ä¹‹é—´çš„å·®å¼‚

```
$ git diff 1.preparing-the-env 2.connecting-a-persistance-layer src 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

* * *

# [](#4-creating-entity-models)4ã€‚åˆ›å»ºå®ä½“æ¨¡å‹

Ritley å¹¶æ²¡æœ‰å‘Šè¯‰ä½ å¦‚ä½•æ„å»ºå®ä½“æ¨¡å‹ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬å…³å¿ƒçš„ï¼Œæ‰€ä»¥æˆ‘ä¼šå°½é‡ç®€çŸ­ã€‚

æ¨¡å‹å°è£…äº†ä¸é¢†åŸŸç›¸å…³çš„æ‰€æœ‰é€»è¾‘ã€‚ä¾‹å¦‚åˆ›å»ºç”¨æˆ·ã€åŠ å¯†å¯†ç ã€éªŒè¯å­—æ®µç­‰ã€‚è€Œèµ„æºå°†è¿™ä¸ªé€»è¾‘ç¿»è¯‘æˆ HTTP å±‚ã€‚

æˆ‘ä»¬çš„ç¬¬ä¸€æ¬¾è½¦å‹å°†å®šä½äº`src/models/user.model.js` :

```
import DataService from "../services/database.service";
import EncryptService from "../services/encrypt.service";
import { Provider, Dependency } from "@ritley/decorators";

@Provider.factory
@Dependency("database", DataService)
@Dependency("encrypt", EncryptService)
export default class UserModel {

  static userPublicPredicate = collection => collection.map(({ pass, ...user }) => ({
    ...user
  }))

  validate(payload) {
    const requiredProps = ["name", "pass", "mail"];
    const props = Object.keys(payload);
    if(requiredProps.every(prop => props.includes(prop))) {
      return Promise.resolve();
    } else {
      return Promise.reject();
    }
  }

  create(payload) {
    const pass = this.encrypt.encode(payload.pass);
    return this.database.create("users", { ...payload, pass });
  }

  isUnique({ mail }) {
    return new Promise((resolve, reject) =>
      this.database.exists("users", { mail }).then(reject, resolve));
  }

  searchBy(predicate) {
    return this.readUsers(predicate).then(UserModel.userPublicPredicate);
  }

  readUsers(predicate) {
    if(predicate) {
      return this.database.filter("users", predicate);
    } else {
      return this.database.read("users");
    }
  }

  update(uid, { mail, name }) {
    return this.database.update("users", { uid }, { mail, name });
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬åˆšåˆšå®ç°äº†è®¸å¤šç¨åä¼šç”¨åˆ°çš„æ–¹æ³•ï¼Œç°åœ¨æˆ‘ä»¬å°†ä½¿ç”¨`validate`ã€`isUnique`å’Œ`create`æ¥æ»¡è¶³[å…³äºç”¨æˆ·åˆ›å»ºçš„éœ€æ±‚](https://github.com/k1r0s/ritley-tutorial/blob/master/REQUIREMENTS.md)ã€‚

æ³¨æ„ï¼Œæˆ‘ä»¬å·²ç»åŒ…å«äº†ä¸€ä¸ªæ–°çš„[å¯†ç åŠ å¯†](https://www.npmjs.com/package/cpass)åŒ…ã€‚

åŒæ ·ï¼Œæ‰€æœ‰éä¸»é¢˜åŒ…éƒ½åªæ˜¯å ä½ç¬¦ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»»ä½•å…¶ä»–ä½ å–œæ¬¢çš„:)

æˆ‘ä»¬è·‘:`$ npm install cpass`

ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹`src/resources/user.resource.js` :

```
 import { AbstractResource } from "@ritley/core";
-import DataService from "../services/database.service"; +import UserModel from "../models/user.model"; 
-import { Dependency, ReqTransformBodySync } from "@ritley/decorators";
+import { Dependency, ReqTransformBodyAsync } from "@ritley/decorators"; 
-@Dependency("database", DataService)
+@Dependency("userModel", UserModel)
 export default class UserResource extends AbstractResource {
   constructor() {
     super("/users");
   }

-  @ReqTransformBodySync
-  post(req, res) {
-    const payload = req.body.toJSON();
-    this.database.create("users", payload).then(user => {
-      res.statusCode = 200;
-      res.end(JSON.stringify(user));
-    }); +  @ReqTransformBodyAsync
+  async post(req, res) {
+    const body = await req.body;
+    const payload = body.toJSON();
+    await this.userModel.validate(payload);
+    await this.userModel.isUnique(payload);
+    const user = await this.userModel.create(payload);
+    res.statusCode = 200;
+    res.end(JSON.stringify(user));
   }
 } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­£å¦‚æˆ‘ä¹‹å‰è¯´è¿‡çš„ï¼Œä½¿ç”¨ async/await ç‰¹æ€§å°†æˆ‘ä»¬çš„`post`æ–¹æ³•è½¬æ¢ä¸ºä¸€ä¸ªæ‰¿è¯ºï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ä½¿ç”¨ **@ReqTransformBodyAsync** è€Œä¸æ˜¯ä¹‹å‰çš„@ReqTransformBodySyncã€‚ç¬¬ä¸€ä¸ªæ˜¯åŸºäº*æ‰¿è¯ºçš„*ï¼Œæ‰€ä»¥å°†å®ƒä¸ async/await ä»£ç ä¸€èµ·ä½¿ç”¨æ˜¯æœ‰æ„ä¹‰çš„ï¼Œæ¯”å¦‚å‰é¢çš„ä»£ç ç‰‡æ®µã€‚

å½“ç„¶ï¼Œæˆ‘ä»¬å·²ç»ä»èµ„æºä¸­ç§»é™¤äº†`this.database`è°ƒç”¨å’Œæ•°æ®æœåŠ¡ã€‚æ‚¨ä¸æƒ³å¼„ä¹± http å±‚ä¸Šçš„æŒä¹…å±‚ï¼›)

æˆ‘ä»¬çš„æœåŠ¡ç°åœ¨æ»¡è¶³äº†ç”¨æˆ·åˆ›å»ºçš„è¦æ±‚ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œç¼ºå°‘å¼‚å¸¸å¤„ç†ã€‚å¦‚æœ JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œæœ‰æ•ˆè½½è·ä¸åŒ…å«å¿…å¡«å­—æ®µï¼Œå‡è®¾ç”µå­é‚®ä»¶è¢«å ç”¨æˆ–å…¶ä»–æƒ…å†µï¼Œæˆ‘ä»¬å°†æŒæœ‰ä¸€ä¸ªæœªå¤„ç†çš„æ‹’ç»ï¼Œæˆ–è€…å¯èƒ½æ˜¯ä¸€ä¸ªå¼‚å¸¸å°†ç»ˆæ­¢æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºğŸ˜°

è®©æˆ‘ä»¬çœ‹çœ‹æ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆï¼

* * *

# [](#5-handling-exceptions)5ã€‚å¤„ç†å¼‚å¸¸

é‚£ä¹ˆï¼Œå½“å‡ºç°é”™è¯¯æ—¶ï¼Œå¦‚ä½•åœ¨ä»»ä½•æ—¶å€™åšå‡ºé€‚å½“çš„å“åº”å‘¢ï¼Ÿ

å—¯ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çœ‹çœ‹é‚£é‡Œ:

```
const body = await req.body;
const payload = body.toJSON();
await this.userModel.validate(payload);
await this.userModel.isUnique(payload);
const user = await this.userModel.create(payload);
res.statusCode = 200;
res.end(JSON.stringify(user)); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰€æœ‰çš„é”™è¯¯éƒ½æºäºé‚£é‡Œæˆ–éšåçš„è°ƒç”¨ï¼Œåº”è¯¥åœ¨è¿™é‡Œ(è¿™é‡Œé™„è¿‘)å¤„ç†ï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ°å‘å®¢æˆ·å‘é€åé¦ˆã€‚

ä½†æ˜¯é‚£æ˜¯ç›¸å½“å›°éš¾çš„ï¼Œå¹¶ä¸”æ¶‰åŠè®¸å¤šä½ å¯èƒ½è®¤ä¸ºçš„ä¾µæ‰°ã€‚

ä¸ºäº†æ›´å¥½åœ°ç†è§£åœ¨ nodejs ä¸­å¤„ç†åµŒå¥—æ‰¿è¯ºæ‹’ç»æ„å‘³ç€ä»€ä¹ˆï¼Œæˆ‘æ¨è[è¿™ç¯‡å…³äºæ‰¿è¯ºæ‹’ç»çš„æ–‡ç« ](http://thecodebarbarian.com/unhandled-promise-rejections-in-node.js.html)ï¼Œæˆ–è€…è‡³å°‘æ”¾åœ¨æ¡Œé¢ä¸Šã€‚

ç”¨`try ... catch`åŒ…è£…æ¯ä¸€ä¸ªå…·ä½“æ¡ˆä¾‹å¯èƒ½æ˜¯ä¸€åœºå™©æ¢¦ã€‚è®©æˆ‘ä»¬ä»å°†æ¯ä¸ªä»»åŠ¡åˆ†æˆå¤„ç†å•ä¸ªæ“ä½œçš„æ–°æ–¹æ³•å¼€å§‹ï¼Œä¾‹å¦‚æœ‰æ•ˆè½½è·è§£æ:

```
parseBody(req, res) {
  try {
    return req.body.toJSON();
  } catch (e) {
    res.statusCode = 400; // Bad Request
    res.end("payload isn't well formed");
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“ç„¶è¿™æ˜¯å¯è¡Œçš„ï¼è®©æˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯ä»€ä¹ˆæ ·å­çš„:

```
import { AbstractResource } from "@ritley/core";
import UserModel from "../models/user.model";

import { Dependency, ReqTransformBodyAsync } from "@ritley/decorators";

@Dependency("userModel", UserModel)
export default class UserResource extends AbstractResource {
  constructor(_database) {
    super("/users");
  }

  @ReqTransformBodyAsync
  async post(req, res) {
    const body = await req.body;
    const payload = this.parseBody(body, res);
    await this.validate(payload, res);
    await this.isUnique(payload, res);
    const user = await this.create(payload, res);
    res.statusCode = 200;
    res.end(JSON.stringify(user));
  }

  parseBody(body, res) {
    try {
      return body.toJSON();
    } catch (e) {
      res.statusCode = 400;
      res.end("payload isn't well formed");
    }
  }

  validate(payload, res) {
    return this.userModel.validate(payload).catch(() => {
      res.statusCode = 400;
      res.end("missing fields, required: [name, mail, pass]");
    })
  }

  isUnique(payload, res) {
    return this.userModel.isUnique(payload).catch(() => {
      res.statusCode = 409;
      res.end("mail is already taken, try another one");
    })
  }

  create(payload, res) {
    return this.userModel.create(payload).catch(() => {
      res.statusCode = 500;
      res.end("there was an error creating your user, try again");
    })
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

mmhï¼é‚£æ˜¯å·¨å¤§çš„ï¼Œä»…ä»…ä¸ºäº†æ­£ç¡®åœ°æ•æ‰å¼‚å¸¸è€Œæ‰©å±•æˆ‘ä»¬çš„ä»£ç æœ‰æ„ä¹‰å—ï¼Ÿè‰¯å¥½çš„...

å³ä½¿æˆ‘ä»¬æ­£åœ¨å¤„ç†æ¯ä¸€ä¸ªå¯èƒ½æ¶‰åŠæ‹’ç»æˆ–å¼‚å¸¸çš„ä»»åŠ¡ä¸­çš„é”™è¯¯ï¼Œæˆ‘ä»¬ä¹Ÿä¼šé‡åˆ°`UnhandledPromiseRejectionWarning`,å› ä¸ºå¼‚æ­¥ç”Ÿæˆå™¨å°†æ•´ä¸ªæ–¹æ³•åŒ…è£…æˆä¸€ä¸ªæ‰¿è¯ºï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½è‡ªå·±å¤„ç†`post`,å› ä¸ºå®ƒè¢«åº“è°ƒç”¨ï¼Œå®ƒä¸åº”è¯¥è‡ªå·±å¤„ç†ã€‚

ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„å¼‚æ­¥æ–¹æ³•ï¼Œé€šè¿‡ post è°ƒç”¨ getï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¤„ç†æ¥è‡ªå¤–éƒ¨çš„å¼‚æ­¥è°ƒç”¨ï¼Œè¿™æ˜¯ä¸€ç§å˜é€šæ–¹æ³•:

```
post(req, res) {
  this.handledPost(req, res).catch(() => console.log('rejection from inside'));
}

async handledPost() {
  ...lots of awaits that may be rejected but locally handled
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦ä¸€ä¸ªä¼˜é›…çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨æ›´å¤šçš„æŠ½è±¡ï¼Œå› ä¸ºæˆ‘ä»¬å¤šæ¬¡é‡å¤ç›¸åŒçš„æ¨¡å¼ã€‚`@ritley/decorators`æä¾›äº†ä¸€äº›ä¸ºäº†è®©æˆ‘ä»¬çš„ç”Ÿæ´»æ›´è½»æ¾ï¼Œä¾‹å¦‚:

```
 import {
+  Default,
+  Catch,
   InternalServerError,
   BadRequest,
   Conflict,
   Created
 } from "@ritley/decorators"; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è€Œä¸”å¤§æ¦‚ä¹Ÿæ²¡æœ‰å¤ªå¤šéœ€è¦è§£é‡Šçš„:

```
import { AbstractResource } from "@ritley/core";
import DataService from "../services/database.service";
import UserModel from "../models/user.model";

import {
  Dependency,
  ReqTransformBodyAsync,
  Default,
  Catch,
  InternalServerError,
  BadRequest,
  Conflict,
  Created
} from "@ritley/decorators";

@Dependency("userModel", UserModel)
export default class UserResource extends AbstractResource {
  constructor(_database) {
    super("/users");
  }

  @Default(Created)
  @ReqTransformBodyAsync
  async post(req, res) {
    const payload = await this.parseBody(req, res);
    await this.validate(payload, res);
    await this.isUnique(payload, res);
    return await this.create(payload, res);
  }

  @Catch(BadRequest, "payload isn't well formed")
  parseBody(req) {
    return req.body.then(body => body.toJSON());
  }

  @Catch(BadRequest, "missing fields, required: [name, mail, pass]")
  validate(payload) {
    return this.userModel.validate(payload);
  }

  @Catch(Conflict, "mail is already taken, try another one")
  isUnique(payload) {
    return this.userModel.isUnique(payload);
  }

  @Catch(InternalServerError, "there was an error creating your user, try again")
  create(payload) {
    return this.userModel.create(payload);
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œè¿™äº›æŠ½è±¡å‡å°‘äº†ä¸€ç‚¹æˆ‘ä»¬çš„ä»£ç åº“ï¼Œæé«˜äº†å¯è¯»æ€§ã€‚

æ‚¨å¯èƒ½æƒ³çŸ¥é“`@Catch(responseFn, content)`åœ¨æ–¹æ³•ä¸Šå¯»æ‰¾**åŒæ­¥å¼‚å¸¸**ï¼Œä½†æ˜¯ä¹Ÿæ£€æŸ¥è¿”å›å€¼æ˜¯å¦æ˜¯ä¸€ä¸ªæ‰¿è¯ºï¼Œå¦‚æœæ˜¯ï¼Œå‘å®ƒæ·»åŠ ä¸€ä¸ª`catch()`å›è°ƒã€‚è¦ä¹ˆå¤„ç†åŒæ­¥é”™è¯¯ï¼Œè¦ä¹ˆæ‹’ç»æ‰¿è¯ºï¼Œå¹¶ä¸”ç”¨æˆ‘ä»¬çš„`res <Response>`å¯¹è±¡è°ƒç”¨`responseFn`ã€‚

æ‰€ä»¥:`BadRequest, Conflict, InternalServerError, Created`...æ˜¯ç”±`@ritley/decorators`å¯¼å‡ºçš„å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ª`res <Response>`å¯¹è±¡ï¼Œå¹¶å°†æ­£ç¡®çš„æ¶ˆæ¯è§£æç»™å®¢æˆ·ç«¯ã€‚å› æ­¤ï¼Œé€šè¿‡è°ƒç”¨`BadRequest(res, "wrong!")`ï¼Œå®¢æˆ·æœºå°†æ”¶åˆ°ä¸€ä¸ªå¸¦æœ‰â€œé”™è¯¯ï¼â€çš„ HTTP 400 ä½œä¸ºä¸€ä¸ªå“åº”æœºæ„ã€‚

å¦ä¸€æ–¹é¢ï¼Œ`@Default(responseFn)`åšåŒæ ·çš„äº‹æƒ…ï¼Œä½†æ˜¯ä½¿ç”¨`then()`æ£€æŸ¥æ‰¿è¯ºè§£æã€‚å®ƒè¿˜é™„åŠ äº†ä¸€ä¸ª`catch()`æ¥é˜²æ­¢å¯èƒ½çš„æœªå¤„ç†çš„æ‹’ç»ï¼Œä½†æ˜¯å®ƒä¼šç”¨ **HTTP 500** è§£å†³è¿™æ ·çš„æƒ…å†µï¼Œå› ä¸ºé‚£ä¸ªé”™è¯¯ç¡®å®æ²¡æœ‰å¾—åˆ°å¦¥å–„å¤„ç†ã€‚

æ¢å¥è¯è¯´ï¼Œ **Default** å‘Šè¯‰æˆ‘ä»¬å¦‚æœä¸€åˆ‡é¡ºåˆ©å°†ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œè€Œ **Catch** ç”¨é”™è¯¯æ¶ˆæ¯åŒ…è£…åˆç†çš„è°ƒç”¨ï¼Œå°±åƒæ£€æŸ¥ç‚¹ä¸€æ ·ã€‚

ä½†æ˜¯è¿˜æœ‰æ›´å¤š:

```
 import { AbstractResource } from "@ritley/core";
-import UserModel from "../models/user.model"; +import UserModel, { UserValidationError, UserMailInUseError } from "../models/user.model"; 
-import { Dependency, ReqTransformBodyAsync } from "@ritley/decorators";
+import {
+  Dependency,
+  ReqTransformBodyAsync,
+  Default,
+  Throws,
+  InternalServerError,
+  BadRequest,
+  Conflict,
+  Created
+} from "@ritley/decorators"; 
 @Dependency("userModel", UserModel)
 export default class UserResource extends AbstractResource {
@@ -9,14 +18,16 @@ export default class UserResource extends AbstractResource {
     super("/users");
   }

+  @Throws(SyntaxError, BadRequest)
+  @Throws(UserValidationError, BadRequest)
+  @Throws(UserMailInUseError, Conflict)
+  @Default(Created)
   @ReqTransformBodyAsync
   async post(req, res) {
     const body = await req.body;
     const payload = body.toJSON();
     await this.userModel.validate(payload);
     await this.userModel.isUnique(payload);
-    const user = await this.userModel.create(payload);
-    res.statusCode = 200;
-    res.end(JSON.stringify(user)); +    return this.userModel.create(payload);
   }
 } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨å¯ä»¥ä½¿ç”¨`@Throws` decorator æ˜ç¡®åœ°å‘Šè¯‰æˆ‘ä»¬å°†ä¼šé‡åˆ°å“ªç§ç±»å‹çš„å¼‚å¸¸ï¼Œä»¥ä¾¿è§¦å‘å¯¹å®¢æˆ·ç«¯çš„ç‰¹å®šå“åº”ã€‚ä»¤äººéœ‡æƒŠï¼Œå¯¹å§ï¼Ÿ

çœ‹çœ‹æˆ‘ä»¬æ˜¯å¦‚ä½•ä»æˆ‘ä»¬çš„æ¨¡å‹å±‚`src/models/user.model.js` :
å¯¼å‡ºå®šåˆ¶é”™è¯¯çš„

```
 if(requiredProps.every(prop => props.includes(prop))) {
       return Promise.resolve();
     } else {
-      return Promise.reject(); +      throw new UserValidationError
     }
   }

@@ -29,7 +28,7 @@ export default class UserModel {

   isUnique({ mail }) {
     return new Promise((resolve, reject) =>
-      this.database.exists("users", { mail }).then(reject, resolve)); +      this.database.exists("users", { mail }).then(() => reject(new UserMailInUseError), resolve));
   }

   searchBy(predicate) {
@@ -48,3 +47,15 @@ export default class UserModel {
     return this.database.update("users", { uid }, { mail, name });
   }
 }
+
+export class UserValidationError extends Error {
+  constructor() {
+    super("missing fields, required: [name, mail, pass]")
+  }
+}
+
+export class UserMailInUseError extends Error {
+  constructor() {
+    super("mail is already taken, try another one")
+  }
+} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰€ä»¥`@Throws(errorType, responseFn)`è¶…è¶Šäº†ã€‚è™½ç„¶`@Catch`ä¼šå¤„ç†ä»»ä½•å¼‚å¸¸ï¼Œä¸ç®¡é”™è¯¯ç±»å‹å¦‚ä½•ï¼Œ`@Throws`åªæ˜¯æä¾›äº†æ›´å…·ä½“çš„æ–¹æ³•æ¥å¤„ç† http å±‚ã€‚

è¿™æ˜¯`src/resources/user.resource.js` :
çš„æœ€ç»ˆé€ å‹

```
import { AbstractResource } from "@ritley/core";
import UserModel, { UserValidationError, UserMailInUseError } from "../models/user.model";

import {
  Dependency,
  ReqTransformBodyAsync,
  Default,
  Throws,
  InternalServerError,
  BadRequest,
  Conflict,
  Created
} from "@ritley/decorators";

@Dependency("userModel", UserModel)
export default class UserResource extends AbstractResource {
  constructor() {
    super("/users");
  }

  @Throws(SyntaxError, BadRequest)
  @Throws(UserValidationError, BadRequest)
  @Throws(UserMailInUseError, Conflict)
  @Default(Created)
  @ReqTransformBodyAsync
  async post(req, res) {
    const body = await req.body;
    const payload = body.toJSON();
    await this.userModel.validate(payload);
    await this.userModel.isUnique(payload);
    return this.userModel.create(payload);
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç®€å•å›é¡¾ä¸€ä¸‹ã€‚æ˜¯å¦ä½¿ç”¨`@Throws`æˆ–`@Catch`ç”±ä½ å†³å®šï¼Œå°½ç®¡`@Catch`å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ª`@Throws(Error, fn)`åˆ«åï¼Œå› ä¸ºå®ƒå°†åœ¨ä»»ä½•å¼‚å¸¸æ—¶è¢«æ‰§è¡Œã€‚ä½†æ˜¯`@Throws`æ›´å…·ç¡®å®šæ€§ï¼Œå› ä¸ºæ‚¨å¯ä»¥å°† HTTP å“åº”ä¸ç‰¹å®šç±»å‹çš„é”™è¯¯æˆ–æˆåŠŸè”ç³»èµ·æ¥ã€‚

åŸºæœ¬ä¸Šæ‰€æœ‰çš„*æ¡†æ¶é€»è¾‘*éƒ½åœ¨ http å±‚ã€‚ä¸ç®¡æä¾›è€…æ˜¯è°ï¼Œæ¨¡å‹éƒ½æ˜¯å®Œå…¨ç‹¬ç«‹çš„ã€‚

å®šä¹‰äº† http è§¦å‘å™¨ï¼Œè¿™äº›è§¦å‘å™¨å°†è°ƒç”¨æ¨¡å‹ä¸Šçš„ç‰¹å®šæ“ä½œï¼Œæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½å°†åœ¨åŒä¸€ä¸ªè§¦å‘å™¨ä¸Šä½¿ç”¨ä¸€ç»„å£°æ˜æ€§çš„è¡¨è¾¾å¼è¿›è¡Œå¤„ç†ã€‚è¿™åŸºæœ¬ä¸Šå…è®¸åœ¨åç«¯è¿›è¡Œéä¾µå…¥å¼å’Œå£°æ˜å¼å¼€å‘ã€‚

ä¼™è®¡ä»¬ï¼Œç°åœ¨å°±åˆ°è¿™é‡Œå§ï¼ç³»åˆ—çš„ä¸‹ä¸€ç« å°†æ˜¯å…³äºå¤„ç†ä¼šè¯ã€å…³æ³¨ç‚¹åˆ†ç¦»ä»¥åŠä¿æŒ ritley çš„å¯ä¼¸ç¼©æ€§ã€‚Cyaï¼

[![ritley from metroid](../Images/6c96b2fa78b770f0acbb0e69af3afa58.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--mCwlMtvz--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/7q8l002pngb479ra00l3.jpeg)