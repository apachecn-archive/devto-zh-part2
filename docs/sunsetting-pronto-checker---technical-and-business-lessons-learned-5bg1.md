# 日落 Pronto 检查-技术和商业经验教训

> 原文：<https://dev.to/hweetty/sunsetting-pronto-checker---technical-and-business-lessons-learned-5bg1>

正如你可能从标题中猜到的，我不再积极维护 Pronto Checker，一个用于检查你的 PRESTO 卡余额的方便应用程序。我已经[在我的博客上写了](https://jerryyu.ca/2018/07/07/sunsetting-pronto-checker/)这对用户意味着什么(简而言之，不多，应用程序仍然工作)，但我也把这作为一个机会，为感兴趣的人讨论一些关于应用程序开发的细节。我发现其他独立开发者的幕后帖子很有见地，我希望这篇帖子也能提供有趣的内容。所以要小心！这篇文章的其余部分将更加专业。

## 深入观察幕后

PRESTO 卡支持加拿大最大的交通系统，每个工作日有超过 200 万张卡和 100 万次点击。我是公共交通的忠实支持者，但是我最大的烦恼是查看我是否需要在我的卡上充值。我仍然记得和我的同事讨论创建这样一个单一用途的应用程序是否值得。虽然它给那些特别面临这个问题的人带来了很多便利，但它肯定是一个利基市场(这将是一个仅限 iPhone 的应用程序，用户可以使用第一方网站，信用卡自动加载甚至消除了对这样一个应用程序的需求)。尽管如此，我已经拼凑出了一个刮刀，所以我想[还能有多少工作量？](https://xkcd.com/1658/)

[!["Screenshots of the current Pronto Checker app"](../Images/b842e20188b18f114b053e2603dfe3fe.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--_z8qyRMM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/7t1mfb7t81oar9acszdp.png)T3】

<center>Screenshots of the current Pronto Checker app</center>

## 技术

我知道我必须建立某种刮刀，因为不幸的是没有公共的 PRESTO api，据我所知，甚至没有一个私有的。有两种主要的方法:我可以自己用正则表达式解析 html 页面，或者让浏览器帮我解析。

我选择了后者，因为大多数程序员都很懒(当然还有一些其他原因)。这被证明是一个好的选择，因为检查余额的过程被分成两个网络请求:登录和获取卡摘要。更复杂的是，我发现网页包含一些动态会话令牌，这意味着应用程序总是需要查询主页来获得一组新的令牌，以便登录 <sup id="fnref1">[1](#fn1)</sup> 。

一旦我获得了包含卡余额的 HTML，棘手的部分是解析出余额。这是通过在页面中注入 JavaScript，找到正确的 DOM 元素，并通过 [WebKit 消息处理程序](https://developer.apple.com/documentation/webkit/wkscriptmessagehandler/1396222-usercontentcontroller)传递数据来完成的。(好在我不再使用 UIWebview [了](https://developer.apple.com/documentation/uikit/uiwebview?changes=_6):)

这里还有一些其他的趣闻:

*   我添加的一个优化是使用 [WKUserContentController](https://developer.apple.com/documentation/webkit/wkusercontentcontroller) (在 iOS 11 和更高版本上)来防止浏览器检索不必要的内容，从而减少带宽使用，实现更快的页面加载时间。
*   由于一个用户可能有多个帐户，应用程序必须小心使用短暂的 web 会话来清除登录之间的 cookies。
*   我很好奇我可以添加什么来使应用程序更容易使用。我尝试添加 OCR，这样用户就不需要手动输入 17 位数字。在添加了一些简单的优化和对卡片格式的巧妙处理后，我让它相当可靠地工作了。具有讽刺意味的是，在 2016 年初，PRESTO 稍微重新设计了他们的卡，以便将卡号分组为四个块(以前是一个连续的字符串)，这使得 OCR 不太可靠。

所有这些都是在用户设备上完成的，原因有几个。我不想把任何信息存储在服务器上，因为那会给我带来很大的安全负担。这也意味着一个失败的中心点，因为所有 PRESTO 必须做的就是阻止我的 ip <sup id="fnref2">[2](#fn2)</sup> (如果他们愿意的话)来阻止这个工作。缺点是，如果 PRESTO 网站改变结构，我将不得不更新应用程序，但我认为这是值得的。

构建可靠软件的一个重要方面是能够监控它。当用户无法登录时，该应用程序会匿名报告，并进行其他分析以获得洞察力。我选择不使用第三方分析库/服务，因为它对我的需求来说是多余的。我不想带一团二进制的 <sup id="fnref3">[3](#fn3)</sup> ，我不知道它可能还在收集什么。

我发送分析报告的方式非常简单。该应用程序在第一次启动时生成一个匿名的唯一 id，然后发送 GET 请求，该请求将相关信息作为 URL 的一部分。我只是将这些请求记录到一个文件中，并不时地查看一下。虽然没有漂亮的图形用户界面，但也没什么必要。

显然，对于大多数用例来说，这种解决方案过于简单，而且需要做大量工作来构建附加功能和向外扩展。然而，我想指出的一点是，在最初的成长阶段，可能只有少数几个关键的统计数据是真正重要的。以尽可能简单的方式识别并专注于将信息呈现给利益相关者是很重要的。

我认为，一旦基本功能完成，另一项至关重要的技术是向用户呈现服务状态信息的能力(例如，系统停机时间或应用程序版本过期)。这可能是一个简单的弹出窗口或只是呈现一个网页。拥有这样一个系统可以让你为意外做好准备。

<center>
![](../Images/e46cbc9112098f9c07328b9615797634.png)
Recent popup from iTunes Connect app
</center>

## 代码质量

我已经在这个项目上工作了两年半多一点的时间，工作的节奏与我过去从事的其他项目非常不同。我大部分时间都在短时间内工作，专注于发布补丁或添加新功能，然后离开项目几个月。这提供了一些有趣的观察。

[![Commit history for Nov 15, 2015 – Jul 7, 2018](../Images/2ffd208ee8f34adc9a50bd2eb4de0f5c.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--93aISovx--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/f69bbah4dmtkag4w8msb.png)T3】

<center>Commit history for Nov 15, 2015 – Jul 7, 2018</center>

我第一次跳回这个项目时，花了一段时间才弄清楚一切是如何工作的，就好像我在读别人的代码一样。一部分原因是由于时间上的差距，但也有很大一部分原因是我当时相对缺乏软件工程的经验。

这个应用程序是关注点基本分离的主要例子，例如将应用程序分为 1)核心平衡检查器，2)平衡的模型/持久性，3)显示平衡的 UI。因此，我在第一次重写时抓住机会，清楚地标出了应用程序每个部分的界限。我定义了新的`struct`,让应用程序的不同部分如何相互交互变得更加清晰，并试图预测我未来需要的属性。我不得不考虑的一个相关问题是版本之间持久层的兼容性。

然而，每隔几个月开发一次应用程序还是有好处的。更容易发现我编写高质量代码的能力的提高，因为在随后的每次重读中，我总能找到我现在有更好的解决方案或组织代码的方法的地方。能够以某种方式重写一些代码，避免过去的自己没有预料到的隐藏问题，这可能是令人兴奋的。然而，也有几次我惊喜地发现，在重读代码时，我已经处理了一些特殊情况。看到 Swift 语言的进步也是一种有趣的体验。我最初在 Swift 1.2 中开始开发这个应用程序，经历了几次迁移(还记得 2.0 吗？)，随着时间的推移看到语言的成熟和变好。

## 定价、营销、促销

好了，现在谈正事。那时候，我听一些播客，关注那些靠卖软件谋生的独立开发者。创建应用相当于一项投资(时间就是金钱，对吗？).我认为这是一个很好的机会，从一些小东西开始，构建各种不同的应用程序，以提供多样化的收入。

我带来的这个应用程序的特点是方便和易用，我希望这足以成为一个付费应用程序的理由。降低一个应用程序的价格也比提高它的价格容易得多。老实说，如果我能看到稳定的付费下载和好评，我个人会觉得它更令人印象深刻，因为这直接证明了人们觉得它很有用。

最初在发布后，我尝试了一下 Google Adwords，因为我很好奇我能得到什么样的结果。我尝试了各种关键词，调整登陆页面或直接链接到应用商店等。然而，我相信(已经有一段时间了)我勉强收支平衡，因为点击率相当低。当测试不同的变化时，工作量也大于价值。我发现在测试之间跟踪每一个假设真的很累人(因为要花时间才能看到结果)，或者尝试不同的布局。

我也试着联系媒体，但没有得到多少回应。回想起来有几个因素。由于这是一个非常小众的应用程序，所以去找记者很难找到合适的客户，而记者知道这一点，所以不值得他们花时间。此外，即使一个人想要一个可以做到这一点的应用程序，由于付费定价，也有很高的障碍。意识到这一点后，我试着把这款应用免费与冷邮件结合起来。最终我在 iphone 的博客上找到了一个链接。

## 请求点评

当 iOS 10.3 引入了[应用内评论对话](https://developer.apple.com/documentation/storekit/skstorereviewcontroller/2851536-requestreview)时，我立刻意识到我想把它加入进来。当时我没有太多评论，这对付费应用特别有帮助。这部分是因为我没有添加任何侵入性的 popovers，因为我想为用户创造一个愉快的体验。(然而，即使我这么做了，我也怀疑点击率会不会很高。在 App Store 上留下评论的旧流程对用户的要求太高了。)

我添加了许多小细节，试图减少用户干扰并获得最佳结果。首先，用户必须在几天内成功地检查了几次他们的余额。满足这一点后，应用程序会在下一次成功刷新后等待几秒钟，这样用户就可以在得到提示前看到他们的余额。这减少了干扰，并有希望产生最好的结果。对于每个版本，用户最多只能看到一次此弹出窗口。此外，App Store 现在允许开发者在发布新的更新后保留之前的评论，减少了继续显示这些对话的需要。

## 太阳下山的过程

这就把我们带到了孙设置 app 的最后一个话题。我对其他应用程序这样做有一些模糊的记忆，但我从来没有真正注意过其他团队如何处理它的细节。然而，在我的情况下，应用程序将继续运行，因为我只是给每个人一个提示，没有未来的应用程序更新计划。

我确实争论过是否应该把这个应用程序从商店里撤下来。我不想继续出售它，因为我不再积极开发它。然而，与此同时，我仍然看到了让人们使用它的价值。因此，我决定让这个应用程序免费下载。

*感谢阅读！你会做任何不同的事情吗？如果你对下面的评论有任何反馈，请告诉我。*

## 脚注

* * *

1.  动态令牌要求是在 2016 年 7 月左右添加的。以前，在没有要求的情况下，我可以在应用程序中包含登录页面的缓存版本，跳过第一个请求 [↩](#fnref1)

2.  如果我是 PRESTO 网站的负责人，看到一个 ip 进行如此多的独立登录，那绝对是一个危险信号 [↩](#fnref2)

3.  最可怕的库是那些不需要*任何*代码的库，因为它们直接挂钩到 [dyld load](https://stackoverflow.com/q/2053029) 进程 [↩](#fnref3)

4.  除非你的 app 是[素描](https://twitter.com/sketchapp/status/517010776352387072) :) [↩](#fnref4)