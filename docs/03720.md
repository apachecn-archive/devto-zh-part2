# 使用 IAM 角色而不是 IAM 用户的 S3 和影响

> 原文:[https://dev . to/ferricoxide/S3-and-impacts-of-using-an-iam-role-inst-an-iam-user-5dmb](https://dev.to/ferricoxide/s3-and-impacts-of-using-an-iam-role-instead-of-an--iam-user-5dmb)

我在一个管理多个 AWS 账户的小组工作。为了从用户管理的角度简化事情，我们使用 IAM *roles* (绑定到一个中央目录服务，并通过目录的组成员关系进行映射)来访问各种帐户，而不是试图管理每个帐户的 IAM *用户*。这意味着我们可以通过 Active Directory 管理用户，这样，随着新团队成员的加入、现有团队成员职责的改变或团队成员的离开，我们只需更新他们的 AD 用户对象，他们的访问权限的广度和深度就会改变。

然而，IAM 角色的使用也有其局限性。基于角色的用户的访问是通过临时令牌的方式授予的。代币最多持续 3600 秒。如果没有一些浏览器扩展，如果你是一个 GUI 用户，这有点烦人，因为这意味着在 8 个多小时的工作会话中，你将被提示刷新你的令牌至少 7 次(除了初始登录之外)。如果您主要通过 CLI 工作，您不一定会注意到这些事情，因为您运行的每个命令都会自动刷新您的令牌。

我使用“不一定会注意到”这个警告，因为*有*个地方使用 IAM 角色会给你带来麻烦。更糟糕的是，有时它会咬你的屁股，让你挠头想“WTF 这不是像我预期的那样工作吗”。

最近在“WTF 不是像我预期的那样工作”中的冒险是在试图使用 S3 预签名 URL 的上下文中。如果您以前没有使用过，预签名的 URL 允许您提供对 S3 托管的对象的临时访问，否则您不希望匿名访问这些对象。在总体方案中，可以执行以下操作之一，为自动化工具提供对 S3 托管数据的访问:

*   托管在公共 S3 桶中的公共读取对象:这是结束关于意外数据泄漏的新故事的好方法
*   托管在私有 S3 桶中的公共读取对象:您仍然可以不受约束地访问特定的 S3 托管的对象/对象集，但是一些 rando 通常不能简单地探索托管 S3 桶以获得有趣的数据。你仍然可以上报纸，但是，损失的范围可能会小得多
*   在私人 S3 桶中托管的私人读取对象:最不可能让你上报纸，但需要一些额外的“魔法”来允许你自动访问 S3 托管的文件:

    *   IAM 用户凭证存储在 EC2 实例上，需要访问 S3 托管的文件:这是一个好方法，直到有人破坏 EC2 实例并窃取凭证。然后，攻击者可以访问这些凭证可以访问的所有内容(直到您发现漏洞，并停用或更改凭证)
    *   IAM 实例-角色:为共享一个角色的一个实例或一组实例提供对 S3 存储桶的大范围访问的好方法。注意，如果没有一些额外的配置技巧，*在启用的实例上运行的每个*流程都可以访问实例角色提供的所有内容。因此，对于允许交互式登录或运行多个可攻击服务的系统来说，这可能不是一个好的选择。
    *   预签名 URL:一种提供对 S3 托管对象的细粒度、*临时*访问的方式。主要的缺点是，在设置对大量文件的访问或提供对所述文件的连续访问时会有很大的开销。因此，可能适合于提供对配置文件的基本 CloudFormation EC2 访问，但如果 EC2 需要对所述文件进行持续访问，则不适合(例如，在自动扩展组类型的用例中)

可能有更多的访问方法可供选择——每种方法都有自己的安全性、粒度和开销权衡。以上只是我用过最多的几个。

我写的自动化倾向于包含一定程度的用户可定制的内容。也就是说，我编写我的自动化来处理给定服务的 90%左右的配置，然后将自动化交给其他人，让他们在认为合适的时候使用。为了帮助防止在这些特定用例中出现明显的代码差异，我的自动化通常允许用户指定配置规范文件和/或二级配置脚本的摄取。虽然我写的东西通常存放在公共 GitHub 库中，但这些定制文件或脚本通常包含人们不想放在公共 GitHub 库中的数据。因此，我通常向自动化的用户推荐“将数据放在安全的地方——这里有通过 S3 相对安全地做这件事的方法”。

回过头来，让这篇文章的标题有意义...通常，我建议自动化用户使用预签名的 URL，这些用户希望提供对这些一次性生命周期文件的安全访问。预先签名的 URL 的访问授权可以短至几秒钟，长至七天。在没有指定期望时间的情况下，授权访问在两小时后到期。

然而，这种灵活性很大程度上取决于创建临时访问授权的 IAM 对象的类型。一个标准的 IAM 用户可以通过*授予前面提到的所有*时间灵活性。然而，一个 IAM *角色*被限制在他们当前激活的令牌有效的时间内。因此，如果使用 IAM *角色*从 CLI 执行，预签名的可授予生命周期为 *0-3600 秒*。

如果您不清楚您创建/给出的预签名 URL 是否来自 IAM 用户或角色，请在 URL 中查找`X-Amz-\*`的存在。如果您看到任何这样的元素，它是由一个 IAM 角色生成的，并且将只持续*到* 3600 秒。