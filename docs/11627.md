# ç±»å‹æ“ä½œæ¼æ´

> åŸæ–‡:[https://dev . to/petermbenjamin/type-manipulation-vulnerability-2 fcg](https://dev.to/petermbenjamin/type-manipulation-vulnerabilities-2fcg)

[![Type Manipulation Vulnerability](../Images/4e1b554fdc0075951ad9c20386ba58f9.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--ajIh7vjO--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/8veyic2a3wf7b2rbqr5j.png)

æœ€è¿‘ï¼Œæˆ‘è¯»äº†ä¸€ç¯‡[ç±»å‹æ“çºµæ¼æ´æ–‡ç« ](https://snyk.io/blog/type-manipulation)ï¼Œå¼•èµ·äº†æˆ‘çš„å…´è¶£ã€‚å› æ­¤ï¼Œæˆ‘å¼€å§‹æ›´å¥½åœ°ç†è§£å®ƒï¼Œå¹¶æŠŠä¸€äº›çŸ¥è¯†å¸¦å›ç¤¾åŒºã€‚

## ç›®å½•

*   [ç®€ä»‹](#introduction)
*   [æ¶ˆæ¯’](#the-sanitisation)
*   [æ“çºµ](#the-manipulation)
*   [æ½œåœ¨è§£å†³æ–¹æ¡ˆ](#potential-solutions)
*   [å¸å–çš„ç»éªŒæ•™è®­](#lessons-learned)
*   [é“¾æ¥](#links)

## 

åœ¨éå¸¸é«˜çš„å±‚æ¬¡ä¸Šï¼Œæ‰€æœ‰ç¼–ç¨‹è¯­è¨€éƒ½éœ€è¦æœ‰**ç±»å‹**ç»“æ„ï¼Œä»¥ä¾¿è§£é‡Šå™¨æˆ–ç¼–è¯‘å™¨å°†äººç±»å¯è¯»çš„ä»£ç ç¿»è¯‘æˆæœºå™¨ä»£ç ã€‚åŠ¨æ€è¯­è¨€ã€é™æ€è¯­è¨€ã€è§£é‡Šè¯­è¨€ã€ç¼–è¯‘è¯­è¨€éƒ½éœ€è¦ç±»å‹ã€‚

ä¸‹é¢æ˜¯ä¸€äº›ä¾‹å­:

```
let firstName = "Peter";
typeof firstName; // returns 'string' 
```

```
# python firstName = "Peter"
type(firstName) # returns <type 'str'> 
```

```
# ruby
first_name = "Peter"
first_name.class # returns String 
```

```
// go
firstName := "Peter"
reflect.TypeOf(firstName) // returns string 
```

å¤ªå¥½äº†ï¼Œç¼–ç¨‹è¯­è¨€æœ‰ç±»å‹ï¼é‚£ä¹ˆï¼Œæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ

å¥½å§ï¼Œå‡è®¾æ‚¨æƒ³è¦è·å–ä¸€äº›ç”¨æˆ·æä¾›çš„è¾“å…¥ï¼Œå¹¶å°†å…¶å‘é€åˆ°æœåŠ¡å™¨è¿›è¡Œä¸€äº›å¤„ç†ï¼Œè¿™åŒ…æ‹¬`eval`è¾“å…¥(æœåŠ¡å™¨ç«¯å‘ˆç°/æ¨¡æ¿å¼•æ“çš„å¸¸è§åœºæ™¯)ã€‚

æ‰€ä»¥ï¼Œä½ å¯¹è‡ªå·±è¯´:â€œåªè¦æˆ‘å¯¹ç”¨æˆ·è¾“å…¥çš„å­—ç¬¦è¿›è¡Œæ€æ¯’ï¼Œè®©å®ƒä»¬èƒ½å¤Ÿåœ¨æˆ‘çš„æœåŠ¡å™¨ä¸Šé€ƒé€¸æˆ–è¿è¡Œä»»æ„ä»£ç ï¼Œé‚£å°±å¥½äº†ï¼Œå¯¹å—ï¼Ÿâ€

å¯¹ï¼Œä½†æ˜¯è®©æˆ‘ä»¬è€ƒè™‘ä¸‹é¢çš„åœºæ™¯...

## 

å¯¹äºè¿™ä¸ªè™šæ„çš„ä¾‹å­ï¼Œè®©æˆ‘ä»¬æ£€æŸ¥å¹¶æ¸…é™¤ç”¨æˆ·è¾“å…¥ä¸­çš„ 3 ä¸ªå·²çŸ¥çš„â€œåâ€å­—ç¬¦:

*   `<`åº”ç¼–ç ä¸º`&lt;`
*   `>`åº”ç¼–ç ä¸º`&gt;`
*   `&`åº”ç¼–ç ä¸º`&amp;`

æ‰€ä»¥ï¼Œæˆ‘ä»¬å†™è¿™ä¸ªå‡½æ•°:

```
const AMP = "&";
const LT = "<";
const GT = ">";

const ESCAPECHARS = RegExp(`${AMP}|${LT}|${GT}`, "g");

function sanitise(input) {
  if (typeof input === "string") {
    if (!ESCAPECHARS.test(input)) {
      // input is good
      return input;
    }
    // input is bad, sanitise...
    return input
      .replace(AMP, "&amp;")
      .replace(LT, "&lt;")
      .replace(GT, "&gt;");
  }
  return input;
}

sanitize('good input');                             // returns 'good input'
sanitize('<script>alert("bad input")</script>');    // returns '&lt;script&gt;...' 
```

å¦‚æœæˆ‘ä»¬æ¥å—æ¥è‡ªå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºçš„è¾“å…¥ï¼Œå®ƒå¯èƒ½çœ‹èµ·æ¥åƒ:

```
// server.js
const http = require("http");
const url = require("url");
const querystring = require("querystring");

// sanitise logic here...

const requestHandler = (req, resp) => {
  let parsedURL = url.parse(req.url);
  let userInput = querystring.parse(parsedURL.query);
  let sanitised = sanitise(userInput.foo);
  resp.end(JSON.stringify(sanitised));
};

const server = http.createServer(requestHandler);

const PORT = 3000;

server.listen(PORT, err => {
  if (err) return console.log(`server failed: ${err}`);
  console.log(`server listening on ${PORT}`);
}); 
```

ç”¨`$ node server.js` &è¿è¡Œå®ƒï¼Œæµè§ˆåˆ°`localhost:3000`
å¾—åˆ°çš„å“åº”å°†æ˜¯ä¸€ä¸ªç©ºé¡µé¢ã€‚

å…³äº:`localhost:3000/?foo=bar`
å›åº”:

```
"bar" 
```

å¥½çš„ã€‚ç°åœ¨å…³é”®æ—¶åˆ»:`localhost:3000/?foo=<bar>`
å›åº”:

```
"&lt;bar&gt;" 
```

åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œä½ å¯èƒ½å¯¹æˆ‘ä»¬çš„æ¶ˆæ¯’å¾ˆæœ‰ä¿¡å¿ƒã€‚

## 

ä½†æ˜¯ï¼Œ`localhost:3000/?foo=bar&foo=<script>alert(1)</script>`å‘¢
å›åº”:

```
[
  "bar",
  "<script>alert(1)</script>"
] 
```

å•Šå“¦ï¼æˆ‘ä»¬å®Œå…¨ç»•è¿‡äº†å‡€åŒ–é€»è¾‘ï¼Œå› ä¸ºæˆ‘ä»¬åªåœ¨è¿è¡Œæ—¶æ£€æŸ¥`typeof input === 'string'`ã€‚

æœ‰è¶£çš„æ˜¯ï¼Œå¦‚æœè¿™äº›æ•°æ®æ˜¯åœ¨å®¢æˆ·ç«¯ä½¿ç”¨çš„(ä¾‹å¦‚å‘ç”¨æˆ·æ˜¾ç¤º`document.location.href`çš„å†…å®¹)ï¼Œè¿™å°†æ„æˆä¸€ç§[åŸºäº DOM çš„è·¨ç«™ç‚¹è„šæœ¬æ”»å‡»](https://www.owasp.org/index.php/DOM_Based_XSS)(ç®€ç§° DOM-XSS)ï¼Œä½†è¿™æ˜¯å¦ä¸€ç¯‡æ–‡ç« çš„ä¸»é¢˜ã€‚

ä½†æ˜¯ï¼Œå¦‚æœè¦åœ¨æœåŠ¡å™¨ä¸Šå¤„ç†è¿™äº›æ•°æ®ï¼Œæˆ–è€…ç”šè‡³`eval`ç¼–è¾‘è¿™äº›æ•°æ®(ä¾‹å¦‚ï¼ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“)ï¼Œé‚£ä¹ˆæ”»å‡»è€…å°±å¯ä»¥çªç ´æ‚¨çš„é€»è¾‘ï¼Œåœ¨æ‚¨çš„æœåŠ¡å™¨ä¸Šè¿è¡Œä»»æ„ä»£ç ï¼Œæ¯”å¦‚:

```
require("child_process").exec(/* steal API tokens, SSH keys, secrets/passwords ...etc */); 
```

å¦‚æœä½ å¯¹å¦‚ä½•åˆ©ç”¨æ„Ÿå…´è¶£ï¼Œè¿™ç¯‡[æ–‡ç« ](https://snyk.io/blog/type-manipulation)å°†æ·±å…¥æ¢è®¨å¦‚ä½•åˆ©ç”¨è¿™ä¸€ç‚¹ã€‚

åœ¨åŠ¨æ€è¯­è¨€ä¸­ï¼Œæœ‰å‡ ç§æ–¹æ³•å¯ä»¥å‡è½»å’Œé˜²å¾¡è¿™ç§ç±»å‹çš„é”™è¯¯ã€‚è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹...

## æ½œåœ¨æ–¹æ¡ˆ

æ‚¨çš„ç›´è§‰å¯èƒ½æ˜¯é€šè¿‡æ£€æŸ¥`if`è¯­å¥ä¸­çš„`Array`å¯¹è±¡ç±»å‹æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ‚¨å¯èƒ½æ˜¯å¯¹çš„ï¼Œä½†æ˜¯è®©æˆ‘ä»¬æ£€æŸ¥å‡ ä¸ªå…¶ä»–é€‰é¡¹ã€‚

*   ä½ å¯ä»¥è€ƒè™‘**ä¸å…è®¸**éå­—ç¬¦ä¸²ç±»å‹ã€‚åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œè¿™å¯èƒ½çœ‹èµ·æ¥åƒ:

```
function sanitise(input) {
  if (typeof input !== 'string') {
    throw new Error('TypeError: sanitise input is not a string.')
  }
    ...
} 
```

*   ä½ å¯ä»¥è€ƒè™‘**è§„èŒƒåŒ–**æ‰€æœ‰çš„æ•°æ®ç±»å‹ã€‚åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œè¿™å¯èƒ½çœ‹èµ·æ¥åƒ:

```
function sanitize(input) {
  if (input.isArray) { ... }
  if (typeof input === 'number') { ... }
  if (typeof input === 'string') { ... }
  // ... so on
} 
```

*   ä½ å¯ä»¥è€ƒè™‘ä¸€ç§æ··åˆçš„æ–¹æ³•ï¼Œä½ å¯ä»¥**ç¦æ­¢**ä¸€äº›ç±»å‹ï¼Œè€Œå¤„ç†ä¸€äº›å…¶ä»–ç±»å‹ã€‚è¿™å¯ä»¥è¯´æ˜¯æœ€è„†å¼±çš„æ–¹æ³•ã€‚

## 

*   è¿™ä¸ªé”™è¯¯çš„æ ¸å¿ƒæ˜¯ä¸æ­£ç¡®åœ°å¤„ç†/æ¸…ç†ç”¨æˆ·è¾“å…¥ã€‚
*   åœ¨åŠ¨æ€è¯­è¨€ä¸­ï¼Œæ¯”å¦‚ Javascriptï¼Œæˆ‘ä»¬å£°æ˜å‡½æ•°è€Œä¸æŒ‡å®šå˜é‡çš„æ•°æ®ç±»å‹ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ï¼Œè½¯ä»¶å¼€å‘äººå‘˜å’Œå·¥ç¨‹å¸ˆï¼Œæœ‰è´£ä»»ç¡®ä¿æˆ‘ä»¬åœ¨ä»»ä½•æ—¶å€™éƒ½å¤„ç†æ­£ç¡®çš„æ•°æ®ç±»å‹ï¼Œä»¥é˜²æ­¢ç±»ä¼¼è¿™æ ·çš„è¾¹ç¼˜æƒ…å†µã€‚
*   å•å…ƒæµ‹è¯•å’ŒåŒè¡Œè¯„å®¡è‡³å…³é‡è¦ã€‚
*   é™æ€ç±»å‹è¯­è¨€åœ¨ç¼–è¯‘æ—¶åœ¨æŸç§ç¨‹åº¦ä¸Šç¼“è§£äº†è¿™äº›ç±»å‹çš„é”™è¯¯ï¼Œä½†æ˜¯å®ƒä»¬ä»ç„¶å®¹æ˜“å—åˆ°è¿™ç§é”™è¯¯çš„å˜ç§çš„æ”»å‡»ï¼Œé€šå¸¸è¢«ç§°ä¸º*ååºåˆ—åŒ–æ¼æ´*ã€‚

## 

*   [æ­¤æ¦‚å¿µéªŒè¯çš„æºä»£ç ğŸ™](https://github.com/petermbenjamin/poc-type-manipulation)
*   [Javascript æ¨¡æ¿åº“ä¸­çš„ç±»å‹æ“ä½œ](https://snyk.io/blog/type-manipulation)
*   [åœ¨ PHP ä¸­é”®å…¥æ‚è€æ¼æ´åˆ©ç”¨](https://www.owasp.org/images/6/6b/PHPMagicTricks-TypeJuggling.pdf)
*   Ruby-on-Rails ä¸­çš„ç±»å‹æ“çºµæ¼æ´& YAML
*   [åŸºäº DOM çš„è·¨ç«™è„šæœ¬æ”»å‡»](https://www.owasp.org/index.php/DOM_Based_XSS)
*   [ååºåˆ—åŒ–æ¼æ´](https://www.owasp.org/index.php/Deserialization_of_untrusted_data)