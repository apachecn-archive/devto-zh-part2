# React Native ä¸Šåœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œ JS çš„ç®€å•æ–¹æ³•

> åŸæ–‡:[https://dev . to/craftzdog/a-simple-way-to-run-js-in-background-thread-on-react native-1k8m](https://dev.to/craftzdog/a-simple-way-to-run-js-in-background-thread-on-reactnative--1k8m)

CPU å¯†é›†å‹ä»»åŠ¡é˜»å¡ UIï¼Œå¦‚ç´¢å¼•ã€‚å› ä¸ºï¼Œåœ¨ React Native ä¸­ï¼ŒJavaScript æ˜¯åœ¨ JavaScriptCore ä¸Šæ‰§è¡Œçš„ï¼Œè¿™æ„å‘³ç€ä½ åªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚æ‰€ä»¥ä½ å¿…é¡»ä½¿ç”¨åƒ [react-native-workers](https://github.com/devfd/react-native-workers) è¿™æ ·çš„æœ¬åœ°æ¨¡å—ï¼Œå®ƒæä¾›äº†ä¸ [web workers](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers) ç±»ä¼¼çš„ APIã€‚ä½†æ˜¯å¦‚æœä½ åªæ˜¯æƒ³åœ¨åå°è¿è¡Œä¸€ä¸ªç®€å•çš„ä»»åŠ¡ï¼Œè¿™æ˜¯ä¸€ç§è¶…é«˜é€Ÿçš„æ–¹æ³•ã€‚æˆ‘ä¸å–œæ¬¢åœ¨æˆ‘çš„åº”ç”¨ç¨‹åºä¸­å®‰è£…å¾ˆå¤šæœ¬æœºæ¨¡å—ï¼Œå› ä¸ºå®ƒä»¬ä¼šä½¿åº”ç”¨ç¨‹åºæ›´åŠ å¤æ‚å’Œè„†å¼±ã€‚å¦‚æœä½ æœ‰ expo appï¼Œå®ƒå°±ä¸èƒ½ä½¿ç”¨åŸç”Ÿæ¨¡å—ã€‚

æˆ‘å‘ç°æˆ‘ä»¬å·²ç»æœ‰ç°æˆçš„åå°çº¿ç¨‹äº†ã€‚ä¹Ÿå°±æ˜¯ [WebView](https://facebook.github.io/react-native/docs/webview.html) ã€‚ä½ å¯ä»¥é€šè¿‡è°ƒç”¨`injectJavaScript`æ–¹æ³•åœ¨é‡Œé¢è¿è¡Œ JavaScriptã€‚åœ¨ webview å†…éƒ¨ï¼Œå®ƒæ˜¯ Safari(iOS)/Chrome(Android)çš„å¦ä¸€ä¸ªå®ä¾‹ï¼Œæ‰€ä»¥åœ¨å…¶ä¸­è¿è¡Œçš„ JS æ ¹æœ¬ä¸ä¼šå±è”½ app UIã€‚æˆ‘é€šè¿‡è¿è¡Œä¸‹é¢çš„ä»£ç åœ¨ä¸¤ä¸ªå¹³å°ä¸Šæ£€æŸ¥äº†è¿™ä¸€ç‚¹:

```
for (;;) { Math.random() * 9999 / 7 } 
```

è¿™æ˜¯æœ‰ç”¨çš„ã€‚ä¸ç”¨å®‰è£…åŸç”Ÿæ¨¡å—å°±å¯ä»¥åœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œä»£ç ï¼è¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å­:

```
import React, { Component } from 'react'
import { WebView } from 'react-native'

export default class BackgroundTaskRunner extends Component {
  render() {
    return (
      <WebView
        ref={el => this.webView = el}
        source={{html: '<html><body></body></html>'}}
        onMessage={this.handleMessage}
      />
    )
  }
  runJSInBackground (code) {
    this.webView.injectJavaScript(code)
  }
  handleMessage = (e) => {
    const message = e.nativeEvent.data
    console.log('message from webview:', message)
  }
} 
```

è¦è·å¾—ä»£ç çš„ç»“æœï¼Œæ‚¨å¯ä»¥ä¸ºæ‚¨çš„ webview æŒ‡å®š`onMessage` propã€‚
webview è°ƒç”¨`window.postMessage`æ—¶è°ƒç”¨çš„åŠŸèƒ½ã€‚è®¾ç½®è¯¥å±æ€§ä¼šå°†ä¸€ä¸ª`postMessage`å…¨å±€å˜é‡æ³¨å…¥åˆ°æ‚¨çš„ webview ä¸­ï¼Œä½†ä»ä¼šè°ƒç”¨é¢„å…ˆå­˜åœ¨çš„`postMessage`å€¼ã€‚
`window.postMessage`æ¥å—ä¸€ä¸ªå‚æ•°`data`ï¼Œè¯¥å‚æ•°å¯ç”¨äº`event`å¯¹è±¡`event.nativeEvent.data`ã€‚`data`å¿…é¡»æ˜¯å­—ç¬¦ä¸²ã€‚

åªéœ€åœ¨ webview ä¸Šè°ƒç”¨:

```
const message = { ok: 1 }
window.postMessage(message) 
```

ç„¶åä½ åœ¨åº”ç”¨ç¨‹åºä¸Šå¾—åˆ°æ¶ˆæ¯:

```
message from webview:, { ok:1 } 
```

å°±æ˜¯è¿™æ ·ï¼ğŸ˜„