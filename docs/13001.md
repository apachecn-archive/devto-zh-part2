# Go ä¸­æ‰«æå­—èŠ‚çš„è®¡æ•°

> åŸæ–‡:[https://dev . to/benrcongdon/counting-scanned-bytes-in-go-2 LBO](https://dev.to/benrcongdon/counting-scanned-bytes-in-go-2lbo)

åœ¨æœ€è¿‘çš„ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œæˆ‘éœ€è¦ä»æ–‡ä»¶çš„ç‰¹å®šå—ä¸­è¯»å–æ•°æ®ã€‚æ•°æ®æ˜¯ä¸€ç³»åˆ—åºåˆ—åŒ–çš„è®°å½•ï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨äº†ä¸€ä¸ª`bufio`æ‰«æä»ªè¿›è¡Œåˆ†å‰²ã€‚æ‰«æä»ªå¾ˆæ£’ï¼Œä½†æ˜¯å®ƒä»¬æ¨¡ç³Šäº†è¯»å–çš„ç¡®åˆ‡å­—èŠ‚æ•°ã€‚åœ¨è§£å†³è¿™ä¸ªé—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘æ‰¾åˆ°äº†ä¸€ä¸ªéå¸¸æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚

æœ¬è´¨ä¸Šï¼Œé—®é¢˜å½’ç»“ä¸º:æˆ‘æƒ³ä½¿ç”¨`bufio`çš„æ‰«æå™¨å¹²å‡€åœ°åˆ†å‰²æ•°æ®è®°å½•ï¼Œä½†æ˜¯æˆ‘ä¹Ÿéœ€è¦ç²¾ç¡®åœ°æ§åˆ¶è¯»å–äº†å¤šå°‘å­—èŠ‚ã€‚ç®€å•åœ°è®¡ç®—è¾“å…¥è®°å½•ä¸­çš„å­—èŠ‚æ•°æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºæ•°æ®è®°å½•å¯èƒ½ä¼šä½¿ç”¨å¯å˜å®½åº¦åˆ†éš”ç¬¦ <sup id="fnref:1">[1](#fn:1)</sup> æ‹†åˆ†ã€‚(å³`\n`å¯¹`\r\n`)ã€‚

<figure>[![Problem: Read & Split Records until Chunk Boundary Is Reached](../Images/d160d9deab795bbffebd8849940515eb.png)](///img/2018-04-10-Counting-Scanned-Bytes-in-Go/chunk_setup.svg) 

<figcaption>é—®é¢˜:è¯»å–&æ‹†åˆ†è®°å½•ï¼Œç›´åˆ°åˆ°è¾¾å—è¾¹ç•Œ</figcaption>

</figure>

æˆ‘æœ€åˆçš„æƒ³æ³•æ˜¯åŒ…è£…æˆ‘ä»ä¸­è¯»å–è®°å½•çš„`io.Reader`ã€‚ç»“æœçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:

```
type CountingReader struct {
    reader io.Reader
    BytesRead int
}

func (r *CountingReader) Read(p []byte) (n int, err error) {
    n, err = r.reader.Read(p)
    r.BytesRead += n
    return n, err
} 
```

Enter fullscreen mode Exit fullscreen mode

è¿™ä¸ªæ–¹æ³•*ç¡®å®åƒå®£ä¼ çš„é‚£æ ·*å·¥ä½œï¼Œå› ä¸ºå®ƒè®¡ç®—ä»è¯»å–å™¨è¯»å–çš„å­—èŠ‚æ•°ã€‚ç„¶è€Œï¼Œ*å¹¶æ²¡æœ‰çœŸæ­£è§£å†³æˆ‘çš„é—®é¢˜â€”â€”è®¡ç®—ä½œä¸ºè®°å½•è¯»å–çš„å­—èŠ‚æ•°ã€‚æ¯”å¦‚:* 

```
func main() {
    buf := bytes.NewBuffer([]byte("foo bar baz"))
    reader := &CountingReader{reader: buf}

    scanner := bufio.NewScanner(reader)
    scanner.Split(bufio.ScanWords)
    scanner.Scan()

    fmt.Println(scanner.Text()) // "foo"
    fmt.Println(reader.BytesRead) // 11 :(
} 
```

Enter fullscreen mode Exit fullscreen mode

(ä½ å¯ä»¥åœ¨ [Go æ¸¸ä¹åœº](https://play.golang.org/p/fRgb06S-LlH)è¯•è¯•è¿™ä¸ª)

æˆ‘å‘ç°ï¼Œè¿™ç§è¡Œä¸ºçš„åŸå› æ˜¯`bufio.Scanner`ç»´æŠ¤ç€ä¸€ä¸ª[å†…éƒ¨ç¼“å†²åŒº](https://golang.org/src/bufio/scan.go?s=1184:1841#L20)ï¼Œå®ƒä»¥å¤§å—çš„å½¢å¼è¯»å–è¿™ä¸ªç¼“å†²åŒºã€‚æˆ‘çš„`CountingReader`å¯ä»¥(æ­£ç¡®åœ°)è¯´å·²ç»ä»å®ƒé‚£é‡Œè¯»å–äº† 11 ä¸ªå­—èŠ‚ï¼Œå³ä½¿æ‰«æä»ªåªäº§ç”Ÿäº† 4 ä¸ªå­—èŠ‚çš„æ•°æ®(`"foo "`)ã€‚

æˆ‘çš„ä¸‹ä¸€ä¸ªæƒ³æ³•æ˜¯é€šè¿‡åŒ…è£…æˆ–é‡æ–°å®ç°`buffio.Scanner`æ¥å®ç°ä¸€ä¸ª`CountingScanner`æ¥è®¡ç®—å¤„ç†çš„å­—èŠ‚æ•°ã€‚è¿™ä¸¤ç§é€‰æ‹©éƒ½æ²¡æœ‰å¸å¼•åŠ›ã€‚`io`æ¨¡å—è¿˜æœ‰ [LimitReader](https://golang.org/pkg/io/#LimitedReader) ï¼Œå®ƒå¼ºåˆ¶æ‰§è¡Œè¯»å–çš„æœ€å¤§å­—èŠ‚æ•°ã€‚å¯¹äºæˆ‘çš„é—®é¢˜ï¼Œè¿™æ˜¯è¡Œä¸é€šçš„ï¼›æˆ‘çš„é˜…è¯»å™¨éœ€è¦å®Œæ•´åœ°è¯»å–æ–‡ä»¶å—ä¸­çš„æœ€åä¸€æ¡è®°å½•ï¼Œå³ä½¿å®ƒè·¨è¶Šäº†æˆªæ­¢ç‚¹ã€‚

<figure>[![io.LimitReader would not allow Logical Splitting](../Images/185ff40df4cf09180f97517b6e08a423.png)](///img/2018-04-10-Counting-Scanned-Bytes-in-Go/split_diagram.svg) 

<figcaption>æœ¨å«ä¸€ã€‚LimitReader ä¸å…è®¸é€»è¾‘æ‹†åˆ†</figcaption>

</figure>

æœ€åï¼Œæˆ‘å°è¯•åŒ…è£…æ‰«æä»ªçš„ [SplitFunc](https://golang.org/pkg/bufio/#SplitFunc) ã€‚ä½œä¸ºå‚è€ƒï¼ŒSplitFunc æœ‰ä»¥ä¸‹ç­¾å:

```
type SplitFunc func(data []byte, atEOF bool) (advance int, token []byte,
    err error) 
```

Enter fullscreen mode Exit fullscreen mode

æœ¬è´¨ä¸Šï¼Œ`SplitFunc`è·å–ä¸€ä¸ªå­—èŠ‚ç‰‡ï¼Œå¹¶è¿”å›æ‰«æå™¨åº”è¯¥å‰è¿›å¤šå°‘å­—èŠ‚ï¼Œä»¥åŠä»å­—èŠ‚ç‰‡ä¸­æå–çš„â€œä»¤ç‰Œâ€ã€‚

è¿™ä¸ª`advance`è¿”å›å€¼æ­£æ˜¯æˆ‘æƒ³è¦çš„:æ‰«æå™¨çœŸæ­£å¤„ç†äº†å¤šå°‘å­—èŠ‚ã€‚

ä»è¿™é‡Œå¼€å§‹ï¼Œæˆ‘æ„å»ºäº†ä¸€ä¸ªç®€å•çš„ç»“æ„ï¼Œå®ƒåŒ…è£…äº†ä¸€ä¸ª`SplitFunc`ï¼Œå¹¶åœ¨æ¯æ¬¡æ‰§è¡Œåˆ†å‰²æ—¶é€’å¢ä¸€ä¸ªå†…éƒ¨è®¡æ•°å™¨:

```
type ScanByteCounter struct {
    BytesRead int
}

func (s *ScanByteCounter) Wrap(split bufio.SplitFunc) bufio.SplitFunc {
    return func(data []byte, atEOF bool) (int, []byte, error) {
        adv, tok, err := split(data, atEOF)
        s.BytesRead += adv
        return adv, tok, err
    }
}

func main() {
    data := []byte("foo bar baz")
    counter := ScanByteCounter{}

    scanner := bufio.NewScanner(bytes.NewBuffer(data))
    splitFunc := counter.Wrap(bufio.ScanWords)
    scanner.Split(splitFunc)

    for scanner.Scan() {
        fmt.Printf("Split Text: %s\n", scanner.Text())
        fmt.Printf("Bytes Read: %d\n\n", counter.BytesRead)
    }
    // Split Text: foo
    // Bytes Read: 4

    // Split Text: bar
    // Bytes Read: 8

    // Split Text: baz
    // Bytes Read: 11
} 
```

Enter fullscreen mode Exit fullscreen mode

è€Œä¸”ç»“æœæˆåŠŸäº†ï¼åœ¨ [Go æ¸¸ä¹åœº](https://play.golang.org/p/YOo7BJOhITO)è¯•è¯•è¿™ä¸ª

ä»¥ä¸‹æ˜¯ä¸€äº›ç»éªŒæ•™è®­:

*   å‡½æ•°åŒ…è£…æ˜¯æ‰©å±•æ ‡å‡†åº“åŠŸèƒ½æœ‰ç”¨æ€§çš„å¥½æ–¹æ³•
*   æ³¨æ„ä¸è¦å¯¹ä»/å‘ç¼“å†²åŒºè¯»å–å¤šå°‘æ•°æ®åšå‡ºå‡è®¾(ç‰¹åˆ«æ˜¯å½“è¯»å–å™¨/å†™å…¥å™¨è¢«å…¶ä»–æ¥å£æ¶ˆè€—æ—¶)

æˆ‘ä¹Ÿå¾ˆå¥½å¥‡æ˜¯å¦æœ‰å®˜æ–¹çš„æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœæœ‰æ›´å¹²å‡€çš„è§£å†³æ–¹æ¡ˆï¼Œè¯·å‘Šè¯‰æˆ‘ï¼ğŸ˜„

*å°é¢:[pix abay](https://pixabay.com/en/city-travel-cityscape-aerial-3142651/)T3ã€‘*

## è„šæ³¨

1ã€‚æˆ‘è¿˜æƒ³æ”¯æŒä»»æ„ SplitFunc çš„ä¸€èˆ¬æƒ…å†µï¼Œæ‰€ä»¥ä»»ä½•åŸºäºå®šç•Œç¬¦å¤§å°çš„ä¸œè¥¿éƒ½ä¸è¡Œã€‚