# 正确存储时间的 3 个简单规则

> 原文：<https://dev.to/xowap/3-simple-rules-to-get-time-storage-right-288i>

我认为这里的每个人都喜欢编程，但是有一个特定的主题既让人非常头疼，又出现的频率非常高。我说的是代表时间。

这个话题已经涉及了很多，但我仍然听到一些误解，所以不时重复这些事情总是好的。像 Zune bug 这样的事情不断提醒着我们，时间表示是很难的 T2 T3。当然，如果他们使用现有的经过测试的库，这就不会发生。

规则#1 : **总是**使用一个经过良好测试的库，用于所有与日期操作相关的事情

但是这并没有给出任何关于存储什么和如何存储的答案。我们来给出几个定义

*   *时间偏移* -与世界时(UTC)相比，您需要增加或减少多少小时？
*   *时区* -时间偏移遵循相同规则的地理区域(例如`Europe/Paris`有一个冬季时间偏移和一个夏季时间偏移，这适用于所有法国大都市)
*   *挂钟时间* -用户在挂钟上阅读的时间

如果您选择偏移或区域，您通常可以找到另一个，从而找到准确的时间点。我看到的唯一例外是，如果你知道挂钟时间和时区，但 DST 发生。这产生了 1 小时的重叠，在此期间时间是不明确的。

规则#2 :要引用一个精确的时刻，你需要挂钟时间加上时区或时间偏差

你怎么挑？这取决于你在寻找什么。如果你想存储一个确切的时刻，你需要存储时间偏移。否则你会得到夏令时重叠。

但是假设你正在写一个闹钟。晚上，用户将闹钟设置在第二天的精确时间，比如说早上 7 点。如果您将挂钟时间(明天早上 7 点)与今天的时间偏差存储在一起，当夏令时开始或结束时会发生什么？用户将会过晚或过早起床一小时。在这种情况下，存储时区而不是偏移量尤其重要。

**规则#3** :根据用户的意图选择使用偏移或区域

你会告诉我，总是用 UTC 存储日期或者用时间戳来代替怎么样？这就好像你选择了使用偏移量。

至于如何在实践中应用所有这些，这个话题相当广泛，因为每种语言都有所不同。然而，有几件事我想指出来。

大多数语言或数据库都有不同类型的“日期”、“时间”和“日期/时间”。通常“日期/时间”具有某种时区和/或时差意识。举例来说，PostgreSQL 有一个明确的时区管理和转换工具(基于每个值)，而 MySQL 以最可能令人困惑的方式处理它(基于每个连接)。再次强调，根据意图做出明智的选择。

日期和时间的操作也相当困难，一方面是因为时间表示的周期性，另一方面是因为大量的异常。在这里应用规则#1，总是寻找一个库来做这项工作。以 Python 为例， [dateutil 的 relativedelta](https://dateutil.readthedocs.io/en/stable/relativedelta.html) 是我最喜欢的工具之一，因为它显示的是挂钟时间，而不是电脑时间。例子:

```
from pytz import timezone, utc
from datetime import datetime

now = datetime.utcnow()\
    .replace(tzinfo=utc)\
    .astimezone(timezone('Europe/Paris'))

in_3_months = relativedelta(months=3) 
```

Enter fullscreen mode Exit fullscreen mode

它将当前日期增加了 3 个月。要手动完成这项工作，要么您处理“日期”表示，这意味着如果需要，您必须增加年份，要么您处理时间戳，并且您必须知道未来 3 个月的长度。无论哪种情况，用手做都很痛苦。

这概述了能够用人类的术语表达转换并有一个库来完成获得正确结果的工作是多么重要。

换句话说，时间通常旨在被人类阅读，而人类对时间的抽象是非常非常有漏洞的。有许多需要考虑的例外，但是你的日期将不得不来回映射到这个抽象。如果您要正确地做这件事，您需要仔细选择哪些工具和模型将代表您的人类意图，以便得到准确翻译规格说明的结果。