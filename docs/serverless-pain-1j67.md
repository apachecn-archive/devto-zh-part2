# 无服务器的痛苦

> 原文：<https://dev.to/vladusenko48/serverless-pain-1j67>

[![Lambda](img/cbf075d23520a44e1dfb3d1b8a24796d.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--SUxbrHAN--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/nwxhgsirvw31elanugpb.png)

原贴[此处](https://medium.com/@vu4848/serverless-pain-ab5547d6b122)。

简单介绍一下我和这个项目。我是一名来自乌克兰的软件开发人员，主要从事基于 JavaScript 的项目，但对任何其他技术开放。在过去的 4 个月里，我一直在做一个无服务器的项目，只用 AWS 解决方案。目标是用 API Gateway、DynamoDB 和 Lambdas 开发一个应用程序。企业需要一个 MVP，每个开发人员都可以理解为“我们需要比平常更快地找到一个好的解决方案”。好吧。

栈是在我加入项目之前选的。据我所知，客户方的技术人员认为使用上述技术将大大加快开发过程。大家之前都听说过无服务器。诸如“厌倦了基础架构管理？加入无服务器！”或者“忘了缩放吧——把所有的精力都放在代码上！”在媒体和推特上到处流行。有些人甚至认为无服务器是后端开发的未来，传统的服务器正在消亡。有些是对的，有些是错的，但在这四个月里，我积累了一些关于过去几年主要流行词的权宜之计或实用性的想法。我真的很想分享它们，这样你们在决定是否加入无服务器之前会有更多的东西要考虑。

所以让我们开始吧…

## API Gateway，Lambda，DynamoDB，那是什么？

我不会花太多时间解释 AWS 产品，但我会留下一些话。

API 网关可以被视为您的应用程序的路由器。就这么简单——创建一个端点(他们称之为资源),通过 CLI 或控制台 UI 关联一个 HTTP 动词，附加一个 AWS 服务或 Lambda 或用 VTL 构建的静态响应或一个代理目的地。在我的例子中，我只附加了 Lambdas 或者像 DynamoDB 这样的服务，VTL 允许你把 HTTP 请求体变成任何 AWS 服务请求可读的。AWS 团队在这方面做得很好👏。

Lambda 是一个很小的容器(你可以把它当作一个很小的服务器)，你可以把你的代码放在里面。使用基于 Node.js 的 lambdas，您可以放入一个包含函数的文件，该文件接受由 AWS docs 参数指定的内容。更多信息你可以在这里阅读。Lambda 是实现业务逻辑的地方。

DynamoDB 是一个无限可伸缩的 NoSQL 数据库。至少他们这么说。没错，您将使用 JSON，没错，它本身的伸缩性非常好。无限的可伸缩性很棒，但是它也给这个数据库留下了一些严重的缺点。任何东西都有价格。我想说的是，在开始设计模式之前，你真的需要阅读文档，理解 DynamoDB 是如何工作的。 DynamoDB 的利弊其实是另一篇文章的大话题。

现在，它肯定不是这些解决方案的全部，但我试图涵盖对开发人员来说最重要的部分。

他们总是说什么？“忘掉扩展和基础设施，想想代码”，对吗？我希望你在接下来的段落中记住这一点。

## 业务逻辑问题

后端没有那么大。在我的 API 网关设置中，我有大约 50 个唯一的端点，这意味着我有大约 40 个唯一的 lambdas。一些逻辑被委托给 VTL + DynamoDB 组合。一些函数用于几个端点，但是内部有 if/else 或 switch/case 语句。

听起来不错，但是问题开始出现了，就像他们说的，无服务器让你专注于你写的代码。这种每端点函数方法的第一个缺点很快就暴露出来了。正如我之前提到的，Lambdas 是很小的容器，因此你可以把它们当作独立的服务器。独立的服务器不共享随机存取存储器。正因为如此，你不能轻易地构建任何面向服务的架构。

比方说，您希望拥有一些包含一些重要且经常使用的业务逻辑的服务类，以便您遵循 DRY 原则。在经典节点服务器上，你可以构建一个类或者仅仅是一个函数，然后在你需要的任何地方导入/需要它。这很好，因为如果这个逻辑改变了，你不需要在每个使用这个逻辑的地方都更新它。现在想象一下，如果你想在两个，四个，十个 lambdas 中使用相同的逻辑。由于这些功能实际上是独立的服务器，所以实现目标的唯一方法就是…重复自己。没错，只是复制并粘贴代码——别无他法。

那怎么办呢？其中一个选择是构建一个 bash 脚本，在应该使用的每个 lambda 中共享一些东西。这是一个很好的选择，它会为你工作，但每样东西都有它的价格。现在你必须 100%确定脚本是好的，它没有被破坏，并且每个 lambda 都会收到你想要共享的东西的最新版本。这个脚本不能简单和容易地制作，因为这是你想要依赖的东西，因此你必须在它上面花费大量的时间。我只是没有那个时间。而且，向客户解释你花了一两天时间，从业务的角度来看并没有什么新的东西，这并不总是可能的。

还有另一个选择，我其实很喜欢，但也不总是可行的。你可以建立一个私有的 npm 注册表，并使用它来请求共享的内容。但为此你必须向 npm 付费，同样，企业并不总是乐意(尤其是初创企业)为你可以避免或建造的东西付费。

长话短说，共享的业务逻辑是我们在工作中每天都要依赖和使用的东西，不幸的是，它成了一个问题。

但是，你有无限的可伸缩性！

## 同时部署问题

想象一下，你有 4 个 lambda 函数，连接到 4 个不同的端点，它们共享一些业务逻辑，我在上面提到过。假设这块业务逻辑需要更改，因为有 4 个 lambda 函数在使用它，所以有 4 个 lambda 函数需要重新部署。显然，它们不能同时部署，不能完全同时部署。这意味着，在生产环境中，您可能最终会得到一些使用过时逻辑的 lambdas，这可能非常危险，您可能会在旅游数据库中有损坏的数据等等。

这个问题对软件开发界来说肯定不是什么新鲜事，但是，即使是最简单的 CRUD 后端，纯粹用 API Gateway 和 Lambdas 构建，您最终肯定会需要一些解决方案。

但是，你仍然拥有无限的可伸缩性！

## 冷启动问题

有了 lambdas，你只需为函数的工作时间付费。当功能空闲时，你不需要付费。太酷了。

兰姆达是容器。容器需要一些时间来引导和变得可用，不幸的是它一点也不快，根据我的经验，至少需要几秒钟。那么这意味着什么呢？假设你的 lambda 函数平均工作时间是 500ms。如果您的函数闲置了一段时间，它的容器将被 AWS 关闭。下次调用您的函数时，AWS 将启动容器，这将为您的端点增加几秒钟的响应时间。实际上，您的平均响应时间有时会从 300 毫秒增加到 10 秒！不太友好，对吧？

大家是怎么解决这个冷启动问题的？他们给羊肉保暖！所以他们在某个地方有一个 cron 作业，不时地触发他们的 lambdas，以防止 AWS 关闭容器。

> ![](img/41431a2f929af05551b94a7343cf3bcd.png)凯尔西·海托华@凯尔西·海托华![](img/4d9c44713c216584b3d48ff3455cbb68.png)人们真的每隔 5 分钟就关闭他们的无服务器功能以避免冷启动吗？我认为扩展到零，只为你使用的东西付费是主要卖点。[serverless.com/blog/keep-your…](https://t.co/kjG3LsXPwN)2018 年 7 月 30 日下午 18:09![Twitter reply action](img/269095962147c28351274afdd5486a48.png)[![Twitter retweet action](img/771160ecf06ae3d4d7a7815c29c819c2.png)](https://twitter.com/intent/retweet?tweet_id=1023994078873047040)261[![Twitter like action](img/c077611ab2a5e0b4cd0c826ee7ae1e48.png)](https://twitter.com/intent/like?tweet_id=1023994078873047040)858

嗯，听起来是不是你实际上最终会考虑底层基础设施？

但是，嘿，你还有… 好吧，你明白了。

考虑到所有这些问题，**你还会选择无限可伸缩性**吗？这个问题没有正确的答案，因为它只取决于你的需求。

## 其他东西

这些都不是问题，只是一些我必须提到的东西。

你不能用 lambdas 做 WebSockets，因为它们有超时，而且协议要求持续运行时间。

我构建的应用程序的一个组件需要一个实时消息选项。为此，我设置了 ECS 集群，并在那里部署了 Docker 容器。工作得很好。

同样，从一开始就不清楚如何用无服务器后端实现**升级和版本控制**。如何区分生产、开发和测试功能？幸运的是 API Gateway 有阶段的概念，我很好地利用了它。Lambdas 也有一个叫做别名的东西，你可以给函数做一个快照，然后给它一个名字。必须构建几个 bash 脚本来实现自动化，它对我来说也很好。lambdas 的分期也可能是另一篇文章的一个很好的主题。

## 总而言之…

无服务器听起来像是解决所有可伸缩性问题的灵丹妙药。就像字面上你只是写代码，这就是你要做的一切！不，完全不是这样。仍然有基础设施和问题需要处理和解决，它们只是不同而已。

在我看来，下一次我不得不从头开始处理无服务器后端时，我会三思而行，也会考虑像 TJ 制作的[**【Up】**](https://github.com/apex/up)或 [**无服务器**](https://serverless.com/%5C) 框架这样的产品。他们实际上充分利用了 API 网关和 Lambda 函数，我甚至称他们为真正的游戏改变者。使用它们编写的代码实际上看起来像一个经典的单片后端，但成本更低，因为它按需运行。

我不是说无服务器不好。这篇文章的目的是给你更多的东西，让你在加入 serverless 之前记住。

因为理论上，理论和实践是一样的，但是这个世界上没有魔法，任何东西都有它的价格。

另外，关于价格和成本，你可以阅读[这篇文章](https://medium.com/@amiram_26122/the-hidden-costs-of-serverless-6ced7844780b)

页（page 的缩写）附言:如果你喜欢这个帖子，请在媒体上给它几个掌声，我会非常感激的< 3

谢谢大家！