# ä½¿ç”¨ Nginxã€Letsencrypt å’Œ Capistrano è¿›è¡Œ HSTS é¢„åŠ è½½ã€‚ğŸ˜

> åŸæ–‡:[https://dev . to/sonica/hsts-preload-using-nginx-letsencrypt-and-capistrano-18l 7](https://dev.to/sonica/hsts-preloading-using-nginx-letsencrypt-and-capistrano-18l7)

å°æç¤º:HSTS ä»£è¡¨ HTTPS ä¸¥æ ¼çš„è¿è¾“å®‰å…¨ã€‚

HSTS æ˜¯ä¸€ç§é˜²æ­¢åè®®é™çº§æ”»å‡»çš„å®‰å…¨ç­–ç•¥æœºåˆ¶ã€‚ç®€å•æ¥è¯´ï¼Œè¿™æ„å‘³ç€å¼ºè¿«æµè§ˆå™¨åœ¨ä½ çš„ç½‘ç«™ä¸Šæ€»æ˜¯ä½¿ç”¨`https`è€Œä¸æ˜¯`http`ã€‚HSTS ä¹Ÿé˜²æ­¢ cookie åŠ«æŒï¼Œä½†æ˜¯æˆ‘ä»¬å°†åœ¨å¦ä¸€ç¯‡æ–‡ç« ä¸­è®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚

åœ¨ä¸‹é¢çš„å¸–å­ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•å¿«é€Ÿé…ç½®ä½ çš„ç½‘ç»œæœåŠ¡å™¨(nginx ),åœ¨æ‰€æœ‰åç»­è¯·æ±‚ä¸­æš—ç¤º HSTSï¼Œç„¶å*å°†è¿™ä¸ªè§„åˆ™ç¡¬ç¼–ç åˆ° Chrome å’Œå…¶ä»–ä¸»è¦æµè§ˆå™¨ä¸­ï¼Œé»˜è®¤ä¸º`https`ä½¿ç”¨ HSTS é¢„åŠ è½½ã€‚*

æˆ‘ä»¬ç°åœ¨åœ¨ [Bubblin è¶…çº§æœ¬](https://bubblin.io)ä¸Šåšè¿™ä¸ªã€‚ğŸ˜‡

æˆ‘æ¨èé˜…è¯» Scott Helme çš„åšå®¢ï¼Œäº†è§£æ›´å¤šå…³äº HSTS é¢„å‹çš„ä¿¡æ¯ã€‚

> â€¦å¸Œæœ›åœ¨å…¶ç½‘ç«™ä¸Šå¼ºåˆ¶ä½¿ç”¨ SSL/TLS çš„ä¸»æœºåˆ—è¡¨å†…ç½®åœ¨æµè§ˆå™¨ä¸­ã€‚è¯¥åˆ—è¡¨ç”±è°·æ­Œç¼–åˆ¶ï¼ŒChromeã€Firefox å’Œ Safari éƒ½åœ¨ä½¿ç”¨ã€‚è¿™äº›ç«™ç‚¹ä¸ä¾èµ–äº HSTS å“åº”æŠ¥å¤´çš„å‘å¸ƒæ¥æ‰§è¡Œç­–ç•¥ï¼Œç›¸åï¼Œæµè§ˆå™¨åœ¨ä»»ä½•è¿æ¥æˆ–é€šä¿¡å‘ç”Ÿä¹‹å‰å°±å·²ç»çŸ¥é“ä¸»æœºéœ€è¦ä½¿ç”¨ SSL/TLSã€‚

è¿™é‡Œçš„â€œé¢„åŠ è½½â€éƒ¨åˆ†æ˜¯ç½‘ç«™ç®¡ç†å‘˜æå‰å‘Šè¯‰ä¾›åº”å•†ä»–ä»¬çš„ç½‘ç«™åªåœ¨`https`ä¸Šçš„ä¸€ç§æ–¹å¼ã€‚è¿™æ ·ï¼Œæµè§ˆå™¨å°±å¯ä»¥è·³è¿‡ä¸å®‰å…¨ http ä¸Šçš„é™çº§è¯·æ±‚ã€‚

### Nginx çš„ HSTS æŒ‡ä»¤

ç°åœ¨æˆ‘ä»¬ä½¿ç”¨è€äº§å“ [Capistrano](https://capistranorb.com/) æ¥è‡ªåŠ¨éƒ¨ç½² Bubblinï¼Œå¹¶ä¸”åªé€šè¿‡ https æ¥æä¾›å›¾ä¹¦ï¼Œæ‰€ä»¥é…ç½®`nginx`åˆ°ä¸¥æ ¼çš„`https`çš„é¢„åŠ è½½éå¸¸å®¹æ˜“ã€‚æˆ‘ç¼–è¾‘äº†ç”± [capistrano3-nginx](https://github.com/treenewbee/capistrano3-nginx) gem ä¸º http - > https é‡å®šå‘é€‰æ‹©çš„æ¨¡æ¿ï¼Œå¹¶åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ äº†ä¸‹é¢çš„æŒ‡ä»¤åˆ°ç°åœ¨æˆ‘ä»¬çš„[æœ€æ–° nginx é…ç½®æ¨¡æ¿](https://gist.github.com/marvindanig/0bdd7d8768cbf5eab2fc4782803df87d)ã€‚

```
 # Path to ./config/deploy/templates/nginx_conf.erb on your rails app
# Jump over to the last line!
â€¦ 

server {
    listen 80;
    listen [::]:80 ipv6only=on; 
    server_name <%= fetch(:nginx_server_name) %> www.<%= fetch(:nginx_server_name) %>;
    rewrite ^(.*) https://$host$1$request_uri permanent;
}

server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;  
  server_name www.<%= fetch(:nginx_server_name) %>;

  # Redirection from http --> https is mandatory.
  rewrite ^ https://<%= fetch(:nginx_server_name) %>$request_uri permanent; 

}

server {
  server_name <%= fetch(:nginx_server_name) %>;
  root <%= current_path %>/public;
  try_files $uri/index.html $uri @puma_<%= fetch(:nginx_config_name) %>;

  â€¦
  â€¦

  # Plenty of nginx configuration here.

  # SSL is mandatory for HSTS. We're using 
  # Certbot to manage Letsencrypt for us.

  listen 443 ssl http2; # managed by Certbot
  listen [::]:443 ssl http2;

  # Add HSTS header with preload. This is the line that does it.
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";

} 
```

åº•éƒ¨çš„ HSTS æŒ‡ä»¤`add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";`ä¼šè¿™æ ·åšï¼Œå¹¶å‘Šè¯‰ç”¨æˆ·çš„æµè§ˆå™¨åœ¨ä½ çš„ç½‘ç«™ä¸Šæ€»æ˜¯ä½¿ç”¨`https`ã€‚

æäº¤æ›´æ”¹ï¼Œç„¶åé‡æ–°éƒ¨ç½²(cap ç”Ÿäº§éƒ¨ç½²)ã€‚ç°åœ¨å‰å¾€ hstspreload.orgã€‚

è¿™æ˜¯æˆ‘ä»¬æäº¤æˆ‘ä»¬çš„ç«™ç‚¹çš„åœ°æ–¹ï¼Œä»¥ä¾¿åŒ…å«åœ¨ Chrome çš„ HTTP ä¸¥æ ¼ä¼ è¾“å®‰å…¨(HSTS) *é¢„åŠ è½½åˆ—è¡¨*ä¸­ã€‚è¢«ç¡¬ç¼–ç åˆ° Chrome ä¸­çš„ç½‘ç«™åˆ—è¡¨åªæœ‰`https`ã€‚å¤§å¤šæ•°ä¸»æµæµè§ˆå™¨å¦‚ Firefoxã€Operaã€Safariã€IE 11 å’Œ Edge ä¹Ÿæœ‰åŸºäº Chrome æ±‡ç¼–çš„ HSTS é¢„åŠ è½½åˆ—è¡¨ã€‚ä¸ºäº†é€šè¿‡æ­¤è¡¨æ ¼è¢« HSTS é¢„åŠ è½½åˆ—è¡¨æ¥å—å¹¶ä¿ç•™ï¼Œæ‚¨çš„ç«™ç‚¹å¿…é¡»æ°¸ä¹…æ»¡è¶³ä»¥ä¸‹ä¸€ç»„è¦æ±‚:

```
1\. Serve a valid certificate.
2\. Redirect from HTTP to HTTPS on the same host, if you are listening on port 80.
3\. Serve all subdomains over HTTPS.
    In particular, you must support HTTPS for the www subdomain if a DNS record for that subdomain exists.
4\. Serve an HSTS header on the base domain for HTTPS requests:
    i. The max-age must be at least 31536000 seconds (1 year).
    ii. The includeSubDomains directive must be specified.
    iii. The preload directive must be specified.
    iv. If you are serving an additional redirect from your HTTPS site, that redirect must still have the HSTS header (rather than the page it redirects to). 
```

è¿™é‡Œè¿˜åº”è¯¥æ³¨æ„çš„æ˜¯ï¼Œå°† HSTS é¢„åŠ è½½ç¡¬ç¼–ç åˆ°æµè§ˆå™¨ä¸­å¹¶ä¸æ„å‘³ç€å®‰å…¨æ€§çš„æ‰€æœ‰æ–¹é¢éƒ½å¾—åˆ°äº†è€ƒè™‘ã€‚å®ƒè‚¯å®šæœ‰åŠ©äºå®‰å…¨ï¼Œè€Œä¸”åœ¨ä½ çš„ç½‘ç»œæœåŠ¡å™¨çš„é€Ÿåº¦å’Œæ€§èƒ½ä¸Šæœ‰ä¸€ä¸ªå°çš„æé«˜ï¼Œå› ä¸ºå®ƒä¸å†éœ€è¦ç¡®å®šå’Œåœ¨å®‰å…¨å’Œä¸å®‰å…¨çš„åè®®ä¹‹é—´åˆ‡æ¢ã€‚

è¿™å°±æ˜¯ HSTS äººçš„å…¨éƒ¨ã€‚â¤ï¸

* * *

æˆ‘æ˜¯ Sonica Aroraï¼ŒBubblin Superbooks çš„é¦–å¸­æŠ€æœ¯å®˜ï¼Œä½ å¯ä»¥åœ¨ Twitter ä¸Šå…³æ³¨æˆ‘ã€‚

**é™„è¨€:**ä½ çŸ¥é“ [Bubblin](https://bubblin.io) æ˜¯ä¸€ç§åœ¨ä½ çš„ iPad ä¸Šé˜…è¯»ä¹¦ç±çš„å¾ˆé…·çš„æ–°æ–¹å¼å—ï¼Ÿ