# 虚拟 DOM——React 的支柱

> 原文:[https://dev.to/sadarshannaiynar/virtual-dom-反应的中坚力量-3cpp](https://dev.to/sadarshannaiynar/virtual-dom---the-backbone-of-react-3cpp)

我们对 React 在处理页面更新、数据绑定等方面的性能大加赞赏。但是有很多事情发生在幕后来实现这个性能。影响因素之一是虚拟 DOM。

等等，有 DOM 这个概念，现在你告诉我有一个全新的东西叫做虚拟 DOM。这是怎么回事？。在我们继续之前，让我们了解一下什么是 DOM。

### [](#what-is-dom)什么是 DOM？

在前端 web 开发**文档对象模型**或通常所说的 DOM 中，它是 html 文档的树表示，树的每个节点都是 html 元素，html 元素的父子关系也在树中维护。这个 DOM 结构为我们提供了一种遍历 DOM 节点并进行更改的方法。普通 Javascript 提供了操纵 DOM 的 API，jQuery 进一步抽象和简化了这个 API。

好的，你是说普通的 Javascript 提供了一个 API，jQuery 也提供了一个简化的 API，如果有这些，还需要 React 和其他前端框架吗？要回答这个问题以及导致虚拟 DOM 的因素，我们必须了解 DOM 缺少什么。

### DOM 的弊端

是的，DOM 对于简单、静态的站点和很少更新 UI 的站点来说是很棒的。但是当人们开始转向更多的 UI、移动、响应驱动的方法来创建网站时，他们开始看到 DOM 的缺点。

#### [](#1-cost-of-dom-mutations)1。DOM 突变的成本

与其他 Javascript 操作相比，更新 DOM 的操作要慢得多。每当你想要更新或添加一个 DOM 时，它必须找到你想要更新的 DOM 节点，或者找到新节点必须插入的位置。这在 DOM 节点数量较少的小网站中不是问题。但是对于拥有大量 DOM 节点的大型站点，更新成本会成为一个性能问题。此外，当有 DOM 更新时，浏览器会重新绘制 DOM 节点，这使得更新更加耗时。

#### [](#2-inefficient-updates)2。低效更新

在计算到底需要更新什么时，DOM 的效率非常低。有时它可能会更新不必要内容。例如，让我们考虑一个场景。您有一个包含从一个值数组中生成的一系列`<li>`项的`<ul>`。现在，当数组中的一个值发生变化时，整个列表都会重新呈现，这是不必要的，因为只有一个项得到了更新。

通常，每当发生单个 DOM 突变调用时，这些步骤都会发生:

1.  遍历 DOM，直到必须插入或更新节点的位置。
2.  更新或添加 DOM 节点。
3.  重新计算职位和 CSS。
4.  再次遍历并重新绘制页面上的节点。

这两点再加上单页面应用程序(SPAs)的兴起(SPAs)通常有大量的 DOM 节点、DOM 突变和监听站点变化的监听器),导致人们想出了绕过这些性能问题的框架。

### [](#the-virtual-dom)虚拟 DOM

首先，让我说 React 没有发明虚拟 DOM，他们只是在性能方面做得更好。从核心意义上来说，虚拟 DOM 只是一个 Javascript 对象，它包含一个必须在真实 DOM 中呈现的节点列表，与更新实际 DOM 树相比，更新这个 Javascript 对象中的值要快得多。

基本上，如果 DOM 是实际的建筑，那么虚拟 DOM 就是建筑的蓝图。核心思想是修改蓝图总是比修改真实的建筑容易和快速。

实现虚拟 DOM 的两种方法是:

1.  脏检查:包括定期检查组件的变化。
2.  可观察的:包括通过监听器监听变化，找出需要更新的组件。

正如猜测的那样，react 使用后一种实现方式，这是 React 拥有单向数据绑定及其惊人性能的主要原因之一。

哇，这一切都很好。但是在 React 中是如何实现的呢？

### [](#synchronizing-virtual-and-real-dom)同步虚拟和真实的 DOM

基于组件更新来更新 DOM 节点的过程通常由 ReactDOM 库来完成。在此过程中通常会发生以下情况:

1.  差异/调节
2.  批量更新真实的 DOM

#### [](#diffingreconciliation)差异/对账

当类似于`setState()`的更新发生时，一个新的虚拟 DOM 树从头开始创建(不要担心它会很快，因为它只是一个 Javascript 对象)。diffing 算法比较新旧虚拟 DOM 树来找到脏组件。一旦它找到所有脏组件。然后，它确定更新实际 DOM 的最少步骤数。这种区分算法基于某些假设工作，以便使它们更快，因为 React 对一些事情使用启发式方法，我不会在这里讨论，但如果你想知道，你可以访问 React 的[协调](https://reactjs.org/docs/reconciliation.html)文档。

#### [](#batch-updating-the-real-dom)批量更新真实 DOM

一旦确定了要更新的步骤，ReactDOM 就将所有这些步骤放在事件循环中的一个调用中。ReactDOM 对这些步骤排序的方式是，它只在最后一步调用 DOM 的 repaint。所以一旦所有的步骤都被执行，事件循环就调用 DOM 重画，因此在整个过程中，DOM 只被重画一次，从而提高了性能。当 ReactDOM 更新真实 DOM 时，如果组件发生更新，它将等待真实 DOM 更新完成。

这就是 React 的虚拟 DOM 如何带来令人惊叹的性能，这已经成为 React 的商标。因此，在创建 React 应用程序时，请记住这些虚拟 DOM 的概念，以便充分利用 React 带来的性能提升。