# å¦‚ä½•å°† monolith è¿ç§»åˆ°å¯æ€•çš„æ–°ç‰ˆ Rails

> åŸæ–‡ï¼š<https://dev.to/amplifr/how-to-migrate-monolith-to-the-scary-new-version-of-rails-3o52>

è¿ç§»åˆ°æ–°ç‰ˆæœ¬çš„ Rails çœ‹èµ·æ¥æ€»æ˜¯å¾ˆå“äººã€‚è€ƒè™‘å‡çº§ä¼šå¸¦æ¥è®¸å¤šé—®é¢˜ï¼Œå°¤å…¶æ˜¯å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºæ˜¯ä¸€ä¸ªæ—§çš„æ•´ä½“ã€‚æœ€å…³é”®çš„ç‚¹æ˜¯:

*   åœ¨ä¸é˜»ç¢åŠŸèƒ½å¼€å‘çš„æƒ…å†µä¸‹å‡çº§
*   å½±å“å°½å¯èƒ½å°‘çš„ç”¨æˆ·
*   ç¡®ä¿æ‰€æœ‰é€»è¾‘åœ¨æ–°ç‰ˆ Rails ä¸Šéƒ½èƒ½æ­£å¸¸å·¥ä½œ

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å›é¡¾ä¸€äº›å¸¸è§çš„æŠ€æœ¯å’ŒæŠ€å·§ï¼Œè¿™äº›æŠ€æœ¯å’ŒæŠ€å·§è®© Amplifr çš„å›¢é˜Ÿå¯ä»¥è½»æ¾åœ°å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬çš„ Railsã€‚

â—The çš„ä¸»è¦æç¤ºæ˜¯**åªå¢é‡å‡çº§åˆ° Rails çš„[æœ€æ–°è¡¥ä¸ç‰ˆæœ¬](https://rubygems.org/gems/rails/versions)ä¸€æ¬¡**ï¼Œå› ä¸ºå¤§éƒ¨åˆ† bug å·²ç»è¢«è§£å†³äº†ã€‚è¿™ç§é€‰æ‹©æœ€å¤§é™åº¦åœ°å‡å°‘äº†æ¯æ¬¡å‡çº§æ‰€éœ€çš„é‡å¤§æ›´æ”¹ã€‚

æˆ‘ä»¬å®Œæˆäº†ä¸‰ä¸ªå‡çº§æ­¥éª¤:`4.2.0 => 5.0.7`ã€`5.0.7 => 5.1.6`ã€`5.1.6 => 5.2.0`ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ª Rails ç‰ˆæœ¬å‡çº§å‘¨æœŸå¹¶å°†å…¶äº¤ä»˜åˆ°ç”Ÿäº§ç¯å¢ƒçš„æ ‡å‡†æ­¥éª¤:

1.  **å¼ƒç”¨:**æ¸…é™¤æ‰€æœ‰é˜»ç¢ä¸‹ä¸€ä¸ª Rails ç‰ˆæœ¬æ›´æ–°çš„å¼ƒç”¨
2.  **åŒé‡å¼•å¯¼:**ä½¿åº”ç”¨ç¨‹åºå¯ä»¥åœ¨å½“å‰å’Œä¸‹ä¸€ä¸ªç‰ˆæœ¬çš„ Rails ä¸Šè¿è¡Œ
3.  **ç»¿è‰²æµ‹è¯•:**é€šè¿‡ä¸¤æ¡è½¨é“çš„æµ‹è¯•(çŸ©é˜µæ„å»º)
4.  **éƒ¨ç½²â†’ç›‘æ§â†’(æ¢å¤)â†’ä¿®å¤:**åˆ‡æ¢åˆ° Rails çš„æ–°ç‰ˆæœ¬ï¼Œç›‘æ§åº”ç”¨ç¨‹åºçš„æ–°æ•…éšœå’Œé”™è¯¯ï¼Œå¦‚æœé”™è¯¯å¾ˆä¸¥é‡å¹¶ä¸”æ‚¨éœ€è¦æ—¶é—´æ¥ä¿®å¤å®ƒä»¬ï¼Œåˆ™è¿›è¡Œæ¢å¤
5.  ç»§ç»­åšç¬¬å››ç‚¹ï¼Œç›´åˆ°ä¸€åˆ‡æ­£å¸¸

é‡å¤ä¸Šè¿°æ“ä½œï¼Œç›´åˆ°æ‚¨ä½¿ç”¨é¡¶éƒ¨å¯¼è½¨ç‰ˆæœ¬ğŸ˜

# æŠ˜æ—§

ä¸èµæˆçš„è§‚ç‚¹è®¤ä¸ºï¼Œå½“ç¬¬ä¸‰æ–¹ä¾èµ–å…³ç³»å¾—åˆ°æ›´æ–°æ—¶ï¼ŒæŸäº›ä¸œè¥¿å¯èƒ½ä¼šæŸåã€‚å› ä¸ºæˆ‘ä»¬è¦å‡çº§ Railsâ€”â€”æˆ‘ä»¬å¿…é¡»ä¸ºä¸‹ä¸€ä¸ªç‰ˆæœ¬çš„ Rails ä¿®å¤æ‹¦æˆªå™¨ã€‚

ä¸»è¦é—®é¢˜æ˜¯å…ˆæŠŠç›®æ ‡ç‰ˆæœ¬å±è”½å™¨å’Œä¿®å¤å®ƒä»¬åˆ†å¼€ã€‚é€šè¿‡ä½¿ç”¨è¿™ç§å±é™©è€Œä¸‘é™‹çš„æ‰‹æ®µæ¥éšè—æœªæ¥ç‰ˆæœ¬çš„åå¯¹æ„è§å¯¹æˆ‘ä»¬æ¥è¯´å¾ˆæœ‰æ•ˆ:

```
 if Rails::VERSION::MAJOR == 5
      # temporary mute test params deprecations
      ActiveSupport::Deprecation.behavior = lambda do |msg, stack|
        unless msg =~ /Using positional arguments in functional tests has been deprecated/
          ActiveSupport::Deprecation::DEFAULT_BEHAVIORS[:stderr].call(msg, stack)
        end
      end
    end 
```

Enter fullscreen mode Exit fullscreen mode

â—:å¦‚æœå¯èƒ½çš„è¯ï¼Œæœ€å¥½ä¸€æ¬¡ä¿®å¤æ‰€æœ‰çš„é—®é¢˜ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœå¾ˆå¤šæ—¶é—´

# åŒå¼€æœº

æƒ³æ³•æ˜¯åŒæ—¶æ”¯æŒä¸¤ä¸ªç‰ˆæœ¬çš„ Railsã€‚è®©åº”ç”¨ç¨‹åºåœ¨å½“å‰çš„ Rails ç‰ˆæœ¬ä¸Šä¿æŒå¯è¿è¡Œæ€§ï¼Œå¯ä»¥ä¿è¯å¦‚æœå‡ºç°é—®é¢˜ï¼Œæ‚¨èƒ½å¤Ÿåœ¨å…¶ä¸Šè¿è¡Œåº”ç”¨ç¨‹åºã€‚è®©åº”ç”¨ç¨‹åºåœ¨ä¸‹ä¸€ä¸ª Rails ç‰ˆæœ¬ä¸Šè¿è¡Œå°†å…è®¸æ‚¨ä¸æ–­å‡çº§ã€‚

æ ¹æ®ç¯å¢ƒå˜é‡`RAILS_NEXT` :
è®©ä½ çš„åº”ç”¨ç¨‹åºèƒ½å¤Ÿè¿è¡Œä¸¤ä¸ªç‰ˆæœ¬çš„ Railsï¼Œè¿™ä¸ªå‘½ä»¤åº”è¯¥å¼•å¯¼å½“å‰çš„ Rails ç‰ˆæœ¬

```
 bundle exec rails c 
```

Enter fullscreen mode Exit fullscreen mode

è¿™å°†å¼•å¯¼åº”ç”¨ç¨‹åºä½¿ç”¨æ–°ç‰ˆæœ¬çš„ Rails:

```
 RAILS_NEXT=1 bundle exec rails c 
```

Enter fullscreen mode Exit fullscreen mode

æ–¹æ³•æ˜¯å°†è¿™æ®µä»£ç æ”¾åœ¨`Gemfile` :
çš„å¼€å¤´ï¼Œç¨å¾®ä¿®æ”¹ä¸€ä¸‹`bundler`

```
module Bundler::SharedHelpers
  def default_lockfile=(path)
    @default_lockfile = path
  end

  def default_lockfile
    @default_lockfile ||= Pathname.new("#{default_gemfile}.lock")
  end
end

module ::Kernel
  def rails_next?
    ENV["RAILS_NEXT"] == '1'
  end
end

if rails_next?
  Bundler::SharedHelpers.default_lockfile =
    Pathname.new("#{Bundler::SharedHelpers.default_gemfile}_next.lock")

  class Bundler::Dsl
    unless method_defined?(:to_definition_unpatched)
      alias_method :to_definition_unpatched, 
                   :to_definition
    end

    def to_definition(_bad_lockfile, unlock)
      to_definition_unpatched(Bundler::SharedHelpers.default_lockfile, unlock)
    end
  end
end

gem 'rails' #relax dependency 
```

Enter fullscreen mode Exit fullscreen mode

è¿™æ®µä»£ç åšäº†å‡ ä»¶äº‹:

*   å®šä¹‰äº†`rails_next`ï¼Ÿæ–¹æ³•ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨:åœ¨`Gemfile`ä¸­ï¼Œåœ¨ä½ çš„ ruby åº”ç”¨ç¨‹åºçš„ä»£ç ä¸­ï¼Œç­‰ç­‰
*   å®šä¹‰ singleton-method æ¥ä¿å­˜å½“å‰ç»‘å®šå™¨çš„é”æ–‡ä»¶å
*   å¦‚æœ`rails_next?`è¢«æ¿€æ´»ï¼Œå°†é”å®šæ–‡ä»¶åé‡ç½®ä¸º`Gemfile_next.lock`

â—Noteï¼Œæˆ‘ä»¬**ä¸ºæ¯ä¸ªç‰ˆæœ¬çš„ Rails** ä½¿ç”¨ä¸€ä¸ª`Gemfile`å’Œä¸¤ä¸ªé”æ–‡ä»¶ã€‚ç»´æŠ¤èµ·æ¥å°±å®¹æ˜“å¤šäº†ã€‚

# ä¾èµ–å…³ç³»

é¦–å…ˆï¼Œæ”¾æ¾`Gemfile`ä¸­çš„ Rails ä¾èµ–æ¥å¯ç”¨æ›´é«˜ç‰ˆæœ¬çš„ Rails:
å¦‚æœä½ æœ‰ Rails ç‰ˆæœ¬è¢«è¿™æ ·é”å®š:

```
gem 'rails', '~> 4.2.3' 
```

Enter fullscreen mode Exit fullscreen mode

æ‰“å¼€å®ƒã€‚

```
gem 'rails' 
```

Enter fullscreen mode Exit fullscreen mode

å®ƒå…è®¸`Gemfile`å…¼å®¹æ‰€æœ‰ç‰ˆæœ¬çš„ Railsã€‚å½“å‰å’Œä¸‹ä¸€ä¸ª rails ç‰ˆæœ¬å°†è¢«é”å®šåœ¨ç›¸åº”çš„`lock`-æ–‡ä»¶ä¸­ã€‚

ç„¶åå°†`Gemfile.lock`å¤åˆ¶åˆ°`Gemfile_next.lock`å¹¶å°è¯•æ›´æ–°`rails_next` :
ä¸Šçš„ rails

```
 $ cp Gemfile.lock Gemfile_next.lock
    # run bundle for fixing dependencies matedata in original Gemfile
    $ bundle
    # run bundle on rails_next to update rails
    $ RAILS_NEXT=1 bundle update rails 
```

Enter fullscreen mode Exit fullscreen mode

åœ¨è¿™é‡Œï¼Œä½ ä¼šå¾—åˆ° bundler åŠªåŠ›å·¥ä½œï¼Œä»¥è§£å†³ä¾èµ–å…³ç³»ï¼Œå¹¶å¯èƒ½åœ¨ä¸­é€”å¤±è´¥ã€‚å¤±è´¥æ„å‘³ç€æŸäº›ä¾èµ–é¡¹ä¸å…è®¸ä¸è¾ƒæ–°ç‰ˆæœ¬çš„ Rails ä¸€èµ·å·¥ä½œã€‚ä»¥ä¸‹æ˜¯ä¸€äº›åœºæ™¯:

*   Gem çš„å½“å‰ç‰ˆæœ¬è¢«é”å®šï¼Œä¸å—æ”¯æŒã€‚å®ƒæœ‰æ–°çš„ç‰ˆæœ¬æ¥æ”¯æŒæ–°ç‰ˆæœ¬çš„ Railsã€‚å¦‚æœåªæœ‰`rails_next?`èµ·ä½œç”¨ï¼Œæˆ‘ä»¬å¿…é¡»æ›´æ–° gem:

```
 if rails_next?
      gem 'devise'
    else
      gem 'devise', git: 'https://github.com/plataformatec/devise', branch: '3-stable'
    end 
```

Enter fullscreen mode Exit fullscreen mode

*   Gem ä»ä¸Šé¢é”å®šäº† Rails ç‰ˆæœ¬:`rails < 5.0`ï¼Œä½†å¯èƒ½é€‚ç”¨äºæ›´æ–°çš„ç‰ˆæœ¬ã€‚ä½ éœ€è¦è§£å¼€ä¾èµ–ï¼Œè¯•ä¸€è¯•ã€‚å°è¯•ä» GitHub æœ¬åœ°å…‹éš†è¿™ä¸ª gemï¼Œåœ¨`gemspec`æ–‡ä»¶ä¸­æ”¾æ¾å¯¹ Rails çš„ä¾èµ–ï¼Œåœ¨æœ¬åœ°æ’å…¥ gemã€‚å¦‚æœæœ‰æ•ˆ-å¾ˆå¥½ï¼Œè½¬åˆ°ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œå¦‚æœæ— æ•ˆ-å°è¯•å…¶ä»–è§£å†³æ–¹æ¡ˆã€‚
*   ç”±äºä¸å…¼å®¹ï¼ŒGem é”å®šäº† Railsï¼Œå¹¶ä¸”ä¸èƒ½ä¸æ–°ç‰ˆæœ¬ä¸€èµ·ä½¿ç”¨ã€‚ä½ éœ€è¦è§£å¼€ä¾èµ–ï¼Œç†è§£ gem å¦‚ä½•å·¥ä½œï¼Œé—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Œç„¶åè§£å†³æ‰€æœ‰çš„å†²çªï¼Œå¹¶åœ¨è¿™ä¸ª gem ä¸­æµ‹è¯•æ–°ç‰ˆæœ¬çš„ railsã€‚

å¤„ç†æœ€åçš„æƒ…å†µ-ä½ å°†ä¸å¾—ä¸æ›´æ–° gem æºä»£ç ã€‚é¦–å…ˆï¼Œæ‚¨å°†ä¿®å¤æ‚¨çš„ fork ä¸­çš„é—®é¢˜ã€‚å°½ç®¡è¿™ç§æ–¹å¼çœ‹èµ·æ¥éå¸¸ç®€å•ã€å¿«é€Ÿå’Œå®¹æ˜“â€”â€”ä½†æ˜¯æœ‰è®¸å¤šç†ç”±é¿å…å°†å®ƒä¿å­˜åœ¨ forks ä¸­:

*   ä½œè€…(æˆ–ä¸€ç»„ä½œè€…)ä»¥é›†ä¸­çš„æ–¹å¼ç»´æŠ¤ä»–ä»¬çš„å®çŸ³ã€‚æ²¡æœ‰äººæœ‰å…´è¶£æ”¯æŒä½ çš„å‰å­ğŸ˜¢ä½ çš„å‰å­æ˜¯ä½ çš„é—®é¢˜ï¼
*   åˆ†å‰å¯ä»¥è®©ä½ å¿«é€Ÿè§£å†³é—®é¢˜ï¼Œä¸éœ€è¦è®¾è®¡å’Œæµ‹è¯•ï¼Œä½†æ˜¯å®ƒåªæ˜¯æ¨è¿Ÿäº†é—®é¢˜çš„è§£å†³ã€‚å°†æ¥ä»è¿œç¨‹æºå‡çº§ fork æ—¶ï¼Œæ‚¨å°†ä¼šå¾—åˆ°å›æŠ¥
*   ä»¥é›†ä¸­çš„æ–¹å¼è§£å†³é—®é¢˜(é€šè¿‡å‘é€æ‹‰å¼è¯·æ±‚)æœ‰åŠ©äºå…¶ä»–å¼€å‘äººå‘˜å¤„ç†ç›¸åŒçš„é—®é¢˜ã€‚è¯·æäº¤æ‹‰åŠ¨å¼è¯·æ±‚ï¼Œè‡ªç”±æŠ•ç¨¿ï¼

â—The ä¿®å¤ gem æºä»£ç çš„æ›´å¥½æ–¹æ³•æ˜¯**å‘ gem çš„å­˜å‚¨åº“**å‘é€æ‹‰è¯·æ±‚ã€‚

ä¸å¹¸çš„æ˜¯ï¼Œä¸€äº›å®çŸ³å› ä¸ºè®¸å¤šåŸå› æ²¡æœ‰äººæ¥ç»´æŠ¤ã€‚è¿™æ˜¯ä¸€ä¸ªä¿¡å·ï¼Œè®©ä½ æ£€æŸ¥ä½ çš„ä¾èµ–ï¼Œä¸ºäº†æ›´å—æ¬¢è¿çš„ä¸œè¥¿è€ŒæŠ›å¼ƒé‚£äº›ä¸å¯ç»´æŠ¤çš„ã€‚

â—Note è¯´ä½ å¿…é¡»**æ›´æ–°æ‰€æœ‰çš„ gem ä¸¤æ¬¡æ¥æ”¯æŒä¸¤ä¸ªç‰ˆæœ¬çš„ Rails** ï¼Œå¹¶æäº¤`Gemfile.lock`å’Œ`Gemfile_next.lock`æ¥ä¿æŒå®ƒä»¬ç›¸ä¼¼ã€‚

```
 bundle update some-gem
    RAILS_NEXT=1 bundle update some-gem 
```

Enter fullscreen mode Exit fullscreen mode

# å¯è¿è¡Œçš„åº”ç”¨

å½“æ‰€æœ‰çš„ä¾èµ–é¡¹éƒ½æ²¡é—®é¢˜ï¼Œå¹¶ä¸”æ‚¨çš„ bundler æˆåŠŸè§£æäº†`rails_next` -æ‚¨å°±å‡†å¤‡å¥½è¿›è¡Œä¸‹ä¸€æ­¥äº†-æ£€æŸ¥åº”ç”¨ç¨‹åºæ˜¯å¦å¯è¿è¡Œã€‚

æ‚¨å¯ä»¥å°è¯•è¿è¡Œ Rails æ§åˆ¶å°æˆ–æœ¬åœ° web æœåŠ¡å™¨ï¼Œä½†æ˜¯æœ€å¥½ä»è¿è¡Œæµ‹è¯•å¼€å§‹:

```
 RAILS_NEXT=1 bundle exec rspec 
```

Enter fullscreen mode Exit fullscreen mode

æµ‹è¯•å¾ˆæœ‰å¯èƒ½æ— æ³•å¼€å§‹ï¼Œç”šè‡³å¤±è´¥ã€‚è¿™é‡Œçš„ä¸»è¦é—®é¢˜æ˜¯ä½ çš„ä»£ç æˆ–ä¸€äº› gems çš„ä»£ç ä¸æ–°çš„ Rails ç‰ˆæœ¬ä¸å…¼å®¹ã€‚æ‰€ä»¥åªæœ‰ä¸€ä¸ªå»ºè®®:æ·±å…¥å¹¶ä¿®å¤å®ƒã€‚

â—æˆ‘ä»¬ä½¿ç”¨çš„ä¸€ä¸ªæŠ€å·§æ˜¯æš‚æ—¶ä½¿ç”¨`rails_next?`æ–¹æ³•ç¼–å†™ **Rails ç‰ˆæœ¬ç›¸å…³ä»£ç ** :

```
 project.run_callbacks(:commit) if rails_next? 
```

Enter fullscreen mode Exit fullscreen mode

å®ƒæœ‰åŠ©äºç¼–å†™ç‰¹å®šäºç‰ˆæœ¬çš„ä»£ç :

```
 if rails_next?
      redirect_to user_omniauth_authorize_path(:instagram)
    else
      redirect_to user_instagram_omniauth_authorize_path
    end 
```

Enter fullscreen mode Exit fullscreen mode

# ç»¿è‰²æµ‹è¯•

å°†é¢å¤–çš„æ„å»ºæ·»åŠ åˆ°æ‚¨çš„ CI ä¸­ï¼Œä»¥ä¾¿ä½¿ç”¨ä¸‹ä¸€ä¸ª Rails ç‰ˆæœ¬è¿è¡Œæµ‹è¯•ã€‚å¦‚æœæ‚¨åœ¨ TravisCI ä¸Šè¿è¡Œï¼Œå®ƒå¯èƒ½æ˜¯è¿™æ ·çš„:

```
 matrix:
      include:
        - env: RAILS_NEXT=0
        - env: RAILS_NEXT=1 
```

Enter fullscreen mode Exit fullscreen mode

å¦‚æœæ‚¨çš„ä¸‹ä¸€ä¸ª Rails ç‰ˆæœ¬æµ‹è¯•è¿˜æ²¡æœ‰é€šè¿‡â€”â€”æ‚¨å¯ä»¥åƒè¿™æ ·å°†å®ƒä»¬æ ‡è®°ä¸ºå¯é€‰çš„:

```
 matrix:
      include:
        - env: RAILS_NEXT=0
        - env: RAILS_NEXT=1
      allow_failures:
        - env: RAILS_NEXT=1 
```

Enter fullscreen mode Exit fullscreen mode

è¿™ç§æ–¹æ³•å°†è®©æ‚¨å°†çŸ©é˜µæ„å»ºåˆå¹¶åˆ°ä¸»åˆ†æ”¯ï¼Œè€Œä¸å½±å“ç‰¹æ€§å¼€å‘ï¼Œå¹¶ä¸”æ‚¨å°†èƒ½å¤Ÿå¹¶è¡Œåœ°è¿›è¡Œæµ‹è¯•ã€‚

æœ€åï¼Œæ‚¨éœ€è¦ä½¿æ‚¨çš„æµ‹è¯•å¯¹ä¸¤ä¸ªç‰ˆæœ¬éƒ½æ˜¯ç»¿è‰²çš„ã€‚

â— **ä¸ç»è¿‡æµ‹è¯•å°±å‡çº§â€”â€”ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„**ğŸ™‚ï¼Œå› ä¸ºä¸å¯èƒ½ç¡®ä¿å…³é”®çš„åº”ç”¨ç¨‹åºéƒ¨åˆ†åœ¨ä¸‹ä¸€ä¸ªç‰ˆæœ¬ä¸­å·¥ä½œã€‚

# éƒ¨ç½²&ç­é•¿

æ˜¯æ—¶å€™å±•ç¤ºäº†ï¼

å¦‚æœæ‚¨æœ‰è¯•è¿è¡Œâ€”â€”é¦–å…ˆåœ¨é‚£é‡Œéƒ¨ç½²ï¼Œå¹¶æ‰‹åŠ¨æ£€æŸ¥ä¸»è¦åŠŸèƒ½ã€‚è¿™å°†é£é™©é™è‡³æœ€ä½ï¼Œå¹¶æœ‰å¯èƒ½æŠ“ä½ä¸€äº›æ¼æ´ã€‚

åœ¨ç”Ÿäº§ä¸­è¿è¡Œæ›´æœ‰æ•ˆã€‚å®ƒè®©çœŸå®çš„ç”¨æˆ·åœ¨çœŸå®çš„æ¡ˆä¾‹ä¸­æµ‹è¯•åº”ç”¨ç¨‹åºã€‚ä¸»è¦çš„æƒ³æ³•æ˜¯â€œä¸€ç‚¹ç‚¹â€åœ°éƒ¨ç½²æ–°çš„ Rails ç‰ˆæœ¬ï¼Œå¹¶è®°ä½æ¢å¤ç­–ç•¥ï¼Œè¿™å°†å¸®åŠ©æ‚¨ä¸å½±å“ç”¨æˆ·å¤ªå¤šæˆ–å¤ªé•¿æ—¶é—´ã€‚

æ ¹æ®æ‚¨çš„åŸºç¡€æ¶æ„ï¼Œæ‚¨å¯èƒ½æ›´å–œæ¬¢ä½¿ç”¨å…¶ä¸­ä¸€ç§æ¨å¹¿ç­–ç•¥ï¼Œæˆ–è€…å°†å®ƒä»¬ç»“åˆä½¿ç”¨:

1.  ä½¿ç”¨æ–°çš„ Rails ç‰ˆæœ¬åº”ç”¨ç¨‹åºå®ä¾‹ä¸ºç‰¹å®šç«¯ç‚¹æä¾›æœåŠ¡ï¼Œä»ä½è´Ÿè½½åˆ°é«˜è´Ÿè½½å¼€å§‹ï¼Œæˆ–è€…ä»éå…³é”®å¼€å§‹ã€‚
2.  ä¸Šèœå æ€»è´Ÿè·çš„ç™¾åˆ†æ¯”ï¼Œç„¶åå¢åŠ è¿è¡Œç‡ã€‚
3.  åœ¨ä½è´Ÿè½½æ—¶é—´(å¦‚æœæœ‰)éƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚åœ¨æ™šä¸Š
4.  å…¨åŠ›ä»¥èµ´ï¼Œä¿æŒå†·é™ğŸ™‚

æˆ‘ä»¬å†³å®šç”¨æ–°çš„ Rails ç‰ˆæœ¬æ¨å‡º all Amplifrï¼Œå› ä¸ºè¿™æ˜¯æœ€è¿›æ­¥çš„æ–¹å¼ï¼Œå¯¹æˆ‘ä»¬æ¥è¯´ï¼Œå›æ»šåˆ°ä»¥å‰çš„ Rails ç‰ˆæœ¬éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚

ä¸€æ—¦ä½ æ¨å‡ºäº†åº”ç”¨ç¨‹åº(æˆ–å®ƒçš„ä¸€éƒ¨åˆ†)å¹¶è®©çœŸæ­£çš„ç”¨æˆ·é¢å¯¹å®ƒï¼Œä¿æŒç›‘æ§é”™è¯¯æ˜¯å¾ˆé‡è¦çš„ã€‚æœ‰ä¸¤ç§äº†è§£é—®é¢˜çš„ä¸€èˆ¬æ–¹æ³•:

1.  ä½¿ç”¨ä¸€äº›å·¥å…·è‡ªåŠ¨ç›‘æ§ï¼Œå¦‚`Honeybadger`ã€`Rollbar`ã€`Sentry`ã€`NewRelic`ã€‚**æ‹¥æœ‰å®ƒâ€”â€”æ˜¯å¿…é¡»çš„ï¼é€šè¿‡ Slackã€ç”µå­é‚®ä»¶æˆ–å…¶ä»–æ–¹å¼åœ¨çº¿é€šçŸ¥ä»–ä»¬é—®é¢˜å’Œç¼ºé™·çš„åŸå› æ˜¯å¾ˆæœ‰ç”¨çš„**
2.  çœŸæ­£çš„ç”¨æˆ·å¯¹äºåƒ Amplifr è¿™æ ·çš„å°å›¢é˜Ÿæ¥è¯´æ˜¯è‡³å…³é‡è¦çš„ã€‚æ— è®ºä½ å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œäº†å¤šå°‘æµ‹è¯•ï¼Œæµ‹è¯•è¦†ç›–ç‡æœ‰å¤šé«˜ï¼Œä½ éƒ½æœ‰å¯èƒ½æ¼æ‰ä¸€äº›é”™è¯¯ï¼Œå°¤å…¶æ˜¯åœ¨ä¸šåŠ¡é€»è¾‘æ–¹é¢ã€‚æ°¸è¿œå¯¹ä½ çš„ç”¨æˆ·å‹å¥½å’Œè€å¿ƒï¼Œå½“ä½ éœ€è¦ä»–ä»¬çš„å¸®åŠ©æ—¶ï¼Œä»–ä»¬ä¼šä»¥åŒæ ·çš„æ–¹å¼è¡¨ç°ã€‚ğŸ™‚

å¦‚æœå‡ºç°é—®é¢˜â€”â€”é€šè¿‡æ”¹å˜ç¯å¢ƒå˜é‡`RAILS_NEXT`çš„å€¼æ¥æ¢å¤ã€‚å…·ä½“æ–¹å¼å–å†³äºæ‚¨æ‹¥æœ‰çš„åŸºç¡€è®¾æ–½:

```
 export RAILS_NEXT=0 
```

Enter fullscreen mode Exit fullscreen mode

â— **å›æ»šå¹¶ä¸æ„å‘³ç€å¤±è´¥**ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒã€‚å®ƒè®©æ‚¨æœ‰æ—¶é—´ä¿®å¤æ–°å‘ç°çš„é”™è¯¯ï¼ŒåŒæ—¶åº”ç”¨ç¨‹åºå¯ä»¥åœ¨ä»¥å‰ç‰ˆæœ¬çš„ Rails ä¸Šç¨³å®šè¿è¡Œã€‚**åšæŒä¸‹å»ï¼**

æˆ‘ä»¬æœ‰å‡ æ¬¡å›æ»šæ¥ä¿®å¤ Amplifr ä¸­çš„å…³é”®é”™è¯¯ã€‚

â—After æˆåŠŸå‡çº§ï¼Œè®©åº”ç”¨ç¨‹åºåœ¨æ–°ç‰ˆ Rails ä¸Šé•¿æœŸå·¥ä½œï¼Œä»¥æœ€å°åŒ–é£é™©å¹¶ä¿®å¤æ‰€æœ‰ bugã€‚

## æ‰“æ‰«å«ç”Ÿ

å‡çº§æˆåŠŸåï¼Œæˆ‘ä»¬å·²ç»æ¸…ç†äº†æºä»£ç ï¼Œåˆ‡æ–­äº†å¯¹ä¹‹å‰ Rails çš„æ”¯æŒã€‚

*   é»˜è®¤æƒ…å†µä¸‹ï¼Œè®©åº”ç”¨ç¨‹åºè¿è¡Œæ–°ç‰ˆæœ¬çš„ Railsã€‚æ‚¨å¿…é¡»å¤åˆ¶ä¸‹ä¸€ä¸ª`lock`-æ–‡ä»¶å†…å®¹å¹¶æäº¤å®ƒ:cat Gemfile _ next . lock>Gemfile . lock git commit...
*   éƒ¨ç½²åº”ç”¨å¹¶åˆ‡æ¢ RAILS_NEXT `1` â†’ `0`
*   æˆªæ‰`Gemfile_next.lock`:git RM Gemfile _ next . lock git commit
*   åˆ é™¤æ‰€æœ‰ç‰ˆæœ¬ç›¸å…³çš„ä»£ç ï¼›ä½ å¾ˆå®¹æ˜“å°±èƒ½æ‰¾åˆ°:grep -ir "rails_next\ï¼Ÿã€‚/
*   ä»`Gemfile`ä¸­ç§»é™¤`Bunder`çš„é»‘å®¢

æˆ‘ä»¬è¿˜æ²¡æœ‰åˆ é™¤åŒé‡å¼•å¯¼ä»£ç ï¼Œå¹¶åœ¨æœªæ›´æ–°çš„`lock`-æ–‡ä»¶ä¸Šè¿è¡Œäº†å‡ å¤©ã€‚ğŸ¤¦â€â™‚ï¸ï¼Œå°å¿ƒç‚¹ã€‚ğŸ™‚

â—Ifï¼Œä½ å°†ç»§ç»­å‡çº§ï¼Œä»ä¸‹ä¸€ä¸ªç‰ˆæœ¬å¼€å§‹ä¹è®¨ã€‚

## å¾…åœ¨è¾¹ç¼˜

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯æœ€åä¸€ä¸ªç¨³å®šç‰ˆæœ¬ï¼Œæ‚¨å¯èƒ½æ›´æ„¿æ„åœæ­¢ä½¿ç”¨å®ƒã€‚å¦ä¸€ä¸ªé€‰æ‹©æ˜¯åœ¨ Rails çš„ä¸‹ä¸€ä¸ªç‰ˆæœ¬ä¸­ç»§ç»­å‡çº§`master`åˆ†æ”¯ã€‚

```
 gem 'rails', git: 'git@github.com/rails/rails' 
```

Enter fullscreen mode Exit fullscreen mode

è¿™ç§æ–¹å¼ä¸æ˜¯å•å€¼çš„ï¼Œä½†å¯èƒ½æ˜¯æ¸è¿›çš„ã€‚å¤§å¤šæ•° gem ä¸æ”¯æŒæ–°ç‰ˆæœ¬ï¼Œä½ å¿…é¡»åœ¨é‚£é‡Œåšå‡ºè´¡çŒ®ã€‚è¿™å¯èƒ½å¾ˆå±é™©ï¼Œä¼šè®©æ‚¨å‘ç° Rails ä»£ç ä¸­ä¸ç¨³å®šç‰¹æ€§çš„ bugã€‚ä½†æ˜¯ä»å¦ä¸€æ–¹é¢æ¥è¯´â€”â€”ä½ å°†ç»§ç»­å…³æ³¨ Rails çš„æ–°ç‰ˆæœ¬ï¼Œä½¿ä½ çš„å‡çº§åœ¨æœªæ¥å˜å¾—è½»æ¾èˆ’é€‚ï¼Œå¹¶ä¸”æœ‰åŠ©äº Ruby çš„ gems æºä»£ç ã€‚

# ç»“è®º

å°½ç®¡å‡çº§ Rails ç‰ˆæœ¬çœ‹èµ·æ¥å·¥ä½œé‡å¾ˆå¤§ï¼Œä½†æ˜¯ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬æ˜¯éå¸¸å¿…è¦çš„ï¼ŒåŸå› å¦‚ä¸‹:

*   å®ƒæ›´åŠ ç¨³å®šã€å¿«é€Ÿ
*   å®ƒæœ‰æ–°çš„ç‰¹ç‚¹
*   å®ƒå…è®¸æ‚¨ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ gem

è¿­ä»£åœ°ã€ä¸€æ­¥ä¸€æ­¥åœ°è¿›è¡Œå‡çº§ï¼Œå¹¶ç‰¢è®°æ¢å¤ç­–ç•¥å¯ä»¥ä½¿æ‚¨çš„å‡çº§ä¸é‚£ä¹ˆç—›è‹¦ã€‚

# è¿›ä¸€æ­¥é˜…è¯»(è§‚çœ‹):

*   Luke Francl çš„æ–‡ç« 
*   RailsConf 2017: [å°†å¤§å‹åº”ç”¨å‡çº§åˆ° Rails 5](https://www.youtube.com/watch?v=I-2Xy3RS1ns) ä½œè€… Rafael FranÃ§
*   [åœ¨ Shopify çš„åšå®¢ä¸Šå°† Shopify å‡çº§åˆ° Rails 5](https://engineering.shopify.com/blogs/engineering/upgrading-shopify-to-rails-5-0)
*   [Shopify åšå®¢ä¸Šçš„ Shopify å¼ƒç”¨å·¥å…·åŒ…ä½¿ç”¨æ¡ˆä¾‹](https://engineering.shopify.com/blogs/engineering/introducing-the-deprecation-toolkit)
*   [åå¹´é“è·¯å‡çº§](https://speakerdeck.com/jnraine/ten-years-of-rails-upgrades)Jordan Raine çš„å¹»ç¯ç‰‡
*   [æˆ‘ä»¬å¦‚ä½•åœ¨é›¶åœæœºæ—¶é—´å†…å‡çº§å¤§å‹ Ruby on Rails monolithã€‘](https://bytes.babbel.com/en/articles/2015-12-14-rails-4-upgrade.html)
*   [Kir Shatrov åœ¨ Shopify ä¸Šè°ˆè®º Rails å‡çº§(ä¿„è¯­)](https://www.youtube.com/watch?v=nqGxzUGtkNw)