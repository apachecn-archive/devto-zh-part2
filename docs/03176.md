# ä¸ä½¿ç”¨æ¡†æ¶å¦‚ä½•å¤„ç† POST è¯·æ±‚ä½“

> åŸæ–‡:[https://dev . to/graphic beacon/how-to-handle-the-post-request-body-without-use-a-framework-49oj](https://dev.to/graphicbeacon/how-to-handle-the-post-request-body-without-using-a-framework-49oj)

åœ¨åŸºäº Node çš„ç±»ä¼¼çš„[æ–‡ç« ](https://itnext.io/how-to-handle-the-post-request-body-in-node-js-without-using-a-framework-cd2038b93190)çš„ç§¯æå›åº”ä¹‹åï¼Œæˆ‘å‘ç°åœ¨ Dart ä¸­æ¼”ç¤ºè¿™ä¸€ç‚¹æ˜¯åˆé€‚çš„ã€‚é•¿è¯çŸ­è¯´ï¼Œæˆ‘å‘ç°è¿™æ ·æ›´ç®€å•ã€‚

è¿™ä¸ªä¾‹å­åœ¨è¯·æ±‚æœ‰æ•ˆè´Ÿè½½çš„`Content-Type`æ˜¯`application/x-www-form-urlencoded`çš„æƒ…å†µä¸‹å·¥ä½œï¼Œè¿™å®é™…ä¸Šæ„å‘³ç€è¡¨å•æ•°æ®åœ¨å‘é€åˆ°æœåŠ¡å™¨æ—¶è¢«æ ¼å¼åŒ–ä¸ºæŸ¥è¯¢å­—ç¬¦ä¸²ã€‚

## [](#1-create-our-server)1ã€‚åˆ›å»ºæˆ‘ä»¬çš„æœåŠ¡å™¨

åˆ›å»ºä¸€ä¸ª`main.dart`æ–‡ä»¶ï¼Œå¹¶è¾“å…¥ä¸‹é¢çš„ä»£ç ç‰‡æ®µ:

```
import 'dart:io';

void main() async {
  var server = await HttpServer.bind('localhost', 9000);

  await for (HttpRequest req in server) {
    req.response
      ..headers.set('Content-Type', 'text/html')
      ..write('''
        <!doctype html>
        <html>
        <body>
          <form action="/" method="post">
            <input type="text" name="fname" /><br />
            <input type="number" name="age" /><br />
            <input type="file" name="photo" /><br />
            <button>Save</button>
          </form>
        </body>
        </html>
      ''')
      ..close();
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å°†å¼•å¯¼æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼Œå¹¶åœ¨å‘`http://localhost:9000`å‘å‡ºè¯·æ±‚æ—¶ç”¨ä¸€ä¸ªè¡¨å•è¿›è¡Œå“åº”ã€‚è¯¥ä»£ç ç‰‡æ®µä»å¯¼å…¥`dart:io`åº“å¼€å§‹ï¼Œå› ä¸ºå®ƒåŒ…å«äº†åˆ›å»ºæœåŠ¡å™¨æ‰€éœ€çš„ç±»ã€‚æ•´ä¸ªå¼•å¯¼è¿‡ç¨‹å‘ç”Ÿåœ¨ä¸€ä¸ª`main()`å‡½æ•°ä¸­ï¼Œè¿è¡Œæˆ‘ä»¬çš„ Dart åº”ç”¨ç¨‹åºéœ€è¦è¿™ä¸ªå‡½æ•°ã€‚

è¦è¿è¡Œè¯¥æ–‡ä»¶ï¼Œè¯·åœ¨ç»ˆç«¯ä¸­é”®å…¥ä»¥ä¸‹å‘½ä»¤:

```
dart main.dart 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨åº”è¯¥ä¼šåœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°ä¸€ä¸ªè¡¨å•:

[![localhost](../Images/a1d7ed4302ba2d566db0a4eaa29c6f5a.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--B9hcZur1--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ba9z5p3rjxluez15m9se.png)

## [](#2-capture-the-posted-payload)2ã€‚æ•è·å‘å¸ƒçš„æœ‰æ•ˆè´Ÿè½½

ç°åœ¨è®©æˆ‘ä»¬ç¡®ä¿æˆ‘ä»¬æ­£åœ¨å¤„ç†ä¸€ä¸ª POST è¯·æ±‚:

```
...
...
await for (HttpRequest req in server) {
  if (req.method == 'POST') {
   // deal with the payload 
  } else {
    req.response
      ..headers.set('Content-Type', 'text/html')
      ..write('''
        <!doctype html>
        <html>
        <body>
          <form action="/" method="post">
            <input type="text" name="fname" /><br />
            <input type="number" name="age" /><br />
            <input type="file" name="photo" /><br />
            <button>Save</button>
          </form>
        </body>
        </html>
      ''')
      ..close();
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯¹æœåŠ¡å™¨çš„è¯·æ±‚è¢«è§†ä¸ºä¸€ä¸ª`Stream`ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯·æ±‚çš„`transform`æ–¹æ³•æ¥è§£ç å†…å®¹ã€‚

```
if (req.method == 'POST') {
  var content = await req.transform().join();
} ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ä¼šé©¬ä¸Šç”Ÿæ•ˆï¼Œå› ä¸º`transform`æ–¹æ³•éœ€è¦ä¸€ä¸ª`StreamTransformer`ã€‚ä¸€ä¸ª`StreamTransformer`åŒ…å«ä¸€ä¸ª`bind`æ–¹æ³•ï¼Œå…è®¸å®ƒä»¥æŸç§æ–¹å¼æ“çºµæµæ•°æ®ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¥å°†æˆ‘ä»¬çš„æµè¯·æ±‚æ•°æ®è½¬æ¢æˆå¯è¯»çš„æ ¼å¼ï¼Œç„¶åä½¿ç”¨`join`æ–¹æ³•æ¥ç»„åˆæˆ‘ä»¬çš„*è½¬æ¢åçš„*å—ã€‚

åœ¨æˆ‘ä»¬çš„`dart:io`å¯¼å…¥ä¸‹é¢ï¼Œæˆ‘ä»¬éœ€è¦`dart:convert`åº“:

```
import 'dart:io';
import 'dart:convert'; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¹¶ä½¿ç”¨`Utf8Decoder`ä½œä¸ºæˆ‘ä»¬çš„å˜å‹å™¨:

```
var content = await req.transform(Utf8Decoder()).join(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœæ‚¨åœ¨è¡¨æ ¼ä¸­å¡«å†™äº†ç›¸å…³çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ‰“å°å‡º`content`å°†ä¼šå¾—åˆ°ä»¥ä¸‹ç»“æœ:

```
fname=John&age=30&photo=file.jpg 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶è€Œï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦ä»æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­æå–ä¿¡æ¯çš„é”®/å€¼å¯¹ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨æ ¸å¿ƒ Dart SDK ä¸­æœ‰ä¸€ä¸ª`Uri`ç±»:

```
var content = await req.transform(Utf8Decoder()).join();
var queryParams = Uri(query: content).queryParameters; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#3-respond-to-the-post)3ã€‚å›å¤å¸–å­

ç°åœ¨è®©æˆ‘ä»¬å‘å›ä¸€ä¸ªå“åº”:

```
var content = await req.transform(Utf8Decoder()).join();
var queryParams = Uri(query: content).queryParameters;

req.response
  ..write('Parsed data belonging to ${queryParams['fname']}')
  ..close(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**æ›´æ–° 20/10/2018**:Tobe osak we([å¤©ä½¿](https://github.com/angel-dart/angel) çš„*åˆ›é€ è€…)å¾ˆæœ‰å¸®åŠ©çš„æŒ‡å‡ºäº†ä½¿ç”¨`splitQueryString`é™æ€æ–¹æ³•æå–æŸ¥è¯¢å‚æ•°:* 

```
// var queryParams = Uri(query: content).queryParameters;
var queryParams = Uri.splitQueryString(content); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬çš„æŸ¥è¯¢å‚æ•°ä½œä¸ºä¸€ä¸ª`Map`å¯¹è±¡è¿”å›ï¼Œå…è®¸æˆ‘ä»¬åƒè¿™æ ·æå–æˆ‘ä»¬çš„å€¼:

```
queryParams['fname'];
queryParams['age'];
queryParams['photo']; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

[![Solution](../Images/df5d994e65212b42e3c72ef81b60d9b3.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--eTrtsRzz--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/bml5w6pdx1oj7tuyp2p7.png)

ä¸‹é¢æ˜¯å®Œæ•´çš„è§£å†³æ–¹æ¡ˆ:

```
import 'dart:io';
import 'dart:convert';

void main() async {
  var server = await HttpServer.bind('127.0.0.1', 9000);

  await for (HttpRequest req in server) {
    if (req.method == 'POST' && req.headers.contentType.toString() == 'application/x-www-form-urlencoded') {
      var content = await req.transform(Utf8Decoder()).join();
      var queryParams = Uri(query: content).queryParameters;
      req.response
        ..write('Parsed data belonging to ${queryParams['fname']}')
        ..close();
    } else {
      req.response
        ..headers.set('Content-Type', 'text/html')
        ..write('''
          <!doctype html>
          <html>
          <body>
            <form action="/" method="post">
              <input type="text" name="fname" /><br />
              <input type="number" name="age" /><br />
              <input type="file" name="photo" /><br />
              <button>Save</button>
            </form>
          </body>
          </html>
        ''')
        ..close();
    }
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#in-closing)åœ¨å…³é—­...

ä¸ç›¸å…³æ–‡ç« ä¸€æ ·ï¼Œè¿™é€‚ç”¨äº`application/x-www-form-urlencoded`å†…å®¹ç±»å‹ï¼Œå¦‚æœè§£æå…¶ä»–å†…å®¹ç±»å‹ï¼Œåˆ™éœ€è¦ä¸åŒçš„æ–¹æ³•ã€‚æˆ‘ä»¬å°†åœ¨ä»¥åçš„æ–‡ç« ä¸­è®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚

**å–œæ¬¢ï¼Œåˆ†äº«ï¼Œå…³æ³¨æˆ‘**ğŸ˜æœ‰å…³ Dart çš„æ›´å¤šå†…å®¹ã€‚

* * *

## [](#further-reading)è¿›ä¸€æ­¥é˜…è¯»

1.  [Dart ä¸­çš„ Hello world æœåŠ¡å™¨](https://www.dartlang.org/tutorials/dart-vm/httpserver#run-the-hello-world-server)
2.  [åœ¨ Dart ä¸­åˆ›å»ºæµ](https://www.dartlang.org/articles/libraries/creating-streams)
3.  [**å…è´¹é£é•–æˆªå±åœ¨ Egghead.io**](https://egghead.io/instructors/jermaine-oppong)