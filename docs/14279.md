# ä½¿ç”¨ React å’Œ React è·¯ç”±å™¨ V4 çš„æœåŠ¡å™¨æ¸²æŸ“

> åŸæ–‡:[https://dev . to/tylermcginnis/server-rendering-with-react-and-react-router-48i 2](https://dev.to/tylermcginnis/server-rendering-with-react-and-react-router--48i2)

æœåŠ¡å™¨ç«¯æ¸²æŸ“ React åº”ç”¨ç¨‹åºå¯ä»¥æä¾›ä¸€äº›ä¸åŒçš„å¥½å¤„ï¼ŒåŒ…æ‹¬æ€§èƒ½å’Œ SEOã€‚é—®é¢˜æ˜¯ï¼Œåœ¨è·å¾—è¿™äº›å¥½å¤„çš„åŒæ—¶ï¼Œæ‚¨çš„åº”ç”¨ç¨‹åºä¹Ÿä¼šå˜å¾—æ›´åŠ å¤æ‚ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»å¤´å¼€å§‹ï¼Œæ…¢æ…¢åœ°æ„å»ºä¸€ä¸ªæœåŠ¡å™¨ç«¯æ¸²æŸ“ React(ç”¨ React è·¯ç”±å™¨),åŒæ—¶åˆ†è§£ä¸€äº›å¤æ‚æ€§ã€‚

### [](#video)è§†é¢‘

[https://www.youtube.com/embed/mZEv4mHsU5E](https://www.youtube.com/embed/mZEv4mHsU5E)

### [](#post)å²—ä½

æœåŠ¡å™¨ç«¯æ¸²æŸ“åˆååŒæ„ JavaScript åˆåé€šç”¨ JavaScript æ˜¯åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·æœºä¸Šè¿è¡Œç›¸åŒ JavaScript ä»£ç çš„~~ç™½æ—¥æ¢¦~~æƒ³æ³•ã€‚ä¸ºä»€ä¹ˆè¿™æ˜¯æœ‰ç›Šçš„ï¼Ÿå—¯ï¼Œæ‚¨é€šå¸¸ä¼šä»ä»£ç é‡ç”¨ã€æ€§èƒ½æé«˜å’Œ SEO æ”¶ç›Šä¸­å—ç›Šã€‚æ›´æ°å½“çš„é—®é¢˜æ˜¯ï¼Œä½ è·å¾—çš„å¥½å¤„å€¼å¾—ä½ å¢åŠ çš„å¤æ‚æ€§å—ï¼Ÿå½“æ„å»ºæœåŠ¡å™¨æ¸²æŸ“çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œæ‚¨éœ€è¦è€ƒè™‘æ›´å¤šçš„æƒ…å†µã€‚**å“ªä¸ªä»£ç ä¼šè¢«å…±äº«ï¼Ÿ** **æœ‰æ²¡æœ‰éœ€è¦å…±äº«çš„åˆå§‹çŠ¶æ€ï¼Ÿ** **å¦‚ä½•åœ¨æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯éƒ½å¤„ç†è·¯ç”±ï¼Ÿå› ä¸ºæ‰€æœ‰è¿™äº›é—®é¢˜éƒ½å¯ä»¥çº¿æ€§åœ°å›ç­”ï¼Œæˆ‘ä»¬å°†åœ¨è¿™ç¯‡æ–‡ç« ä¸­é‡‡ç”¨åŒæ ·çš„æ–¹æ³•ã€‚æˆ‘ä»¬å°†ä»æœ€åŸºæœ¬çš„å¼€å§‹ï¼Œè§£å†³å®ƒï¼Œç„¶åå¢åŠ æ›´å¤šçš„å¤æ‚æ€§ã€‚æœ€åï¼Œæ‚¨å°†èƒ½å¤Ÿå†³å®šæœåŠ¡å™¨æ¸²æŸ“çš„å¤æ‚æ€§æƒè¡¡å¯¹äºæ‚¨çš„ç‰¹å®šåº”ç”¨ç¨‹åºæ˜¯å¦å€¼å¾—ã€‚**

å¦‚æœå¯¹ä½ æ¥è¯´è¿™æ˜¯ä¸€ä¸ªæ–°æ¦‚å¿µï¼Œé‚£ä¹ˆåœ¨æ·±å…¥ç»†èŠ‚ä¹‹å‰ï¼ŒæŠ“ä½æ‰€æœ‰éƒ¨åˆ†å¦‚ä½•ç»„åˆåœ¨ä¸€èµ·çš„å¤§å±€æ˜¯å¾ˆé‡è¦çš„ã€‚

è¿™æ˜¯(åˆå§‹)è¿‡ç¨‹

1)ç”¨æˆ·åœ¨ä»–ä»¬çš„ web æµè§ˆå™¨ä¸­é”®å…¥æ‚¨çš„ URLï¼Œç„¶åç‚¹å‡» enterã€‚

2)æ‚¨çš„æœåŠ¡å™¨å‘ç°å­˜åœ¨å¯¹è·¯å¾„â€œ/â€çš„ GET è¯·æ±‚ã€‚

3)å®ƒå‘ˆç°åº”ç”¨ç¨‹åºçš„ä¸»è¦ç»„ä»¶ï¼Œå¹¶å°†å…¶åŒ…è£…åœ¨æ ‡å‡†çš„ html æ–‡æ¡£(DOCTYPEã€HTMLã€headã€body ç­‰)ä¸­ï¼Œç„¶åå°†æ•´ä¸ªå†…å®¹ä½œä¸ºå“åº”å‘é€å›æ¥ã€‚

[![SSR response](../Images/d7fa9380a71d0869f9a0f1c7375dd457.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--LPFVOgBg--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://tylermcginnis.com/static/891375429d05b32d5742de8078102a0d-77d4f.png)

4)æµè§ˆå™¨çœ‹åˆ°å®ƒä»æœåŠ¡å™¨è·å¾—äº†ä¸€ä¸ª HTML æ–‡æ¡£ï¼Œå¹¶ä¸”å®ƒçš„[æ¸²æŸ“å¼•æ“å¼€å§‹å·¥ä½œ](https://www.html5rocks.com/en/tutorials/internals/howbrowserswork/)ã€‚å®ƒå¾ˆå¿«å°±å®Œæˆäº†é¡µé¢çš„å‘ˆç°ã€‚

5)æ­¤æ—¶ï¼Œ**é¡µé¢å¯è§**ï¼Œæµè§ˆå™¨å¼€å§‹ä¸‹è½½ä»»ä½•è„šæœ¬ã€‚

[![Download waterfall](../Images/c0025993ea7cd8960a641cfeca3d8df7.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--fW9qeV1U--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://tylermcginnis.com/static/90cd5d58ebc514b289ec0db73f6a4fa4-fed13.png)

6)ä¸€æ—¦è„šæœ¬è¢«ä¸‹è½½ï¼ŒReact æ¥ç®¡å¹¶ä¸”é¡µé¢æ˜¯äº¤äº’å¼çš„ã€‚

è¯·æ³¨æ„ï¼Œä½¿ç”¨æœåŠ¡å™¨å‘ˆç°ï¼Œæµè§ˆå™¨ä»æœåŠ¡å™¨è·å¾—çš„å“åº”æ˜¯å‡†å¤‡å¥½å‘ˆç°çš„é¡µé¢çš„ HTMLã€‚è¿™ä¸å®¢æˆ·ç«¯æ¸²æŸ“æœ‰å¾ˆå¤§çš„ä¸åŒï¼Œå®¢æˆ·ç«¯æ¸²æŸ“åªæ˜¯è¿”å›ä¸€ä¸ªå¸¦æœ‰å·¨å¤§ JS åŒ…çš„ç©ºç™½ HTML æ–‡æ¡£ã€‚

é€šè¿‡å‘é€å›ä¸€ä¸ªå®Œæˆçš„ HTML æ–‡æ¡£ï¼Œæµè§ˆå™¨èƒ½å¤Ÿå‘ç”¨æˆ·æ˜¾ç¤ºä¸€äº› UIï¼Œè€Œä¸å¿…ç­‰å¾… JavaScript å®Œæˆä¸‹è½½ã€‚

* * *

ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†å¤§è‡´çš„äº†è§£ï¼Œè®©æˆ‘ä»¬å¼€å§‹ä¸ºæœåŠ¡å™¨æ¸²æŸ“çš„ React è·¯ç”±å™¨åº”ç”¨ç¨‹åºåˆ›å»ºåŸºç¡€ã€‚

åˆ†è§£æˆ‘ä»¬çš„åˆ—è¡¨ï¼Œæˆ‘ä»¬çŸ¥é“æœ‰ä¸‰æ ·ä¸œè¥¿æˆ‘ä»¬éœ€è¦é¢„å…ˆå‡†å¤‡å¥½ã€‚

1)ä¸€ä¸ª React ç»„ä»¶â€”â€”ç›®å‰ç”šè‡³åªæ˜¯ä¸€ä¸ªå‘ˆç°â€œHello Worldâ€çš„åŸºæœ¬ç»„ä»¶ã€‚2)ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå®ƒå°†æˆ‘ä»¬çš„åŸºæœ¬ React ç»„ä»¶å°è£…åœ¨æŸç§ HTML ç»“æ„ä¸­ï¼Œç„¶åè¿”å›ç»™æˆ‘ä»¬ã€‚3)ä¸€ä¸ª React åº”ç”¨ç¨‹åºï¼Œå®ƒå°†ä»æœåŠ¡å™¨å‘ˆç° HTML çš„åœ°æ–¹å¼€å§‹ï¼Œå¹¶åœ¨éœ€è¦çš„åœ°æ–¹å‘ç°æœ‰æ ‡è®°æ·»åŠ ä»»ä½•äº‹ä»¶ä¾¦å¬å™¨ã€‚

> è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‡ºäº React çš„è€ƒè™‘ï¼Œæ‚¨åœ¨æœåŠ¡å™¨ä¸Šå‘ˆç°çš„å†…å®¹(ä¸Šé¢çš„#2)éœ€è¦ä¸åœ¨å®¢æˆ·æœºä¸Šå‘ˆç°çš„å†…å®¹(ä¸Šé¢çš„#3)ç›¸åŒã€‚å¦‚æœæ²¡æœ‰ï¼ŒReact å°†æŠ›å‡ºä¸€ä¸ªè­¦å‘Šã€‚

å’Œå¾€å¸¸ä¸€æ ·ï¼Œåœ¨å¤„ç† React æ—¶ï¼Œæˆ‘ä»¬å°†éœ€è¦åœ¨æŸä¸ªæ—¶å€™è®¨è®º webpackã€‚æˆ‘ä»¬ä¸ä¼šä½¿ç”¨ Create React åº”ç”¨ç¨‹åºï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»æ¨å‡ºè‡ªå·±çš„é…ç½®ã€‚ä¸ºäº†ä½¿æœ¬æ•™ç¨‹å°½å¯èƒ½é›†ä¸­ï¼Œæˆ‘å°†ç²˜è´´ webpack.config.js æ–‡ä»¶å’Œä¸‹é¢çš„ package.jsonï¼Œç„¶åçªå‡ºæ˜¾ç¤ºé‡è¦çš„éƒ¨åˆ†ã€‚

```
// webpack.config.js

var path = require('path')
var webpack = require('webpack')
var nodeExternals = require('webpack-node-externals')

var browserConfig = {
  entry: './src/browser/index.js',
  output: {
    path: path.resolve(__dirname, 'public'),
    filename: 'bundle.js',
    publicPath: '/'
  },
  module: {
    rules: [
      { test: /\.(js)$/, use: 'babel-loader' },
    ]
  },
  plugins: [
    new webpack.DefinePlugin({
      __isBrowser__: "true"
    })
  ]
}

var serverConfig = {
  entry: './src/server/index.js',
  target: 'node',
  externals: [nodeExternals()],
  output: {
    path: __dirname,
    filename: 'server.js',
    publicPath: '/'
  },
  module: {
    rules: [
      { test: /\.(js)$/, use: 'babel-loader' }
    ]
  },
  plugins: [
    new webpack.DefinePlugin({
      __isBrowser__: "false"
    })
  ]
}

module.exports = [browserConfig, serverConfig] 
```

æ³¨æ„æˆ‘ä»¬æœ‰ä¸¤ä¸ªä¸åŒçš„é…ç½®:ä¸€ä¸ªç”¨äºæµè§ˆå™¨ï¼Œä¸€ä¸ªç”¨äºæœåŠ¡å™¨ã€‚

**æµè§ˆå™¨é…ç½®**å°†è·å–ä½äº`/src/browser/index.js`çš„ä»£ç ï¼Œé€šè¿‡`babel-loader`è¿è¡Œå®ƒ(å®ƒå°†é€šè¿‡`env`å’Œ`react`é¢„ç½®è¿è¡Œå®ƒ)ï¼Œç„¶ååœ¨`/public/bundle.js`æŠ›å‡ºä¿®æ”¹åçš„æ†ç»‘ä»£ç ã€‚`__isBrowser__`è¡Œå°†å‘å…¨å±€åç§°ç©ºé—´æ·»åŠ ä¸€ä¸ªå±æ€§(`__isBrowser__`)ï¼Œè¿™æ ·æˆ‘ä»¬å°±çŸ¥é“æˆ‘ä»¬æ­£åœ¨æµè§ˆå™¨ä¸Šè¿›è¡Œæ¸²æŸ“ã€‚

**æœåŠ¡å™¨é…ç½®**ç±»ä¼¼ã€‚å®ƒå°†è·å–ä½äº`/src/server/index.js`çš„ä»£ç ï¼Œé€šè¿‡åŒä¸€ä¸ª`babel-loader`è¿è¡Œå®ƒï¼Œç„¶åå®ƒå°†åœ¨`./server.js`å°†å…¶æ‹†åˆ†ã€‚`externals`çº¿ä½¿å®ƒä¸ä¸æœåŠ¡å™¨`node_modules`æ†ç»‘åœ¨ä¸€èµ·ã€‚`target`å‘Šè¯‰ webpack åœ¨â€œç±»ä¼¼ Node.js çš„ç¯å¢ƒâ€ä¸­è¿›è¡Œç¼–è¯‘ï¼Œå¹¶å¸®åŠ©`externals`çŸ¥é“å¿½ç•¥ä»€ä¹ˆ(å†…ç½®åœ¨ pathã€fs ç­‰èŠ‚ç‚¹æ¨¡å—ä¸­)ã€‚

TLï¼›æœ€ç»ˆçš„å®¢æˆ·ç«¯ä»£ç å°†æ”¾åœ¨`public/bundle.js`å¤„ï¼Œè€Œæœ€ç»ˆçš„æœåŠ¡å™¨ä»£ç å°†æ”¾åœ¨æ ¹ä½ç½®`server.js`å¤„ã€‚

```
// package.json

{
  "name": "rrssr",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "start": "webpack -w & nodemon server.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "MIT",
  "description": "",
  "babel": {
    "presets": [
      "env",
      "react"
    ],
    "plugins": [
      "transform-object-rest-spread"
    ]
  },
  "devDependencies": {
    "babel-core": "^6.26.0",
    "babel-loader": "^7.1.2",
    "babel-plugin-transform-object-rest-spread": "^6.26.0",
    "babel-preset-env": "^1.6.1",
    "babel-preset-react": "^6.24.1",
    "nodemon": "^1.12.5",
    "webpack": "^3.10.0",
    "webpack-node-externals": "^1.6.0"
  },
  "dependencies": {
    "cors": "^2.8.4",
    "express": "^4.16.2",
    "isomorphic-fetch": "^2.2.1",
    "react": "^16.2.0",
    "react-dom": "^16.2.0",
    "react-router-dom": "^4.2.2",
    "serialize-javascript": "^1.4.0"
  }
} 
```

å½“æˆ‘ä»¬åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œ`npm run start`æ—¶ï¼Œå°†ä¼šè¿è¡Œ`webpack -w`å’Œ`nodemon server.js`ã€‚`webpack -w`å°†è§‚å¯Ÿæˆ‘ä»¬çš„ä»£ç ï¼Œå¹¶åœ¨ä»£ç å‘ç”Ÿå˜åŒ–æ—¶é‡æ–°ç¼–è¯‘ï¼Œè€Œ`nodemon server.js`å°†åœ¨æˆ‘ä»¬çš„æœåŠ¡å™¨ä»£ç å‘ç”Ÿå˜åŒ–æ—¶é‡æ–°å¯åŠ¨æˆ‘ä»¬çš„æœåŠ¡å™¨ã€‚

* * *

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹å·¥ä½œã€‚æ ¹æ®æˆ‘ä»¬çš„`webpack.config.js`æ–‡ä»¶ï¼Œåœ¨æˆ‘ä»¬çš„`src`æ–‡ä»¶å¤¹ä¸­ï¼Œæˆ‘ä»¬å°†æœ‰ä¸€ä¸ª`server`å’Œä¸€ä¸ª`browser`æ–‡ä»¶å¤¹ã€‚è®©æˆ‘ä»¬ä¹Ÿä¸ºä¸¤è€…å…±äº«çš„æ‰€æœ‰åŠŸèƒ½æ·»åŠ ä¸€ä¸ª`shared`æ–‡ä»¶å¤¹ã€‚

```
webpack.config.js
package.json
/src
  /browser
  /server
  /shared 
```

å¦‚æœä½ è¿˜è®°å¾—ï¼Œå½“æˆ‘ä»¬åˆ†è§£æœ€åˆçš„ SSR æµç¨‹æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ä¸‰ä¸ªé¡¹ç›®ã€‚

1)ä¸€ä¸ª React ç»„ä»¶â€”â€”ç›®å‰ç”šè‡³åªæ˜¯ä¸€ä¸ªå‘ˆç°â€œHello Worldâ€çš„åŸºæœ¬ç»„ä»¶ã€‚2)ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå®ƒå°†æˆ‘ä»¬çš„åŸºæœ¬ React ç»„ä»¶å°è£…åœ¨æŸç§ HTML ç»“æ„ä¸­ï¼Œç„¶åè¿”å›ç»™æˆ‘ä»¬ã€‚3)ä¸€ä¸ª React åº”ç”¨ç¨‹åºï¼Œå®ƒå°†ä»æœåŠ¡å™¨å‘ˆç° HTML çš„åœ°æ–¹å¼€å§‹ï¼Œå¹¶åœ¨éœ€è¦çš„åœ°æ–¹å‘ç°æœ‰æ ‡è®°æ·»åŠ ä»»ä½•äº‹ä»¶ä¾¦å¬å™¨ã€‚

æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°å¤„ç†#1ã€‚è®©æˆ‘ä»¬åœ¨`shared`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª App.js ç»„ä»¶ï¼Œå¹¶è®©å®ƒå‘ˆç°â€œHello Worldâ€ã€‚

```
// src/shared/App.js

import React, { Component } from 'react'

class App extends Component {
  render() {
    return (
      <div>
        Hello World
      </div>
    )
  }
}

export default App 
```

å®Œäº†ï¼Œå®Œäº†ã€‚ç°åœ¨ï¼Œæ¥çœ‹ç¬¬äºŒä¸ªé—®é¢˜ã€‚

> # 2â€”â€”ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå®ƒå°†æˆ‘ä»¬çš„åŸºæœ¬ React ç»„ä»¶å°è£…åœ¨æŸä¸ª HTML ç»“æ„ä¸­åè¿”å›ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬åœ¨`src/server`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª`index.js`æ–‡ä»¶ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ expressï¼Œå› æ­¤è®©æˆ‘ä»¬å…ˆè¿›è¡ŒåŸºæœ¬è®¾ç½®ã€‚

```
import express from "express"
import cors from "cors"

const app = express()

app.use(cors())

// We're going to serve up the public
// folder since that's where our
// client bundle.js file will end up.
app.use(express.static("public"))

app.listen(3000, () => {
  console.log(`Server is listening on port: 3000`)
}) 
```

ç°åœ¨ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™æ ·åšï¼Œæ¯å½“æˆ‘ä»¬çš„æœåŠ¡å™¨æ¥æ”¶åˆ°ä¸€ä¸ª`GET`è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬å°±æŠŠ HTML æ¡†æ¶è¿åŒå®ƒé‡Œé¢çš„`App`ç»„ä»¶çš„æ ‡è®°ä¸€èµ·å‘é€å›å»ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ React çš„`renderToString`æ–¹æ³•ã€‚å®ƒæ¥å—ä¸€ä¸ª React å…ƒç´ å¹¶è¿”å›ä¸€ä¸ª HTML å­—ç¬¦ä¸²ã€‚

```
import express from "express"
import cors from "cors"
import { renderToString } from "react-dom/server"
import App from '../shared/App'
import React from 'react'

const app = express()

app.use(cors())

// We're going to serve up the public
// folder since that's where our
// client bundle.js file will end up.
app.use(express.static("public"))

app.get("*", (req, res, next) => {
  const markup = renderToString(
    <App />
  )

  res.send(`
    <!DOCTYPE html>
    <html>
      <head>
        <title>SSR with RR</title>
      </head>

      <body>
        <div id="app">${markup}</div>
      </body>
    </html>
  `)
})

app.listen(3000, () => {
  console.log(`Server is listening on port: 3000`)
}) 
```

æœ€åï¼Œæˆ‘ä»¬è¿˜å¸Œæœ›åŒ…å«ä¸€ä¸ª`<script src='/bundle.js'></script>`æ ‡ç­¾ï¼Œå› ä¸ºå½“æµè§ˆå™¨è§£æè¿™ä¸ª HTML æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒè·å–åŒ…å«æ‰€æœ‰å®¢æˆ·ç«¯ä»£ç çš„`bundle.js`æ–‡ä»¶ã€‚

```
<head>
  <title>SSR with RR</title>
  <script src="/bundle.js" defer></script>
</head> 
```

ç°åœ¨ï¼Œæ— è®ºä½•æ—¶å‘æˆ‘ä»¬çš„æœåŠ¡å™¨å‘å‡º GET è¯·æ±‚ï¼Œæˆ‘ä»¬éƒ½ä¼šå¾—åˆ°ä¸€äº› HTMLï¼Œå…¶ä¸­åŒ…æ‹¬æˆ‘ä»¬çš„`<App />`ç»„ä»¶å’Œä¸€ä¸ªåˆ°æˆ‘ä»¬çš„`bundle.js`æ–‡ä»¶çš„é“¾æ¥ã€‚

> #3.React åº”ç”¨ç¨‹åºå°†ä»æœåŠ¡å™¨å‘ˆç° HTML çš„åœ°æ–¹ç»§ç»­å‰è¿›ï¼Œå¹¶åœ¨éœ€è¦çš„åœ°æ–¹å‘ç°æœ‰æ ‡è®°æ·»åŠ ä»»ä½•äº‹ä»¶ä¾¦å¬å™¨ã€‚

è¿™ä¸ªå¬èµ·æ¥æ¯”å®é™…æ›´éš¾ã€‚é€šå¸¸ï¼Œå½“æ‚¨æƒ³è¦å‘Šè¯‰æµè§ˆå™¨æ‚¨çš„ React åº”ç”¨ç¨‹åºæ—¶ï¼Œæ‚¨è°ƒç”¨`ReactDOM.render`å¹¶å‘å…¶ä¼ é€’æ‚¨æƒ³è¦æŒ‚è½½çš„å…ƒç´ å’Œ DOM èŠ‚ç‚¹ã€‚æˆ‘ä»¬éœ€è¦åšçš„æœåŠ¡å™¨æ¸²æŸ“æ˜¯ç±»ä¼¼çš„ï¼Œä½†ä¸æ˜¯è°ƒç”¨`ReactDOM.render`ï¼Œæˆ‘ä»¬æƒ³è°ƒç”¨`ReactDOM.hydrate`ã€‚`.hydrate`è¦åšçš„æ˜¯å‘Šè¯‰ React æ‚¨å·²ç»åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºäº†æ ‡è®°ï¼Œè€Œä¸æ˜¯åœ¨å®¢æˆ·æœºä¸Šé‡æ–°åˆ›å»ºå®ƒï¼Œå®ƒåº”è¯¥ä¿å­˜å®ƒå¹¶åªå°†ä»»ä½•éœ€è¦çš„äº‹ä»¶å¤„ç†ç¨‹åºé™„åŠ åˆ°ç°æœ‰çš„æœåŠ¡å™¨å‘ˆç°çš„æ ‡è®°ä¸Šã€‚

è®©æˆ‘ä»¬åœ¨`src/browser`ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„`index.js`æ–‡ä»¶ï¼Œå¹¶åœ¨é‚£é‡Œè°ƒç”¨`hydrate`ã€‚

```
// src/browser/index.js

import React from 'react'
import { hydrate } from 'react-dom'
import App from '../shared/App'

hydrate(
  <App />,
  document.getElementById('app')
); 
```

æ­¤æ—¶ï¼Œå‡è®¾æ‚¨å·²ç»åœ¨ç»ˆç«¯ä¸­è¿è¡Œäº†`npm run start`ï¼Œå½“æ‚¨è®¿é—®`localhost:3000`æ—¶ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°â€œHello Worldâ€ã€‚â€œHello Worldâ€æœ€åˆåœ¨æœåŠ¡å™¨ä¸Šå‘ˆç°ï¼Œç„¶åå½“å®ƒåˆ°è¾¾å®¢æˆ·ç«¯å¹¶åŠ è½½äº†`bundle.js`æ–‡ä»¶æ—¶ï¼ŒReact æ¥ç®¡äº†å®ƒã€‚

é…·æ¯™äº†ã€‚è¿˜æœ‰ï¼Œè™å¤´è›‡å°¾ã€‚

è®©æˆ‘ä»¬æŠŠäº‹æƒ…æ··åˆèµ·æ¥ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½çœŸæ­£çœ‹åˆ°è¿™æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚å¦‚æœæˆ‘ä»¬æƒ³è®©`App`æ¸²æŸ“`Hello {this.props.data}`è€Œä¸æ˜¯æ¸²æŸ“â€œHello Worldâ€å‘¢ï¼Ÿé‚£æ˜¯ä¸€ä¸ªè¶³å¤Ÿç®€å•çš„`App.js`å†…éƒ¨çš„å˜åŒ–

```
class App extends Component {
  render() {
    return (
      <div>
        Hello {this.props.data}
      </div>
    )
  }
} 
```

ç°åœ¨ï¼Œæ¯å½“æˆ‘ä»¬åˆ›å»ºæˆ‘ä»¬çš„`App`å…ƒç´ æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å‘å®ƒä¼ é€’ä¸€ä¸ª`data` prop - React 101ã€‚

æˆ‘ä»¬åœ¨å“ªé‡Œåˆ›å»º`App`å…ƒç´ ï¼Ÿæœ‰ä¸¤ä¸ªåœ°æ–¹ã€‚ç¬¬ä¸€ä¸ªä½ç½®åœ¨`server/index.js`å†…éƒ¨ï¼Œç”¨äºæˆ‘ä»¬æœåŠ¡å™¨æ¸²æŸ“çš„æ—¶å€™ï¼Œç¬¬äºŒä¸ªä½ç½®åœ¨`browser/index.js`å†…éƒ¨ï¼Œç”¨äºæµè§ˆå™¨è·å–å®ƒçš„æ—¶å€™ã€‚è®©æˆ‘ä»¬ä¿®æ”¹è¿™ä¸¤ä¸ªå¹¶æ·»åŠ ä¸€ä¸ª`Tyler`çš„`data`é“å…·ã€‚

```
// browser/index.js

hydrate(
  <App data='Tyler' />,
  document.getElementById('app')
); 
```

```
// server/index.js

const markup = renderToString(
  <App data='Tyler' />
) 
```

å¤ªå¥½äº†ã€‚ç°åœ¨æˆ‘ä»¬åœ¨ç”¨æˆ·ç•Œé¢ä¸Šçœ‹åˆ°äº†â€œä½ å¥½ï¼Œæ³°å‹’â€ã€‚è¿˜è®°å¾—æˆ‘å‰é¢æåˆ°çš„ï¼Œä½ åœ¨æœåŠ¡å™¨ä¸Šæ¸²æŸ“çš„å†…å®¹éœ€è¦å’Œåœ¨å®¢æˆ·ç«¯æ¸²æŸ“çš„å†…å®¹ä¸€è‡´å—ï¼Ÿå¦‚æœæˆ‘ä»¬æ”¹å˜å…¶ä¸­ä¸€ä¸ªæ•°æ®å±æ€§ï¼Œå°±å¯ä»¥çœ‹åˆ°è¿™ä¸€ç‚¹ã€‚

```
hydrate(
  <App data='Mikenzi' />,
  document.getElementById('app')
); 
```

ç°åœ¨ï¼Œå½“ä½ åˆ·æ–°åº”ç”¨ç¨‹åºæ—¶ï¼Œä½ æœ€åˆä¼šçœ‹åˆ°â€œHello Tylerâ€(è¿™æ˜¯æœåŠ¡å™¨ä¸Šå‘ˆç°çš„å†…å®¹)ï¼Œç„¶åå½“ React æ¥ç®¡æ—¶ï¼Œä½ ä¼šçœ‹åˆ°â€œHello Mikenziâ€ã€‚åœ¨æ§åˆ¶å°ä¸­ï¼Œæ‚¨ä¼šçœ‹åˆ°ä¸€ä¸ªè­¦å‘Š`Text content did not match. Server: "Tyler" Client: "Mikenzi"`ã€‚

ä»¥ä¸‹æ˜¯ React åŒ»ç”Ÿå¯¹æ­¤çš„çœ‹æ³•

> React æœŸæœ›å‘ˆç°çš„å†…å®¹åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·æœºä¹‹é—´æ˜¯ç›¸åŒçš„ã€‚å®ƒå¯ä»¥ä¿®è¡¥æ–‡æœ¬å†…å®¹ä¸­çš„å·®å¼‚ï¼Œä½†æ˜¯æ‚¨åº”è¯¥å°†ä¸åŒ¹é…è§†ä¸ºé”™è¯¯å¹¶ä¿®å¤å®ƒä»¬ã€‚åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼ŒReact ä¼šåœ¨æ°´åˆè¿‡ç¨‹ä¸­å‘å‡ºä¸åŒ¹é…è­¦å‘Šã€‚ä¸ä¿è¯åœ¨ä¸åŒ¹é…çš„æƒ…å†µä¸‹ä¼šä¿®è¡¥å±æ€§å·®å¼‚ã€‚å‡ºäºæ€§èƒ½åŸå› ï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºåœ¨å¤§å¤šæ•°åº”ç”¨ç¨‹åºä¸­ï¼Œä¸åŒ¹é…çš„æƒ…å†µå¾ˆå°‘å‘ç”Ÿï¼Œå› æ­¤éªŒè¯æ‰€æœ‰æ ‡è®°ä¼šéå¸¸æ˜‚è´µã€‚

å½“æ‚¨åªæ˜¯å‘ˆç°ä¸€ä¸ªæ²¡æœ‰æ•°æ®çš„ç»„ä»¶æ—¶ï¼Œè®©æœåŠ¡å™¨å‘ˆç°çš„å†…å®¹å’Œå®¢æˆ·ç«¯å‘ˆç°çš„å†…å®¹å®Œå…¨ç›¸åŒå¹¶ä¸å›°éš¾â€”â€”å°±åƒæˆ‘ä»¬åˆšåˆšå‘ˆç°`<App />`æ—¶çœ‹åˆ°çš„é‚£æ ·ã€‚å½“ä½ æ·»åŠ æ•°æ®æ—¶ï¼Œäº‹æƒ…å˜å¾—æœ‰ç‚¹å¤æ‚ã€‚æ‚¨éœ€è¦ç¡®ä¿åœ¨å®¢æˆ·æœºå’ŒæœåŠ¡å™¨ä¸Šç”¨ç›¸åŒçš„æ•°æ®(æˆ–é“å…·)å‘ˆç°ç»„ä»¶ã€‚è®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬æ˜¯å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹çš„(ä¸åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·æœºä¸Šç¡¬ç¼–ç `data` prop)ã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œç”±äºåº”ç”¨ç¨‹åºå°†é¦–å…ˆåœ¨æœåŠ¡å™¨ä¸Šå‘ˆç°ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéœ€è¦çš„ä»»ä½•åˆå§‹æ•°æ®éƒ½å¿…é¡»æ¥è‡ªæœåŠ¡å™¨ã€‚è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œä¸ºäº†ç¡®ä¿æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æ˜¯ç›¸åŒçš„ï¼Œæˆ‘ä»¬éœ€è¦å¼„æ¸…æ¥šå¦‚ä½•å°†æ¥è‡ªæœåŠ¡å™¨çš„ç›¸åŒæ•°æ®ä¼ é€åˆ°å®¢æˆ·ç«¯ã€‚å—¯ï¼Œæœ‰ä¸€ä¸ªéå¸¸â€œè€æ´¾â€çš„è§£å†³æ–¹æ¡ˆï¼Œéå¸¸æœ‰æ•ˆã€‚è®©æˆ‘ä»¬æŠŠå®ƒæ”¾åœ¨å…¨å±€åç§°ç©ºé—´ä¸Šï¼Œè¿™æ ·å®¢æˆ·æœºå°±å¯ä»¥å¼•ç”¨å®ƒã€‚

```
...

import serialize from "serialize-javascript"

app.get("*", (req, res, next) => {
  const name = 'Tyler'
  const markup = renderToString(
    <App data={name}/>
  )

  res.send(`
    <!DOCTYPE html>
    <html>
      <head>
        <title>SSR with RR</title>
        <script src="/bundle.js" defer></script>
        <script>window.__INITIAL_DATA__ = ${serialize(name)}</script>
      </head>

      <body>
        <div id="app">${markup}</div>
      </body>
    </html>
  `)
}) 
```

ç°åœ¨ï¼Œåœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å¯ä»¥ä»`window.__INITIAL_DATA__`è·å–åç§°ã€‚

```
hydrate(
  <App data={window.__INITIAL_DATA__} />,
  document.getElementById('app')
); 
```

ğŸ•º:æˆ‘ä»¬å·²ç»é€šè¿‡ä½¿ç”¨`window`å¯¹è±¡è§£å†³äº†ä»æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯å…±äº«åˆå§‹æ•°æ®çš„é—®é¢˜ã€‚

* * *

ç°åœ¨è®©æˆ‘ä»¬å®é™…ä¸Šå¼€å§‹å»ºç«‹ä¸€äº›å®è´¨æ€§çš„ä¸œè¥¿ã€‚å¾ˆå¯èƒ½ä½ æ°¸è¿œä¸ä¼šæœ‰é™æ€çš„åˆå§‹æ•°æ®ã€‚æ‚¨çš„æ•°æ®å¾ˆå¯èƒ½æ¥è‡ªæŸä¸ªåœ°æ–¹çš„ APIã€‚è®©æˆ‘ä»¬ä¿®æ”¹æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼Œä½¿å®ƒåœ¨è¿”å› HTML ä¹‹å‰è·å–ä¸€äº›æ•°æ®ã€‚æœ€ç»ˆç›®æ ‡æ˜¯å»ºé€ åƒè¿™æ ·çš„ä¸œè¥¿ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ Github API æ¥è·å–ç‰¹å®šè¯­è¨€çš„æµè¡Œåº“ã€‚æˆ‘ä»¬å°†åœ¨æ²¡æœ‰ä»»ä½•è·¯ç”±çš„æƒ…å†µä¸‹å¼€å§‹ï¼Œç„¶åæˆ‘ä»¬å°†çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ React è·¯ç”±å™¨å°†å…¶æ·»åŠ è¿›æ¥ã€‚

æˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ç§è¯­è¨€ï¼Œå¹¶ä½¿ç”¨ Github API è·å–è¯¥è¯­è¨€æœ€æµè¡Œçš„ reposã€‚å› ä¸ºæˆ‘ä»¬å°†åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·æœºä¸Šéƒ½ä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åœ¨`shared`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª`api.js`æ–‡ä»¶ï¼Œå¹¶è°ƒç”¨å‡½æ•°`fetchPopularRepos`ã€‚

```
// shared/api.js

import fetch from 'isomorphic-fetch'

export function fetchPopularRepos (language = 'all') {
  const encodedURI = encodeURI(`https://api.github.com/search/repositories?q=stars:>1+language:${language}&sort=stars&order=desc&type=Repositories`)

  return fetch(encodedURI)
    .then((data) => data.json())
    .then((repos) => repos.items)
    .catch((error) => {
      console.warn(error)
      return null
    });
} 
```

ç°åœ¨æˆ‘ä»¬éœ€è¦ç¡®å®šä½•æ—¶è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚è¿™ä¸ªæƒ³æ³•æ˜¯ï¼Œå½“å¯¹æˆ‘ä»¬çš„æœåŠ¡å™¨å‘å‡º GET è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬ä¸æ˜¯ç«‹å³è°ƒç”¨`renderToString`,è€Œæ˜¯é¦–å…ˆè·å–æµè¡Œçš„å­˜å‚¨åº“ï¼Œç„¶ååœ¨å‘ React åº”ç”¨ç¨‹åºæä¾›æ•°æ®åè°ƒç”¨å®ƒã€‚

```
// server/index.js

...

import { fetchPopularRepos } from '../shared/api'

app.get("*", (req, res, next) => {
  fetchPopularRepos()
    .then((data) => {
      const markup = renderToString(
        <App data={data} />
      )

      res.send(`
        <!DOCTYPE html>
        <html>
          <head>
            <title>SSR with RR</title>
            <script src="/bundle.js" defer></script>
            <script>window.__INITIAL_DATA__ = ${serialize(data)}</script>
          </head>

          <body>
            <div id="app">${markup}</div>
          </body>
        </html>
      `)
    })
}) 
```

ç°åœ¨ï¼Œå½“å‘å‡ºè¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬æ­£åœ¨è·å–æˆ‘ä»¬éœ€è¦çš„æ•°æ®ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¸Œæœ›ä¿®æ”¹`App`ç»„ä»¶ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ­£ç¡®åœ°å¤„ç†æ–°æ•°æ®ã€‚è®©æˆ‘ä»¬åˆ¶ä½œä¸€ä¸ªåä¸º`Grid`çš„æ–°ç»„ä»¶æ¥å¤„ç†æ‰€æœ‰å›è´­çš„æ˜ å°„ï¼Œè€Œä¸æ˜¯åœ¨`App`ä¸­å¤„ç†å®ƒã€‚

```
// shared/Grid.js
import React, { Component } from 'react'

class Grid extends Component {
  render() {
    const repos = this.props.data

    return (
      <ul style={{display: 'flex', flexWrap: 'wrap'}}>
        {repos.map(({ name, owner, stargazers_count, html_url }) => (
          <li key={name} style={{margin: 30}}>
            <ul>
              <li><a href={html_url}>{name}</a></li>
              <li>@{owner.login}</li>
              <li>{stargazers_count} stars</li>
            </ul>
          </li>
        ))}
      </ul>
    )
  }
}

export default Grid 
```

```
// shared/App.js
import React, { Component } from 'react'
import Grid from './Grid'

class App extends Component {
  render() {
    return (
      <div>
        <Grid data={this.props.data} />
      </div>
    )
  }
} 
```

åšå®ã€‚ç°åœ¨ï¼Œå½“æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè¢«è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨è·å–åº”ç”¨ç¨‹åºéœ€è¦çš„æ•°æ®ï¼Œæˆ‘ä»¬å¾—åˆ°çš„ HTML å“åº”åŒ…å«äº†åˆå§‹ UI æ‰€éœ€çš„æ‰€æœ‰å†…å®¹ã€‚

* * *

åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä»¬å·²ç»åšäº†å¾ˆå¤šï¼Œä½†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè¿˜æœ‰å¾ˆé•¿çš„è·¯è¦èµ°ï¼Œå°¤å…¶æ˜¯åœ¨è·¯ç”±æ–¹é¢ã€‚

React è·¯ç”±å™¨æ˜¯ä¸€ç§å£°æ˜å¼çš„ã€åŸºäºç»„ä»¶çš„è·¯ç”±æ–¹æ³•ã€‚ç„¶è€Œï¼Œå½“æˆ‘ä»¬ç”¨ React Router å¤„ç†æœåŠ¡å™¨ç«¯æ¸²æŸ“æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ”¾å¼ƒè¿™ç§èŒƒå¼ï¼Œå°†æ‰€æœ‰è·¯ç”±ç§»åŠ¨åˆ°ä¸€ä¸ª[ä¸­å¤®è·¯ç”±é…ç½®](https://tylermcginnis.com/react-router-route-config/)ã€‚è¿™æ ·åšçš„åŸå› æ˜¯å› ä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½éœ€è¦çŸ¥é“æˆ‘ä»¬çš„è·¯ç”±ã€‚å®¢æˆ·ç«¯ï¼Œå› ä¸ºå®ƒæ˜¾ç„¶éœ€è¦çŸ¥é“å½“ç”¨æˆ·åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­å¯¼èˆªæ—¶è¦å‘ˆç°å“ªäº›ç»„ä»¶ï¼›æœåŠ¡å™¨ï¼Œå› ä¸ºå®ƒéœ€è¦çŸ¥é“å½“ç”¨æˆ·è¯·æ±‚ç‰¹å®šè·¯å¾„æ—¶è¦è·å–å“ªäº›æ•°æ®ã€‚

ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºä¸­å¿ƒè·¯ç”±é…ç½®ã€‚åœ¨æˆ‘ä»¬çš„`shared`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`routes.js`çš„æ–°æ–‡ä»¶ã€‚æˆ‘ä»¬å°†ç”¨ä¸€ç»„å¯¹è±¡æ¥è¡¨ç¤ºæˆ‘ä»¬çš„è·¯çº¿ã€‚æ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€æ¡æ–°è·¯çº¿ã€‚æœ€åï¼Œæˆ‘ä»¬å°†æ˜ å°„æˆ‘ä»¬çš„ routes æ•°ç»„ï¼Œå¹¶ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºä¸€ä¸ª`<Route>`ã€‚åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å°†æœ‰ä¸¤æ¡è·¯çº¿- `/`å’Œ`/popular/:id`ã€‚`/`å°†å‘ˆç°(å³å°†åˆ›å»ºçš„)`Home`ç»„ä»¶ï¼Œè€Œ`/popular/:id`å°†å‘ˆç°æˆ‘ä»¬çš„`Grid`ç»„ä»¶ã€‚

```
// shared/routes.js
import Home from './Home'
import Grid from './Grid'

const routes =  [
  {
    path: '/',
    exact: true,
    component: Home,
  },
  {
    path: '/popular/:id',
    component: Grid,
  }
]

export default routes 
```

åœ¨æˆ‘ä»¬ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘ä»¬èµ¶ç´§åˆ›å»º`Home`ç»„ä»¶ã€‚

```
// shared/Home.js
import React from 'react'

export default function Home () {
  return (
    <div>
      Select a Language
    </div>
  )
} 
```

æˆ‘å‰é¢æåˆ°è¿‡ï¼ŒæœåŠ¡å™¨éœ€è¦è®¿é—®ä¸­å¤®è·¯ç”±é…ç½®çš„åŸå› æ˜¯â€œå®ƒéœ€è¦çŸ¥é“å½“ç”¨æˆ·è¯·æ±‚ç‰¹å®šè·¯å¾„æ—¶è¦è·å–å“ªäº›æ•°æ®â€ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å°†æŠŠç‰¹å®šè·¯ç”±éœ€è¦çš„ä»»ä½•æ•°æ®è¯·æ±‚æ”¾åœ¨è·¯ç”±å¯¹è±¡æœ¬èº«ä¸­ã€‚è¿™å°†å…è®¸æœåŠ¡å™¨è¯´â€œçœ‹èµ·æ¥ç”¨æˆ·æ­£åœ¨è¯·æ±‚`/popular/javascript`è·¯çº¿ã€‚åœ¨æˆ‘ä»¬å‘é€å›å“åº”ä¹‹å‰ï¼Œæœ‰æ²¡æœ‰éœ€è¦è·å–çš„æ•°æ®ï¼Ÿæœ‰å—ï¼Ÿå¥½çš„ï¼Œæ‹¿æ¥ã€‚â€ã€‚

```
// shared/routes.js
import Home from './Home'
import Grid from './Grid'
import { fetchPopularRepos } from './api'

const routes =  [
  {
    path: '/',
    exact: true,
    component: Home,
  },
  {
    path: '/popular/:id',
    component: Grid,
    fetchInitialData: (path = '') => fetchPopularRepos(
      path.split('/').pop()
    )
  }
]

export default routes 
```

åŒæ ·ï¼Œé€šè¿‡å‘æˆ‘ä»¬çš„`/popular/:id`è·¯ç”±æ·»åŠ ä¸€ä¸ª`fetchInitialData`å±æ€§ï¼Œå½“ç”¨æˆ·ä»æœåŠ¡å™¨å‘å‡ºä¸€ä¸ªå¸¦æœ‰è¯¥è·¯å¾„çš„`GET`è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬å°†ç»§ç»­è°ƒç”¨`fetchInitialData`å¹¶å‘å…¶ä¼ é€’è¯¥è·¯å¾„ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªæ‰¿è¯ºï¼Œè¯¥æ‰¿è¯ºæœ€ç»ˆå°†è§£ææˆ‘ä»¬éœ€è¦å‘ˆç°çš„æ•°æ®ã€‚

è®©æˆ‘ä»¬å›åˆ°æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼Œçœ‹çœ‹è¿™äº›å˜åŒ–ä¼šæ˜¯ä»€ä¹ˆæ ·å­ã€‚

æˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯æ‰¾å‡ºå“ªä¸ªè·¯ç”±(å¦‚æœæœ‰çš„è¯)åŒ¹é…å½“å‰è¯·æ±‚çš„æœåŠ¡å™¨ URLã€‚ä¾‹å¦‚ï¼Œå¦‚æœç”¨æˆ·è¯·æ±‚`/`é¡µé¢ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°åŒ¹é…`/`çš„è·¯çº¿ã€‚å¹¸è¿çš„æ˜¯ï¼ŒReact Router å¯¼å‡ºäº†ä¸€ä¸ª`matchPath`å‡½æ•°ï¼Œå®ƒåœ¨å†…éƒ¨ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥åŒ¹é…ä½ç½®å’Œè·¯çº¿ã€‚

```
// server/index.js
...
import { matchPath } from "react-router-dom"
import routes from '../shared/routes'

app.get("*", (req, res, next) => {
  const activeRoute = routes.find(
    (route) => matchPath(req.url, route)
  ) || {}

})

... 
```

ç°åœ¨ï¼Œ`activeRoute`å°†æ˜¯ç”¨æˆ·è¯·æ±‚çš„ä»»ä½•é¡µé¢çš„è·¯å¾„(`req.url`)ã€‚

ä¸‹ä¸€æ­¥æ˜¯æŸ¥çœ‹è¯¥è·¯ç”±æ˜¯å¦éœ€è¦ä»»ä½•æ•°æ®ã€‚æˆ‘ä»¬å°†æ£€æŸ¥`activeRoute`æ˜¯å¦æœ‰ä¸€ä¸ª`fetchInitialData`å±æ€§ã€‚å¦‚æœæ˜¯ï¼Œæˆ‘ä»¬å°†è°ƒç”¨å®ƒå¹¶æŠŠå½“å‰è·¯å¾„ä¼ é€’ç»™å®ƒï¼Œå¦‚æœä¸æ˜¯ï¼Œæˆ‘ä»¬å°†ç»§ç»­ã€‚

```
app.get("*", (req, res, next) => {
  const activeRoute = routes.find((route) => matchPath(req.url, route)) || {}

  const promise = activeRoute.fetchInitialData
    ? activeRoute.fetchInitialData(req.path)
    : Promise.resolve()

  promise.then((data) => {

  }).catch(next)
}) 
```

ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªæ‰¿è¯ºï¼Œå®ƒå°†é€šè¿‡æ•°æ®æ¥è§£å†³ï¼Œæˆ–è€…ä»€ä¹ˆéƒ½ä¸ç”¨åšã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€åšçš„ï¼Œæˆ‘ä»¬å¸Œæœ›è·å–å®ƒï¼Œå¹¶å°†å…¶ä¼ é€’ç»™æˆ‘ä»¬çš„ç»„ä»¶ï¼ŒåŒæ—¶å°†å…¶æ”¾åœ¨çª—å£å¯¹è±¡ä¸Šï¼Œä»¥ä¾¿å®¢æˆ·ç«¯ç¨åå¯ä»¥è·å–å®ƒã€‚

```
app.get("*", (req, res, next) => {
  const activeRoute = routes.find((route) => matchPath(req.url, route)) || {}

  const promise = activeRoute.fetchInitialData
    ? activeRoute.fetchInitialData(req.path)
    : Promise.resolve()

  promise.then((data) => {
    const markup = renderToString(
      <App data={data} />
    )

    res.send(`
      <!DOCTYPE html>
      <html>
        <head>
          <title>SSR with RR</title>
          <script src="/bundle.js" defer></script>
          <script>window.__INITIAL_DATA__ = ${serialize(data)}</script>
        </head>

        <body>
          <div id="app">${markup}</div>
        </body>
      </html>
    `)
  }).catch(next)
}) 
```

è¶Šæ¥è¶Šè¿‘ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬ä¸å†æ€»æ˜¯è·å–æµè¡Œçš„å›è´­ï¼Œè€Œæ˜¯åªåœ¨è¢«æ¸²æŸ“çš„è·¯çº¿å…·æœ‰`fetchInitialData`å±æ€§æ—¶æ‰è·å–å®ƒä»¬ã€‚è¿™æ„å‘³ç€åªæœ‰å½“ç”¨æˆ·è¯·æ±‚åŒ¹é…`/popular/:id`çš„è·¯å¾„æ—¶ï¼Œæˆ‘ä»¬æ‰ä¼šè·å–æ•°æ®ã€‚

åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­å°è¯•ä¸€ä¸‹ã€‚å‰å¾€`localhost:3000/popular/javascript`ã€‚æ‚¨ä¼šæ³¨æ„åˆ°æœ€å—æ¬¢è¿çš„ JavaScript repos æ­£åœ¨è¢«è¯·æ±‚ã€‚æ‚¨å¯ä»¥å°†è¯­è¨€æ›´æ”¹ä¸º github API æ”¯æŒçš„ä»»ä½•è¯­è¨€ï¼Œæ‚¨å°†è·å¾—è¯¥è¯­è¨€æœ€å—æ¬¢è¿çš„å›å¤ã€‚è¿™æ ·åšçš„åŸå› æ˜¯å› ä¸ºåœ¨æˆ‘ä»¬çš„ routes æ•°ç»„ä¸­ï¼Œæˆ‘ä»¬è¦å°†`req.path`ä¼ é€’åˆ°`fetchInitialData`ã€‚ç„¶åå®ƒè§£æè·¯å¾„ä¸­çš„è¯­è¨€ï¼Œç„¶åç”¨è¯¥è¯­è¨€è°ƒç”¨`fetchPopularRepos`ã€‚

```
// shared/routes.js
  {
    path: '/popular/:id',
    component: Grid,
    fetchInitialData: (path = '') =>
      fetchPopularRepos(path.split('/').pop())
  } 
```

* * *

æ—¢ç„¶æˆ‘ä»¬å·²ç»æ ¹æ®ç”¨æˆ·è¯·æ±‚çš„è·¯ç”±åœ¨æœåŠ¡å™¨ä¸Šè·å–äº†æ­£ç¡®çš„æ•°æ®ï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬ä¹Ÿæ·»åŠ ä¸€äº›å®¢æˆ·ç«¯è·¯ç”±ã€‚

å’Œå¾€å¸¸ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬çš„ä¸»ç»„ä»¶(`App`)åŒ…è£…åœ¨å®¢æˆ·ç«¯ React Router çš„`BrowserRouter`ç»„ä»¶ä¸­ã€‚æˆ‘ä»¬å°†åœ¨`browser/index.js`å†…éƒ¨è¿›è¡Œï¼Œå› ä¸ºé‚£é‡Œæ˜¯æˆ‘ä»¬æ¸²æŸ“`App`çš„åœ°æ–¹ã€‚

```
import React from 'react'
import { hydrate } from 'react-dom'
import App from '../shared/App'
import { BrowserRouter } from 'react-router-dom'

hydrate(
  <BrowserRouter>
    <App data={window.__INITIAL_DATA__} />
  </BrowserRouter>,
  document.getElementById('app')
); 
```

ç°åœ¨ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»å°†å¯¹å®¢æˆ·æœºçš„æ§åˆ¶äº¤ç»™äº† React è·¯ç”±å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦åœ¨æœåŠ¡å™¨ä¸ŠåšåŒæ ·çš„äº‹æƒ…ï¼Œä»¥ä¾¿å®ƒä»¬åŒ¹é…ã€‚å› ä¸ºæˆ‘ä»¬åœ¨æœåŠ¡å™¨ä¸Šï¼Œæ¸²æŸ“ä¸€ä¸ªå«`BrowserRouter`çš„ç»„ä»¶æ²¡æœ‰æ„ä¹‰ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ React è·¯ç”±å™¨çš„`StaticRouter`ç»„ä»¶ã€‚å®ƒè¢«ç§°ä¸º`StaticRouter`,å› ä¸ºä½ç½®å®é™…ä¸Šä»æœªæ”¹å˜ã€‚å®ƒéœ€è¦ä¸¤ä¸ªé“å…·:`location`å’Œ`context`ã€‚`location`æ˜¯ç”¨æˆ·è¯·æ±‚çš„å½“å‰ä½ç½®(`req.url`),`context`éœ€è¦æ˜¯ä¸€ä¸ªå¯ä»¥åŒ…å«å…³äºæ¸²æŸ“çš„ä»»ä½•ä¿¡æ¯çš„å¯¹è±¡â€”â€”æˆ‘ä»¬ç°åœ¨å°†ä½¿ç”¨ä¸€ä¸ªç©ºç™½çš„ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚

```
// server/index.js
...
import { StaticRouter, matchPath } from "react-router-dom"
...

const markup = renderToString(
  <StaticRouter location={req.url} context={{}}>
    <App data={data}/>
  </StaticRouter> )

... 
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¸²æŸ“ä¸€äº›å®¢æˆ·ç«¯è·¯çº¿ã€‚æˆ‘ä»¬å·²ç»æœ‰äº†æˆ‘ä»¬çš„`routes`æ•°ç»„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ˜ å°„å®ƒã€‚ä¸€ä¸ªè­¦å‘Šæ˜¯ï¼Œæˆ‘ä»¬è¿˜å¸Œæœ›[å°† React è·¯ç”±å™¨](https://tylermcginnis.com/react-router-pass-props-to-components/)å‘ˆç°çš„ç»„ä»¶ä¼ é€’ç»™`fetchInitialData`å±æ€§(å¦‚æœå®ƒå­˜åœ¨çš„è¯),è¿™æ ·ï¼Œå¦‚æœå®¢æˆ·ç«¯è¿˜æ²¡æœ‰æ¥è‡ªæœåŠ¡å™¨çš„æ•°æ®ï¼Œå®ƒä¹Ÿå¯ä»¥è°ƒç”¨å®ƒã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`Route`çš„`render`æ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è‡ªå·±åˆ›å»ºå…ƒç´ å¹¶ç»™å®ƒä¼ é€’ä»»ä½•é“å…·ã€‚

```
// shared/App.js
import React, { Component } from 'react'
import routes from './routes'
import { Route } from 'react-router-dom'

class App extends Component {
  render() {
    return (
      <div>
       {routes.map(({ path, exact, component: C, ...rest }) => (
          <Route
            key={path}
            path={path}
            exact={exact}
            render={(props) => (
              <C {...props} {...rest} />
            )}
          />
        ))}
      </div>
    )
  }
} 
```

åœ¨æˆ‘ä»¬ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘ä»¬ç»™æˆ‘ä»¬çš„`App`æ·»åŠ ä¸€ä¸ªå¯¼èˆªæ å’Œä¸€ä¸ª [catch all - 404](https://tylermcginnis.com/react-router-handling-404-pages/) è·¯çº¿ã€‚

```
// shared/Navbar.js
import React from 'react'
import { NavLink } from 'react-router-dom'

export default function Navbar () {
  const languages = [{
    name: 'All',
    param: 'all'
  }, {
    name: 'JavaScript',
    param: 'javascript',
  }, {
    name: 'Ruby',
    param: 'ruby',
  }, {
    name: 'Python',
    param: 'python',
  }, {
    name: 'Java',
    param: 'java',
  }]

  return (
    <ul>
      {languages.map(({ name, param }) => (
        <li key={param}>
          <NavLink activeStyle={{fontWeight: 'bold'}} to={`/popular/${param}`}>
            {name}
          </NavLink>
        </li>
      ))}
    </ul>
  )
} 
```

```
// shared/NoMatch.js
import React from 'react'

export default function NoMatch () {
  return (
    <div>
      Four Oh Four
    </div>
  )
} 
```

```
import React, { Component } from 'react'
import routes from './routes'
import { Route, Switch } from 'react-router-dom'
import Navbar from './Navbar'
import NoMatch from './NoMatch'

class App extends Component {
  render() {
    return (
      <div>
        <Navbar />

        <Switch>
         {routes.map(({ path, exact, component: C, ...rest }) => (
            <Route
              key={path}
              path={path}
              exact={exact}
              render={(props) => (
                <C {...props} {...rest} />
              )}
            />
          ))}
          <Route render={(props) => <NoMatch {...props} />} />
        </Switch>
      </div>
    )
  }
}

export default App 
```

## [](#)ğŸ‘ŒğŸ‘ŒğŸ‘Œ

çœ‹èµ·æ¥ä¸é”™ã€‚å¦‚æœæˆ‘ä»¬è½¬åˆ°`/`è·¯çº¿ï¼Œæˆ‘ä»¬å°†å¾—åˆ°é¢„æœŸçš„`Navbar`å’Œ`Home`ç»„ä»¶ï¼Œä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å•å‡»å…¶ä¸­ä¸€ä¸ª`Link`ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªé”™è¯¯- `Cannot read property 'map' of undefined`ã€‚

å®é™…ä¸Šï¼Œä¹‹å‰æˆ‘ä»¬å°†`data`ä½œä¸ºé“å…·ä¼ é€’ç»™`App`ï¼Œç„¶åï¼Œæˆ‘ä»¬å°†å®ƒä¼ é€’ç»™`Grid`ã€‚å› ä¸ºæˆ‘ä»¬ä¸å†æ¸²æŸ“`App`å†…çš„`Grid`(å› ä¸ºæˆ‘ä»¬æ­£åœ¨æ¸²æŸ“`Route` s ),æ‰€ä»¥`data`ä¸ä¼šåˆ°è¾¾`Grid`,å› æ­¤`Grid`å†…çš„`props.data`æ˜¯æœªå®šä¹‰çš„ã€‚é‚£æ˜¯ä¸€å£ã€‚åŸºæœ¬ä¸Š`Grid`ä¸å†æ¥æ”¶å®ƒéœ€è¦çš„æ•°æ®ã€‚

æœ‰å‡ ç§ä¸åŒçš„æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å½“æˆ‘ä»¬åœ¨`render`æ–¹æ³•ä¸­å‘ˆç°æ•°æ®æ—¶ï¼Œæˆ‘ä»¬*å¯ä»¥*å°†æ•°æ®ä¼ é€’ç»™ç»„ä»¶ã€‚

```
<C {...props} {...rest} data={this.props.data} /> 
```

é‚£è¡Œå¾—é€šã€‚ä½†æ˜¯å®ƒä¼šä¼ é€’ç»™æ¯ä¸ªç»„ä»¶ï¼Œç”šè‡³æ˜¯é‚£äº›ä¸éœ€è¦å®ƒçš„ç»„ä»¶ã€‚æˆ‘ä»¬å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œåªæœ‰å½“å®ƒæ˜¯`Grid`ç»„ä»¶æ—¶æ‰é€šè¿‡å®ƒï¼Œä½†è¿™ä¼¼ä¹è¿‡äºå¤æ‚ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰è°ˆåˆ°çš„`context`é“å…·ã€‚æˆ‘ä»¬ç²˜è´´åœ¨ä¼ é€’ç»™`context`çš„å¯¹è±¡ä¸Šçš„ä»»ä½•ä¸œè¥¿ï¼Œæˆ‘ä»¬ä»¥åéƒ½èƒ½å¤Ÿåœ¨ä»»ä½•ç»„ä»¶ä¸­ä»¥`props.staticContext`çš„èº«ä»½è®¿é—®ã€‚æ‰€ä»¥ä¸å…¶æŠŠ`data`ä¼ ç»™`App`ï¼Œä¸å¦‚ç”¨`context`æ¥ä»£æ›¿ã€‚

```
// server/index.js
...

promise.then((data) => {
  const context = { data }

  const markup = renderToString(
    <StaticRouter location={req.url} context={context}>
      <App />
    </StaticRouter>
  )

... 
```

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä¸å†å°†ä»»ä½•ä¸œè¥¿ä½œä¸ºé“å…·ä¼ é€’ç»™`App`ã€‚ç°åœ¨ï¼Œä¸ºäº†è®¿é—®æµè¡Œçš„å›è´­ï¼Œæˆ‘ä»¬å°†ä»`props.staticContext.data`ä¸­è·å¾—å®ƒã€‚è®©æˆ‘ä»¬å‰å¾€æˆ‘ä»¬çš„`Grid`ç»„ä»¶ï¼Œåœ¨é‚£é‡Œæˆ‘ä»¬éœ€è¦æ•°æ®å¹¶è¿›è¡Œæ›´æ”¹ã€‚

```
class Grid extends Component {
  render() {
    const repos = this.props.staticContext.data

    return (
      <ul style={{display: 'flex', flexWrap: 'wrap'}}>
        {repos.map(({ name, owner, stargazers_count, html_url }) => (
          <li key={name} style={{margin: 30}}>
            <ul>
              <li><a href={html_url}>{name}</a></li>
              <li>@{owner.login}</li>
              <li>{stargazers_count} stars</li>
            </ul>
          </li>
        ))}
      </ul>
    )
  }
} 
```

æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç°åœ¨æ­£å¤„äºä¸€ä¸ªæœ‰è¶£çš„æ—¶åˆ»ã€‚å¦‚æœä½ åœ¨æµè§ˆå™¨ä¸­åŠ è½½`http://localhost:3000/popular/javascript`,å®ƒä¼šå·¥ä½œï¼Œä½†ä¹Ÿä¼šæŠ›å‡ºä¸€äº›é”™è¯¯ã€‚è¿™æ ·åšçš„åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨æœåŠ¡å™¨ä¸Šæ¸²æŸ“ï¼Œè¿™å·¥ä½œå¾—å¾ˆå¥½ã€‚ç„¶åå½“ React è½¬åˆ°â€œæ¡èµ·æ¥â€æ—¶ï¼Œå®ƒæŠ›å‡ºä¸€ä¸ª`Cannot read property 'data' of undefined`é”™è¯¯ã€‚è¿™æ ·åšçš„åŸå› æ˜¯å› ä¸ºï¼Œå°±åƒæˆ‘ä»¬ä¹‹å‰åœ¨æœåŠ¡å™¨ä¸Šåšçš„ä¸€æ ·ï¼Œæˆ‘ä»¬æ­£åœ¨å°†ä¸€ä¸ª`data`é“å…·ä¼ é€’ç»™å®¢æˆ·ç«¯çš„`App`ç»„ä»¶ã€‚

```
// browser/index.js

hydrate(
  <BrowserRouter>
    <App data={window.__INITIAL_DATA__} />
  </BrowserRouter>,
  document.getElementById('app')
); 
```

è¿™æ˜¯è¡Œä¸é€šçš„ï¼ŒåŸå› å’Œå®ƒåœ¨æœåŠ¡å™¨ä¸Šè¡Œä¸é€šä¸€æ ·ã€‚`App`ä¸å†å°†æ•°æ®ä¼ é€’ç»™`Grid`ç»„ä»¶ã€‚æˆ‘ä»¬å¯ä»¥ä»`Grid`ç»„ä»¶å†…éƒ¨çš„`window`å¯¹è±¡ä¸­è·å–æ•°æ®ï¼Œè€Œä¸æ˜¯å‘ä¸‹ä¼ é€’æ•°æ®ã€‚

```
// browser/index.js

hydrate(
  <BrowserRouter>
    <App />
  </BrowserRouter>,
  document.getElementById('app')
); 
```

```
class Grid extends Component {
  constructor(props) {
    super(props)

    let repos
    if (__isBrowser__) {
      repos = window.__INITIAL_DATA__
      delete window.__INITIAL_DATA__
    } else {
      repos = props.staticContext.data
    }

    this.state = {
      repos,
    }
  }
  render() {
    const { repos } = this.state

    return (
      <ul style={{display: 'flex', flexWrap: 'wrap'}}>
        {repos.map(({ name, owner, stargazers_count, html_url }) => (
          <li key={name} style={{margin: 30}}>
            <ul>
              <li><a href={html_url}>{name}</a></li>
              <li>@{owner.login}</li>
              <li>{stargazers_count} stars</li>
            </ul>
          </li>
        ))}
      </ul>
    )
  }
} 
```

çœ‹èµ·æ¥ä¸é”™ã€‚ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸Šæ¸²æŸ“ï¼Œæˆ‘ä»¬å°†ä»`window.__INITIAL_DATA__`è·å–æ•°æ®ï¼Œå¦‚æœä¸æ˜¯ï¼Œæˆ‘ä»¬å°†ä»`staticContext`è·å–æ•°æ®ã€‚

### æˆ‘å‘ä½ ä¿è¯æˆ‘ä»¬å·²ç»å¾ˆæ¥è¿‘äº†ã€‚

è‡³æ­¤ï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨å·²ç»å…¨éƒ¨å®Œæˆã€‚å®ƒæ­£ç¡®åœ°è·å–è¯·æ±‚çš„è·¯å¾„ï¼Œè·å–è¯¥è·¯å¾„çš„ä»»ä½•æ•°æ®ï¼Œç„¶åå‘é€å›ä¸€ä¸ªè‰¯å¥½çš„æœåŠ¡å™¨å‘ˆç°å“åº”ã€‚æ˜¯å®¢æˆ·æœ‰é—®é¢˜ã€‚ä¾‹å¦‚ï¼ŒåŠ è½½å›å®¶è·¯çº¿`localhost:3000`ï¼Œç„¶åç‚¹å‡»â€œJavaScriptâ€é“¾æ¥ã€‚ä½ ä¼šæ³¨æ„åˆ°ä½ å¾—åˆ°ä¸€ä¸ªé”™è¯¯ã€‚çŸ¥é“ä¸ºä»€ä¹ˆä¼šè¿™æ ·å—ï¼Ÿè®°ä½ï¼Œæˆ‘ä»¬åŒæ—¶å¤„ç†æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯æ¸²æŸ“ã€‚æœåŠ¡å™¨ç«¯æ¸²æŸ“åªåœ¨åˆå§‹é¡µé¢åŠ è½½æ—¶è¿›è¡Œï¼Œä¹‹åï¼ŒReact Router ä¼šæ¥ç®¡ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è¯·æ±‚åº”ç”¨ç¨‹åºæ—¶ï¼Œä¸€åˆ‡éƒ½å¾ˆå¥½ã€‚ç„¶åï¼ŒReact è·¯ç”±å™¨æ¥ç®¡ï¼Œæˆ‘ä»¬å°è¯•è®¿é—®`/popular/javascript`ï¼Œç”±äºæˆ‘ä»¬æ²¡æœ‰æ­£ç¡®çš„æ•°æ®ï¼Œåº”ç”¨ç¨‹åºä¸­æ–­ã€‚å¥½æ¶ˆæ¯æ˜¯è¦è§£å†³è¿™ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬å¯ä»¥åƒå¾€å¸¸ä¸€æ ·åšâ€”â€”å¦‚æœæˆ‘ä»¬è¿˜æ²¡æœ‰ä»æœåŠ¡å™¨è·å–æ•°æ®ï¼Œå°±åœ¨`componentDidMount`è·å–æ•°æ®ã€‚

```
class Grid extends Component {
  constructor(props) {
    super(props)

    let repos
    if (__isBrowser__) {
      repos = window.__INITIAL_DATA__
      delete window.__INITIAL_DATA__
    } else {
      repos = this.props.staticContext.data
    }

    this.state = {
      repos,
      loading: repos ? false : true,
    }

    this.fetchRepos = this.fetchRepos.bind(this)
  }
  componentDidMount () {
    if (!this.state.repos) {
      this.fetchRepos(this.props.match.params.id)
    }
  }
  fetchRepos (lang) {
    this.setState(() => ({
      loading: true
    }))

    this.props.fetchInitialData(lang)
      .then((repos) => this.setState(() => ({
        repos,
        loading: false,
      })))
  }
  render() {
    const { repos, loading } = this.state

    if (loading === true) {
      return <p>LOADING</p>
    }

    return (
      <ul style={{display: 'flex', flexWrap: 'wrap'}}>
        {repos.map(({ name, owner, stargazers_count, html_url }) => (
          <li key={name} style={{margin: 30}}>
            <ul>
              <li><a href={html_url}>{name}</a></li>
              <li>@{owner.login}</li>
              <li>{stargazers_count} stars</li>
            </ul>
          </li>
        ))}
      </ul>
    )
  }
} 
```

ç°åœ¨ï¼Œå½“ç»„ä»¶æŒ‚è½½æ—¶ï¼Œå¦‚æœæˆ‘ä»¬è¿˜æ²¡æœ‰æ•°æ®(å¦‚æœ React Router å°†æˆ‘ä»¬å¸¦åˆ°è¿™ä¸ªé¡µé¢ï¼Œæˆ‘ä»¬å°±ä¸ä¼šæœ‰æ•°æ®)ï¼Œæˆ‘ä»¬å°†è·å–å®ƒï¼Œç„¶åè°ƒç”¨`setState`ã€‚æˆ‘ä»¬è¿˜åœ¨æˆ‘ä»¬çš„å·ä¸­æ·»åŠ äº†ä¸€ä¸ª`loading`å±æ€§æ¥ç¨å¾®æ”¹å–„ä¸€ä¸‹ UXã€‚

## [](#one-more-problem)ä¸€ä¸ªã€‚æ›´å¤šã€‚é—®é¢˜ã€‚

ç°åœ¨ï¼Œå½“æˆ‘ä»¬ä»`/`å¯¼èˆªåˆ°`/popular/javascript`æ—¶ï¼Œä¸€åˆ‡æ­£å¸¸ã€‚ä½†æ˜¯å½“æˆ‘ä»¬ä»ä¸€ç§è¯­è¨€è½¬å‘å¦ä¸€ç§è¯­è¨€æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿè¯´ä»`/popular/javascript`åˆ°`/popular/ruby`ï¼Ÿä½ ä¼šå‘ç°ä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿã€‚åŒæ ·ï¼Œè¿™åªæ˜¯ä¸€ä¸ªååº”çš„äº‹æƒ…ã€‚é“å…·åœ¨å˜ï¼Œä½†æ˜¯ç»„ä»¶ä¸ä¼šé‡æ–°å®‰è£…ï¼Œæ‰€ä»¥`componentDidMount`ä¸ä¼šè¢«å†æ¬¡è°ƒç”¨ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ React çš„`componentWillReceiveProps`ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

```
// shared/Grid.js

componentWillReceiveProps (nextProps) {
  const { match, fetchInitialData } = this.props

  if (nextProps.match.params.id !== match.params.id) {
    this.fetchRepos(nextProps.match.params.id)
  }
} 
```

ç°åœ¨ï¼Œå½“ä¸‹ä¸€ç§è¯­è¨€(`nextProps.match.params.id`)ä¸å‰ä¸€ç§è¯­è¨€(`match.params.id`)ä¸åŒ¹é…æ—¶ï¼Œæˆ‘ä»¬å°†ç»§ç»­è°ƒç”¨`fetchRepos`ä¼ é€’æ–°è¯­è¨€ã€‚

å°±è¿™æ ·ï¼Œæˆ‘ä»¬ç»“æŸäº†ï¼ç¬¬ä¸€ä¸ªè¯·æ±‚å°†ç”±æœåŠ¡å™¨å‘ˆç°ï¼Œéšåçš„æ¯ä¸ªè·¯å¾„æ›´æ”¹å°†ç”±ååº”è·¯ç”±å™¨æ‹¥æœ‰ã€‚

ç°åœ¨ï¼Œä½ å‘Šè¯‰æˆ‘ï¼Œè¿™ç§å¤æ‚æ€§å€¼å¾—ç»™ä½ çš„åº”ç”¨å¸¦æ¥å¥½å¤„å—ï¼ŸğŸ¤·â€

> ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°æœ€ç»ˆä»£ç -[github.com/tylermcginnis/rrssr](https://github.com/tylermcginnis/rrssr)ã€‚

* * *

è¿™ç¯‡æ–‡ç« æœ€åˆå‘è¡¨åœ¨ TylerMcGinnis.com å¤§å­¦ï¼Œæ˜¯ä»–ä»¬ T2 ååº”è·¯ç”±å™¨è¯¾ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚