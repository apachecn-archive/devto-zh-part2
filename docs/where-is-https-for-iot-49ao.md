# 物联网的 HTTPS 在哪里？(更新)

> 原文：<https://dev.to/danielkun/where-is-https-for-iot-49ao>

*更新，2018 年 10 月 22 日:*增加提案 1.a，增加 HTTP 公钥锁定

现在每个人都应该知道 HTTPS 是安全的，HTTPS 是重要的。在这个时代，浏览器甚至宣布 HTTP 网站“不安全”。然而，当你看到物联网设备时，比如你的智能家居设备，它们通常使用 HTTP。这意味着它们在没有加密的情况下通信。

***免责声明:**我不是安全专家，所以如果您发现信息可能不完全正确或不完整，请多包涵。我将很高兴在评论中收到您的反馈并更新文章！*

# 物联网(传输层)安全问题

物联网设备通常很便宜，因此工程工作也需要便宜和快速。通常没有预算或时间来考虑安全性。因此，即使是绝对的安全基础，如身份验证，也常常不存在。外面有足够多的小玩意，当你接入别人的局域网时，你可以完全控制它们。

这不仅是来自亚洲的无名产品的问题，甚至是来自知名公司的设备的问题，比如 Google Home。Google Home 应用程序使用的本地 Google Home API 有一个官方文档。根据这个文档——我希望现在 API 已经被撤销和重新设计了——至少在某个时间点，通信是未加密的(HTTP)和未认证的。哇哦。

虽然不使用身份认证是你可以——也必须——责怪任何工程师的事情，但你不能责怪任何人不在他们的物联网设备上使用 HTTPS。为什么？因为这是不可能的。至少当看到 HTTPS 像它被设计的那样工作时不会。我们稍后会看到为什么会这样，但事实是，通过 HTTPS 的安全通信机制是以一种你不能轻易将其用于本地通信的方式设计的。哎哟。是的，我知道，这有点夸张，但我还能怎样引起你的注意呢？:-)

Mahmoud Al-Qudsi 已经为 T2 写了一篇很好的博文。

*这里有一张令人震惊的图片，它会让你的血压瞬间升高:*

[![Browser shows unsecure hint](../Images/880e172cc83eb16808a3d6b4812b36e4.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--kH54zSRo--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/bcrd976y7w93wvjt35gw.png)

# 面向所有物联网开发者的即时安全措施

在我们深入了解 HTTPS 之前，有几项非常重要的安全措施是每个物联网设备开发人员绝对必须遵守的:

*   对所有 API 端点使用身份验证。
*   为每台设备使用在制造过程中生成的唯一、强密码。
*   使用防火墙/iptables/netfilter 关闭公共 IP 未使用的所有端口。
*   不要直接使用任何 HTTP 服务器实现来公开用任何语言编写的服务——而是使用一个维护良好、测试良好的 HTTP 服务器作为入口，比如也可用于 ARM 的 [nginx](https://www.nginx.com/) 。
*   允许用户更新固件，甚至自动更新。

[![Scribbled login form](../Images/385ea4488f5a4a52dffe662f81aff363.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--wZ4hCsvm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/4gswwd1qv5wqns48piw2.png)

# 物联网中使用 HTTPS 的好处

但是你为什么要考虑使用 HTTPS 呢？首先，如果你认为你的家庭网络是一个只有你才能进入的神圣的地方，那么你可以放心使用 HTTP。但是，如果您接受这样一个事实，即您总是有可能或多或少地访问您的整个局域网，那么当您知道即使存在这种入侵可能性，即使不知道正确的凭据或授权，您的物联网设备仍然是安全的，您也会感到更安全。

有人可以访问您的局域网的一种方式是一种非常古老、非常容易的攻击，称为“ [DNS 重新绑定](https://en.wikipedia.org/wiki/DNS_rebinding)”，我们将在稍后讨论另一个原因。DNS 重新绑定允许攻击者[访问关键组件](https://medium.com/@brannondorsey/attacking-private-networks-from-the-internet-with-dns-rebinding-ea7098a2d325)，比如你的路由器——而路由器通常有[很多安全漏洞](https://threatpost.com/popular-d-link-router-riddled-with-vulnerabilities/127907/)。你相信了吗？那么，HTTPS 能帮上什么忙呢？

HTTPS 防止通信嗅探，数据操纵，并提供验证您的同行。这应该会让你感觉更安全，因为即使你的路由器被入侵，你的银行账户登录仍然是安全的。此外，HTTPS 验证服务器的身份，以便您可以确定您正在与谁通信，并且在犯罪发生的情况下，您知道该起诉谁。耶！

[![HTTPS browser badge](../Images/aa5fc218dd77872b8a7f357253697900.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--eF_MaqzE--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/pmohesrheuzrnnddwrte.png)

让我们记住 HTTPS 保证的这三个重要承诺，因为我们稍后会谈到它们:

1)隐私:没有通信嗅探
2)完整性:没有数据操纵
3)识别:你知道你在和谁说话(或者:你在和谁的软件说话)

# 核心问题

HTTPS 的核心问题是它的一个基本组成部分是主机名。浏览器将您在地址栏中输入的主机名与服务器证书颁发给的主机名进行比较。如果这些不匹配，浏览器将不会连接到服务器，除非当您的用户费力地通过几乎不可见的链接最终为您的设备添加一个例外。并且它会告诉你的用户，他目前正在做的事情是非常不安全的。令人恐惧！

而且还不止这些:[自 2015 年 11 月 1 日](https://community.digicert.com/en/blogs.entry.html/2013/12/19/important-changes-to-ssl-certificates-on-intranets-what-you-need-to-know.html)起，该域名不得是 IPv4 或 IPv6 地址，必须是拥有公共顶级域名的 FQDN。没有 192.168.1.20 或 raspberry.local 的证书！

在其他场景中，没有这样的控制可用，例如 Homee 等其他物联网小工具中的内置客户端可以触发任意 https 端点(通常用于 [IFTTT](https://ifttt.com/) ，但也可以指向您的本地设备)，通信将完全不可能。

所以，这咬你，当:

*   您希望在您的物联网设备上提供安全的网络前端
*   您希望在物联网设备上提供安全的本地 API

# 无解在望？

所以我们似乎运气不佳。到目前为止，本地 HTTPS 连接的传输层安全性的通用解决方案似乎是不可能的。HTTPS 在设计时就考虑到了公共互联网，不包含正确处理本地使用的机制。但是，我们有什么选择来保护我们的物联网通信呢？剧透:没有一个在所有环境下都能开箱即用。

## 解决方案 1:忽略 SSL 证书中的无效主机

如果你足够幸运，自己构建了所有客户端，也就是说，当你构建了一个移动或桌面应用程序来连接到你的设备或者你的设备相互连接时，你仍然可以建立 HTTPS 连接。几乎所有 HTTPS 客户端都允许您在代码中处理证书错误。这里有一个 Java 的例子。只是请确保您只忽略关于主机名的错误，并且当证书有其他错误时，例如当它过期时，仍然让连接失败。

亲:工程在离线情况下，没有一个字节离开您的本地网络。反对:只有当你控制了所有的客户时才有效。:-(

## 解决方案 2:将公共域名用于私有 IP

这就是 [Plex 的工作方式](https://blog.filippo.io/how-plex-is-doing-https-for-all-its-users/)。您可以为您的所有设备创建动态域名，例如在子域中使用 GUID 或其他名称，并将它们解析为您设备的私有 IP。这需要一些基础设施以编程方式添加 DNS 条目并为其创建证书。如今，谷歌、Azure &公司的云 DNS 提供商很容易做到这一点。这相当复杂，但效果很好——只要你用户的路由器不做 DNS 重新绑定保护。

如果您恰好只有使用不进行 DNS 重新绑定保护的路由器的客户，或者您控制本地网络基础设施和互联网访问以解析域名，或者运行本地 DNS 服务器，那么您就很酷。这是一个非常可行的，也许是最好的解决方案。如果您不控制网络基础设施，尤其是路由器，DNS 重新绑定保护变得更加流行的风险很高，您的解决方案开始对越来越多的用户失效。

利:除了域查找，所有的流量都是本地的，并被标记为安全的——即使在对安全敏感的浏览器中——并且在许多情况下都没有问题。缺点:在大多数设置中运行良好，但是对于碰巧使用安全路由器的非专业用户来说非常麻烦。:-(

## 解决方案#3:滚动你自己的密码！嗯，不尽然

实际上，我在生产中见过这种情况。您可以依赖于经过充分测试和验证的高质量 JavaScript 加密库，这些库允许您实现诸如证书验证之类的事情(除了主机名，哟！)和有效载荷的加密。W3C 甚至正在对这样的库[进行标准化。](https://www.w3.org/TR/WebCryptoAPI/)

你应该完全确保你有适当的知识来解决这个问题，或者让你的解决方案由知道这类事情的人来验证。很容易犯错误。

教授:当你正确使用的时候，它可以保证有效并且非常安全。反对:你的浏览器仍然会告诉你的用户通信是不安全的，尽管你已经尽了最大努力。并且您不能使用标准客户端(如 curl)与您的设备进行通信。:-(

## 解决方案#4:公共反向代理

疯狂:为了获得所有浏览器和客户端都信任的安全性，你必须向公共互联网开放你的本地网络！要为本地设备获取 HTTPS，您可以设置一个可公开访问的反向代理，通过安全隧道将传入流量转发到您的本地设备。一个简单的自制设置可能如下所示:

1)为您的每个物联网设备创建一个唯一且不易被猜到的子域，例如 09460e83-1759-4fbd-afed-9ee4adf8b288.iot.example.com
2)通过 Let's Encrypt 为该域生成一个证书，并将其部署到您的物联网设备。
3)从您的物联网设备建立 ssh 连接，将 HTTPS 端口上的传入流量传输到本地 web 服务器:

```
ssh user@09460e83-1759-4fbd-afed-9ee4adf8b288.iot.example.com -R *:443:localhost:443 
```

Enter fullscreen mode Exit fullscreen mode

然后嘭的一声，你就可以在本地设备上安装 HTTPS 了。

有些服务让这变得更加容易，比如 https://ngrok.com/的 T1 和 https://webhookrelay.com/的 T3。

Pro:将在所有浏览器中显示为安全。缺点:没有互联网接入，它就不能在本地工作，而且会把你的设备暴露在公共互联网下。:-(但至少通过猜测或者抓取你的服务是找不到接入点的。结合非常好的密码，这并没有*那么*糟糕，但是它仍然比它应该暴露的要多得多。

## 解决方案 5:端口转发和动态 DNS

这与解决方案#4 基本相同，但安全性更低。您的设备可以连接到动态 DNS 服务(您可以自己构建或使用流行的服务之一),并保持一个指向路由器公共 IP 地址的域。然后，它从 Let's Encrypt 为该域获取一个证书，并通过 UPnP 以编程方式设置一个转发给自己的端口。但见鬼，你的设备现在可以从互联网上公开访问，公共 IP 枚举将使它被黑客检测到。

优点:设置起来并不复杂；缺点:非常不安全。首先，你根本不想使用端口转发，因为它在你的本地网络中钻了一个整体，否则就与公网隔绝了。其次，这种特定的设置通过枚举 ISP 的 IP 范围使您的设备可以被公开访问，并且它很可能成为脚本小子和黑客的目标。不要这样！:-(
此外-我很高兴这是现在的情况-大多数路由器默认不允许 UPnP，必须手动启用。

# 一个合适的解决方案是什么样的？

我们现在的问题是信任。您的浏览器不信任您的设备，因为浏览器无法验证该设备是否仅包含值得信任的人提供的软件。在公共网站上，这是通过主机名来完成的，因为域名是注册到一个实体上的，如果他们做了什么恶意的事情，你可以追踪到他们，然后把你的脚踢到他们的屁股上。但是，如何用可能被欺骗的设备来验证这一点呢？

似乎苹果在其 HomeKit echosystem 中对此有一个解决方案。最强有力的解决方案似乎是使用特殊的认证协处理器。但在 2017 年的某个时候，也提供了软件认证解决方案。但这种解决方案绝不是公开的或公开记录的(这是苹果的典型做法)，所以我不知道它是如何工作的。我敢打赌它是相当安全的，但是，非常想知道它是如何工作的！

由于不知道苹果的秘密，我就如何设计安全系统提出了自己的建议。

## 建议#1:在 HTTPS 简单地取消对私有 IP 的主机名检查

这对于浏览器来说是显而易见的，而且对安全性来说也没那么糟糕。检查完整的证书，如到期日期、信任链。但是包含的域被忽略。相反，用户会看到证书颁发给的公司，并询问她是否信任该公司。类似于桌面应用程序询问您安装是否可以以管理员/root 身份运行。安全性仍然非常高——至少比目前的技术水平高得多

这个解决方案在多大程度上兑现了 HTTPS 的三个承诺？

1)隐私:通信是加密的，不能被监听，即使有人完全控制了你的本地网络——除了你正在连接的设备。2)完整性:这同样适用于 3)识别:这不像互联网域名那么强。通过输入域名或点击链接，你已经事先告诉了浏览器你信任谁。当浏览到一个 IP 地址时，你不需要对你的同伴的身份做出可验证的假设。这就是为什么我会考虑一次性弹出窗口告诉你谁用你输入的 IP 地址控制设备的身份，也就是说，基本上和输入域名一样强大。

## 提案#1.a:增加了公钥锁定

这个提议是我最喜欢的。浏览器的行为类似于建议#1 中所描述的，但是增加了对最近的证书的 HTTP 公钥锁定——它不能是证书链中的任何任意证书，而是验证您刚刚连接到的主机的最近的证书。浏览器将把这个证书“钉”到这个主机上——它可能是一个 IP 地址——当它连接到同一个主机，但这次收到一个不同的证书时，就会警告用户。这是宋承宪多年来的做法。这意味着它被认为足够安全，可以让您对设备进行潜在的 root 访问，所以我想它足够安全，可以连接到只能通过本地网络访问的物联网设备，也可以通过通常有限的 API 访问。

## 建议 2:让制造商验证设备的真实性

这个提议比第一个更复杂，但也更复杂。和往常一样，为了多一点安全性，你需要付出成倍的努力。

我认为没有一个通用的方法来验证一个设备没有被修修补补过。但是，可以肯定的是，制造商应该是最了解如何检查设备真实性的人。那么为什么不让厂商来做这件事呢？浏览器可以按照这种方案实现一种机制:

*   使用 HTTPS 连接到物联网设备
*   浏览器读取证书并验证通常的东西，比如有效期和信任链——但不验证主机名
*   HTTPS 响应包含一个随机生成的会话 id 和一个随机令牌，证书包含一个到在线验证 web 服务(稍后使用)的 URL
*   设备应该连接到 web 服务，并向它发送一个给定会话 id 的随机令牌
*   制造商可以选择在对设备的完整性进行某种验证之后才接受该令牌
*   在进行更多的交流之前，让用户验证证书上的制造商是她所期望和信任的机构。这很像桌面操作系统在安装软件时的做法。在提议 1 中，这是建立信任的重要部分。
*   当用户确认时，浏览器联系验证 web 服务(必须是 HTTPS！)，向它发送会话 ID 并读回令牌。将该令牌与来自设备的 HTTPS 响应中包含的令牌进行比较
*   只有当令牌匹配时，连接才被认为是成功的——额外的好处是:设备的证书和验证服务的证书必须颁发给同一家公司。这将进一步提高可信度。

这个解决方案在多大程度上兑现了 HTTPS 的三个承诺？

1)和 2)与第一个建议相同，与公共域一样强大
3)在这个建议中更强大一些，因为您将可信的、经过良好测试的公共域验证与本地设备验证相结合。此外，制造商可以选择实施额外的步骤来验证设备没有被篡改。这将是非常强大的，我不认为比公共域验证安全一点，但当然这将是一个相当麻烦的实现。另外:它需要设备和浏览器的活跃互联网连接。(不过还是那句话，IoT 中的 I 代表“互联网”。)

然而，我认为第一个建议是值得信赖的。您只想验证您正在连接的设备是否是您期望的设备。如果是这种情况，因为你认出了制造商的名字，这应该足够好了，至少对我来说是这样。通过提案 1.a 中添加的公钥锁定，您可以获得相当可靠的安全设置。

# 结论

事实是，在标准改变后，本地 HTTPS 连接只有在没有额外修补的情况下才是可能的。我认为 IETF、浏览器开发者和其他任何人都有必要关注这个问题，并为物联网制造商提供解决方案。为物联网设备提供本地网页作为前端一直很常见，它将变得更加流行。因为这篇文章中讨论的问题，在过去的几个月和几年中变得更加不切实际，现在几乎所有的制造商都回到 HTTP，以避开所有的麻烦。这是一个真正的遗憾，应该尽快改变！