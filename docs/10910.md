# ä» Jenkins ä¸Šè¿è¡Œçš„ Docker å®¹å™¨å‘å‡ºè¯·æ±‚

> åŸæ–‡:[https://dev . to/David _ oje da/make-requests-from-docker-container-running-on-Jenkins-3ln 1](https://dev.to/david_ojeda/make-requests-from-docker-container-running-on-jenkins-3ln1)

è¿™ç¯‡æ–‡ç« æ˜¯å…³äºæˆ‘é‡åˆ°çš„ä¸€ä¸ªå…·ä½“é—®é¢˜ï¼Œæˆ‘æ— æ³•ä» Docker å®¹å™¨å‘å¤–ç•Œå‘å‡ºä»»ä½•è¯·æ±‚ã€‚è¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡ä¸è©¹é‡‘æ–¯ç®¡é“å…¬å¸åˆä½œï¼Œå¹¶å†³å®šä½¿ç”¨ Docker ä½œä¸ºæˆ‘çš„éš”ç¦»ä»£ç†ã€‚

ä¸æˆ‘çš„ç¯å¢ƒç›¸å…³çš„ä¸€äº›äº‹å®:

*   Jenkins è¿è¡Œåœ¨ Tomcat ä¸Šï¼Œè€Œä¸æ˜¯ Docker å®¹å™¨ä¸Š
*   æˆ‘ä½¿ç”¨ **iptables** è¿›è¡Œç«¯å£é‡å®šå‘(80 åˆ° 8080 å’Œ 443 åˆ° 8443)

## [](#code-in-question)ä»£ç æœ‰é—®é¢˜

æˆ‘çš„ Jenkinsfile çš„ç›¸å…³éƒ¨åˆ†æ˜¯è¿™æ ·çš„:

```
stage('build and test apps') {
  failFast true
  parallel {
    stage('front end') {
      steps {
        sh 'npm install --prefix front_end/'
        sh 'npm run build --prefix front_end/'
        sh 'npm run test --prefix front_end/'
      }
    }

    stage('back end') {
      steps {
        sh 'npm install --prefix back_end/'
        sh 'npm run test --prefix back_end/'
      }
    }
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#the-logs)æ—¥å¿—

åœ¨`npm install`å‘½ä»¤ä¸Šéœ€è¦çš„è¯·æ±‚æ˜¯**å¤±è´¥ï¼Œå‡ºç° 403 http é”™è¯¯**ï¼Œå¹¶ä¸”è¿™ä¸ªæ—¥å¿—å‡ºç°:

```
npm ERR! Unexpected token < in JSON at position 0
npm ERR! <html><head><meta http-equiv='refresh' content='1;url=/login?from=%2Freact-scripts'/><script>window.location.replace('/login?from=%2Freact-scripts');</script></head><body style='background-color:white; color:white;'>
npm ERR!
npm ERR!
npm ERR! Authentication required
npm ERR! <!--
npm ERR! You are authenticated as: anonymous
npm ERR! Groups that you are in:
npm ERR!
npm ERR! Permission you need to have (but didn't): hudson.model.Hudson.Read
npm ERR!  ... which is implied by: hudson.security.Permission.GenericRead
npm ERR!  ... which is implied by: hudson.model.Hudson.Administer
npm ERR! -->
npm ERR!
npm ERR! </body></html>
npm ERR!
npm ERR! If you need help, you may report this error at:
npm ERR!     <https://github.com/npm/npm/issues> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯»å®Œæ—¥å¿—åï¼Œæˆ‘æƒ³åˆ°çš„ç¬¬ä¸€ä»¶äº‹æ˜¯:è¿™ä¸è¿è¡Œ Docker å®¹å™¨çš„ç”¨æˆ·çš„æƒé™æœ‰å…³ï¼Œåœ¨æˆ‘çš„ä¾‹å­ä¸­æ˜¯ tomcatã€‚

åœ¨è°ƒè¯•äº†ç›¸å½“é•¿ä¸€æ®µæ—¶é—´åï¼Œæˆ‘å¶ç„¶å‘ç° StackOverflow ä¸Šçš„ä¸€äº›ç¥å…‰ã€‚å¤šäºäº†è¿™ä¸ªï¼Œæˆ‘å‘ç°æˆ‘æ­£åœ¨å°†**æ‰€æœ‰**ç«¯å£ 80 å’Œ 443 æµé‡ä»**å„å¤„**é‡å®šå‘åˆ°å®ƒä»¬ç›¸åº”çš„ 8080 å’Œ 8443 ç«¯å£ã€‚

## [](#the-solution)è§£

**æ›´æ”¹ iptables ä»¥åˆ›å»ºä¸€ä¸ªå¦å®šçš„è§„åˆ™ï¼Œå¹¶é¿å…æ¥è‡ª Docker å­ç½‘**çš„é‡å®šå‘ã€‚

é¦–å…ˆï¼Œç”¨è¿™ä¸ªå‘½ä»¤æ£€æŸ¥å½“å‰çš„ iptables:

`iptables -t nat -L -n --line-numbers`

```
Chain PREROUTING (policy ACCEPT)
num  target     prot opt source               destination
1    REDIRECT   tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:80 redir ports 8080
2    REDIRECT   tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:443 redir ports 8443
3               tcp  --  0.0.0.0/0            0.0.0.0/0
4    DOCKER     all  --  0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL

Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
num  target     prot opt source               destination
1    REDIRECT   tcp  --  0.0.0.0/0            127.0.0.1            tcp dpt:443 redir ports 8443
2    REDIRECT   tcp  --  0.0.0.0/0            127.0.0.1            tcp dpt:80 redir ports 8080
3    DOCKER     all  --  0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL

Chain POSTROUTING (policy ACCEPT)
num  target     prot opt source               destination
1    MASQUERADE  all  --  172.17.0.0/16       0.0.0.0/0

Chain DOCKER (2 references)
num  target     prot opt source               destination
1    RETURN     all  --  0.0.0.0/0            0.0.0.0/0 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æºæ ä¸Šçš„å€¼ **0.0.0.0/0** æŒ‡çš„æ˜¯**æ‰€æœ‰**æµé‡ã€‚å› æ­¤ï¼Œåœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œæˆ‘éœ€è¦æ›¿æ¢é¢„è·¯ç”±å’Œè¾“å‡ºé“¾çš„å‰ä¸¤ä¸ªæ¡ç›®:

**æ³¨**:é»˜è®¤ Docker å­ç½‘ä¸º **172.17.0.0/16** ã€‚å¦‚æœæ‚¨æ›´æ”¹äº†é»˜è®¤é…ç½®ï¼Œè¯·ç¡®ä¿ä¹Ÿåœ¨å‘½ä»¤ä¸­æ›´æ”¹å®ƒä»¬ã€‚

**é¢„è·¯ç”±**

```
iptables -t nat -R PREROUTING 1 ! -s 172.17.0.0/16 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8080 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
iptables -t nat -R PREROUTING 2 ! -s 172.17.0.0/16 -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 8443 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**è¾“å‡º**

```
iptables -t nat -R OUTPUT 1 ! -s 172.17.0.0/16 -d 127.0.0.1/32 -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 8443 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
iptables -t nat -R OUTPUT 2 ! -s 172.17.0.0/16 -d 127.0.0.1/32 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8080 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œæ¥è‡ª Docker å®¹å™¨çš„è¯·æ±‚è¿”å› 200 http çŠ¶æ€ï¼Œæ¯ä¸ªäººéƒ½å¾ˆé«˜å…´ğŸ¤—å¦‚æœä½ æœ‰ç±»ä¼¼çš„é—®é¢˜ï¼Œå¸Œæœ›è¿™èƒ½å¸®åŠ©ä½ ï¼

é¡ºä¾¿æä¸€ä¸‹ï¼Œåœ¨åšè¿™äº›äº‹æƒ…çš„åŒæ—¶ï¼Œæˆ‘è¿˜éœ€è¦å­¦ä¹ æ›´å¤šå…³äº iptables åŠå…¶ä¸åŒé€‰é¡¹çš„çŸ¥è¯†ã€‚æˆ‘å‘ç°**æè¯ºå¾·**T3[çš„è¿™ä¸ªå¿«é€ŸæŒ‡å—å¾ˆæ–¹ä¾¿ã€‚](https://www.linode.com/docs/security/firewalls/control-network-traffic-with-iptables/)

æ„Ÿè°¢ä½ é˜…è¯»æˆ‘çš„æ–‡ç« ï¼