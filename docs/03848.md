# ç”¨æ³¨é‡Šå’Œå­æŸ¥è¯¢æ›´æ–° Django æŸ¥è¯¢é›†

> åŸæ–‡:[https://dev . to/pauloxnet/updating-a-django-query set-with-annotation-and subquery-48 G1](https://dev.to/pauloxnet/updating-a-django-queryset-with-annotation-andsubquery-48g1)

> ä½¿ç”¨æ³¨é‡Šå’Œå­æŸ¥è¯¢æ›´æ–° Django æŸ¥è¯¢é›†çš„æ“ä½œæŒ‡å—

## å‰è¨€

åœ¨ Django [çš„å®˜æ–¹æ–‡æ¡£](https://docs.djangoproject.com)ä¸­ï¼Œæ²¡æœ‰å…³äºä½¿ç”¨ Django ORM **update()** å’Œ **annotate()** å‡½æ•°é€šè¿‡ä½¿ç”¨æ³¨é‡Šå€¼æ¥æ›´æ–° queryset ä¸­çš„æ‰€æœ‰è¡Œçš„ä¿¡æ¯ã€‚

æˆ‘ä»¬å°†å±•ç¤ºä¸€ç§åªä½¿ç”¨ Django ORM **å­æŸ¥è¯¢()**è€Œä¸ä½¿ç”¨ *extra()* å‡½æ•°æˆ– *SQL* ä»£ç æ¥æ›´æ–°å¸¦æ³¨é‡Šçš„ Django queryset çš„æ–¹æ³•ã€‚

## å‹å·

é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨ weblog åº”ç”¨ç¨‹åºä»£ç ï¼Œå¯ä»¥åœ¨ Django æ–‡æ¡£ä¸­çš„[â€œMaking Queriesâ€](https://docs.djangoproject.com/en/2.0/topics/db/queries/)ä¸‹æ‰¾åˆ°ã€‚

`Python`

```
from django.db import models

class Blog(models.Model):
    name = models.CharField(max_length=100)
    rating = models.DecimalField(max_digits=3, decimal_places=2, default=5)

    def __str__(self):
        return self.name

class Entry(models.Model):
    blog = models.ForeignKey(Blog, on_delete=models.CASCADE)
    headline = models.CharField(max_length=255)
    rating = models.IntegerField(default=5)

    def __str__(self):
        return self.headline 
```

Enter fullscreen mode Exit fullscreen mode

## ä¸€æœŸ

åŸºäºæ‰€æœ‰æ¡ç›®çš„å¹³å‡è¯„çº§æ¥æ›´æ–°åšå®¢è¯„çº§çš„ä¸€ç§æ–¹æ³•å¯ä»¥æ˜¯:

`Python`

```
from django.db.models import Avg
from blog.models import Blog

for blog in Blog.objects.annotate(avg_rating=Avg('entry__rating')):
    blog.rating = blog.avg_rating or 0
    blog.save() 
```

Enter fullscreen mode Exit fullscreen mode

å¦‚æœæˆ‘ä»¬æœ‰å¾ˆå¤šæ¡ç›®æˆ–åšå®¢ï¼Œä¸Šé¢çš„ä»£ç å¯èƒ½ä¼šéå¸¸ä½æ•ˆå’Œç¼“æ…¢ï¼Œå› ä¸º Django ORM å¯¹ for-cycle çš„æ¯ä¸€æ­¥éƒ½æ‰§è¡Œ SQL æŸ¥è¯¢ã€‚

å¦‚æœæˆ‘ä»¬æƒ³é¿å…ä¸Šé¢çš„ä»£ç ï¼Œè€Œåœ¨å•ä¸ª SQL è¯·æ±‚ä¸­æ‰§è¡Œæ›´æ–°æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨è¿™æ ·çš„ä»£ç :

`Python`

```
Blog.objects.update(rating=Avg('entry__rating')) 
```

Enter fullscreen mode Exit fullscreen mode

ä½†æ˜¯è¿™ä¸èµ·ä½œç”¨ï¼Œæˆ‘ä»¬å°†ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„é”™è¯¯:

```
Traceback (most recent call last):
...
FieldError: Joined field references are not permitted in this query 
```

Enter fullscreen mode Exit fullscreen mode

## è§£

åœ¨ Django 1.11+ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ Django ORMï¼Œä½†æ˜¯è¦ä½¿ç”¨**å­æŸ¥è¯¢()**:

> **å­æŸ¥è¯¢()è¡¨è¾¾å¼**
> 
> æ‚¨å¯ä»¥ä½¿ç”¨**å­æŸ¥è¯¢**è¡¨è¾¾å¼å‘**æŸ¥è¯¢é›†**æ·»åŠ æ˜¾å¼å­æŸ¥è¯¢ã€‚
> 
> *[å‚è§æ–‡æ¡£](https://docs.djangoproject.com/en/2.1/ref/models/expressions/#subquery-expressions)*

`Python`

```
from django.db.models import Avg, OuterRef, Subquery
from blog.models import Blog

Blog.objects.update( 
    rating=Subquery( 
        Blog.objects.filter( 
            id=OuterRef('id') 
        ).annotate( 
            avg_rating=Avg('entry__rating') 
        ).values('avg_rating')[:1] 
    ) 
) 
```

Enter fullscreen mode Exit fullscreen mode

åœ¨ PostgreSQL ä¸Šï¼ŒSQL çœ‹èµ·æ¥åƒ:

`SQL`

```
UPDATE "blog_blog"
SET "rating" = (
   SELECT AVG(U1."rating") AS "avg_rating"
   FROM "blog_blog" U0
   LEFT OUTER JOIN "blog_entry" U1 ON (U0."id" = U1."blog_id")
   WHERE U0."id" = ("blog_blog"."id")
   GROUP BY U0."id"
   LIMIT 1
) 
```

Enter fullscreen mode Exit fullscreen mode

# å †æ ˆæº¢å‡º

æˆ‘ç¬¬ä¸€æ¬¡å†™è¿™ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯ä½œä¸ºå¯¹**æ ˆæº¢å‡º**çš„å›ç­”ã€‚

å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰ç”¨ï¼Œä½ å¯ä»¥[åœ¨ Stack Overflow ä¸Šä¸ºæˆ‘çš„ç­”æ¡ˆ](https://stackoverflow.com/a/50134728/755343)æŠ•ç¥¨ï¼Œå¹¶åœ¨[æˆ‘çš„ä¸ªäººèµ„æ–™](https://stackoverflow.com/users/755343)ä¸Šé˜…è¯»æˆ‘çš„å…¶ä»–ç­”æ¡ˆã€‚

# æ‰§ç…§

æœ¬æ–‡ä»¥çŸ¥è¯†å…±äº«ç½²åå…±äº«è®¸å¯åè®®å‘å¸ƒã€‚

ã€creativecommons.org/licenses/by-saã€‘T2

# æºä»£ç 

æˆ‘åœ¨ GitHub ä¸Šå‘å¸ƒäº†æœ¬æ–‡ä½¿ç”¨çš„æºä»£ç ã€‚

ã€github.com/pauloxnet/django_queriesã€‘T2

## ![GitHub logo](../Images/75095a8afc1e0f207cda715962e75c8d.png)[ã€pauloxnetã€‘](https://github.com/pauloxnet)/[å§œæˆˆé‡Œ](https://github.com/pauloxnet/djangoqueries)

### æˆ‘åœ¨æ–‡ç« â€œç”¨ PostgreSQL åœ¨ Django ä¸­è¿›è¡Œå…¨æ–‡æœç´¢â€ä¸­ä½¿ç”¨çš„ docs.djangoproject.comâ€œæŸ¥è¯¢â€ä»£ç ã€‚

<article class="markdown-body entry-content container-lg" itemprop="text">

# <g-emoji class="g-emoji" alias="unicorn" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f984.png">ğŸ¦„</g-emoji>å§œæˆˆæƒ³è¦

[![Twitter: pauloxnet](../Images/0301fba733289c8b07d40dfa7b222c1c.png) ](https://twitter.com/pauloxnet) [ ![Code style: black](../Images/1abbac1bb267dc041dcfa091baa4840f.png)](https://github.com/python/black)

æˆ‘çš„æ–‡ç« [â€œç”¨ PostgreSQL åœ¨ Django ä¸­è¿›è¡Œå…¨æ–‡æœç´¢â€](https://www.paulox.net/2017/12/22/full-text-search-in-django-with-postgresql)ä¸­ä½¿ç”¨çš„æºä»£ç åŸºäº Django æ–‡æ¡£ä¸»é¢˜[â€œè¿›è¡ŒæŸ¥è¯¢â€](https://docs.djangoproject.com/en/stable/topics/db/queries/)ä¸­å®šä¹‰çš„åšå®¢åº”ç”¨ç¨‹åºã€‚

## <g-emoji class="g-emoji" alias="book" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d6.png">ğŸ“–</g-emoji>æ–‡æ¡£

### æ•°æ®åº“

åœ¨æœ¬åœ° PostgreSQL å®ä¾‹ä¸­åˆ›å»º`djangoqueries`æ•°æ®åº“:

```
$ createdb -U postgres -O postgres djangoqueries
```

Enter fullscreen mode Exit fullscreen mode

### è™šæ‹Ÿç¯å¢ƒ

åˆ›å»ºå’Œæ¿€æ´»è™šæ‹Ÿç¯å¢ƒ:

```
$ python3 -m venv .venv
$ source .venv/bin/activate
```

Enter fullscreen mode Exit fullscreen mode

### <g-emoji class="g-emoji" alias="jigsaw" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f9e9.png">ğŸ§©</g-emoji> è¦æ±‚

åœ¨`djangoqueries`è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…æ‰€éœ€çš„ python åŒ…:

```
$ python3 -m pip install -r requirements/local.txt
```

Enter fullscreen mode Exit fullscreen mode

### â¬†ï¸ è¿å¾™

è¿ç§»`djangoqueries`æ•°æ®åº“ä»¥åˆ›å»ºæ‰€æœ‰éœ€è¦çš„è¡¨:

```
$ python3 -m manage migrate
```

Enter fullscreen mode Exit fullscreen mode

### <g-emoji class="g-emoji" alias="microscope" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f52c.png">ğŸ”¬</g-emoji>æµ‹è¯•

è¿è¡Œå®šä¹‰çš„æµ‹è¯•:

```
$ python3 -m manage test
```

Enter fullscreen mode Exit fullscreen mode

### <g-emoji class="g-emoji" alias="bar_chart" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ca.png">ğŸ“Š</g-emoji>æ•°æ®

ç”¨åšå®¢åº”ç”¨ç¨‹åºçš„æ¼”ç¤ºæ•°æ®å¡«å……`djangoqueries`æ•°æ®åº“:

```
$ python3 -m manage populate
```

Enter fullscreen mode Exit fullscreen mode

## è®¸å¯è¯

**Django æŸ¥è¯¢**æ ¹æ® [BSD ä¸‰æ¡æ¬¾è®¸å¯](https://github.com/pauloxnet/djangoqueries/blob/master/LICENSE.md)è·å¾—è®¸å¯ã€‚

## <g-emoji class="g-emoji" alias="busts_in_silhouette" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f465.png">ğŸ‘¥</g-emoji>ä½œè€…

### <g-emoji class="g-emoji" alias="bust_in_silhouette" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f464.png">ä¿ç½—Â·æ¢…å°”åŸºè€¶</g-emoji>

*   <g-emoji class="g-emoji" alias="earth_africa" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f30d.png">ğŸŒ</g-emoji>åšå®¢:ã€www.paulox.netã€‘T2
*   <g-emoji class="g-emoji" alias="octopus" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f419.png">ğŸ™</g-emoji> â€¦

</article>

[View on GitHub](https://github.com/pauloxnet/djangoqueries)

# åˆ†äº«

æ¶²ä½“é”™è¯¯:å†…éƒ¨

[https://www.instagram.com/p/BoFRx63CrMS/embed/captioned/](https://www.instagram.com/p/BoFRx63CrMS/embed/captioned/)