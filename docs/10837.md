# 为什么您应该在星期五下午部署

> 原文:[https://dev . to/quii/why-you-should-deploy-on-Friday-午后 285h](https://dev.to/quii/why-you-should-deploy-on-friday-afternoon-285h)

> 不要在星期五下午部署！

这种表达被认为是程序员的智慧，但我讨厌它。我要试着用语言和经验杀死它。

背后的动机是健全的。我也不想在周五晚上调试生产问题。

对我来说，这些表达带有不专业的味道。软件开发作为一个行业名声不好，像这样的短语没有帮助。

如果你在星期五下午去急诊室，却因为医生不相信他们自己的工具和技术而被拒绝，你会有什么感觉？

如果我们想让人们认真对待我们的工艺，我们需要拥有它，不要给人留下我们不了解系统的印象，我们是否在周末做出了足够的改变。

## 为什么很多人不想在周五部署

*   *你不了解你的系统*。你正在做出改变，但你不能 100%确定一切都会好。问问自己这是为什么。你为什么害怕改变你的软件？
*   监控不力。如果用户是第一个告诉你是否有问题的人，那么反馈循环会在发布的时候出现，而不是在你部署的时候。
*   过于复杂的回滚/分支。你的灾难恢复怎么样？一旦你解决了一个 bug，推出一个补丁有多容易？

## (光盘)连续交货

我曾经在一些团队中工作过，他们在下午 4:30 多次在分布式系统中部署各种服务的新版本，并且没有流过一点汗。

为什么？因为部署是完全自动化的，并且是非事件性的。这是开创性的过程。

*   写一些代码
*   `git commit -am "made the button pop"`
*   `git pull -r && ./build && git push`
*   沏一杯茶
*   现在开始直播了。

不久以前，每 6 个月发布一次，甚至在项目结束时发布一次，被认为是正常的。

那个时代的先进思想家看到了这个问题

*   不良反馈循环
*   压力大的开发团队
*   灾难性的失败。

因此，整个行业致力于大量的工具、技术和最佳实践，以使我们能够更快地发布软件。

认识到发布经常降低风险现在被普遍接受，但是团队仍然经常决定每周或每两周发布一次；经常配合他们冲刺的节奏。

## 周/夜发布有什么问题？

*   反馈回路仍然不是很好。如果你发布了你的版本，会有很多提交被激活，如果有什么地方出错了，找出到底是什么出了问题是很有挑战性的。尤其是你两周前写的。
*   仍然过度依赖手动流程。我见过团队因为 QA 休假而跳过一个发布。这在 2018 年肯定是不能接受的。手动测试不能扩展到未来。人们离开，事情被遗忘，等等。
*   让我们陷入这样一个陷阱:写故事依赖于在“冲刺”中完成的其他故事。如果不是这样，事情会变得非常复杂。

有了 CD，我们认识到我们可以走得更远，在每次绿色构建时部署新软件*来运行*。这有一些惊人的好处，

*   极快的反馈循环。当 live 出现问题时，您不必再考虑两周前编写的代码。
*   强制最佳实践。为了能够部署绿色生活，您需要出色的监控和测试。这些本身都是好事情。
*   减轻压力。“释放”不再是一件*事情*了。你可以放心地重新编写你的软件了！
*   极大地提高了灵活性。发现了窃听器？修好它！这鼓励一种更精益的工作方式，而不是大量的前期规划。甚至没有复杂发布过程的选项，你必须保持简单。
*   迫使你去写那些实际上可以发布的故事。不依赖于故事 x、y 和 z。将最佳实践强加于每个人都承认但经常被忽略的用户故事。

## 但是如果你把东西弄坏了呢？

经常有人说用 CD

> 是的，很好，但是如果它坏了呢？我们应该让质量保证人员检查一下

事情是这样的，*世界上没有一个进程可以防止 bug*。你的*将*飞船破译密码。真正重要的是你能多快发现并从中恢复。希望手工测试能捕捉到一切是痴心妄想。

## 如何 CD 上一个新项目

在一个新项目中做 CD 要容易得多，因为你可以从小项目开始并不断改进。

一般来说，你的工作应该首先集中在交付最有价值的用户旅程上，所以这是一个极好的机会来练习如何确保该功能在没有任何人检查的情况下工作。

*   编写一个端到端的测试。编写和运行这些都很昂贵，应该只保留给你最重要的旅程
*   当出现问题时，使用阈值警报进行监控
*   设置您的管道，以便当您的代码被推送时，所有的自动化测试都被运行，如果它们通过，就进入生产。
*   有某种绿/蓝释放机制。在已部署的候选发布上运行你的自动化测试，如果他们没有通过，就不要发布它。

对于每个后续的故事，问问你自己

*   我们如何知道这是有效的？(监测)
*   我需要什么样的测试才能有足够的信心在没有任何人检查的情况下工作。不是每个故事都需要在一个巨大的分布式系统上进行完整的端到端测试，但是显然你需要一些测试。
*   这个故事是不是小得不能再小了？如果你的用户故事是大量的，它们更有可能出错。如果故事需要一周时间，那么这又回到了缓慢的反馈循环。
*   如果你不能回答这些问题，那么你需要重新思考这个故事。请注意，这些都只是用户故事的基本敏捷原则。**持续交付迫使你坚持经常被忽视的原则**

## 如何在已有项目上 CD

### 剥开手动过程

*   您可能有某种“操作手册”,在运送软件时会用到。看看你能做些什么来自动化它。
*   发现所有手动过程正在发生。询问为什么需要它们，怎样才能使它们自动化。

### 光盘最多暂存。

一些公司在其交付管道中有许多环境。一个良好的开端是在正式发布之前自动发布到环境中。更好的方法是尽可能多地删除它们。有某种“开发”环境来进行实验是可以的，但是问问你自己为什么不能首先在本地测试这些东西。

### 确定一个你可以作为起点的子系统

如果您正在使用一个分布式系统，您可能能够识别出一个比其他系统更容易 CD 的系统。以此为起点，因为这会让你的团队对新的工作方式有所了解，并能帮助你开始打破文化障碍。

## CD 既是一个技术问题，也是一个文化问题

### 角色和职责

通常，产品所有者或项目经理希望成为负责发布的人。

在某些情况下,*向用户公开特性*应该由团队中的非技术成员来控制，但是这可以通过特性切换来管理。

但是将代码从一台计算机复制到另一台计算机是团队中开发人员的责任。毕竟，我们是负责确保系统运行的人。这是一个技术问题，而不是商业问题。

### 现在的 QAs 都做些什么？

CD 实际上解放了 QAs

*   与其花时间手工测试测试不佳的系统，他们现在可以专注于更全面的系统视图，尝试为 CD 提供一个环境，这样整个团队就可以确信一切正常
*   QAs 花更多的精力帮助开发人员定义需要测试和监控的内容。
*   更多时间用于探索性测试

### 重新评估你对缺陷的容忍度

许多公司*认为*他们不能有任何缺陷，并将花费大量时间和精力在复杂、耗时(因此**昂贵**)的流程上，试图阻止它们。

但是想想这一切的代价？如果您将测试未覆盖的变更推向生产，可能是 CSS 变更；考虑一下，如果某些浏览器出现一个小的视觉错误，是否真的是灾难性的

也许是这样，在这种情况下，也有专门针对这一点的测试技术。

## 恢复

您用 CD 发布的每个版本都将具有以下品质

*   大量的测试
*   良好的监控
*   小范围
*   在开发者的心目中仍然“新鲜”

所以以我的经验来看，修补任何漏洞都很容易。这比试图浏览 2 周的 git 历史要简单得多。

我建议在大多数情况下不要回滚(除非真的很糟糕)，而是修复问题并释放它。回滚有时无论如何都不是一个选项(例如数据库迁移)，所以您的系统适合快速发布的事实实际上是 CD 的一个真正优势。

## 其他快捷提示

*   快速反馈回路是关键。衡量你的`git push`生存时间并保持低水平。
*   如果事情进展缓慢，重新评估您的端到端测试。如果您删除了一个测试，或者将它重构为一个单元测试，您会更不自信吗？如果不是，那么就进行重构
*   您可能需要投入一些时间来提高组件的可测试性，以避免编写大量缓慢的端到端测试。*这是好事*。
*   功能切换是一个有用的工具，但可能会变得混乱，请注意复杂性
*   庆祝一下。从每两周发布一次到每天发布 50 次，感觉棒极了。

## 包装完毕

这只是对 CD 的一个小介绍，这是一个有大量资源可以研究的大主题。

持续交付在技术上和文化上都是一项巨大的努力，但它会带来巨大的回报。

我曾经使用 CD 开发过超过 30 个可单独部署的组件的分布式系统，这比我曾经开发过的另一个项目压力要小，那个项目只有少数几个系统，但是有大量的过程和仪式。

能够在软件写好的时候发布软件更加强调质量，并降低团队的风险。它还迫使你使用敏捷的最佳实践，比如可测试的、小的、可独立发布的用户故事。

也许最重要的是，它要求您了解您的系统，并且您不会部署到生产环境中并祈祷好运。我觉得这样更专业。