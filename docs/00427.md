# å¿«é€Ÿç¼–å†™ Redux Reducer æµ‹è¯•

> åŸæ–‡:[https://dev.to/gsto/write-redux-reducer-tests-fast-4o8d](https://dev.to/gsto/write-redux-reducer-tests-fast-4o8d)

Redux å¯èƒ½é™„å¸¦äº†è®¸å¤šæ ·æ¿æ–‡ä»¶ã€æ¨¡å¼å’Œåº“ï¼Œä½†å®ƒçš„æ ¸å¿ƒå¾ˆç®€å•ã€‚ä¸€ä¸ªå½“å‰çŠ¶æ€å’Œä¸€ä¸ªåŠ¨ä½œè¿›å»ï¼Œæ–°çš„çŠ¶æ€å‡ºæ¥ã€‚

ä»£ç ç®€å•å¹¶ä¸æ„å‘³ç€ä¸åº”è¯¥æµ‹è¯•å®ƒã€‚å¦‚æœæ‚¨åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ Reduxï¼Œè¿™æ„å‘³ç€æ‚¨çš„å•†åº—æ˜¯å®ƒçš„æ ¸å¿ƒéƒ¨åˆ†ã€‚å‡ºäºè¿™ä¸ªåŸå› ï¼Œæ‚¨åº”è¯¥å¯¹æ‚¨çš„ç¼©å‡å™¨å¯èƒ½é‡‡å–çš„æ¯ä¸ªåŠ¨ä½œï¼Œä»¥åŠå®ƒä»¬å¯èƒ½é‡‡å–çš„æ¯ä¸ªé€»è¾‘åˆ†æ”¯è¿›è¡Œæµ‹è¯•ã€‚ä½†æ˜¯ä¸è¦çƒ¦æ¼ï¼å› ä¸º reducers å¹¶ä¸å¤æ‚ï¼Œæ‰€ä»¥ç¼–å†™æµ‹è¯•ä¹Ÿä¸å¤æ‚ã€‚é€šè¿‡ä¸€ç‚¹è®¾ç½®ï¼Œæ‚¨å¯ä»¥éµå¾ªè¿™ä¸ªæ¨¡å¼ï¼Œåƒä¸“å®¶ä¸€æ ·å®Œæˆ reducer æµ‹è¯•ã€‚

*(å…ˆå¿«é€Ÿè¯´æ˜ä¸€ä¸‹ï¼å¸–å­[å†™ Redux å‡é€Ÿå™¨æµ‹è¯•å¿«](https://glennstovall.com/write-redux-reducer-tests-fast/)æœ€æ—©å‡ºç°åœ¨æˆ‘çš„ç®€è®¯ä¸Šï¼Œ[å‘¨äºŒè„‰åŠ¨](https://glennstovall.com/newsletter)ã€‚)*

## [](#set-up-reducer-tests)è®¾ç½®å‡é€Ÿå™¨æµ‹è¯•

å¦‚æœæˆ‘éœ€è¦æ¯ä¸ªæµ‹è¯•éƒ½æœ‰ä¸€ä¸ªç¼©å†™çŠ¶æ€ï¼Œæˆ‘ä½¿ç”¨çš„å”¯ä¸€è®¾ç½®æ˜¯ä½¿ç”¨ startState å¯¹è±¡ã€‚ä¸åƒ[æµ‹è¯• thunks](https://glennstovall.com/how-to-test-async-redux-thunks/) ï¼Œä¸éœ€è¦æ¨¡æ‹Ÿå­˜å‚¨ã€‚æˆ‘ä»¬çš„åˆå§‹çŠ¶æ€(ä»¥åŠæˆ‘ä»¬åœ¨æµ‹è¯•ä¸­ä½¿ç”¨çš„çŠ¶æ€)å°†æ˜¯ç®€å•çš„å¯¹è±¡ã€‚è¿™äº›æµ‹è¯•å°èµ·æ¥åº”è¯¥åƒ[é¦™è‰](https://glennstovall.com/which-version-of-javascript-is-vanilla-javascript/)ã€‚

```
const startState = {} // initial state shape if needed 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#the-reducer)å‡é€Ÿå™¨

æˆ‘å°†ä»ä¹‹å‰å…³äº[åˆ›å»ºå¼‚æ­¥åŠ¨ä½œ](https://glennstovall.com/redux-http-async/)çš„æ•™ç¨‹ä¸­æå– reducer ç¤ºä¾‹ã€‚ä»£ç é‡ç”¨ï¼Œå“‡å“¦ï¼ğŸ‰

```
const postReducer = (state = {}, action) => {
  switch (action.type) {
    case types.LOAD_POST_REQUEST:
      return {
        ...state,
        posts_loading: true,
      }
      case types.LOAD_POST_SUCCESS:
        return {
          ...state,
          posts_loading: false,
          posts: action.payload,
        }
        case types.LOAD_POST_FAILURE:
        return {
          ...state,
          posts_loading: false,
          posts_error: action.payload,
        }
        //...other actions
        default:
           return state 
        }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½œä¸ºå¿«é€Ÿå‚è€ƒï¼Œè¿™é‡Œæœ‰ä¸€äº›åŠ¨ä½œåˆ›å»ºå™¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥å¤„ç†è¿™ä¸ª reducerã€‚æˆ‘ä»¬å¾ˆå¿«å°±ä¼šéœ€è¦å®ƒä»¬

```
const loadPostsRequest = () => ({ type: types.LOAD_POSTS_REQUEST })
const loadPostsSuccess = posts => ({
  type: types.LOAD_POSTS_SUCCESS,
  payload: posts,
})
const loadPostsFailure = error => ({
  type: types.LOAD_POSTS_FAILURE,
  payload: error,
  error: true,
})
export default {
  loadPostsRequest,
  loadPostsSuccess,
  loadPostsFailure,
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#the-reducer-test-pattern)å‡é€Ÿå™¨æµ‹è¯•æ¨¡å¼

æˆ‘ä¸ºä¸€ä¸ªç¼©å‡å™¨ç¼–å†™çš„æ¯ä¸ªæµ‹è¯•éƒ½éµå¾ªè¿™ä¸ªæ¨¡å¼:

1.  æˆ‘å®£å¸ƒä¸€ä¸ªåˆå§‹çŠ¶æ€
2.  æˆ‘å£°æ˜ä¸€ä¸ªé¢„æœŸçš„ç»“æœçŠ¶æ€
3.  æˆ‘åˆ›å»ºäº†ä¸€ä¸ªåŠ¨ä½œ
4.  æˆ‘ç”¨åŠ¨ä½œå’Œåˆå§‹çŠ¶æ€è°ƒç”¨ reducer
5.  æˆ‘æ¯”è¾ƒå®é™…çŠ¶æ€å’Œé¢„æœŸçŠ¶æ€ï¼Œæˆ‘é¢„æœŸä¼šå‘ç”Ÿå˜åŒ–ã€‚

ä¸‹é¢æ˜¯ä»£ç å½¢å¼çš„æ¨¡æ¿:

```
it('should apply the updates as expected', () => {
  const start = { ...startState } // add or change fields as needed.
  const expected = {} // expected result state
  const action = actions.myActionCreator() //include arguments as needed
  const actual = reducer(start, action) 
  expect(actual).toEqual(expected)
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å˜£ã€‚å®Œæˆäº†ã€‚ä¸ºäº†ä½¿äº‹æƒ…æ›´ç®€å•ï¼Œå¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºæ²¡æœ‰åˆå§‹çŠ¶æ€ï¼Œæ‚¨å¯ä»¥å£°æ˜ä»å¤´å¼€å§‹ã€‚æ­£å¦‚æ‚¨å°†åœ¨ä¸‹é¢çœ‹åˆ°çš„ï¼Œæ‚¨å°†éœ€è¦ä¸ºç‰¹å®šçš„æƒ…å†µè°ƒæ•´å…¬å¼ï¼Œä½†æ˜¯å®ƒä»¬éƒ½å°†éµå¾ªè¿™ä¸ªæ¨¡æ¿ã€‚

## [](#example-1-loadpostsrequest)ä¾‹ 1:åŠ è½½ _ å‘å¸ƒ _ è¯·æ±‚

è®©æˆ‘ä»¬çœ‹çœ‹å®ƒçš„å®é™…æ•ˆæœã€‚æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªåŠ¨ä½œå°±æ˜¯åˆ‡æ¢ä¸€ä¸ªå¸ƒå°”å€¼ã€‚æ³¨æ„ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä¸ä¼šåˆ›å»ºä¸€ä¸ªé¢„æœŸçš„ç»“æœçŠ¶æ€ã€‚å› ä¸ºæˆ‘ä»¬åªå¯¹ä¸€ä¸ªå¸ƒå°”å€¼æ„Ÿå…´è¶£ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹é‚£ä¸ªå€¼ï¼Œå¹¶ä½¿ç”¨ Jest çš„ toBeTruthy()å’Œ toBeFalsy()åŒ¹é…å™¨ã€‚å¦‚æœä½ ä¸ç†Ÿæ‚‰æ‰€æœ‰çš„åŒ¹é…å™¨ï¼Œ[è¿™é‡Œæœ‰ä¸€ä¸ªå¿«é€Ÿåˆ—è¡¨](https://jestjs.io/docs/en/expect)ä¾›å‚è€ƒã€‚

```
describe('LOAD_POSTS_REQUEST', () => {
  it('marks the current task as not loaded', () => {
    const start = {
        ...startState,
        posts_loading: false,
      }
    const action = actions.loadPostsRequest()
    const actual = reducer(start, action).posts_loading
    expect(actual).toBeTruthy()
  })
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#example-2-loadpostssuccess)ä¾‹ 2:åŠ è½½ _ å‘å¸ƒ _ æˆåŠŸ

è¿™é‡Œæˆ‘ä»¬å°†ç¼–å†™ä¸¤ä¸ªæµ‹è¯•:ä¸€ä¸ªç¡®è®¤æˆ‘ä»¬å°†æ–‡ç« åŠ è½½åˆ°çŠ¶æ€ï¼Œå¦ä¸€ä¸ªç¡®è®¤æˆ‘ä»¬å·²ç»æ ‡è®°æ–‡ç« ä¸å†å¤„äºåŠ è½½çŠ¶æ€ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸€äº›è®¾ç½®ä»£ç ç§»åˆ° before å‡½æ•°ä¸­ã€‚

```
describe('LOAD_POSTS_SUCCESS', () => {
  let actual
  let expected
  beforeEach(() => {
    const start = {
      ...startState,
      posts: [],
      posts_loading: true
    }
    expected = ['some', 'posts']
    const action = actions.loadPostsSuccess(expected)
    actual = reducer(start, action)
  })
  it('marks posts as loaded', () => {
    expect(actual.posts_loading).toBeFalsy()
  })
  it('saves posts in state', () => {
    expect(actual.posts).toEqual(expected)
  })
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#example-3-loadpostsfailure)ä¾‹ 3:LOAD _ post _ FAILURE

ç±»ä¼¼äºæˆ‘ä»¬çš„ thunk ç¤ºä¾‹ï¼Œæˆ‘ä»¬çš„å¤±è´¥ç”¨ä¾‹çœ‹èµ·æ¥ç±»ä¼¼äºæˆ‘ä»¬çš„æˆåŠŸç”¨ä¾‹ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå½»åº•ä¸€ç‚¹è¿˜æ˜¯å¥½çš„ã€‚æ²¡æœ‰ä»€ä¹ˆæ¯”æœŸå¾…æœ‰ç”¨çš„é”™è¯¯ä¿¡æ¯å´ä»€ä¹ˆä¹Ÿæ²¡æ‰¾åˆ°æ›´ä»¤äººæ²®ä¸§çš„äº†ã€‚

```
describe('LOAD_POSTS_FAILURE', () => {
  let actual
  let expected
  beforeEach(() => {
    const start = {
      ...startState,
      posts_error: null,
      posts_loading: true
    }
    expected = 'Posts not found!'
    const action = actions.loadPostsFailure(expected)
    actual = reducer(start, action)
  })
  it('marks posts as loaded', () => {
    expect(actual.posts_loading).toBeFalsy()
  })
  it('saves posts error in state', () => {
    expect(actual.posts_error).toEqual(expected)
  })
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## å°†æ­¤åº”ç”¨åˆ°æ‚¨çš„ä»£ç åº“

å¦‚æœæ‚¨çš„ reducer æ›´æ–°çŠ¶æ€çš„æ–¹å¼æœ‰é”™è¯¯ï¼Œé‚£ä¹ˆè°ƒè¯•ä¼šå¾ˆå›°éš¾ã€‚è™½ç„¶ Redux DevTools æœ‰æ‰€å¸®åŠ©ï¼Œä½†æ˜¯å¦‚æœè¿™äº› bug ä»æ¥æ²¡æœ‰å‡ºç°åœ¨æµè§ˆå™¨ä¸­ä¸æ˜¯æ›´å¥½å—ï¼Ÿä¸ºäº†å¸®åŠ©é˜²æ­¢å®ƒä»¬é€ƒè„±ï¼Œè¯·ç¡®ä¿æ‚¨çš„å‡é€Ÿå™¨ç»è¿‡å½»åº•æµ‹è¯•ã€‚è¯¥æ¨¡å¼å¯ä»¥å¾ˆå®¹æ˜“åœ°è°ƒæ•´åˆ°å…¶ä»–å¸¸è§çš„å‡é€Ÿå™¨ç”¨ä¾‹:

*   ä½ çš„å‡é€Ÿå™¨ä¸­æœ‰æ¡ä»¶é€»è¾‘å—ï¼Ÿä¸ºæ¯ä¸ªé€»è¾‘åˆ†æ”¯ç¼–å†™ä¸€ä¸ªæµ‹è¯•ã€‚
*   å¯¹æ‚¨çš„å‡é€Ÿå™¨è¿›è¡ŒéªŒè¯ï¼ŸæŠ›å‡ºæœ‰æ•ˆå’Œæ— æ•ˆçš„åŠ¨ä½œï¼Œä»¥ç¡®ä¿å®ƒæ­£ç¡®å¤„ç†è¿™ä¸¤ç§æƒ…å†µã€‚
*   åœ¨æ‚¨çš„ reducer ä¸­è½¬æ¢æ•°æ®ï¼Ÿè°ƒæ•´é¢„æœŸçš„è°ƒç”¨ï¼Œä»¥ç¡®ä¿æ•°æ®æŒ‰ç…§æ‚¨æƒ³è¦çš„æ–¹å¼è¾“å‡ºã€‚

ä»ç„¶æœ‰ä¸€ä¸ªç‰¹åˆ«çš„è¡ŒåŠ¨è®©ä½ æ„Ÿåˆ°å›°éš¾ï¼Ÿè¿™å¯èƒ½æ˜¯ä¸€ä¸ªè¿¹è±¡ï¼Œè¡¨æ˜æ‚¨æœ‰ä¸€ä¸ªæ··ä¹±æˆ–è¿‡äºå¤æ‚çš„åŠ¨ä½œæˆ–çŠ¶æ€å½¢çŠ¶ï¼Œä¸€äº›é‡æ„å¯èƒ½æ˜¯æœ‰åºçš„ã€‚

*(æƒ³è¦æ›´å¤šåƒè¿™æ ·å¯æ“ä½œçš„ç¼–ç å’ŒèŒä¸šå»ºè®®ï¼Ÿä½ ä¼šåœ¨[å‘¨äºŒè„‰æ](https://glennstovall.com/newsletter)æ‰¾åˆ°å®ƒã€‚)*