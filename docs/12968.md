# Javascript Underdogs:ç¬¬ 1 éƒ¨åˆ† WeakMap

> åŸæ–‡ https://dev.to/kepta/javascript-underdogs-part-1-the-weak map-4jih

ä½ å¥½ 2018ï¼è·ç¦»æˆ‘ä»¬ç¬¬ä¸€æ¬¡çœ‹åˆ° Javascript 2015(åˆå ES6)å·²ç»è¿‡å» 3 å¹´äº†ã€‚åœ¨è¿™æ®µæ—¶é—´é‡Œï¼Œæˆ‘ä»¬å¤§å¤šæ•°äººéƒ½ä¸“æ³¨äºå¤–è§‚ä¸Šçš„å˜åŒ–ï¼Œæ¯”å¦‚ Arrow `=>`å‡½æ•°æˆ–è€…èŠ±å“¨çš„ææ„æ“ä½œç¬¦`â€¦`ã€‚

[![gif1](../Images/cb40445c98c09035a507155a825dc311.png)T2ã€‘](https://i.giphy.com/media/xTiTnEHBh7qapyuvwQ/giphy.gif)

æ¯ä¸ªäººéƒ½éœ€è¦ä¸€äº›ä»¤äººå…´å¥‹çš„ä¸œè¥¿ï¼Œæ¯”å¦‚å³å°†åˆ°æ¥çš„å¥‡ç‰¹çš„ç®¡é“æ“ä½œå‘˜ã€‚è°åœ¨ä¹ ES6 æ˜¯ä¸æ˜¯ä¹ŸåŠ äº†`WeakMap`ã€`WeakSet`ã€`Iterables`ã€`Map`æˆ–è€…`Set`ä¹‹ç±»çš„ä¸œè¥¿ã€‚ç”šè‡³çœ‹ç€è¿™ä¸ªå«`WeakMap`çš„ä¸œè¥¿ï¼Œéƒ½è§‰å¾—å¥½å‹æŠ‘ğŸ˜ã€‚

æ’‡å¼€è®½åˆºä¸è°ˆï¼Œè®©æˆ‘ä»¬æ¥è°ˆè°ˆ`WeakMaps`ğŸ’ƒã€‚

## [](#why-you-would-need-something-weak)ä¸ºä»€ä¹ˆä½ ä¼šéœ€è¦ä¸€äº›è™šå¼±çš„ä¸œè¥¿

æˆ‘ä¸å¾—ä¸åŒæ„`WeakMap`è¿™ä¸ªåå­—ç»å¯¹æ˜¯ç”¨è¯ä¸å½“ã€‚å¦‚æœæ˜¯æˆ‘ï¼Œæˆ‘ä¼šæŠŠå®ƒå‘½åä¸ºè¶…çº§åœ°å›¾ã€‚åœ¨æˆ‘ä»¬è¿›å…¥å®šä¹‰ä¹‹å‰ï¼Œè®©æˆ‘ä»¬èŠ±ç‚¹æ—¶é—´æ¥ç†è§£ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„åº”ç”¨ä¸­éœ€è¦`WeakMap`ã€‚

æƒ³è±¡ç°åœ¨æ˜¯ 1990 å¹´ğŸ¡ä½ åˆ›å»ºäº†ä¸€ä¸ªæ‰€æœ‰å›½å®¶çš„åº”ç”¨ç¨‹åºğŸŒå½“æ—¶åœ¨åœºçš„ã€‚

```
var USSR = {
  name: 'Soviet Union',
  capital: 'Moscow',
  ..
  ..
}

var countries = [ Afganishtan, Albania, Algeria, ..., USSR, ..., Zimbabwe ] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”¨æˆ·å¯ä»¥ç‚¹å‡»ä»»ä½•å›½å®¶ï¼Œå¹¶è·å¾—è¯¦ç»†ä¿¡æ¯ï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬è¯¥å›½çš„åœ°åŒºã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå‡è®¾çš„é¢ç§¯è®¡ç®—å‡½æ•°ã€‚

```
async function calcArea(country) {
  const boundaries = await fetch(country);

  area = calculateArea(country, boundaries); // takes a long time

  return area;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#caching-the-area)ç¼“å­˜åŒºåŸŸ

æ¯å½“ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªå›½å®¶ï¼Œä½ å°±è®¡ç®—è¿™ä¸ªå›½å®¶çš„é¢ç§¯ã€‚ä½†æ˜¯æˆ‘ä»¬æœ‰ä¸€ä¸ªé—®é¢˜ï¼å¦‚æœç”¨æˆ·å¤šæ¬¡ç‚¹å‡»ä¸€ä¸ªå›½å®¶ï¼Œä½ å¿…é¡»é‡å¤è¿™ä¸ªå·¨å¤§çš„å¼‚æ­¥è®¡ç®—ï¼Œè¿™æ˜¯æˆ‘ä»¬åº”è¯¥å®Œå…¨é¿å…çš„ã€‚è§£å†³è¿™ç±»é—®é¢˜ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ã€‚

1.  å»æŠ–åŠŸèƒ½
2.  ç¼“å­˜è¯¥å‡½æ•°

å»æŠ–æ˜¯ä¸€ç§åœ¨çŸ­æ—¶é—´å†…å¹³æ¯å¤šæ¬¡æ”»å‡»æ€§è¡Œä¸ºçš„å’Œå¹³æ–¹å¼ã€‚(*æƒ³è±¡ä¸€ä¸ªä¸è€çƒ¦çš„ç”¨æˆ·å¤šæ¬¡ç‚¹å‡»åˆ·æ–°æŒ‰é’®*)ã€‚å»æŠ–åŠ¨å…è®¸æˆ‘ä»¬åªå–æœ€åä¸€æ¬¡è°ƒç”¨ï¼Œè€Œä¸¢å¼ƒå…¶ä½™çš„è°ƒç”¨ã€‚

ç”±äºå›½å®¶ä¸ç»å¸¸æ”¹å˜é¢ç§¯ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°ç¼“å­˜`calcArea`çš„ç»“æœã€‚

æˆ‘ä»¬å¯ä»¥åŒæ—¶ä½¿ç”¨**ç¼“å­˜**å’Œ**å»æŠ–åŠ¨**æ¥æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªé€šç”¨çš„ç¼“å­˜å‡½æ•°ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥ç¼“å­˜`calcArea`ã€‚

```
function cachify(fn) {
  // its a good idea to hide you cache inside the closure
  var cache = new Map();
  return arg => {
    if (cache.has(arg)) {
      return cache.get(arg);
    }
    var computed = fn(arg);
    cache.set(arg, computed);
    return computed;
  };
}

cachedCalcArea = cachify(calcArea);

cachedCalcArea(USSR); // goes and computes the area
cachedCalcArea(USSR); // already computed, returns the cached area 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#great-we-made-some-serious-performance-improvements)å¤ªæ£’äº†ï¼æˆ‘ä»¬åšäº†ä¸€äº›é‡å¤§çš„æ€§èƒ½æ”¹è¿›ã€‚

ä½†æ˜¯æˆ‘ä»¬æœ‰å¦ä¸€ä¸ªé—®é¢˜ï¼Œ`USSR`åˆšåˆšé—¯å…¥ 15 ä¸ªæ–°å›½å®¶ã€‚è¿™å°†æ„å‘³ç€æˆ‘ä»¬ç§»é™¤è‹è”ï¼Œå¹¶å°†æ–°æˆç«‹çš„å›½å®¶åŠ å…¥æˆ‘ä»¬çš„`countries`é˜µåˆ—ã€‚

```
countries.remove(USSR);
// add the new countries
countries.add([Armenia, Azerbaijan, ...., Uzbekistan]); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»…ä»…ä»æ•°ç»„ä¸­åˆ é™¤`USSR`æ²¡æœ‰å¸®åŠ©ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç¼“å­˜ä»ç„¶åŒ…å«`USSR`å’Œè®¡ç®—åŒºåŸŸã€‚ä¸€ä¸ªå¤©çœŸçš„è§£å†³æ–¹æ¡ˆæ˜¯ä¿®æ”¹æˆ‘ä»¬çš„`cachify`åŠŸèƒ½æ¥ç§»é™¤è‹è”ï¼Œä½†æ˜¯å¦‚æœä¸–ç•Œç»§ç»­åˆ†è£‚æˆæ›´å°çš„å›½å®¶ï¼Œæˆ‘ä»¬å°±ä¼šæœ‰ä¸€ä¸ªå†…å­˜æ³„æ¼ã€‚

æˆ‘ä»¬éœ€è¦ä¸€ç§æ™ºèƒ½çš„æ–¹æ³•æ¥æ¸…ç†æˆ‘ä»¬çš„ç¼“å­˜ï¼Œè¿™ç§æ–¹æ³•å¯ä»¥å¾ˆå¥½åœ°æ‰©å±•ã€‚å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è§£å†³è¿™ä¸ªé—®é¢˜:

1.  ç»´æŠ¤ä¸€ä¸ª**é¢„è®¡ç®—åŒºåŸŸæ•°ç»„**å¹¶ä¿æŒä¸å›½å®¶åŒæ­¥ã€‚
2.  æ‰¾å‡ºä¸€äº›**æ™ºèƒ½ç¼“å­˜é©±é€**åƒ LRUï¼ŒåŸºäºæ—¶é—´çš„ï¼Œç­‰ç­‰ã€‚

é¢„è®¡ç®—æ¯ä¸ªå›½å®¶çš„é¢ç§¯ä¼¼ä¹æ˜¯æµªè´¹è®¡ç®—ï¼Œå› ä¸ºå¤§å¤šæ•°ç”¨æˆ·ä¸ä¼šçœ‹åˆ°æ¯ä¸ªå›½å®¶ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ™ºèƒ½ç¼“å­˜ç­–ç•¥ï¼Œå¦‚[æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç¼“å­˜](https://chrisrng.svbtle.com/lru-cache-in-javascript)ï¼Œè¿™ç§ç¼“å­˜ä¼šè‡ªåŠ¨åˆ é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ¡ç›®ã€‚ä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰ç”¨å®Œ 160 å¤šä¸ªå›½å®¶çš„å†…å­˜ï¼ŒLRU çœ‹èµ·æ¥ä¹Ÿæ²¡æœ‰é‚£ä¹ˆç¥å¥‡å’Œå®Œç¾ã€‚

## weak map å‘¢ï¼Ÿ

[![wmap](../Images/d8344a70775d40a2ede3efba9a659254.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--US_5Q70E--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/6966254/38578957-73f8d2e4-3cd3-11e8-9b63-e0a4a2e7a73a.png)

æ˜¯æˆ‘ä»¬ç¼“å­˜é—®é¢˜ä¸­ç¼ºå¤±çš„æ‹¼å›¾ã€‚å®ƒä¼šè‡ªåŠ¨ç§»é™¤*å…¶ä¸­ä»»ä½•æœªä½¿ç”¨çš„å¼•ç”¨ã€‚

"***weak map**å¯¹è±¡æ˜¯é”®/å€¼å¯¹çš„é›†åˆï¼Œå…¶ä¸­çš„é”®æ˜¯å¼±å¼•ç”¨çš„ã€‚é”®å¿…é¡»æ˜¯å¯¹è±¡ï¼Œå€¼å¯ä»¥æ˜¯ä»»æ„å€¼ã€‚*â€”â€”[MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap)

æˆ‘å–œæ¬¢è¯´ WeakMap åªä¸è¿‡æ˜¯ä¸€å¼ æ™®é€šçš„ç—´å‘†åœ°å›¾ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å®½å®¹çš„æ•°æ®ç»“æ„ï¼Œå®ƒä¼šå¿˜è®°é‚£äº›ä¸å†é‡è¦çš„äº‹æƒ…ã€‚*(æˆ‘ä»¬ä¹Ÿåº”è¯¥é‚£æ ·:P)*

æˆ‘ä»¬å¯ä»¥ç®€å•åœ°åœ¨ç¼“å­˜å‡½æ•°ä¸­ç”¨`WeakMap`æ›¿æ¢`Map`ã€‚

```
function weakCache(fn) {
  var cache = new WeakMap(); // <-- Behold the Weak!
  return (arg) => {
    if (cache.has(arg)) {
      return cache.get(arg);
    }
    var computed = fn(arg);
    cache.set(arg, computed);
    return computed;
  }
}
cachedCalcArea = weakCache(calcArea);

cachedCalcArea(USSR); // cache miss
cachedCalcArea(USSR); // cache hit 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨è®©`USSR`æ‰“å…¥ 15 ä¸ªå›½å®¶ã€‚æˆ‘ä»¬åªéœ€è¦ç§»é™¤åº”ç”¨ç¨‹åºä¸­æŒ‡å‘`USSR` obj çš„æ‰€æœ‰å¼•ç”¨ï¼Œæˆ‘ä»¬çš„`cachedCalcArea`å‡½æ•°å°±ä¼šè‡ªåŠ¨å¿˜è®°ç¼“å­˜ä¸­çš„`USSR`æ¡ç›®ã€‚å› æ­¤ï¼Œé¿å…äº†å†…å­˜æ³„æ¼ï¼

### [](#how-does-it-forget-things)å®ƒæ˜¯å¦‚ä½•å¿˜è®°äº‹æƒ…çš„ï¼Ÿ

`WeakMap`çš„å·¥ä½œæ–¹å¼ç±»ä¼¼äºå¸¸è§„çš„`Map`ï¼Œä½†æ˜¯ä¸ºäº†æˆä¸ºä¸€ä¸ªå¥å¿˜çš„åœ°å›¾ç‰ˆæœ¬ï¼Œå®ƒæ–½åŠ äº†ä»¥ä¸‹é™åˆ¶:

*   **ä¸å…è®¸åŸå§‹æ•°æ®**ç±»å‹é”®(æ•°å­—ã€å­—ç¬¦ä¸²ã€ç©ºã€çœŸç­‰)
*   æ‚¨ä¸èƒ½**åˆ—å‡º WeakMap ä¸­çš„æ‰€æœ‰å€¼**

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ª WeakMap çš„å‡è®¾ä¾‹å­

*   æƒ³è±¡ä¸€ä¸ªå®ä¾‹æ˜¯ä¸€åº§æ‹¥æœ‰æ•°åƒä¸ªğŸšªé—¨ã€‚

```
 var building = new WeakMap(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*   æ¯æ‰‡é—¨éƒ½æœ‰ä¸€æŠŠç‹¬ä¸€æ— äºŒçš„é’¥åŒ™ï¼Œæˆ‘ä»¬ä¹Ÿæœ‰ä¸€æŠŠé’¥åŒ™ğŸ”‘ä¸ºäº†æˆ‘ä»¬çš„`ğŸšª101`ã€‚ç”±äºä¸Šé¢æåˆ°çš„çº¦æŸï¼Œå¯†é’¥åªèƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚

```
 var key = {
    password: 'ğŸ”‘'
  }; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*   æˆ‘ä»¬å¯ä»¥ç”¨è¿™æŠŠé’¥åŒ™é”é—¨ã€‚

```
 building.set(key, 'ğŸšª101');

  building.get(key); // ğŸšª101 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*   ç°åœ¨ä¸€ä¸ªå°å·çœ‹åˆ°äº†æˆ‘ä»¬çš„é’¥åŒ™*(å®ƒçš„ Javascript å’„ï¼å¹¶ä¸”ä»–è¯•å›¾ä¼ªé€ ä¸€æŠŠå¤åˆ¶çš„é’¥åŒ™ã€‚*

```
 var fake_key = {
    password: 'ğŸ”‘'
  }; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*   å› ä¸ºæˆ‘ä»¬ç”Ÿæ´»åœ¨ä¸€ä¸ª Javascript ä¸–ç•Œä¸­ï¼Œæˆ‘ä»¬æ¸…æ¥šåœ°çŸ¥é“å³ä½¿å®ƒä»¬çœ‹èµ·æ¥ä¸€æ ·ï¼Œä½†å®ƒä»¬ä¸æ˜¯`equal`ã€‚

```
 fake_key === key // false 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*   æˆ‘ä»¬çš„å°å·æ²¡æœ‰è¯»è¿™ç¯‡å¾ˆæ£’çš„æ–‡ç« ï¼Œä»–è¯•å›¾ç”¨ä»–çš„å‡é’¥åŒ™è¿›å…¥æˆ‘ä»¬çš„å¤§æ¥¼ï¼Œç»“æœå¤±è´¥äº†ã€‚

```
 building.get(fake_key); // undefined 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### å¦‚æœæˆ‘ä»¬ä¸¢å¤±äº†é’¥åŒ™ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆ

åªè¦æŸä¸ªå˜é‡ä¿å­˜äº†å¯¹åŸå§‹å¯†é’¥çš„å¼•ç”¨ï¼Œæˆ‘ä»¬å°±æ˜¯å®‰å…¨çš„ã€‚ä½†æ˜¯å¦‚æœæœ‰ä¸€å¤©ï¼Œæ•´ä¸ªåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰å˜é‡æŒæœ‰å¯¹æˆ‘ä»¬çš„é”®çš„å¼•ç”¨ï¼Œæˆ‘ä»¬å°±å¤±å»äº†å¯¹æˆ‘ä»¬çš„`ğŸšª101`çš„è®¿é—®ã€‚

è¿™æ­£æ˜¯é©±åŠ¨`WeakMap`æ™ºèƒ½ç¼“å­˜çš„åŸå› ã€‚å¦‚æœæˆ‘ä»¬ä¸¢å¤±äº†å¯†é’¥ï¼ŒGC å¯ä»¥æ¨æ–­å‡ºæ²¡æœ‰åŠæ³•è®¿é—®ä¸å¯†é’¥ç›¸å…³çš„ä¸œè¥¿ï¼Œå®ƒå¯ä»¥å®‰å…¨åœ°ä»å†…å­˜ä¸­åˆ é™¤å®ƒã€‚

*æ³¨:è¿™æ˜¯`WeakMap`å’Œ`Map`çš„å…³é”®åŒºåˆ«ã€‚`WeakMap`ç§»é™¤`<key,value>`å¦‚æœä½ ä¸¢å¤±äº†é’¥åŒ™ï¼Œä½†æ˜¯åœ¨åœ°å›¾ä¸­ï¼Œä½ å¯ä»¥ç®€å•åœ°åˆ—å‡ºæ‰€æœ‰çš„é’¥åŒ™æ¥æ‰¾åˆ°ä¸¢å¤±çš„é’¥åŒ™ã€‚*

å›åˆ°è‹è”çš„é—®é¢˜ï¼Œå½“è‹è”åˆ†è£‚æˆ 15 ä¸ªå›½å®¶ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­åˆ é™¤æ‰€æœ‰å¯¹è‹è”å¯¹è±¡çš„å¼•ç”¨ã€‚

```
countries.remove(USSR); // remove from array

USSR = undefined; // unset the variable

// at this point there is no way to get the cached area of USSR since it doesn't exist anymore 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œåœ¨ä¸Šè¿°æ­¥éª¤ä¹‹åï¼Œåœ¨ app çš„å½“å‰çŠ¶æ€ä¸‹æ²¡æœ‰åŠæ³•è®¿é—® USSR å¯¹è±¡ï¼Œå› æ­¤ Javascript åƒåœ¾æ”¶é›†å™¨ä¼šè‡ªåŠ¨æ¸…é™¤å®ƒä¸º USSR åŒºåŸŸä¿ç•™çš„å†…å­˜ã€‚è¯·æ³¨æ„ï¼Œåˆ é™¤æ˜¯åœ¨å¹•åè¿›è¡Œçš„ï¼Œæˆ‘ä»¬æ‰€åšçš„åªæ˜¯ç”¨`WeakMap`æ›¿æ¢äº†`Map`ã€‚æ˜¯ä¸æ˜¯å¾ˆå‰å®³ï¼Ÿ

## [](#weakmap-takeaways)WeakMap å¤–å–

*   è®°ä½**ä¸è¦æ”¹å˜é”®**å¯¹è±¡ï¼Œå› ä¸ºåœ¨ Javascript ä¸­ï¼Œå³ä½¿ä½ æ”¹å˜äº†å¯¹è±¡ï¼Œå¯¹è±¡å¼•ç”¨ä¹Ÿä¿æŒä¸å˜ã€‚

```
var obj = {name: 'ğŸ•'};
weakMap.set(obj, 'animal');

obj.name = 'ğŸ™â€â™‚ï¸';
weakMap.get(obj); // 'animal' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*   WeakMap ä¸èƒ½æ¥å—åŸå§‹çš„ javascript å€¼ä½œä¸ºé”®ã€‚å¦‚æœä½ æƒ³ç”¨å®ƒä»¬ä½œä¸ºä½ çš„é’¥åŒ™ï¼Œä½ åº”è¯¥ç”¨`Map`ã€‚

```
weakMap.set('key', 'value'); // Error! 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*   æœ‰æ—¶ä¸ç¼“å­˜å‡½æ•°ä¼šæ›´å¿«ã€‚å¦‚æœä½ çš„å‡½æ•°æ‰§è¡Œèµ·æ¥åªéœ€è¦ä¸€æ¯«ç§’ï¼Œé‚£ä¹ˆä½ æœ€ç»ˆä¼šå› ä¸ºç¼“å­˜è€Œå‡æ…¢å®ƒçš„é€Ÿåº¦ã€‚
*   ä½ å¯ä»¥ç”¨ä»»ä½•ä¸œè¥¿ä½œä¸º`WeakMap` / `Map`çš„`value`ã€‚æ˜¯çš„ï¼Œç”šè‡³æ‰¿è¯ºï¼
*   æœªä½¿ç”¨çš„é”®**çš„é©±é€ä¸ä¼šç«‹å³å‘ç”Ÿ**ã€‚çœ‹æ”¶åƒåœ¾çš„å¿ƒæƒ…äº†ã€‚ä¸è¿‡ä½ ä¸åº”è¯¥æ‹…å¿ƒè¿™éƒ¨åˆ†ã€‚
*   WeakMap éå¸¸é€‚åˆæ´¾ç”ŸçŠ¶æ€ã€‚å¾ˆå¤šæ—¶å€™ï¼Œä½ çš„åº”ç”¨ç¨‹åºçš„çŠ¶æ€å¯ä»¥ç®€å•åœ°ä»å…¶ä»–çŠ¶æ€ä¸­æ´¾ç”Ÿå‡ºæ¥ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ä½¿ç”¨ç¼“å­˜å‡½æ•°æ´¾ç”Ÿä¸€ä¸ªå€¼æ›´å®¹æ˜“ç»´æŠ¤ï¼Œä¹Ÿæ›´å®¹æ˜“æ¨ç†ã€‚

```
var user = {
    name: "Kushan Joshi"
}

var websites = ['Facebook', 'Github', 'Twitter', 'Dev.to', 'Medium'];

var memberOf = (user) => websites.filter(website => isUser(user));

// save the websites and keep track of it, too complicated ğŸ¤® !
user.memberOf = memberOf(user);

// deriving the value using weakMaps, awesomo ğŸ¤–!
cachedMemberOf = weakCache(memberOf); // avoid recomputing everytime
// or derive it everytime you need it
console.log(cachedMemberOf(user)); 
render(cachedMemberOf(user)) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘çœŸçš„å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ ç†è§£`WeakMaps`ã€‚æˆ‘å–œæ¬¢å°†å®ƒä¸åƒ`Immutable.js`æˆ–`Redux`è¿™æ ·çš„åº“ä¸€èµ·ä½¿ç”¨ï¼Œå› ä¸ºå®ƒä»¬å¢å¼ºäº†ä¸å˜æ€§ã€‚å³ä½¿ä½ ä¸ä½¿ç”¨è¿™äº›åº“ï¼Œåªè¦ä½ ä¸æ”¹å˜å¯¹è±¡ï¼Œä½ å°±å¯ä»¥ä» WeakMap ä¸­è·ç›Šã€‚

æˆ‘æ­£è®¡åˆ’å†™ä¸€ç¯‡å…³äº Javascript å¤±è´¥è€…çš„æ–‡ç« ï¼Œè¯·åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘ä½ è®¤ä¸ºå“ªäº› Javascript ç‰¹æ€§å¾ˆæ£’ï¼Œä½†æ²¡æœ‰å¾—åˆ°å……åˆ†çš„è¯„ä»·ã€‚

å¦‚æœä½ â¤ï¸è¿™ç¯‡æ–‡ç« ï¼Œè¯·åˆ†äº«è¿™ç¯‡æ–‡ç« ä¼ æ’­çš„è¯ã€‚

åœ¨ Twitter ä¸Šè”ç³»æˆ‘ [@kushan2020](https://twitter.com/kushan2020) ã€‚