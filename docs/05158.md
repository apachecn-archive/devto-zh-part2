# å¯ç ´åè½¬ç§»æ¨¡å¼

> åŸæ–‡:[https://dev.to/rzadp/destructible-transfer-pattern-g5b](https://dev.to/rzadp/destructible-transfer-pattern-g5b)

å¦‚æœä½ åƒæˆ‘ä¸€æ ·æ˜¯ä¸€ä¸ª Solidity å¼€å‘äººå‘˜ï¼Œé‚£ä¹ˆ**é€€å‡ºå¥‘çº¦**æ¨¡å¼å¯èƒ½æ˜¯ä½ å­¦ä¹ çš„ç¬¬ä¸€ä¸ª[é€šç”¨æ¨¡å¼](https://solidity.readthedocs.io/en/v0.4.24/common-patterns.html)ä¹‹ä¸€ã€‚å®ƒå¯ä»¥ä¿æŠ¤æ‚¨çš„åˆåŒåœ¨å‘å¦ä¸€ä¸ªåœ°å€æ±‡æ¬¾æ—¶ä¸ä¼šå¤±è´¥ã€‚ç„¶è€Œï¼Œä»£ä»·æ˜¯å¼•å…¥äº†é¢å¤–çš„æ­¥éª¤ï¼Œè¿™å¢åŠ äº†å¤æ‚æ€§ï¼Œå¹¶ä¸”ä¼šå¹²æ‰°è‡ªåŠ¨åŒ–è¿‡ç¨‹ã€‚

â˜ï¸å¦‚æœä½ ä¸ç†Ÿæ‚‰**é€€å‡ºåˆåŒ**çš„æ¨¡å¼ï¼Œè¯·ç»§ç»­é˜…è¯»ã€‚å¦åˆ™ï¼Œä½ å¯ä»¥è·³åˆ°**å¯ç ´åè½¬ç§»**æ¨¡å¼éƒ¨åˆ†ã€‚

## æ¡ˆä¾‹åˆ†æ-å·¥èµ„ç³»ç»Ÿ

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªè‡ªåŠ¨å·¥èµ„ç³»ç»Ÿï¼Œé€šè¿‡ä»¥å¤ªç½‘è¿›è¡Œæ”¯ä»˜ã€‚æ‰€æœ‰å›°éš¾çš„éƒ¨åˆ†éƒ½å®Œæˆäº†â€”â€”å‰©ä¸‹å”¯ä¸€è¦åšçš„å°±æ˜¯ç¼–å†™ä¸€ä¸ªæ™ºèƒ½å¥‘çº¦ï¼Œé€šè¿‡å‘å‡ºä¸€ä¸ªäº‹ä»¶æ¥å¤„ç†å’Œè®°å½•ä»¥å¤ªåŠåŒºå—é“¾ä¸Šçš„æ¯ä¸€ç¬”æ”¯ä»˜ã€‚è¿™æ˜¯ä½ çš„åˆç¨¿:

```
contract NaivePayroll {
    event Paid(address account, uint amount);

    function pay(address account) public payable {
        require(account.send(msg.value));
        emit Paid(account, msg.value);
    }
} 
```

Enter fullscreen mode Exit fullscreen mode

### å®‰å…¨é£é™©

ä¸Šé¢çš„åˆåŒè¢«å‘½åä¸º`NaivePayroll`æ˜¯æœ‰åŸå› çš„â€”â€”å®ƒå¤©çœŸåœ°å‡è®¾æ¥æ”¶åœ°å€è¦ä¹ˆæ˜¯ä¸€ä¸ªé’±åŒ…ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªä¸ä¼šåšä»»ä½•æ€ªå¼‚äº‹æƒ…çš„åˆåŒã€‚è€ƒè™‘ä»¥ä¸‹åˆåŒ:

```
contract MaliciousReceiver {
    function() public payable {
        revert();
    }
} 
```

Enter fullscreen mode Exit fullscreen mode

æœªå‘½åçš„å‡½æ•°æ˜¯ä¸€ä¸ª[åå¤‡å‡½æ•°](https://solidity.readthedocs.io/en/v0.4.24/contracts.html?#fallback-function)â€”â€”æ¯å½“æœ‰ä»¥å¤ªç½‘è½¬ç§»åˆ°è¿™ä¸ªå¥‘çº¦æ—¶ï¼Œå®ƒå°±è¢«æ‰§è¡Œã€‚

ğŸ’¥å¦‚æœ`MaliciousReceiver`åœ¨å·¥èµ„å•ä¸Šï¼Œæ‚¨çš„è‡ªåŠ¨åŒ–ç³»ç»Ÿå°†å‘åŒºå—é“¾å‘é€å¤±è´¥çš„äº¤æ˜“ã€‚

### è§£

ä½ è®¾è®¡çš„è‡ªåŠ¨åŒ–ç³»ç»Ÿè¦ä¹ˆè·³è¿‡è¿™äº›è´¦æˆ·ï¼Œè¦ä¹ˆä¼˜é›…åœ°å¤„ç†å¤±è´¥çš„äº¤æ˜“ã€‚ç„¶è€Œï¼Œè¿™è¿˜ä¸å¤Ÿâ€”â€”å¿…é¡»åœ¨åŒºå—é“¾ä¸Šè®°å½•æ”¯ä»˜æ„å‘ï¼Œå¹¶ä¸”èµ„é‡‘å¿…é¡»ç¦»å¼€è‡ªåŠ¨åŒ–ç³»ç»Ÿçš„è´¦æˆ·ã€‚

è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆ:

*   é€€å‡ºåˆåŒæ¨¡å¼
*   å¯ç ´åè½¬ç§»æ¨¡å¼

* * *

## é€€å‡ºåˆçº¦æ¨¡å¼

æ‚¨å¯ä»¥ä½¿ç”¨**é€€å‡ºåˆåŒ**æ¨¡å¼å¿«é€Ÿæ›´æ”¹æ‚¨çš„`NaivePayroll`ã€‚è¿™æ˜¯ä½ çš„ä»£ç :

```
contract BrokePayroll {
    mapping(address => uint) pending;
    event PayAdded(address account, uint amount);
    event PayWithdrawed(address account, uint amount);

    function pay(address account) public payable {
        pending[account] = pending[account] + msg.value;
        emit PayAdded(account, msg.value);
    }

    function withdrawPay() public {
        require(msg.sender.send(pending[msg.sender]));
        emit PayWithdrawed(msg.sender, pending[msg.sender]);
        pending[msg.sender] = 0;
    }
} 
```

Enter fullscreen mode Exit fullscreen mode

### å®‰å…¨é£é™©

è¿˜æ˜¯é‚£å¥è¯ï¼ŒåˆåŒçš„åå­—ä¸æ˜¯æ²¡æœ‰é“ç†çš„ã€‚è€ƒè™‘ä»¥ä¸‹åˆåŒ:

```
contract GreedyReceiver {
    function getPaid(address _payroll) public {
        Payroll payroll = Payroll(_payroll);
        payroll.withdrawPay();
    }

    function() public payable {
        if (msg.sender.balance >= msg.value) {
            this.getPaid(msg.sender);
        }
    }
} 
```

Enter fullscreen mode Exit fullscreen mode

ğŸ’¸å¦‚æœè´ªå©ªçš„æ¥å—è€…åœ¨å·¥èµ„å•ä¸Šï¼Œå®ƒå¯ä»¥æå–æ¯”é¢„æœŸæ›´å¤šçš„èµ„é‡‘ã€‚

`GreedyReceiver`çš„[å›é€€åŠŸèƒ½](https://solidity.readthedocs.io/en/v0.4.24/contracts.html?#fallback-function)ä¸€æ¬¡åˆä¸€æ¬¡åœ°å¯åŠ¨å–æ¬¾ï¼Œç›´åˆ°æ²¡æœ‰å‰©ä½™èµ„é‡‘ï¼Œä½ ç ´äº§ä¸ºæ­¢ã€‚

â˜ï¸æŠŠè¿™ä¸ªé—®é¢˜ç§°ä¸º**é‡å…¥**é—®é¢˜

### çº æ­£æ’¤å•æ¨¡å¼ç”¨æ³•

å¯é‡å…¥æ€§çš„è§£å†³æ–¹æ¡ˆç›¸å½“ç®€å•â€”â€”æ‚¨éœ€è¦åšçš„å°±æ˜¯åœ¨å‘é€èµ„é‡‘ä¹‹å‰ï¼Œé¦–å…ˆæ¸…é™¤æœªå†³çš„å–æ¬¾ã€‚

```
contract WithdrawalPatternPayroll {
    mapping(address => uint) pending;
    event PayAdded(address account, uint amount);
    event PayWithdrawed(address account, uint amount);

    function pay(address account) public payable {
        pending[account] = pending[account] + msg.value;
        emit PayAdded(account, msg.value);
    }

    function withdrawPay() public {
        uint value = pending[msg.sender];
        pending[msg.sender] = 0;
        msg.sender.send(value);
        emit PayWithdrawed(msg.sender, value);
    }
} 
```

Enter fullscreen mode Exit fullscreen mode

* * *

## å¯ç ´åçš„è½¬ç§»æ¨¡å¼

ä½¿ç”¨**æ’¤é”€åˆåŒ**æ¨¡å¼çš„æ›¿ä»£æ–¹æ¡ˆæ˜¯ä½¿ç”¨**å¯é”€æ¯è½¬ç§»**ã€‚
è¿™ä¸ªæ¨¡å¼çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªå°è€Œæœ‰è¶£çš„å¥‘çº¦:

```
contract DestructibleTransfer {
    constructor(address payee) public payable {
        selfdestruct(payee);
    }
} 
```

Enter fullscreen mode Exit fullscreen mode

`DestuctibleTransfer`åˆåŒå……å½“ç”¨äºè¿›è¡Œæ”¯ä»˜çš„ä¸­ä»‹åˆåŒã€‚æ„é€ æ—¶ï¼Œå®ƒç«‹å³è‡ªæ¯ï¼Œå¯¼è‡´å‰©ä½™èµ„é‡‘è¢«è½¬ç§»åˆ°ç»™å®šåœ°å€ã€‚
`DestuctibleTransferPayroll`åˆåŒçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:

```
contract DestuctibleTransferPayroll {
    event Paid(address account, uint amount);

    function pay(address account) public payable {
        (new DestructibleTransfer).value(msg.value)(account);
        emit Paid(account, msg.value);
    }
} 
```

Enter fullscreen mode Exit fullscreen mode

`DestuctibleTransferPayroll`åˆåŒä¸å®¹æ˜“å—åˆ°`MaliciousReceiver`å’Œ`GreedyReceiver`çš„æ”»å‡»ã€‚

### ä¸ºä»€ä¹ˆæœ‰æ•ˆ

ä»ææ„åå®šå‘èµ·çš„ä¼ è¾“ä¸æ‰§è¡Œæ¥æ”¶è€…çš„å›é€€å‡½æ•°ã€‚
å› æ­¤ï¼Œå›é€€åŠŸèƒ½ä»£ç ä¸­çš„å¤±è´¥æˆ–å¯é‡å…¥å¯¹äºæˆ‘ä»¬åˆ©ç”¨**å¯ç ´åè½¬ç§»**æ¨¡å¼çš„å·¥èµ„ç³»ç»Ÿæ¥è¯´æ˜¯ä¸åŒ¹é…çš„ã€‚

### ç¼ºç‚¹

å¯ç ´åè½¬ç§»æ¯”æ™®é€šè½¬ç§»æ¶ˆè€—æ›´å¤šçš„æ°”ä½“ã€‚ä¸ºäº†å‡å°‘æ°”ä½“çš„ä½¿ç”¨ï¼Œè€ƒè™‘ä»…åœ¨æ ‡å‡†ä¼ è¾“å¤±è´¥æ—¶ä½¿ç”¨å¯ç ´åä¼ è¾“ã€‚

```
contract SmartPayroll {
    event Paid(address account, uint amount);

    function pay(address account) public payable {
        if (!account.send(msg.value)) {
            (new DestructibleTransfer).value(msg.value)(account);
        }
        emit Paid(account, msg.value);
    }
} 
```

Enter fullscreen mode Exit fullscreen mode

## ç»“è®º

åœ¨æ™ºèƒ½å¥‘çº¦å¼€å‘ä¸­ï¼Œå®‰å…¨æ€§éå¸¸é‡è¦ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†ä»¥å¤ªå­˜å–æ—¶ã€‚æ¯ä¸€ä¸ªå®‰å…¨æ¼æ´éƒ½ç·æ±¡äº†ç¤¾åŒºå¯¹ä»¥å¤ªåŠåœ¨ç°å®ä¸–ç•Œä¸­çš„é€‚ç”¨æ€§çš„ä¿¡ä»»ã€‚

æˆ‘ç›¸ä¿¡å»ºç«‹å¯é çš„æ¨¡å¼å’Œæœ€ä½³å®è·µå°†æé«˜ä»¥å¤ªåŠåŒºå—é“¾æ™ºèƒ½åˆçº¦çš„æ€»ä½“è´¨é‡ï¼Œå¹¶å¸Œæœ›æˆ‘çš„è´¡çŒ®å°†æœ‰åŠ©äºå¼€å‘è€…æ»¡æ€€ä¿¡å¿ƒåœ°ç¼–å†™å®‰å…¨çš„æ™ºèƒ½åˆçº¦ã€‚