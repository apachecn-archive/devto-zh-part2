# 使用 AWS RDS 自动将生产数据库恢复到测试中

> 原文：<https://dev.to/goozenburger/automating-restoration-of-production-databases-into-test-using-aws-rds-56f4>

我最近一直在做一些自动化工作，定期将我们所有的实时数据库从 AWS RDS 恢复到副本中，用作测试环境。这包括一些数据清理，以删除敏感信息、真实电子邮件地址等，但允许在类似生产的环境中进行测试。

我们有 MS-SQL 和 Aurora MySql 数据库，我使用了 AWS APIs 来完成这项任务。在我的例子中，我使用了。Net APIs 并构建了一个控制台应用程序来调用它们。虽然这些 API 都有很好的文档记录，并且非常容易使用，但我仍然发现获得正确的调用组合需要一些时间。

首先，从快照恢复数据库的 API 调用将正确地拒绝覆盖现有的实例。但是，在这种情况下，我们希望每次恢复时覆盖现有环境。所以我不得不在我的应用中加入这一点。

首先，用目标实例的名称调用 **DescribeDBInstances** 。如果找到一个实例，那么调用 **DeleteDBInstance** 删除它。请注意，如果实例不存在，此调用将抛出 DBInstanceNotFoundException，因此您需要捕捉它并继续，因为这是一个完全有效的场景。

所有这些调用都需要注意的一点是，API 将在云中触发一个任务，而不是等待它完成。因此，您的数据库实例将以“删除”状态存在一段时间。我没有找到订阅事件的方法来告诉您何时完成，所以我实现了一些简单的轮询，每 2 分钟调用一次 DescribeDBInstances，直到实例不再存在。

一旦确定目标实例不存在，就可以调用**restoredbinstancefromdsnapshot**来进行恢复。这假设您有一个可用的快照，最好的办法是从动态数据库自动生成常规快照。您需要使用 **DescribeDBSnapshots** 找到源数据库的最新快照。按数据库实例名返回所有可用的实例，然后按日期降序排序以查找最新的实例。

同样，您需要等待恢复完成，因此我再次使用 DescribeDBInstances 进行了一些轮询，以等待目标实例存在，其状态为“可用”。

一旦您有了一个新恢复的数据库，您可能需要应用安全组，并且您可能想要更改主用户密码，因此 test 和 live 没有相同的凭证。这都可以通过使用 **ModifyDBInstance** 来实现。我发现的一个问题是，如果您需要随后连接到 DB 以完成进一步的任务，请确保将“ApplyImmediately”设置为 true。否则，AWS 将等待一个维护窗口来应用更改，这是您不希望的。

接下来，您可以应用一些数据清理或任何您想做的事情，将生产数据转换成测试就绪数据。为此，您可以使用您喜欢的任何方法简单地连接到数据库，并运行您的脚本。

现在，这一切都很好，但是如果您在多个地区都有数据库呢？如果您有一个英国数据库，您想将其作为测试环境进行复制，但是您的所有测试都在澳大利亚进行，因此您希望您的测试数据库位于澳大利亚以获得更好的延迟，该怎么办？您不能跨区域恢复快照，但可以跨区域复制快照。只需调用 **CopyDBSnapshot** 命令，连接到目标区域，传递您希望复制的源区域中快照的“DBSnapshotArn”。
然后，一旦它被复制，(在目标区域使用 DescribeDBSnapshots 检查状态)，您可以继续如上所述。

以上介绍了 MS-SQL 中的单个实例，但是 Aurora DB 集群呢？这有点复杂，也不太直观。

首先调用**RestoreDBClusterFromSnapshot**。这里的主要问题是您需要指定引擎，尽管文档暗示您可以省略它。在我的例子中，Engine = "aurora-mysql "。

如上所述，您可以轮询可用性(调用 **DescribeDBClusters** )然后调用 **ModifyDBCluster** 来应用安全组和密码更改。

这就是有点不直观的地方。如果您通过 web dashboard 执行此操作，集群和其中的一个实例将被恢复，但是 API 不会执行第二步。因此，您最终会得到一个空集群，这看起来没什么用，但是集群包含了在其中运行实例所需的所有信息。
所以你现在需要调用 **CreateDbInstance** 。

传入以下参数:
DBClusterIdentifier =(目标集群)，
DBInstanceIdentifier =(目标实例名)，
Engine = "aurora-mysql "，

public accessible = true(注意这默认为 false，即使您还原的原始文件是 public 的。这让我措手不及，我浪费了一些时间想为什么我不能连接)。

所以你走吧。将生产 AWS 数据库恢复到测试环境中所需了解的一切。只需使用您喜欢的构建服务器或调度工具来调度您的应用程序，您就可以开始了。你可以恢复一个新的环境，每天晚上，在冲刺开始的时候，或者任何你想的时候。