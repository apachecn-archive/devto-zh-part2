# ç”¨æ•°æ®å®Œæ•´æ€§å‡€åŒ–ä»£ç ã€‚ç¬¬ 1 éƒ¨åˆ†:é»˜è®¤å€¼å’Œéç©ºå€¼

> åŸæ–‡:[https://dev . to/ampli fr/purify-code-with-data-integrity-part-1-defaults-and-not-nulls-492 p](https://dev.to/amplifr/purify-code-with-data-integrity-part-1-defaults-and-not-nulls-492p)

å¤„ç†æ•°æ®æ˜¯ä»»ä½•åº”ç”¨ç¨‹åºçš„å…³é”®ç‚¹ã€‚ActiveRecord è®© Rails å¼€å‘è€…æ›´å®¹æ˜“å®Œæˆè¿™ä¸ªè¿‡ç¨‹ã€‚å®ƒå…è®¸åœ¨ä¸æ·±å…¥åº•å±‚æ•°æ®åº“çš„æƒ…å†µä¸‹ç®¡ç†æ•°æ®ã€‚æœ‰æ—¶å®ƒä¼šå¯¼è‡´ä¸€äº›ä»£ç é—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬æ›´åŠ æ³¨æ„æ•°æ®åº“çš„ç»“æ„å’Œç»´æŠ¤æ•°æ®å®Œæ•´æ€§ï¼Œè¿™äº›é—®é¢˜å°±ä¸ä¼šå‡ºç°äº†ã€‚

## [](#data-integrity)æ•°æ®å®Œæ•´æ€§ï¼Ÿ

[æ•°æ®å®Œæ•´æ€§](https://en.wikipedia.org/wiki/Data_integrity)æ˜¯ç»´æŠ¤æ•°æ®å‡†ç¡®æ€§å’Œä¸€è‡´æ€§çš„è¿‡ç¨‹ã€‚

åœ¨`ActiveRecord`ä¸Šä¸‹æ–‡ä¸­ï¼Œæˆ‘çš„æ„æ€æ˜¯ï¼Œ`data integrity` -æ˜¯é€šè¿‡æ›´åŠ å…³æ³¨å…¶æ¨¡å¼è®¾è®¡æ¥ä¿æŒåº•å±‚æ•°æ®åº“å¤„äºå‡†ç¡®çŠ¶æ€çš„*åŸåˆ™é›†ã€‚*

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å›é¡¾ä¸€äº›è‘—åçš„**æ•°æ®å®Œæ•´æ€§æŠ€æœ¯**ï¼Œå®ƒä»¬å¯¹æ”¹è¿›ä»£ç åº“éå¸¸æœ‰å¸®åŠ©ï¼Œä½†æœ‰æ—¶ç”±äºæŸäº›åŸå› è¢«ä½ä¼°äº†ã€‚æˆ‘ä»¬å°†çœ‹åˆ°å®ƒä»¬æ˜¯å¤šä¹ˆå®¹æ˜“é›†æˆï¼Œä»¥åŠå®ƒä»¬å¦‚ä½•å¸®åŠ©ç¼–å†™æ›´æ¸…æ™°çš„ä»£ç ã€‚

## [](#default-values)é»˜è®¤å€¼

ä½ è§è¿‡è¿™æ ·çš„ä»£ç å—ï¼Ÿ

```
# Example 1
order = Order.new(state: 'new')

# Example 2
class Order < ApplicationRecord
  validates :state, presence: true

  def before_validation
    self.state ||= 'new'
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸¤ä¸ªä¾‹å­éƒ½æœ‰åŒæ ·çš„é—®é¢˜:ç¼ºç¼ºçœå€¼é¢„ç½®ã€‚å®ƒå¯¼è‡´ä½¿ç”¨ä»¥ä¸‹é€‰é¡¹ä¹‹ä¸€ä»¥éé›†ä¸­æ–¹å¼â€œæ‰‹åŠ¨â€å†™å…¥åˆå§‹åŒ–:

1) ğŸ‘**è®¾å®šå€¼ã€åˆ°ä½ã€‘**(ä¾‹ä¸€)ã€‚è¿™ä¸ªè§£å†³æ–¹æ¡ˆåˆå¿«åˆè„ã€‚ä¸»è¦ç¼ºç‚¹æ˜¯â€œæ­£ç¡®çš„â€ç¼ºçœå€¼çš„éšå«æ€§:ä¸ç†Ÿæ‚‰é¡¹ç›®**çš„äººä¸ä¼šçŸ¥é“å°†æ¥è®¾ç½®**çš„å»ºè®®ç¼ºçœå€¼ï¼Œæˆ–è€…**æœŸæœ›è¯¥å€¼åº”è¯¥å·²ç»å­˜åœ¨**ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´é”™è¯¯ã€‚

ç¬¬äºŒç‚¹æ˜¯ï¼Œè¿™æ ·çš„â€œä»£ç ç‰‡æ®µâ€**éå¸ƒæ•´ä¸ªä»£ç åº“**ï¼Œå¹¶ä¸”ç”±äºé‡å¤å’Œåˆ†æ•£ï¼Œå¾ˆéš¾ç»´æŠ¤ã€‚

2) ğŸ‘**åœ¨ã€é¢„ä¿å­˜ã€‘æ¨¡å¼å›è°ƒ**ä¸­è®¾ç½®é»˜è®¤å€¼
(ä»ä¸Šä¾‹äºŒ)ã€‚ä½†æ˜¯è¿™é‡Œæˆ‘ä»¬ä¹Ÿæœ‰éšå«æ€§ã€‚åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°æ­£ç¡®çš„åˆå§‹å€¼`before_save`ã€`before_commit`ã€`before_validation`ï¼Ÿç­”æ¡ˆå–å†³äºä½œè€…çš„æƒ³è±¡åŠ›ğŸ˜Šã€‚

ç¬¬äºŒä¸ªé—®é¢˜æ˜¯æ–°æ¨¡å‹ä¸­æ²¡æœ‰åˆå§‹åŒ–é»˜è®¤å€¼(ä¾‹äºŒ)ï¼Œå³ä½¿æˆ‘ä»¬åœ¨ä¿å­˜å‰è®¾ç½®äº†é»˜è®¤å€¼ï¼Œåœ¨æ–°æ¨¡å‹å¯¹è±¡ä¸­ä»ç„¶æ²¡æœ‰åˆå§‹åŒ–:

```
order = Order.new
order.state
=> nil
order.save
order.state
=> 'new' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ğŸ‘æœ€å¥½çš„é€‰æ‹©æ˜¯åœ¨æ•°æ®åº“æ¨¡å¼ä¸­é¢„è®¾é»˜è®¤å€¼ï¼Œé€šè¿‡è®¾è®¡è®© ActiveRecord å¾ˆå¥½åœ°å·¥ä½œ:

```
create_table :orders do |t|
  ...
  t.integer :state, default:'new'
end

# default value work by-default :)
Order.new.state
=> 'new' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®ƒå…è®¸ä¸€ä¸ªæ–°çš„å¯¹è±¡å…·æœ‰é»˜è®¤çš„åˆ—è®¾ç½®ã€‚ActiveRecord å°†è¯»å–æ‚¨çš„è¡¨çš„å…ƒæ•°æ®ï¼Œå¹¶ä¸ºä»»ä½•æ–°çš„`User`ç±»å‹çš„æ¨¡å‹é¢„è®¾é»˜è®¤å€¼ã€‚

### [](#setting-up-the-database)è®¾ç½®æ•°æ®åº“

ç®€å•çš„ä¾‹å­æ˜¯åœ¨åˆ›å»ºæ–°è¡¨æ—¶è®¾ç½®é»˜è®¤å€¼ã€‚æ“ä½œç®€å•ï¼Œæ— é˜»å¡:

```
create_table :order do |t|
  ...
  t.integer :state, default: 'new'
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦åˆ™ï¼Œå‘ç°æœ‰è¡¨ä¸­æ·»åŠ ä¸€ä¸ªå¸¦æœ‰é»˜è®¤å€¼çš„åˆ—ä¼šæ›´å¤æ‚ï¼Œå› ä¸ºè¿™å°†å¼ºåˆ¶ä¸ºæ‰€æœ‰è¡Œè®¾ç½®é»˜è®¤å€¼ã€‚å®ƒä¼šåœ¨é«˜è´Ÿè½½æ•°æ®åº“ä¸­é”å®šä¸€æ®µæ—¶é—´çš„è¯»/å†™æ“ä½œã€‚

å¦‚æœä½ å¹¸è¿åœ°ç«™åœ¨å‰æ²¿ï¼Œåœ¨ Postgres 11 ä¸Šè¿è¡Œä½ çš„åº”ç”¨ç¨‹åºï¼Œäº‹æƒ…ä¼šå˜å¾—ç®€å•å¾—å¤šã€‚PostgreSQL 11 ä¸æ¥è§¦ç°æœ‰è¡Œï¼Œä½†[ä¼šâ€˜å»¶è¿Ÿâ€™æ›´æ–°å®ƒä»¬](https://leopard.in.ua/2016/09/20/safe-and-unsafe-operations-postgresql#.W_Oy4nozZbW)ã€‚

å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨ Postgres 11ï¼Œè®¾ç½®ç¼ºçœå€¼çº¦æŸçš„å®‰å…¨æ–¹æ³•åŒ…æ‹¬ä¸¤ä¸ªç®€å•çš„æ­¥éª¤:
1)åˆ›å»ºå¯ç©ºçš„åˆ—è€Œä¸è®¾ç½®ç¼ºçœå€¼
2)æ”¹å˜åˆ—çš„ç¼ºçœå€¼

```
 add_column :orders, :state, :text
  change_column_default :orders, :state, 'new' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­¤åï¼Œæ‰€æœ‰æ–°è¡Œéƒ½å°†å…·æœ‰é»˜è®¤å€¼ï¼Œæ´»åŠ¨è®°å½•å°†ä½¿ç”¨è¿™äº›å…ƒæ•°æ®è‡ªåŠ¨é¢„è®¾é»˜è®¤å€¼ã€‚æ•°æ®åº“ä¸­æ‰€æœ‰ç°æœ‰çš„è¡Œä»ç„¶æœ‰`NULL`å€¼ï¼Œéœ€è¦â€œæ‰‹åŠ¨â€å¡«å……å®ƒä»¬æ¥ç¾åŒ– ruby ä»£ç ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä¾èµ–æ¯ä¸€è¡Œçš„åˆ—çš„å­˜åœ¨ã€‚

â—The çš„è¦ç‚¹æ˜¯ä¿æŒå…¼å®¹æ€§:æ”¹å˜æ•°æ®åº“é¢„ç½®ç¬¬ä¸€æ¬¡å’Œèˆ¹èˆ¶ã€‚ç„¶åï¼Œå½“åˆ—ä¸­ä¸å†æœ‰ç©ºå€¼æ—¶ï¼Œä» Ruby ä»£ç ä¸­åˆ é™¤é»˜è®¤å€¼åˆå§‹åŒ–ã€‚

## [](#notnull-constraints)éç©ºçº¦æŸ

ä½ é¢å¯¹è¿‡è¿™æ ·çš„ä»£ç å—ï¼Ÿ

```
class ImageUploadService
  def call
    ...
    image.upload_tries_count ||= 0
    image.upload_tries_count += 1
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªé—®é¢˜ç±»ä¼¼äºç¼ºå°‘é»˜è®¤å€¼ã€‚å½“ä¸€ä¸ªåˆ—å¯ä¸ºç©ºæ—¶â€”â€”web ä¸èƒ½ç¡®å®šæ²¡æœ‰`nil`å€¼ã€‚æ¯æ¬¡æˆ‘ä»¬å¿…é¡»ä½¿ç”¨åˆ—æ—¶ï¼Œå®ƒå¼ºåˆ¶å†™`nil`-æ£€æŸ¥é€»è¾‘ã€‚

å¦‚æœæˆ‘ä»¬ä¿è¯è¯¥åˆ—æ²¡æœ‰`nil`å€¼ï¼Œä»£ç å°†å˜å¾—ç®€å•å¾—å¤š:

```
image.upload_tries_count += 1 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è§£å†³æ–¹æ¡ˆå¦‚ä¸‹:

> not-null çº¦æŸä»…æŒ‡å®šåˆ—ä¸èƒ½é‡‡ç”¨ null å€¼ã€‚

### [](#create-a-new-table-and-with-notnull-column)åˆ›å»ºä¸€ä¸ªæ–°è¡¨å¹¶å¸¦æœ‰éç©ºåˆ—

è®¾ç½®`default`é€‰é¡¹ï¼Œè¯¥åˆ—å°†å…·æœ‰é»˜è®¤è®¾ç½®çš„å€¼:

```
create_table :user do |t|
  ...
  t.integer :points_count, null: false, default: 0
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#adding-notnull-column-to-existing-table)å‘ç°æœ‰è¡¨ä¸­æ·»åŠ éç©ºåˆ—

[è¿™ç¯‡æ–‡ç« ](https://medium.com/klaxit-techblog/zero-downtime-migrations-with-activerecord-47528abe5136)è¯¦ç»†æè¿°äº†ç”¨ default æ·»åŠ æ–°åˆ—çš„å®‰å…¨æ–¹æ³•ï¼Œä½†è¿™é‡Œæ˜¯æ€»ç»“æ­¥éª¤:

*   ç”¨æŸä¸ªå€¼å¡«å……æ•°æ®åº“ä¸­çš„æ‰€æœ‰ç©ºå€¼
*   å°†åˆ—è®¾ç½®ä¸ºéç©º(é€šè¿‡è¿ç§»)
*   åˆ é™¤â€œå°±åœ°â€æ¨¡å‹åˆå§‹åŒ–ä»£ç 

â—The å¡«å……é‡è½½è¡¨çš„å€¼çš„æ›´å¥½çš„æ–¹æ³•æ˜¯ç”¨æ‰¹å¤„ç†(äº‹åŠ¡ä¸­çš„æ¯ä¸€ä¸ªæ‰¹å¤„ç†)è¿›è¡Œæ›´æ–°ï¼Œå¹¶åœ¨æ—¶é—´ä¸Šè¿›è¡Œæ‹‰ä¼¸ã€‚

åœ¨ Ruby world ä¸­ï¼Œè‡ªåŠ¨åŒ–çš„æ ‡å‡†æ–¹å¼æ˜¯`Rake` -tasksï¼Œè¿™é‡Œæ˜¯ rake-task çš„ç¤ºä¾‹ï¼Œç”¨æ‰¹å¤„ç†æ›´æ–° users è¡¨ users:

```
desc 'Fill user points count'
namespace :migrations do
  task fill_user_points_count: :environment do
    total_updated = 0
    loop do
      updated_rows = User
        .where(points_count: nil).limit(10_000)
        .update_all(points_count: 0).to_i
      break if updated_rows.zero?

      total_updated += updated_rows
      puts "updated #{total_updated} users"
    end
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘æ¨èåœ¨è¿ç§»ä¸­ä½¿ç”¨ rake-task è€Œä¸æ˜¯æ›´æ–°åˆ—ï¼Œå› ä¸ºå®ƒ
ç»™äº†**æ›´å¤šçš„æ§åˆ¶æ¥åœ¨ç”Ÿäº§**ä¸Šè¿è¡Œå®ƒ(å¦‚æœå‡ºç°é—®é¢˜ï¼Œæ‚¨å¯ä»¥éšæ—¶ä¸­æ–­è¿›ç¨‹)ã€‚è¿™é‡Œæœ‰ä¸€äº›æŠ€å·§æ€§çš„è¿ç§»æ¥è‡ªåŠ¨è®¾ç½®ä¸´æ—¶ç¯å¢ƒå’Œå…¶ä»–å¼€å‘äººå‘˜æœºå™¨çš„é»˜è®¤å€¼:

```
class FillOrderSourceAndSetNotNull < ActiveRecord::Migration[5.0]
  disable_ddl_transaction!

  def up
    if Rails.env.production?
      puts "Run bundle exec migrations:fill_user_points_count in production"
    else
      Rake::Task['migrations:fill_user_points_count'].invoke
    end
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­¤è¿ç§»ç¦ç”¨è¿ç§»çš„äº‹åŠ¡æ¨¡å¼ï¼Œå¹¶ä»¥ 10 000 è¡Œä¸ºä¸€æ‰¹æ›´æ–°ç”¨æˆ·ã€‚å¦‚æœè¡¨åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ›´æ–°ï¼Œå®ƒå…è®¸æ²¡æœ‰å¤§è¡¨é”ã€‚

ç»è¿‡è¿™ä¸€æ­¥-æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°è®¾ç½® table not-null:

```
change_column_null :users, :points_count, false 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¹¶å°†æ›´æ”¹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ã€‚
æœ€åä¸€æ­¥æ˜¯åˆ é™¤é›¶æ ¡éªŒä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
user.points_count ||= 0 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#wrap-up)æ€»ç»“èµ·æ¥

éµå¾ªè¿™ä¸¤ä¸ªç®€å•çš„è§„åˆ™:â€œè®¾ç½®é»˜è®¤å€¼â€å’Œâ€œè®¾ç½®åˆ—ä¸ä¸ºç©ºâ€å¯¹äºç¼–å†™æ›´æ¸…æ™°çš„ä»£ç å’Œé¿å…è®¸å¤šé—®é¢˜éå¸¸æœ‰ç”¨ã€‚

æ„Ÿè°¢é˜…è¯»ï¼ä¸‹ä¸€ä¸ªè¯é¢˜å†è§ã€‚

## [](#additional-links)é™„åŠ é“¾æ¥:

*   [å®˜æ–¹æ–‡ä»¶ä¸­ PorstreSQL çº¦æŸçš„è®¸å¤šç»†èŠ‚](https://www.postgresql.org/docs/10/ddl-constraints.html)
*   [å¤§å®¹é‡ PostgreSQL çš„å®‰å…¨å’Œä¸å®‰å…¨æ“ä½œ](https://leopard.in.ua/2016/09/20/safe-and-unsafe-operations-postgresql#.W-2GDzkSw0M)
*   [å…·æœ‰æ•°æ®å®Œæ•´æ€§çš„ç¼–ç è½¨é“](https://www.bignerdranch.com/blog/coding-rails-with-data-integrity/)
*   [ä½¿ç”¨ ActiveRecord å®ç°é›¶åœæœºè¿ç§»](https://medium.com/klaxit-techblog/zero-downtime-migrations-with-activerecord-47528abe5136)