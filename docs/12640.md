# 集装箱化铁路:技术、缺陷和最佳实践(RailsConf 2018)

> 原文:[https://dev . to/dazuma/containing-rails-techniques-trains-and-best-practices-rails conf-2018-1p4g](https://dev.to/dazuma/containerizing-rails-techniques-pitfalls-and-best-practices-railsconf-2018-1p4g)

2018 年 4 月 18 日，我在宾夕法尼亚州匹兹堡的 RailsConf 上发表了“集装箱化铁路:技术、陷阱和最佳实践”的演讲。讲座讨论了为 Rails 应用程序设计 Docker 容器的最佳实践。

## 谈话资源

*   [会议视频](http://confreaks.tv/videos/railsconf2018-containerizing-rails-techniques-pitfalls-best-practices)
*   [speaker deck 上的幻灯片](https://speakerdeck.com/dazuma/containerizing-rails-techniques-pitfalls-and-best-practices)

## 一列提示

这是我们在谈话中提到的所有建议。

1.  阅读并理解你的基本形象。

    docker 文件通常可以在 Github 上访问。了解您的基础映像在做什么很重要，这样您就可以判断它是否适合您的应用程序。

2.  **结合安装命令和清理**

    务必确保临时/不需要的文件不会出现在映像的任何中间层中。

3.  **使用单独的构建阶段**

    多阶段 docker 文件非常强大，对于确保您的最终映像只包含运行时需要的文件非常有用。

4.  **设置系统区域设置**

    一些 Linux 发行版在默认情况下不设置它，这可能会对 Ruby 中的字符串编码产生意想不到的影响。

5.  **创建一个无特权用户**

    建立纵深防御。默认情况下，容器中的进程以超级用户身份运行，这不是 Rails 想要的。

6.  **CMD 的首选执行形式**

    很多原因，包括与 ENTRYPOINT 的互操作性。但具体来说，它是正确的信号传播和安全的容器关闭所需要的。

7.  **在 shell 表单前加上关键字**

    如果您必须使用 shell 形式，请在前面加上“exec”关键字，以使 bash 传播信号。

8.  **避免 ONBUILD**

    它只是没有那么有用的功能。它对你的应用程序的需求做出假设，并涉及隐式而不是显式的构建。

9.  **始终指定资源约束**

    这对于确保生产中容器行为的稳定性和可预测性至关重要。如果您不能定义静态约束，这表明您的容器可能做得太多了。

10.  **避免在容器中进行预加工**

    预工作与资源(如文件句柄)有复杂的交互，并可能导致不太可预测的内存行为

11.  **通过添加容器进行扩展**

    容器是最好的缩放单位。如果需要更多资源，请添加更多容器。

    很抱歉，我在演讲中没有把这一点说得那么清楚，但是在一个容器中有多个进程是可以的，如果它们一起工作来执行一个服务，只要容器仍然有静态的、可预测的资源约束。

12.  **登录到标准输出或外部代理**

    将生产日志放在容器外。最简单的方法是通过设置`RAILS_LOG_TO_STDOUT`环境变量来记录到 STDOUT。

## 链接

*   Docker 文档发布了另一个好的 Docker 文件最佳实践列表。
*   Phusion 的 baseimage 提供了对许多复杂用例的支持，例如控制 init 过程和在容器中运行守护进程。它有很好的文档记录，对于学习 Docker 的 edge 案例非常有用，尽管对于大多数应用程序来说可能有些过头了。