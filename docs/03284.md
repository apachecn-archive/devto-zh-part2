# ActiveRecord ä¸ Ecto ç¬¬äºŒéƒ¨åˆ†

> åŸæ–‡:[https://dev.to/appsignal/activerecord-vs-ecto-part-two-3001](https://dev.to/appsignal/activerecord-vs-ecto-part-two-3001)

è¿™æ˜¯â€œActiveRecord vs. Ectoâ€ç³»åˆ—çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œè™è ä¾ å’Œè™è å¥³ä¾ ä¸ºæŸ¥è¯¢æ•°æ®åº“è€Œæˆ˜ï¼Œæˆ‘ä»¬æ¯”è¾ƒè‹¹æœå’Œæ©˜å­ã€‚

åœ¨ [ActiveRecord ä¸ Ecto ç¬¬ä¸€éƒ¨åˆ†](https://blog.appsignal.com/2018/09/28/active-record-vs-ecto.html)ä¸­ç ”ç©¶äº†æ•°æ®åº“æ¨¡å¼å’Œè¿ç§»ä¹‹åï¼Œè¿™ç¯‡æ–‡ç« ä»‹ç»äº† ActiveRecord å’Œ Ecto å¦‚ä½•ä½¿å¼€å‘äººå‘˜èƒ½å¤ŸæŸ¥è¯¢æ•°æ®åº“ï¼Œä»¥åŠ ActiveRecord å’Œ Ecto åœ¨å¤„ç†ç›¸åŒéœ€æ±‚æ—¶å¦‚ä½•è¿›è¡Œæ¯”è¾ƒã€‚ä¸€è·¯èµ°æ¥ï¼Œæˆ‘ä»¬è¿˜å°†æ‰¾å‡ºè™è å¥³ä¾  1989-2011 å¹´çš„èº«ä»½ã€‚

## ç§å­æ•°æ®

æˆ‘ä»¬å¼€å§‹å§ï¼åŸºäºæœ¬ç³»åˆ—[ç¬¬ä¸€ç¯‡](%5Bhttps://blog.appsignal.com/2018/09/28/active-record-vs-ecto.html%5D)ä¸­å®šä¹‰çš„æ•°æ®åº“ç»“æ„ï¼Œå‡è®¾`users`å’Œ`invoices`è¡¨ä¸­å­˜å‚¨äº†ä»¥ä¸‹æ•°æ®:

**ç”¨æˆ·**

| èº«ä»½è¯æ˜ï¼ˆidentificationï¼‰ | å…¨å | ç”µå­é‚®ä»¶ | åˆ›å»ºäº* | æ›´æ–°æ•°æ® |
| --- | --- | --- | --- | --- |
| one | æ›´å¥½çš„å‡¯æ© | [bette@kane.test](mailto:bette@kane.test) | 2018-01-01 10:01:00 | 2018-01-01 10:01:00 |
| Two | èŠ­èŠ­æ‹‰Â·æˆˆç™» | [èŠ­èŠ­æ‹‰@æˆˆç™». test](mailto:barbara@gordon.test) | 2018-01-02 10:02:00 | 2018-01-02 10:02:00 |
| three | å¡çŠå¾·æ‹‰Â·è¯¥éš | [cassandra@cain.test](mailto:cassandra@cain.test) | 2018-01-03 10:03:00 | 2018-01-03 10:03:00 |
| four | æ–¯è’‚èŠ¬å¦®Â·å¸ƒæœ— | stephanie@brown.test | 2018-01-04 10:04:00 | 2018-01-04 10:04:00 |

* ActiveRecord çš„`created_at`å­—æ®µåœ¨ Ecto ä¸­é»˜è®¤å‘½åä¸º`inserted_at`ã€‚

**å‘ç¥¨**

| èº«ä»½è¯æ˜ï¼ˆidentificationï¼‰ | ç”¨æˆ·æ ‡è¯† | æ”¯ä»˜æ–¹å¼ | æ”¯ä»˜æ—¶é—´ | åˆ›å»ºäº* | æ›´æ–°æ•°æ® |
| --- | --- | --- | --- | --- | --- |
| one | one | ä¿¡ç”¨å¡ | 2018-02-01 08:00:00 | 2018-01-02 08:00:00 | 2018-01-02 08:00:00 |
| Two | Two | è´å® | 2018-02-01 08:00:00 | 2018-01-03 08:00:00 | 2018-01-03 08:00:00 |
| three | three |  |  | 2018-01-04 08:00:00 | 2018-01-04 08:00:00 |
| four | four |  |  | 2018-01-05 08:00:00 | 2018-01-05 08:00:00 |

* ActiveRecord çš„`created_at`å­—æ®µåœ¨ Ecto ä¸­é»˜è®¤å‘½åä¸º`inserted_at`ã€‚

é€šè¿‡æœ¬å¸–æ‰§è¡Œçš„æŸ¥è¯¢å‡è®¾ä¸Šè¿°æ•°æ®å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œå› æ­¤åœ¨é˜…è¯»æ—¶è¯·è®°ä½è¿™äº›ä¿¡æ¯ã€‚

## ä½¿ç”¨ä¸»é”®æŸ¥æ‰¾é¡¹ç›®

è®©æˆ‘ä»¬ä»ä½¿ç”¨ä¸»é”®ä»æ•°æ®åº“è·å–è®°å½•å¼€å§‹ã€‚

### [æ¿€æ´»è®°å½•](#activerecord)

```
irb(main):001:0>  User.find(1)
User Load (0.4ms)  SELECT  "users".* FROM "users" WHERE "users"."id" = $1 LIMIT $2  [["id", 1], ["LIMIT", 1]] => #<User id: 1, full_name: "Bette Kane", email: "bette@kane.test", created_at: "2018-01-01 10:01:00", updated_at: "2018-01-01 10:01:00"> 
```

Enter fullscreen mode Exit fullscreen mode

### Ecto

```
iex(3)> Repo.get(User, 1)
[debug] QUERY OK source="users" db=5.2ms decode=2.5ms queue=0.1ms
SELECT u0."id", u0."full_name", u0."email", u0."inserted_at", u0."updated_at" FROM "users" AS u0 WHERE (u0."id" = $1) [1]
%Financex.Accounts.User{
  __meta__: #Ecto.Schema.Metadata<:loaded, "users">,
  email: "bette@kane.test",
  full_name: "Bette Kane",
  id: 1,
  inserted_at: ~N[2018-01-01 10:01:00.000000],
  invoices: #Ecto.Association.NotLoaded<association :invoices is not loaded>,
  updated_at: ~N[2018-01-01 10:01:00.000000]
} 
```

Enter fullscreen mode Exit fullscreen mode

### æ¯”è¾ƒ

è¿™ä¸¤ç§æƒ…å†µéå¸¸ç›¸ä¼¼ã€‚ActiveRecord ä¾èµ–äº`User`æ¨¡å‹ç±»çš„`find`ç±»æ–¹æ³•ã€‚è¿™æ„å‘³ç€æ¯ä¸ª ActiveRecord å­ç±»éƒ½æœ‰è‡ªå·±çš„`find`æ–¹æ³•ã€‚

Ecto ä½¿ç”¨ä¸€ç§ä¸åŒçš„æ–¹æ³•ï¼Œä¾é [åº“](https://martinfowler.com/eaaCatalog/repository.html)æ¦‚å¿µä½œä¸ºæ˜ å°„å±‚å’ŒåŸŸä¹‹é—´çš„ä¸­ä»‹ã€‚å½“ä½¿ç”¨ Ecto æ—¶ï¼Œ`User`æ¨¡å—ä¸çŸ¥é“å¦‚ä½•æ‰¾åˆ°è‡ªå·±ã€‚è¿™ç§èŒè´£å­˜åœ¨äº`Repo`æ¨¡å—ä¸­ï¼Œè¯¥æ¨¡å—èƒ½å¤Ÿå°†å…¶æ˜ å°„åˆ°åº•å±‚çš„æ•°æ®å­˜å‚¨ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ Postgresã€‚

å½“æ¯”è¾ƒ SQL æŸ¥è¯¢æœ¬èº«æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¸€äº›å·®å¼‚:

*   ActiveRecord åŠ è½½æ‰€æœ‰å­—æ®µ(`users.*`)ï¼Œè€Œ Ecto åªåŠ è½½åœ¨`schema`å®šä¹‰ä¸­åˆ—å‡ºçš„å­—æ®µã€‚
*   ActiveRecord åœ¨æŸ¥è¯¢ä¸­åŒ…å«äº†ä¸€ä¸ª`LIMIT 1`ï¼Œè€Œ Ecto æ²¡æœ‰ã€‚

## æŠ“å–æ‰€æœ‰é¡¹ç›®

è®©æˆ‘ä»¬æ›´è¿›ä¸€æ­¥ï¼Œä»æ•°æ®åº“ä¸­åŠ è½½æ‰€æœ‰ç”¨æˆ·ã€‚

### [æ¿€æ´»è®°å½•](#activerecord)

```
irb(main):001:0>  User.all
User Load (0.5ms)  SELECT  "users".* FROM "users" LIMIT $1  [["LIMIT", 11]] => #<ActiveRecord::Relation [#<User id: 1, full_name: "Bette Kane", email: "bette@kane.test", created_at: "2018-01-01 10:01:00", updated_at: "2018-01-01 10:01:00">, #<User id: 2, full_name: "Barbara Gordon", email: "barbara@gordon.test", created_at: "2018-01-02 10:02:00", updated_at: "2018-01-02 10:02:00">, #<User id: 3, full_name: "Cassandra Cain", email: "cassandra@cain.test", created_at: "2018-01-03 10:03:00", updated_at: "2018-01-03 10:03:00">, #<User id: 4, full_name: "Stephanie Brown", email: "stephanie@brown.test", created_at: "2018-01-04 10:04:00", updated_at: "2018-01-04 10:04:00">]> 
```

Enter fullscreen mode Exit fullscreen mode

### Ecto

```
iex(4)> Repo.all(User)
[debug] QUERY OK source="users" db=2.8ms decode=0.2ms queue=0.2ms
SELECT u0."id", u0."full_name", u0."email", u0."inserted_at", u0."updated_at" FROM "users" AS u0 []
[
  %Financex.Accounts.User{
    __meta__: #Ecto.Schema.Metadata<:loaded, "users">,
    email: "bette@kane.test",
    full_name: "Bette Kane",
    id: 1,
    inserted_at: ~N[2018-01-01 10:01:00.000000],
    invoices: #Ecto.Association.NotLoaded<association :invoices is not loaded>,
    updated_at: ~N[2018-01-01 10:01:00.000000]
  },
  %Financex.Accounts.User{
    __meta__: #Ecto.Schema.Metadata<:loaded, "users">,
    email: "barbara@gordon.test",
    full_name: "Barbara Gordon",
    id: 2,
    inserted_at: ~N[2018-01-02 10:02:00.000000],
    invoices: #Ecto.Association.NotLoaded<association :invoices is not loaded>,
    updated_at: ~N[2018-01-02 10:02:00.000000]
  },
  %Financex.Accounts.User{
    __meta__: #Ecto.Schema.Metadata<:loaded, "users">,
    email: "cassandra@cain.test",
    full_name: "Cassandra Cain",
    id: 3,
    inserted_at: ~N[2018-01-03 10:03:00.000000],
    invoices: #Ecto.Association.NotLoaded<association :invoices is not loaded>,
    updated_at: ~N[2018-01-03 10:03:00.000000]
  },
  %Financex.Accounts.User{
    __meta__: #Ecto.Schema.Metadata<:loaded, "users">,
    email: "stephanie@brown.test",
    full_name: "Stephanie Brown",
    id: 4,
    inserted_at: ~N[2018-01-04 10:04:00.000000],
    invoices: #Ecto.Association.NotLoaded<association :invoices is not loaded>,
    updated_at: ~N[2018-01-04 10:04:00.000000]
  }
] 
```

Enter fullscreen mode Exit fullscreen mode

### æ¯”è¾ƒ

å®ƒéµå¾ªä¸ä¸Šä¸€èŠ‚å®Œå…¨ç›¸åŒçš„æ¨¡å¼ã€‚ActiveRecord ä½¿ç”¨`all`ç±»æ–¹æ³•ï¼Œè€Œ Ecto ä¾èµ–äºå­˜å‚¨åº“æ¨¡å¼æ¥åŠ è½½è®°å½•ã€‚

SQL æŸ¥è¯¢ä¸­ä¹Ÿæœ‰ä¸€äº›ä¸åŒä¹‹å¤„:

*   ä¸ä¸Šä¸€èŠ‚ç›¸åŒï¼ŒActiveRecord åŠ è½½æ‰€æœ‰å­—æ®µ(`users.*`)ï¼Œè€Œ Ecto åªåŠ è½½`schema`å®šä¹‰ä¸­åˆ—å‡ºçš„å­—æ®µã€‚
*   ActiveRecord è¿˜å®šä¹‰äº†ä¸€ä¸ª`LIMIT 11`ï¼Œè€Œ Ecto åªæ˜¯ç®€å•åœ°åŠ è½½ä¸€åˆ‡ã€‚è¿™ä¸ªé™åˆ¶æ¥è‡ªäºæ§åˆ¶å°ä¸Šä½¿ç”¨çš„`inspect`æ–¹æ³•([https://github . com/rails/rails/blob/master/active record/lib/active _ record/relation . Rb # L599](https://github.com/rails/rails/blob/master/activerecord/lib/active_record/relation.rb#L599))ã€‚

## å¸¦æ¡ä»¶æŸ¥è¯¢

æˆ‘ä»¬ä¸å¤ªå¯èƒ½éœ€è¦ä»ä¸€ä¸ªè¡¨ä¸­è·å–æ‰€æœ‰è®°å½•ã€‚ä¸€ä¸ªå¸¸è§çš„éœ€æ±‚æ˜¯ä½¿ç”¨æ¡ä»¶æ¥è¿‡æ»¤æ‰è¿”å›çš„æ•°æ®ã€‚

è®©æˆ‘ä»¬ç”¨é‚£ä¸ªä¾‹å­æ¥åˆ—å‡ºæ‰€æœ‰è¿˜æœªæ”¯ä»˜çš„`invoices`(`WHERE paid_at IS NULL`)ã€‚

### [æ¿€æ´»è®°å½•](#activerecord)

```
irb(main):024:0>  Invoice.where(paid_at: nil)
Invoice Load (18.2ms)  SELECT  "invoices".* FROM "invoices" WHERE "invoices"."paid_at" IS NULL LIMIT $1  [["LIMIT", 11]] => #<ActiveRecord::Relation [#<Invoice id: 3, user_id: 3, payment_method: nil, paid_at: nil, created_at: "2018-01-04 08:00:00", updated_at: "2018-01-04 08:00:00">, #<Invoice id: 4, user_id: 4, payment_method: nil, paid_at: nil, created_at: "2018-01-05 08:00:00", updated_at: "2018-01-05 08:00:00">]> 
```

Enter fullscreen mode Exit fullscreen mode

### Ecto

```
iex(19)> where(Invoice, [i], is_nil(i.paid_at)) |> Repo.all()
[debug] QUERY OK source="invoices" db=20.2ms
SELECT i0."id", i0."payment_method", i0."paid_at", i0."user_id", i0."inserted_at", i0."updated_at" FROM "invoices" AS i0 WHERE (i0."paid_at" IS NULL) []
[
  %Financex.Accounts.Invoice{
    __meta__: #Ecto.Schema.Metadata<:loaded, "invoices">,
    id: 3,
    inserted_at: ~N[2018-01-04 08:00:00.000000],
    paid_at: nil,
    payment_method: nil,
    updated_at: ~N[2018-01-04 08:00:00.000000],
    user: #Ecto.Association.NotLoaded<association :user is not loaded>,
    user_id: 3
  },
  %Financex.Accounts.Invoice{
    __meta__: #Ecto.Schema.Metadata<:loaded, "invoices">,
    id: 4,
    inserted_at: ~N[2018-01-04 08:00:00.000000],
    paid_at: nil,
    payment_method: nil,
    updated_at: ~N[2018-01-04 08:00:00.000000],
    user: #Ecto.Association.NotLoaded<association :user is not loaded>,
    user_id: 4
  }
] 
```

Enter fullscreen mode Exit fullscreen mode

### æ¯”è¾ƒ

åœ¨è¿™ä¸¤ä¸ªä¾‹å­ä¸­ï¼Œéƒ½ä½¿ç”¨äº†å…³é”®å­—`where`ï¼Œå®ƒæ˜¯ SQL `WHERE`å­å¥çš„ä¸€ä¸ªè¿æ¥ã€‚å°½ç®¡ç”Ÿæˆçš„ SQL æŸ¥è¯¢éå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯è¿™ä¸¤ç§å·¥å…·çš„å®ç°æ–¹å¼æœ‰ä¸€äº›é‡è¦çš„ä¸åŒã€‚

ActiveRecord è‡ªåŠ¨å°†`paid_at: nil`å‚æ•°è½¬æ¢ä¸º`paid_at IS NULL` SQL è¯­å¥ã€‚ä¸ºäº†ä½¿ç”¨ Ecto å¾—åˆ°ç›¸åŒçš„è¾“å‡ºï¼Œå¼€å‘äººå‘˜éœ€è¦é€šè¿‡è°ƒç”¨`is_nil()`æ¥æ›´åŠ æ˜ç¡®ä»–ä»¬çš„æ„å›¾ã€‚

å¦ä¸€ä¸ªéœ€è¦å¼ºè°ƒçš„åŒºåˆ«æ˜¯ Ecto ä¸­å‡½æ•°`where`çš„â€œçº¯â€è¡Œä¸ºã€‚å•ç‹¬è°ƒç”¨`where`å‡½æ•°æ—¶ï¼Œå¹¶ä¸ä¼šä¸ä¸æ•°æ®åº“äº¤äº’ã€‚`where`å‡½æ•°çš„è¿”å›æ˜¯ä¸€ä¸ª`Ecto.Query`ç»“æ„:

```
iex(20)> where(Invoice, [i], is_nil(i.paid_at))
#Ecto.Query<from i in Financex.Accounts.Invoice, where: is_nil(i.paid_at)> 
```

Enter fullscreen mode Exit fullscreen mode

åªæœ‰å½“è°ƒç”¨`Repo.all()`å‡½æ•°æ—¶ï¼Œæ•°æ®åº“æ‰ä¼šè¢«è§¦åŠ¨ï¼Œå°†`Ecto.Query` struct ä½œä¸ºå‚æ•°ä¼ é€’ã€‚è¿™ç§æ–¹æ³•å…è®¸åœ¨ Ecto ä¸­è¿›è¡ŒæŸ¥è¯¢ç»„åˆï¼Œè¿™æ˜¯ä¸‹ä¸€èŠ‚çš„ä¸»é¢˜ã€‚

## æŸ¥è¯¢ä½œæ–‡

æ•°æ®åº“æŸ¥è¯¢æœ€å¼ºå¤§çš„æ–¹é¢ä¹‹ä¸€æ˜¯ç»„åˆã€‚å®ƒä»¥åŒ…å«å¤šä¸ªæ¡ä»¶çš„æ–¹å¼æè¿°æŸ¥è¯¢ã€‚

å¦‚æœæ‚¨æ­£åœ¨æ„å»ºåŸå§‹ SQL æŸ¥è¯¢ï¼Œè¿™æ„å‘³ç€æ‚¨å¯èƒ½ä¼šä½¿ç”¨æŸç§è¿æ¥ã€‚å‡è®¾ä½ æœ‰ä¸¤ä¸ªæ¡ä»¶:

1.  `not_paid = 'paid_at IS NOT NULL'`
2.  `paid_with_paypal = 'payment_method = "Paypal"'`

ä¸ºäº†ä½¿ç”¨åŸå§‹ SQL å°†è¿™ä¸¤ä¸ªæ¡ä»¶ç»“åˆèµ·æ¥ï¼Œæ„å‘³ç€æ‚¨å¿…é¡»ä½¿ç”¨ç±»ä¼¼äºä»¥ä¸‹å†…å®¹çš„å†…å®¹å°†å®ƒä»¬è¿æ¥èµ·æ¥:

```
SELECT * FROM invoices WHERE #{not_paid} AND #{paid_with_paypal} 
```

Enter fullscreen mode Exit fullscreen mode

å¹¸è¿çš„æ˜¯ï¼ŒActiveRecord å’Œ Ecto éƒ½æœ‰è§£å†³æ–¹æ¡ˆã€‚

### [æ¿€æ´»è®°å½•](#activerecord)

```
irb(main):003:0>  Invoice.where.not(paid_at: nil).where(payment_method: "Paypal")
Invoice Load (8.0ms)  SELECT  "invoices".* FROM "invoices" WHERE "invoices"."paid_at" IS NOT NULL AND "invoices"."payment_method" = $1 LIMIT $2  [["payment_method", "Paypal"], ["LIMIT", 11]] => #<ActiveRecord::Relation [#<Invoice id: 2, user_id: 2, payment_method: "Paypal", paid_at: "2018-02-01 08:00:00", created_at: "2018-01-03 08:00:00", updated_at: "2018-01-03 08:00:00">]> 
```

Enter fullscreen mode Exit fullscreen mode

### Ecto

```
iex(6)> Invoice |> where([i], not is_nil(i.paid_at)) |> where([i], i.payment_method == "Paypal") |> Repo.all()
[debug] QUERY OK source="invoices" db=30.0ms decode=0.6ms queue=0.2ms
SELECT i0."id", i0."payment_method", i0."paid_at", i0."user_id", i0."inserted_at", i0."updated_at" FROM "invoices" AS i0 WHERE (NOT (i0."paid_at" IS NULL)) AND (i0."payment_method" = 'Paypal') []
[
  %Financex.Accounts.Invoice{
    __meta__: #Ecto.Schema.Metadata<:loaded, "invoices">,
    id: 2,
    inserted_at: ~N[2018-01-03 08:00:00.000000],
    paid_at: #DateTime<2018-02-01 08:00:00.000000Z>,
    payment_method: "Paypal",
    updated_at: ~N[2018-01-03 08:00:00.000000],
    user: #Ecto.Association.NotLoaded<association :user is not loaded>,
    user_id: 2
  }
] 
```

Enter fullscreen mode Exit fullscreen mode

### æ¯”è¾ƒ

ä¸¤ä¸ªæŸ¥è¯¢éƒ½åœ¨å›ç­”åŒä¸€ä¸ªé—®é¢˜:â€œå“ªäº›å‘ç¥¨æ˜¯ç”¨ Paypal æ”¯ä»˜çš„ï¼Ÿâ€ã€‚

æ­£å¦‚é¢„æœŸçš„é‚£æ ·ï¼ŒActiveRecord æä¾›äº†ä¸€ç§æ›´ç®€æ´çš„æ–¹å¼æ¥ç¼–å†™æŸ¥è¯¢(å¯¹äºé‚£ä¸ªä¾‹å­)ï¼Œè€Œ Ecto è¦æ±‚å¼€å‘äººå‘˜åœ¨ç¼–å†™æŸ¥è¯¢ä¸Šå¤šèŠ±ä¸€ç‚¹æ—¶é—´ã€‚åƒå¾€å¸¸ä¸€æ ·ï¼ŒBatgirl(å­¤å„¿ï¼Œå¡çŠå¾·æ‹‰Â·è¯¥éšèº«ä»½çš„å“‘å·´)æˆ– Activerecord å¹¶ä¸å†—é•¿ã€‚

ä¸è¦è¢«ä¸Šé¢æ˜¾ç¤ºçš„ Ecto æŸ¥è¯¢çš„å†—é•¿å’Œæ˜æ˜¾çš„å¤æ‚æ€§æ‰€è¿·æƒ‘ã€‚åœ¨çœŸå®ä¸–ç•Œç¯å¢ƒä¸­ï¼Œè¯¥æŸ¥è¯¢å°†è¢«é‡å†™ä¸ºç±»ä¼¼äº:

```
Invoice
|> where([i], not is_nil(i.paid_at))
|> where([i], i.payment_method == "Paypal")
|> Repo.all() 
```

Enter fullscreen mode Exit fullscreen mode

ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œå‡½æ•°`where`(å®ƒæœ¬èº«ä¸æ‰§è¡Œæ•°æ®åº“æ“ä½œ)çš„â€œçº¯â€æ–¹é¢ä¸ç®¡é“æ“ä½œç¬¦çš„ç»“åˆï¼Œä½¿å¾— Ecto ä¸­çš„æŸ¥è¯¢ç»„åˆéå¸¸å¹²å‡€ã€‚

## è®¢è´­

æ’åºæ˜¯æŸ¥è¯¢çš„ä¸€ä¸ªé‡è¦æ–¹é¢ã€‚å®ƒä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿç¡®ä¿ç»™å®šçš„æŸ¥è¯¢ç»“æœéµå¾ªæŒ‡å®šçš„é¡ºåºã€‚

### [æ¿€æ´»è®°å½•](#activerecord)

```
irb(main):002:0>  Invoice.order(created_at: :desc)
Invoice Load (1.5ms)  SELECT  "invoices".* FROM "invoices" ORDER BY "invoices"."created_at" DESC LIMIT $1  [["LIMIT", 11]] => #<ActiveRecord::Relation [#<Invoice id: 4, user_id: 4, payment_method: nil, paid_at: nil, created_at: "2018-01-05 08:00:00", updated_at: "2018-01-05 08:00:00">, #<Invoice id: 3, user_id: 3, payment_method: nil, paid_at: nil, created_at: "2018-01-04 08:00:00", updated_at: "2018-01-04 08:00:00">, #<Invoice id: 2, user_id: 2, payment_method: "Paypal", paid_at: "2018-02-01 08:00:00", created_at: "2018-01-03 08:00:00", updated_at: "2018-01-03 08:00:00">, #<Invoice id: 1, user_id: 1, payment_method: "Credit Card", paid_at: "2018-02-01 08:00:00", created_at: "2018-01-02 08:00:00", updated_at: "2018-01-02 08:00:00">]> 
```

Enter fullscreen mode Exit fullscreen mode

### Ecto

```
iex(6)> order_by(Invoice, desc: :inserted_at) |> Repo.all()
[debug] QUERY OK source="invoices" db=19.8ms
SELECT i0."id", i0."payment_method", i0."paid_at", i0."user_id", i0."inserted_at", i0."updated_at" FROM "invoices" AS i0 ORDER BY i0."inserted_at" DESC []
[
  %Financex.Accounts.Invoice{
    __meta__: #Ecto.Schema.Metadata<:loaded, "invoices">,
    id: 3,
    inserted_at: ~N[2018-01-04 08:00:00.000000],
    paid_at: nil,
    payment_method: nil,
    updated_at: ~N[2018-01-04 08:00:00.000000],
    user: #Ecto.Association.NotLoaded<association :user is not loaded>,
    user_id: 3
  },
  %Financex.Accounts.Invoice{
    __meta__: #Ecto.Schema.Metadata<:loaded, "invoices">,
    id: 4,
    inserted_at: ~N[2018-01-04 08:00:00.000000],
    paid_at: nil,
    payment_method: nil,
    updated_at: ~N[2018-01-04 08:00:00.000000],
    user: #Ecto.Association.NotLoaded<association :user is not loaded>,
    user_id: 4
  },
  %Financex.Accounts.Invoice{
    __meta__: #Ecto.Schema.Metadata<:loaded, "invoices">,
    id: 2,
    inserted_at: ~N[2018-01-03 08:00:00.000000],
    paid_at: #DateTime<2018-02-01 08:00:00.000000Z>,
    payment_method: "Paypal",
    updated_at: ~N[2018-01-03 08:00:00.000000],
    user: #Ecto.Association.NotLoaded<association :user is not loaded>,
    user_id: 2
  },
  %Financex.Accounts.Invoice{
    __meta__: #Ecto.Schema.Metadata<:loaded, "invoices">,
    id: 1,
    inserted_at: ~N[2018-01-02 08:00:00.000000],
    paid_at: #DateTime<2018-02-01 08:00:00.000000Z>,
    payment_method: "Credit Card",
    updated_at: ~N[2018-01-02 08:00:00.000000],
    user: #Ecto.Association.NotLoaded<association :user is not loaded>,
    user_id: 1
  }
] 
```

Enter fullscreen mode Exit fullscreen mode

### æ¯”è¾ƒ

åœ¨è¿™ä¸¤ç§å·¥å…·ä¸­ï¼Œå‘æŸ¥è¯¢æ·»åŠ è®¢å•éƒ½éå¸¸ç®€å•ã€‚

å°½ç®¡ Ecto ç¤ºä¾‹ä½¿ç”¨äº†ä¸€ä¸ª`Invoice`ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä½†æ˜¯`order_by`å‡½æ•°ä¹Ÿæ¥å—`Ecto.Query`ç»“æ„ï¼Œè¿™ä½¿å¾—`order_by`å‡½æ•°å¯ä»¥ç”¨äºç»„åˆï¼Œæ¯”å¦‚:

```
Invoice
|> where([i], not is_nil(i.paid_at))
|> where([i], i.payment_method == "Paypal")
|> order_by(desc: :inserted_at)
|> Repo.all() 
```

Enter fullscreen mode Exit fullscreen mode

## é™åˆ¶

ä»€ä¹ˆæ˜¯æ²¡æœ‰é™åˆ¶çš„æ•°æ®åº“ï¼Ÿä¸€åœºç¾éš¾ã€‚å¹¸è¿çš„æ˜¯ï¼ŒActiveRecord å’Œ Ecto éƒ½æœ‰åŠ©äºé™åˆ¶è¿”å›è®°å½•çš„æ•°é‡ã€‚

### [æ¿€æ´»è®°å½•](#activerecord)

```
irb(main):004:0>  Invoice.limit(2)
Invoice Load (0.2ms)  SELECT  "invoices".* FROM "invoices" LIMIT $1  [["LIMIT", 2]] => #<ActiveRecord::Relation [#<Invoice id: 1, user_id: 1, payment_method: "Credit Card", paid_at: "2018-02-01 08:00:00", created_at: "2018-01-02 08:00:00", updated_at: "2018-01-02 08:00:00">, #<Invoice id: 2, user_id: 2, payment_method: "Paypal", paid_at: "2018-02-01 08:00:00", created_at: "2018-01-03 08:00:00", updated_at: "2018-01-03 08:00:00">]> 
```

Enter fullscreen mode Exit fullscreen mode

### Ecto

```
iex(22)> limit(Invoice, 2) |> Repo.all()
[debug] QUERY OK source="invoices" db=3.6ms
SELECT i0."id", i0."payment_method", i0."paid_at", i0."user_id", i0."inserted_at", i0."updated_at" FROM "invoices" AS i0 LIMIT 2 []
[
  %Financex.Accounts.Invoice{
    __meta__: #Ecto.Schema.Metadata<:loaded, "invoices">,
    id: 1,
    inserted_at: ~N[2018-01-02 08:00:00.000000],
    paid_at: #DateTime<2018-02-01 08:00:00.000000Z>,
    payment_method: "Credit Card",
    updated_at: ~N[2018-01-02 08:00:00.000000],
    user: #Ecto.Association.NotLoaded<association :user is not loaded>,
    user_id: 1
  },
  %Financex.Accounts.Invoice{
    __meta__: #Ecto.Schema.Metadata<:loaded, "invoices">,
    id: 2,
    inserted_at: ~N[2018-01-03 08:00:00.000000],
    paid_at: #DateTime<2018-02-01 08:00:00.000000Z>,
    payment_method: "Paypal",
    updated_at: ~N[2018-01-03 08:00:00.000000],
    user: #Ecto.Association.NotLoaded<association :user is not loaded>,
    user_id: 2
  }
] 
```

Enter fullscreen mode Exit fullscreen mode

### æ¯”è¾ƒ

ActiveRecord å’Œ Ecto éƒ½æœ‰é™åˆ¶æŸ¥è¯¢è¿”å›çš„è®°å½•æ•°é‡çš„æ–¹æ³•ã€‚

Ecto çš„`limit`ä¸`order_by`çš„å·¥ä½œæ–¹å¼ç±»ä¼¼ï¼Œé€‚ç”¨äºæŸ¥è¯¢ç»„åˆã€‚

## è”æƒ³

å½“è°ˆåˆ°å¦‚ä½•å¤„ç†å…³è”æ—¶ï¼ŒActiveRecord å’Œ Ecto æœ‰ä¸åŒçš„æ–¹æ³•ã€‚

### [æ¿€æ´»è®°å½•](#activerecord)

åœ¨ ActiveRecord ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ¨¡å‹ä¸­å®šä¹‰çš„ä»»ä½•å…³è”ï¼Œè€Œä¸å¿…å¯¹æ­¤åšä»»ä½•ç‰¹æ®Šå¤„ç†ï¼Œä¾‹å¦‚:

```
irb(main):012:0>  user = User.find(2)
User Load (0.3ms)  SELECT  "users".* FROM "users" WHERE "users"."id" = $1 LIMIT $2  [["id", 2], ["LIMIT", 1]] => #<User id: 2, full_name: "Barbara Gordon", email: "barbara@gordon.test", created_at: "2018-01-02 10:02:00", updated_at: "2018-01-02 10:02:00">
irb(main):013:0>  user.invoices
Invoice Load (0.4ms)  SELECT  "invoices".* FROM "invoices" WHERE "invoices"."user_id" = $1 LIMIT $2  [["user_id", 2], ["LIMIT", 11]] => #<ActiveRecord::Associations::CollectionProxy [#<Invoice id: 2, user_id: 2, payment_method: "Paypal", paid_at: "2018-02-01 08:00:00", created_at: "2018-01-03 08:00:00", updated_at: "2018-01-03 08:00:00">]> 
```

Enter fullscreen mode Exit fullscreen mode

ä¸Šé¢çš„ä¾‹å­è¡¨æ˜ï¼Œå½“è°ƒç”¨`user.invoices`æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—ç”¨æˆ·å‘ç¥¨çš„åˆ—è¡¨ã€‚æ‰§è¡Œæ­¤æ“ä½œæ—¶ï¼ŒActiveRecord ä¼šè‡ªåŠ¨æŸ¥è¯¢æ•°æ®åº“å¹¶åŠ è½½ä¸ç”¨æˆ·ç›¸å…³è”çš„å‘ç¥¨ã€‚è™½ç„¶è¿™ç§æ–¹æ³•ä½¿äº‹æƒ…å˜å¾—æ›´ç®€å•ï¼Œå› ä¸ºç¼–å†™çš„ä»£ç æ›´å°‘ï¼Œæˆ–è€…ä¸å¿…æ‹…å¿ƒé¢å¤–çš„æ­¥éª¤ï¼Œä½†æ˜¯å¦‚æœè¦è¿­ä»£å¤šä¸ªç”¨æˆ·å¹¶è·å–æ¯ä¸ªç”¨æˆ·çš„å‘ç¥¨ï¼Œè¿™å¯èƒ½ä¼šæ˜¯ä¸€ä¸ªé—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜è¢«ç§°ä¸ºâ€œN + 1 é—®é¢˜â€ã€‚

åœ¨ ActiveRecord ä¸­ï¼Œå¯¹â€œN + 1 é—®é¢˜â€çš„å»ºè®®ä¿®å¤æ˜¯ä½¿ç”¨`includes`æ–¹æ³•:

```
irb(main):022:0>  user = User.includes(:invoices).find(2)
User Load (0.3ms)  SELECT  "users".* FROM "users" WHERE "users"."id" = $1 LIMIT $2  [["id", 2], ["LIMIT", 1]]
Invoice Load (0.6ms)  SELECT "invoices".* FROM "invoices" WHERE "invoices"."user_id" = $1  [["user_id", 2]] => #<User id: 2, full_name: "Barbara Gordon", email: "barbara@gordon.test", created_at: "2018-01-02 10:02:00", updated_at: "2018-01-02 10:02:00">
irb(main):023:0>  user.invoices
=> #<ActiveRecord::Associations::CollectionProxy [#<Invoice id: 2, user_id: 2, payment_method: "Paypal", paid_at: "2018-02-01 08:00:00", created_at: "2018-01-03 08:00:00", updated_at: "2018-01-03 08:00:00">]> 
```

Enter fullscreen mode Exit fullscreen mode

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒActiveRecord åœ¨è·å–ç”¨æˆ·æ—¶ä¼šç«‹å³åŠ è½½`invoices`å…³è”(å¦‚æ‰€ç¤ºçš„ä¸¤ä¸ª SQL æŸ¥è¯¢æ‰€ç¤º)ã€‚

### Ecto

ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°äº†ï¼ŒåŸƒå…‹æ‰˜çœŸçš„ä¸å–œæ¬¢é­”æœ¯æˆ–å«è“„ã€‚å®ƒè¦æ±‚å¼€å‘è€…æ˜ç¡®ä»–ä»¬çš„æ„å›¾ã€‚

è®©æˆ‘ä»¬å°è¯•ä¸€ä¸‹åŒæ ·çš„æ–¹æ³•ï¼Œå°†`user.invoices`ä¸
ä¸€èµ·ä½¿ç”¨

```
iex(7)> user = Repo.get(User, 2)
[debug] QUERY OK source="users" db=18.3ms decode=0.6ms
SELECT u0."id", u0."full_name", u0."email", u0."inserted_at", u0."updated_at" FROM "users" AS u0 WHERE (u0."id" = $1) [2]
%Financex.Accounts.User{
  __meta__: #Ecto.Schema.Metadata<:loaded, "users">,
  email: "barbara@gordon.test",
  full_name: "Barbara Gordon",
  id: 2,
  inserted_at: ~N[2018-01-02 10:02:00.000000],
  invoices: #Ecto.Association.NotLoaded<association :invoices is not loaded>,
  updated_at: ~N[2018-01-02 10:02:00.000000]
}
iex(8)> user.invoices
#Ecto.Association.NotLoaded<association :invoices is not loaded> 
```

Enter fullscreen mode Exit fullscreen mode

ç»“æœæ˜¯ä¸€ä¸ª`Ecto.Association.NotLoaded`ã€‚æ²¡é‚£ä¹ˆæœ‰ç”¨ã€‚

è¦è®¿é—®å‘ç¥¨ï¼Œå¼€å‘äººå‘˜éœ€è¦ä½¿ç”¨`preload`å‡½æ•°:
è®© Ecto çŸ¥é“è¿™ä¸€ç‚¹

```
iex(12)> user = preload(User, :invoices) |> Repo.get(2)
[debug] QUERY OK source="users" db=11.8ms
SELECT u0."id", u0."full_name", u0."email", u0."inserted_at", u0."updated_at" FROM "users" AS u0 WHERE (u0."id" = $1) [2]
[debug] QUERY OK source="invoices" db=4.2ms
SELECT i0."id", i0."payment_method", i0."paid_at", i0."user_id", i0."inserted_at", i0."updated_at", i0."user_id" FROM "invoices" AS i0 WHERE (i0."user_id" = $1) ORDER BY i0."user_id" [2]
%Financex.Accounts.User{
  __meta__: #Ecto.Schema.Metadata<:loaded, "users">,
  email: "barbara@gordon.test",
  full_name: "Barbara Gordon",
  id: 2,
  inserted_at: ~N[2018-01-02 10:02:00.000000],
  invoices: [
    %Financex.Accounts.Invoice{
      __meta__: #Ecto.Schema.Metadata<:loaded, "invoices">,
      id: 2,
      inserted_at: ~N[2018-01-03 08:00:00.000000],
      paid_at: #DateTime<2018-02-01 08:00:00.000000Z>,
      payment_method: "Paypal",
      updated_at: ~N[2018-01-03 08:00:00.000000],
      user: #Ecto.Association.NotLoaded<association :user is not loaded>,
      user_id: 2
    }
  ],
  updated_at: ~N[2018-01-02 10:02:00.000000]
}

iex(15)> user.invoices
[
  %Financex.Accounts.Invoice{
    __meta__: #Ecto.Schema.Metadata<:loaded, "invoices">,
    id: 2,
    inserted_at: ~N[2018-01-03 08:00:00.000000],
    paid_at: #DateTime<2018-02-01 08:00:00.000000Z>,
    payment_method: "Paypal",
    updated_at: ~N[2018-01-03 08:00:00.000000],
    user: #Ecto.Association.NotLoaded<association :user is not loaded>,
    user_id: 2
  }
] 
```

Enter fullscreen mode Exit fullscreen mode

ä¸ ActiveRecord `includes`ç±»ä¼¼ï¼Œpreload with è·å–å…³è”çš„`invoices`ï¼Œè¿™å°†ä½¿å®ƒä»¬åœ¨è°ƒç”¨`user.invoices`æ—¶å¯ç”¨ã€‚

### æ¯”è¾ƒ

ActiveRecord å’Œ Ecto ä¹‹é—´çš„æˆ˜æ–—å†æ¬¡ä»¥ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„è§‚ç‚¹ç»“æŸ:æ˜¾å¼æ€§ã€‚è¿™ä¸¤ä¸ªå·¥å…·éƒ½ä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿè½»æ¾åœ°è®¿é—®å…³è”ï¼Œä½†æ˜¯è™½ç„¶ ActiveRecord ä½¿å®ƒä¸é‚£ä¹ˆå†—é•¿ï¼Œä½†æ˜¯å®ƒçš„ç»“æœå¯èƒ½ä¼šæœ‰æ„æƒ³ä¸åˆ°çš„è¡Œä¸ºã€‚Ecto éµå¾ª WYSIWYG ç±»å‹çš„æ–¹æ³•ï¼Œåªåšå¼€å‘äººå‘˜å®šä¹‰çš„æŸ¥è¯¢ä¸­çœ‹åˆ°çš„äº‹æƒ…ã€‚

Rails ä»¥åœ¨åº”ç”¨ç¨‹åºçš„æ‰€æœ‰ä¸åŒå±‚ä½¿ç”¨å’Œæ¨å¹¿ç¼“å­˜ç­–ç•¥è€Œé—»åã€‚ä¸€ä¸ªä¾‹å­æ˜¯å…³äºä½¿ç”¨â€œä¿„ç½—æ–¯å¨ƒå¨ƒâ€ç¼“å­˜æ–¹æ³•ï¼Œå®ƒå®Œå…¨ä¾é â€œN + 1 é—®é¢˜â€æ¥å®ç°å…¶ç¼“å­˜æœºåˆ¶ã€‚

## éªŒè¯

ActiveRecord ä¸­çš„å¤§å¤šæ•°éªŒè¯ä¹Ÿå¯ä»¥åœ¨ Ecto ä¸­ä½¿ç”¨ã€‚ä¸‹é¢æ˜¯å¸¸è§éªŒè¯çš„åˆ—è¡¨ï¼Œä»¥åŠ ActiveRecord å’Œ Ecto å¦‚ä½•å®šä¹‰å®ƒä»¬:

| ActiveRecord | åŸƒå…‹æ‰˜ |
| --- | --- |
| `validates :title, presence: true` | `validate_required(changeset, [:title])` |
| `validates :email, confirmation: true` | `validate_confirmation(changeset, :email)` |
| `validates :email, format: {with: /@/` } | `validate_format(changeset, :email, ~r/@/)` |
| `validates :start, exclusion: {in: %w(a b)}` | `validate_exclusion(changeset, :start, ~w(a b))` |
| `validates :start, inclusion: {in: %w(a b)}` | `validate_inclusion(changeset, :start, ~w(a b))` |
| `validates :terms_of_service, acceptance: true` | `validate_acceptance(changeset, :terms_of_service)` |
| `validates :password, length: {is: 6}` | `validate_length(changeset, :password, is: 6)` |
| `validates :age, numericality: {equal_to: 1}` | `validate_number(changeset, :age, equal_to: 1)` |

## æ€»ç»“èµ·æ¥

ç°åœ¨ä½ æœ‰äº†:åŸºæœ¬çš„è‹¹æœå’Œæ©˜å­çš„æ¯”è¾ƒã€‚

ActiveRecord ä¾§é‡äºæ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢çš„ä¾¿åˆ©æ€§ã€‚å®ƒçš„ç»å¤§éƒ¨åˆ†ç‰¹æ€§éƒ½é›†ä¸­åœ¨æ¨¡å‹ç±»æœ¬èº«ï¼Œä¸éœ€è¦å¼€å‘äººå‘˜å¯¹æ•°æ®åº“æœ‰æ·±å…¥çš„ç†è§£ï¼Œä¹Ÿä¸éœ€è¦è¿™äº›æ“ä½œçš„å½±å“ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒActiveRecord éšå¼åœ°åšäº†å¾ˆå¤šäº‹æƒ…ã€‚è™½ç„¶è¿™ä½¿å¼€å§‹å˜å¾—æ›´å®¹æ˜“ï¼Œä½†å®ƒä½¿ç†è§£å¹•åå‘ç”Ÿçš„äº‹æƒ…å˜å¾—æ›´éš¾ï¼Œè€Œä¸”åªæœ‰å½“ä½ éµå¾ªâ€œæ´»åŠ¨è®°å½•æ–¹å¼â€æ—¶ï¼Œå®ƒæ‰ä¼šèµ·ä½œç”¨ã€‚

å¦ä¸€æ–¹é¢ï¼ŒEcto è¦æ±‚æ˜¾å¼æ€§ï¼Œè¿™ä¼šå¯¼è‡´ä»£ç æ›´åŠ å†—é•¿ã€‚ä½œä¸ºä¸€ä¸ªå¥½å¤„ï¼Œä¸€åˆ‡éƒ½åœ¨èšå…‰ç¯ä¸‹ï¼Œæ²¡æœ‰å¹•åï¼Œä½ å¯ä»¥æŒ‡å®šè‡ªå·±çš„æ–¹å¼ã€‚

ä¸¤è€…éƒ½æœ‰å…¶ä¼˜åŠ¿ï¼Œè¿™å–å†³äºä½ çš„è§†è§’å’Œåå¥½ã€‚æ¯”è¾ƒäº†è‹¹æœå’Œæ¡”å­ä¹‹åï¼Œæˆ‘ä»¬å°±åˆ°äº†è¿™ä¸ªè¯é¢˜çš„ç»“å°¾ã€‚å·®ç‚¹å¿˜äº†å‘Šè¯‰ä½  bat girl(1989-2001)çš„ä»£å·æ˜¯....ç”²éª¨æ–‡ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸è¦æ·±å…¥è®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚ğŸ˜‰

*æœ¬æ–‡ç”±å®¢åº§ä½œè€…[åŸƒå°”ç»´å¥¥Â·ç»´ç§‘è¨](http://www.elviovicosa.com)æ’°å†™ã€‚åŸƒå°”ç»´å¥¥æ˜¯ã€Šä¸º Rails å¼€å‘è€…å‡†å¤‡çš„[å‡¤å‡°ã€‹ä¸€ä¹¦çš„ä½œè€…ã€‚](http://www.phoenixforrailsdevelopers.com)*