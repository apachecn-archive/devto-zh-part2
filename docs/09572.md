# 通过形成循环缓慢死亡

> 原文:[https://dev.to/benhayehudi/a-slow-death-by-for-loops-1004](https://dev.to/benhayehudi/a-slow-death-by-for-loops-1004)

本周，我的任务是用 PHP 构建一个 web 应用程序，它将接收多个数据输入，将它们连接成一个多维关联数组，进行一些数学计算，然后将结果输出给用户一个 CSV 文件。

这些不同数据源中的数据，通常情况下，并不是完美无缺的。甚至在将各个部分连接在一起之前，就需要检查数据是否有错误并进行清理。有些数据需要去掉多余的字符。一些数据需要过滤非数字值。而其他一些数据需要进行重复检查。

然后，一旦清理了数据，就需要对数据输入进行相互比较，以便将记录连接在一起。一个数据源保存一行信息的一些信息，另一个数据源保存更多的信息，另一个数据源保存更多的信息，最后，第四个数据源保存最后一位信息，以形成一个完整的记录。

可以想象，这种应用程序涉及到大量的迭代。迭代数据以清理数据。对数据进行迭代以进行比较，在比较中进行迭代以检查进一步的相等比较，以及应用转换等等。

如今，空间很便宜，但时间仍然很贵。这种迭代可能非常耗时。任何使用过 PHP 的人都知道测试应用程序并遇到可怕的`Fatal Error: Maximum execution time exceeded`错误的感觉。

直到你真正遇到一个涉及时间复杂性的问题，大 O 的概念才显得抽象。然而，只要花几分钟时间来优化你的代码，让它变得更快，你就会很快意识到它是多么的基础。

例如，看看下面的内容:

```
for ($i = 0; $i < count($foo); $i++) {
    for ($x = 0; $x < $count($foo_two); $x++) {
       // do something...
    }
} 
```

在比较两个数据数组时，这是一个非常常见的例子。你想在一个循环的同时也在另一个循环。这个的成本是多少？如果每个 for 循环都是 O(n)，那么 for 循环内部的嵌套 for 循环将是 O(n) <sup>2。</sup>*n*代表找到数据集最末端的值所需的时间，因此每个 for 循环都会使操作的时间复杂度加倍。这可能会非常快地累积起来，并对应用程序的性能造成相当大的损失。

当必须循环数据时，您会怎么做？怎么优化呢？

让我们来看几个技巧，特别适合 PHP，来提高我们的效率。

## [](#preset-your-total)预设您的总

我们都知道每种语言中见到的经典 for 循环表达式:`for ($i = 0; $i < count($array); $i++)`。表达式的第二部分，我们在每次循环时评估`$i`是否仍然小于数组的长度，这是非常昂贵的。每次循环时，我们的代码都要重新计算数组有多大。如果我们提前定义长度会怎么样？

```
$length = count($array);
for ($i = 0; $i < $length; $i++) {
    // do something
} 
```

现在，用我们的`$length`变量保存数组的大小，我们不用让我们的应用程序在每次循环时检查长度。根据[一个基准](http://www.phpbench.com/)的说法，使用预先计算的变量而不是强制计算每个循环可以快 94%。那可以很快累加起来。

## [](#single-quote-vs-double-quote)单引号 vs 双引号

使用单引号和双引号之间的时间差没有以前那么明显了。尽管如此，在我看来，对普通的文本字符串使用单引号仍然是一个好习惯。这是为什么呢？每次使用双引号时，PHP 都会检查引号内是否有需要评估的代码。所以，如果你正在比较一个数组中的一个对象，通过键引用它的值，使用`$array['key']`告诉代码`key`只是一个文本串，而使用`$array["key"]`让它检查`key`是否引用了除了一个文本串之外的任何东西。

## 你在那个 For 循环里面做什么？

每次循环的时候，你要求你的程序做什么？遍历数据本身就很费时间。现在，将您想要对该数据做的任何事情的成本考虑在内，您可以继续增加应用程序的时间复杂性。有些手术比其他手术更昂贵。当然，有时，您别无选择，只能在 for 循环中执行代价高昂的操作，但是如果您能够避免，您的代码将会更加高效。

字符串连接就是一个会快速增加时间复杂度的常见操作的例子。这是你的程序中经常被忽略的部分。毕竟，你所做的只是把一些文本放在一起。但是，如果按照循环的次数将这些串联起来，就很容易降低性能。

在 for 循环中，有什么比连接更有效的替代方法？把你的文本添加到一个数组中，当你需要输出文本时，内爆这个数组怎么样？在遍历数据的过程中，向数组中添加纯文本值比连接文本要快。另一种可能性是，如果满足您的要求，只需直接`echo`文本，而不进行连接。当然，这并不总是可能的，这取决于您需要您的应用程序做什么。

最后，将这些原则与其他一些原则一起应用到我负责创建的应用程序中，帮助实现了显著的性能提升。将时间复杂性作为开发过程中不可或缺的一部分来考虑，可以在以后需要重构现有代码时节省很多时间。

大 O 不仅仅是为了白板访谈，更确切地说，在现场对它的欣赏，可以产生更有效的代码，这使得更快乐的用户，进而更快乐的开发人员。