# 被盗的访问令牌和你

> 原文:[https://dev.to/oktadev/stolen-access-tokens-and-you-3gan](https://dev.to/oktadev/stolen-access-tokens-and-you-3gan)

什么东西永远不会死，会疯狂传播，而且一定会咬你？你猜对了:偷来的访问令牌！

最近几周，我们已经看到了许多围绕 OAuth 访问令牌的攻击。尽管我们很想指责底层技术，但更多的是出于误用和误解。

不管是谁，爆发都是一样的:

*   网站使用 OAuth，范围粒度很小甚至没有
*   网站发布一个没有到期的访问令牌
*   网站被攻破，令牌被泄露
*   这些令牌用于访问其他系统

这不是我们想要的“病毒式传播”。

更糟糕的是，当我们调查并试图清理这个烂摊子时，我们发现了三件事:

首先，令牌没有过期时间，所以它们永远不会失效。今天受损的令牌将永远受损。即使我们已经实现了 OAuth 令牌撤销( [RFC 7009](https://tools.ietf.org/html/rfc7009) )，下游系统可能不会像我们希望的那样验证访问令牌，因此它将永远存在。

此外，那些下游系统可能接受该访问令牌以[生成它们自己的会话](https://www.wired.com/story/facebook-hack-single-sign-on-data-exposed/)并发布它们自己的访问令牌。这些会话和令牌中的每一个都有自己的生存期，它们与原始令牌完全无关。一个漏洞会在瞬间传遍所有系统。

最后，请记住，这些原始令牌是未画出或画出的。我们丢失了万能钥匙，所以我们的攻击者可以打开任何门，下载任何数据，甚至可能修改用户的帐户。如果他们更改了电子邮件地址，无论我们发送多少警告通知，都已经太晚了。没有人在听。

在这一点上，我们的选择有限。我们可以冻结账户，撤销令牌，并通知下游应用程序，但最终我们不得不抱最好的希望。不幸的是，这还不够。像大多数从事安全工作的人一样，我是个偏执狂，需要知道我们已经锁上了每一扇窗户，保护了每一条路线，加固了每一个环节。因此，我们必须首先考虑如何阻止它和如何防止它。

## [](#stop-the-spread)停止蔓延

从下游应用程序的角度来看，我们必须小心我们接受的内容。我们可以在这个过程中插入一个中断，而不是使用访问或 ID 令牌来创建和激活用户的帐户。在创建和激活之间，我们应该坚持一个额外的因素，在这个用户和我们的系统之间创建一个隔离区。这可以像激活电子邮件一样简单，发送到经验证的令牌中提供的电子邮件。这种中断保护了我们的系统，并且对用户来说是一种很好理解的模式。

不幸的是，期望每个下游应用程序的每个开发人员在每个场景中都遵循最佳实践，在最好的情况下也是过于乐观了。我们如何在第一时间阻止疫情爆发？

## [](#prevention-is-the-cure)预防是治疗

首先，我们应该实现 OAuth 2.0 令牌撤销( [RFC 7009](https://tools.ietf.org/html/rfc7009) )和 OAuth 2.0 令牌自检( [RFC 7662](https://tools.ietf.org/html/rfc7662) )。这两个规范是一个强大的组合。它们给了我们杀死一个令牌的能力和安全地确认它已经死了的方法。我们越早教会开发人员确定令牌是否处于活动状态，我们所有的系统就越安全。

接下来，我们应该使用细粒度的作用域(也称为权限)。在我们的[API 访问管理的推荐实践](https://developer.okta.com/use_cases/api_access_management/#authorization-server)中，我们注意到一般的“管理”范围很少是合适的。您的范围应该特定于您的用例。如果您的用例是下载今天的数据用于报告，那么您的范围应该是只读的，并且仅限于该特定数据。如果您的用例涉及转移资金或读取健康信息，那么范围应该是唯一的，并且更加细粒度。现在，受损令牌对攻击者来说价值更低，对您的破坏性也更小。

最后，我们需要经常让令牌过期。乍一看，这似乎是错误的。毕竟，长期令牌允许用户完成他们需要的一切。但是请记住，我们有一个解决方案:刷新令牌！刷新令牌允许应用程序返回 OAuth 服务器并获得新的访问令牌。更重要的是，它可以像访问令牌一样被撤销。如果您的令牌受损，您将撤销它们，并且刷新令牌交换会失败。攻击者被锁在外面。

唯一公开的问题是“什么是好的访问令牌生命周期？”我的一般规则是，一个用例涉及花费或转移金钱；修改健康、保险或财务数据；或者更新联系信息或凭证应该具有极短的生命周期，大约几分钟。即使在这种情况下，我们也可能需要灵活性。例如，给一个朋友送 10 美元去吃午饭和转 10，000 美元去买车是不一样的。对于更普通或只读的用例，更长的生存期是可以接受的。

## 这不是奥特的错

尽管我们很想责怪我们的工具或技术，但这不是他们的错。很有可能，我们浏览了说明书或者阅读了很棒的 howto，却没有真正理解所需的~~咒语~~预防措施。

我们只决定我们可以。我们从未问过我们是否应该。T3】

为了保护我们自己、我们的系统和我们的客户，我们需要做最坏的打算，抱最好的希望。

[![looking good](../Images/75f899a8cfbb1c07863ba3771c1e1e43.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--Bbp-8Mgy--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://developer.okta.com/assets/blog/stolen-access-tokens/looking-good-2683fc93242433d02f08880e1aa06995eb46f862a24015afd4956ec08adeb436.jpg)