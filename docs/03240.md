# é€šè¿‡ä¸€ä¸ª bug æ¥å’Œæˆ‘ä¸€èµ·æµè§ˆè¿™ä¸ªç½‘ç«™çš„æºä»£ç 

> åŸæ–‡:[https://dev . to/lymes/come-with-me-on-a-journey-through the-this-websites-source-code-by-a-way-a-a-bug-odj](https://dev.to/rhymes/come-with-me-on-a-journey-through-this-websites-source-code-by-way-of-a-bug-odj)

è¿™ç¯‡æ–‡ç« çš„å¼€å§‹æ˜¯å› ä¸ºæˆ‘è®¤ä¸ºç ”ç©¶ä¸€ä¸ªç‰¹å®šçš„ bug å¯èƒ½æœ‰åŠ©äºæ›´å¥½åœ°ç†è§£ devto çš„æºä»£ç ã€‚æ‰€ä»¥æˆ‘åœ¨åšç ”ç©¶çš„æ—¶å€™å†™äº†è¿™ä¸ªï¼Œæœ€åæˆ‘ä¹Ÿå†™äº†ä¸€äº›å…¶ä»–çš„ä¸œè¥¿ã€‚å¼€å§‹äº†ã€‚

æˆ‘æŒ‡çš„è¿™ä¸ª bug å«åšåœ¨ GitHub ä¸Šåˆ é™¤å¸–å­æ—¶[è¶…æ—¶ã€‚é¡¾åæ€ä¹‰ï¼Œåˆ é™¤å¸–å­ä¼šå¯¼è‡´æœåŠ¡å™¨è¶…æ—¶ï¼Œä»è€Œç»™ç”¨æˆ·å¸¦æ¥é”™è¯¯ã€‚](https://github.com/thepracticaldev/dev.to/issues/821) [@peter](https://dev.to/peter) åœ¨ä»–çš„ bug æŠ¥å‘Šä¸­æ·»åŠ äº†å‡ ä¸ªæˆ‘ä»¬éœ€è¦ä¸ºæˆ‘ä»¬çš„â€œè°ƒæŸ¥â€ä¿ç•™çš„ç»†èŠ‚:è¿™ä¸ª bug å¹¶ä¸æ€»æ˜¯å‘ç”Ÿ(è¿™åœ¨å¯»æ‰¾è§£å†³æ–¹æ¡ˆçš„èƒŒæ™¯ä¸‹ä¼šæ›´å¥½ï¼Œç¡®å®šæ€§æ€»æ˜¯æ›´å¥½)ï¼Œå®ƒæ›´æœ‰å¯èƒ½å‡ºç°åœ¨æœ‰è®¸å¤šååº”å’Œè¯„è®ºçš„æ–‡ç« ä¸­ã€‚

ç¬¬ä¸€ä¸ªçº¿ç´¢:è¿™ç§æƒ…å†µæœ‰æ—¶ä¼šå‘ç”Ÿï¼Œé€šå¸¸å‘ç”Ÿåœ¨é™„æœ‰å¤§é‡æ•°æ®çš„æ–‡ç« ä¸­ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹æ˜¯å¦èƒ½åœ¨é’»ç ”ä»£ç ä¹‹å‰æŒ–æ˜å‡ºæ›´å¤šçš„ä¿¡æ¯*ã€‚*

æ³¨æ„:æˆ‘å†™è¿™ç¯‡æ–‡ç« æ˜¯ä¸ºäº†è§£é‡Š(å¹¶æ‰©å±•)æˆ‘ç ”ç©¶è¿™ä¸ªé—®é¢˜çš„æ–¹å¼ï¼Œè€Œå®ƒæ˜¯åœ¨åŒä¸€æ—¶é—´å‘ç”Ÿçš„(å—¯ï¼Œåœ¨å‡ å¤©çš„è¿‡ç¨‹ä¸­ï¼Œä½†ä»ç„¶æ˜¯åœ¨åŒä¸€æ—¶é—´:-D)ï¼Œæ‰€ä»¥å½“æˆ‘å†™ä¸‹å®ƒä»¬æ—¶ï¼Œæ‰€æœ‰çš„å‘ç°å¯¹æˆ‘æ¥è¯´éƒ½æ˜¯æ–°çš„ï¼Œå¦‚æœä½ è¯»äº†è¿™ç¯‡æ–‡ç« ï¼Œå®ƒä»¬å¯¹ä½ æ¥è¯´ä¹Ÿæ˜¯æ–°çš„ã€‚

å¦ä¸€ä¸ªæ³¨æ„äº‹é¡¹:æˆ‘å°†åœ¨è¿™é‡Œäº¤æ›¿ä½¿ç”¨æœ¯è¯­â€œå¼‚æ­¥â€å’Œâ€œè¿›ç¨‹å¤–â€ã€‚åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œå¼‚æ­¥æ„å‘³ç€â€œç”¨æˆ·ä¸ç­‰å¾…è°ƒç”¨è¢«æ‰§è¡Œâ€ï¼Œè€Œä¸æ˜¯ JavaScript ä¸­çš„â€œå¼‚æ­¥â€ã€‚æ›´å¥½çš„è¯´æ³•åº”è¯¥æ˜¯â€œè¿›ç¨‹å¤–â€ï¼Œå› ä¸ºè¿™äº›å¼‚æ­¥è°ƒç”¨æ˜¯ç”±ä¸€ä¸ªå¤–éƒ¨è¿›ç¨‹é€šè¿‡æ•°æ®åº“ä¸Šçš„ä¸€ä¸ªé˜Ÿåˆ—æ‰§è¡Œçš„ï¼Œè¯¥é˜Ÿåˆ—å¸¦æœ‰ä¸€ä¸ªåä¸º[å»¶è¿Ÿä½œä¸š](https://github.com/collectiveidea/delayed_job/)çš„åº“/gemã€‚

## [](#referential-integrity)å‚ç…§å®Œæ•´æ€§

ActiveRecord (Rails çš„ ORM)åƒè®¸å¤šå…¶ä»–å¯¹è±¡å…³ç³»æ˜ å°„å™¨ä¸€æ ·ï¼Œæ˜¯ä½äºå…³ç³»æ•°æ®åº“ç³»ç»Ÿä¹‹ä¸Šçš„å¯¹è±¡å±‚ã€‚è®©æˆ‘ä»¬ç»•ä¸€ç‚¹å¼¯è·¯ï¼Œè°ˆä¸€è°ˆåœ¨æ•°æ®åº“ç³»ç»Ÿä¸­ä¿æŒæ•°æ®æœ‰æ„ä¹‰çš„ä¸€ä¸ªåŸºæœ¬ç‰¹æ€§:å¼•ç”¨å®Œæ•´æ€§ã€‚ä¸ºä»€ä¹ˆä¸ï¼Œçªƒå¬å™¨å¯ä»¥ç­‰ï¼

[å¼•ç”¨å®Œæ•´æ€§](https://en.wikipedia.org/wiki/Referential_integrity)ï¼Œç®€å•æ¥è¯´ï¼Œæ˜¯å¯¹é‚£äº›å¯¹å¦‚ä½•æ„å»ºå…³ç³»æ•°æ®æœ‰å¥‡æ€ªæƒ³æ³•çš„å¼€å‘äººå‘˜çš„ä¸€ç§é˜²å¾¡ã€‚å®ƒç¦æ­¢åœ¨å…³ç³»çš„ä¸»è¡¨ä¸­æ’å…¥æ²¡æœ‰å¯¹åº”å…³ç³»çš„è¡Œã€‚é€šä¿—åœ°è¯´ï¼Œå®ƒä¿è¯åœ¨å…³ç³»ä¸­æœ‰ä¸€ä¸ªå¯¹åº”çš„è¡Œ:å¦‚æœæ‚¨æœ‰ä¸€ä¸ªåŒ…å« 10 ä¸ªåŸå¸‚çš„è¡¨ï¼Œæ‚¨ä¸åº”è¯¥æœ‰ä¸€ä¸ªåœ°å€å±äºæœªçŸ¥åŸå¸‚çš„å®¢æˆ·ã€‚æœ‰è¶£çš„æ˜¯ï¼ŒMySQL åœ¨é»˜è®¤æƒ…å†µä¸‹ç”¨äº†åå¤šå¹´æ‰æ¿€æ´»å‚ç…§å®Œæ•´æ€§ï¼Œè€Œ PostgreSQL åœ¨é‚£æ—¶å·²ç»ç”¨äº† 10 å¹´ã€‚æœ‰æ—¶æˆ‘è®¤ä¸º MySQL åœ¨å®ƒçš„æ—©æœŸç‰ˆæœ¬æ˜¯ä¸€ä¸ªå·¨å¤§çš„ CSV æ–‡ä»¶é›†åˆï¼Œä¸Šé¢æ˜¯ SQLã€‚æˆ‘å¼€ç©ç¬‘çš„ï¼Œä¹Ÿè®¸ã€‚

æœ‰äº†é€‚å½“çš„å¼•ç”¨å®Œæ•´æ€§ï¼Œæ‚¨å¯ä»¥(å¤§éƒ¨åˆ†)æ”¾å¿ƒï¼Œæ•°æ®åº“ä¸ä¼šè®©æ‚¨æ·»åŠ åƒµå°¸è¡Œï¼Œä¼šä¿æŒå…³ç³»æ›´æ–°ï¼Œå¦‚æœæ‚¨å‘Šè¯‰å®ƒï¼Œå®ƒä¼šåœ¨æ‚¨ä¹‹åæ¸…ç†ã€‚

ä½ å¦‚ä½•æŒ‡ç¤ºæ•°æ®åº“åšæ‰€æœ‰è¿™äº›äº‹æƒ…ï¼Ÿå¾ˆç®€å•ã€‚æˆ‘å°†ä½¿ç”¨æ¥è‡ª PostgreSQL 10 æ–‡æ¡£ :
çš„ä¸€ä¸ªä¾‹å­

```
CREATE TABLE products (
    product_no integer PRIMARY KEY,
    name text,
    price numeric
);

CREATE TABLE orders (
    order_id integer PRIMARY KEY,
    shipping_address text,
);

CREATE TABLE order_items (
    product_no integer REFERENCES products ON DELETE RESTRICT,
    order_id integer REFERENCES orders ON DELETE CASCADE,
    quantity integer,
    PRIMARY KEY (product_no, order_id)
); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¡¨`order_items`æœ‰ä¸¤ä¸ªå¤–é”®ï¼Œä¸€ä¸ªæŒ‡å‘`orders`ï¼Œå¦ä¸€ä¸ªæŒ‡å‘`products`(å¦‚æœä½ æƒ³çŸ¥é“çš„è¯ï¼Œè¿™æ˜¯å¤šå¯¹å¤šçš„ç»å…¸ä¾‹å­)ã€‚

å½“æ‚¨è®¾è®¡è¿™æ ·çš„è¡¨æ—¶ï¼Œæ‚¨åº”è¯¥é—®è‡ªå·±ä»¥ä¸‹é—®é¢˜(é™¤äº†åƒâ€œæˆ‘åˆ°åº•åœ¨ç”¨è¿™äº›æ•°æ®åšä»€ä¹ˆï¼Ÿâ€):

*   å¦‚æœåˆ é™¤äº†ä¸»è¡¨ä¸­çš„ä¸€è¡Œï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿ

*   æˆ‘è¦åˆ é™¤æ‰€æœ‰ç›¸å…³çš„è¡Œå—ï¼Ÿ

*   æˆ‘æ˜¯å¦è¦å°†å¼•ç”¨åˆ—è®¾ç½®ä¸º`NULL`ï¼Ÿåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™å¯¹æˆ‘çš„ä¸šåŠ¡é€»è¾‘æ„å‘³ç€ä»€ä¹ˆï¼Ÿ`NULL`å¯¹æˆ‘çš„æ•°æ®æœ‰æ„ä¹‰å—ï¼Ÿ

*   æˆ‘è¦å°†åˆ—è®¾ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿè¿™å¯¹æˆ‘çš„å•†ä¸šé€»è¾‘æ„å‘³ç€ä»€ä¹ˆï¼Ÿè¿™ä¸ªåˆ—æœ‰é»˜è®¤å€¼å—ï¼Ÿ

å¦‚æœä½ å›å¤´çœ‹çœ‹è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å‘Šè¯‰æ•°æ®åº“çš„æ˜¯ä»¥ä¸‹ä¸¤ä»¶äº‹:

*   äº§å“ä¸èƒ½è¢«ç§»é™¤ï¼Œé™¤éå®ƒä»¬æ²¡æœ‰ä»¥ä»»ä½•é¡ºåºå‡ºç°

*   è®¢å•å¯ä»¥åœ¨ä»»ä½•æ—¶å€™è¢«åˆ é™¤ï¼Œä»–ä»¬å¸¦ç€è¿™äº›ç‰©å“è¿›å…¥åŸå¢“ğŸ˜€

è¯·è®°ä½ï¼Œåœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­åˆ é™¤ä»ç„¶æ˜¯ä¸€ä¸ªå¿«é€Ÿæ“ä½œï¼Œå³ä½¿åœ¨åƒ dev.to è¿™æ ·çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå¦‚æœä¸€ç¯‡æ–‡ç« æœ‰ä¸ *cascade* æŒ‡ä»¤é“¾æ¥çš„è¡¨ï¼Œå®ƒä»ç„¶åº”è¯¥æ˜¯ä¸€ä¸ªå¿«é€Ÿæ“ä½œã€‚å½“å•ä¸ª`DELETE`è§¦å‘æ•°ç™¾ä¸‡(æˆ–æ•°åƒä¸‡)çš„å…¶ä»–åˆ é™¤æ—¶ï¼ŒDBs å¾€å¾€ä¼šå˜æ…¢ã€‚æˆ‘å‡è®¾æƒ…å†µä¸æ˜¯è¿™æ ·(ç°åœ¨æˆ–å°†æ¥),ä½†æ˜¯å› ä¸ºè¿™ä¸€èŠ‚çš„é‡ç‚¹æ˜¯æ‰©å±•æˆ‘ä»¬å…³äºå¼•ç”¨å®Œæ•´æ€§çš„çŸ¥è¯†ï¼Œè€Œä¸æ˜¯å®é™…è°ƒæŸ¥ bugï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ç»§ç»­æŒ–æ˜ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ‰“å¼€æ§åˆ¶å°ï¼Œä½¿ç”¨`psql` :
æ£€æŸ¥è¡¨æ ¼æ˜¯å¦ç›¸äº’é“¾æ¥

```
$ rails dbconsole
psql (10.5)
Type "help" for help.

PracticalDeveloper_development=# \d+ articles
...
Indexes:
    "articles_pkey" PRIMARY KEY, btree (id)
    "index_articles_on_boost_states" gin (boost_states)
    "index_articles_on_featured_number" btree (featured_number)
    "index_articles_on_hotness_score" btree (hotness_score)
    "index_articles_on_published_at" btree (published_at)
    "index_articles_on_slug" btree (slug)
    "index_articles_on_user_id" btree (user_id) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯¥è¡¨æœ‰ä¸€ä¸ªä¸»é”®å’Œä¸€äº›ç´¢å¼•ï¼Œä½†æ˜¾ç„¶æ²¡æœ‰å¤–é”®çº¦æŸ(å‚ç…§å®Œæ•´æ€§çš„æŒ‡æ ‡)ã€‚å°†å…¶ä¸åŒæ—¶åŒ…å«ä»¥ä¸‹ä¸¤é¡¹çš„è¡¨æ ¼è¿›è¡Œæ¯”è¾ƒ:

```
PracticalDeveloper_development=# \d users
...
Indexes:
    "users_pkey" PRIMARY KEY, btree (id)
    "index_users_on_confirmation_token" UNIQUE, btree (confirmation_token)
    "index_users_on_reset_password_token" UNIQUE, btree (reset_password_token)
    "index_users_on_username" UNIQUE, btree (username)
    "index_users_on_language_settings" gin (language_settings)
    "index_users_on_organization_id" btree (organization_id)
Referenced by:
    TABLE "messages" CONSTRAINT "fk_rails_273a25a7a6" FOREIGN KEY (user_id) REFERENCES users(id)
    TABLE "badge_achievements" CONSTRAINT "fk_rails_4a2e48ca67" FOREIGN KEY (user_id) REFERENCES users(id)
    TABLE "chat_channel_memberships" CONSTRAINT "fk_rails_4ba367990a" FOREIGN KEY (user_id) REFERENCES users(id)
    TABLE "push_notification_subscriptions" CONSTRAINT "fk_rails_c0b1e39717" FOREIGN KEY (user_id) REFERENCES users(id) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å°±æ˜¯æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢æ‰€å­¦åˆ°çš„:å½“æ‚¨ä» DB ä¸­åˆ é™¤è¡Œæ—¶ï¼Œä¸ºä»€ä¹ˆå¼•ç”¨å®Œæ•´æ€§ä¼šå‘æŒ¥ä½œç”¨ï¼Œä»¥åŠåœ¨æ•°æ®åº“çº§åˆ«ä¸Š,`articles`è¡¨ä¸ä»»ä½•å…¶ä»–è¡¨æ²¡æœ‰æ˜æ˜¾çš„å…³ç³»ã€‚ä½†æ˜¯åœ¨ web app ä¸­æ˜¯è¿™æ ·å—ï¼Ÿè®©æˆ‘ä»¬å‘ä¸Šç§»åŠ¨ä¸€å±‚ï¼Œæ·±å…¥ Ruby ä»£ç ã€‚

*psã€‚å¯¹äº Rails(ä¸è®°å¾—ä»å“ªä¸ªç‰ˆæœ¬å¼€å§‹äº†)ï¼Œä½ è¿˜å¯ä»¥é€šè¿‡æŸ¥çœ‹ [schema.rb](https://github.com/thepracticaldev/dev.to/blob/master/db/schema.rb) æ–‡ä»¶æ¥æŸ¥çœ‹ä½ å®šä¹‰äº†å“ªäº›å¤–é”®ã€‚*

## [](#activerecord-associations-and-callbacks)ActiveRecordï¼Œå…³è”å’Œå›è°ƒ

ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†ä»€ä¹ˆæ˜¯å‚ç…§å®Œæ•´æ€§ï¼Œå¦‚ä½•è¯†åˆ«å®ƒï¼Œç°åœ¨æˆ‘ä»¬çŸ¥é“å®ƒåœ¨è¿™ä¸ª bug ä¸­ä¸èµ·ä½œç”¨ï¼Œæˆ‘ä»¬å¯ä»¥å‘ä¸Šç§»åŠ¨ä¸€å±‚ï¼Œæ£€æŸ¥å¦‚ä½•å®šä¹‰[æ–‡ç« å¯¹è±¡](https://github.com/thepracticaldev/dev.to/blob/master/app/models/article.rb)(æˆ‘å°†è·³è¿‡æˆ‘è®¤ä¸ºä¸æœ¬æ–‡å’Œ bug æœ¬èº«æ— å…³çš„å†…å®¹ï¼Œå°½ç®¡æˆ‘å¯èƒ½æ˜¯é”™çš„ï¼Œå› ä¸ºæˆ‘ä¸å¤ªäº†è§£ä»£ç åº“):

```
class Article < ApplicationRecord
  # ...

  has_many :comments,       as: :commentable
  has_many :buffer_updates
  has_many :reactions,      as: :reactable, dependent: :destroy
  has_many  :notifications, as: :notifiable

  # ...

  before_destroy    :before_destroy_actions

  # ...

  def before_destroy_actions
    bust_cache
    remove_algolia_index
    reactions.destroy_all
    user.delay.resave_articles
    organization&.delay&.resave_articles
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ®µä»£ç ä¸­çš„ä¸€äº›æ–°ä¿¡æ¯:

*   Rails(ä½†ä¸æ˜¯ DB)çŸ¥é“ä¸€ç¯‡æ–‡ç« å¯ä»¥æœ‰è®¸å¤šè¯„è®ºã€ç¼“å†²åŒºæ›´æ–°ã€ååº”å’Œé€šçŸ¥(åœ¨ Rails è¡Œè¯ä¸­è¿™äº›è¢«ç§°ä¸ºâ€œå…³è”â€)

*   ååº”æ˜æ˜¾ä¾èµ–äºæ–‡ç« ï¼Œå¦‚æœæ–‡ç« è¢«ç§»é™¤ï¼Œå®ƒä»¬å°†è¢«ç ´å

*   åœ¨å¯¹è±¡åŠå…¶åœ¨æ•°æ®åº“ä¸­çš„è¡Œè¢«é”€æ¯ä¹‹å‰ï¼Œæœ‰ä¸€ä¸ªå›è°ƒå‡½æ•°ä¼šåšä¸€äº›äº‹æƒ…(æˆ‘ä»¬å°†åœ¨åé¢æ¢è®¨)

*   å››ä¸ªå…³è”ä¸­æœ‰ä¸‰ä¸ªæ˜¯`able`ç±»å‹ï¼ŒRails ç§°è¿™äº›[å¤šæ€å…³è”ä¸º](https://guides.rubyonrails.org/association_basics.html#polymorphic-associations)ï¼Œå› ä¸ºå®ƒä»¬å…è®¸ç¨‹åºå‘˜ä½¿ç”¨ä¸¤ä¸ªä¸åŒçš„åˆ—(ä¸€ä¸ªåŒ…å«å¯¹è±¡æ‰€å±æ¨¡å‹ç±»å‹åç§°çš„å­—ç¬¦ä¸²å’Œä¸€ä¸ª id)å°†å¤šç§ç±»å‹çš„å¯¹è±¡å…³è”åˆ°åŒä¸€è¡Œã€‚å®ƒä»¬éå¸¸æ–¹ä¾¿ï¼Œå°½ç®¡æˆ‘æ€»è§‰å¾—å®ƒä»¬ä½¿æ•°æ®åº“éå¸¸ä¾èµ–äºåŸŸæ¨¡å‹(ç”± Rails è®¾ç½®)ã€‚ä»–ä»¬è¿˜å¯ä»¥åœ¨å…³è”è¡¨ä¸­è¦æ±‚ä¸€ä¸ª[å¤åˆç´¢å¼•](https://www.postgresql.org/docs/10/static/indexes-multicolumn.html)æ¥åŠ é€ŸæŸ¥è¯¢

ä¸åº•å±‚æ•°æ®åº“ç³»ç»Ÿæ‰€èƒ½åšçš„ç±»ä¼¼ï¼ŒActiveRecord å…è®¸å¼€å‘äººå‘˜æŒ‡å®šå½“ä¸»å¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œç›¸å…³å¯¹è±¡ä¼šå‘ç”Ÿä»€ä¹ˆã€‚æ ¹æ®[æ–‡æ¡£](https://guides.rubyonrails.org/association_basics.html#dependent) Rails æ”¯æŒ:é”€æ¯æ‰€æœ‰ç›¸å…³å¯¹è±¡ã€åˆ é™¤æ‰€æœ‰ç›¸å…³å¯¹è±¡ã€è®¾ç½®å¤–é”®ä¸º`NULL`æˆ–é™åˆ¶åˆ é™¤é”™è¯¯ã€‚*é”€æ¯*å’Œ*åˆ é™¤*çš„åŒºåˆ«åœ¨äºï¼Œåœ¨å‰ä¸€ç§æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ç›¸å…³çš„å›è°ƒéƒ½åœ¨ç§»é™¤ä¹‹å‰æ‰§è¡Œï¼Œåœ¨åä¸€ç§æƒ…å†µä¸‹ï¼Œå›è°ƒè¢«è·³è¿‡ï¼Œåªæœ‰ DB ä¸­çš„è¡Œè¢«ç§»é™¤ã€‚

å¯¹äºæ²¡æœ‰`dependent`çš„å…³ç³»ï¼Œ[é»˜è®¤ç­–ç•¥](https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#module-ActiveRecord::Associations::ClassMethods-label-Delete+or+destroy%3F)æ˜¯ä»€ä¹ˆéƒ½ä¸åšï¼Œè¿™æ„å‘³ç€å°†è¢«å¼•ç”¨çš„è¡Œç•™åœ¨åŸå¤„ã€‚å¦‚æœç”±æˆ‘å†³å®šï¼Œé»˜è®¤å°†æ˜¯*è¯¥åº”ç”¨ç¨‹åºä¸ä¼šå¯åŠ¨ï¼Œç›´åˆ°ä½ å†³å®šå¦‚ä½•å¤„ç†é“¾æ¥çš„æ¨¡å‹*ï¼Œä½†æˆ‘ä¸æ˜¯è®¾è®¡ ActiveRecord çš„äººã€‚

è¯·è®°ä½ï¼Œæ•°æ®åº“èƒœè¿‡ä»£ç ï¼Œå¦‚æœæ‚¨åœ¨ Rails çº§åˆ«æ²¡æœ‰å®šä¹‰ä»»ä½•ä¸œè¥¿ï¼Œä½†æ˜¯æ•°æ®åº“è¢«é…ç½®ä¸ºè‡ªåŠ¨é”€æ¯æ‰€æœ‰ç›¸å…³çš„è¡Œï¼Œé‚£ä¹ˆè¿™äº›è¡Œå°†è¢«é”€æ¯ã€‚è¿™æ˜¯å€¼å¾—èŠ±æ—¶é—´å­¦ä¹  DB å¦‚ä½•å·¥ä½œçš„ä¼—å¤šåŸå› ä¹‹ä¸€:-)

å…³äºæ¨¡å‹å±‚ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰è°ˆåˆ°çš„æœ€åä¸€ç‚¹æ˜¯å›è°ƒï¼Œè¿™å¯èƒ½æ˜¯ bug å‡ºç°çš„åœ°æ–¹ã€‚

### [](#the-infamous-callback)å£°åç‹¼è—‰çš„å›è°ƒ

è¿™ä¸ªåœ¨é”€æ¯ä¹‹å‰çš„*å›è°ƒå°†åœ¨å‘æ•°æ®åº“å‘å‡º`DELETE`è¯­å¥ä¹‹å‰æ‰§è¡Œ:* 

```
def before_destroy_actions
  bust_cache
  remove_algolia_index
  reactions.destroy_all
  user.delay.resave_articles
  organization&.delay&.resave_articles
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

#### [](#cache-busting)ç¼“å­˜ç ´å

å›è°ƒåšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯è°ƒç”¨æ–¹æ³•`bust_cache`ï¼Œæ–¹æ³•[ä¾æ¬¡è°ƒç”¨å…­æ¬¡ Fastly API](https://github.com/thepracticaldev/dev.to/blob/master/app/labor/cache_buster.rb#L6) æ¥æ¸…é™¤æ–‡ç« çš„ç¼“å­˜(æ¯æ¬¡è°ƒç”¨ bust éƒ½æ˜¯ä¸¤æ¬¡ HTTP è°ƒç”¨)ã€‚å®ƒè¿˜å¯¹åŒä¸€ä¸ª API è¿›è¡Œäº†å¤§é‡çš„è¿›ç¨‹å¤–è°ƒç”¨(å¤§çº¦ 20-50 æ¬¡ï¼Œå–å†³äºæ–‡ç« çš„çŠ¶æ€å’Œæ ‡ç­¾çš„æ•°é‡)ï¼Œä½†è¿™äº›éƒ½æ— å…³ç´§è¦ï¼Œå› ä¸ºç”¨æˆ·ä¸ä¼šç­‰å¾…å®ƒä»¬ã€‚

æœ‰ä¸€ç‚¹éœ€è¦æ³¨é‡Š:å…­ä¸ª HTTP è°ƒç”¨æ˜¯*åœ¨ä½ æŒ‰ä¸‹æŒ‰é’®åˆ é™¤ä¸€ç¯‡æ–‡ç« åæ€»æ˜¯*å‡ºå»ã€‚

#### [](#index-removal)ç´¢å¼•åˆ é™¤

dev.to ä½¿ç”¨ Algolia è¿›è¡Œæœç´¢ï¼Œè°ƒç”¨`remove_algolia_index`æ‰§è¡Œä»¥ä¸‹æ“ä½œ:

*   è°ƒç”¨ [algolia_remove_from_index](https://github.com/algolia/algoliasearch-rails/blob/25436b69de166b60eb220890e2eb8a07ed65ac82/lib/algoliasearch-rails.rb#L587)è¿›è€Œè°ƒç”¨ Algolia HTTP API çš„â€œå¼‚æ­¥â€ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬å®é™…ä¸Šä¼šå¯¹ Algolia è¿›è¡Œ[(å¿«é€Ÿ)åŒæ­¥è°ƒç”¨ï¼Œè€Œæ— éœ€ç­‰å¾…ç´¢å¼•åœ¨å®ƒä»¬é‚£ç«¯è¢«æ¸…é™¤ã€‚è¿™ä»ç„¶æ˜¯ä¸€ä¸ªåŒæ­¥å‘¼å«ä¸»é¢˜ï¼Œå¢åŠ äº†ç”¨æˆ·çš„ç­‰å¾…æ—¶é—´](https://github.com/algolia/algoliasearch-client-ruby/blob/2dcf070e2b9f4f446a85d1abf494269acc4dec42/lib/algolia/client.rb#L518)

*   ä¸ºå…¶ä»–ç´¢å¼•è°ƒç”¨ Algolia çš„ HTTP API å¦å¤–ä¸¤æ¬¡

å› æ­¤ï¼ŒåŠ ä¸Šä¹‹å‰å¯¹ Fastly çš„ 6 ä¸ª HTTP è°ƒç”¨ï¼Œæˆ‘ä»¬åœ¨è¿›ç¨‹ä¸­è°ƒç”¨äº† 9 ä¸ª API

#### [](#reactions-destruction)ååº”ç ´å

ç¬¬ä¸‰æ­¥æ˜¯`reactions.destroy_all`,é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æ‘§æ¯å¯¹æ–‡ç« çš„æ‰€æœ‰ååº”ã€‚åœ¨ Rails `destroy_all`ä¸­ï¼Œç®€å•åœ°è¿­ä»£æ‰€æœ‰å¯¹è±¡ï¼Œå¹¶å¯¹æ¯ä¸ªå¯¹è±¡è°ƒç”¨ destroyï¼Œç„¶åæ¿€æ´»æ‰€æœ‰çš„â€œdestroyâ€å›è°ƒå‡½æ•°è¿›è¡Œé€‚å½“çš„æ¸…ç†ã€‚[ååº”](https://github.com/thepracticaldev/dev.to/blob/master/app/models/reaction.rb)æ¨¡å¼æœ‰ä¸¤ä¸ª`before_destroy`å›è°ƒ:

```
class Reaction < ApplicationRecord
  # ...

  before_destroy :update_reactable_without_delay
  before_destroy :clean_up_before_destroy

  # ...
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä¸å¾—ä¸ç¨å¾®æŒ–æ˜ä¸€ä¸‹ï¼Œçœ‹çœ‹ç¬¬ä¸€ä¸ªæ˜¯åšä»€ä¹ˆçš„(æˆ‘ä¸å–œæ¬¢ Rails åšäº‹æ–¹å¼çš„ä¸€ä¸ªåŸå› æ˜¯åˆ°å¤„å‡ºç°çš„ç¥å¥‡æ–¹æ³•ï¼Œå®ƒä»¬ä½¿é‡æ„æ›´åŠ å›°éš¾ï¼Œå¹¶ä¸”å®ƒä»¬é¼“åŠ±æ¨¡å‹å’Œæ‰€æœ‰å„ç§å®çŸ³ä¹‹é—´çš„è€¦åˆ)ã€‚`update_reactable_without_delay`ç»•è¿‡é˜Ÿåˆ—è°ƒç”¨ [update_reactable](https://github.com/thepracticaldev/dev.to/blob/master/app/models/reaction.rb#L76) (é»˜è®¤æƒ…å†µä¸‹å·²ç»å£°æ˜ä¸ºå¼‚æ­¥å‡½æ•°)ã€‚ç»“æœæ˜¯ç”¨æˆ·ç­‰å¾…çš„æ ‡å‡†å†…è”å‘¼å«ã€‚

*   å¦‚æœæ–‡ç« å·²ç»å‘è¡¨ï¼Œåˆ™é‡æ–°è®¡ç®—(è¿™ä¸€æ¬¡åœ¨è¿›ç¨‹ä¹‹å¤–)æ–‡ç« çš„åˆ†æ•°(è¿™æ˜¯åº”è¯¥é¿å…çš„äº‹æƒ…ï¼Œå› ä¸ºæ–‡ç« å°†è¢«åˆ é™¤)ã€‚ç„¶å(åå‘å†…è”)å®ƒè°ƒç”¨ Algolia é‡æ–°ç´¢å¼•æ–‡ç« (ä¸¤æ¬¡)ï¼Œä» Fastly çš„ç¼“å­˜ä¸­åˆ é™¤ååº”(æ¯ä¸ªç ´åç¼“å­˜çš„è°ƒç”¨æ˜¯ä¸¤ä¸ª Fastly çš„è°ƒç”¨)ï¼Œç ´åå¦ä¸€ä¸ªç¼“å­˜(ä¸¤ä¸ªä»¥ä¸Šçš„ HTTP è°ƒç”¨)ï¼Œå¹¶å¯èƒ½æ›´æ–°æ–‡ç« ä¸Šçš„ä¸€ä¸ªåˆ—(å¯èƒ½ä¸éœ€è¦ï¼Œå› ä¸ºå®ƒå°†è¢«åˆ é™¤)ã€‚æ€»å…±æœ‰ 6 ä¸ª HTTP è°ƒç”¨:ä¸€ä¸ªå¼‚æ­¥ HTTP è°ƒç”¨(ç¬¬ä¸€ä¸ªè°ƒç”¨åˆ° Algolia)ï¼Œå¦ä¸€ä¸ªè°ƒç”¨åˆ° Algoliaï¼Œå››ä¸ªè°ƒç”¨åˆ° Fastlyã€‚è®©æˆ‘ä»¬æ³¨é‡Šä¸‹ç”¨æˆ·å¿…é¡»ç­‰å¾…çš„ 5ã€‚

*   å¯¹ Algolia çš„æ–‡ç« è¿›è¡Œäº†é‡æ–°ç´¢å¼•(ç¬¬ä¸‰æ¬¡)ã€‚

è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹:ç§»é™¤ä¸€ä¸ªååº”ç›¸å½“äº 6 æ¬¡ HTTP è°ƒç”¨ã€‚å¦‚æœæ–‡ç« æœ‰ 100 ä¸ªååº”...ä½ å¯ä»¥ç®—ä¸€ä¸‹ã€‚

å‡è®¾è¿™ç¯‡æ–‡ç« æœ‰ 1 ä¸ªåé¦ˆï¼ŒåŠ ä¸Šä¹‹å‰ç»Ÿè®¡çš„ 15 ä¸ª HTTP è°ƒç”¨:

*   6 .ç ´è§£æ–‡ç« çš„ç¼“å­˜

*   3 ä»ç´¢å¼•ä¸­åˆ é™¤æ–‡ç« 

*   6 å¯¹äºé™„åœ¨æ–‡ç« ä¸Šçš„ååº”

è¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„é¢å¤–çš„ HTTP è°ƒç”¨ï¼Œæˆ‘å¶ç„¶å‘ç°å®ƒä½¿ç”¨äº†ä¸€ä¸ª[è¦ç‚¹æ¥è°ƒè¯• net/http è°ƒç”¨](https://gist.github.com/ahoward/736721)ï¼Œå®ƒè°ƒç”¨äº† [Stream.io API](https://github.com/GetStream/stream-rails#activerecord) æ¥åˆ é™¤ç”¨æˆ·æè¦ä¸­çš„ååº”ã€‚æ€»å…± 16 æ¬¡ HTTP è°ƒç”¨ã€‚

è¿™å°±æ˜¯å½“ä¸€ä¸ªååº”è¢«ç ´åæ—¶å‘ç”Ÿçš„äº‹æƒ…(æˆ‘åœ¨æˆ‘çš„æœ¬åœ°å®‰è£…ä¸­æ·»åŠ äº†ä»¤äººæ•¬ç•çš„ gem[http log](https://github.com/trusche/httplog):

```
[httplog] Sending: PUT https://REDACTED.algolia.net/1/indexes/Article_development/25
[httplog] Data: {"title":" The Curious Incident of the Dog in the Night-Time"}
[httplog] Connecting: REDACTED.algolia.net:443
[httplog] Status: 200
[httplog] Benchmark: 0.357128 seconds
[httplog] Response:
{"updatedAt":"2018-10-09T17:23:44.151Z","taskID":945887592,"objectID":"25"}

[httplog] Sending: PUT https://REDACTED.algolia.net/1/indexes/searchables_development/articles-25
[httplog] Data: {"title":" The Curious Incident of the Dog in the Night-Time","tag_list":["discuss","security","python","beginners"],"main_image":"https://pigment.github.io/fake-logos/logos/medium/color/8.png","id":25,"featured":true,"published":true,"published_at":"2018-09-30T07:44:48.530Z","featured_number":1538293488,"comments_count":1,"reactions_count":0,"positive_reactions_count":0,"path":"/willricki/-the-curious-incident-of-the-dog-in-the-night-time-3e4b","class_name":"Article","user_name":"Ricki Will","user_username":"willricki","comments_blob":"Waistcoat craft beer pickled vice seitan kombucha drinking. 90's green juice hoodie.","body_text":"\n\nMeggings tattooed normcore kitsch chia. Fixie migas etsy hashtag jean shorts neutra pork belly. Vice salvia biodiesel portland actually slow-carb loko chia. Freegan biodiesel flexitarian tattooed.\n\n\nNeque. \n\n\nBefore they sold out diy xoxo aesthetic biodiesel pbr\u0026amp;b. Tumblr lo-fi craft beer listicle. Lo-fi church-key cold-pressed.\n\n\n","tag_keywords_for_search":"","search_score":153832,"readable_publish_date":"Sep 30","flare_tag":{"name":"discuss","bg_color_hex":null,"text_color_hex":null},"user":{"username":"willricki","name":"Ricki Will","profile_image_90":"/uploads/user/profile_image/6/22018b1a-7afa-47c1-bbae-b829977828e4.png"},"_tags":["discuss","security","python","beginners","user_6","username_willricki","lang_en"]}
[httplog] Status: 200
[httplog] Benchmark: 0.031995 seconds
[httplog] Response:
{"updatedAt":"2018-10-09T17:23:44.426Z","taskID":945887612,"objectID":"articles-25"}

[httplog] Sending: PUT https://REDACTED.algolia.net/1/indexes/ordered_articles_development/articles-25
[httplog] Data: {"title":" The Curious Incident of the Dog in the Night-Time","path":"/willricki/-the-curious-incident-of-the-dog-in-the-night-time-3e4b","class_name":"Article","comments_count":1,"tag_list":["discuss","security","python","beginners"],"positive_reactions_count":0,"id":25,"hotness_score":153829,"readable_publish_date":"Sep 30","flare_tag":{"name":"discuss","bg_color_hex":null,"text_color_hex":null},"published_at_int":1538293488,"user":{"username":"willricki","name":"Ricki Will","profile_image_90":"/uploads/user/profile_image/6/22018b1a-7afa-47c1-bbae-b829977828e4.png"},"_tags":["discuss","security","python","beginners","user_6","username_willricki","lang_en"]}
[httplog] Status: 200
[httplog] Benchmark: 0.047077 seconds
[httplog] Response:
{"updatedAt":"2018-10-09T17:23:44.494Z","taskID":945887622,"objectID":"articles-25"}

[httplog] Sending: PUT https://REDACTED.algolia.net/1/indexes/Article_development/25
[httplog] Data: {"title":" The Curious Incident of the Dog in the Night-Time"}
[httplog] Status: 200
[httplog] Benchmark: 0.029352 seconds
[httplog] Response:
{"updatedAt":"2018-10-09T17:23:44.541Z","taskID":945887632,"objectID":"25"}

[httplog] Sending: PUT https://REDACTED.algolia.net/1/indexes/searchables_development/articles-25
[httplog] Data: {"title":" The Curious Incident of the Dog in the Night-Time","tag_list":["discuss","security","python","beginners"],"main_image":"https://pigment.github.io/fake-logos/logos/medium/color/8.png","id":25,"featured":true,"published":true,"published_at":"2018-09-30T07:44:48.530Z","featured_number":1538293488,"comments_count":1,"reactions_count":0,"positive_reactions_count":1,"path":"/willricki/-the-curious-incident-of-the-dog-in-the-night-time-3e4b","class_name":"Article","user_name":"Ricki Will","user_username":"willricki","comments_blob":"Waistcoat craft beer pickled vice seitan kombucha drinking. 90's green juice hoodie.","body_text":"\n\nMeggings tattooed normcore kitsch chia. Fixie migas etsy hashtag jean shorts neutra pork belly. Vice salvia biodiesel portland actually slow-carb loko chia. Freegan biodiesel flexitarian tattooed.\n\n\nNeque. \n\n\nBefore they sold out diy xoxo aesthetic biodiesel pbr\u0026amp;b. Tumblr lo-fi craft beer listicle. Lo-fi church-key cold-pressed.\n\n\n","tag_keywords_for_search":"","search_score":154132,"readable_publish_date":"Sep 30","flare_tag":{"name":"discuss","bg_color_hex":null,"text_color_hex":null},"user":{"username":"willricki","name":"Ricki Will","profile_image_90":"/uploads/user/profile_image/6/22018b1a-7afa-47c1-bbae-b829977828e4.png"},"_tags":["discuss","security","python","beginners","user_6","username_willricki","lang_en"]}
[httplog] Status: 200
[httplog] Benchmark: 0.028819 seconds
[httplog] Response:
{"updatedAt":"2018-10-09T17:23:44.612Z","taskID":945887642,"objectID":"articles-25"}

[httplog] Sending: PUT https://REDACTED.algolia.net/1/indexes/ordered_articles_development/articles-25
[httplog] Data: {"title":" The Curious Incident of the Dog in the Night-Time","path":"/willricki/-the-curious-incident-of-the-dog-in-the-night-time-3e4b","class_name":"Article","comments_count":1,"tag_list":["discuss","security","python","beginners"],"positive_reactions_count":1,"id":25,"hotness_score":153829,"readable_publish_date":"Sep 30","flare_tag":{"name":"discuss","bg_color_hex":null,"text_color_hex":null},"published_at_int":1538293488,"user":{"username":"willricki","name":"Ricki Will","profile_image_90":"/uploads/user/profile_image/6/22018b1a-7afa-47c1-bbae-b829977828e4.png"},"_tags":["discuss","security","python","beginners","user_6","username_willricki","lang_en"]}
[httplog] Status: 200
[httplog] Benchmark: 0.02821 seconds
[httplog] Response:
{"updatedAt":"2018-10-09T17:23:44.652Z","taskID":945887652,"objectID":"articles-25"}

[httplog] Connecting: us-east-api.stream-io-api.com:443
[httplog] Sending: DELETE http://us-east-api.stream-io-api.com:443/api/v1.0/feed/user/10/Reaction:7/?api_key=REDACTED&foreign_id=1
[httplog] Data:
[httplog] Status: 200
[httplog] Benchmark: 0.336152 seconds
[httplog] Response:
{"removed":"Reaction:7","duration":"17.84ms"} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœä½ æ•°ä»–ä»¬ï¼Œä»–ä»¬æ˜¯ 7 å²ï¼Œè€Œä¸æ˜¯ 16 å²ã€‚è¿™æ˜¯å› ä¸ºå¯¹ Fastly çš„è°ƒç”¨åªåœ¨ç”Ÿäº§ä¸­æ‰§è¡Œã€‚

#### [](#resaving-articles)ä¿å­˜æ–‡ç« 

[User.resave_articles](https://github.com/thepracticaldev/dev.to/blob/master/app/models/user.rb#L338) åˆ·æ–°ç”¨æˆ·çš„å…¶ä»–æ–‡ç« ï¼Œå¹¶åœ¨è¿›ç¨‹å¤–è¢«è°ƒç”¨ï¼Œå› æ­¤æˆ‘ä»¬ç°åœ¨å¯¹å®ƒä¸æ„Ÿå…´è¶£ã€‚å¦‚æœæ–‡ç« æ˜¯ä¸€ä¸ªç»„ç»‡çš„ä¸€éƒ¨åˆ†ï¼ŒåŒæ ·çš„æƒ…å†µä¹Ÿä¼šå‘ç”Ÿï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸åœ¨ä¹ã€‚

è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬æ‰€çŸ¥é“çš„ã€‚æ¯ç¯‡æ–‡ç« çš„åˆ é™¤éƒ½ä¼šè§¦å‘ä¸€ä¸ªå›è°ƒï¼Œè¿™ä¸ªå›è°ƒä¼šåšå¾ˆå¤šæ¶‰åŠç¬¬ä¸‰æ–¹æœåŠ¡çš„äº‹æƒ…ï¼Œå¸®åŠ©è¿™ä¸ªç½‘ç«™å°½å¯èƒ½å¿«åœ°è¿è¡Œï¼Œå®ƒè¿˜ä¼šæ›´æ–°å„ç§è®¡æ•°å™¨ï¼Œæˆ‘å¹¶æ²¡æœ‰çœŸæ­£ç ”ç©¶è¿‡è¿™äº›è®¡æ•°å™¨:-Dã€‚

### [](#what-happens-when-the-article-is-removed)æ–‡ç« åˆ é™¤åä¼šå‘ç”Ÿä»€ä¹ˆ

åœ¨å¤„ç†å®Œå›è°ƒï¼Œæ‰€æœ‰ä¸åŒçš„ç¼“å­˜éƒ½æ˜¯æœ€æ–°çš„ï¼Œæ•°æ®åº“ä¸­çš„ååº”éƒ½æ¶ˆå¤±äº†ä¹‹åï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦æ£€æŸ¥æˆ‘ä»¬è¦åˆ é™¤çš„æ–‡ç« çš„å…¶ä»–å…³è”å‘ç”Ÿäº†ä»€ä¹ˆã€‚æ­£å¦‚æ‚¨æ‰€è®°å¾—çš„ï¼Œæ¯ç¯‡æ–‡ç« éƒ½å¯èƒ½æœ‰è¯„è®ºã€ååº”(ç°åœ¨å·²ç»æ²¡æœ‰äº†)ã€ç¼“å†²åŒºæ›´æ–°(ä¸ç¡®å®šå®ƒä»¬æ˜¯ä»€ä¹ˆ)å’Œé€šçŸ¥ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹é”€æ¯ä¸€ç¯‡æ–‡ç« ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œçœ‹èƒ½ä¸èƒ½å¾—åˆ°å…¶ä»–çº¿ç´¢ã€‚æˆ‘ç”¨æˆ‘çš„æ€»ç»“ä»£æ›¿äº†ä¸€ç¯‡é•¿æ—¥å¿—:

```
> art = Article.last # article id 25
> art.destroy!
# its tags are destroyed, this is handled by "acts_as_taggable_on :tags"...
# a bunch of other tag related stuff happens, 17 select calls...
# the aforamentioned HTTP calls for each reaction are here too...
# there's a SQL DELETE for each reaction...
# the user object is updated...
# a couple of other UPDATEs I didn't investigate but which seem really plausible...
# the HTTP calls to remove the article itself from search...
# the article is finally deleted from the db...
# the article count for the user is updated 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é™¤äº†åœ¨æˆ‘æœ€åˆçš„æ¦‚è¿°ä¸­æˆ‘å®Œå…¨å¿˜è®°äº†æ ‡ç­¾çš„é”€æ¯(å®ƒä»¬ç›¸å½“äºæ•°æ®åº“ä¸­çš„ä¸€ä¸ª`DELETE`å’Œä¸€ä¸ª`UPDATE`)ä¹‹å¤–ï¼Œæˆ‘è¦è¯´å½“ä¸€ç¯‡æ–‡ç« è¢«åˆ é™¤æ—¶ä¼šå‘ç”Ÿå¾ˆå¤šäº‹æƒ…ã€‚

æˆ‘ä»¬åœ¨æ§åˆ¶å°ä¸­æ²¡æœ‰æ‰¾åˆ°çš„å…¶ä»–å¯¹è±¡ä¼šæ€ä¹ˆæ ·ï¼Ÿ

å¦‚æœæ‚¨è¿˜è®°å¾—æˆ‘å‰é¢è¯´è¿‡çš„è¯ï¼Œåœ¨ Rails å…³ç³»ä¸­ï¼Œæ‰€æœ‰æ²¡æœ‰è¢«æ˜ç¡®æ ‡è®°ä¸ºâ€œä¾èµ–â€çš„ä¸œè¥¿åœ¨ä¸»å¯¹è±¡é”€æ¯åä»ç„¶å­˜åœ¨ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½åœ¨ DB:

```
PracticalDeveloper_development=# select count(*) from comments where commentable_id = 25;
 count
-------
     3
PracticalDeveloper_development=# select count(*) from notifications where notifiable_id = 25;
 count
-------
     2
PracticalDeveloper_development=# select count(*) from buffer_updates where article_id = 25;
 count
-------
     1 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘è®¤ä¸ºæˆ‘ä»¬å¯ä»¥æœ‰ä¸€ç‚¹ä¿¡å¿ƒï¼Œå¦‚æœè¿™ç¯‡æ–‡ç« åœ¨è¢«åˆ é™¤ä¹‹å‰çœŸçš„å¾ˆå—æ¬¢è¿ï¼Œæœ‰å¾ˆå¤šååº”ã€è¯„è®ºå’Œé€šçŸ¥ï¼Œé‚£ä¹ˆå¼•å‘è¿™ç¯‡æ–‡ç« çš„é—®é¢˜å¾ˆå¯èƒ½ä¼šå‡ºç°ã€‚

### [](#timeout)è¶…æ—¶

æˆ‘åœ¨å¯¹è¿™ä¸ªé—®é¢˜çš„è¯„è®ºä¸­æåˆ°çš„å¦ä¸€ä¸ªå› ç´ æ˜¯ Heroku çš„é»˜è®¤è¶…æ—¶è®¾ç½®ã€‚dev.to IIRC åœ¨ Heroku ä¸Šè¿è¡Œï¼Œä¸€æ—¦è·¯ç”±å™¨å¤„ç†äº† HTTP è°ƒç”¨ï¼Œå®ƒå°±æœ‰ä¸€ä¸ª 30 ç§’çš„è¶…æ—¶(æ‰€ä»¥å®ƒæ˜¯ä½ çš„åº”ç”¨ç¨‹åºä»£ç çš„è®¡æ—¶å™¨)ã€‚å¦‚æœåº”ç”¨ç¨‹åºåœ¨ 30 ç§’å†…æ²¡æœ‰å“åº”ï¼Œå®ƒä¼šè¶…æ—¶å¹¶å‘é€ä¸€ä¸ªé”™è¯¯ã€‚

dev.to èªæ˜åœ°ä½¿ç”¨[æœºæ¶è¶…æ—¶](https://github.com/heroku/rack-timeout#rails-apps)é»˜è®¤æœåŠ¡è¶…æ—¶(15 ç§’)å°†è¯¥è¶…æ—¶å‡åŠã€‚

ç®€è€Œè¨€ä¹‹:å¦‚æœç‚¹å‡»â€œåˆ é™¤æ–‡ç« â€æŒ‰é’®åï¼ŒæœåŠ¡å™¨æ²¡æœ‰åœ¨ 15 ç§’å†…å®Œæˆï¼Œå°±ä¼šå‡ºç°è¶…æ—¶é”™è¯¯ã€‚çœ‹åˆ°ä¸€ç¯‡å—æ¬¢è¿çš„æ–‡ç« å¯èƒ½ä¼šè§¦å‘å‡ åä¸ª HTTP è°ƒç”¨ï¼Œä½ å°±èƒ½ç†è§£ä¸ºä»€ä¹ˆåœ¨æŸäº›æƒ…å†µä¸‹ 15 ç§’å¢™ä¼šè¢«æ‰“ç ´ã€‚

## [](#recap)é‡è¿°

è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬æ‰€äº†è§£åˆ°çš„å½“ä¸€ç¯‡æ–‡ç« è¢«åˆ é™¤æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ:

*   å¦‚æœæ–‡ç« æœ‰æ•°ç™¾ä¸‡ä¸ªç›¸å…³è¡Œ(åœ¨è¿™ç§æƒ…å†µä¸‹ä¸å¤ªå¯èƒ½)ï¼Œå¼•ç”¨å®Œæ•´æ€§å¯èƒ½æ˜¯ä¸€ä¸ªå› ç´ 

*   Rails é¡ºåºåˆ é™¤ç›¸å…³çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå› ç´ (è€ƒè™‘åˆ°åœ¨åˆ é™¤è¿™äº›å¯¹è±¡ä¹‹å‰ï¼Œå®ƒè¿˜å¿…é¡»å°†è¿™äº›å¯¹è±¡ä» DB åŠ è½½åˆ° ORMï¼Œå› ä¸ºå¦‚æœå®ƒæƒ³è¦è§¦å‘å„ç§å›è°ƒï¼Œå®ƒå¿…é¡»è¿™æ ·åš)

*   å†…è”å›è°ƒå’Œ HTTP è°ƒç”¨æ˜¯å¦ä¸€ä¸ªå› ç´ 

*   Rails ä¸€ç‚¹ä¹Ÿä¸èªæ˜ï¼Œå› ä¸ºå®ƒå¯ä»¥å‡å°‘å¯¹ DB çš„è°ƒç”¨é‡(ä¾‹å¦‚é€šè¿‡ç¼“å†²æ‰€æœ‰ååº”çš„`DELETE`è¯­å¥ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ª`IN`å­å¥)

*   Rails é­”æ³•æœ‰æ—¶å¾ˆçƒ¦äººğŸ˜›

## [](#possible-solutions)å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ

è¿™æ˜¯æˆ‘ç°åœ¨åœä¸‹æ¥çš„åœ°æ–¹ï¼Œå› ä¸ºæˆ‘ä¸ç†Ÿæ‚‰ä»£ç åº“(å—¯ï¼Œåœ¨è¿™ä¹‹åè‚¯å®šæ›´:D)ï¼Œå› ä¸ºæˆ‘è®¤ä¸ºè¿™å¯èƒ½æ˜¯ä¸€ä¸ªæœ‰è¶£çš„â€œé›†ä½“â€ç»ƒä¹ ï¼Œå› ä¸ºå®ƒä¸æ˜¯ä¸€ä¸ªéœ€è¦â€œæ˜¨å¤©â€ä¿®å¤çš„å…³é”®é”™è¯¯ã€‚

é¦–å…ˆï¼Œäººä»¬è„‘æµ·ä¸­å¯èƒ½å‡ºç°çš„æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œé€šè¿‡å°†æ‰€æœ‰äº‹æƒ…å§”æ‰˜ç»™é˜Ÿåˆ—ç®¡ç†å™¨å°†æ‹¾å–çš„ä½œä¸šï¼Œæ¥ç§»åŠ¨åœ¨è¿›ç¨‹å¤–è°ƒç”¨ä¸­åˆ é™¤æ–‡ç« æ—¶å†…è”å‘ç”Ÿçš„æ‰€æœ‰äº‹æƒ…ã€‚ç”¨æˆ·åªéœ€è¦æ–‡ç« ä»ä»–ä»¬çš„è§†é‡ä¸­æ¶ˆå¤±ã€‚æ­£ç¡®çš„ç§»é™¤å¯ä»¥é€šè¿‡å·¥ä½œè¿›ç¨‹è¿›è¡Œã€‚é™¤äº†æˆ‘ä¸ç¡®å®šæˆ‘è€ƒè™‘äº†æ‰€æœ‰æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…(æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œæˆ‘å¶ç„¶å‘ç°äº†æ ‡ç­¾)å’Œæ‰€æœ‰çš„å½±å“ï¼Œæˆ‘è®¤ä¸ºè¿™åªæ˜¯ä¸€ä¸ªå¿«é€Ÿçš„èƒœåˆ©ã€‚å®ƒå¯ä»¥é€šè¿‡æ©ç›–æŠ¥å‘Šçš„é—®é¢˜æ¥è§£å†³ç”¨æˆ·çš„é—®é¢˜ã€‚

å¦ä¸€ä¸ªå¯èƒ½çš„è§£å†³æ–¹æ¡ˆæ˜¯å°†åˆ é™¤åˆ†ä¸ºä¸¤ä¸ªä¸»è¦éƒ¨åˆ†:éœ€è¦æ›´æ–°æˆ–æ¸…ç©ºç¼“å­˜ï¼Œéœ€è¦ä» DB ä¸­åˆ é™¤è¡Œã€‚ç¼“å­˜éƒ½å¯ä»¥åœ¨è¿›ç¨‹å¤–é”€æ¯ï¼Œè¿™æ ·ç”¨æˆ·å°±ä¸å¿…ç­‰å¾… Fastly æˆ– Algolia(ä¹Ÿè®¸åªæœ‰ Stream.ioï¼Ÿæˆ‘ä¸çŸ¥é“)ã€‚è¿™éœ€è¦ä¸€ç‚¹é‡æ„ï¼Œå› ä¸ºæˆ‘è°ˆåˆ°çš„ä¸€äº›ä»£ç ä¹Ÿè¢«åº”ç”¨ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ä½¿ç”¨ã€‚

ä¸€ä¸ªæ›´å®Œæ•´çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨ç¬¬äºŒä¸ªè§£å†³æ–¹æ¡ˆçš„åŸºç¡€ä¸Šæ›´è¿›ä¸€æ­¥ï¼ŒåŒæ—¶æ¸…ç†æ‰€æœ‰å‰©ä½™çš„å†…å®¹(æ³¨é‡Šã€é€šçŸ¥å’Œç¼“å†²åŒºæ›´æ–°)ï¼Œä½†æ˜¯å®ƒä»¬ç•™åœ¨é‚£é‡Œå¯èƒ½æ˜¯æœ‰åŸå› çš„ã€‚æ‰€æœ‰è¿™ä¸‰ä¸ªå®ä½“éƒ½å¯ä»¥åœ¨ä¸€ä¸ªå•ç‹¬çš„ä½œä¸šä¸­åˆ é™¤ï¼Œå› ä¸ºä¸‰ä¸ªå®ä½“ä¸­æœ‰ä¸¤ä¸ªåœ¨ destroy å›è°ƒä¹‹å‰æœ‰*ï¼Œè¿™äº›å›è°ƒè§¦å‘äº†æˆ‘è¿˜æ²¡æœ‰çœ‹åˆ°çš„å…¶ä»–ä¸œè¥¿ã€‚*

è¿™å¯¹ç”¨æˆ·æ¥è¯´åº”è¯¥è¶³å¤Ÿäº†ï¼Œå†ä¹Ÿä¸ä¼šé‡åˆ°è®¨åŒçš„è¶…æ—¶é”™è¯¯ã€‚ä¸ºäº†æ›´è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç ”ç©¶ ActiveRecord ä¸ºå®ƒä»æ•°æ®åº“ä¸­ç§»é™¤çš„æ¯ä¸ªå¯¹è±¡å‘å‡ºä¸€ä¸ªå•ç‹¬çš„`DELETE`çš„äº‹å®ï¼Œä½†æ˜¯è¿™å¯¹äºç°åœ¨æ¥è¯´è‚¯å®šå¤ªå¤šäº†ã€‚å¦‚æœéœ€è¦çš„è¯ï¼Œæˆ‘ä¼šåœ¨æŸå¤„å¯¹æ­¤è¿›è¡Œæ³¨é‡Šï¼Œå¹¶åœ¨é‡æ„åå†å›æ¥è®¨è®ºã€‚

## [](#conclusions)ç»“è®º

å¦‚æœä½ è¿˜å’Œæˆ‘åœ¨ä¸€èµ·ï¼Œè°¢è°¢ã€‚æˆ‘èŠ±äº†å¾ˆé•¿æ—¶é—´æ¥å†™è¿™ä¸ª:-D

æˆ‘æ²¡æœ‰ä»»ä½•å¼ºæœ‰åŠ›çš„ç»“è®ºã€‚æˆ‘å¸Œæœ›å¯¹ dev.to æºä»£ç çš„æ·±å…¥ç ”ç©¶è‡³å°‘æœ‰æ‰€å¸®åŠ©ã€‚å¯¹æˆ‘æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ–¹å¼æ¥å­¦ä¹ æ›´å¤šçš„ä¸œè¥¿ï¼Œå¹¶å†™ä¸€äº›é Rails å¼€å‘äººå‘˜å¯èƒ½ä¸çŸ¥é“çš„ä¸œè¥¿ï¼Œä½†æ›´é‡è¦çš„æ˜¯å¸®åŠ©æ½œåœ¨çš„è´¡çŒ®è€…ã€‚

æˆ‘å½“ç„¶å¸Œæœ›å¾—åˆ°ä¸€äº›åé¦ˆï¼›-)