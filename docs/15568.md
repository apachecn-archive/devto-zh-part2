# 微服务边界:指导设计的 5 个特征

> 原文:[https://dev . to/jakelumetta/microservice-boundaries-5-characters-to-guide-your-design-5396](https://dev.to/jakelumetta/microservice-boundaries-5-characteristics-to-guide-your-design-5396)

## 你的微服务是不是太小了？耦合太紧？本设计指南可以提供帮助。

Web 组件是微前端的核心概念:一种设计类似于微服务架构的复杂前端应用程序的新方法。使用微服务架构，我们可以使用 [Web 组件来创建微应用](https://buttercms.com/blog/using-web-components-with-buttercms)，每个应用都有特定的任务。查看[我们的帖子](https://buttercms.com/blog/using-web-components-with-buttercms)了解更多

在 SparkPost 的早期，SparkPost 的工程副总裁克里斯·麦克法登和他的团队必须解决每个 SaaS 企业都面临的一个问题:他们需要提供基本的服务，如身份验证、账户管理和计费。

当然，核心问题不是如何向用户收费。而是如何设计他们的用户帐户微服务，以支持该问题领域的所有内容:用户帐户、API 密钥、身份验证、商业帐户、计费等。

为了解决这个问题，他们创建了两个微服务:一个用户 API 和一个帐户 API。用户 API 将处理用户帐户、API 密钥、认证，而帐户 API 将处理所有与计费相关的逻辑。一个非常合理的分离，但是不久，他们发现了一个问题。

“我们有一个叫做用户应用编程接口的服务，还有一个叫做账户应用编程接口的服务。但问题是，他们之间实际上有多次通话。因此，你可以在帐户中做一些事情，在用户中设置呼叫和端点，反之亦然，”他继续说道。

这两个服务耦合得太紧密了。

“我们意识到，在大多数情况下，你真的不想让一个服务以循环的方式调用另一个服务。这通常不是一个好主意，”克里斯解释道。

我认为这个场景对于任何处理过这个设计问题的开发人员来说都很熟悉。过去我犯过无数次这样的错误。问题是，我们如何避免这些微服务设计陷阱，我们应该寻找什么模式？请继续阅读，寻找答案。

### 微服务边界的重要性

当麦克法登和我进一步交谈时，他强调了创建一个具有微服务架构的新系统的主要挑战之一。当我提到用微服务开发新系统的核心好处之一是架构允许开发者独立地构建和修改单个组件时，问题就出现了——但是当涉及到最小化每个 API 之间的回调数量时。根据麦克法登的说法，解决方案是应用适当的服务边界。

但是与域驱动设计(DDD)这一微服务框架有时难以理解和抽象的概念相比，我将在本章尽可能实际地与我们行业的一些顶级首席技术官讨论定义良好的微服务边界的必要性。

### 避免武断的规则

在设计和创建微服务时，不要陷入使用任意规则的陷阱。如果你读了足够多的建议，你会发现下面的一些规则。虽然有吸引力，但这些都不是确定微服务边界的正确方法。

#### 1.“一个微服务应该有 X 行代码”

让我们弄清楚一件事；微服务中的代码行数没有限制。一个微服务不会因为你多写了几行代码就突然变成一个庞然大物。关键是确保服务中的代码具有高内聚性(稍后将详细介绍)。

#### 2.“将每个功能转变为微服务”

如果一个函数基于三个输入值进行计算，并返回一个结果，这是微服务的好选择吗？它应该是一个可单独部署的应用程序吗？这实际上取决于功能是什么以及它如何服务于整个系统。

其他武断的规则包括那些不考虑您的整个环境的规则，例如团队的经验、DevOps 容量、服务正在做什么以及数据的可用性需求。

### 设计良好的服务的特征

如果你读过关于微服务的文章，毫无疑问你会遇到关于什么是设计良好的服务的建议。简单来说:高内聚，松耦合。如果您不熟悉这些概念，可以阅读许多关于这些概念的文章。虽然这些建议听起来不错，但这些概念相当抽象。

我与数十位首席技术官就此话题进行了交谈，向他们学习如何划定微服务界限，我在下面为您总结了一些基本特征。

#### 特性#1:它不与另一个服务共享数据库表

正如我们在本章前面提到的克里斯·麦克法登的案例中看到的，在设计微服务时，如果有多个服务引用同一个表，这是一个危险信号，因为这可能意味着您的数据库是一个耦合源。

> "每个服务都应该有自己的表，并且不应该共享数据库表."——Darby Frey，诚实领导组织的联合创始人

这实际上是关于服务如何与数据相关联，这正是 Swiftype SRE 公司的负责人 Oleksiy Kovrin 告诉我的:

“我们在开发新服务时使用的主要基本原则之一是，它们不应跨越数据库边界。每个服务都应该依赖于自己的底层数据存储集。这使我们能够集中访问控制、审计日志、缓存逻辑等，”他说。

Kovyrin 继续解释说，如果数据库表的一个子集“与数据集的其余部分没有或很少连接，这是一个强烈的信号，表明组件可以被隔离到一个单独的 API 或单独的服务中。”

Sam Newman 很好地说明了这种情况，并提供了一些解决方案。

GeeCON 2013: Sam Newman -从宏观到微观:你的服务应该有多大？从 [GeeCON 会议](https://vimeo.com/geecon)到 [Vimeo](https://vimeo.com) 。

您可以将表拆分(27:41)或具体化新服务(26:00):

诚实领导的联合创始人 Darby Frey 回应了这种观点，他告诉我，“每个服务都应该有自己的表，并且永远不应该共享数据库表。”

#### 特征 2:它有最少的数据库表

正如[第一章](https://buttercms.com/books/microservices-for-startups/how-teams-get-microservices-wrong-from-the-start)中提到的，微服务的理想规模是足够小，但不能更小。每个服务的数据库表的数量也是如此。

Scaylr 的工程主管 Steven Czerwinski 在一次采访中向我解释说，Scaylr 的优势在于，“一个服务有一两个数据库表。”

“我们有一个抑制微服务，它处理并跟踪数百万、数十亿个与抑制相关的条目，但它都非常专注于抑制，所以实际上只有一两个表。像 webhooks 这样的其他服务也是如此，”克里斯·麦克法登解释道。

#### 特征#3:它是经过深思熟虑的有状态或无状态

在设计您的微服务时，您需要问自己，它是否需要访问数据库，或者它是否将成为一种无状态的服务，处理数 TB 的数据，如电子邮件或日志。

> “我们通过定义服务的输入和输出来定义服务的边界。有时服务是一个网络 API，但它也可以是一个消耗文件和在数据库中产生记录的过程(我们的日志处理服务就是这样)”——朱利安·莱莫因

明确这一点，它将导致更好的服务设计。

#### 特征#4:考虑了其数据可用性需求

在设计微服务时，您需要记住哪些服务将依赖于这种新服务，以及如果该数据变得不可用会产生什么样的系统范围影响。考虑到这一点，您可以为此服务正确设计数据备份和恢复系统。

在与 Steven Czerwinski 交谈时，他提到他们的关键客户行空间映射数据因其重要性而以不同的方式复制和分离。

“而每个分片的信息，都在它自己的小分区里。Czerwinski 解释说:“如果宕机，情况会很糟糕，因为这部分客户将无法使用他们的日志，但这只会影响 5%的客户，而不是 100%的客户。

#### 特征 5:这是唯一的真理来源

要记住的最后一个特征是设计一个服务，使其成为您系统中某件事情的唯一来源。

举个例子，当你从一个电子商务网站订购东西时，会生成一个订单 ID。其他服务可以使用这个订单 ID 来查询订单服务，以获得订单的完整信息。使用发布/订阅概念，在服务之间传递的数据应该是订单 ID，而不是订单本身的属性/信息。只有订单服务具有完整的信息，并且是给定订单的唯一真实来源。

### 大型团队的注意事项

对于较大的组织，整个团队可以专门拥有一个服务，当确定服务边界时，组织的考虑就发挥作用了。需要记住两个考虑因素:独立的发布时间表和不同的正常运行时间重要性。

Cloud66 首席执行官 Khash Sajadi 表示:“我们见过的最成功的微服务实施要么基于软件设计原则，例如域驱动设计和面向服务的架构，要么反映了组织方法。

“所以[对]支付团队来说，”萨贾迪继续说，“他们有支付服务或信用卡验证服务，这是他们向外界提供的服务。所以不一定和软件有关。这主要是关于向外界提供多一项服务的业务部门。”

> “[杰夫·贝索斯]提出了‘两个披萨’规则——一个团队的规模不应该超过两个披萨能喂饱的数量。”Iron.io 首席技术官特拉维斯·里德(Travis Reeder)

亚马逊是一个拥有多个团队的大型组织的完美例子。正如发表在 [API 布道者](https://apievangelist.com/2012/01/12/the-secret-to-amazons-success-internal-apis/)的一篇文章中提到的，杰夫·贝索斯向所有员工发布了一项命令，通知他们公司内的每个团队都必须通过 API 进行沟通。任何不这样做的人都会被解雇。

这样，所有的数据和功能都通过接口公开。贝佐斯还设法让每个团队分离，定义他们的资源是什么，并通过 API 提供这些资源。亚马逊从头开始建立一个系统。这使得公司内的每个团队都成为彼此的合作伙伴。

我与 Iron.io 首席技术官特拉维斯·里德(Travis Reeder)讨论了贝佐斯的内部计划。

“杰夫·贝索斯要求所有团队都必须构建 API 来与其他团队交流。他也是提出“两块披萨”规则的人；他说:“一个团队的规模不应该超过两块披萨的容量。

“我认为这同样适用于这里:一个小团队可以开发、管理和生产的任何东西。如果它开始变得笨拙或开始变慢，它可能变得太大了，”里德告诉我。

### 如何判断服务是否太小，或者没有正确定义

在微服务系统的测试和实施阶段，有一些指标需要记住。

要注意的第一个指标是服务之间的过度依赖。如果两个服务不断地相互回调，那么这是一个强有力的耦合迹象，也是一个信号，表明将它们组合成一个服务可能会更好。

回到克里斯·麦克法登在本章开始时分享的例子，他有两个 API 服务，账户和用户，它们经常相互通信，麦克法登想出了一个合并服务的想法，并决定将其称为原告的 API。这被证明是一个卓有成效的策略:

“我们开始做的是消除它们之间的内部 API 调用。这有助于简化代码。”麦克法登告诉我的。

第二个问题是建立服务的开销是否超过了让它独立的好处。

Darby Frey 解释说:“每个应用程序都需要将其日志聚集在某个地方，并需要进行监控。你需要为它设置警报。你需要有标准的操作程序和操作手册，以备出现问题时使用。你必须管理对那个东西的 SSH 访问。要让一款应用正常运行，必须要有一个巨大的基础。”

### 考虑这些特征

设计微服务往往更像是一门艺术，而不是一门科学。作为一名工程师，这和我的左脑不太协调。有很多一般性的建议，但有时可能有点太抽象，所以让我们快速回顾一下:

1.  它不与另一个服务共享数据库表
2.  它有最少数量的数据库表
3.  它是经过深思熟虑的有状态或无状态
4.  考虑了其数据可用性需求
5.  这是真理的唯一来源

这是设计下一套微服务时需要考虑的 5 个具体特征。所以下一次当你面临为新服务划定界限的任务时，就像一开始提到的用户和账户的例子，我希望回顾一下这些能让任务变得更容易。

感谢[克里斯·麦克法登](https://twitter.com/cristoirmac)、[达比·弗雷](https://twitter.com/darbyfrey)、史蒂文·茨韦林斯基、[朱利安·莱莫因](https://twitter.com/jlemoine_algo)、[奥莱克西·柯维林](https://twitter.com/kovyrin)、[特拉维斯·里德](https://twitter.com/treeder)和[卡什·萨贾迪](https://twitter.com/khash)对本章的审阅和贡献。

这是 ButterCMS 的电子书[为创业公司](https://buttercms.com/books/microservices-for-startups/)提供微服务的一章，你可以免费查阅。