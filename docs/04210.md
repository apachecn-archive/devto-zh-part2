# Apache Airflow å…¥é—¨

> åŽŸæ–‡:[https://dev . to/kad nan/getting-started-with-Apache-air flow-3 noa](https://dev.to/kadnan/getting-started-with-apache-airflow-3noa)

[![Apache Airflow](../Images/8506236c9b020a702ea6e3620c40bdcb.png)T2ã€‘](http://blog.adnansiddiqi.me/wp-content/uploads/2018/09/airflow_logo.png)

*æœ¬å¸–æ˜¯[æ•°æ®å·¥ç¨‹ç³»åˆ—](http://blog.adnansiddiqi.me/tag/data-engineering/)çš„ä¸€éƒ¨åˆ†ã€‚*

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è®¨è®ºç”± Airbnb å¼€å‘çš„å·¥ä½œæµç®¡ç†ç³»ç»Ÿ Apache Airflowã€‚

æ—©äº›æ—¶å€™ï¼Œæˆ‘æ›¾ç»è®¨è®ºè¿‡ç”¨ Bonobo ç¼–å†™åŸºæœ¬çš„ ETL ç®¡é“ã€‚Bonobo åœ¨ç¼–å†™ ETL ç®¡é“æ–¹é¢å¾ˆé…·ï¼Œä½†æ˜¯è¿™ä¸ªä¸–ç•Œå¹¶ä¸å…¨æ˜¯ç¼–å†™ ETL ç®¡é“æ¥å®žçŽ°è‡ªåŠ¨åŒ–ã€‚è¿˜æœ‰ä¸€äº›å…¶ä»–çš„ç”¨ä¾‹ï¼Œåœ¨è¿™äº›ç”¨ä¾‹ä¸­ï¼Œæ‚¨å¿…é¡»æŒ‰ç…§ä¸€å®šçš„é¡ºåºæ‰§è¡Œä»»åŠ¡ä¸€æ¬¡æˆ–è€…å®šæœŸæ‰§è¡Œã€‚ä¾‹å¦‚:

*   ç›‘æŽ§ Cron ä½œä¸š
*   å°†æ•°æ®ä»Žä¸€ä¸ªåœ°æ–¹ä¼ è¾“åˆ°å¦ä¸€ä¸ªåœ°æ–¹ã€‚
*   è‡ªåŠ¨åŒ–æ‚¨çš„å¼€å‘è¿ç»´ã€‚
*   å®šæœŸä»Žç½‘ç«™ä¸ŠèŽ·å–æ•°æ®ï¼Œå¹¶ä¸ºä½ ä»¤äººæ•¬ç•çš„ä»·æ ¼æ¯”è¾ƒç³»ç»Ÿæ›´æ–°æ•°æ®åº“ã€‚
*   åŸºäºŽæŽ¨èç³»ç»Ÿçš„æ•°æ®å¤„ç†ã€‚
*   æœºå™¨å­¦ä¹ ç®¡é“ã€‚

å¯èƒ½æ€§æ˜¯æ— ç©·çš„ã€‚

åœ¨æˆ‘ä»¬è¿›ä¸€æ­¥åœ¨æˆ‘ä»¬çš„ç³»ç»Ÿä¸­å®žçŽ°æ°”æµä¹‹å‰ï¼Œè®©æˆ‘ä»¬è®¨è®ºä¸€ä¸‹ä»€ä¹ˆæ˜¯æ°”æµåŠå…¶æœ¯è¯­ã€‚

### ä»€ä¹ˆæ˜¯æ°”æµï¼Ÿ

ä»Žç½‘ç«™:

> Airflow æ˜¯ä¸€ä¸ªä»¥ç¼–ç¨‹æ–¹å¼åˆ›ä½œã€è°ƒåº¦å’Œç›‘æŽ§å·¥ä½œæµçš„å¹³å°ã€‚
> 
> ä½¿ç”¨ airflow å°†å·¥ä½œæµåˆ›ä½œä¸ºä»»åŠ¡çš„æœ‰å‘æ— çŽ¯å›¾(Dag)ã€‚airflow scheduler åœ¨éµå¾ªæŒ‡å®šä¾èµ–å…³ç³»çš„åŒæ—¶ï¼Œå¯¹ä¸€ç»„å·¥ä½œçº¿ç¨‹æ‰§è¡Œæ‚¨çš„ä»»åŠ¡ã€‚ä¸°å¯Œçš„å‘½ä»¤è¡Œå®žç”¨ç¨‹åºä½¿åœ¨ Dag ä¸Šæ‰§è¡Œå¤æ‚çš„æ‰‹æœ¯å˜å¾—è½»è€Œæ˜“ä¸¾ã€‚ä¸°å¯Œçš„ç”¨æˆ·ç•Œé¢ä½¿å¾—å¯è§†åŒ–ç”Ÿäº§ä¸­è¿è¡Œçš„ç®¡é“ã€ç›‘æŽ§è¿›åº¦ä»¥åŠåœ¨éœ€è¦æ—¶è§£å†³é—®é¢˜å˜å¾—å®¹æ˜“ã€‚

åŸºæœ¬ä¸Šï¼Œå®ƒæœ‰åŠ©äºŽè‡ªåŠ¨åŒ–è„šæœ¬æ¥æ‰§è¡Œä»»åŠ¡ã€‚Airflow æ˜¯åŸºäºŽ Python çš„ï¼Œä½†æ˜¯ä½ å¯ä»¥æ‰§è¡Œä¸€ä¸ªç¨‹åºï¼Œè€Œä¸ç®¡å®ƒæ˜¯ä»€ä¹ˆè¯­è¨€ã€‚ä¾‹å¦‚ï¼Œå·¥ä½œæµç¨‹çš„ç¬¬ä¸€é˜¶æ®µå¿…é¡»æ‰§è¡Œä¸€ä¸ªåŸºäºŽ C++çš„ç¨‹åºæ¥æ‰§è¡Œå›¾åƒåˆ†æžï¼Œç„¶åŽæ‰§è¡Œä¸€ä¸ªåŸºäºŽ Python çš„ç¨‹åºæ¥å°†ä¿¡æ¯ä¼ è¾“åˆ° S3ã€‚å¯èƒ½æ€§æ˜¯æ— ç©·çš„ã€‚

### Dag æ˜¯ä»€ä¹ˆï¼Ÿ

*æ¥è‡ªç»´åŸºç™¾ç§‘*

> åœ¨æ•°å­¦å’Œè®¡ç®—æœºç§‘å­¦ä¸­ï¼Œæœ‰å‘æ— çŽ¯å›¾(DAG /ËˆdÃ¦É¡/(å…³äºŽè¿™ä¸ªå£°éŸ³å¬))æ˜¯æ²¡æœ‰æœ‰å‘åœˆçš„æœ‰é™æœ‰å‘å›¾ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒç”±æœ‰é™æ•°é‡çš„é¡¶ç‚¹å’Œè¾¹ç»„æˆï¼Œæ¯æ¡è¾¹ä»Žä¸€ä¸ªé¡¶ç‚¹æŒ‡å‘å¦ä¸€ä¸ªé¡¶ç‚¹ï¼Œå› æ­¤æ²¡æœ‰åŠžæ³•ä»Žä»»ä½•é¡¶ç‚¹ v å¼€å§‹ï¼Œå¹¶æ²¿ç€ä¸€è‡´æŒ‡å‘çš„è¾¹åºåˆ—ï¼Œæœ€ç»ˆå†æ¬¡å¾ªçŽ¯å›žåˆ° vã€‚ç­‰ä»·åœ°ï¼ŒDAG æ˜¯å…·æœ‰æ‹“æ‰‘æŽ’åºçš„æœ‰å‘å›¾ï¼Œå³é¡¶ç‚¹åºåˆ—ï¼Œä½¿å¾—æ¯æ¡è¾¹åœ¨åºåˆ—ä¸­ä»Žå‰é¢æŒ‡å‘åŽé¢ã€‚

è®©æˆ‘è¯•ç€ç”¨ç®€å•çš„è¯æ¥è§£é‡Š:ä½ åªèƒ½æ˜¯ä½ çˆ¶äº²çš„å„¿å­ï¼Œè€Œä¸æ˜¯ç›¸åã€‚å¥½å§ï¼Œè¿™æ˜¯è¹©è„šæˆ–æ€ªå¼‚çš„ï¼Œä½†æ‰¾ä¸åˆ°ä¸€ä¸ªæ›´å¥½çš„ä¾‹å­æ¥è§£é‡Šä¸€ä¸ª*å®šå‘å‘¨æœŸ*ã€‚

[![](../Images/293f7e347835feb133934cec4f517c1a.png)T2ã€‘](http://blog.adnansiddiqi.me/wp-content/uploads/2018/09/airflow_0.png)

åœ¨ Airflow ä¸­ï¼Œæ‰€æœ‰å·¥ä½œæµéƒ½æ˜¯ Dagã€‚Dag ç”±*æ“ä½œç¬¦ç»„æˆã€‚*æ“ä½œå‘˜å®šä¹‰éœ€è¦æ‰§è¡Œçš„å•ä¸ªä»»åŠ¡ã€‚æœ‰ä¸åŒç±»åž‹çš„æ“ä½œå™¨å¯ç”¨(å¦‚ Airflow ç½‘ç«™ä¸Šç»™å‡ºçš„):

*   `BashOperator`â€“æ‰§è¡Œ bash å‘½ä»¤
*   `PythonOperator`â€“è°ƒç”¨ä»»æ„ Python å‡½æ•°
*   `EmailOperator`â€“å‘é€ç”µå­é‚®ä»¶
*   `SimpleHttpOperator`â€“å‘é€ HTTP è¯·æ±‚
*   `MySqlOperator`ã€`SqliteOperator`ã€`PostgresOperator`ã€`MsSqlOperator`ã€`OracleOperator`ã€`JdbcOperator`ç­‰ã€‚â€“æ‰§è¡Œ SQL å‘½ä»¤
*   `Sensor`â€“ç­‰å¾…ç‰¹å®šçš„æ—¶é—´ã€æ–‡ä»¶ã€æ•°æ®åº“è¡Œã€S3 é”®ç­‰

ä½ ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦å®šåˆ¶ä¸€ä¸ªæ“ä½œç¬¦ã€‚

### å®‰è£…å’Œè®¾ç½®

æ°”æµæ˜¯åŸºäºŽ Python çš„ã€‚æœ€å¥½çš„å®‰è£…æ–¹å¼æ˜¯é€šè¿‡`pip`å·¥å…·ã€‚

`pip install apache-airflow`

è¦éªŒè¯å®ƒæ˜¯å¦å·²å®‰è£…ï¼Œè¯·è¿è¡Œå‘½ä»¤:`airflow version`ï¼Œå®ƒåº”è¯¥ä¼šæ˜¾ç¤ºå¦‚ä¸‹å†…å®¹:

```
[2018-09-22 15:59:23,880] {\_\_init\_\_.py:51} INFO - Using executor SequentialExecutor \_\_\_\_\_\_\_\_\_\_\_\_ \_\_\_\_\_\_\_\_\_\_\_\_\_ \_\_\_\_ |\_\_( )\_\_\_\_\_\_\_\_\_ \_\_/\_\_ /\_\_\_\_\_\_\_\_ \_\_ \_\_\_\_ /| |\_ /\_\_ \_\_\_/\_ /\_ \_\_ /\_ \_\_ \_ | /| / / \_\_\_ \_\_\_ | / \_ / \_ \_\_/ \_ / / /\_/ /\_ |/ |/ / \_/\_/ |\_/\_/ /\_/ /\_/ /\_/ \_\_\_\_/\_\_\_\_/|\_\_/ v1.10.0 You will need to install mysqlclient as well to incorporate MySQL in your workflows. It is optional though. 
```

æ‚¨è¿˜éœ€è¦å®‰è£…`mysqlclient`æ¥å°† MySQL æ•´åˆåˆ°æ‚¨çš„å·¥ä½œæµç¨‹ä¸­ã€‚å°½ç®¡è¿™æ˜¯å¯é€‰çš„ã€‚

`pip install mysqlclient`

åœ¨å¼€å§‹ä»»ä½•æ“ä½œä¹‹å‰ï¼Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹å¹¶å°†å…¶è®¾ç½®ä¸º`AIRFLOW_HOME`ã€‚æˆ‘çš„æƒ…å†µæ˜¯`airflow_home`ã€‚ä¸€æ—¦åˆ›å»ºï¼Œä½ å°†è°ƒç”¨`export`å‘½ä»¤æ¥è®¾ç½®å®ƒçš„è·¯å¾„ã€‚

`export AIRFLOW_HOME='pwd' airflow_home`

åœ¨è¿è¡Œ`export`å‘½ä»¤ä¹‹å‰ï¼Œç¡®ä¿ä½ æ˜¯åœ¨`airflow_home`ä¹‹ä¸Šçš„ä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚åœ¨`airflow_home`ä¸­ï¼Œä½ å°†åˆ›å»ºå¦ä¸€ä¸ªæ–‡ä»¶å¤¹æ¥ä¿å­˜ Dagã€‚ç§°ä¹‹ä¸º`dags`

å¦‚æžœæ‚¨è®¾ç½®äº†`load_examples=False`ï¼Œå®ƒå°†ä¸ä¼šåœ¨ Web ç•Œé¢ä¸ŠåŠ è½½é»˜è®¤ç¤ºä¾‹ã€‚

çŽ°åœ¨ä½ å¿…é¡»è°ƒç”¨`airflow_home`æ–‡ä»¶å¤¹ä¸­çš„`airflow initdb`ã€‚ä¸€æ—¦å®Œæˆï¼Œå®ƒå°±ä¼šåˆ›å»º`airflow.cfg`å’Œ`unitests.cfg`

`airflow.db`æ˜¯ä¸€ä¸ª SQLite æ–‡ä»¶ï¼Œç”¨æ¥å­˜å‚¨æ‰€æœ‰ä¸Žè¿è¡Œå·¥ä½œæµç›¸å…³çš„é…ç½®ã€‚`airflow.cfg`æ˜¯ä¿æŒæ‰€æœ‰çš„åˆå§‹è®¾ç½®ï¼Œè®©äº‹æƒ…ä¿æŒè¿è¡Œã€‚

åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å€¼ä¸º`../airflow_home/airflow.db`çš„`sql_alchemy_conn`å‚æ•°

æ„¿æ„çš„è¯å¯ä»¥ç”¨ MySQLã€‚çŽ°åœ¨ï¼Œåªè¦åšæŒåŸºæœ¬è®¾ç½®ã€‚

åˆ°ç›®å‰ä¸ºæ­¢ä¸€åˆ‡é¡ºåˆ©ï¼ŒçŽ°åœ¨ä¸æµªè´¹ä»»ä½•æ—¶é—´ï¼Œè®©æˆ‘ä»¬å¯åŠ¨ web æœåŠ¡å™¨ã€‚

`airflow webserver`

å¯åŠ¨æ—¶ï¼Œå±å¹•æ˜¾ç¤ºå¦‚ä¸‹:

```
2018-09-20 22:36:24,943] {\_\_init\_\_.py:51} INFO - Using executor SequentialExecutor /anaconda3/anaconda/lib/python3.6/site-packages/airflow/bin/cli.py:1595: DeprecationWarning: The celeryd\_concurrency option in [celery] has been renamed to worker\_concurrency - the old setting has been used, but please update your config. default=conf.get('celery', 'worker\_concurrency')), \_\_\_\_\_\_\_\_\_\_\_\_ \_\_\_\_\_\_\_\_\_\_\_\_\_ \_\_\_\_ |\_\_( )\_\_\_\_\_\_\_\_\_ \_\_/\_\_ /\_\_\_\_\_\_\_\_ \_\_ \_\_\_\_ /| |\_ /\_\_ \_\_\_/\_ /\_ \_\_ /\_ \_\_ \_ | /| / / \_\_\_ \_\_\_ | / \_ / \_ \_\_/ \_ / / /\_/ /\_ |/ |/ / \_/\_/ |\_/\_/ /\_/ /\_/ /\_/ \_\_\_\_/\_\_\_\_/|\_\_/ v1.10.0

[2018-09-19 14:21:42,340] {\_\_init\_\_.py:57} INFO - Using executor SequentialExecutor \_\_\_\_\_\_\_\_\_\_\_\_ \_\_\_\_\_\_\_\_\_\_\_\_\_ \_\_\_\_ |\_\_( )\_\_\_\_\_\_\_\_\_ \_\_/\_\_ /\_\_\_\_\_\_\_\_ \_\_ \_\_\_\_ /| |\_ /\_\_ \_\_\_/\_ /\_ \_\_ /\_ \_\_ \_ | /| / / \_\_\_ \_\_\_ | / \_ / \_ \_\_/ \_ / / /\_/ /\_ |/ |/ / \_/\_/ |\_/\_/ /\_/ /\_/ /\_/ \_\_\_\_/\_\_\_\_/|\_\_/ /anaconda3/anaconda/lib/python3.6/site-packages/flask/exthook.py:71: ExtDeprecationWarning: Importing flask.ext.cache is deprecated, use flask\_cache instead. .format(x=modname), ExtDeprecationWarning [2018-09-19 14:21:43,119] [48995] {models.py:167} INFO - Filling up the DagBag from /Development/airflow\_home/dags Running the Gunicorn Server with: Workers: 4 sync Host: 0.0.0.0:8080 
```

çŽ°åœ¨ï¼Œå½“æ‚¨è®¿é—®`0.0.0.0:8080`æ—¶ï¼Œå®ƒä¼šæ˜¾ç¤ºå¦‚ä¸‹å±å¹•:

[![](../Images/c236b36c5139ee6c21532e6fee5c234d.png)T2ã€‘](http://blog.adnansiddiqi.me/wp-content/uploads/2018/09/airflow_1.png)

ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°ä¸€å †æ¡ç›®ã€‚è¿™äº›æ˜¯æ°”æµè£…ç½®é™„å¸¦çš„ç¤ºä¾‹ã€‚æ‚¨å¯ä»¥é€šè¿‡è®¿é—®`airflow.cfg`æ–‡ä»¶å¹¶å°†`load_examples`è®¾ç½®ä¸º`FALSE`æ¥å…³é—­å®ƒä»¬

**DAG è¿è¡Œ**å‘ŠçŸ¥æŸä¸ª DAG å·²ç»æ‰§è¡Œäº†å¤šå°‘æ¬¡ã€‚**æœ€è¿‘çš„ä»»åŠ¡**å‘ŠçŸ¥ DAG ä¸­å½“å‰æ­£åœ¨è¿è¡Œçš„è®¸å¤šä»»åŠ¡ä¸­çš„å“ªä¸ªä»»åŠ¡ï¼Œä»¥åŠå®ƒçš„çŠ¶æ€å¦‚ä½•ã€‚**è°ƒåº¦**ç±»ä¼¼äºŽæ‚¨åœ¨è°ƒåº¦ Cron æ—¶ä½¿ç”¨çš„è°ƒåº¦ï¼Œå› æ­¤ï¼Œæˆ‘çŽ°åœ¨ä¸å¼ºè°ƒå®ƒã€‚**è°ƒåº¦**è´Ÿè´£è¯¥ç‰¹å®š DAG åº”è¯¥è¢«è§¦å‘çš„æ—¶é—´ã€‚

[![Airflow Graph View](../Images/cde710bc9a676cf8e0443001d3e57749.png)T2ã€‘](http://blog.adnansiddiqi.me/wp-content/uploads/2018/09/airflow_0_graph_view.png)

è¿™æ˜¯æˆ‘ä¹‹å‰åˆ›å»ºå¹¶æ‰§è¡Œçš„ DAG çš„æˆªå›¾ã€‚æ‚¨å¯ä»¥çœ‹åˆ°ä»£è¡¨ä»»åŠ¡çš„çŸ©å½¢æ¡†ã€‚åœ¨ç°è‰²æ–¹æ¡†çš„å³ä¸Šæ–¹è¿˜å¯ä»¥çœ‹åˆ°ä¸åŒé¢œè‰²çš„æ–¹æ¡†ï¼Œåˆ†åˆ«å‘½åä¸º:**æˆåŠŸ**ã€**è¿è¡Œ**ã€**å¤±è´¥**ç­‰ã€‚è¿™äº›éƒ½æ˜¯ä¼ è¯´ã€‚åœ¨ä¸Šå›¾ä¸­ï¼Œæ‚¨å¯ä»¥é€‰æ‹©æ‰€æœ‰çš„æ¡†éƒ½æœ‰ç»¿è‰²è¾¹æ¡†ï¼Œä½†æ˜¯ï¼Œå¦‚æžœæ‚¨ä¸ç¡®å®šï¼Œè¯·å°†é¼ æ ‡æ‚¬åœåœ¨ success legend ä¸Šï¼Œæ‚¨å°†çœ‹åˆ°å¦‚ä¸‹å±å¹•:

[![](../Images/576b8c91bc7dad921af70915bc07c558.png)T2ã€‘](http://blog.adnansiddiqi.me/wp-content/uploads/2018/09/airflow_0_graph_hover.png)

ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°è¿™äº›ç›’å­çš„èƒŒæ™¯/å¡«å……é¢œè‰²æ˜¯ç»¿è‰²å’ŒèŠ¦è‹‡è‰²ã€‚åœ¨ç°è‰²æ¡†çš„å·¦ä¸Šè§’ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å®ƒä»¬ä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„é¢œè‰²ï¼Œè¿™äº›èƒŒæ™¯è‰²ä»£è¡¨äº†æ­¤ DAG ä¸­ä½¿ç”¨çš„ä¸åŒç±»åž‹çš„è¿ç®—ç¬¦ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† *BashOperator* å’Œ *PythonOperatorã€‚*

### åŸºæœ¬ç¤ºä¾‹

æˆ‘ä»¬å°†ç ”ç©¶ä¸€ä¸ªåŸºæœ¬çš„ä¾‹å­ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚æˆ‘å°†è§£é‡Šè¿™ä¸ªä¾‹å­ã€‚åœ¨ä¹‹å‰åœ¨`airflow_home/`ä¸­åˆ›å»ºçš„`dags`æ–‡ä»¶å¤¹ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç¤ºä¾‹ DAGã€‚å› æ­¤ï¼Œæˆ‘å°†åˆ›å»ºä¸€ä¸ªåä¸º`my_simple_dag.py`çš„æ–‡ä»¶

å¯¼å…¥ä¹‹åŽä½ è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯ç¼–å†™ä¾‹ç¨‹ï¼Œä½œä¸º**æ“ä½œç¬¦**çš„*ä»»åŠ¡*ã€‚æˆ‘ä»¬å°†æ··åˆä½¿ç”¨`BashOperator`å’Œ`PythonOperator`ã€‚

```
import datetime as dt from airflow import DAG from airflow.operators.bash\_operator import BashOperator from airflow.operators.python\_operator import PythonOperator def greet(): print('Writing in file') with open('path/to/file/greet.txt', 'a+', encoding='utf8') as f: now = dt.datetime.now() t = now.strftime("%Y-%m-%d %H:%M") f.write(str(t) + '\n') return 'Greeted' def respond(): return 'Greet Responded Again' 
```

è¿™æ˜¯ä¸¤ä¸ªç®€å•çš„ä¾‹ç¨‹ï¼Œé™¤äº†è¿”å›žä¸€ä¸ªæ–‡æœ¬ä»€ä¹ˆä¹Ÿä¸åšã€‚ç¨åŽæˆ‘ä¼šå‘Šè¯‰ä½ ä¸ºä»€ä¹ˆæˆ‘è¦åœ¨æ–‡æœ¬æ–‡ä»¶ä¸­å†™ä¸œè¥¿ã€‚æŽ¥ä¸‹æ¥æˆ‘è¦åšçš„æ˜¯å®šä¹‰`default_args`å¹¶åˆ›å»ºä¸€ä¸ª`DAG`å®žä¾‹ã€‚

```
default\_args = { 'owner': 'airflow', 'start\_date': dt.datetime(2018, 9, 24, 10, 00, 00), 'concurrency': 1, 'retries': 0 } 
```

è¿™é‡Œä½ åœ¨`default_args` `dict`å˜é‡ä¸­è®¾ç½®äº†ä¸€å †å‚æ•°ã€‚

`start_date`å‘ŠçŸ¥è‡ªä½•æ—¶èµ·è¯¥ DAG åº”å¼€å§‹æ‰§è¡Œå·¥ä½œæµã€‚è¿™ä¸ª`start_date`å¯èƒ½å±žäºŽè¿‡åŽ»ã€‚å¯¹æˆ‘æ¥è¯´ï¼ŒçŽ°åœ¨æ˜¯ä¸–ç•Œåè°ƒæ—¶ 9 æœˆ 22 æ—¥ä¸Šåˆ 11 ç‚¹ã€‚è¿™ä¸ªæ—¥æœŸå¯¹æˆ‘æ¥è¯´å·²ç»è¿‡åŽ»äº†ï¼Œå› ä¸ºå¯¹æˆ‘æ¥è¯´å·²ç»æ˜¯ä¸–ç•Œæ ‡å‡†æ—¶é—´ä¸Šåˆ 11 ç‚¹ 15 åˆ†äº†ã€‚æ‚¨å¯ä»¥éšæ—¶é€šè¿‡`airflow.cfg`æ–‡ä»¶æ›´æ”¹è¯¥å‚æ•°ï¼Œå¹¶è®¾ç½®æ‚¨è‡ªå·±çš„æœ¬åœ°æ—¶åŒºã€‚ç›®å‰ï¼ŒUTC å¯¹æˆ‘æ¥è¯´å¾ˆå¥½ã€‚å¦‚æžœä½ ä»ç„¶æƒ³çŸ¥é“æ°”æµä½¿ç”¨äº†å¤šå°‘æ—¶é—´ï¼Œæ£€æŸ¥ä¸€ä¸‹æ°”æµç½‘é¡µç•Œé¢çš„å³ä¸Šæ–¹ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„å†…å®¹ã€‚æ‚¨å¯ä»¥å°†æ­¤ä½œä¸ºå‚è€ƒæ¥å®‰æŽ’æ‚¨çš„ä»»åŠ¡ã€‚

[![](../Images/53b9871f7f328be3e4e0743fd316bde4.png)T2ã€‘](http://blog.adnansiddiqi.me/wp-content/uploads/2018/09/airflow_2.png)

åœ¨æ²¡æœ‰æˆåŠŸæ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œ`retries`å‚æ•°é‡è¯•è¿è¡Œ DAG **X** çš„æ¬¡æ•°ã€‚`concurrency`å‚æ•°æœ‰åŠ©äºŽæŒ‡å®šè¿è¡Œå¤šä¸ª Dag æ‰€éœ€çš„è¿›ç¨‹æ•°é‡ã€‚ä¾‹å¦‚ï¼Œæ‚¨çš„ DAG å¿…é¡»è¿è¡Œ 4 ä¸ªè¿‡åŽ»çš„å®žä¾‹ï¼Œä¹Ÿç§°ä¸º[å›žå¡«](https://airflow.apache.org/scheduler.html#backfill-and-catchup)ï¼Œé—´éš” 10 åˆ†é’Ÿ(*æˆ‘å°†å¾ˆå¿«ä»‹ç»è¿™ä¸ªå¤æ‚çš„ä¸»é¢˜*)ï¼Œå¹¶ä¸”æ‚¨å·²ç»å°†`concurrency`è®¾ç½®ä¸º`2`ï¼Œé‚£ä¹ˆ **2 ä¸ª DAG**å°†åŒæ—¶è¿è¡Œå¹¶æ‰§è¡Œå…¶ä¸­çš„ä»»åŠ¡ã€‚å¦‚æžœä½ å·²ç»åœ¨ä½ çš„ Python ä¸­å®žçŽ°äº†`multiprocessing`,é‚£ä¹ˆåœ¨è¿™é‡Œä½ åº”è¯¥ä¼šæœ‰å®¶çš„æ„Ÿè§‰ã€‚

```
with DAG('my\_simple\_dag', default\_args=default\_args, schedule\_interval='\*/10 \* \* \* \*', ) as dag: opr\_hello = BashOperator(task\_id='say\_Hi', bash\_command='echo "Hi!!"') opr\_greet = PythonOperator(task\_id='greet', python\_callable=greet) opr\_sleep = BashOperator(task\_id='sleep\_me', bash\_command='sleep 5') opr\_respond = PythonOperator(task\_id='respond', python\_callable=respond) opr\_hello \>\> opr\_greet \>\> opr\_sleep \>\> opr\_respond 
```

çŽ°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨[ä¸Šä¸‹æ–‡ç®¡ç†å™¨](https://en.wikibooks.org/wiki/Python_Programming/Context_Managers)æ¥å®šä¹‰ dag åŠå…¶å±žæ€§ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ DAG çš„ IDï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯`my_simple_dag`ï¼Œç¬¬äºŒä¸ªå‚æ•°æˆ‘ä»¬å·²ç»è®¨è®ºè¿‡ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°éœ€è¦ä¸Ž`default_args`ä¸­æåˆ°çš„`start_date`ä¸€èµ·è®¨è®ºã€‚

åœ¨é‚£ä¸ª*ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸­ï¼Œ*æ‚¨æ­£åœ¨åˆ†é…æ“ä½œç¬¦å’Œä»»åŠ¡ idã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­è¿™äº›æ“ä½œç¬¦æ ‡è®°ä¸º:`opr_hello` `opr_greet` `opr_sleep`å’Œ`opr_respond`ã€‚è¿™äº›åå­—ç„¶åŽå‡ºçŽ°åœ¨ä¸Šé¢è®¨è®ºçš„çŸ©å½¢æ¡†ä¸­ã€‚

åœ¨æˆ‘ç»§ç»­ä¹‹å‰ï¼Œæˆ‘æœ€å¥½è®¨è®ºä¸€ä¸‹ *DAG è¿è¡Œ*å’Œ*è°ƒåº¦å™¨*ä»¥åŠå®ƒä»¬åœ¨æ•´ä¸ªå·¥ä½œæµä¸­æ‰®æ¼”ä»€ä¹ˆè§’è‰²ã€‚

#### ä»€ä¹ˆæ˜¯æ°”æµè°ƒåº¦å™¨ï¼Ÿ

æ°”æµè°ƒåº¦ç¨‹åºæ˜¯ä¸€ä¸ªä¸€ç›´è¿è¡Œçš„ç›‘æŽ§è¿›ç¨‹ï¼Œæ ¹æ®`schedule_interval`å’Œ`execution_date.`è§¦å‘ä»»åŠ¡æ‰§è¡Œ

#### ä»€ä¹ˆæ˜¯ DagRunï¼Ÿ

ä¸€ä¸ª *DagRun* æ˜¯ä¸€æ¬¡å°†è¿è¡Œçš„ DAG çš„å®žä¾‹ã€‚å½“å®ƒè¿è¡Œæ—¶ï¼Œå®ƒé‡Œé¢çš„æ‰€æœ‰ä»»åŠ¡éƒ½å°†è¢«æ‰§è¡Œã€‚

[![](../Images/31469e03db27fff729052e6a446be345.png)T2ã€‘](http://blog.adnansiddiqi.me/wp-content/uploads/2018/09/airflow_3.png)

ä¸Šå›¾å¯èƒ½æœ‰åŠ©äºŽç†è§£ä¸€ä¸ª*è¾¾æ ¼é¾™* [![ðŸ™‚](../Images/1bb31e891282bfa40812655c9c9ace9e.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--DvXCaIjD--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://s.w.org/images/core/emoji/11/72x72/1f642.png)

å‡è®¾`start_date`æ˜¯ä¸–ç•Œåè°ƒæ—¶ 2018 å¹´ 9 æœˆ 24 æ—¥ 12:00:00PM çš„**ï¼Œå¹¶ä¸”æ‚¨å·²ç»ä½¿ç”¨ ***/10 * * * *çš„`schedule_interval`åœ¨ä¸–ç•Œåè°ƒæ—¶**12:30:00PM**å¼€å§‹ DAG(æ¯ 10 åˆ†é’ŸåŽ)ã€‚**é€šè¿‡ä½¿ç”¨ä¸Šé¢è®¨è®ºçš„ç›¸åŒçš„`default_args`å‚æ•°ï¼Œä¸‹é¢å°†æ˜¯å°†ç«‹å³è¿è¡Œçš„ DAG çš„æ¡ç›®ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œç”±äºŽ`concurrency`æ˜¯`1`ï¼Œæ‰€ä»¥å°†ä¸€ä¸ªæŽ¥ä¸€ä¸ªåœ°è¿è¡Œ:**

[![](../Images/d45fc69a447c638bed16eb3d9dc7c0aa.png)T2ã€‘](http://blog.adnansiddiqi.me/wp-content/uploads/2018/09/airflow_4.png)

ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿå—¯ï¼Œä½ è¦å¯¹æ­¤è´Ÿè´£ã€‚æ°”æµç»™ä½ çš„è®¾å¤‡è¿è¡Œè¿‡åŽ»çš„ç‹—ã€‚è·‘è¿‡ Dag çš„è¿‡ç¨‹å«åš[å›žå¡«](https://airflow.readthedocs.io/en/latest/scheduler.html#backfill-and-catchup)ã€‚å›žå¡«çš„è¿‡ç¨‹å®žé™…ä¸Šè®©æ°”æµä¸ºæ‰€æœ‰ Dag è®¾ç½®äº†æŸç§çŠ¶æ€ã€‚è¯¥åŠŸèƒ½é€‚ç”¨äºŽè¿è¡Œ DAG çš„åœºæ™¯ï¼ŒDAG æŸ¥è¯¢ä¸€äº›æ•°æ®åº“æˆ– APIï¼Œå¦‚ Google Analyticsï¼Œä»¥èŽ·å–ä»¥å‰çš„æ•°æ®ï¼Œå¹¶ä½¿å…¶æˆä¸ºå·¥ä½œæµçš„ä¸€éƒ¨åˆ†ã€‚å³ä½¿æ²¡æœ‰è¿‡åŽ»çš„æ•°æ®ï¼ŒAirflow ä¹Ÿä¼šè¿è¡Œå®ƒï¼Œä»¥ä¿æŒæ•´ä¸ªå·¥ä½œæµçš„çŠ¶æ€ä¸å˜ã€‚

è¿è¡Œå®Œè¿‡åŽ»çš„ Dag åŽï¼Œä¸‹ä¸€ä¸ª Dag(æ‚¨æ‰“ç®—è¿è¡Œçš„ Dag)å°†åœ¨ UTC æ—¶é—´ä¸‹åˆ **12:40:00 è¿è¡Œã€‚**è¯·è®°ä½ï¼Œæ— è®ºæ‚¨è®¾ç½®ä»€ä¹ˆè®¡åˆ’ï¼ŒDAG éƒ½ä¼šåœ¨è¯¥æ—¶é—´ä¹‹åŽè¿è¡Œï¼Œåœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œå¦‚æžœå®ƒå¿…é¡»æ¯ 10 åˆ†é’Ÿåœ¨ä¹‹åŽè¿è¡Œ**ï¼Œå®ƒå°†åœ¨ 10 åˆ†é’Ÿè¿‡åŽè¿è¡Œä¸€æ¬¡ã€‚**

è®©æˆ‘ä»¬ä¸€èµ·çŽ©å§ã€‚æˆ‘æ‰“å¼€`my_simple_dag`ï¼Œç„¶åŽå¯åŠ¨è°ƒåº¦ç¨‹åºã€‚

[![](../Images/b9930e40c25d0ce354cef7b702952c2d.png)T2ã€‘](http://blog.adnansiddiqi.me/wp-content/uploads/2018/09/airflow_5.png)

`airflow scheduler`

è¿è¡ŒåŽï¼Œæ‚¨å°†çœ‹åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„ dag å±å¹•:

[![](../Images/b7fd7416c646d1bb99754bfc554936f7.png)T2ã€‘](http://blog.adnansiddiqi.me/wp-content/uploads/2018/09/airflow_6.png)

ä¸€äº›ä»»åŠ¡æ­£åœ¨æŽ’é˜Ÿã€‚å¦‚æžœæ‚¨å•å‡» DAG Idï¼Œ`my_simple_dag`ï¼Œæ‚¨å°†çœ‹åˆ°å¦‚ä¸‹å±å¹•:

[![](../Images/52162dc6bfca754d1e9e5e4668a6baa2.png)T2ã€‘](http://blog.adnansiddiqi.me/wp-content/uploads/2018/09/airflow_7.png)

æ³¨æ„**è¿è¡Œ Id** åˆ—ä¸­çš„æ—¶é—´æˆ³ã€‚ä½ çœ‹åˆ°æ¨¡å¼äº†å—ï¼Ÿç¬¬ä¸€æ¬¡æ˜¯åœ¨ 10 ç‚¹ï¼Œç„¶åŽæ˜¯ 10 ç‚¹ 10 åˆ†ï¼Œ10 ç‚¹ 20 åˆ†ã€‚ç„¶åŽå®ƒä¼šåœæ­¢ï¼Œè®©æˆ‘å†æ¬¡æ¾„æ¸…ï¼ŒDAG ä¼šåœ¨ 10 åˆ†é’Ÿçš„æŒç»­æ—¶é—´è¿‡åŽè¿è¡Œã€‚*è°ƒåº¦*åœ¨ä¸Šåˆ 10:30 å¼€å§‹ã€‚äºŽæ˜¯å°±ç”¨é—´éš”çš„ **10 åˆ†é’Ÿ**ä¹‹å·®å¡«è¿‡äº† **3** ã€‚

[![](../Images/da2c93f25d870bdd367886507dccadbe.png)T2ã€‘](http://blog.adnansiddiqi.me/wp-content/uploads/2018/09/airflow_8.png)

åœ¨ä¸–ç•Œåè°ƒæ—¶ä¸Šåˆ**10:30:00**æ‰§è¡Œçš„ DAG å®žé™…ä¸Šæ˜¯åœ¨ä¸–ç•Œåè°ƒæ—¶ä¸Šåˆ 10:40:00**å®Œæˆçš„ï¼Œæœ€æ–°çš„ DAGRun è®°å½•å°†æ€»æ˜¯æ¯”å½“å‰æ—¶é—´å‡ä¸€ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæœºå™¨æ—¶é—´æ˜¯ä¸–ç•Œåè°ƒæ—¶**ä¸Šåˆ 10:40:00****

[![](../Images/a5f88816ae6c7a57a9ec0d1d08c27239.png)T2ã€‘](http://blog.adnansiddiqi.me/wp-content/uploads/2018/09/airflow_9.png)

å¦‚æžœæ‚¨å°†é¼ æ ‡æ‚¬åœåœ¨å…¶ä¸­ä¸€ä¸ªåœ†åœˆä¸Šï¼Œæ‚¨å¯ä»¥çœ‹åˆ°åœ¨ **Run:** å‰é¢çš„æ—¶é—´æˆ³ï¼Œå®ƒå‘Šè¯‰æ‚¨å®ƒè¢«æ‰§è¡Œçš„æ—¶é—´ã€‚ä½ å¯ä»¥çœ‹åˆ°è¿™äº›ç»¿è‰²çš„åœ†åœˆæœ‰ 10 åˆ†é’Ÿçš„æ—¶é—´å·®ã€‚*æ ‘è§†å›¾*ç»™å‡ºçš„æœ‰ç‚¹å¤æ‚ï¼Œä½†ç»™å‡ºäº†æ•´ä¸ªå·¥ä½œæµç¨‹çš„å®Œæ•´ç”»é¢ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒè¿è¡Œäº† 4 æ¬¡ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½è¿è¡ŒæˆåŠŸï¼Œæ·±ç»¿è‰²ã€‚

æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥é¿å…å›žå¡«:å°†`start_date`è®¾ç½®åœ¨æœªæ¥ï¼Œæˆ–è€…å°†`catchup = False`è®¾ç½®åœ¨`DAG`å®žä¾‹ä¸­ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œå¦‚ä¸‹æ“ä½œ:

```
with DAG('my\_simple\_dag', catchup=False, default\_args=default\_args, schedule\_interval='\*/10 \* \* \* \*', # schedule\_interval=None, ) as dag: 
```

é€šè¿‡è®¾ç½®`catchup=False`ï¼Œä½ çš„`start_date`æ˜¯å¦å±žäºŽè¿‡åŽ»å¹¶ä¸é‡è¦ã€‚å®ƒå°†ä»Žå½“å‰æ—¶é—´å¼€å§‹æ‰§è¡Œå¹¶ç»§ç»­ã€‚é€šè¿‡è®¾ç½®`end_date`ï¼Œä½ å¯ä»¥è®©ä¸€åªç‹—åœæ­¢è‡ªå·±è¿è¡Œã€‚

```
opr\_hello \>\> opr\_greet \>\> opr\_sleep \>\> opr\_respond 
```

ä½ åœ¨ä¸Šé¢çœ‹åˆ°çš„è¿™æ¡çº¿è¯´æ˜Žäº†æ“ä½œè€…ä¹‹é—´çš„å…³ç³»ï¼Œå› æ­¤æž„æˆäº†æ•´ä¸ªå·¥ä½œæµç¨‹ã€‚è¿™é‡Œçš„æŒ‰ä½è¿ç®—ç¬¦è®²çš„æ˜¯è¿ç®—ç¬¦ä¹‹é—´çš„å…³ç³»ã€‚è¿™é‡Œ`opr_hello`å…ˆè·‘ï¼Œç„¶åŽå‰©ä¸‹çš„ã€‚æµç¨‹ä»Žå·¦åˆ°å³æ‰§è¡Œã€‚åœ¨å›¾ç¤ºå½¢å¼ä¸­ï¼Œå®ƒçœ‹èµ·æ¥å¦‚ä¸‹:

[![](../Images/c162706c9a4540216e6585624bd457c0.png)T2ã€‘](http://blog.adnansiddiqi.me/wp-content/uploads/2018/09/airflow_10.png)

```
opr\_hello \>\> opr\_greet \>\> opr\_sleep \<\< opr\_respond 
```

å¦‚æžœæ‚¨æ›´æ”¹æœ€åŽä¸€ä¸ªè¿ç®—ç¬¦çš„æ–¹å‘ï¼Œæµç¨‹å°†å¦‚ä¸‹æ‰€ç¤º:

[![](../Images/7ca519ba92e07941984fa007af59466e.png)T2ã€‘](http://blog.adnansiddiqi.me/wp-content/uploads/2018/09/airflow_11.png)

ä»»åŠ¡`respond`å°†å¹¶è¡Œæ‰§è¡Œï¼Œè€Œ`sleep`å°†åœ¨ä¸¤ç§æƒ…å†µä¸‹æ‰§è¡Œã€‚

### ç»“è®º

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è®¨è®ºäº†å¦‚ä½•å¼•å…¥ä¸€ä¸ªå…¨é¢çš„å·¥ä½œæµç³»ç»Ÿæ¥å®‰æŽ’å’Œè‡ªåŠ¨åŒ–æ‚¨çš„å·¥ä½œæµã€‚åœ¨ç¬¬ 2 éƒ¨åˆ†ä¸­ï¼Œæˆ‘å°†ç»™å‡ºä¸€ä¸ªçœŸå®žçš„ä¾‹å­æ¥å±•ç¤ºå¦‚ä½•ä½¿ç”¨æ°”æµã€‚æˆ‘æƒ³åœ¨è¿™ç¯‡æ–‡ç« ä¸­æŽ©ç›–å®ƒï¼Œä½†å®ƒå·²ç»å¤Ÿé•¿äº†ï¼Œè§£é‡Š **DAGRun** æ¦‚å¿µæ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå®ƒèŠ±äº†æˆ‘ç›¸å½“é•¿çš„æ—¶é—´æ¥å¼„æ¸…æ¥šå®ƒã€‚

*ä¸€å¦‚æ—¢å¾€ï¼Œè¿™ç¯‡æ–‡ç« çš„ä»£ç å¯ä»¥åœ¨ [Github](https://github.com/kadnan/Airflow-Tutorial) ä¸Šæ‰¾åˆ°ã€‚*