# ä½¿ç”¨ TensorFlow.js çš„æ— æœåŠ¡å™¨æœºå™¨å­¦ä¹ 

> åŸæ–‡:[https://dev . to/jthomas/server less-machine-learning-with-tensorflowjs-36eb](https://dev.to/jthomas/serverless-machine-learning-with-tensorflowjs-36eb)

åœ¨[ä¹‹å‰çš„ä¸€ç¯‡åšæ–‡](http://jamesthom.as/blog/2018/08/07/machine-learning-in-node-dot-js-with-tensorflow-dot-js/)ä¸­ï¼Œæˆ‘å±•ç¤ºäº†å¦‚ä½•åœ¨ Node.js ä¸Šä½¿ç”¨ [TensorFlow.js](https://js.tensorflow.org/) å¯¹æ¥è‡ªæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„å›¾åƒè¿è¡Œ[è§†è§‰è¯†åˆ«ã€‚TensorFlow.js æ˜¯ Google å¼€æºæœºå™¨å­¦ä¹ åº“çš„ JavaScript ç‰ˆæœ¬ã€‚](https://gist.github.com/jthomas/145610bdeda2638d94fab9a397eb1f1d#file-script-js)

ä¸€æ—¦æˆ‘ç”¨ä¸€ä¸ªæœ¬åœ° Node.js è„šæœ¬å®Œæˆäº†è¿™ä¸ªå·¥ä½œï¼Œæˆ‘çš„ä¸‹ä¸€ä¸ªæƒ³æ³•å°±æ˜¯æŠŠå®ƒè½¬æ¢æˆä¸€ä¸ªæ— æœåŠ¡å™¨çš„å‡½æ•°ã€‚åœ¨[IBM Cloud Functions](https://console.bluemix.net/openwhisk/)([Apache open whish](https://openwhisk.incubator.apache.org/))ä¸Šè¿è¡Œè¿™ä¸ªå‡½æ•°ä¼šæŠŠè¿™ä¸ªè„šæœ¬å˜æˆæˆ‘è‡ªå·±çš„è§†è§‰è¯†åˆ«å¾®æœåŠ¡ã€‚

[![Serverless TensorFlow.js Function](../Images/fdd11a5d7daf4fb3458aaeff4cab8c7c.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--YRF-ImjK--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/jrugj4ot0kofa6drt609.gif)

å¬èµ·æ¥å¾ˆç®€å•ï¼Œå¯¹å§ï¼Ÿåªæ˜¯ä¸€ä¸ª JavaScript åº“ï¼Ÿæ‰€ä»¥ï¼Œæ‹‰ä¸Šæ‹‰é“¾ï¼Œæˆ‘ä»¬èµ°å§... ***å’³å’³*** ğŸ‘Š

*è½¬æ¢å›¾åƒåˆ†ç±»è„šæœ¬ä»¥åœ¨æ— æœåŠ¡å™¨ç¯å¢ƒä¸­è¿è¡Œé¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜...*

*   **TensorFlow.js åº“éœ€è¦åœ¨è¿è¡Œæ—¶å¯ç”¨ã€‚**
*   å¿…é¡»æ ¹æ®å¹³å°æ¶æ„ç¼–è¯‘åº“çš„æœ¬åœ°ç»‘å®šã€‚
*   éœ€è¦ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½æ¨¡å‹æ–‡ä»¶ã€‚

å…¶ä¸­ä¸€äº›é—®é¢˜æ¯”å…¶ä»–é—®é¢˜æ›´éš¾è§£å†³ï¼è®©æˆ‘ä»¬å…ˆçœ‹çœ‹æ¯ä¸ªé—®é¢˜çš„ç»†èŠ‚ï¼Œç„¶åè§£é‡Šå¦‚ä½•ä½¿ç”¨ Apache OpenWhisk ä¸­çš„ [Docker æ”¯æŒ](http://jamesthom.as/blog/2017/01/16/openwhisk-docker-actions/)æ¥è§£å†³æ‰€æœ‰é—®é¢˜ã€‚

## [](#challenges)æŒ‘æˆ˜

### [](#tensorflowjs-libraries)TensorFlow.js åº“

Apache OpenWhisk æä¾›çš„ [Node.js è¿è¡Œæ—¶](https://github.com/apache/incubator-openwhisk-runtime-nodejs)ä¸­ä¸åŒ…å« TensorFlow.js åº“ã€‚

é€šè¿‡ä» zip æ–‡ä»¶éƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œå¯ä»¥å°†å¤–éƒ¨åº“[å¯¼å…¥](http://jamesthom.as/blog/2016/11/28/npm-modules-in-openwhisk/)åˆ°è¿è¡Œæ—¶ã€‚zip æ–‡ä»¶ä¸­åŒ…å«çš„è‡ªå®šä¹‰`node_modules`æ–‡ä»¶å¤¹å°†åœ¨è¿è¡Œæ—¶æå–ã€‚Zip æ–‡ä»¶è¢«é™åˆ¶åœ¨æœ€å¤§ 48MB çš„ã€‚

#### [](#library-size)åº“å¤§å°

å¯¹æ‰€ä½¿ç”¨çš„ TensorFlow.js åº“è¿è¡Œ`npm install`æ­ç¤ºäº†ç¬¬ä¸€ä¸ªé—®é¢˜...äº§ç”Ÿçš„`node_modules`ç›®å½•æ˜¯ 175MBã€‚ğŸ˜±

çœ‹è¿™ä¸ªæ–‡ä»¶å¤¹çš„å†…å®¹ï¼Œ`tfjs-node`æ¨¡å—ç¼–è¯‘äº†ä¸€ä¸ª[åŸç”Ÿå…±äº«åº“](https://github.com/tensorflow/tfjs-node/tree/master/src)(`libtensorflow.so`)135mã€‚è¿™æ„å‘³ç€å†å°çš„ JavaScript ä»£ç ä¹Ÿæ— æ³•åœ¨ç¥å¥‡çš„ 48 MB é™åˆ¶ä¸‹è·å¾—è¿™äº›å¤–éƒ¨ä¾èµ–ã€‚ğŸ‘

#### [](#native-dependencies)åŸç”Ÿä¾èµ–

å¿…é¡»ä½¿ç”¨å¹³å°è¿è¡Œæ—¶ç¼–è¯‘`libtensorflow.so`æœ¬åœ°å…±äº«åº“ã€‚åœ¨æœ¬åœ°è¿è¡Œ`npm install`ä¼šè‡ªåŠ¨ç¼–è¯‘é’ˆå¯¹ä¸»æœºå¹³å°çš„æœ¬æœºä¾èµ–é¡¹ã€‚æœ¬åœ°ç¯å¢ƒå¯èƒ½ä½¿ç”¨ä¸åŒçš„ CPU æ¶æ„(Mac ä¸ Linux ),æˆ–è€…é“¾æ¥æ— æœåŠ¡å™¨è¿è¡Œæ—¶ä¸­ä¸å¯ç”¨çš„å…±äº«åº“ã€‚

### [](#mobilenet-model-files)MobileNet æ¨¡å‹æ–‡ä»¶

TensorFlow æ¨¡å‹æ–‡ä»¶[éœ€è¦ä» Node.js ä¸­çš„æ–‡ä»¶ç³»ç»Ÿ](https://js.tensorflow.org/tutorials/model-save-load.html)åŠ è½½ã€‚æ— æœåŠ¡å™¨è¿è¡Œæ—¶åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸­æä¾›äº†ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿã€‚åœ¨è°ƒç”¨ä¹‹å‰ï¼Œéƒ¨ç½² zip æ–‡ä»¶ä¸­çš„æ–‡ä»¶ä¼šè‡ªåŠ¨æå–åˆ°è¿™ä¸ªç¯å¢ƒä¸­ã€‚åœ¨æ— æœåŠ¡å™¨åŠŸèƒ½çš„ç”Ÿå‘½å‘¨æœŸä¹‹å¤–ï¼Œæ²¡æœ‰å¯¹è¯¥æ–‡ä»¶ç³»ç»Ÿçš„å¤–éƒ¨è®¿é—®ã€‚

MobileNet æ¨¡å‹çš„æ¨¡å‹æ–‡ä»¶ä¸º 16MBã€‚å¦‚æœè¿™äº›æ–‡ä»¶åŒ…å«åœ¨éƒ¨ç½²åŒ…ä¸­ï¼Œå®ƒå°†ä¸ºåº”ç”¨ç¨‹åºæºä»£ç çš„å…¶ä½™éƒ¨åˆ†ç•™å‡º 32MBã€‚è™½ç„¶æ¨¡å‹æ–‡ä»¶è¶³å¤Ÿå°ï¼Œå¯ä»¥åŒ…å«åœ¨ zip æ–‡ä»¶ä¸­ï¼Œä½†æ˜¯ TensorFlow.js åº“å‘¢ï¼Ÿåšæ–‡åˆ°æ­¤ç»“æŸäº†å—ï¼Ÿæ²¡é‚£ä¹ˆå¿«....

Apache OpenWhisk å¯¹å®šåˆ¶è¿è¡Œæ—¶çš„æ”¯æŒä¸ºæ‰€æœ‰è¿™äº›é—®é¢˜æä¾›äº†ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆï¼

## [](#custom-runtimes)è‡ªå®šä¹‰è¿è¡Œæ—¶

Apache OpenWhisk ä½¿ç”¨ Docker å®¹å™¨ä½œä¸ºæ— æœåŠ¡å™¨åŠŸèƒ½(åŠ¨ä½œ)çš„è¿è¡Œæ—¶ç¯å¢ƒã€‚æ‰€æœ‰å¹³å°è¿è¡Œæ—¶æ˜ åƒéƒ½[å‘å¸ƒåœ¨ Docker Hub](https://hub.docker.com/r/openwhisk/) ä¸Šï¼Œå…è®¸å¼€å‘è€…åœ¨æœ¬åœ°å¯åŠ¨è¿™äº›ç¯å¢ƒã€‚

å¼€å‘è€…è¿˜å¯ä»¥åœ¨åˆ›å»ºåŠ¨ä½œæ—¶æŒ‡å®šå®šåˆ¶çš„è¿è¡Œæ—¶å›¾åƒã€‚è¿™äº›å›¾ç‰‡å¿…é¡»åœ¨ Docker Hub ä¸Šå…¬å¼€ã€‚å®šåˆ¶è¿è¡Œæ—¶å¿…é¡»å…¬å¼€å¹³å°è°ƒç”¨åŠ¨ä½œæ‰€ä½¿ç”¨çš„[ç›¸åŒçš„ HTTP API](https://github.com/apache/incubator-openwhisk/blob/master/docs/actions-new.md#action-interface) ã€‚

ä½¿ç”¨å¹³å°è¿è¡Œæ—¶æ˜ åƒä½œä¸ºçˆ¶æ˜ åƒä½¿æ„å»ºå®šåˆ¶è¿è¡Œæ—¶å˜å¾—ç®€å•ã€‚ç”¨æˆ·å¯ä»¥åœ¨ Docker æ„å»ºæœŸé—´è¿è¡Œå‘½ä»¤æ¥å®‰è£…é¢å¤–çš„åº“å’Œå…¶ä»–ä¾èµ–é¡¹ã€‚çˆ¶æ˜ åƒå·²ç»åŒ…å«å¸¦æœ‰å¤„ç†å¹³å°è¯·æ±‚çš„ HTTP API æœåŠ¡çš„æºæ–‡ä»¶ã€‚

### [](#tensorflowjs-runtime)TensorFlow.js Runtime

ä¸‹é¢æ˜¯ Node.js åŠ¨ä½œè¿è¡Œæ—¶çš„ Docker æ„å»ºæ–‡ä»¶ï¼Œå¸¦æœ‰é¢å¤–çš„ TensorFlow.js ä¾èµ–é¡¹ã€‚

```
FROM openwhisk/action-nodejs-v8:latest

RUN npm install @tensorflow/tfjs @tensorflow-models/mobilenet @tensorflow/tfjs-node jpeg-js

COPY mobilenet mobilenet 
```

`openwhisk/action-nodejs-v8:latest`æ˜¯ OpenWhisk å‘å¸ƒçš„ Node.js åŠ¨ä½œè¿è¡Œæ—¶é•œåƒ[ã€‚](https://hub.docker.com/r/openwhisk/action-nodejs-v8/)

åœ¨æ„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨`npm install`å®‰è£… TensorFlow åº“å’Œå…¶ä»–ä¾èµ–é¡¹ã€‚é€šè¿‡åœ¨æ„å»ºè¿‡ç¨‹ä¸­è¿›è¡Œå®‰è£…ï¼Œ`@tensorflow/tfjs-node`åº“çš„æœ¬æœºä¾èµ–é¡¹ä¼šé’ˆå¯¹æ­£ç¡®çš„å¹³å°è‡ªåŠ¨ç¼–è¯‘ã€‚

å› ä¸ºæˆ‘æ­£åœ¨æ„å»ºä¸€ä¸ªæ–°çš„è¿è¡Œæ—¶ï¼Œæ‰€ä»¥æˆ‘è¿˜å°† [MobileNet æ¨¡å‹æ–‡ä»¶](https://github.com/tensorflow/tfjs-models/tree/master/mobilenet)æ·»åŠ åˆ°äº†æ˜ åƒä¸­ã€‚è™½ç„¶ä¸æ˜¯ç»å¯¹å¿…è¦çš„ï¼Œä½†æ˜¯ä» action zip æ–‡ä»¶ä¸­åˆ é™¤å®ƒä»¬å¯ä»¥å‡å°‘éƒ¨ç½²æ—¶é—´ã€‚

***æƒ³è·³è¿‡ä¸‹ä¸€æ­¥ï¼Ÿä½¿ç”¨è¿™ä¸ªå›¾åƒ [`jamesthomas/action-nodejs-v8:tfjs`](https://hub.docker.com/r/jamesthomas/action-nodejs-v8/) è€Œä¸æ˜¯æ„å»ºä½ è‡ªå·±çš„ã€‚***

### [](#building-the-runtime)æ„å»ºè¿è¡Œæ—¶

åœ¨[ä¹‹å‰çš„åšæ–‡](http://jamesthom.as/blog/2018/08/07/machine-learning-in-node-dot-js-with-tensorflow-dot-js/)ä¸­ï¼Œæˆ‘å±•ç¤ºäº†å¦‚ä½•ä»å…¬å…±å­˜å‚¨æ¡¶ä¸‹è½½æ¨¡å‹æ–‡ä»¶ã€‚

*   ä¸‹è½½ MobileNet æ¨¡å‹çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œå¹¶å°†æ‰€æœ‰æ–‡ä»¶æ”¾åœ¨`mobilenet`ç›®å½•ä¸­ã€‚
*   å°†ä¸Šé¢çš„ Docker æ„å»ºæ–‡ä»¶å¤åˆ¶åˆ°åä¸º`Dockerfile`çš„æœ¬åœ°æ–‡ä»¶ä¸­ã€‚
*   è¿è¡Œ Docker [build å‘½ä»¤](https://docs.docker.com/engine/reference/commandline/build/)ç”Ÿæˆä¸€ä¸ªæœ¬åœ°æ˜ åƒã€‚

```
docker build -t tfjs . 
```

*   [ç”¨è¿œç¨‹ç”¨æˆ·åå’Œå­˜å‚¨åº“æ ‡è®°æœ¬åœ°æ˜ åƒ](https://docs.docker.com/engine/reference/commandline/tag/)ã€‚

```
docker tag tfjs <USERNAME>/action-nodejs-v8:tfjs 
```

*ç”¨æ‚¨çš„ Docker Hub ç”¨æˆ·åæ›¿æ¢`<USERNAME>`ã€‚*

*   [å°†æœ¬åœ°å›¾åƒ](https://docs.docker.com/engine/reference/commandline/push/)æ¨é€åˆ° Docker Hub

```
 docker push <USERNAME>/action-nodejs-v8:tfjs 
```

ä¸€æ—¦ Docker Hub ä¸Šçš„æ˜ åƒ[å¯ç”¨](https://hub.docker.com/r/jamesthomas/action-nodejs-v8/)ï¼Œå°±å¯ä»¥ä½¿ç”¨è¯¥è¿è¡Œæ—¶æ˜ åƒåˆ›å»ºåŠ¨ä½œã€‚ğŸ˜

## [](#example-code)ç¤ºä¾‹ä»£ç 

è¿™ä¸ªæºä»£ç å°†å›¾åƒåˆ†ç±»å®ç°ä¸ºä¸€ä¸ª OpenWhisk åŠ¨ä½œã€‚ä½¿ç”¨äº‹ä»¶å‚æ•°ä¸Šçš„`image`å±æ€§ï¼Œå›¾åƒæ–‡ä»¶ä½œä¸º Base64 ç¼–ç çš„å­—ç¬¦ä¸²æä¾›ã€‚åˆ†ç±»ç»“æœä½œä¸ºå“åº”ä¸­çš„`results`å±æ€§è¿”å›ã€‚

### [](#caching-loaded-models)ç¼“å­˜åŠ è½½çš„æ¨¡å‹

æ— æœåŠ¡å™¨å¹³å°æŒ‰éœ€åˆå§‹åŒ–è¿è¡Œæ—¶ç¯å¢ƒä»¥å¤„ç†è°ƒç”¨ã€‚ä¸€æ—¦åˆ›å»ºäº†ä¸€ä¸ªè¿è¡Œæ—¶ç¯å¢ƒï¼Œå®ƒå°†è¢«[é‡ç”¨ï¼Œä»¥è¿›è¡Œè¿›ä¸€æ­¥çš„è°ƒç”¨](https://medium.com/openwhisk/squeezing-the-milliseconds-how-to-make-serverless-platforms-blazing-fast-aea0e9951bd0),ä½†æœ‰ä¸€äº›é™åˆ¶ã€‚è¿™é€šè¿‡ä»è¯·æ±‚å¤„ç†ä¸­æ¶ˆé™¤åˆå§‹åŒ–å»¶è¿Ÿ(â€œå†·å¯åŠ¨â€)æ¥æé«˜æ€§èƒ½ã€‚

åº”ç”¨ç¨‹åºå¯ä»¥åˆ©ç”¨è¿™ç§è¡Œä¸ºï¼Œé€šè¿‡ä½¿ç”¨å…¨å±€å˜é‡æ¥ç»´æŠ¤è·¨è¯·æ±‚çš„çŠ¶æ€ã€‚è¿™é€šå¸¸ç”¨äº[ç¼“å­˜æ‰“å¼€æ•°æ®åº“è¿æ¥](https://blog.rowanudell.com/database-connections-in-lambda/)æˆ–å­˜å‚¨ä»å¤–éƒ¨ç³»ç»ŸåŠ è½½çš„åˆå§‹åŒ–æ•°æ®ã€‚

æˆ‘å·²ç»ä½¿ç”¨è¿™ä¸ªæ¨¡å¼[ç¼“å­˜äº†ç”¨äºåˆ†ç±»çš„ MobileNet æ¨¡å‹](https://gist.github.com/jthomas/e7c78bbfe4091ed6ace93d1b53cbf6e5#file-index-js-L80-L82)ã€‚åœ¨å†·è°ƒç”¨æœŸé—´ï¼Œæ¨¡å‹ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½å¹¶å­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€å˜é‡ä¸­ã€‚ç„¶åï¼Œçƒ­è°ƒç”¨ä½¿ç”¨è¯¥å…¨å±€å˜é‡çš„å­˜åœ¨æ¥è·³è¿‡è¿›ä¸€æ­¥è¯·æ±‚çš„æ¨¡å‹åŠ è½½è¿‡ç¨‹ã€‚

ç¼“å­˜æ¨¡å‹å‡å°‘äº†çƒ­è°ƒç”¨åˆ†ç±»çš„æ—¶é—´(ä»è€Œå‡å°‘äº†æˆæœ¬)ã€‚

### [](#memory-leak)å†…å­˜æ³„æ¼

ä» IBM Cloud Functions ä¸Šçš„ blog post ä¸­è¿è¡Œ Node.js è„šæœ¬åªéœ€å¾ˆå°‘çš„ä¿®æ”¹ã€‚ä¸å¹¸çš„æ˜¯ï¼Œæ€§èƒ½æµ‹è¯•æ­ç¤ºäº†å¤„ç†å‡½æ•°ä¸­çš„å†…å­˜æ³„æ¼ã€‚ğŸ˜¢

*é˜…è¯»æ›´å¤šå…³äº[tensor flow . js å¦‚ä½•å·¥ä½œçš„ä¿¡æ¯](https://js.tensorflow.org/tutorials/core-concepts.html)åœ¨ Node.js ä¸Šå‘ç°äº†è¿™ä¸ªé—®é¢˜...*

TensorFlow.js çš„ Node.js æ‰©å±•ä½¿ç”¨åŸç”Ÿ C++åº“åœ¨ CPU æˆ– GPU å¼•æ“ä¸Šæ‰§è¡Œå¼ é‡ã€‚æœ¬æœºåº“ä¸­ä¸ºå¼ é‡å¯¹è±¡åˆ†é…çš„å†…å­˜å°†ä¸€ç›´ä¿ç•™ï¼Œç›´åˆ°åº”ç”¨ç¨‹åºæ˜¾å¼é‡Šæ”¾å®ƒæˆ–è¿›ç¨‹é€€å‡ºã€‚TensorFlow.js åœ¨å•ä¸ªå¯¹è±¡ä¸Šæä¾›äº†ä¸€ä¸ª`dispose`æ–¹æ³•æ¥é‡Šæ”¾åˆ†é…çš„å†…å­˜ã€‚è¿˜æœ‰ä¸€ä¸ª`tf.tidy`æ–¹æ³•å¯ä»¥è‡ªåŠ¨æ¸…ç†ä¸€ä¸ªå¸§å†…æ‰€æœ‰åˆ†é…çš„å¯¹è±¡ã€‚

å›é¡¾ä»£ç ï¼Œå¼ é‡è¢«åˆ›å»ºä¸ºæ¥è‡ªå›¾åƒçš„[æ¨¡å‹è¾“å…¥ã€‚è¿™äº›å¯¹è±¡åœ¨ä»è¯·æ±‚å¤„ç†ç¨‹åºè¿”å›ä¹‹å‰æ²¡æœ‰è¢«é‡Šæ”¾ã€‚è¿™æ„å‘³ç€æœ¬åœ°å†…å­˜å˜å¾—æ— é™ã€‚æ·»åŠ ä¸€ä¸ªæ˜¾å¼çš„`dispose`è°ƒç”¨ï¼Œåœ¨è¿”å›](https://gist.github.com/jthomas/e7c78bbfe4091ed6ace93d1b53cbf6e5#file-index-js-L51-L59)[ä¹‹å‰é‡Šæ”¾è¿™äº›å¯¹è±¡ï¼Œä¿®å¤äº†é—®é¢˜](https://gist.github.com/jthomas/e7c78bbfe4091ed6ace93d1b53cbf6e5#file-index-js-L91)ã€‚

### [](#profiling-amp-performance)å‰–æ&è¡¨ç°

åŠ¨ä½œä»£ç è®°å½•åˆ†ç±»è¿‡ç¨‹ä¸­ä¸åŒé˜¶æ®µçš„å†…å­˜ä½¿ç”¨æƒ…å†µå’Œè¿è¡Œæ—¶é—´ã€‚

è®°å½•[å†…å­˜ä½¿ç”¨æƒ…å†µ](https://gist.github.com/jthomas/e7c78bbfe4091ed6ace93d1b53cbf6e5#file-index-js-L12-L20)å…è®¸æˆ‘ä¿®æ”¹åˆ†é…ç»™è¯¥å‡½æ•°çš„æœ€å¤§å†…å­˜ï¼Œä»¥è·å¾—æœ€ä½³æ€§èƒ½å’Œæˆæœ¬ã€‚Node.js æä¾›äº†ä¸€ä¸ª[æ ‡å‡†åº“ API](https://nodejs.org/docs/v0.4.11/api/all.html#process.memoryUsage) æ¥æ£€ç´¢å½“å‰è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨æƒ…å†µã€‚è®°å½•è¿™äº›å€¼å…è®¸æˆ‘æ£€æŸ¥ä¸åŒé˜¶æ®µçš„å†…å­˜ä½¿ç”¨æƒ…å†µã€‚

å®šæ—¶[åˆ†ç±»è¿‡ç¨‹ä¸­çš„ä¸åŒä»»åŠ¡](https://gist.github.com/jthomas/e7c78bbfe4091ed6ace93d1b53cbf6e5#file-index-js-L71)ï¼Œå³æ¨¡å‹åŠ è½½ã€å›¾åƒåˆ†ç±»ï¼Œè®©æˆ‘æ·±å…¥äº†è§£åˆ†ç±»ä¸å…¶ä»–æ–¹æ³•ç›¸æ¯”æœ‰å¤šé«˜æ•ˆã€‚Node.js æœ‰ä¸€ä¸ª[æ ‡å‡†åº“ API](https://nodejs.org/api/console.html#console_console_time_label) ï¼Œç”¨äºè®¡æ—¶å™¨è®°å½•è¿è¡Œæ—¶é—´å¹¶æ‰“å°åˆ°æ§åˆ¶å°ã€‚

## [](#demo)æ¼”ç¤º

### [](#deploy-action)éƒ¨ç½²è¡ŒåŠ¨

*   ä½¿ç”¨ [IBM Cloud CLI](https://console.bluemix.net/openwhisk/learn/cli) è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»ºæ“ä½œã€‚

```
ibmcloud fn action create classify --docker <IMAGE_NAME> index.js 
```

*å°†`<IMAGE_NAME>`æ›¿æ¢ä¸ºè‡ªå®šä¹‰è¿è¡Œæ—¶çš„å…¬å…± Docker Hub æ˜ åƒæ ‡è¯†ç¬¦ã€‚å¦‚æœæ‚¨æ²¡æœ‰æ‰‹åŠ¨æ„å»ºï¼Œè¯·ä½¿ç”¨`jamesthomas/action-nodejs-v8:tfjs`ã€‚*

### [](#testing-it-out)è¯•æ¢ä¸€ä¸‹

*   ä»ç»´åŸºç™¾ç§‘ä¸‹è½½è¿™å¼ ç†ŠçŒ«çš„å›¾ç‰‡ã€‚

[![Panda](../Images/5aee62fca734617b73cf497cfebfb223.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--J9LVA8k8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/su9xscczsrjvwgcjlpyx.jpg)

```
wget http://bit.ly/2JYSal9 -O panda.jpg 
```

*   ä½¿ç”¨ Base64 ç¼–ç çš„å›¾åƒä½œä¸ºè¾“å…¥å‚æ•°è°ƒç”¨åŠ¨ä½œã€‚

```
 ibmcloud fn action invoke classify -r -p image $(base64 panda.jpg) 
```

*   è¿”å›çš„ JSON æ¶ˆæ¯åŒ…å«åˆ†ç±»æ¦‚ç‡ã€‚ğŸ¼ğŸ¼ğŸ¼

```
{  "results":  [{  className:  'giant  panda,  panda,  panda  bear,  coon  bear',  probability:  0.9993536472320557  }]  } 
```

### [](#activation-details)æ¿€æ´»è¯¦æƒ…

*   æ£€ç´¢ä¸Šæ¬¡æ¿€æ´»çš„æ—¥å¿—è®°å½•è¾“å‡ºï¼Œä»¥æ˜¾ç¤ºæ€§èƒ½æ•°æ®ã€‚

```
ibmcloud fn activation logs --last 
```

***åˆ†æå’Œå†…å­˜ä½¿ç”¨è¯¦ç»†ä¿¡æ¯è¢«è®°å½•åˆ° stdout***

```
prediction function called.
memory used: rss=150.46 MB, heapTotal=32.83 MB, heapUsed=20.29 MB, external=67.6 MB
loading image and model...
decodeImage: 74.233ms
memory used: rss=141.8 MB, heapTotal=24.33 MB, heapUsed=19.05 MB, external=40.63 MB
imageByteArray: 5.676ms
memory used: rss=141.8 MB, heapTotal=24.33 MB, heapUsed=19.05 MB, external=45.51 MB
imageToInput: 5.952ms
memory used: rss=141.8 MB, heapTotal=24.33 MB, heapUsed=19.06 MB, external=45.51 MB
mn_model.classify: 274.805ms
memory used: rss=149.83 MB, heapTotal=24.33 MB, heapUsed=20.57 MB, external=45.51 MB
classification results: [...]
main: 356.639ms
memory used: rss=144.37 MB, heapTotal=24.33 MB, heapUsed=20.58 MB, external=45.51 MB 
```

`main`æ˜¯åŠ¨ä½œå¤„ç†ç¨‹åºçš„æ€»è¿è¡Œæ—¶é—´ã€‚`mn_model.classify`æ˜¯å›¾åƒåˆ†ç±»æ‰€ç”¨çš„æ—¶é—´ã€‚å†·å¯åŠ¨è¯·æ±‚æ‰“å°ä¸€æ¡é¢å¤–çš„æ—¥å¿—ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¨¡å‹åŠ è½½æ—¶é—´ï¼Œ`loadModel: 394.547ms`ã€‚

## [](#performance-results)æ€§èƒ½ç»“æœ

é’ˆå¯¹å†·æ¿€æ´»å’Œçƒ­æ¿€æ´»è°ƒç”¨`classify`åŠ¨ä½œ 1000 æ¬¡(ä½¿ç”¨ 256MB å†…å­˜)ä¼šäº§ç”Ÿä»¥ä¸‹æ€§èƒ½ç»“æœã€‚

### [](#warm-invocations)æ¸©æš–çš„ç¥ˆæ„¿

[![Warm Activation Performance Results](../Images/138b889e7e7337e68fbb192100d72a80.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--7RTJoDm9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/4i7ii902of646eww8vrq.png)

å½“ä½¿ç”¨æ¸©æš–çš„ç¯å¢ƒæ—¶ï¼Œåˆ†ç±»å¹³å‡éœ€è¦ **316 æ¯«ç§’æ¥å¤„ç†ã€‚æŸ¥çœ‹è®¡æ—¶æ•°æ®ï¼Œå°† Base64 ç¼–ç çš„ JPEG è½¬æ¢ä¸ºè¾“å…¥å¼ é‡å¤§çº¦éœ€è¦ 100 æ¯«ç§’ã€‚è¿è¡Œæ¨¡å‹åˆ†ç±»ä»»åŠ¡éœ€è¦ 200 - 250 æ¯«ç§’ã€‚**

### [](#cold-invocations)å¯’å¼•ç´ 

[![Cold Activation Performance Results](../Images/f8ce184042f089ae9866978a93fc1049.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--O17w9TOH--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/23h2f07sm3pm5fvq887r.png)

ä½¿ç”¨å†·ç¯å¢ƒæ—¶ï¼Œå¤„ç†åˆ†ç±»å¹³å‡éœ€è¦ **1260 æ¯«ç§’ã€‚è¿™äº›è¯·æ±‚ä¼šå¯¼è‡´åˆå§‹åŒ–æ–°çš„è¿è¡Œæ—¶å®¹å™¨å’Œä»æ–‡ä»¶ç³»ç»ŸåŠ è½½æ¨¡å‹çš„ä»£ä»·ã€‚è¿™ä¸¤é¡¹ä»»åŠ¡éƒ½èŠ±è´¹äº†å¤§çº¦ 400 æ¯«ç§’ã€‚**

åœ¨ Apache OpenWhisk ä¸­ä½¿ç”¨å®šåˆ¶è¿è¡Œæ—¶æ˜ åƒçš„ä¸€ä¸ªç¼ºç‚¹æ˜¯ç¼ºå°‘é¢„çƒ­çš„å®¹å™¨ã€‚é¢„çƒ­é€šè¿‡åœ¨éœ€è¦è¿è¡Œæ—¶å®¹å™¨ä¹‹å‰å¯åŠ¨å®ƒä»¬æ¥å‡å°‘å†·å¯åŠ¨æ—¶é—´ã€‚éæ ‡å‡†è¿è¡Œæ—¶æ˜ åƒä¸æ”¯æŒè¿™ä¸€ç‚¹ã€‚

### [](#classification-cost)åˆ†ç±»æˆæœ¬

IBM Cloud Functions [æä¾›æ¯æœˆ 400ï¼Œ000 GB/s çš„å…è´¹å±‚](https://console.bluemix.net/openwhisk/learn/pricing)ã€‚æ¯å¤šæ‰§è¡Œä¸€ç§’é’Ÿï¼Œæ¯åˆ†é…ä¸€ GB å†…å­˜æ”¶å– 0.000017 ç¾å…ƒçš„è´¹ç”¨ã€‚æ‰§è¡Œæ—¶é—´å››èˆäº”å…¥åˆ°æœ€æ¥è¿‘çš„ 100 æ¯«ç§’ã€‚

å¦‚æœæ‰€æœ‰æ¿€æ´»éƒ½æ˜¯çƒ­æ¿€æ´»ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¸€ä¸ª 256MB çš„æ“ä½œåœ¨è‡ªç”±å±‚ä¸­æ¯æœˆæ‰§è¡Œ**è¶…è¿‡ 4ï¼Œ000ï¼Œ000 ä¸ªåˆ†ç±»ã€‚ä¸€æ—¦è¶…å‡ºå…è´¹å±‚ï¼Œå¤§çº¦ 600ï¼Œ000 æ¬¡è¿›ä¸€æ­¥è°ƒç”¨çš„æˆæœ¬å°†è¶…è¿‡ 1 ç¾å…ƒã€‚**

å¦‚æœæ‰€æœ‰æ¿€æ´»éƒ½æ˜¯å†·æ¿€æ´»ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¸€ä¸ª 256MB çš„æ“ä½œåœ¨è‡ªç”±å±‚ä¸­æ¯æœˆæ‰§è¡Œ**è¶…è¿‡ 1ï¼Œ200ï¼Œ000 ä¸ªåˆ†ç±»ã€‚ä¸€æ—¦è¶…å‡ºå…è´¹å±‚ï¼Œå¤§çº¦ 180ï¼Œ000 æ¬¡è¿›ä¸€æ­¥è°ƒç”¨çš„æˆæœ¬å°†è¶…è¿‡ 1 ç¾å…ƒã€‚**

## [](#conclusion)ç»“è®º

TensorFlow.js ä¸º JavaScript å¼€å‘è€…å¸¦æ¥äº†æ·±åº¦å­¦ä¹ çš„åŠ›é‡ã€‚é€šè¿‡ TensorFlow.js åº“ä½¿ç”¨é¢„å…ˆè®­ç»ƒçš„æ¨¡å‹ï¼Œå¯ä»¥ç”¨æœ€å°‘çš„å·¥ä½œå’Œä»£ç è½»æ¾æ‰©å±• JavaScript åº”ç”¨ç¨‹åºï¼Œå®Œæˆå¤æ‚çš„æœºå™¨å­¦ä¹ ä»»åŠ¡ã€‚

è·å¾—ä¸€ä¸ªæœ¬åœ°è„šæœ¬æ¥è¿è¡Œå›¾åƒåˆ†ç±»ç›¸å¯¹ç®€å•ï¼Œä½†æ˜¯è½¬æ¢æˆæ— æœåŠ¡å™¨åŠŸèƒ½å¸¦æ¥äº†æ›´å¤šçš„æŒ‘æˆ˜ï¼Apache OpenWhisk å°†æœ€å¤§åº”ç”¨ç¨‹åºå¤§å°é™åˆ¶ä¸º 50MBï¼Œè€Œæœ¬åœ°åº“ä¾èµ–é¡¹è¿œè¿œè¶…è¿‡äº†è¿™ä¸ªé™åˆ¶ã€‚

å¹¸è¿çš„æ˜¯ï¼ŒApache OpenWhisk çš„è‡ªå®šä¹‰è¿è¡Œæ—¶æ”¯æŒå…è®¸æˆ‘ä»¬è§£å†³æ‰€æœ‰è¿™äº›é—®é¢˜ã€‚é€šè¿‡ä½¿ç”¨æœ¬æœºä¾èµ–é¡¹å’Œæ¨¡å‹æ–‡ä»¶æ„å»ºè‡ªå®šä¹‰è¿è¡Œæ—¶ï¼Œè¿™äº›åº“å¯ä»¥åœ¨å¹³å°ä¸Šä½¿ç”¨ï¼Œè€Œæ— éœ€å°†å®ƒä»¬åŒ…å«åœ¨éƒ¨ç½²åŒ…ä¸­ã€‚