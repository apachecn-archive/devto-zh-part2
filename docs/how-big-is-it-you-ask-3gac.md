# “它有多大？”你问？

> 原文：<https://dev.to/ferricoxide/how-big-is-it-you-ask-3gac>

对于我支持的一个项目，他们想部署到一个受控网络中。然而，他们希望能够灵活地支持网络中系统，能够根据需要获取特性并修补 rpm(和其他东西)。在一个受控的网络中，他们不想通过让一堆系统直接从互联网上获取数据来压倒安全网关。创建一个本地缓存，对其进行一次恶意扫描*，比在每个系统执行和单独读取时对相同的内容进行多次恶意扫描要高效得多。结果:希望托管相关上游软件存储库的受控预扫描镜像。*

 *这就引出了一个问题，“我们*需要*镜像什么？”我强调“需求”这个词，因为这个客户习惯于从手工而不是自动化的角度来思考(也和他们一起工作)。由于这种手动思维模式，他们希望围绕任务保持较小的数据集。

不幸的是，他们对小的想法也有点过时了。对他们来说，100 gib——至少对软件仓库来说——属于“不小”的范畴。对我来说，如果我能在手机上安装一些东西，那就是少量的数据。我们将忽略这样一个事实，即我对我可以将 512GiB 微型 SD 卡插入我的手机存有偏见。无论如何，他们希望最大限度地减少需要镜像的存储库和通道的数量，这样他们就可以保持少量的拷贝工作。我指出“你想让这些系统拥有与它们没有被阻止直接从互联网下载时相似的抓取功能:这意味着你需要<insert exhaustive="" list="" of="" repositories="" and="" channels="">”。自然，他们犹豫了。有人问了“你怎么知道他们真的需要所有这些”和“所有这些需要多少空间”这样的问题(有一定程度的过度紧张)。</insert>

我指出，我不能有意义地回答前一个问题，因为我不属于将在受控网络中部署的系统的设计组。我还指出，他们可能更好地询问潜在系统的所有者他们预期需要什么(非常清楚，通常，这样的问题的答案在“我不确定，但是”附近的某个地方)。因此，我的详尽清单是一种对冲:拥有而不需要比需要而不拥有要好。考虑到存储的愚蠢廉价，以及实际上同步给定存储库中的所有频道会更容易，而不是同步一个子集，我看不出不使用存储来解决这个问题有什么好处。

对于第二个问题，我指出，“我是坐在这个会上，不是在电脑前。一旦我回到我的办公桌，我可以给你一个完整的，一个频道一个频道的分析。

yum 存储库(特性和补丁 rpm 将来自于此)的一个优点是，它们可以很容易地查询项目计数和聚合大小。唯一真正的缺点是，操作系统内置的工具更适合以人为中心的特别查询，而不是那些可以塞进 Excel 电子表格和正在运行的`=SUM`公式的东西。换句话说，大小是以“友好的”单位表示的:如果你有 100KiB 的数据，这个数字是以 KiB 为单位报告的；如果你有 1055KiB 的数据，这个数字在 MiB 中报告；诸如此类。因此，我需要“包装”本机工具输出，将所有内容放入一致的单位中(Excel 更喜欢=苏明和其他数学运算)。因为这是一个“快速”任务，所以我在 BASH 中完成了它。回想起来，使用另一种语言可能不会那么糟糕。然而，我想出了创建一个 CSV:

```
#!/bin/bash

for YUM in $(
 yum repolist all | awk '/abled/{ print $1}' | \
 sed -e '{
 /-test/d
 /-debuginfo/d
 /-source/d
 /-media/d
 }' | sed 's/\/.\*$//'
 )
do
IFS=$'
'
 REPOSTRUCT=($(
 yum --disablerepo=\* --enablerepo=${YUM} repolist -v | \
 grep ^Repo- | grep -E "(id|-name|pkgs|size) \*:" | \
 sed 's/ \*: /:/'
 ))
 unset IFS

 REPSZ=($(echo "${REPOSTRUCT[3]}" | sed 's/^Repo-size://'))

 if [[$( echo "${REPSZ[1]}" ) = M ]]
 then
 SIZE=$(echo "${REPSZ[0]} \* 1024" | bc)
 elif [[$( echo "${REPSZ[1]}" ) = G ]]
 then
 SIZE=$(echo "${REPSZ[0]} \* 1024 \* 1024 " | bc)
 else
 SIZE="${REPSZ[0]}"
 fi

 for CT in 0 1 2
 do
 printf "%s;" "${REPOSTRUCT[${CT}]}"
 done
 echo ${SIZE}
done | sed 's/Repo-[a-z]\*://' 
```

Enter fullscreen mode Exit fullscreen mode

是...可怕的，可能远远不是最佳的...但是不值得我花时间(即使我有的话)去重温。它完成了工作，而且编写可怕的代码来解决你一开始不想被要求解决的问题也有一定的乐趣。

无论如何，对照我们希望为项目镜像的所有回购协议，*初始同步*数据集将适合我的手机(无需升级到最高端的[设备](https://www.bhphotovideo.com/c/product/1274443-REG/pny_technologies_p_sdx512u3h_ge_sdhc_95mb_sec_512gb.html))。指出唯一的初始同步将是“大”的，并且只有几个频道以类似规律性的方式更新(其余的基本上是静态的)，每月的增量同步将会小得多并且微不足道。所以，我们将会看到这是否能减轻他们的焦虑。*