# ååº”æœ¬åœ°ä½ç½®è·Ÿè¸ª

> åŸæ–‡:[https://dev . to/vikrantnegi/react-native-location-tracking-32o 7](https://dev.to/vikrantnegi/react-native-location-tracking-32o7)

[![](../Images/a270ac1f9e52c455bc54dbaf967c8b88.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--p8I29wXY--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/z8404b4p03988nb64m6q.gif)

å¦‚æœä½ ä¸€ç›´åœ¨ä½¿ç”¨ React Nativeï¼Œä½ ä¸€å®šç”¨è¿‡æˆ–è€…å¬è¯´è¿‡ react-native-mapsã€‚React native maps æ˜¯ä¸€ä¸ª React native åŒ…ï¼Œå®ƒä¸º react native æä¾›äº† Google Maps APIã€‚ä½¿ç”¨é™æ€è°·æ­Œåœ°å›¾æ˜¯éå¸¸å¸¸è§çš„ï¼Œä½†ä»Šå¤©æˆ‘ä»¬å°†ä½¿ç”¨è°·æ­Œåœ°å›¾çš„ä¸€ä¸ªå¹¿æ³›ä½¿ç”¨çš„åŠŸèƒ½ï¼Œä½¿ç”¨ React native è¿›è¡Œä½ç½®è·Ÿè¸ªã€‚

> åœ¨æ­¤æ‰¾åˆ°é¡¹ç›®å›è´­

## [](#getting-started)å…¥é—¨

é¦–å…ˆåˆ›å»ºä¸€ä¸ª React åŸç”Ÿé¡¹ç›®ï¼Œå¹¶éšæ„å‘½åã€‚æˆ‘ä½¿ç”¨çš„æ˜¯ react-native-cliï¼Œä½† [create-react-native-app](https://github.com/react-community/create-react-native-app) åº”è¯¥ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œã€‚

`react-native init locationTracking`

## [T1ã€‘å®‰è£… react-native-maps](#installing-reactnativemaps)

é¦–å…ˆï¼Œä» npm ä¸‹è½½è¿™ä¸ªåº“:

`npm install react-native-maps --save`

å®‰è£… react-native-maps éœ€è¦åœ¨åŸç”Ÿ iOS å’Œ Android æ–‡ä»¶ä¸­æ·»åŠ ä»£ç ã€‚éµå¾ª react-native-maps æä¾›çš„å®‰è£…è¯´æ˜ã€‚å®‰è£…åï¼Œç¡®ä¿é¡¹ç›®æˆåŠŸæ„å»ºï¼Œç„¶åå†ç»§ç»­ã€‚

å®‰è£… react-native-maps ä¸æ˜¯ä¸€é¡¹ç®€å•çš„ä»»åŠ¡ã€‚å¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡è¿™æ ·åšï¼Œæˆ‘å»ºè®®ä»”ç»†é˜…è¯»[å®‰è£…](https://github.com/react-community/react-native-maps/blob/master/docs/installation.md)è¯´æ˜ã€‚ç›¸ä¿¡æˆ‘ï¼Œè¿™å°†æ˜¯æœ¬æ•™ç¨‹ä¸­æœ€å›°éš¾çš„ä»»åŠ¡ã€‚å¦‚æœä½ é‡åˆ°ä»»ä½•é”™è¯¯ï¼Œè¯·ä½¿ç”¨è°·æ­Œã€‚

## [](#using-reactnativemaps)ä½¿ç”¨ react-native-map

å¾ˆå¥½ï¼Œç°åœ¨æ‚¨å·²ç»æˆåŠŸå®‰è£…äº† react-native-mapsã€‚è®©æˆ‘ä»¬è¿›å…¥æœ‰è¶£çš„éƒ¨åˆ†ï¼ŒçœŸæ­£çš„å¥‡è¿¹å‘ç”Ÿäº†ã€‚è®©æˆ‘ä»¬é¦–å…ˆè®¾ç½®ä¸€äº›å°†ç”¨äºè¿™ä¸ªé¡¹ç›®çš„åˆå§‹çŠ¶æ€ã€‚

```
constructor(props) {
  super(props);
  this.state = {
    latitude: LATITUDE,
    longitude: LONGITUDE,
    routeCoordinates: [],
    distanceTravelled: 0,
    prevLatLng: {},
    coordinate: new AnimatedRegion({
     latitude: LATITUDE,
     longitude: LONGITUDE
    })
  };
} 
```

æˆ‘ä»¬å°†åœ¨åº”ç”¨ç¨‹åºçš„åé¢ä½¿ç”¨è¿™äº›çŠ¶æ€ï¼Œè¿™é‡Œå”¯ä¸€æ„Ÿå…´è¶£çš„æ˜¯æ–°çš„`AnimatedRegion`ï¼Œå®ƒå°†å¸®åŠ©æˆ‘ä»¬åœ¨ä½ç½®æ›´æ–°æ—¶æ¿€æ´»æˆ‘ä»¬çš„æ ‡è®°ã€‚

## [](#watch-for-location-changes)æ³¨æ„ä½ç½®å˜åŒ–

ç°åœ¨æˆ‘ä»¬éœ€è¦è·å¾—ç”¨æˆ·æ¯æ¬¡ç§»åŠ¨çš„ä½ç½®åæ ‡ã€‚è°·æ­Œåœ°å›¾åœ°ç†å®šä½ API æœ‰ä¸€ä¸ª`watchPosition`æ–¹æ³•ï¼Œæ— è®ºä½•æ—¶ä½ç½®åæ ‡å‘ç”Ÿå˜åŒ–ï¼Œå®ƒéƒ½ä¼šå¸®åŠ©æˆ‘ä»¬è·å–ä½ç½®åæ ‡ã€‚

```
componentDidMount() {
  this.watchID = navigator.geolocation.watchPosition(
    position => {
      const { coordinate, routeCoordinates, distanceTravelled } =   this.state;
      const { latitude, longitude } = position.coords;

      const newCoordinate = {
        latitude,
        longitude
      };
      if (Platform.OS === "android") {
        if (this.marker) {
          this.marker._component.animateMarkerToCoordinate(
            newCoordinate,
            500
          );
         }
       } else {
         coordinate.timing(newCoordinate).start();
       }
       this.setState({
         latitude,
         longitude,
         routeCoordinates: routeCoordinates.concat([newCoordinate]),
         distanceTravelled:
         distanceTravelled + this.calcDistance(newCoordinate),
         prevLatLng: newCoordinate
       });
     },
     error => console.log(error),
     { enableHighAccuracy: true, timeout: 20000, maximumAge: 1000 }
  );
} 
```

æ¯å½“ç”¨æˆ·çš„ä½ç½®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œç›‘è§†ä½ç½®å°±ä¼šç»™æˆ‘ä»¬æä¾›æœ‰å…³ç”¨æˆ·ä½ç½®çš„ä¿¡æ¯ã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ ES6 [ææ„](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment)ä»ä½ç½®åæ ‡è·å¾—çº¬åº¦&ç»åº¦ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å°†è·å¾—åæ ‡ï¼Œä»åˆå§‹çŠ¶æ€ç§»åŠ¨çš„è·¯å¾„åæ ‡&è·ç¦»ã€‚

ç„¶åï¼Œæˆ‘ä»¬å°†åˆ›å»º newCoordinate å˜é‡ï¼Œè¯¥å˜é‡å°†å­˜å‚¨æˆ‘ä»¬ä» position.coords æ”¶åˆ°çš„è¿™äº›æ–°çš„æ›´æ–°ä½ç½®åæ ‡ã€‚ç°åœ¨æˆ‘ä»¬å·²ç»è·å¾—äº†æ›´æ–°åæ ‡ï¼Œæˆ‘ä»¬å°†æ ¹æ®è¿™äº›æ–°åæ ‡åˆ¶ä½œæ ‡è®°åŠ¨ç”»ã€‚Android å’Œ iOS æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ä½¿ç”¨[å¹³å°ç‰¹å®šä»£ç ](https://facebook.github.io/react-native/docs/platform-specific-code.html)æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚

```
if (Platform.OS === "android") {
  if (this.marker) {
  this.marker._component.animateMarkerToCoordinate(
    newCoordinate,
    500
   );
  }
} else {
  coordinate.timing(newCoordinate).start();
} 
```

ç°åœ¨æ˜¯ç”¨æ–°çš„çŠ¶æ€æ›´æ–°åˆå§‹çŠ¶æ€çš„æ—¶å€™äº†ã€‚

```
this.setState({
  latitude,
  longitude,
  routeCoordinates: routeCoordinates.concat([newCoordinate]),
  distanceTravelled: distanceTravelled + this.calcDistance(newCoordinate),
  prevLatLng: newCoordinate
}); 
```

## [](#calculating-distance-travelled)è®¡ç®—è¡Œè¿›çš„è·ç¦»

æˆ‘ä»¬ä½¿ç”¨ distance travelled çŠ¶æ€å˜é‡æ¥å­˜å‚¨ç”¨æˆ·è¡Œé©¶çš„è·ç¦»ã€‚ä¸ºäº†è®¡ç®—è¿™ä¸ªè·ç¦»ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•° calcDistanceï¼Œå®ƒå°† newLatLng ä½œä¸ºå‚æ•°ï¼ŒprevLatLng ä½œä¸ºçŠ¶æ€å˜é‡ï¼Œå¹¶å°†è¿”å›è·ç¦»ã€‚

```
calcDistance = newLatLng => {
  const { prevLatLng } = this.state;
  return haversine(prevLatLng, newLatLng) || 0;
}; 
```

çœ‹ç€è¿™ä¸ªå‡½æ•°ï¼Œä½ å¯èƒ½æƒ³çŸ¥é“ä»€ä¹ˆæ—¶å€™è®¡ç®—è·ç¦»å˜å¾—å¦‚æ­¤å¤æ‚ã€‚æ˜¾ç„¶ï¼Œç”±äºåœ°çƒçš„æ›²ç‡ï¼Œå€ŸåŠ©çº¬åº¦å’Œç»åº¦è®¡ç®—è·ç¦»å¹¶ä¸é‚£ä¹ˆç®€å•ã€‚åœ°çƒæœ‰ä¸€äº›æ›²çº¿ã€‚

ä¸ºäº†ä½¿ç”¨çº¬åº¦å’Œç»åº¦è®¡ç®—è·ç¦»ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨[å“ˆå¼—è¾›](https://en.wikipedia.org/wiki/Haversine_formula)å…¬å¼ã€‚å¦‚æœä½ åƒæˆ‘ä¸€æ ·çº ç»“äºæ•°å­¦ğŸ˜…å“ˆä½›å¤§å­¦çš„ npm è½¯ä»¶åŒ…æœ‰æœ›å¸®åŠ©æˆ‘ä»¬ä½¿ç”¨çº¬åº¦å’Œç»åº¦è®¡ç®—è·ç¦»ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£… haversine npm åŒ…ã€‚

`npm install haversine`

## [](#rendering-mapview)æ¸²æŸ“ MapView

å› ä¸ºç»„ä»¶éœ€è¦æ¥å—å¸¦æœ‰ä½ç½®åæ ‡å¯¹è±¡çš„åŒºåŸŸå±æ€§ã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›æ‰€éœ€çš„æ‰€æœ‰å¿…è¦ä¿¡æ¯ã€‚

```
getMapRegion = () => ({
  latitude: this.state.latitude,
  longitude: this.state.longitude,
  latitudeDelta: LATITUDE_DELTA,
  longitudeDelta: LONGITUDE_DELTA
}); 
```

ç°åœ¨æˆ‘ä»¬æœ‰äº†æ¸²æŸ“åœ°å›¾æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚

```
<MapView
  style={styles.map}
  showUserLocation
  followUserLocation
  loadingEnabled
  region={this.getMapRegion()}
>
  <Polyline coordinates={this.state.routeCoordinates} strokeWidth={5} />
  <Marker.Animated
    ref={marker => {
      this.marker = marker;
    }}
    coordinate={this.state.coordinate}
  />
</MapView> 
```

æˆ‘ä»¬è¿˜ä½¿ç”¨è°·æ­Œåœ°å›¾æŠ˜çº¿æ¥ç»˜åˆ¶ç”¨æˆ·ç§»åŠ¨çš„è·¯å¾„ã€‚æŠ˜çº¿æœ‰ä¸€ä¸ªåæ ‡å±æ€§ï¼Œå®ƒæ¥å—ä¸€ä¸ªåæ ‡æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„å¯ä»¥ä»æˆ‘ä»¬çš„ routeCoordinates ä¸­è·å¾—ã€‚æˆ‘ä»¬è¿˜å°† strokeWidth è®¾ç½®ä¸ºï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°è·¯å¾„ã€‚

æ¥ä¸‹æ¥æ˜¾ç¤ºåŠ¨ç”»æ ‡è®°ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ ‡è®°ã€‚åœ¨ç”¨æˆ·å½“å‰ä½ç½®æ˜¾ç¤ºæ ‡è®°çš„åŠ¨ç”»ç»„ä»¶ã€‚å®ƒæœ‰åæ ‡å±æ€§ï¼Œå¯ä»¥ä»çŠ¶æ€ä¸­è·å–åæ ‡å¯¹è±¡ã€‚

## [](#show-distance-travelled)æ˜¾ç¤ºè¡Œé©¶çš„è·ç¦»

æœ€åï¼Œä¸ºäº†æ˜¾ç¤ºç”¨æˆ·èµ°è¿‡çš„è·ç¦»ï¼Œæˆ‘ä»¬å°†è®¾ç½®ä¸€ä¸ªåº”ç”¨äº†é€‚å½“æ ·å¼çš„è§†å›¾ã€‚

```
<View style={styles.buttonContainer}>
  <TouchableOpacity style={[styles.bubble, styles.button]}>
    <Text style={styles.bottomBarContent}>
      {parseFloat(this.state.distanceTravelled).toFixed(2)} km
    </Text>
  </TouchableOpacity>
</View> 
```

## [](#testing)æµ‹è¯•

ç°åœ¨æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†æ‰€æœ‰å¿…è¦çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥è¿è¡Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºäº†ã€‚

ä¸ºäº†åœ¨ iOS æ¨¡æ‹Ÿå™¨ä¸Šæµ‹è¯•è¯¥åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ iOS æ¨¡æ‹Ÿå™¨ä¸­å¯ç”¨çš„å®šä½æ¨¡å¼ã€‚è¿è¡Œåº”ç”¨ç¨‹åºåï¼Œè¿›å…¥æ¨¡æ‹Ÿå™¨ä¸­çš„`Debug` > `Location` > `Freeway Drive`è®¾ç½®ä»¥æ‰“å¼€æ­¤åŠŸèƒ½ã€‚è¿™æ ·åšåº”è¯¥ä¼šäº§ç”Ÿç±»ä¼¼ä¸‹é¢çš„ç»“æœã€‚

[![](../Images/a270ac1f9e52c455bc54dbaf967c8b88.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--p8I29wXY--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/z8404b4p03988nb64m6q.gif)

å¯¹äº Androidï¼Œè¿™å¹¶ä¸ç®€å•ï¼Œå› ä¸º Android æ¨¡æ‹Ÿå™¨æ²¡æœ‰ä»»ä½•å†…ç½®åŠŸèƒ½æ¥æµ‹è¯•åŠ¨æ€ä½ç½®å˜åŒ–ã€‚ä¸ºäº†æµ‹è¯•å®ƒï¼Œä½ å¯ä»¥é€šè¿‡æ­¥è¡Œä¸€æ®µè·ç¦»æ¥æ‰‹åŠ¨æ”¹å˜ä½ çš„ä½ç½®ï¼Œæˆ–è€…ä½ å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹æ¨¡æ‹Ÿå®šä½åº”ç”¨ç¨‹åºã€‚æˆ‘èƒ½å¤Ÿåœ¨ Android ä¸Šä½¿ç”¨ [GPS æ“çºµæ†](https://play.google.com/store/apps/details?id=com.theappninjas.gpsjoystick&hl=en_IN)åº”ç”¨ç¨‹åºæ¥æµ‹è¯•è¿™ä¸€ç‚¹ã€‚

## [](#conclusion)ç»“è®º

æˆ‘ä»¬å·²ç»æˆåŠŸåˆ›å»ºäº†ä¸€ä¸ª React æœ¬æœºåº”ç”¨ç¨‹åºï¼Œå®ƒå¯ä»¥è·Ÿè¸ªç”¨æˆ·ä½ç½®å¹¶ç»˜åˆ¶è·¯å¾„ã€‚å®ƒè¿˜å¯ä»¥è®¡ç®—ç”¨æˆ·è¡Œè¿›çš„è·ç¦»ã€‚

æˆ‘å·²ç»è·³è¿‡äº†è¿™ä¸ªåº”ç”¨ç¨‹åºéœ€è¦çš„æ ·å¼å’Œä¸€äº›å…¶ä»–æ ·æ¿ä»£ç ï¼Œä½†ä½ å¯ä»¥åœ¨ github repo [è¿™é‡Œ](https://github.com/vikrantnegi/react-native-location-tracking)æ‰¾åˆ°ã€‚

æˆ‘å¸Œæœ›è¿™èƒ½å¸®åŠ©ä½ ç†è§£è°·æ­Œåœ°å›¾ APIã€‚ä¹Ÿè®¸ä½ å¯ä»¥ä»ä¸­è·å¾—çµæ„Ÿæ¥å»ºé€ ä¸€äº›ä»¤äººæƒŠå¹çš„ä¸œè¥¿ã€‚è¯·éšæ—¶ç•™ä¸‹ä»»ä½•åé¦ˆï¼Œæˆ‘ä¸€ç›´åœ¨å¯»æ‰¾æ›´å¥½çš„è§£å†³æ–¹æ¡ˆï¼

> æœ€åˆå‘è¡¨äº[åª’ä½“](https://medium.com/@vikrantnegi/react-native-location-tracking-14ab2c9e2db8)