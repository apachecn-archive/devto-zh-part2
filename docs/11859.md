# 磁盘空间调试清单

> 原文:[https://dev.to/rrampage/disk-space-debugging-checklist-5ld](https://dev.to/rrampage/disk-space-debugging-checklist-5ld)

很多时候，平稳运行的流程会神秘地停止工作。你打开日志，看看发生了什么，却发现连日志都停止更新了。但是过程本身正在运行。您通过 SSH 连接到服务器并键入 cd TAB。Bash 哭诉“无法创建临时文件”。机器磁盘空间不足...

下面是一个使用标准 Linux 实用程序使磁盘空间调试更容易的清单，这样您就可以开始使用，而不必安装任何额外的东西:

1.  **`df -h`** 命令以可读格式概述了已装载的磁盘数量及其总容量和可用容量。
2.  要了解哪些文件夹/目录占用了最大的空间，可以试试 **`du -ch / | sort -h | tail -n 30`** 。这给了你 30 个最消耗空间的目录。如果您已经知道哪些目录会产生最大的磁盘输出，例如日志和临时文件，那么您可以用您的目录(DIR)替换“/”，并运行命令 **`du -ch DIR | sort -h | tail -n 30`**
3.  现在，我们已经确定了占用空间最大的目录，我们可能需要删除一些文件，让我们的过程重新开始。这里的 **`rm`** 指挥是你的朋友。您可以删除旧日志和临时文件来释放空间。
4.  很多时候，罪魁祸首是一个已经被程序使用的大文件，例如 Apache Tomcat 的`catalina.out`。如果您想在不关闭进程的情况下释放空间，那么 **`truncate`** 命令会帮您解决这个问题。例如: **`truncate -s0 BIG_LOG.log`** 。这将把文件截断为 0 字节，但仍允许另一个进程毫无问题地使用它(标准 Unix 权限适用)
5.  有时，您删除文件，但空间似乎并没有恢复。这可能是因为某个进程仍然持有已删除文件的文件描述符。一旦这些进程停止，空间将被恢复。这里的 **`lsof`** 命令会帮你解决这个问题。它代表*列出打开的文件*。您可以通过以下方式了解哪些进程正在使用已删除的文件:`lsof | grep deleted | grep OLD_FILENAME`。lsof 命令为您提供了进程名和进程 id，因此您可以在进程上运行`kill`。如果您不知道被删除文件的名称，您仍然可以运行`lsof | grep deleted`并查看输出来检查任何熟悉的文件/进程。

最后，请记住，磁盘空间是您应该在服务器上监控的指标之一。这份清单必须在紧急情况下使用。如果您发现自己经常遇到磁盘空间问题，解决方案是设置旧日志文件的定期删除/循环，当磁盘空间达到特定阈值时发出警报，或者如果您的进程需要大量磁盘空间(例如 Kafka、MySQL 和其他数据库),则增加磁盘大小。

让我知道我是否遗漏了一些其他工具，以及您处理磁盘空间问题的经验！