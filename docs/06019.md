# åœ¨ WhatsApp ä¸Šç”¨ Railsã€Twilio å’Œ Spotify å»ºç«‹ä¸€ä¸ªåä½œæ’­æ”¾åˆ—è¡¨

> åŸæ–‡:[https://dev . to/twilio/build-a-collaborative-playlist-over-whatsapp-with-rails-twilio-and-Spotify-1fnn](https://dev.to/twilio/build-a-collaborative-playlist-over-whatsapp-with-rails-twilio-and-spotify-1fnn)

é€šè¿‡æ’­æ”¾åˆ—è¡¨å…±äº«éŸ³ä¹æ˜¯å‘ç°æ–°æ—§éŸ³ä¹çš„å¥½æ–¹æ³•ã€‚Spotify æœ‰åˆä½œæ’­æ”¾åˆ—è¡¨ï¼Œä½†æˆ‘ä¸å–œæ¬¢ä»–ä»¬è®©ä½ çš„æœ‹å‹é‡æ–°æ’åºå’Œä»åˆ—è¡¨ä¸­åˆ é™¤æ­Œæ›²çš„æ–¹å¼ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ„å»ºè‡ªå·±çš„åä½œæ’­æ”¾åˆ—è¡¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¯¥åˆ—è¡¨åªå…è®¸ä½¿ç”¨ [Spotify Web API](https://developer.spotify.com/documentation/web-api/) æ·»åŠ å†…å®¹ã€‚æœ‰äº†ç”¨äº WhatsApp çš„[Twilio API](https://www.twilio.com/whatsapp)ï¼Œæˆ‘ä»¬å¯ä»¥è®©æˆ‘ä»¬çš„æœ‹å‹åœ¨æœ‰çµæ„Ÿæ—¶å‘é€ä¸€é¦–æ­Œæ›²ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Ruby on Rails æ„å»ºä¸€ä¸ª WhatsApp æœºå™¨äººæ¥å®Œæˆä¸Šè¿°æ‰€æœ‰å·¥ä½œã€‚

## [](#getting-started)å…¥é—¨

è¦æ„å»ºè¿™ä¸ªåº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›ä¸œè¥¿:

*   [å®‰è£…äº† Ruby ç‰ˆæœ¬ 2 . 5 . 1](https://www.ruby-lang.org/en/downloads/)
*   è½¨é“å’Œæ†æ‰æœºï¼Œå¯å®‰è£…`gem install rails bundler`
*   Twilio å¸æˆ·([åœ¨æ­¤æ³¨å†Œå…è´¹çš„ Twilio å¸æˆ·](https://www.twilio.com/try-twilio)
*   åœ¨æˆ‘ä»¬çš„ Twilio å¸æˆ·ä¸­è®¾ç½®çš„ WhatsApp æ²™ç›’
*   [ä¸€ä¸ª Spotify å¼€å‘è€…è´¦æˆ·](https://developer.spotify.com/)
*   [ngrok](https://ngrok.com) ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥[é€šè¿‡éš§é“åˆ°è¾¾æˆ‘ä»¬æœ¬åœ°å¼€å‘çš„åº”ç”¨ç¨‹åºæ¥ä½¿ç”¨ webhooks](https://www.twilio.com/blog/2015/09/6-awesome-reasons-to-use-ngrok-when-testing-webhooks.html)

### [](#spotify-api-credentials)Spotify API å‡­è¯

è¦ä½¿ç”¨ Spotify APIï¼Œæˆ‘ä»¬éœ€è¦ç”Ÿæˆä¸€äº› API å‡­è¯ã€‚ä» [Spotify å¼€å‘è€…ä»ªè¡¨ç›˜](https://developer.spotify.com/dashboard/applications)åˆ›å»ºä¸€ä¸ªæ–°åº”ç”¨ç¨‹åºï¼Œå¹¶éµå¾ª 3 æ­¥æµç¨‹ã€‚

1.  é¦–å…ˆï¼Œå¡«å†™ä¸€äº›å…³äºåº”ç”¨ç¨‹åºçš„è¯¦ç»†ä¿¡æ¯ã€‚è¯´å‡ºå®ƒçš„åå­—ï¼Œæˆ‘æŠŠæˆ‘çš„å«åš WhatsPlayingï¼Œæä¾›ä¸€ä¸ªç®€çŸ­çš„æè¿°å¹¶æ£€æŸ¥å®ƒæ˜¯ä»€ä¹ˆç±»å‹çš„åº”ç”¨ç¨‹åºï¼Œæˆ‘é€‰æ‹©äº†â€œç½‘ç«™â€
2.  æ¥ä¸‹æ¥æˆ‘ä»¬è¢«é—®åŠè¿™æ˜¯å¦æ˜¯å•†ä¸šæ•´åˆï¼›é€‰æ‹©â€œå¦â€
3.  æœ€åï¼Œæ£€æŸ¥åè®®

å®Œæˆè¿™äº›æ­¥éª¤åï¼Œæˆ‘ä»¬å°†çœ‹åˆ°åº”ç”¨ç¨‹åºæ§åˆ¶é¢æ¿ã€‚æˆ‘ä»¬éœ€è¦ä»è¿™ä¸ªé¡µé¢çš„å®¢æˆ·ç«¯ ID å’Œå®¢æˆ·ç«¯å¯†ç ã€‚

è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦åšä¸€ä»¶äº‹ã€‚ç‚¹å‡»â€œç¼–è¾‘è®¾ç½®â€ï¼Œè¾“å…¥é‡å®šå‘ç½‘å€`http://localhost:3000/auth/spotify/callback`ï¼Œç‚¹å‡»â€œæ·»åŠ â€ã€‚

æ—¢ç„¶å‡­è¯å·²ç»æ’åºï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹æ„å»ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºäº†ã€‚

## [](#preparing-the-project)å‡†å¤‡é¡¹ç›®

æˆ‘å·²ç»å¼€å§‹äº†è¿™ä¸ªé¡¹ç›®ï¼Œæ‰€ä»¥[ä» GitHub](https://github.com/philnash/whats_playing) å…‹éš†æˆ–ä¸‹è½½å›è´­åè®®ï¼Œå¹¶æ£€æŸ¥`getting-started`åˆ†æ”¯ã€‚

```
git clone -b getting-started https://github.com/philnash/whats_playing.git 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åˆ‡æ¢åˆ°ç›®å½•å¹¶å®‰è£…é¡¹ç›®çš„ä¾èµ–é¡¹ã€‚

```
cd whats_playing
bundle install 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°†`config/env.yml.example`æ–‡ä»¶å¤åˆ¶åˆ°`config/env.yml`(æˆ‘ä»¬ä½¿ç”¨ envyable æ¥[ç®¡ç†åº”ç”¨ç¨‹åº](https://www.twilio.com/blog/2015/02/managing-development-environment-variables-across-multiple-ruby-applications.html)çš„ç¯å¢ƒå˜é‡)ã€‚æ‰“å¼€`config/env.yml`ï¼Œå¡«å†™æˆ‘ä»¬åˆšåˆšç”Ÿæˆçš„ Spotify å®¢æˆ·ç«¯ ID å’Œå®¢æˆ·ç«¯å¯†ç ã€‚æˆ‘ä»¬å¾ˆå¿«ä¼šæŠŠå‰©ä¸‹çš„è¡¥ä¸Šã€‚

æˆ‘ä»¬ç°åœ¨å°†ä¸ºæ‚¨åœ¨ Spotify ä¸Šçš„å¸æˆ·ç”Ÿæˆä¸€ä¸ª Spotify è®¿é—®ä»¤ç‰Œï¼Œä»¥åŠä¸€ä¸ªåä¸ºâ€œWhatsPlayingâ€çš„æ–°æ’­æ”¾åˆ—è¡¨ï¼Œæˆ‘ä»¬å°†æŠŠå®ƒç”¨ä½œæˆ‘ä»¬çš„åä½œæ’­æ”¾åˆ—è¡¨ã€‚ä½¿ç”¨
è¿è¡Œ Rails åº”ç”¨ç¨‹åº

```
bundle exec rails server 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨[æ‰“å¼€ app http://localhost:3000](http://localhost:3000)ã€‚ä¼šæœ‰ä¸€ä¸ªâ€œç™»å½• Spotifyâ€çš„é“¾æ¥ã€‚å•å‡»é“¾æ¥å¹¶éµå¾ª OAuth æµç¨‹ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯ç”± [RSpotify gem](https://github.com/guilhermesad/rspotify) å’Œ [omniauth](https://github.com/omniauth/omniauth) å¤„ç†çš„ï¼Œä½ å¯ä»¥åœ¨`config/initializers/rspotify.rb`ä¸­æŸ¥çœ‹å®Œæˆè¿™äº›å·¥ä½œæ‰€éœ€çš„é…ç½®ã€‚

[![](../Images/931f10c15a285f2edf8f0e2a20a12ec7.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s---ulZ09x4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://s3.amazonaws.com/com.twilio.prod.twilio-docs/images/-cLIvjXZ1zUy1dnYRd6rWFkXIhh0AO33g1YJCEHZAb_Q6x.width-500.png)

ä¸€æ—¦æ‚¨è¢«å¼•å¯¼å›åº”ç”¨ç¨‹åºï¼Œæ‚¨å°†åœ¨æ‚¨é¢å‰çš„é¡µé¢ä¸Šçœ‹åˆ°æ‚¨çš„ Spotify ç”¨æˆ· IDã€è®¿é—®ä»¤ç‰Œã€åˆ·æ–°ä»¤ç‰Œå’Œæ’­æ”¾åˆ—è¡¨ IDã€‚å°†è¿™äº›å¤åˆ¶åˆ°`config/env.yml`ä¸­ï¼Œé‡å¯åº”ç”¨ç¨‹åºï¼Œå†æ¬¡æ‰“å¼€ [http://localhost:3000](http://localhost:3000) ã€‚æ‚¨ä¼šå‘ç°è„šæœ¬åˆšåˆšåˆ›å»ºçš„æ’­æ”¾åˆ—è¡¨æ˜¯ç©ºçš„ï¼Œå¹¶åµŒå…¥åœ¨é¡µé¢ä¸­ã€‚ç°åœ¨æ˜¯æ—¶å€™åœ¨ WhatsAppã€Twilio å’Œ Spotify ä¹‹é—´å»ºç«‹æ•´åˆäº†ã€‚

## [](#getting-to-grip-with-webhooks)ç”¨ç½‘é’©æŠ“ç‰¢

å½“ä½ å‘ä½ ç”¨ Twilio æ§åˆ¶çš„ WhatsApp å·ç å‘é€æ¶ˆæ¯æ—¶ï¼ŒTwilio ä¼šå‘æˆ‘ä»¬æä¾›çš„åº”ç”¨ç¨‹åº URL å‘é€ä¸€ä¸ª HTTP è¯·æ±‚æˆ– webhookã€‚æˆ‘ä»¬å°†ç”¨å®ƒæ¥å›å¤æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œå¹¶å°†æ­Œæ›²æ·»åŠ åˆ°æˆ‘ä»¬çš„æ’­æ”¾åˆ—è¡¨ä¸­ã€‚è®©æˆ‘ä»¬é¦–å…ˆè®¾ç½®æˆ‘ä»¬çš„ webhook ç«¯ç‚¹ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†å®‰è£… [twilio-ruby å®çŸ³](https://github.com/twilio/twilio-ruby/)ã€‚è¿™å°†ä½¿ç¼–å†™ TwiML(Twilio ç†è§£å¹¶æ¥å—å…¶æŒ‡å¯¼çš„ XML)å˜å¾—æ›´åŠ å®¹æ˜“ã€‚æ‰“å¼€`Gemfile`ï¼Œåœ¨åŒ…å« RSpotify çš„è¡Œä¸‹ï¼Œæ·»åŠ  twilio-ruby:

```
gem 'rspotify', '~> 2.1.1'
gem 'twilio-ruby', '~> 5.12.3' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é€šè¿‡å†æ¬¡è¿è¡Œé¡¹ç›®ç›®å½•ä¸­çš„`bundle install`æ¥å®‰è£… gemã€‚

æˆ‘ä»¬ç°åœ¨éœ€è¦ä¸€ä¸ªæ–°çš„æ§åˆ¶å™¨æ¥å¤„ç†ä¼ å…¥çš„ webhooksã€‚ä½¿ç”¨ Rails ç”Ÿæˆå™¨åˆ›å»ºä¸€ä¸ªæ–°çš„:

```
bundle exec rails generate controller twilio/messages 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰“å¼€æ–°ç”Ÿæˆçš„`app/controllers/twilio/messages_controller.rb`ï¼Œå¼€å§‹ç§»é™¤é»˜è®¤çš„[è½¨é“ CSRF ä¿æŠ¤](https://guides.rubyonrails.org/security.html#csrf-countermeasures)ã€‚æ ¹æ®å®šä¹‰ï¼ŒWebhooks æ˜¯ä¸€ä¸ªè·¨ç«™ç‚¹è¯·æ±‚ï¼Œæˆ‘ä»¬åº”è¯¥é€šè¿‡[éªŒè¯è¯·æ±‚æ¥è‡ª Twilio](https://www.twilio.com/docs/usage/security) æ¥ä¿æŠ¤å®ƒä»¬ã€‚æˆ‘ä»¬å¯ä»¥ç¨åä½¿ç”¨ twilio-ruby gem æä¾›çš„ [Twilio è¯·æ±‚éªŒè¯æ¡†æ¶ä¸­é—´ä»¶æ¥å®ç°ã€‚](https://www.twilio.com/blog/2014/09/securing-your-ruby-webhooks-with-rack-middleware.html) 

```
class Twilio::MessagesController < ApplicationController
  skip_before_action :verify_authenticity_token
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåŠ¨ä½œæ¥å¤„ç†ä¼ å…¥çš„ webhook è¯·æ±‚ã€‚åœ¨ Rails çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œæˆ‘è®¤ä¸º webhooks æ˜¯`create`åŠ¨ä½œï¼Œæ‰€ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„`create`æ–¹æ³•ã€‚

```
class Twilio::MessagesController < ApplicationController
  skip_before_action :verify_authenticity_token
  def create
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†ç¡®ä¿æˆ‘ä»¬åœ¨æ­£ç¡®çš„è½¨é“ä¸Šï¼Œè®©æˆ‘ä»¬é¦–å…ˆç”¨ä¸€ä¸ªç®€å•çš„æ¶ˆæ¯è¿›è¡Œå“åº”ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ twilio-ruby gem çš„ TwiML ç”ŸæˆåŠŸèƒ½ï¼Œç”¨ä¹ æƒ¯çš„â€œHello Worldï¼â€æ¥å“åº”ä»»ä½•ä¼ å…¥çš„æ¶ˆæ¯ã€‚

```
class Twilio::MessagesController < ApplicationController
  skip_before_action :verify_authenticity_token
  def create
    response = Twilio::TwiML::MessagingResponse.new
    response.message(body: "Hello World!")
    render xml: response.to_xml
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªåŠ¨ä½œä¹Ÿéœ€è¦ä¸€ä¸ªè·¯çº¿ã€‚æ‰“å¼€`config/routes.rb`å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹:

```
Rails.application.routes.draw do
  namespace :twilio do
    post 'messages', to: 'messages#create'
  end
  # other routes
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦å¾—åˆ°å“åº”çš„å…¨éƒ¨å†…å®¹ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å°† Twilio WhatsApp æ²™ç®±è¿æ¥åˆ°è¿™ä¸ªåº”ç”¨ç¨‹åºã€‚

å¯åŠ¨ä½ çš„åº”ç”¨:

```
bundle exec rails server 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯åŠ¨ ngrok éš§é“ï¼Œä»¥ä¾¿ Twilio webhook å¯ä»¥é€šè¿‡å…¬å…± URL è®¿é—®æ‚¨çš„åº”ç”¨ç¨‹åºã€‚åœ¨æ–°çš„ç»ˆç«¯çª—å£å‘½ä»¤è¡Œä¸Šè¿è¡Œ:

```
ngrok http 3000 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è·å– ngrok ç”Ÿæˆçš„ URLï¼Œæ·»åŠ `/twilio/messages`è·¯å¾„ï¼Œå¹¶å°†å…¶ä½œä¸º [WhatsApp é¢‘é“](https://www.twilio.com/console/sms/whatsapp/sandbox)çš„â€œæœ‰æ¶ˆæ¯è¿›æ¥â€æ—¶çš„ URLã€‚

[![](../Images/8fe23402ae5798cda39728b0873e4265.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--lGhTdgqI--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://s3.amazonaws.com/com.twilio.prod.twilio-docs/images/mOcd_C7CBBLk1HcW4JB11qrpaKD6I0_o2vJlWe4cZDtoYi.width-500.png)

å‘ WhatsApp æ²™ç›’å·ç å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ªå›å¤ï¼Œè¯´â€œä½ å¥½ï¼Œä¸–ç•Œï¼â€ã€‚ç°åœ¨æ˜¯æ—¶å€™è¿æ¥ Spotify API äº†ã€‚

## [](#connecting-with-the-spotify-api)ä¸ Spotify API è¿æ¥

æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªå¯¹è¯ç•Œé¢ï¼Œä¸ Spotify API è¿›è¡Œäº¤äº’ã€‚æˆ‘ä»¬å°†å‡è®¾å½“ç”¨æˆ·å‘é€ä»–ä»¬çš„ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œæ˜¯ä»–ä»¬æƒ³è¦æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨ä¸­çš„æ­Œæ›²æ ‡é¢˜ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ Spotify API æœç´¢è¯¥æ­Œæ›²ï¼Œå¹¶å°†ç¬¬ä¸€ä¸ªç»“æœå‘é€ç»™ç”¨æˆ·ï¼Œçœ‹çœ‹è¿™æ˜¯å¦æ˜¯ä»–ä»¬æƒ³è¦çš„ã€‚å¦‚æœä»–ä»¬ä»¥è‚¯å®šçš„å›åº”ç¡®è®¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼šå°†è¯¥æ›²ç›®æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨ä¸­ã€‚å¦‚æœä»–ä»¬è¯´ä¸ï¼Œæˆ‘ä»¬å°†è¦æ±‚ä»–ä»¬å†æ¬¡æœç´¢ã€‚å¦‚æœä»–ä»¬å‘å›ä»»ä½•ä¸œè¥¿ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºè¿™æ˜¯ä¸€æ¬¡æ–°çš„æœç´¢ã€‚

æˆ‘ä»¬ä¸ºè¿™ä¸ªåº”ç”¨ç¨‹åºä½¿ç”¨äº†ä¼˜ç§€çš„ [RSpotify](https://github.com/guilhermesad/rspotify) åº“ï¼Œä½†æ˜¯è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ›´é€‚åˆæˆ‘ä»¬ä½¿ç”¨çš„ç±»ã€‚åœ¨`app`ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`services`çš„æ–°ç›®å½•ï¼Œå¹¶åœ¨å…¶ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`spotify.rb`çš„æ–‡ä»¶ã€‚æ‰“å¼€`spotify.rb`å¹¶åˆ›å»ºä¸€ä¸ªæ–°ç±»:

```
class Spotify
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨åˆå§‹åŒ–å™¨ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¹‹å‰åˆ›å»ºçš„å‡­è¯æ¥åˆ›å»ºä¸€ä¸ªç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ã€‚

```
class Spotify
  def initialize(user_id, user_token, user_refresh_token)
    @user = RSpotify::User.new({
      'id' => user_id,
      'credentials' => {
        'token' => user_token,
        'refresh_token' => user_refresh_token
      }
    })
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é€šè¿‡å‘`RSpotify::Track.search`æ–¹æ³•ä¼ é€’ä¸€ä¸ªæŸ¥è¯¢æ¥æœç´¢éŸ³è½¨ï¼Œæˆ‘ä»¬åªæƒ³è¿”å›ç¬¬ä¸€ä¸ªç»“æœã€‚

```
class Spotify
  def initialize(user_id, user_token, user_refresh_token)
  end

  def track_search(query)
    RSpotify::Track.search(query).first
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»`track_search`çš„ç»“æœä¸­è·å–æ›²ç›® IDï¼Œé€šè¿‡ ID æœç´¢æ’­æ”¾åˆ—è¡¨ï¼Œç„¶åå°†æ›²ç›®æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨ä¸­ï¼Œä»è€Œå°†æ›²ç›®æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨ä¸­ã€‚

```
class Spotify
  def initialize(user_id, user_token, user_refresh_token)
  end

  def track_search(query)
  end

  def add_to_playlist(playlist_id, track_id)
    playlist = RSpotify::Playlist.find(@user.id, playlist_id)
    playlist.add_tracks!([track_id])
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨è®©æˆ‘ä»¬åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨è¿™ä¸ªç±»ï¼Œå†æ¬¡æ‰“å¼€`app/controllers/twilio/messages_controller.rb`ã€‚åœ¨`create`æ–¹æ³•çš„å¼€å§‹ï¼Œè·å–æ¶ˆæ¯çš„æ­£æ–‡ï¼Œæˆ‘ä»¬å°†æŠŠå®ƒç”¨ä½œæœç´¢è¯ï¼Œå¹¶ä½¿ç”¨ç¯å¢ƒä¸­çš„å‡­è¯å®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„ Spotify å¯¹è±¡ã€‚

### [](#searching-for-songs)æœç´¢æ­Œæ›²

æˆ‘ä»¬å°†é¦–å…ˆæµ‹è¯•æœç´¢åŠŸèƒ½ï¼Œå¹¶è¿”å›æˆ‘ä»¬æ‰¾åˆ°çš„ç¬¬ä¸€é¦–æ›²ç›®çš„åç§°å’Œè‰ºæœ¯å®¶ã€‚Spotify ä»¥åˆ—è¡¨å½¢å¼è¿”å›è‰ºæœ¯å®¶ï¼Œå› ä¸ºå¯èƒ½æœ‰å¤šä¸ªè‰ºæœ¯å®¶è´Ÿè´£ä¸€é¦–æ›²ç›®ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ç‚¹ç§¯ææ”¯æŒçš„æŠ€å·§æŠŠå®ƒå˜æˆä¸€ä¸ªå¥å­ã€‚ [WhatsApp è¿˜æ”¯æŒä¸€äº›åŸºæœ¬çš„æ¶ˆæ¯æ ¼å¼åŒ–](https://faq.whatsapp.com/en/android/26000002/)ï¼›å¦‚æœæˆ‘ä»¬ç”¨ä¸‹åˆ’çº¿å°†æ›²ç›®å’Œè‰ºæœ¯å®¶çš„åå­—æ‹¬èµ·æ¥ï¼Œå®ƒä»¬å°†ä»¥æ–œä½“æ˜¾ç¤ºã€‚

```
class Twilio::MessagesController < ApplicationController
  skip_before_action :verify_authenticity_token
  def create
    body = params['Body']
    spotify = Spotify.new(ENV['SPOTIFY_USER_ID'], ENV['SPOTIFY_TOKEN'], ENV['SPOTIFY_REFRESH_TOKEN'])

    track = spotify.track_search(body)
    message = "Did you want to add _#{track.name}_ by _#{track.artists.map(&:name).to_sentence}_?"

    response = Twilio::TwiML::MessagingResponse.new
    response.message(body: message)
    render xml: response.to_xml
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºå¹¶å‘é€ä¿¡æ¯ï¼Œæœç´¢æ‚¨æƒ³å¬çš„æ›²ç›®ã€‚æ‚¨åº”è¯¥ä¼šæ”¶åˆ°ä¸€æ¡åˆ—å‡ºæ‚¨æƒ³è¦çš„æ›²ç›®çš„æ¶ˆæ¯ã€‚å¦‚æœæ‚¨è·å¾—ä¸åŒçš„æ­Œæ›²ï¼Œè¯·å°è¯•æ·»åŠ è‰ºæœ¯å®¶æˆ–ä¸“è¾‘ä»¥ç¼©å°æœç´¢èŒƒå›´ã€‚

[![](../Images/41514bd0be989a856affab9ce481cbbb.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--ycyWCE3_--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://s3.amazonaws.com/com.twilio.prod.twilio-docs/images/bA3Sdd8dpQp03o8M8PfVIFv5Hm-L19JSBaeuItZpblztY0.width-500.png)

å¦‚æœæˆ‘ä»¬æ‰¾ä¸åˆ°ä»»ä½•æ­Œæ›²ï¼Œæˆ‘ä»¬ç¡®å®éœ€è¦å¤„ç†è¿™ä¸ªæ¡ˆä¾‹ã€‚

```
 def create
    body = params['Body']
    spotify = Spotify.new(ENV['SPOTIFY_USER_ID'], ENV['SPOTIFY_TOKEN'], ENV['SPOTIFY_REFRESH_TOKEN'])

    track = spotify.track_search(query)
    if track
      message = "Did you want to add _#{track.name}_ by _#{track.artists.map(&:name).to_sentence}_?"
    else
      message = "I couldn't find any songs by searching for '#{body}'. Try something else."
    end

    response = Twilio::TwiML::MessagingResponse.new
    response.message(body: message)
    render xml: response.to_xml
  end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#adding-to-the-playlist)æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨

æˆ‘ä»¬å¯ä»¥å¤„ç†æœç´¢è¯·æ±‚ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿæ·»åŠ è½¨é“ï¼Œå¦‚æœç”¨æˆ·çš„å›ç­”æ˜¯è‚¯å®šçš„ã€‚

åƒ Twilio ä¸Šçš„ SMS å¯¹è¯ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¼šè¯æ¥ä¿ç•™æ¶ˆæ¯ä¹‹é—´çš„æ•°æ®ã€‚å¯¹äºæ­¤åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¼šè¯ä¸­å­˜å‚¨æ›²ç›® URIï¼Œä»¥ä¾¿ Spotify è¯†åˆ«å®ƒã€‚ç„¶åï¼Œå¦‚æœæˆ‘ä»¬åœ¨ä¼šè¯ä¸­æœ‰ä¸€ä¸ªè·Ÿè¸ªï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å“åº”ä¸­å¯»æ‰¾â€œæ˜¯â€ã€‚å¦‚æœæˆ‘ä»¬å¾—åˆ°â€œæ˜¯â€ï¼Œæˆ‘ä»¬å°†æ›²ç›®æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨å¹¶æ¸…é™¤ä¼šè¯ã€‚

```
 def create
    body = params['Body']
    spotify = Spotify.new(ENV['SPOTIFY_USER_ID'], ENV['SPOTIFY_TOKEN'], ENV['SPOTIFY_REFRESH_TOKEN'])

    if session[:track]
      answer = body.split(' ').first.downcase.strip
      if ['yes', 'yeah', 'yep', 'yup', 'ğŸ‘'].include? answer
        message = "OK, adding that track now."
        spotify.add_to_playlist(ENV['SPOTIFY_PLAYLIST_ID'], session[:track])
        session[:track] = nil
      end
    end

    if !message
      track = spotify.track_search(body)
      if track
        session[:track] = track.uri
        message = "Did you want to add _#{track.name}_ by _#{track.artists.map(&:name).to_sentence}_?"
      else
        message = "I couldn't find any songs by searching for '#{body}'. Try something else."
      end
    end
    response = Twilio::TwiML::MessagingResponse.new
    response.message(body: message)
    render xml: response.to_xml
  end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘æ·»åŠ äº†ä¸€äº›å…¶ä»–è¯´â€œæ˜¯â€çš„é€‰é¡¹ï¼ŒåŒ…æ‹¬ç«–èµ·å¤§æ‹‡æŒ‡çš„è¡¨æƒ…ç¬¦å·ğŸ‘ã€‚[è°ä¸çˆ±è¡¨æƒ…ç¬¦å·ï¼Ÿ](https://www.twilio.com/blog/2018/08/emoji-translations-twilio-api-whatsapp-node-js.html)

ä½ å¯ä»¥é€šè¿‡åº”ç”¨ç¨‹åºæµ‹è¯•è¿™æ¡è·¯å¾„ï¼Œæ–¹æ³•æ˜¯å‘ WhatsApp å·ç å‘é€ä¸€é¦–æ­Œæ›²ï¼Œç„¶åç”¨â€œæ˜¯â€è¿›è¡Œè·Ÿè¿›ã€‚ç„¶åæ£€æŸ¥æ­Œæ›²æ˜¯å¦å‡ºç°åœ¨æ’­æ”¾åˆ—è¡¨ä¸­ã€‚

### [](#other-responses)å…¶ä»–å“åº”

ä¸ºäº†å®Œæˆæˆ‘ä»¬çš„ Spotify WhatsApp æœºå™¨äººï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†å…¶ä»–æ½œåœ¨çš„å›åº”ã€‚å¦‚æœç”¨æˆ·å‘å›å¦å®šçš„å›ç­”ï¼Œé‚£ä¹ˆæˆ‘ä»¬æƒ³é—®ä»–ä»¬æƒ³æ·»åŠ ä»€ä¹ˆæ ·çš„æ›²ç›®ã€‚ä»»ä½•å…¶ä»–ååº”ï¼Œæˆ‘ä»¬ä¼šå‡è®¾è¿™æ˜¯ä¸€ä¸ªæ–°çš„æœç´¢ã€‚

```
 def create
    body = params['Body']
    spotify = Spotify.new(ENV['SPOTIFY_USER_ID'], ENV['SPOTIFY_TOKEN'], ENV['SPOTIFY_REFRESH_TOKEN'])

    if session[:track]
      answer = body.split(' ').first.downcase.strip
      if ['yes', 'yeah', 'yep', 'yup', 'ğŸ‘'].include? answer
        message = "OK, adding that track now."
        spotify.add_to_playlist(ENV['SPOTIFY_PLAYLIST_ID'], session[:track])
        session[:track] = nil
      elsif ['no', 'nah', 'nope', 'ğŸ‘'].include? answer
        session[:track] = nil
        message = "What do you want to add?"
      end
    end

    if !message
      track = spotify.track_search(body)
      if track
        session[:track] = track.uri
        message = "Did you want to add _#{track.name}_ by _#{track.artists.map(&:name).to_sentence}_?"
      else
        message = "I couldn't find any songs by searching for '#{body}'. Try something else."
      end
    end
    response = Twilio::TwiML::MessagingResponse.new
    response.message(body: message)
    render xml: response.to_xml
  end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å†æ¬¡é‡å¯åº”ç”¨ç¨‹åºï¼Œå¼€å§‹æœç´¢å¹¶ç¡®è®¤æˆ–æ‹’ç»æ›²ç›®ã€‚ä½ å¯ä»¥çœ‹åˆ°ä½ æ·»åŠ çš„æ­Œæ›²å‡ºç°åœ¨ä½ çš„æ’­æ”¾åˆ—è¡¨ä¸­ï¼Œä¹Ÿå¯ä»¥åœ¨ä½ çš„åº”ç”¨ä¸»é¡µä¸Šçš„åµŒå…¥å¼æ’­æ”¾åˆ—è¡¨ä¸­çœ‹åˆ°ã€‚

## [](#a-bot-and-a-brand-new-playlist)ä¸€ä¸ªæœºå™¨äººå’Œä¸€ä¸ªå…¨æ–°çš„æ’­æ”¾åˆ—è¡¨

é€šè¿‡ Spotify API å’Œ WhatsApp çš„ Twilio APIï¼Œæˆ‘ä»¬åˆšåˆšå»ºç«‹äº†ä¸€ä¸ªåä½œæ’­æ”¾åˆ—è¡¨ã€‚ç°åœ¨äº¤äº’éå¸¸ç®€å•ï¼Œä½†ä½ å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šå¢åŠ å¯¹æ­Œæ›²çš„æŠ•ç¥¨ï¼Œå°†å®ƒä»¬åœ¨æ’­æ”¾åˆ—è¡¨ä¸­ä¸Šç§»ï¼Œæˆ–è€…æ›´å¥½åœ°ä¸æ›´å¤šæœ‹å‹åˆ†äº«æ’­æ”¾åˆ—è¡¨ã€‚

å¦‚æœä½ æƒ³çœ‹åˆ°è¿™ä¸ªåº”ç”¨ç¨‹åºçš„æ‰€æœ‰ä»£ç ï¼Œè¯·æŸ¥çœ‹ GitHub ä¸Šçš„ repoã€‚

æˆ‘æƒ³çœ‹çœ‹ä½ ä¼šåœ¨æ’­æ”¾åˆ—è¡¨ä¸­æ·»åŠ ä»€ä¹ˆä¼šå¾ˆæœ‰è¶£ï¼Œæ‰€ä»¥æˆ‘éƒ¨ç½²äº†è¿™ä¸ªåº”ç”¨ç¨‹åºçš„æˆ‘çš„ç‰ˆæœ¬ã€‚ä½ å¯ä»¥é€šè¿‡å‘è¿™ä¸ª Twilio WhatsApp å·ç +14155238886 å‘é€æ¶ˆæ¯â€œ **join beaver-wrasse** â€æ¥è¿æ¥åˆ°æˆ‘çš„ WhatsApp æ²™ç›’ï¼Œä»è€Œå‘å®ƒæ·»åŠ æ­Œæ›²ã€‚é‚£å°±å¼€å§‹ç»™æˆ‘å‘ä½ æœ€å–œæ¬¢çš„æ­Œå§ï¼ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹[åœ¨çº¿æ’­æ”¾åˆ—è¡¨](https://twilio-whatsapp-spotify.herokuapp.com/)ï¼

ä½ æœ‰ä»€ä¹ˆå¯ä»¥ç”¨ WhatsApp å’Œ Twilio æ„å»ºåä½œåº”ç”¨çš„æƒ³æ³•å—ï¼Ÿè¯·åœ¨è¯„è®ºä¸­ã€[åœ¨æ¨ç‰¹ä¸Š](https://twitter.com/philnash)æˆ–é€šè¿‡ç”µå­é‚®ä»¶åœ¨ philnash@twilio.com[å‘Šè¯‰æˆ‘ã€‚](mailto:philnash@twilio.com)