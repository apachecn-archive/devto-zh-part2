# ç”¨ Dartã€Aqueduct å’Œ PostgreSQL æ„å»º RESTful Web APIs ç¬¬ 4 éƒ¨åˆ†:æµ‹è¯•

> åŸæ–‡:[https://dev . to/graphic beacon/building-restful-we B- API-with-dart-aqueduct-and-PostgreSQL part-4-testing-3974](https://dev.to/graphicbeacon/building-restful-web-apis-with-dart-aqueduct-and-postgresqlpart-4-testing-3974)

[![Featured image for Building RESTful Web APIs with Dart, Aqueduct, and PostgreSQL](../Images/cbdf930372b6e08ad5ad2b8c1296074d.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--PZk7TA-r--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/dv19znif0x9wpvdcdt13.jpg)

* * *

***è¯·æ³¨æ„:ä» Dart 2 å¼€å§‹ï¼Œå¯¼æ°´ç®¡çš„ API å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯¼è‡´äº†é‡å¤§å˜åŒ–ã€‚æœ¬æ–‡åŸºäº Dart v1 çš„ Aqueduct 2.5.0ã€‚**T3ã€‘*

***æˆ‘å·²ç»æ›´æ–°äº†è¿™ä¸ªä½œä¸ºæ–°çš„è§†é¢‘ç³»åˆ—:ã€http://bit.ly/aqueduct-tutorialã€‘***

* * *

åœ¨ç¬¬ 3 éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°† API ä¸ PostgreSQL æ•°æ®åº“é›†æˆï¼Œåˆ©ç”¨ Aqueduct çš„ ORM ä½œä¸ºç®¡ç†æ•°æ®äº‹åŠ¡çš„æ‰‹æ®µã€‚äº†è§£äº†æ‰˜ç®¡å¯¹è±¡å’Œæ‰˜ç®¡ä¸Šä¸‹æ–‡ä¹‹åï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œå®ƒæä¾›äº†æ•°æ®æŒä¹…æ€§ï¼Œè€Œä¸éœ€è¦ç¼–å†™å¤æ‚çš„ SQL æŸ¥è¯¢ã€‚

æœ¬æ–‡æ˜¯ç³»åˆ—æ–‡ç« çš„ä¸€éƒ¨åˆ†ï¼Œæ¶µç›–ä»¥ä¸‹ä¸»é¢˜:

*   [ç¬¬ 1 éƒ¨åˆ†:è®¾ç½®å¹¶è¿è¡Œç¤ºä¾‹](https://dev.to/graphicbeacon/building-restful-web-apis-with-dart-aqueduct-and-postgresql-55k)
*   [ç¬¬ 2 éƒ¨åˆ†:ç”¨ CRUD æ“ä½œå®ç°è·¯ç”±](https://dev.to/graphicbeacon/building-restful-web-apis-with-dart-aqueduct-and-postgresqlpart-2-routing-53ip)
*   [ç¬¬ 3 éƒ¨åˆ†:å°† Web APIs è¿æ¥åˆ° PostgreSQL æ•°æ®åº“](https://dev.to/graphicbeacon/building-restful-web-apis-with-dart-aqueduct-and-postgresqlpart-3-postgres-9c7)
*   ç¬¬å››éƒ¨åˆ†:å†™ä½œæµ‹è¯•
*   [***å¥–åŠ±å†…å®¹*** DB è¿ç§»å’Œæ¨¡å‹å…³ç³»](https://dev.to/graphicbeacon/building-restful-web-apis-with-dart-aqueduct-and-postgresqlbonus-content-551g)ğŸ˜„

åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†ç¼–å†™æµ‹è¯•ï¼ŒåŒæ—¶é‡æ„æˆ‘ä»¬çš„é€»è¾‘ä»¥é€‚åº”è¿™äº›æµ‹è¯•ã€‚æˆ‘ä»¬å°†ä½¿ç”¨å»ºç«‹åœ¨ Dart å›¢é˜Ÿ[æµ‹è¯•](https://pub.dartlang.org/packages/test)åŒ…ä¹‹ä¸Šçš„ Aqueduct å†…ç½®æµ‹è¯•åº“ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨è‡ªå·±è®¾ç½®äº†ã€‚

* * *

## [](#the-test-harness)æµ‹è¯•çº¿æŸ

ä½¿ç”¨ç¬¬ 1 éƒ¨åˆ†ä¸­çš„æ­å»ºå·¥å…·åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºäº†ä¸€ä¸ª`test/`æ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶ç»“æ„å¦‚ä¸‹:

```
test/
|--harness
   |--app.dart
   example_test.dart 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æµ‹è¯•å·¥å…·`harness/app.dart`è´Ÿè´£å¯åŠ¨å’Œåœæ­¢æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚å½“æˆ‘ä»¬åœ¨`test/example_test.dart` :
ä¸­æŸ¥çœ‹è¿™ä¸ªç‰‡æ®µæ—¶ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†è¿™ä¸€ç‚¹

```
TestApplication app = new TestApplication();

// Runs before all tests
setUpAll(() async {
  await app.start();
});

// Runs after all tests
tearDownAll(() async {
  await app.stop();
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åº”ç”¨ç¨‹åºåœ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•ä¹‹å‰å¯åŠ¨ï¼Œä¹‹åç«‹å³åœæ­¢ã€‚æˆ‘ä»¬çš„æµ‹è¯•å·¥å…·å¤åˆ¶äº†`bin/main.dart`,ä½†æœ‰ä»¥ä¸‹ä¾‹å¤–:

1.  æŒ‡å®šäº†ä¸€ä¸ªç«¯å£`0`,è¿™æ ·æˆ‘ä»¬çš„æµ‹è¯•å¯ä»¥åœ¨ä»»ä½•å¯ç”¨çš„ç«¯å£ä¸Šè¿è¡Œ
2.  ç»™å‡ºäº†ä¸€ä¸ªå•ç‹¬çš„é…ç½®æ–‡ä»¶(config.src.yaml ),å…¶ä¸­åŒ…å«ç‰¹å®šäºæµ‹è¯•çš„æ•°æ®
3.  å½“è°ƒç”¨`application.start`æ—¶,`runOnMainIsolate`é€‰é¡¹è¢«è®¾ç½®ä¸º trueï¼Œåœ¨ä¸»çº¿ç¨‹ä¸Šè¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•ã€‚è¿™å°†ç¦ç”¨å¤šçº¿ç¨‹ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥è®¿é—®åº”ç”¨ç¨‹åºçš„çŠ¶æ€å’ŒæœåŠ¡æ¥æ‰§è¡Œæˆ‘ä»¬çš„æ–­è¨€ã€‚
4.  ä¸€ä¸ª`TestClient`è¢«å®ä¾‹åŒ–ä»¥æä¾›ä¸€ä¸ª HTTP å®¢æˆ·ç«¯æ¥æ‰§è¡Œå¯¹æˆ‘ä»¬çš„ API çš„è¯·æ±‚ã€‚ä½¿ç”¨å®ƒå°†ä¸ºæˆ‘ä»¬çš„æ–­è¨€æä¾›æµ‹è¯•å“åº”ã€‚
5.  æä¾›äº†ä¸€ç§åœæ­¢åº”ç”¨ç¨‹åºçš„æ–¹æ³•ï¼Œä»¥ä¾¿åœ¨æ‰€æœ‰æµ‹è¯•è¿è¡Œåè°ƒç”¨

ä¸ºäº†è¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•ï¼Œè®©æˆ‘ä»¬åœ¨ç¬¬ 3 éƒ¨åˆ†ä¸­é‡æ„æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆï¼Œä»æˆ‘ä»¬çš„æ•°æ®åº“é…ç½®å¼€å§‹ã€‚è¿™æ˜¯ä¸ºäº†æ”¯æŒæµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒçš„çµæ´»æ€§ã€‚

## [](#1-configure-the-database)1ã€‚é…ç½®æ•°æ®åº“

å†æ¬¡æŸ¥çœ‹`lib/fave_reads_sink.dart`ä¸­çš„`FaveReadsSink`ï¼Œç›¸åŒçš„ Postgres ç»†èŠ‚å°†è¢«ç”¨äºæˆ‘ä»¬çš„æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒ(*å“å‘€ï¼*)

é€šè¿‡åˆ†ç¦»æµ‹è¯•å’Œç”Ÿäº§ä¿¡æ¯ï¼Œé…ç½®æ–‡ä»¶çš„ä½¿ç”¨æœ‰åŠ©äºç¼“è§£è¿™ä¸€é—®é¢˜ã€‚åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†åœ¨æ ¹çº§åˆ«ä½¿ç”¨`config.src.yaml`å’Œ`config.yaml`æ–‡ä»¶ã€‚

è®©æˆ‘ä»¬é¦–å…ˆç”¨æˆ‘ä»¬çš„æ•°æ®åº“è¿æ¥ä¿¡æ¯æ¥ä¿®æ”¹è¿™äº›æ–‡ä»¶:

```
# config.src.yaml - for test environment
database:
  username: dartuser
  password: dbpass123
  host: localhost
  port: 5432
  databaseName: fave_reads_test
  isTemporary: true 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨æˆ‘ä»¬çš„ config.yaml æ–‡ä»¶ä¸­:

```
# for production environment
database:
  username: dartuser
  password: dbpass123
  host: localhost
  port: 5432
  databaseName: fave_reads
  isTemporary: false 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å…è®¸æˆ‘ä»¬å¯¹`FaveReadsSink` :
è¿›è¡Œä»¥ä¸‹ä¿®æ”¹

```
// fave_reads_sink.dart
// ...
// ...
class FaveReadsSink extends RequestSink {
  FaveReadsConfiguration config;

  FaveReadsSink(ApplicationConfiguration appConfig) : super(appConfig) {
    logger.onRecord.listen(
        (rec) => print("$rec  ${rec.error ?? ""}  ${rec.stackTrace ?? ""}"));

    var configFilePath = appConfig.configurationFilePath;
    config = new FaveReadsConfiguration(configFilePath);

    var managedDataModel = new ManagedDataModel.fromCurrentMirrorSystem();
    var persistentStore = new PostgreSQLPersistentStore.fromConnectionInfo(
        config.database.username,
        config.database.password,
        config.database.host,
        config.database.port,
        config.database.databaseName);

    ManagedContext.defaultContext =
        new ManagedContext(managedDataModel, persistentStore);
  }
  // ...
  // ...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶è·¯å¾„ç”±`bin/main.dart`å’Œ`test/harness/app.dart`ä¸­çš„`Application`æ„é€ å‡½æ•°çš„`configurationFilePath`å±æ€§æŒ‡å®šã€‚æˆ‘ä»¬çš„`FaveReadsSink`ç±»åœ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºå¯¹è±¡ä¸­è¢«å®ä¾‹åŒ–ï¼Œé€šè¿‡å®ƒæ¥æ”¶è¯·æ±‚æ¥æ”¶å™¨æ„é€ å‡½æ•°çš„`appConfig`å‚æ•°ä¸­çš„é…ç½®è·¯å¾„ã€‚

ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡å®ä¾‹åŒ–`ConfigurationItem`åŠ©æ‰‹ç±»çš„å­ç±»`FaveReadsConfiguration`æ¥æå–é…ç½®ä¿¡æ¯ã€‚è¿™ä¼šå°†é…ç½®æ–‡ä»¶è§£æä¸ºä¸€ä¸ªæ˜ å°„ã€‚

åœ¨è¯·æ±‚æ¥æ”¶å™¨ä¹‹åï¼Œè®©æˆ‘ä»¬å®šä¹‰æˆ‘ä»¬çš„é…ç½®é¡¹:

```
class FaveReadsConfiguration extends ConfigurationItem {
  FaveReadsConfiguration(String fileName) : super.fromFile(fileName);

  DatabaseConnectionConfiguration database;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å±æ€§æ˜ å°„åˆ°æˆ‘ä»¬é…ç½®æ–‡ä»¶ä¸­çš„åŒä¸€ä¸ªé”®ã€‚è¿™å°±æ˜¯æš´éœ²æˆ‘ä»¬çš„æ•°æ®åº“ä¿¡æ¯è¢«è¿™æ ·è®¿é—®çš„åŸå› :`config.database.username`

## [](#2-extract-schemabuilder-into-utility-file)2ã€‚å°† SchemaBuilder æå–åˆ°å®ç”¨ç¨‹åºæ–‡ä»¶ä¸­

è®©æˆ‘ä»¬å°†`createDatabaseSchema`æ–¹æ³•ç§»åˆ°ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œè¿™ä¸ªæ–‡ä»¶ä¹Ÿå°†è¢«æˆ‘ä»¬çš„æµ‹è¯•å·¥å…·ä½¿ç”¨:

```
// This goes in lib/utils/utils.dart
import 'dart:async';
import 'package:aqueduct/aqueduct.dart';

Future createDatabaseSchema(ManagedContext context, bool isTemporary) async {
  try {
    var builder = new SchemaBuilder.toSchema(
        context.persistentStore,
        new Schema.fromDataModel(context.dataModel),
        isTemporary: isTemporary);

    for (var cmd in builder.commands) {
      await context.persistentStore.execute(cmd);
    }
  } catch (e) {
    // Database may already exist
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ç°åœ¨æœ‰ç¬¬äºŒä¸ªå‚æ•°`isTemporary`è¦ç”±æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶æ¥è®¾ç½®ã€‚è¿™ä¸ªé€‰é¡¹å†³å®šäº†æˆ‘ä»¬çš„æ•°æ®æ˜¯å¦è¢«æŒä¹…åŒ–ã€‚å¯¹äºæˆ‘ä»¬çš„æµ‹è¯•ï¼Œæˆ‘ä»¬å°†å…¶è®¾ç½®ä¸º`true`ã€‚

ç°åœ¨è®©æˆ‘ä»¬å°†è¿™ä¸ªå®ç”¨ç¨‹åºé‡æ–°å¯¼å…¥åˆ°`lib/fave_reads_sink.dart` :

```
import 'fave_reads.dart';
import './controller/books_controller.dart';
import './utils/utils.dart'; // ğŸ‘ˆğŸ‘ˆğŸ‘ˆ

class FaveReadsSink extends RequestSink {
  //...
  //...
  @override
  Future willOpen() async {
    await createDatabaseSchema(
        ManagedContext.defaultContext, config.database.isTemporary);
  }
  //...
}
//... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#3-set-up-the-testing-database)3ã€‚å»ºç«‹æµ‹è¯•æ•°æ®åº“

æ‰“å¼€`psql`å·¥å…·å¹¶è¿è¡Œä¸‹é¢çš„æŸ¥è¯¢:

```
CREATE DATABASE fave_reads_test;
CREATE USER dartuser;
ALTER USER dartuser WITH password 'dbpass123';
GRANT ALL ON database fave_reads_test TO dartuser; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœæ‚¨å·²ç»åœ¨ç¬¬ 3 éƒ¨åˆ†ä¸­è¿™æ ·åšäº†ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥è·³è¿‡ç¬¬ 2 è¡Œå’Œç¬¬ 3 è¡Œã€‚

## [](#4-write-your-tests)4ã€‚ç¼–å†™æ‚¨çš„æµ‹è¯•

å°†`example_test.dart`é‡å‘½åä¸º`books_controller_test.dart`,å¹¶ç”¨ä»¥ä¸‹å†…å®¹æ›¿æ¢å…¶å†…å®¹: