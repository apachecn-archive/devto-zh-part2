# Go ä¸­çš„æµ‹è¯•:æµ‹è¯•æµ®ç‚¹æ•°

> åŸæ–‡ï¼š<https://dev.to/juliaferraioli/testing-in-go-testing-floating-point-numbers-4i0a>

*è¿™æ˜¯ä»[æˆ‘çš„åšå®¢](https://juliaferraioli.com/blog/2018/06/golang-testing-floats/)äº¤å‰å‘å¸ƒçš„ã€‚*

æˆ‘ä¸€ç›´åœ¨å¼€å‘ä¸€ä¸ªåŒ…å« Go ä¸­ä¸€äº›å‘é‡æ“ä½œçš„åº“ï¼Œè¯•å›¾éµå¾ªè‰¯å¥½çš„å¼€å‘å®è·µï¼Œå¹¶é¦–å…ˆä»ç¼–å†™æµ‹è¯•å¼€å§‹ã€‚ä½†æ˜¯åœ¨æ—©æœŸï¼Œæˆ‘é‡åˆ°äº†ä¸€ä¸ªå°é—®é¢˜:æµ®ç‚¹ã€‚

# é—®é¢˜

ç°åœ¨ï¼Œæˆ‘ä»¬çŸ¥é“æµ®ç‚¹æ˜¯ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªé—®é¢˜ï¼Œè¿™æ˜¯ç”±å®ƒä»¬åœ¨å†…å­˜ä¸­çš„è¡¨ç°æ–¹å¼å†³å®šçš„ã€‚æˆ‘å–œæ¬¢ Julia Evans åœ¨å¥¹çš„ [Linux æ¼«ç”»æ‚å¿—](https://jvns.ca/linux-comics-zine.pdf)ä¸­å¯¹æµ®åŠ¨å¦‚ä½•å·¥ä½œçš„ç®€è¦è§£é‡Š(å‘ä¸‹æ»šåŠ¨åˆ°ç¬¬å…­ä¸ªé¢æ¿)ï¼Œè¦è·å¾—æ›´æ·±å…¥çš„è§£é‡Šï¼Œè¯·å‚è§ Carl Burch çš„[è¿™ç¯‡æ–‡ç« ](http://www.toves.org/books/float/#s2.1)ã€‚

æˆ‘çš„é—®é¢˜:åœ¨ç¼–å†™äº†å‘é‡åŠ æ³•å‡½æ•°çš„å®ç°ä¹‹åï¼Œæˆ‘æ— æ³•é€šè¿‡æµ‹è¯•ï¼Œå› ä¸ºæ¯”è¾ƒæµ®ç‚¹æ•°çš„ç›¸ç­‰æ€§æ˜¯...å¾ˆéš¾ã€‚æˆ‘å°†æ¯”è¾ƒé¢„æœŸç»“æœ`{2,3}`å’Œå®é™…ç»“æœ`{1.99999999, 3.00000000002}`ã€‚è¿™äº›ä»·å€¼è§‚ä¸ç¬¦åˆä¼ ç»Ÿçš„å¹³ç­‰ã€‚

æˆ‘æŸ¥é˜…äº†å¦‚ä½•å¯¹è¿”å›æµ®ç‚¹æ•°çš„å‡½æ•°è¿›è¡Œå•å…ƒæµ‹è¯•çš„æœ€ä½³å®è·µï¼Œç»å¤§å¤šæ•°äººéƒ½å»ºè®®â€œä¸è¦â€ã€‚(æ²¡ä»€ä¹ˆå¸®åŠ©ï¼Œå„ä½ã€‚)æœ‰äººå»ºè®®ä½¿ç”¨ä¸€ä¸ªå®¹å·®â€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœé¢„æœŸæ•°å­—å’Œå®é™…æ•°å­—ä¹‹é—´çš„ç»å¯¹å·®å€¼åœ¨è§„å®šçš„å®¹å·®ä¹‹å†…ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºå®ƒä»¬ç›¸ç­‰ã€‚

è¿™å¾ˆå®¹æ˜“å®ç°ï¼Œçœ‹èµ·æ¥åƒè¿™æ ·:

```
got  :=  Add(tt.vectors)  if  math.Abs(got-tt.want)  >  tolerance  {  t.Fail("Got %v, expected %v",  got,  tt.want)  } 
```

# å®šä¹‰æ¯”è¾ƒå™¨

ç„¶è€Œï¼Œæˆ‘æœ€è¿‘å¼€å§‹é‡æ–°å®ç°æˆ‘çš„åº“ï¼Œå¹¶åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­åˆ‡æ¢åˆ°ä½¿ç”¨ cmp åŒ…è¿›è¡Œæµ‹è¯•ã€‚cmp åŒ…æ˜¯ä¸€ç§æ›´åŠ å¥å£®çš„æµ‹è¯•ç›¸ç­‰æ€§çš„æ–¹æ³•ï¼Œåœ¨æ¢ç´¢å®ƒçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°å¯ä»¥å®šä¹‰ä¸€ä¸ªæ¯”è¾ƒå™¨å‡½æ•°æ¥ä½¿å®ƒæ›´åŠ ç®€æ´ã€‚è¿™æ˜¯æ–‡æ¡£ä¸­çš„æ¯”è¾ƒå™¨å‡½æ•°ï¼Œå®ƒä½¿ç”¨äº†æ¯”æˆ‘ä¸Šé¢çš„åˆå§‹å‡½æ•°æ›´ç²¾ç¡®çš„é€»è¾‘:

```
const  tolerance  =  .00001  opt  :=  cmp.Comparer(func(x,  y  float64)  bool  {  diff  :=  math.Abs(x  -  y)  mean  :=  math.Abs(x  +  y)  /  2.0  return  (diff  /  mean)  <  tolerance  }) 
```

ç„¶åï¼Œå½“è¿è¡Œæµ‹è¯•æ—¶ï¼Œåœ¨æµ‹è¯•ç›¸ç­‰æ€§æ—¶ä½¿ç”¨æ¯”è¾ƒå™¨å‡½æ•°:

```
if  !cmp.Equal(got,  tt.want,  opt)  {  t.Fatalf("got %v, wanted %v",  got,  tt.want)  } 
```

æ‚¨çš„æµ‹è¯•è¦å¹²å‡€å¾—å¤šï¼Œå¹¶ä¸”æ‚¨å¯ä»¥è½»æ¾åœ°ä½¿ç”¨é€‚åˆæ‚¨çš„ç”¨ä¾‹çš„æ¯”è¾ƒå™¨å‡½æ•°ã€‚

# Postscript

ç„¶è€Œ...ä½ å¿…é¡»å°å¿ƒä½ çš„æ¯”è¾ƒå‡½æ•°ï¼ä¸Šé¢çš„ä¸€ä¸ªæ˜¯ç›´æ¥æ¥è‡ª cmp æ–‡æ¡£ã€‚ä½†æ˜¯å¾ˆå¿«æˆ‘é‡åˆ°äº†ä¸€ä¸ªæˆ‘æ²¡æœ‰é¢„æ–™åˆ°çš„æµ‹è¯•å¤±è´¥:å½“è¯•å›¾å¯¹é›¶å‘é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œå®ƒå¤±è´¥äº†ã€‚è¿™å¯¼è‡´äº†æˆ‘å’Œæˆ‘çš„æµ‹è¯•ä¹‹é—´çš„äº¤æµ:

[![More<br>
Me: Tests, why are you failing?<br>
Tests: Not telling.<br>
Me: It's a simply equality check! Nothing complex -- I swear!<br>
Tests: Mmmhmmm.<br>
Me: This was my baseline test. The simplest test case I could think of.<br>
Tests: Suuuure.<br>
Me: Let me look. Wait...are you dividing by ZERO!?!<br>
Tests: ğŸ˜ˆ](img/6c977da9683b29cba9d9a50182aa6692.png "Screenshot of a frustrated tweet")](https://res.cloudinary.com/practicaldev/image/fetch/s--vwiMSTsy--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://juliaferraioli.com/blimg/golang-testing-floats/twitter-screenshot.png) 
æ²®ä¸§çš„æ¨ç‰¹ï¼Œ[æ¨ç‰¹](https://twitter.com/juliaferraioli/status/1004770471227940864)

æ˜¯çš„ï¼Œå½“ä¸€ä¸ªå‘é‡ä¸­çš„æ‰€æœ‰å€¼éƒ½æ˜¯ 0 æ—¶ï¼Œæˆ‘æœ€åé™¤ä»¥ 0ã€‚æ‰€ä»¥æˆ‘çš„å®é™…æ¯”è¾ƒå™¨å‡½æ•°çœ‹èµ·æ¥åƒè¿™æ ·:

```
opt  :=  cmp.Comparer(func(x,  y  float64)  bool  {  diff  :=  math.Abs(x  -  y)  mean  :=  math.Abs(x  +  y)  /  2.0  if  math.IsNaN(diff  /  mean)  {  return  true  }  return  (diff  /  mean)  <  tolerance  }) 
```

å½“ç„¶ï¼Œå¦‚æœä¸ä½¿ç”¨`cmp`æ¯”è¾ƒå™¨é€‰é¡¹ï¼ŒåŒæ ·çš„é€»è¾‘(`diff / mean`)ä¹Ÿä¼šæœ‰åŒæ ·çš„é—®é¢˜ï¼Œæ‰€ä»¥è¿™ä¸ªæœ‰è¶£çš„æ•…äº‹æ˜¯å…³äºä¸€èˆ¬æƒ…å†µçš„ã€‚

ä½†æ˜¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨äº† 8 è¡Œä»£ç æ¥è®©æˆ‘çš„æµ‹è¯•çœŸæ­£æµ‹è¯•æˆ‘æ‰€å…³å¿ƒçš„ä¸œè¥¿ã€‚æ‰€ä»¥å¦‚æœä½ åœ¨åšç§‘å­¦è®¡ç®—ï¼Œä¸è¦å¿˜è®°ä½ çš„æ¯”è¾ƒå‡½æ•°ï¼

æ­»

*è¿™ç¯‡åšæ–‡ä¸­çš„æ‰€æœ‰ä»£ç éƒ½æ˜¯åœ¨ [Apache 2.0 è®¸å¯](https://www.apache.org/licenses/LICENSE-2.0)ä¸‹å‘å¸ƒçš„ï¼Œ[å¯ä»¥åœ¨ GitHub](https://github.com/juliaferraioli/code_snippets/tree/master/blogs/cmp-testing/floats) ä¸Šæ‰¾åˆ°ã€‚*