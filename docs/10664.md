# æ²¡æœ‰å¯åŠ¨ç±»çš„ ASP.NET æ ¸å¿ƒ 2 web æœåŠ¡

> åŸæ–‡:[https://dev . to/kspeakman/aspnet-core-2-web-service-without-a-startup-class-4gkn](https://dev.to/kspeakman/aspnet-core-2-web-service-without-a-startup-class-4gkn)

# [](#update-20180706)æ›´æ–° 2018-07-06

è¿™ç¯‡æ–‡ç« çš„å†…å®¹å› ä¸º ASP.NET æ ¸å¿ƒä¸æ”¯æŒå¤šæ¬¡è¿è¡Œ`Configure(...)`è€Œæœ‰æ‰€å‡å°‘ã€‚ç›¸åï¼Œå°†åªè¿è¡Œæœ€åä¸€ä¸ªé…ç½®åŠŸèƒ½ã€‚

ç„¶è€Œï¼Œæˆ‘ç¨å¾®è°ƒæ•´äº†ä¸€ä¸‹æˆ‘çš„åŠ©æ‰‹ï¼Œä»¥ä¾¿å•ç‹¬è·Ÿè¸ªæ‰€éœ€çš„é…ç½®å‡½æ•°ï¼Œå¹¶ä¸”åªåœ¨æ„å»ºæ—¶åº”ç”¨å®ƒä»¬ã€‚ä¸‹é¢æ˜¯ JWT OAuth çš„æ›´æ–°ç¤ºä¾‹ã€‚

```
type AppBuilder = IApplicationBuilder -> IApplicationBuilder

let setAuth0Auth audKey authKey (host : IWebHostBuilder, configs : AppBuilder list) =
    ( host
        .ConfigureServices(fun (context : WebHostBuilderContext) (services : IServiceCollection) ->
            let config = context.Configuration
            services
                .AddAuthentication(fun options ->
                    options.DefaultAuthenticateScheme <- JwtBearerDefaults.AuthenticationScheme
                    options.DefaultChallengeScheme <- JwtBearerDefaults.AuthenticationScheme
                )
                .AddJwtBearer(fun options ->
                    options.Audience <- config.[audKey]
                    options.Authority <- config.[authKey]
                )
            |> ignore
        )
    , configs @ [ fun app -> app.UseAuthentication() ]
    )

let run (host : IWebHostBuilder, configs : AppBuilder list) =
    host
        .Configure(fun (app : IApplicationBuilder) ->
            configs
            |> List.fold (fun x f -> f x) app
            |> ignore
        )
        .Build()
        .Run() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦åˆ™ä¸‹é¢çš„å†…å®¹è¿˜æ˜¯å¯ä»¥ç”¨çš„ã€‚

* * *

å‡ å¤©æ¥ï¼Œæˆ‘ä¸€ç›´åœ¨æ•²æ‰“é”®ç›˜ï¼Œè¯•å›¾æ­£ç¡®é…ç½® ASP.NET Core 2 web æœåŠ¡ï¼Œä½¿å…¶åœ¨ä¸ä½¿ç”¨å¯åŠ¨ç±»çš„æƒ…å†µä¸‹è¿è¡Œã€‚æˆ‘ç»ˆäºè®©å®ƒå·¥ä½œäº†ã€‚

## [](#why)ä¸ºä»€ä¹ˆï¼Ÿ

å¯åŠ¨ç±»æ˜¯å„ç§å…³æ³¨ç‚¹ã€ä¸å¿…è¦çš„æŠ½è±¡å’Œä¸å¿…è¦çš„è®°å¿†æƒ¯ä¾‹çš„ä¸€ä¸ªéå¸¸æƒŠäººçš„æ··åˆä½“ã€‚ä¸ä»…å¦‚æ­¤ï¼Œä½¿ç”¨ä¸åŒçš„æ–¹æ³•å®é™…ä¸Šå¯ä»¥æ›´å®¹æ˜“åœ°åˆ›å»ºå’Œç»´æŠ¤æœåŠ¡é…ç½®ã€‚

## [](#how)å¦‚ä½•ï¼Ÿ

æˆ‘å°†ä»æœ€ç»ˆç»“æœå¼€å§‹ï¼Œé€†å‘å·¥ä½œã€‚è¿™æ˜¯æˆ‘æœå½¹æ—¶çš„æ ·å­ã€‚

```
[<EntryPoint>]
let main args =
    let basePath = Directory.GetCurrentDirectory()

    new WebHostBuilder()
    |> setConfig basePath args
    |> setSerilogLogger
    |> removeServerHeader // bye X-Powered-By
    |> setAuth0Auth Keys.Audience Keys.Authority
    |> setCorsPolicy
    |> setRouteHandler MyApi.routes
    |> run

    0 // exit code 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

çœ‹ç€è¿™æ®µä»£ç ï¼Œæˆ‘è¦é…ç½®çš„ä¸œè¥¿(å¸Œæœ›)æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚å½“ç„¶ï¼Œè¿™äº›æ˜¯æˆ‘å¿…é¡»è‡ªå·±åˆ›å»ºçš„è¾…åŠ©å‡½æ•°ã€‚ä½†æ˜¯å› ä¸ºè¿™äº›å‡½æ•°æ˜¯ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥å®ƒä»¬å¯ä»¥åœ¨å…¶ä»–é¡¹ç›®ä¸­é‡ç”¨ã€‚å®ƒä»¬è¿˜å…è®¸æˆ‘é€šè¿‡æ·»åŠ æˆ–åˆ é™¤ä¸€è¡Œæ¥é€‰æ‹©åŠ å…¥æˆ–é€€å‡ºå„ç§åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œæˆ‘å¯ä»¥ç”¨`setLogaryLogger`ä»£æ›¿`setSerilogLogger`ã€‚

è¯šç„¶ï¼Œæ„å»ºå™¨å·²ç»æœ‰äº†æµç•…çš„æ–¹æ³•â€”â€”æ¯”å¦‚`Configure`å’Œ`ConfigureServices`ã€‚ä½ ä¹Ÿå¯ä»¥ä¸ºä»–ä»¬åšåŒæ ·çš„å£°æ˜ã€‚ä½†æ˜¯ï¼Œæœ‰äº›åŠŸèƒ½ä¸æ˜¯ä»…é€šè¿‡ä¸€ç§ fluent æ–¹æ³•é…ç½®çš„ã€‚ä¾‹å¦‚ï¼Œ`setAuth0Auth`å‡½æ•°å¿…é¡»åœ¨å†…éƒ¨ä½¿ç”¨ä¸€äº›æ–¹æ³•æ¥æ­£ç¡®é…ç½®è®¤è¯:

```
let setAuth0Auth audienceKey authorityKey (host : IWebHostBuilder) =
    host
        .ConfigureServices(fun (context : WebHostBuilderContext) (services : IServiceCollection) ->
            let config = context.Configuration
            services
                .AddAuthentication(fun options ->
                    options.DefaultAuthenticateScheme <- JwtBearerDefaults.AuthenticationScheme
                    options.DefaultChallengeScheme <- JwtBearerDefaults.AuthenticationScheme
                )
                .AddJwtBearer(fun options ->
                    options.Authority <- config.[authorityKey]
                    options.Audience <- config.[audienceKey]
                )
                |> ignore
        )
        .Configure(fun builder -> builder.UseAuthentication() |> ignore) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°†å®ƒç»„ç»‡æˆè‡ªå·±çš„å‡½æ•°å‡†ç¡®åœ°å°è£…äº†è®¾ç½® auth éœ€è¦åšçš„äº‹æƒ…ï¼Œå¹¶ä¸”åªæœ‰ authã€‚å› ä¸ºå®ƒåªä½¿ç”¨ä¼ é€’ç»™å®ƒçš„å†…å®¹ï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°å¯¹äºå…¶ä»–æœåŠ¡æ¥è¯´æ˜¯éå¸¸å¯é‡ç”¨çš„ã€‚(æœ‰ç‚¹é—æ†¾çš„æ˜¯ï¼Œæ„å»ºå™¨ä½¿ç”¨äº†çªå˜ï¼Œä½†è¿™ä¸å¤ªå¯èƒ½æ˜¯ä¸ªé—®é¢˜ï¼Œå› ä¸ºè¿™æ®µä»£ç åªåœ¨å¯åŠ¨æ—¶è¿è¡Œã€‚)

å¼„æ¸…æ¥šå¦‚ä½•åˆ›å»ºæ— å¯åŠ¨æœåŠ¡çš„æ£˜æ‰‹éƒ¨åˆ†æ˜¯è®¿é—®æ‚¨å¯èƒ½éœ€è¦çš„ä¸œè¥¿ï¼Œæ¯”å¦‚`IConfiguration`å’Œ`IHostingEnvironment`çŠ¶æ€ã€‚æˆ‘æ‰¾åˆ°çš„æ¯ä¸€æ¡å»ºè®®éƒ½æ˜¯:â€œæŠŠå®ƒä»¬æ³¨å…¥ä¸€ä¸ªåˆ›ä¸šç­â€ğŸ™ƒã€‚ä½†äº‹å®è¯æ˜ï¼Œç”¨ [`ConfigureService`è¿‡è½½](https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder.configureservices?view=aspnetcore-2.1)ä¸­çš„ä¸€ä¸ªå¾ˆå®¹æ˜“æ‰¾åˆ°å®ƒä»¬ã€‚å¸¦`WebHostBuilderContext`çš„é‚£ä¸ªæ˜¯é’¥åŒ™ã€‚å®ƒå°†é…ç½®å’Œå®¿ä¸»å¯¹è±¡éƒ½ä½œä¸ºå±æ€§ã€‚ä½ å¯ä»¥åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­çœ‹åˆ°ï¼Œæˆ‘ç”¨å®ƒæ¥è·å–`IConfiguration`å¯¹è±¡ã€‚

ä»`Configure`ä¸­è·å–è¿™äº›é¡¹ç›®æ›´å…·æŒ‘æˆ˜æ€§ï¼Œå› ä¸ºå®ƒæ²¡æœ‰å°†è¿™äº›ä½œä¸ºç›´æ¥å±æ€§çš„é‡è½½ã€‚ä½†æ˜¯ï¼Œä½ ä»ç„¶å¯ä»¥åœ¨æä¾›çš„`IApplicationBuilder`ä¸­æ‰¾åˆ°å®ƒä»¬(å’Œå…¶ä»–ä¸œè¥¿)ã€‚

```
webHostBuilder
    .Configure(fun (builder : IApplicationBuilder) ->
        let services = builder.ApplicationServices
        let env = services.GetService<IHostingEnvironment>()
        let config = services.GetService<IConfiguration>()
        ...
    ) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#summary)æ€»ç»“

å‡ ä¸ªåŠ©æ‰‹å‡½æ•°å¯¹é™ä½é…ç½®æœåŠ¡çš„å¤æ‚æ€§å¤§æœ‰å¸®åŠ©ã€‚å½“å®ƒä»¬å¯é‡ç”¨æ¥åˆ›å»ºå…¶ä»–æœåŠ¡æ—¶ï¼Œé‚£å°±æ›´å¥½äº†ï¼