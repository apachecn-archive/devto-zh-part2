# 在 Elixir 中流式传输大型数据集

> 原文:[https://dev . to/jackmarchant/streaming-large-datasets-in-elixir-2mnm](https://dev.to/jackmarchant/streaming-large-datasets-in-elixir-2mnm)

## 什么是流？

我们通常认为流媒体是我们观看视频/音频等多媒体内容的方式。我们按下 play，内容被缓冲并开始通过线路发送数据。接收数据的客户机将处理这些数据包并显示内容，同时请求更多的数据。流媒体使我们能够通过互联网消费大型媒体内容类型，如电视节目或电影。

一个[流](https://hexdocs.pm/elixir/Stream.html)在这个词的仙丹意义上来说，是一种可组合的方式，用来懒惰地评估集合上的转换。当管理大型数据集时，传统上，您会将所有记录加载到内存中，比如从一个数据库查询中，并使用[枚举](https://hexdocs.pm/elixir/Enum.html)模块在每次调用`Enum`函数时应用各种转换。使用 Streams，您可以以可组合的方式调用流函数，但是只有当调用`Stream.run/1`或者将其转换为可枚举类型时，它才会实际执行这些计算。

当我们通过调用流模块上众多函数中的一个来创建一个新的流时，例如`Stream.map/2`，我们传递给它一个可枚举的和一个函数，我们希望它被延迟应用。我们可以看到返回的流，保留了对原始可枚举值:`enum`和我们想要应用的函数:`funs`的引用。

只有当我们将流转换为可枚举类型时，函数才会针对可枚举类型运行，这样我们就有了结果。

## 为什么要用流？

我认为使用流有三个好处:

1.  函数可以被延迟求值，从而随着时间的推移而构建，直到流最终被转换或运行。
2.  大型数据集可以分割成较小的块，从而减少消耗它们所需的内存量。
3.  流鼓励函数的可组合性，而不需要在`Enum.reduce`中编写复杂的代码。

这些优势更容易用代码描述:

您可以看到，拥有大型数据集，并为每个转换枚举整个列表的成本会更高。通过 Streams 及其惰性评估，我们可以推迟获取值，直到需要时，这意味着它可以减少花费在进行潜在的昂贵计算上的时间。

流是一个强大的概念，它允许您通过鼓励函数的组合来有效地管理甚至无限的数据集。对于复杂的`Enum.reduce/3`函数来说，流是一个方便的替代品。使用流不仅可以清理您的代码，还可以让您对数据上发生的转换有一个更清晰的印象。组合函数是 Elixir 擅长的，Streams 允许你分解数据转换，甚至可能在不同的时间完成它们——这在 reducer 函数中并不容易。

## 使用 Ecto(或其他数据源)

将流用于数据库时，特别是用于 Repo.stream/2 和 Stream.resource/3 时，流会变得非常强大。后者更通用一些，所以我们将使用它作为例子。

使用`Stream.resouce/3`,您可以将数据集分成指定的数量，并通过流发出它们。它允许您跟踪通过标识符看到的最后一条记录，并从它停止的地方开始下一个块。你所需要做的就是考虑应用什么样的转换以及何时评估它们。

我们可以将这些概念应用于其他数据源，而不仅仅是 Ecto 甚至是数据库。这可用于从使用分页来浏览数据的 API 接收结果。

使用流，我们可以组合函数并将它们推到堆栈上，直到我们准备好让 Elixir 一起评估所有函数的结果。这是一个强大的概念，我期待着在未来与他们一起做更多的事情。