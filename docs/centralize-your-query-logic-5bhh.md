# 集中您的查询逻辑！

> 原文：<https://dev.to/dmfay/centralize-your-query-logic-5bhh>

在我本月早些时候的一次演讲中，一位听众问 [Massive](https://github.com/dmfay/massive-js) 是否支持将来自多个表的信息连接在一起。这个问题以前也出现过。Massive 目前没有这个功能，虽然我很乐意接受建议，但它不在我的考虑范围内。

出现这种情况的主要原因是，从应用程序架构的角度来看，连接逻辑可能很难管理。在需要时关联和组合所需内容的能力当然非常强大，但它也在客户端代码中嵌入了关于数据库布局的假设。随着数据库和应用程序的发展，这些假设很容易过时，并且彼此不同步。实际上，如果您的应用程序从数据库加载的用户“模型”(无论是隐式的还是显式的)有时只包括用户记录本身，但其他时候会在单独的配置文件表中查找信息、添加当前统计数据等等，并且您拥有对用户进行操作的功能，那么要么您了解用户有不同的形式并全面地相应地处理它们，要么您是在借用正常运行时间。

一些应用程序架构通过将查询逻辑组合在一起来处理这种情况。在企业世界中， *n 层*应用程序经常将相关查询拉入“服务”或数据访问对象(Dao)中，因此至少存在某种组织模式。这在一定程度上减少了维护开销，但这不是一个完美的解决方案，尤其是因为除了容易出错的代码审查(如果有的话)之外，没有任何东西能够阻止有人将数据访问代码放到其他地方。

幸运的是，已经有一部分应用程序数据库生态系统致力于组织事物——数据库本身！作为一个组织原则，它已经有了自己管理复杂查询的方式。当然，这将涉及到编写一点 SQL，但是让我们面对它:无论如何，你最终都要编写 SQL。

如果您只接触了使用数据库的皮毛，那么您可能不熟悉视图。好消息是它们非常简单:视图是一个带有名称的存储的 SQL 查询，由语句`CREATE VIEW myview AS SELECT...`赋予生命。您可以像处理表一样从视图中执行`SELECT`,可以选择使用`JOIN`和`WHERE`子句以及所有其他修饰，然后数据库执行查询。结果不会被存储，所以您从视图中获得的信息总是最新的，除非您通过创建一个*物化*视图来故意牺牲实时数据以提高速度，该视图不会保存结果，并且必须手动刷新。

应用程序开发中视图被低估和利用不足的原因主要与开发人员用来与数据库通信的框架有关。当你必须提供一元`User`模型的具体实现时，很可能你只关心你既能读*又能写*的东西，所以你用表来备份它，而不是使用视图来形成你需要的数据。在对象/关系映射中几乎没有视图的空间，当我不得不使用 O/RMs 时，我只能利用视图来简化使用 O/RMs 时必须编写的原始 SQL 查询。

但是，如果您没有被对象关系映射器所困扰，您真的可以从视图中获得金钱的价值！从一个视图中检索用户记录，或者通过将它加入到其他视图中来构建更复杂的包含用户的结果，确保您对数据库中构建的用户信息有一个一致的定义。当然，您不能总是阻止其他开发人员即兴发挥，但是有了这个核心定义，至少消除了一个主要的潜在歧义。Massive 省略了 join 特性，这鼓励了使用它的开发人员将他们的思想集中在数据库和它提供的组织信息的工具上。

和任何事情一样，也有权衡。在这里，是灵活性。视图可能是短暂的存储查询，但尽管如此，它们仍然是数据库模式的一部分，并且模式的改变比应用程序代码需要更多的计划和努力。但是首先仔细考虑这些东西是个好主意。