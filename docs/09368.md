# React ä¸­çš„çŠ¶æ€ç®¡ç†:Redux è¿˜æ˜¯ not Reduxï¼Ÿ

> åŸæ–‡:[https://dev . to/alexisjanvier/managing-state-in-react-redux-or-not-redux-4 ebp](https://dev.to/alexisjanvier/managing-state-in-react-redux-or-not-redux-4ebp)

***æ³¨:æœ¬å¸–åŸå¸–äº marmelab.com çš„[ã€‚](https://marmelab.com/blog/2018/06/27/redux-or-not-redux.html)***

åœ¨ Marmelabï¼Œæˆ‘ä»¬éå¸¸å–œæ¬¢ä½¿ç”¨ [Redux](https://redux.js.org/) æ¥ç®¡ç† React åº”ç”¨çš„çŠ¶æ€ã€‚å®ƒçš„å‡ºç°æ”¹å˜äº†æˆ‘ä»¬ç¼–å†™åº”ç”¨ç¨‹åºçš„æ–¹å¼:ä¸å˜æ€§ã€å‡½æ•°å¼ç¼–ç¨‹ã€ä½¿ç”¨ Redux-Saga ç”Ÿæˆå™¨çš„å¼‚æ­¥ API è°ƒç”¨ç®¡ç†...ä»¥è‡³äºæˆ‘ä»¬æœ‰æ—¶å€¾å‘äºâ€œäº‹å®ä¸Šâ€å°† Redux é›†æˆåˆ°æˆ‘ä»¬çš„é¡¹ç›®å¯åŠ¨å †æ ˆä¸­ã€‚

ä½†è¿™æ˜¯ä¸ªå¥½ä¸»æ„å—ï¼Ÿä¸ç¡®å®š...

## ä¸€ä¸ªä¾‹å­:ç”¨ React ç®¡ç†èšä¼š

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªç®€å•çš„ meetup ç®¡ç†åº”ç”¨ç¨‹åºã€‚å®ƒåº”è¯¥èƒ½å¤Ÿæ˜¾ç¤º:

*   ä¸€ä»½ææ¡ˆæ¸…å•ï¼Œ
*   ä¼šè°ˆçš„æ„¿æœ›æ¸…å•ï¼Œ
*   meetup æˆå‘˜åˆ—è¡¨ã€‚

æ•°æ®æ¥è‡ª REST APIã€‚ç™»å½•/å¯†ç ä¿æŠ¤åº”ç”¨ç¨‹åºå’Œ APIã€‚

åº”ç”¨ç¨‹åºé€šè¿‡ [Create React App](https://github.com/facebook/create-react-app) å¼•å¯¼ï¼Œå¹¶é€šè¿‡ä»¥ä¸‹æ–¹å¼å‡çº§:

*   [è¿˜åŸ](https://redux.js.org/)
*   [Redux-Saga](https://redux-saga.js.org/)
*   [react-router-redux](https://github.com/reactjs/react-router-redux)

è¿™ä¸ªé¡¹ç›®æ˜¯è¿™æ ·çš„:

[![Edit simple-application-with-redux](../Images/0b3f0135583496627e3621355d8e9248.png)T2ã€‘](https://codesandbox.io/s/m5n2xjl6pj)

è¯¥åº”ç”¨ç¨‹åºåæ˜ äº†å…¸å‹çš„ redux æ¶æ„ã€‚å®ƒä»ä¸€ä¸ª`<App />`ç»„ä»¶å¼€å§‹ï¼Œè¯¥ç»„ä»¶å®‰è£…äº† redux store ( `<Provider store={store}>`)å’Œè·¯ç”±å™¨(`<ConnectedRouter history={history}>` ):

```
// in App.js
...
 export const App = ({ store, history }) => (
    <Provider store={store}>
        <ConnectedRouter history={history}>
            <Container>
                <Header />
                <Switch>
                    <Route exact path="/" component={Home} />
                    <Route path="/talks" component={Talks} />
                    <Route path="/wishes" component={Wishes} />
                    <Route path="/members" component={Members} />
                    <Route path="/login" component={Authentication} />
                    <Route component={NoMatch} />
                </Switch>
            </Container>
        </ConnectedRouter>
    </Provider> ); 
```

Enter fullscreen mode Exit fullscreen mode

Redux ç”¨æˆ·ä¼šå¯¹æˆ‘é€‰æ‹©çš„æ–‡ä»¶ç»“æ„æ„Ÿåˆ°æ»¡æ„ã€‚æˆ‘å°†ä¸ä¸€ä¸ªç‰¹æ€§ç›¸å…³çš„æ‰€æœ‰ä»£ç åˆ†ç»„åˆ°ä¸€ä¸ªç›®å½•ä¸­ã€‚ä¸€ä¸ªå…³äº`talks`é¡µé¢çš„ä¾‹å­:

```
â”œâ”€â”€ talks
â”‚   â”œâ”€â”€ actions.js
â”‚   â”œâ”€â”€ reducer.js
â”‚   â”œâ”€â”€ sagas.js
â”‚   â””â”€â”€ Talks.js 
```

Enter fullscreen mode Exit fullscreen mode

`<Talks>`é¡µé¢ç»„ä»¶æ˜¯ä¸€ä¸ªç®€å•çš„â€œè¿æ¥ç»„ä»¶â€:

```
 // in talks/Talks.js
export const Talks = ({ isLoading, talks }) => (
    <div>
        <h1>Talks</h1>
        {isLoading && <Spinner />}
        {talks && talks.map(talk => <h2 key={talk.id}>{talk.title}</h2>)}
    </div> );

const mapStateToProps = ({  talks }) => ({
    isLoading: talks.isLoading,
    talks: talks.data,
});

// passing {} as the second's connect argument prevents it to pass dispatch as prop
const mapDispatchToProps = {};

export default connect(mapStateToProps, mapDispatchToProps)(Talks); 
```

Enter fullscreen mode Exit fullscreen mode

ä¼šè°ˆçš„æ•°æ®ä¸æ˜¯åœ¨`componentWillMount`è·å–çš„ï¼Œè€Œæ˜¯é€šè¿‡ç›‘å¬è·¯çº¿å˜åŒ–çš„ä¼ å¥‡:

```
// in talks/sagas.js
import { put, select, takeLatest } from 'redux-saga/effects';
import { LOCATION_CHANGE } from 'react-router-redux';

import { loadTalks } from './actions';

const hasData = ({ talks }) => !!talks.data;

export function* handleTalksLoading() {
    if (yield select(hasData)) {
        return;
    }

    yield put(loadTalks());
}

export const sagas = function*() {
    yield takeLatest(
        action =>
            action.type === LOCATION_CHANGE &&
            action.payload.pathname === '/talks',
        handleTalksLoading,
    );
}; 
```

Enter fullscreen mode Exit fullscreen mode

å½“è·¯çº¿æ”¹å˜å¹¶å¯¹åº”äºä¼šè°ˆéƒ¨åˆ†(`action.type === LOCATION_CHANGE && action.payload.pathname === '/talks'`)æ—¶ï¼Œæˆ‘çš„åº”ç”¨ç¨‹åºé€šè¿‡`loadTalks`åŠŸèƒ½è§¦å‘ä¸€ä¸ªåŠ¨ä½œ:

```
// in talks/actions.js
export const LOAD_TALKS = 'LOAD_TALKS';

export const loadTalks = payload => ({
    type: 'LOAD_TALKS',
    payload,
    meta: {
        request: {
            url: '/talks',
        },
    },
}); 
```

Enter fullscreen mode Exit fullscreen mode

è¿™ä¸ªåŠ¨ä½œåœ¨å®ƒçš„**å…ƒ**ä¸­åŒ…å«äº†è·å–ä¼šè°ˆæ•°æ®çš„ urlï¼Œå®ƒå°†è¢«ä¸€ä¸ªé€šç”¨è·å–**ä¼ å¥‡**T0:
æ‹¦æˆª

```
// in /services/fetch/fetchSagas.js
import { call, put, takeEvery, select } from 'redux-saga/effects';

import { appFetch as fetch } from './fetch';

export const fetchError = (type, error) => ({
    type: `${type}_ERROR`,
    payload: error,
    meta: {
        disconnect: error.code === 401,
    },
});

export const fetchSuccess = (type, response) => ({
    type: `${type}_SUCCESS`,
    payload: response,
});

export function* executeFetchSaga({ type, meta: { request } }) {
    const token = yield select(state => state.authentication.token);
    const { error, response } = yield call(fetch, request, token);
    if (error) {
        yield put(fetchError(type, error));
        return;
    }

    yield put(fetchSuccess(type, response));
}

export const sagas = function*() {
    yield takeEvery(
        action => !!action.meta && action.meta.request,
        executeFetchSaga,
    );
}; 
```

Enter fullscreen mode Exit fullscreen mode

ä¸€æ—¦è·å–æˆåŠŸï¼Œsaga å°†è§¦å‘æŒ‡ç¤ºæ•°æ®æ¢å¤æˆåŠŸçš„æœ€ç»ˆæ“ä½œ(`createAction('${type}_SUCCESS')(response)`)ã€‚è¯¥åŠ¨ä½œç”±ä¼šè°ˆä½¿ç”¨**å‡é€Ÿå™¨** :

```
// in talks/reducers.js
export const reducer = (state = defaultState, action) => {
    switch (action.type) {
        case LOAD_TALKS:
            return {
                ...state,
                loading: true,
            };
        case LOAD_TALKS_ERROR:
            return {
                ...state,
                loading: false,
                error: action.payload,
            };
        case LOAD_TALKS_SUCCESS:
            return {
                ...state,
                loading: false,
                data: action.payload,
            };
        case LOGOUT:
            return defaultState;
        default:
            return state;
    }
}; 
```

Enter fullscreen mode Exit fullscreen mode

æ•ˆæœå¾ˆå¥½ã€‚è¿™å¾ˆèªæ˜ï¼Œç”šè‡³å¾ˆä¼˜é›…ï¼åŠ¨ä½œçš„**å…ƒ**çš„ä½¿ç”¨å…è®¸åœ¨åº”ç”¨ç¨‹åºå†…å…±äº«é€šç”¨è¡Œä¸º(æ•°æ®è·å–ä»¥åŠé”™è¯¯å¤„ç†æˆ–æ³¨é”€)ã€‚

## å¾ˆèªæ˜ï¼Œä½†æ˜¯å¾ˆå¤æ‚

å½“ä½ å‘ç°åº”ç”¨ç¨‹åºæ—¶ï¼Œä¸å®¹æ˜“æ‰¾åˆ°æ–¹å‘ï¼Œæœ‰äº›è¡Œä¸ºæ˜¯å¦‚æ­¤ç¥å¥‡ã€‚æ€»è€Œè¨€ä¹‹ï¼Œåº”ç”¨ç¨‹åºä½¿ç”¨è¿æ¥åˆ°è·¯ç”±å™¨çš„ redux-saga è·å–æ•°æ®ï¼Œè·¯ç”±å™¨å‘é€ç”±å¦ä¸€ä¸ªé€šç”¨ saga æ‹¦æˆªçš„è·å–åŠ¨ä½œï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™å‘å‡ºå¦ä¸€ä¸ªåŠ¨ä½œï¼Œç”±é¡µé¢çš„ redux-saga æ‹¦æˆªçš„åŠ¨ä½œå·²ç»å‘å‡ºäº†é“¾çš„ç¬¬ä¸€ä¸ªåŠ¨ä½œ...

æœ‰äº›äººå¯èƒ½ä¼šè¯´è¿™æ˜¯å¯¹ redux çš„æ»¥ç”¨ï¼Œä½†å®ƒä¸»è¦æ˜¯åœ¨è¿™ä¸ªå †æ ˆä¸Šå®Œæˆçš„å‡ ä¸ªé¡¹ç›®çš„ç»“æœï¼Œæœ‰é‡å†™åŠ¨ä½œå’Œ reducers çš„ç»éªŒã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¤§é‡çš„*ç®¡é“*ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªç‰¹æ€§éƒ½æœ‰è®¸å¤šé‡å¤çš„æ–‡ä»¶(åŠ¨ä½œã€å‡å°‘å™¨å’Œå…¶ä»–ä¼ å¥‡)ã€‚

è®©æˆ‘ä»¬åˆ†æä¸€ä¸‹è¿™ä¸ªåŒ…å«ä¸‰ä¸ªé¡µé¢çš„ç¤ºä¾‹åº”ç”¨ç¨‹åº:ä¸»é¡µå’Œç™»å½•é¡µé¢:

```
 â¯ cloc services/cra_webapp/src
      32 text files.
      32 unique files.
       0 files ignored.

github.com/AlDanial/cloc v 1.74  T=0.06 s (581.6 files/s, 17722.1 lines/s)
-------------------------------------------------------------------------------
Language                     files          blank        comment           code
-------------------------------------------------------------------------------
JavaScript                      31            150              1            819
CSS                              1              0              0              5
-------------------------------------------------------------------------------
SUM:                            32            150              1            824
------------------------------------------------------------------------------- 
```

Enter fullscreen mode Exit fullscreen mode

31 ä¸ªæ–‡ä»¶ï¼Œ819 è¡Œä»£ç ï¼Œå¯¹äºä¸€ä¸ªç®€å•çš„åº”ç”¨æ¥è¯´å·²ç»å¾ˆå¤šäº†ã€‚è¿™æ®µä»£ç å¯ä»¥ç®€åŒ–ä¸€ç‚¹ï¼Œä½†æœ‰å¯èƒ½ä¼šå˜å¾—ä¸é‚£ä¹ˆé€šç”¨ã€‚

å½“ç„¶æ˜¯æ—¶å€™é—®é—®æˆ‘ä»¬è‡ªå·± Redux åœ¨è¿™é‡Œæ˜¯å¦æœ‰å¿…è¦äº†ï¼Ÿ

> Redux æ˜¯ JavaScript åº”ç”¨ç¨‹åºçš„å¯é¢„æµ‹çŠ¶æ€å®¹å™¨ã€‚

ä½†æ˜¯ï¼Œåº”ç”¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†æ˜¯å¦ä¼šä¿®æ”¹ç›¸åŒçš„æ•°æ®ï¼Œéœ€è¦è¯¥æ•°æ®çš„å¯é¢„æµ‹çŠ¶æ€ï¼Ÿä¸ï¼Œæˆ‘åªéœ€è¦æ˜¾ç¤ºæ¥è‡ª API çš„æ•°æ®ã€‚DOM ä¸­æ˜¯å¦åŸ‹æœ‰å¯ä»¥ä¿®æ”¹æ•°æ®çš„ç»„ä»¶ï¼Ÿä¸ï¼Œç”¨æˆ·äº¤äº’éå¸¸æœ‰é™ã€‚

æ‰€ä»¥æˆ‘å¤§æ¦‚ä¸éœ€è¦ Reduxã€‚

## å–æ•°æ®æ— å†—ä½™

è®©æˆ‘ä»¬å°è¯•åœ¨æ²¡æœ‰ Redux çš„æƒ…å†µä¸‹è·å–æ•°æ®ï¼Œæˆ–è€…æ›´å‡†ç¡®åœ°è¯´ï¼Œåœ¨æ²¡æœ‰ **Redux-Saga** çš„æƒ…å†µä¸‹è·å–æ•°æ®(å› ä¸ºæ‰§è¡Œæ•°æ®è·å–ä¸æ˜¯ Redux çš„ç›´æ¥å·¥ä½œ)ã€‚æˆ‘å¯ä»¥åœ¨æ¯ä¸ªé¡µé¢ä¸Šå®ç°æ‰€æœ‰è¿™äº›è·å–é€»è¾‘ã€‚ç„¶è€Œï¼Œè¿™å°†å»ºç«‹éå¸¸é‡å¤çš„æœºåˆ¶å’Œå¤§é‡é‡å¤çš„ä»£ç ã€‚æ‰€ä»¥æˆ‘å¿…é¡»æ‰¾åˆ°ä¸€ç§é€šç”¨çš„æ–¹æ³•ä» API ä¸­è·å–æ•°æ®ï¼Œè€Œä¸ä¼šå¼•å…¥å¤ªå¤šçš„é‡å¤å’Œå¤æ‚æ€§ã€‚

[**æ¸²æŸ“é“å…·**](https://cdb.reacttraining.com/use-a-render-prop-50de598f11ce) å›¾æ¡ˆæ˜¯è¿™ç±»é—®é¢˜çš„ç»ä½³å€™é€‰ï¼

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª`DataProvider`ç»„ä»¶:

```
// in DataProvider.js
import React, { Component, Fragment } from 'react';
import { Redirect } from 'react-router';
import { appFetch } from './services/fetch';

export class DataProvider extends Component {
    static propTypes = {
        render: PropTypes.func.isRequired,
        url: PropTypes.string.isRequired,
    };

    state = {
        data: undefined,
        error: undefined,
    };

    fetchData = async props => {
        const token = window.sessionStorage.getItem('token');
        try {
            const data = await appFetch({ url }, token);
            this.setState({
                data: data.response,
                error: null,
            });
        } catch (error) {
            this.setState({
                error,
            });
        }
    };

    componentDidMount() {
        return this.fetchData(this.props);
    }

    render() {
        const { data, error } = this.state;
        const { location } = this.props;

        if (error) {
            return error.code >= 401 && error.code <= 403 ? (
                <Redirect to="/login" />
            ) : (
                <p>Erreur lors du chargement des donnÃ©es</p>
            );
        }

        return (
            <Fragment>
                {data ? (
                    <p>Aucune donnÃ©e disponible</p>
                ) : (
                    this.props.render({
                        data,
                    })
                )}
            </Fragment>
        );
    }
} 
```

Enter fullscreen mode Exit fullscreen mode

è¯¥ç»„ä»¶åœ¨`componentDidMount`æœŸé—´ä»å±æ€§`url`è·å–æ•°æ®ã€‚å®ƒç®¡ç†é”™è¯¯å’Œä¸¢å¤±çš„æ•°æ®ã€‚å¦‚æœå®ƒå¾—åˆ°æ•°æ®ï¼Œå®ƒä¼šå°†æ¸²æŸ“å§”æ‰˜ç»™ä½œä¸º`render` prop ( `this.props.render({ data })`)ä¼ é€’çš„å‡½æ•°ã€‚

è®©æˆ‘ä»¬åœ¨å¯¹è¯é¡µé¢ä¸Šå®ç°è¿™ä¸ªç»„ä»¶:

```
// in talks/Talks.js
import React from 'react';
import PropTypes from 'prop-types';

import { DataProvider } from '../DataProvider';

export const TalksView = ({ talks }) => (
    <div>
        <h1>Talks</h1>
        {talks && talks.map(talk => <h2 key={talk.id}>{talk.title}</h2>)}
    </div> );

TalksView.propTypes = {
    talks: PropTypes.array,
};

export const Talks = () => (
    <DataProvider
        url="/talks"
        render={({ data }) => <TalksView talks={data} />}
    />
); 
```

Enter fullscreen mode Exit fullscreen mode

æˆ‘ç°åœ¨æœ‰ä¸¤ä¸ªç»„ä»¶:

*   `TalksView`ç»„ä»¶ï¼Œåªæ˜¾ç¤ºæ•°æ®ï¼Œä¸ç®¡å®ƒæ¥è‡ªå“ªé‡Œï¼Œ
*   `Talks`ç»„ä»¶ï¼Œä½¿ç”¨`DataProvider`è·å–æ•°æ®ï¼Œä½¿ç”¨`TalksView`æ˜¾ç¤ºæ•°æ®`render={({ data }) => <TalksView talks={data} />}`ã€‚

ç®€å•æœ‰æ•ˆï¼Œå¯è¯»æ€§å¼ºï¼

æœ‰ä¸€ä¸ªä¼˜ç§€çš„åº“å®ç°äº†è¿™ç§ç±»å‹çš„ data provider:[React-request:React çš„å£°æ˜æ€§ HTTP è¯·æ±‚](https://github.com/jamesplease/react-request)

æˆ‘ç°åœ¨å‡†å¤‡ä»åº”ç”¨ç¨‹åºä¸­åˆ é™¤ Reduxã€‚

[![Edit simple-application-without-redux](../Images/0b3f0135583496627e3621355d8e9248.png)T2ã€‘](https://codesandbox.io/s/o77qv75rmq)

è®©æˆ‘ä»¬é‡æ–°å¼€å§‹åˆ†ææˆ‘ä»¬çš„é¡¹ç›®:

```
â¯ cloc services/cra_webapp/src
      16 text files.
      16 unique files.
       0 files ignored.

github.com/AlDanial/cloc v 1.74  T=0.04 s (418.9 files/s, 13404.6 lines/s)
-------------------------------------------------------------------------------
Language                     files          blank        comment           code
-------------------------------------------------------------------------------
JavaScript                      15             64              1            442
CSS                              1              0              0              5
-------------------------------------------------------------------------------
SUM:                            16             64              1            447
------------------------------------------------------------------------------- 
```

Enter fullscreen mode Exit fullscreen mode

æ‰€ä»¥æˆ‘ä» 819 è¡Œä»£ç åˆ° **442 è¡Œ**ï¼Œå‡ ä¹å°‘äº†ä¸€åŠã€‚è¿˜ä¸é”™ï¼

## ç”¨ React çŠ¶æ€æ›¿æ¢ Redux å­˜å‚¨

åœ¨å½“å‰çŠ¶æ€ä¸‹ï¼Œæ¯ä¸ªé¡µé¢éƒ½ä½¿ç”¨ DataProvider è·å–æ•°æ®ã€‚ç„¶è€Œï¼Œæˆ‘çš„åº”ç”¨ç¨‹åºéœ€è¦é€šè¿‡ä¸€ä¸ª **json-web-token** è¿›è¡Œèº«ä»½éªŒè¯æ¥è·å–ç”¨æˆ·ä¿¡æ¯ã€‚

å¦‚æœæ²¡æœ‰ Redux å­˜å‚¨ï¼Œè¿™äº›ç”¨æˆ·ä¿¡æ¯å°†å¦‚ä½•ä¼ è¾“åˆ°å„ä¸ªç»„ä»¶ï¼Ÿå—¯ï¼Œé€šè¿‡ä½¿ç”¨ä¸Šçº§ç»„ä»¶(`App.js`)çš„**çŠ¶æ€**ï¼Œå¹¶å°†`user`ä½œä¸ºé“å…·ä¼ é€’ç»™éœ€è¦å®ƒçš„å­ç»„ä»¶(`PrivateRoute.js`ã€`Header.js`)ã€‚

**æ€»ä¹‹è®©æˆ‘ä»¬å†åšä¸€æ¬¡ React ä»£ç å§ï¼**

```
// in App.js
import React, { Component } from 'react';
import { BrowserRouter as Router, Route, Switch } from 'react-router-dom';

import { Authentication } from './authentication/Authentication';
import { Header } from './components/Header';
import { PrivateRoute } from './PrivateRoute';
import { Talks } from './talks/Talks';

export class App extends Component {
    state = {
        user: null,
    };

    decodeToken = token => {
        const user = decode(token);
        this.setState({ user });
    };

    componentWillMount() {
        const token = window.sessionStorage.getItem('token');

        if (token) {
            this.decodeToken(token);
        }
    }

    handleNewToken = token => {
        window.sessionStorage.setItem('token', token);
        this.decodeToken(token);
    };

    handleLogout = () => {
        window.sessionStorage.removeItem('token');
        this.setState({ user: null });
    };

    render() {
        const { user } = this.state;
        return (
            <Router>
                <div>
                    <Header user={user} onLogout={this.handleLogout} />
                    <Switch>
                        <PrivateRoute
                            path="/talks"
                            render={() => (
                                <Talks />
                            )}
                            user={user}
                        />
                        <Route
                            path="/login"
                            render={({ location }) => (
                                <Authentication
                                    location={location}
                                    onNewToken={this.handleNewToken}
                                />
                            )}
                        />
                    </Switch>
                </div>
            </Router>
        );
    }
} 
```

Enter fullscreen mode Exit fullscreen mode

**æ³¨**:æˆ‘çŸ¥é“:æŠŠ`token`å­˜å‚¨åœ¨`window.sessionStorage`é‡Œæ˜¯ä¸€ä¸ª [**çƒ‚ç»ƒ**](https://www.rdegges.com/2018/please-stop-using-local-storage/) ã€‚ä½†æ˜¯ä¸ºäº†è¿™ä¸ªä¾‹å­ï¼Œè¿™å…è®¸æˆ‘å¿«é€Ÿè®¾ç½®è®¤è¯ã€‚è¿™å’Œå»é™¤ Redux æ²¡æœ‰å…³ç³»ã€‚

```
// in PrivateRoute.js
import React from 'react';
import PropTypes from 'prop-types';
import { Redirect, Route } from 'react-router';

/**
 * This Route will redirect the user to the login page if needed.
 */
export const PrivateRoute = ({ user, ...rest }) =>
    user ? (
        <Route {...rest} />
    ) : (
        <Redirect
            to={{
                pathname: '/login',
                state: { from: rest.location },
            }}
        />
    );

PrivateRoute.propTypes = {
    user: PropTypes.object,
}; 
```

Enter fullscreen mode Exit fullscreen mode

```
// in components/Header.js
import React from 'react';
import PropTypes from 'prop-types';

import { Navigation } from './Navigation';

export const Header = ({ user, onLogout }) => (
    <header>
        <h1>JavaScript Playground: meetups</h1>
        {user && <Navigation onLogout={onLogout} />}
    </header> );

Header.propTypes = {
    user: PropTypes.object,
    onLogout: PropTypes.func.isRequired,
}; 
```

Enter fullscreen mode Exit fullscreen mode

æˆ‘çš„ç”³è¯·ç›¸å¯¹ç®€å•ï¼Œå°†`user`ä½œä¸º**é“å…·**ä¼ é€’ç»™å­©å­ä»¬å¹¶ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„é—®é¢˜ã€‚

å‡è®¾æˆ‘æƒ³è®©æˆ‘çš„å¯¼èˆªæ æ›´æ¼‚äº®ï¼Œç”¨ä¸€ä¸ªçœŸæ­£çš„æ³¨é”€èœå•æ˜¾ç¤ºç”¨æˆ·çš„åå­—ã€‚æˆ‘å¿…é¡»å°†è¿™ä¸ª`user`ä¼ é€’ç»™`Navigation`ç»„ä»¶ã€‚

```
<Navigation onLogout={onLogout} user={user}/> 
```

Enter fullscreen mode Exit fullscreen mode

æ­¤å¤–ï¼Œå¦‚æœ`<UserMenu>`ç»„ä»¶ä½¿ç”¨å¦ä¸€ä¸ªç»„ä»¶æ¥æ˜¾ç¤ºç”¨æˆ·ï¼Œæˆ‘å°†ä¸å¾—ä¸å†æ¬¡ä¼ è¾“æˆ‘çš„ç”¨æˆ·:

```
const UserMenu = ({ onLogout, user }) => {
    <div>
        <DisplayUser user={user} />
        <UserSubMenu onLogout={onLogout} />
    </div> } 
```

Enter fullscreen mode Exit fullscreen mode

åœ¨æ˜¾ç¤ºä¹‹å‰ï¼Œ`user`å·²ç»é€šè¿‡äº† 4 ä¸ªç»„ä»¶...

æ›´å¤æ‚å’Œ/æˆ–æ›´ç¹é‡çš„åº”ç”¨ç¨‹åºå‘¢ï¼Ÿè¿™ä¼šå˜å¾—éå¸¸ç—›è‹¦ã€‚è¿™æ˜¯è¯¢é—® Redux çš„ä½¿ç”¨é—®é¢˜å˜å¾—åˆç†çš„æƒ…å†µä¹‹ä¸€ï¼

ç„¶è€Œï¼Œç°åœ¨æœ‰ä¸€ä¸ªç›´æ¥çš„è§£å†³æ–¹æ¡ˆå¯ä»¥å°†æ•°æ®ä»ä¸€ä¸ªç»„ä»¶ä¼ è¾“åˆ° React æ ‘ä¸­æ›´æ·±å±‚æ¬¡çš„å…¶ä»–ç»„ä»¶:React ä¸Šä¸‹æ–‡[**ã€‚**](https://reactjs.org/docs/context.html)

### ä½¿ç”¨ React ä¸Šä¸‹æ–‡ä¼ é€’çŠ¶æ€

`React.createContext`æ–¹æ³•ç”Ÿæˆä¸¤ä¸ªç»„ä»¶:

```
const {Provider, Consumer} = React.createContext(defaultValue); 
```

Enter fullscreen mode Exit fullscreen mode

*   ä¸€ä¸ª`Provider`è´Ÿè´£*åˆ†å‘*æ•°æ®ï¼Œ
*   èƒ½å¤Ÿè¯»å–æä¾›å•†æ•°æ®çš„ã€‚

è®©æˆ‘ä»¬å›åˆ°å‰é¢çš„ä¸‰ä¸ªç»„ä»¶ã€‚

```
// in App.js
import React, { Component } from 'react';
import { BrowserRouter as Router, Route, Switch } from 'react-router-dom';
import styled from 'styled-components';
import { decode } from 'jsonwebtoken';

...

const UserContext = React.createContext({
    user: null,
    onLogout: () => true,
});

export const UserConsumer = UserContext.Consumer;
const UserProvider = UserContext.Provider;

export class App extends Component {
    ...

    render() {
        const { user } = this.state;
        return (
            <UserProvider
                value={{
                    user,
                    onLogout: this.handleLogout,
                }}
            >
                <Router>
                    <Container>
                        <Header />
                        <Switch>
                            <PrivateRoute
                                exact
                                path="/"
                                render={({ location }) => (
                                    <Home location={location} />
                                )}
                            />
                        ... 
```

Enter fullscreen mode Exit fullscreen mode

```
// in PrivateRoute.js
import React from 'react';
import PropTypes from 'prop-types';
import { Redirect, Route } from 'react-router';

import { UserConsumer } from './App';

const PrivateRouteWithoutContext = ({ user, ...rest }) =>
    user ? (
        <Route {...rest} />
    ) : (
        <Redirect
            to={{
                pathname: '/login',
                state: { from: rest.location },
            }}
        />
    );

PrivateRouteWithoutContext.propTypes = {
    user: PropTypes.object,
};

export const PrivateRoute = props => {
    return (
        <UserConsumer>
            {({ user }) => (
                <PrivateRouteWithoutContext user={user} {...props} />
            )}
        </UserConsumer>
    );
}; 
```

Enter fullscreen mode Exit fullscreen mode

æ³¨æ„ï¼Œ`Consumer`ä½¿ç”¨äº†**æ¸²æŸ“é“å…·**æ¨¡å¼ã€‚

```
// in components/Header.js
import React from 'react';
import PropTypes from 'prop-types';

import { UserConsumer } from '../App';
import { Navigation } from './Navigation';

export const HeaderWithoutContext = ({ user, onLogout }) => (
    <header>
        <h1>JavaScript Playground: meetups</h1>
        {user && <Navigation onLogout={onLogout} />}
    </header> );

HeaderWithoutContext.propTypes = {
    user: PropTypes.object,
    onLogout: PropTypes.func.isRequired,
};

export const Header = () => {
    return (
        <UserConsumer>
            {({ user, onLogout }) => (
                <HeaderWithoutContext user={user} onLogout={onLogout} />
            )}
        </UserConsumer>
    );
}; 
```

Enter fullscreen mode Exit fullscreen mode

React Context æ˜¯å°†æ•°æ®ä»åº”ç”¨ç¨‹åºçš„ N çº§ç»„ä»¶ç›´æ¥ä¼ é€åˆ°ä»»ä½• N-x çº§å­ç»„ä»¶çš„ç®€å•æ–¹æ³•ã€‚

## é‚£ä¹ˆï¼ŒRedux è¿˜æ˜¯ä¸ Reduxï¼Ÿ

ä¸€æ—¦é¡¹ç›®è¾¾åˆ°ä¸€å®šçš„å¤æ‚ç¨‹åº¦ï¼ŒRedux å°±å˜å¾—æœ‰è¶£äº†ã€‚ç„¶è€Œï¼Œé¢„å…ˆåˆ¤æ–­ä»£ç çš„å¤æ‚ç¨‹åº¦å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼æˆ‘å–œæ¬¢æŠŠäº‹æƒ…ç®€å•åŒ–ï¼Œå¯¹è‡ªå·±è¯´:â€œå¤ªå¥½äº†ï¼ä¹‹åæˆ‘è¦åšä¸€ä¸ªå¤æ‚çš„ã€‚è¿™è®©æˆ‘æƒ³èµ·äº†å‡ å¹´å‰ï¼ŒSymfony è¢«ç³»ç»Ÿåœ°ç”¨æ¥å¯åŠ¨ä¸€ä¸ª PHP é¡¹ç›®ï¼Œè€Œ Silex è®©å®ƒä¸Šæ‰‹èµ·æ¥èˆ’æœå¤šäº†ï¼Œä¹Ÿå¿«å¤šäº†ã€‚

å°½ç®¡å¦‚æ­¤ï¼Œå°±åƒ Symfony ä¸€æ ·ï¼Œä½¿ç”¨ Redux å¯ä»¥æˆä¸ºä¸€ä¸ªéå¸¸æ˜æ™ºçš„é€‰æ‹©ã€‚

**åœ¨é¡¹ç›®å¼€å§‹æ—¶ä½¿ç”¨å®ƒåªæ˜¯ä¸€ä¸ªä¸æˆç†Ÿçš„å†³å®šã€‚**

è¿™ä¸æ˜¯ä»€ä¹ˆæ–°é²œæ–°é—»ğŸ˜„

> ä½ å¯èƒ½ä¸éœ€è¦ Reduxã€‚
> 
> â€” Dan Abramov ([@dan_abramov](https://dev.to/dan_abramov)) [19 septembre 2016](https://twitter.com/dan_abramov/status/777983404914671616)

æ­¤å¤–ï¼Œé™¤äº†è¿™äº›ç†è®ºä¸Šçš„è€ƒè™‘ï¼Œä¼¼ä¹è¿œç¦» Redux ä¹Ÿæœ‰ä¸€äº›æœ‰ç›Šçš„å½±å“ã€‚

é¦–å…ˆï¼Œæˆ‘æ›´å…³æ³¨ Reactï¼é€šè¿‡ç¼–å†™è¿™ç¯‡æ–‡ç« ä¸­çš„ç¬¬äºŒä¸ªä¾‹å­ï¼Œæˆ‘é‡æ–°å‘ç°äº†åªç”¨ç –å—æˆ–ç»„ä»¶æ„å»ºåº”ç”¨ç¨‹åºçš„ä¹è¶£:å°±åƒç©ä¹é«˜ä¸€æ ·ã€‚ä½¿ç”¨**æ¸²æŸ“å±æ€§**å…è®¸åœ¨æ•´ä¸ªé¡¹ç›®ä¸­é‡ç”¨ä»£ç ï¼ŒåŒæ—¶ä¿æŒåµŒå¥— React ç»„ä»¶çš„é€»è¾‘ã€‚è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¨¡å¼ï¼Œæ²¡æœ‰ [HOC](https://reactjs.org/docs/higher-order-components.html) é‚£ä¹ˆç¥å¥‡ã€‚å†è€…ï¼Œåˆ°æ—¶å€™ä¼šé€‚åº” Redux å¯èƒ½çš„å®ç°ã€‚è¿™æ–¹é¢çš„è¯æ®æ˜¯ [react-admin 2.0](https://marmelab.com/blog/2018/05/18/react-admin-2-0.html) ï¼Œå®ƒå°† [UI éƒ¨åˆ†](https://github.com/marmelab/react-admin/tree/master/packages/ra-ui-materialui)ä»[åº”ç”¨ç¨‹åºé€»è¾‘](https://github.com/marmelab/react-admin/tree/master/packages/ra-core)ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œè¿™è¦å½’åŠŸäºä¸€ä¸ªæ¸²æŸ“é“å…·ã€‚

æœ€åï¼Œè¿™ä¼¼ä¹æ˜¯ React å›¢é˜Ÿé‡‡å–çš„æ–¹å‘ã€‚æœ‰äº†æ–°çš„ **Context API** ï¼Œä»–ä»¬æä¾›äº†åœ¨ä¸é‡‡ç”¨ Redux çš„æƒ…å†µä¸‹å»ºç«‹ä¸€ä¸ªæ˜“äºå…±äº«çš„å…¨çƒå•†åº—çš„å¯èƒ½æ€§ã€‚