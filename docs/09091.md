# ä½¿ç”¨ OAuth2 å’Œ JWT çš„ NextJS å’Œè®¤è¯

> åŸæ–‡:[https://dev . to/whoisryosuke/nextjs-and-authentic ation-using-oauth 2-and-jwt-3gc 6](https://dev.to/whoisryosuke/nextjs-and-authentication-using-oauth2-and-jwt-3gc6)

æˆ‘ä»¬å°†ä½¿ç”¨ OAuth2 è¿‡ç¨‹é€šè¿‡æˆ‘ä»¬çš„ Laravel API æ¥è®¤è¯æˆ‘ä»¬çš„ NextJS åº”ç”¨ç¨‹åºç”¨æˆ·(æ„Ÿè°¢ Passport)ã€‚å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨ Laravelï¼Œè¿™ä¸ªè¿‡ç¨‹åœ¨æ¦‚å¿µä¸Šåº”è¯¥ä¸ Twitter ç­‰ç¬¬ä¸‰æ–¹ API éå¸¸ç›¸ä¼¼ã€‚

> æœ¬æŒ‡å—å‡è®¾æ‚¨å¯¹ React æœ‰æ‰€äº†è§£ï¼ŒçŸ¥é“ä»€ä¹ˆæ˜¯ HOC ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒï¼Œå¹¶ä¸”äº†è§£è¯¸å¦‚ NextJSã€Express æˆ– OAuth2 ä¹‹ç±»çš„åŸºç¡€çŸ¥è¯†ã€‚

## [](#how-it-works)å·¥ä½œåŸç†

å‡è®¾ä½ éœ€è¦ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œç”¨æˆ·å¯ä»¥ç™»å½•å¹¶è®¿é—®æ³¨å†Œç”¨æˆ·çš„ç§äººé¡µé¢ã€‚æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¥å—ç”¨æˆ·åå’Œå¯†ç çš„ç™»å½•è¡¨å•ï¼Œå¹¶å°†å…¶å‘é€ç»™ APIã€‚ä½†æ˜¯å¯¹äºæ¯ä¸ªä½ æƒ³è¦è®¤è¯çš„å°åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œè¦å†™å¾ˆå¤šä»£ç ã€‚è¿™å°±æ˜¯ OAuth2 çš„ç”¨æ­¦ä¹‹åœ°ã€‚

ä½¿ç”¨ OAuth2ï¼Œæˆ‘ä»¬å¯ä»¥è®©ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªç™»å½•é“¾æ¥ï¼Œæ¯”å¦‚â€œç”¨ Twitter ç™»å½•â€æŒ‰é’®ã€‚è¿™ä¼šå°†ç”¨æˆ·é‡å®šå‘åˆ° Twitterï¼Œåœ¨é‚£é‡Œä»–ä»¬ä½¿ç”¨è‡ªå·±çš„ Twitter å¸æˆ·ç™»å½•ï¼Œå¹¶æ¥å—æ‚¨çš„åº”ç”¨ç¨‹åºã€‚Twitter éšåä¼šå‘æ‚¨å‘é€ä¸€ä¸ªç‰¹æ®Šçš„â€œè®¿é—®ä»¤ç‰Œâ€ï¼Œå…è®¸æ‚¨ä»£è¡¨ç”¨æˆ·ä½¿ç”¨ Twitter APIã€‚

ç°åœ¨ä»£æ›¿ Twitterï¼Œæƒ³è±¡å®ƒæ˜¯ä½ è‡ªå·±çš„ APIã€‚ç”¨æˆ·è¢«å‘é€åˆ°æ‚¨åˆ›å»ºçš„ç™»å½•æœåŠ¡å™¨ï¼Œæ‚¨å°†è·å¾—ä¸€ä¸ªé€‚ç”¨äºæ‚¨è‡ªå·±çš„ API çš„è®¿é—®ä»¤ç‰Œã€‚è¿™æ ·ï¼Œä½ å¯ä»¥å…è®¸å¼€å‘è€…ä»¥ç”¨æˆ·èº«ä»½åˆ›å»ºä½¿ç”¨ä½ çš„ API çš„åº”ç”¨ï¼Œè€Œä¸æ˜¯ç›´æ¥è®¿é—®ã€‚è¿™æ ·ï¼Œæ‚¨å¯ä»¥æ ¹æ®æ‚¨è®¾ç½®çš„ç”¨æˆ·æƒé™æ¥é™åˆ¶ API è®¿é—®ã€‚

## [](#the-authentication-api)è®¤è¯ API

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªè®¤è¯ API æ¥ä½¿ç”¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨æˆ‘ä»¬çš„å‰ç«¯ NextJS åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å®ƒã€‚API å°†ä½¿ç”¨ OAuth2 åè®®ï¼Œå¹¶ä¸ºæ¯ä¸ªæˆæƒç”¨æˆ·è¿”å›ä¸€ä¸ª JSON Web ä»¤ç‰Œ(æˆ– JWT)ã€‚

### oauth 2 æµç¨‹

OAuth2 åˆçœ‹èµ·æ¥å¯èƒ½ä»¤äººç”Ÿç•ï¼Œä½†ç”±äºæ¯ä¸ªä¸»è¦å¹³å°(Twitterã€è„¸ä¹¦ã€è°·æ­Œå’Œæ— æ•°å…¶ä»–å¹³å°)éƒ½ä½¿ç”¨å®ƒæ¥è®¿é—® API çš„è®¤è¯éƒ¨åˆ†ï¼Œæ‚¨å¾ˆå¿«å°±ä¼šäº†è§£å®ƒã€‚é€šè¿‡æ‚¨çš„åº”ç”¨ç¨‹åºç™»å½•ç”¨æˆ·çš„è¿‡ç¨‹éå¸¸ç®€å•:

[![OAuth 2.0 Authentication Process with NextJS App](../Images/71810041b0fba55f27625bc8eccc2ef3.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--gCngy_Ol--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/http://whoisryosuke.com/static/OAuth2-Process.min-cad1af9f2e2fcbae4bb95cd96a966a6f-e2462.png)

1.  æ‚¨ç™»å½•åˆ°æƒ³è¦ç”¨äºèº«ä»½éªŒè¯çš„ APIï¼Œå¹¶ä½¿ç”¨å›è°ƒ URL åˆ›å»ºä¸€ä¸ªæ–°çš„ **"client"** ã€‚è¿™ä¸ªå›è°ƒ URL æ˜¯åº”ç”¨ç¨‹åºä¸Šçš„é¡µé¢ï¼ŒAPI åœ¨ç”¨æˆ·ç™»å½•åé‡å®šå‘ç”¨æˆ·ã€‚åœ¨ Twitter ä¸Šï¼Œè¿™æ˜¯â€œåº”ç”¨â€é¡µé¢å—ï¼Ÿ

> åˆ›å»º**â€œå®¢æˆ·ç«¯â€**ä¼šç”Ÿæˆä¸€ä¸ª API å®¢æˆ·ç«¯ ID å’Œå¯†ç ï¼Œæ‚¨å¯ä»¥ç”¨å®ƒæ¥é€šè¿‡ API éªŒè¯æ‚¨è‡ªå·±çš„åº”ç”¨ç¨‹åºã€‚ç•™ç€ä»¥åç”¨ã€‚ID æ˜¯å…¬å¼€çš„(ä»»ä½•äººéƒ½èƒ½çœ‹åˆ°)ï¼Œè€Œç§˜å¯†æ˜¯å—¯ï¼Œç§˜å¯†ã€‚ä½ æ°¸è¿œä¸ä¼šè®©ç”¨æˆ·çœ‹åˆ°æˆ–è®¿é—®ä½ çš„ç§˜å¯†ï¼Œå®ƒå­˜åœ¨äºæœåŠ¡å™¨ç«¯ä»£ç ä¸­ã€‚

1.  æ‚¨å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­åˆ›å»ºä¸€ä¸ªæŒ‰é’®ï¼Œæˆ–è€…å°†æ‚¨çš„ç”¨æˆ·é‡å®šå‘åˆ°ä¸€ä¸ªç‰¹å®šçš„ URLï¼Œè¯¥ URL åŒ…å«å¸¦æœ‰æ‚¨çš„å®¢æˆ·ç«¯ IDã€å›è°ƒ URL å’Œå“åº”ç±»å‹(é»˜è®¤ä¸ºâ€œcodeâ€)çš„æŸ¥è¯¢å‚æ•°ã€‚åº”è¯¥æ˜¯è¿™æ ·çš„:

[http://127 . 0 . 0 . 1/oauth/authorize/ï¼Ÿ* * client _ id **= 2&* * redirect _ uri * * = http://127 . 0 . 0 . 1:3000/token&* * response _ type * * =ä»£ç &* *èŒƒå›´* * =è®¿é—®ç”¨æˆ·å¸æˆ·](http://127.0.0.1/oauth/authorize/?**client_id**=2&**redirect_uri**=http://127.0.0.1:3000/token&**response_type**=code&**scope**=access-user-account)

> æœ‰æ—¶ï¼ŒURL çš„æŸ¥è¯¢å‚æ•°ä¸­ä¼šæ·»åŠ èŒƒå›´ï¼Œè¿™äº›å‚æ•°æ˜¯ç»™ä½ é¢å¤– API ç‰¹æƒçš„å…³é”®å­—ç¬¦ä¸²â€”â€”æ¯”å¦‚è®¿é—®ç”¨æˆ·ç”µå­é‚®ä»¶ã€‚

1.  ç”¨æˆ·è¢«é‡å®šå‘åˆ° APIï¼Œå¦‚æœä»–ä»¬æ²¡æœ‰ç™»å½•ï¼Œå°±ä¼šçœ‹åˆ°ä¸€ä¸ªç™»å½•å±å¹•ã€‚ä¸€æ—¦ä»–ä»¬ç™»å½•ï¼Œå°±ä¼šçœ‹åˆ°æ‚¨çš„åº”ç”¨ç¨‹åºçš„æˆæƒè¯·æ±‚ã€‚è¯¥è¯·æ±‚æ˜¯ä¸€ä¸ªçª—å£ï¼Œæ˜¾ç¤ºæ‚¨ä¹‹å‰è¾“å…¥çš„åº”ç”¨ç¨‹åºåç§°ï¼Œå¹¶è¯¢é—®ç”¨æˆ·æ˜¯å¦æ‰¹å‡†å®ƒä»£è¡¨ä»–ä»¬è®¿é—® APIã€‚å¦‚æœä½ æ›¾ç»ä½¿ç”¨ Twitter/è„¸ä¹¦/etc ç™»å½•è¿‡ä¸€ä¸ªç½‘ç«™ï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„ä¸œè¥¿ã€‚

2.  å¦‚æœç”¨æˆ·åŒæ„ï¼Œä»–ä»¬å°†è¢«é‡å®šå‘å›æ‚¨ä¹‹å‰åˆ›å»ºåº”ç”¨ç¨‹åºæ—¶ä½¿ç”¨çš„å›è°ƒ URLã€‚å½“ç”¨æˆ·è¢«é‡å®šå‘æ—¶ï¼Œä»–ä»¬ä¼šè¢«å‘é€ä¸€ä¸ªç‰¹æ®Šçš„ä»£ç ã€‚åœ¨åº”ç”¨ç¨‹åºçš„å›è°ƒé¡µé¢ä¸Šï¼Œæ‚¨è·å–è¿™æ®µä»£ç å¹¶å‘ API å‘å‡ºå¦ä¸€ä¸ªè¯·æ±‚ï¼Œè¯·æ±‚ä¸­åŒ…å«è¿™æ®µä»£ç å’Œæ‚¨çš„ç§˜å¯†ã€‚

3.  å¦‚æœ API æ‰¹å‡†äº†æ‚¨çš„è¯·æ±‚ï¼Œå®ƒä¼šå‘å›ä¸€ä¸ª JSON å“åº”ï¼Œå…¶ä¸­åŒ…å«ç”¨æˆ·çš„ä»¤ç‰Œå’Œå…¶ä»–ç›¸å…³æ•°æ®ã€‚é€šå¸¸æ‚¨ä¼šä»å“åº”ä¸­è·å–ä»¤ç‰Œï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ä¼šè¯æˆ– cookie ä¸­ä»¥å¤‡åç”¨(å› ä¸ºæ‚¨ä¼šç»å¸¸ç”¨åˆ°å®ƒï¼).

## [](#creating-the-api)åˆ›å»º API

æ—¢ç„¶æ‚¨å·²ç»äº†è§£äº†æˆ‘ä»¬æ­£åœ¨åˆ›å»ºä»€ä¹ˆæ ·çš„ APIï¼Œæˆ‘ä»¬å®é™…ä¸Šå°±å¯ä»¥å®ç°å®ƒäº†ã€‚

æˆ‘æœ‰ä¸€ä¸ªå…³äºä½¿ç”¨ Laravel å’Œ Passport åŒ…åˆ›å»ºå¿«é€Ÿè®¤è¯ API çš„æŒ‡å—ã€‚å°è¯•æ—‹è½¬é‚£ä¸ªé¡¹ç›®ï¼Œå¹¶ä¸è¿™ä¸ªé¡¹ç›®ä¸€èµ·ä½¿ç”¨ã€‚å®ƒå°†åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡ API è®¿é—®ç™»å½•ç”¨æˆ·å¹¶å–å›ä»¤ç‰Œã€‚

ä¸€æ—¦ API æœåŠ¡å™¨å¯åŠ¨å¹¶è¿è¡Œï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„åº”ç”¨ç¨‹åº:

`php artisan passport:client`

> å¦‚æœä½ åœ¨ Docker å®¹å™¨ä¸­(åƒæˆ‘çš„é¡¹ç›®ä½¿ç”¨çš„)ï¼Œç¡®ä¿ä½¿ç”¨ docker-compose `exec`å‘½ä»¤:`docker-compose exec workspace php artisan`

CLI å°†è¦æ±‚ä¸€ä¸ªåº”ç”¨ç¨‹åºåç§°ï¼Œå¹¶ä¸ºæ‚¨ç”Ÿæˆä¸€ä¸ªå®¢æˆ·ç«¯ ID å’Œå¯†ç ï¼Œå­˜å‚¨è¿™äº›ä¾›ä»¥åä½¿ç”¨ã€‚

> ç†æƒ³æƒ…å†µä¸‹ï¼Œæ‚¨åº”è¯¥åˆ›å»ºä¸€ä¸ªå‰ç«¯ UI æ¥ç”Ÿæˆè¿™äº› API å‡­è¯ï¼Œå¦‚æœæ‚¨éœ€è¦çš„è¯ï¼ŒLaravel ç¡®å®åœ¨ Vue ä¸­æä¾›äº†ä¸€ä¸ªç¤ºä¾‹ç‰ˆæœ¬ã€‚ä½†æ˜¯å¯¹äºæµ‹è¯•æˆ–æ›´ç®€å•çš„ç›®çš„ï¼ŒCLI å·¥ä½œå¾—å¾ˆå¥½ã€‚

### [](#alternatives-to-laravel)æ‹‰è…Šç»´å°”çš„æ›¿ä»£å“

æˆ‘çŸ¥é“ PHP æˆ– Laravel ä¸æ˜¯æ¯ä¸ªäººçš„å›Šä¸­ä¹‹ç‰©ï¼Œæˆ–è€…ä½ æ²¡æœ‰æ—¶é—´åœ¨ Heroku - **ä¸Šè¿è¡ŒæœåŠ¡å™¨ï¼Œä½ åªæ˜¯æƒ³è¦ä¸€ä¸ªæœ‰æ•ˆçš„ APIã€‚**

ä½ å¯ä»¥åˆ©ç”¨ Twitter æˆ– Slack è¿™æ ·çš„å…è´¹å¹³å°ï¼Œä½¿ç”¨ä»–ä»¬çš„â€œç™»å½•â€¦â€¦â€æœåŠ¡ã€‚ç„¶è€Œï¼Œå¦‚æœæ‚¨æƒ³è¦è·å–è‡ªå·±çš„ APIï¼Œæ‚¨å¯èƒ½ä»ç„¶éœ€è¦ä½¿ç”¨è‡ªå·±çš„è®¤è¯æœåŠ¡å™¨ã€‚å¦åˆ™ï¼Œä½¿ç”¨ Twitter ç™»å½•çš„å”¯ä¸€åŸå› æ˜¯é€šè¿‡æ‚¨çš„åº”ç”¨ç¨‹åºä»£è¡¨ç”¨æˆ·è®¿é—® Twitter APIã€‚

> é™¤äº†åˆ›å»ºè‡ªå·±çš„æˆ–ä½¿ç”¨ç¤¾äº¤åª’ä½“å¹³å°ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œå¦‚ [Auth0](http://auth0.com) æ¥åˆ©ç”¨ä»–ä»¬åŸºäºäº‘çš„è®¤è¯ APIã€‚åƒ [Netlify](http://netlify.com) è¿™æ ·çš„å¹³å°ä¹Ÿä¸ºä½ çš„é¡¹ç›®æä¾› JWT æ”¯æŒã€‚

## next js App

è¿™é‡Œæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œåªæ˜¯ä¸€ä¸ªæ–°é¡¹ç›®ï¼Œå¹¶è®©ä¸€äº›æ¨¡å—ã€‚å½“æˆ‘ä»¬ä½¿ç”¨å®ƒä»¬æ—¶ï¼Œæˆ‘ä¼šæ›´æ·±å…¥åœ°è§£é‡Šå®ƒä»¬:

`npm install react react-dom next express cookie-parser csurf dotenv isomorphic-unfetch js-cookie --save`

### [](#app-structure)App ç»“æ„

åº”ç”¨ç¨‹åºçš„ç»“æ„éå¸¸ç®€å•ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå‡ ç§ä¸åŒçš„æŠ€æœ¯æ¥æˆæƒæ‚¨çš„åº”ç”¨ç¨‹åº(æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯)ã€‚

1.  å°†ç”¨æˆ·é‡å®šå‘åˆ° API ç™»å½•çš„ç™»å½•é“¾æ¥æˆ–é¡µé¢ã€‚
2.  å›è°ƒé¡µé¢æ¥å— API çš„å“åº”ä»£ç ï¼Œå‘é€å¸¦æœ‰æˆ‘ä»¬çš„ç§˜å¯†çš„è¯·æ±‚ï¼Œæ¥æ”¶è®¿é—®ä»¤ç‰Œ(JWT)ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ã€‚
3.  ä¸€ä¸ªç”¨äºç§æœ‰é¡µé¢çš„ React é¡µé¢åŒ…è£…å™¨(æˆ– HOC ),å®ƒå°†æ£€æŸ¥ cookies ä¸­çš„ä»¤ç‰Œï¼Œå¦‚æœä¸æ£€æŸ¥ï¼Œå®ƒä»¬å°†è¢«é‡å®šå‘åˆ°å…¬å…±é¡µé¢(é€šå¸¸æ˜¯ç™»å½•)ã€‚

### [](#the-login-link)ç™»å½•é“¾æ¥

æˆ‘ä»¬éœ€è¦åœ¨åº”ç”¨ç¨‹åºçš„ä»»ä½•åœ°æ–¹åˆ›å»ºä¸€ä¸ªé“¾æ¥ï¼Œä½œä¸ºåº”ç”¨ç¨‹åºçš„â€œç™»å½•â€æŒ‰é’®ã€‚è¿™å°†æ˜¯ä¸€ä¸ªç®€å•çš„`<a>`å…ƒç´ ï¼Œé“¾æ¥åˆ°æˆ‘ä»¬çš„ Laravel API å’Œ/oauth/authorize/ endpoint(å‡è®¾æ˜¯ localhost):

`http://localhost/oauth/authorize/?client_id=4&redirect_uri=http://localhost:3000/token&response_type=code`

è¿™ä¸ªé“¾æ¥åŒ…å«æˆ‘ä»¬çš„**å®¢æˆ·ç«¯ id** ã€**é‡å®šå‘ uri** æˆ–å›è°ƒ URLï¼Œä»¥åŠä¸€ä¸ª**å“åº”ç±»å‹**ï¼Œå®ƒåº”è¯¥è¢«è®¾ç½®ä¸ºâ€œä»£ç â€ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ Laravel API åˆ›å»ºä¸€ä¸ªæ–°çš„ OAuth åº”ç”¨ç¨‹åºæ—¶ï¼Œ**å®¢æˆ·ç«¯ id** å’Œ **redirect_uri** ä¼šè¢«æä¾›ç»™æˆ‘ä»¬ã€‚é€šå¸¸ä½ ä¼šè®¾ç½®ä¸€ä¸ªå‰ç«¯è¡¨å•ï¼Œåƒ Twitter çš„å¼€å‘è€…éƒ¨åˆ†å’Œä»–ä»¬çš„è¡¨å•æ¥åˆ›å»ºæ–°çš„â€œåº”ç”¨â€æ¥äº¤æ¢ API å¯†é’¥ã€‚

> å¦‚æœä½ æƒ³ä½¿ç”¨ JSï¼Œç”šè‡³ PHP Artisan CLI åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ŒæŸ¥çœ‹ Laravel Passport æ–‡æ¡£ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚

### [](#create-callback-url)åˆ›å»ºå›è°ƒ URL

ä½¿ç”¨ Express æˆ–è€… NextJS çš„å®šåˆ¶æœåŠ¡å™¨è®¾ç½®ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªå›è°ƒè·¯ç”±ï¼ŒAPI å¯ä»¥æŸ¥è¯¢è¿™ä¸ªè·¯ç”±æ¥éªŒè¯æˆ‘ä»¬çš„å‡­è¯ã€‚è¿™æ˜¯ä¸€ä¸ªç›¸å½“ç®€å•çš„è¿‡ç¨‹:

1.  åˆ›å»ºä¸€ä¸ªè·å–è·¯å¾„ï¼Œå¹¶éšæ„å‘½åã€‚
2.  ç”¨æˆ‘ä»¬çš„å‡­è¯å’Œ API æœåŠ¡å™¨å‘é€çš„è¯·æ±‚ä»£ç å‘ API å‘å‡ºä¸€ä¸ª`fetch()`è¯·æ±‚ã€‚
3.  ä½¿ç”¨ cookie-parser å’Œ Express ( `res.cookies`)å°†ä»¤ç‰Œå­˜å‚¨åœ¨ cookie ä¸­ã€‚

ä¸‹é¢æ˜¯`server.js` :
ä¸­çš„æœ€åä¸€æ®µä»£ç 

```
// Callback for OAuth2 API
server.get('/token', (req, res) => {
    const callback = {
    grant_type: 'authorization_code',
    client_id: process.env.API_CLIENT_ID,
    client_secret: process.env.API_CLIENT_SECRET,
    redirect_uri: process.env.API_REDIRECT_URI,
    code: req.query.code
    }

    // Query API for token
    fetch('http://localhost/oauth/token', {
        method: 'post',
        headers: {
        'Content-Type': 'application/json'
        },
        body: JSON.stringify(callback)
    })
    .then(r => r.json())
    .then(data => jsonErrorCheck(data))
    .then(data => {
        // Store JWT from response in cookies
        res.cookie('kushyFToken', data.access_token, {
        maxAge: 900000,
        httpOnly: true
        });

        // store object in session (with express-session)
        // req.session.token = data.access_token

        return res.redirect('/dashboard')
    }); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> ä¸è¦å¿˜è®°ä½¿ç”¨`fetch()`çš„åŒæ„ç‰ˆæœ¬ï¼Œå› ä¸º Node æ²¡æœ‰å®‰è£…å®ƒã€‚

### [](#protecting-routes-grabbing-our-token-from-cookies)ä¿æŠ¤è·¯çº¿+ä» cookies ä¸­è·å–æˆ‘ä»¬çš„ä»¤ç‰Œ

ä¸ºäº†è®¿é—®æ¯ä¸ªè·¯ç”±ä¸­çš„ä»¤ç‰Œï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå¤šç”¨é€”çš„è‡ªç»„ç»‡ç½‘ç»œã€‚è¿™ä¸ªç‰¹è®¾å°†åŒ…è£…æˆ‘ä»¬çš„ç»„ä»¶ï¼Œåªæœ‰å½“æˆ‘ä»¬æœ‰ä¸€ä¸ªä»¤ç‰Œæ—¶æ‰è¿”å›å®ƒä»¬ï¼Œå¦åˆ™å®ƒå°†é‡å®šå‘ç”¨æˆ·ã€‚HOC çš„å·¥ä½œæ–¹å¼æ˜¯ä» cookie(æœåŠ¡å™¨æˆ–æµè§ˆå™¨ cookie)ä¸­è·å–æˆ‘ä»¬çš„ä»¤ç‰Œï¼Œå¦‚æœä»¤ç‰Œè¢«æ£€ç´¢åˆ°ï¼Œæˆ‘ä»¬åŒ…è£…çš„ç»„ä»¶å°±ä¼šè¢«åŠ è½½ã€‚

> åœ¨ç”Ÿäº§è®¾ç½®ä¸­ï¼Œæ‚¨åº”è¯¥åœ¨éœ€è¦æˆæƒé¡µé¢æ—¶éšæ—¶éªŒè¯ä»¤ç‰Œã€‚æ‚¨æ°¸è¿œä¸çŸ¥é“ç”¨æˆ·æ˜¯å¦ä¼ªé€ äº†ä»–ä»¬çš„ cookieï¼Œæ‰€ä»¥ä»…ä»…æ¥å—ä»¤ç‰Œæ˜¯ä¸å¤Ÿçš„â€”â€”ä»¤ç‰Œéœ€è¦å·¥ä½œã€‚ç”¨ä»¤ç‰Œå‘æˆ‘ä»¬çš„ API å‘å‡ºä¸€ä¸ªå¿«é€Ÿçš„`fetch()`è¯·æ±‚(é€šå¸¸åœ¨ç”¨æˆ·æ¦‚è¦ç«¯ç‚¹ä¸Šï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šæµªè´¹ API è°ƒç”¨å’Œè·å–ç›¸å…³æ•°æ®)ã€‚å¦‚æœè¯·æ±‚æœ‰æ•ˆï¼Œåˆ™ç”¨æˆ·è¢«æ‰¹å‡†ã€‚æ£€æŸ¥åï¼Œæ‚¨å¯ä»¥è®¾ç½®ä¸€ä¸ªæœåŠ¡å™¨ç«¯ cookie(ç”¨æˆ· ID çš„åŠ å¯†å“ˆå¸Œ+å½“å‰æ—¶é—´+åº”ç”¨ç¨‹åºå¯†ç )ï¼Œè®©åº”ç”¨ç¨‹åºçŸ¥é“ç”¨æˆ·æœ€è¿‘è·å¾—äº†æˆæƒã€‚

æˆ‘ä»¬è¿˜å°†åˆ©ç”¨ React çš„ä¸Šä¸‹æ–‡ APIï¼Œç”¨åŒ…å«æˆ‘ä»¬ä»¤ç‰Œçš„æä¾›è€…æ¥åŒ…è£…æˆ‘ä»¬æˆæƒçš„é¡µé¢ç»„ä»¶ã€‚è¿™æ ·ï¼Œæ‚¨å¯ä»¥å°†ä»»ä½•éœ€è¦è®¿é—®ç»è¿‡èº«ä»½éªŒè¯çš„ API è·¯ç”±çš„ç»„ä»¶åŒ…è£…åœ¨æ¶ˆè´¹è€…ä¸­ã€‚è¿™ä¸ªæ¶ˆè´¹è€…å°†ä»¤ç‰Œä¼ é€’ç»™ props ä¸­çš„ç»„ä»¶ã€‚

#### [](#but-what-about-production)ä½†æ˜¯ç”Ÿäº§å‘¢ï¼Ÿ

åœ¨ç”Ÿäº§ä¸­ï¼Œæœ€ä½³å®è·µæ˜¯æ°¸è¿œä¸è¦å‘ä»»ä½•äººå±•ç¤ºè®¿é—®ä»¤ç‰Œ(JWT)ã€‚ä½†æ˜¯ç”±äº OAuth2 ç›¸å½“å®‰å…¨çš„ç‰¹æ€§ï¼Œä»¥åŠè¿è¡Œç»è¿‡è®¤è¯çš„å®¢æˆ·ç«¯è¯·æ±‚çš„éœ€è¦ï¼Œå¼€å‘äººå‘˜ç»å¸¸åœ¨ cookies ä¸­æŠ›å‡ºæœªåŠ å¯†çš„ JWTï¼Œæˆ–è€…æ›´ç³Ÿçš„æ˜¯ï¼Œ`localStorage`ã€‚

ç†æƒ³æƒ…å†µä¸‹ï¼Œæ‚¨åº”è¯¥å°† JWT å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ä¼šè¯ä¸­ï¼Œå…¶ä¸­åŠ å¯†çš„ ID ä¿å­˜åœ¨ cookie ä¸­ï¼Œè€Œ JWT å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯æ•°æ®å­˜å‚¨ä¸­(å¦‚ Redis æˆ– Memcached)ã€‚æ¯å½“ä½ éœ€è¦ä»¤ç‰Œçš„æ—¶å€™ï¼Œä½ å¯ä»¥ç”¨åŠ å¯†çš„ cookie ID å’Œ CSRF ä»¤ç‰Œ(ç”±æœåŠ¡å™¨ç”Ÿæˆï¼Œä»¥ç¡®ä¿å®ƒæ¥è‡ªæœåŠ¡å™¨åˆ›å»ºçš„`<form>`-è€Œä¸æ˜¯éšæœºçš„ POST è¯·æ±‚)å‘åº”ç”¨çš„ Express æœåŠ¡å™¨å‘é€ POST è¯·æ±‚ã€‚Express æœåŠ¡å™¨æ£€æŸ¥æ•°æ®å­˜å‚¨ä¸­ cookie çš„ IDï¼Œè·å–ä»¤ç‰Œï¼Œå¹¶ä½¿ç”¨å®ƒæ¥å‘å‡º API è¯·æ±‚ï¼Œç„¶åè¿”å› API çš„å“åº”ã€‚

æ‚¨å¯ä»¥çœ‹åˆ°åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨å……å½“äº†â€œä¸­é—´äººâ€çš„è§’è‰²ï¼Œä»¥ç¡®ä¿å®¢æˆ·ç«¯å’Œ API ä¹‹é—´çš„å®‰å…¨ä¼ è¾“ã€‚è¿™æ ·ï¼Œæ²¡æœ‰äººå¯ä»¥é€šè¿‡åˆ›å»ºå¸¦æœ‰ä»¤ç‰Œçš„å‡ cookies æ¥å°è¯•ç™»å½•ã€‚ä»¤ç‰Œå¿…é¡»å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼Œå¹¶ä¸”å®ƒä»¬éœ€è¦é€‚å½“çš„å¯†é’¥æ¥è®¿é—®æ•°æ®å­˜å‚¨ä¸­å½“å‰çš„ä»»ä½•ä»¤ç‰Œã€‚å¦‚æœä½ æ„Ÿå…´è¶£ï¼Œæˆ‘åœ¨ä¸‹é¢ä»‹ç»äº†è¿™ä¸ªæ–¹æ³•ã€‚

### [](#authorization-hoc)æˆæƒç‰¹è®¾

å¯¹äº HOCï¼Œæˆ‘ä»¬åœ¨`getInitialProps()`ä¸­åŠ è½½åŒ…å«ä»¤ç‰Œçš„é“å…·ï¼Œä»¤ç‰Œæ˜¯ä» cookies ä¸­è·å–çš„ã€‚ç„¶åå½“ç»„ä»¶æŒ‚è½½æ—¶(`componentDidMount()`)ï¼Œæˆ‘ä»¬è¿è¡Œä¸€ä¸ªæ£€æŸ¥æ¥æŸ¥çœ‹ä»¤ç‰Œæ˜¯å¦åœ¨ props ä¸­ã€‚å¦‚æœæ²¡æœ‰ï¼Œæˆ‘ä»¬ä½¿ç”¨ Next çš„`Router`é‡å®šå‘åˆ°ç™»å½•é¡µé¢ã€‚å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªä»¤ç‰Œï¼Œæˆ‘ä»¬å°†åŠ è½½çŠ¶æ€è®¾ç½®ä¸º falseï¼Œè¿™å°†æ¿€æ´»å—ä¿æŠ¤è·¯ç”±çš„ç»„ä»¶(æˆ‘ä»¬åŒ…è£… auth HOC çš„ç»„ä»¶)ã€‚

> æ‚¨å¯ä»¥éšæ„ç”¨çœŸæ­£çš„åŠ è½½ç»„ä»¶æ›¿æ¢â€œåŠ è½½â€æ–‡æœ¬ï¼Œæˆ–è€…ç”¨åŠ è½½å™¨æ›¿æ¢é¡µé¢ã€‚

ç°åœ¨æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ cookies æ¥è·å–ä»¤ç‰Œï¼Œä½†æ˜¯æˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•åœ¨æœåŠ¡å™¨ç«¯ä¹Ÿè¿™æ ·åšï¼Œè¿™æ ·æ‚¨å°±å¯ä»¥çœ‹åˆ°ä¸ºä»€ä¹ˆå®ƒä¸æ˜¯æœ€ä½³é€‰æ‹©ã€‚

#### [](#server-side)æœåŠ¡å™¨ç«¯

åˆ›å»ºä¸€ä¸ªä¸­é—´ä»¶æŠ“å– cookie å¹¶å­˜å‚¨åœ¨`res.local.cookies`ä¸­ï¼Œç„¶ååœ¨æ¸²æŸ“æ¯æ¡è·¯çº¿æ—¶ä¼ å…¥ app:`return app.render(req, res, '/dashboard', { token: res.locals.token })`ã€‚

server.js

```
// A JSON error checking function since fetch()
// won't let us know if it failed or not
function jsonErrorCheck(data) {
  if('error' in data)
  {
    return error
  }
  return data
}

// The middleware
function getUser(req, res, next) {
  if (req.cookies['kushyFToken']) {
    const credentials = {
      method: 'get',
      headers: {
        'Authorization': 'Bearer ' + req.cookies['kushyFToken'],
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    }

    const fetchUser = async () => {
      await fetch('http://localhost/api/user/', credentials)
        .then(r => r.json())
        .then(data => jsonErrorCheck(data))
        .then(data => {
          res.locals.token = req.cookies['kushyFToken']
          res.locals.user = data
          next()        
        });
      }
      fetchUser();
  } else {
    next()
  }
}

// .... some other code

// Apply middleware to your route
// You basically stack middleware after the page string
// and before your page render 
// otherwise the middleware would never get called
server.get('/dashboard', getUser, (req, res) => {
    return app.render(req, res, '/dashboard', { token: res.locals.token, user: res.locals.user })
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
import React, {Component} from 'react'
import Router from 'next/router'

export default function withAuth(AuthComponent) {
    return class Authenticated extends Component {

      static async getInitialProps(ctx) {
        // Check if Page has a `getInitialProps`; if so, call it.
        const pageProps = AuthComponent.getInitialProps && await AuthComponent.getInitialProps(ctx);
        // Return props.
        return { 
          ...pageProps,
          token: ctx.query.token
          user: ctx.query.user
        }
      }

      constructor(props) {
        super(props)
        this.state = {
          isLoading: true,
        };
      }

      componentDidMount () {
        // Console logs for convenience
        // console.log('protected page, did we get token?:');
        // console.log(this.props.token);
        if (!this.props.token) {
          Router.push('/login')
        }
        this.setState({ isLoading: false })
      }

      render() {
        return (
          <div>
          {this.state.isLoading ? (
              <div>LOADING....</div>
            ) : (
                // We don't need to explicitly pass token or user as props here
                // because {...this.props} includes them (ES6 destructuring ftw)
              <AuthComponent {...this.props}  auth={Auth} />
            )}
          </div>
        )
      }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å¾ˆç¹çï¼Œå› ä¸ºå®ƒè¦æ±‚æ‚¨å°†ä»¤ç‰Œæ”¾åœ¨æ¯ä¸ªè¯·æ±‚ä¸­ã€‚å¦‚æœä¸€ä¸ªé¡µé¢åŠ è½½å®¢æˆ·ç«¯ï¼Œè€Œä¸å‘å‡ºæœåŠ¡å™¨è¯·æ±‚ï¼Œæˆ‘ä»¬å°±æ— æ³•è®¿é—®åŒ…å«æˆ‘ä»¬ä»¤ç‰Œçš„`ctx`å˜é‡ã€‚

æ‰€ä»¥**æˆ‘ä»¬è¢«è¿«ä½¿ç”¨å®¢æˆ·ç«¯æ•°æ®å­˜å‚¨**ï¼Œæœ€å¥½æ˜¯åƒ **cookies** æˆ– IndexDB è¿™æ ·çš„å®‰å…¨å­˜å‚¨ã€‚

#### [](#using-cookies)ä½¿ç”¨ Cookies

å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†ç”¨äº Express çš„ [cookie-parser](https://www.npmjs.com/package/cookie-parser) ä¸­é—´ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤„äº`getInitialProps`çŠ¶æ€çš„`req`å˜é‡:`ctx.req.headers.cookie`æ¥è®¿é—® cookie æœåŠ¡å™¨ç«¯ã€‚è¿™å°†è¿”å›ä¸€ä¸ªå·¨å¤§çš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«ç”±&ç¬¦å·åˆ†éš”çš„æ‰€æœ‰ cookies(æ¯”å¦‚æŸ¥è¯¢å‚æ•°)ã€‚å¦‚æœæˆ‘ä»¬è§£æå­—ç¬¦ä¸²å¹¶é€šè¿‡é”®åæ‰¾åˆ° cookieï¼Œæˆ‘ä»¬å°±æœ‰äº† cookieã€‚

æˆ–è€…ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­(å°±åƒç”¨æˆ·åœ¨åº”ç”¨ç¨‹åºä¸­ç‚¹å‡»ä¸€ä¸ªå†…éƒ¨çš„`<Link />`ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [js-cookie](https://github.com/js-cookie/js-cookie) åº“ä»å®¢æˆ·ç«¯è·å– cookie(`cookie.get('token')`)ã€‚

> æˆ‘ä½¿ç”¨åŠ©æ‰‹å‡½æ•°ä½¿è®¿é—® cookies å˜å¾—æ›´å®¹æ˜“(ä» Github ä¸Šçš„@carlos-peru å·æ¥çš„[)ã€‚å®ƒåŸºæœ¬ä¸Šæ˜¯ js-cookie çš„åŒ…è£…å™¨ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯æœåŠ¡å™¨ç«¯è¿˜æ˜¯å®¢æˆ·ç«¯ã€‚å¦‚æœå®ƒä»¬æ˜¯æœåŠ¡å™¨ç«¯çš„ï¼Œå®ƒä¼šåœ¨`req`å˜é‡ä¸­æœç´¢æˆ‘ä»¬çš„ cookie åç§°ã€‚å¦‚æœæ˜¯å®¢æˆ·ç«¯ï¼Œå°±ç”¨ js-cookieã€‚](https://github.com/carlos-peru/next-with-api/blob/master/lib/session.js)

utils/Cookies.js

```
import cookie from "js-cookie";

export const setCookie = (key, value) => {
    if (process.browser) {
        cookie.set(key, value, {
            expires: 1,
            path: "/"
        });
    }
};

export const removeCookie = key => {
    if (process.browser) {
        cookie.remove(key, {
            expires: 1
        });
    }
};

export const getCookie = (key, req) => {
    return process.browser ?
        getCookieFromBrowser(key) :
        getCookieFromServer(key, req);
};

const getCookieFromBrowser = key => {
    console.log('grabbing key from browser')
    return cookie.get(key);
};

const getCookieFromServer = (key, req) => {
    console.log('grabbing key from server')
    if (!req.headers.cookie) {
        return undefined;
    }
    const rawCookie = req.headers.cookie
        .split(";")
        .find(c => c.trim().startsWith(`${key}=`));
    if (!rawCookie) {
        return undefined;
    }
    return rawCookie.split("=")[1];
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

withAuth.js

```
import React, {Component} from 'react'
import Router from 'next/router'
import TokenContext from '../context/TokenContext'
import { getCookie } from '../utils/Cookies'

export default function withAuth(AuthComponent) {
    return class Authenticated extends Component {

      static async getInitialProps(ctx) {
        const token = getCookie('kushyFToken', ctx.req)
        // Check if Page has a `getInitialProps`; if so, call it.
        const pageProps = AuthComponent.getInitialProps && await AuthComponent.getInitialProps(ctx);
        // Return props.
        return { ...pageProps, token }
      }

      constructor(props) {
        super(props)
        this.state = {
          isLoading: true
        };
      }

      componentDidMount () {
        console.log('checking auth')
        if (!this.props.token) {
          Router.push('/')
        }
        this.setState({ isLoading: false })
      }

      render() {
        return (
          <div>
          {this.state.isLoading ? (
              <div>LOADING....</div>
            ) : (
              <TokenContext.Provider value={this.props.token}>
                <AuthComponent {...this.props} />
              </TokenContext.Provider>
            )}
          </div>
        )
      }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ˜¯ä¸€ä¸ªæ›´å¥½çš„æ–¹æ³•ï¼Œå› ä¸ºæ‚¨è·å¾—äº†æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ cookies çš„å®‰å…¨æ€§ã€‚

> Protip:æ‚¨å¯èƒ½å¸Œæœ›åˆ©ç”¨ä¸Šä¸‹æ–‡ APIï¼Œå°†æˆæƒç»„ä»¶åŒ…è£…åœ¨å¸¦æœ‰ä»¤ç‰Œæ•°æ®çš„æä¾›è€…ä¸­ï¼Œè¿™æ ·åº”ç”¨ç¨‹åºçš„ä»»ä½•éƒ¨åˆ†éƒ½å¯ä»¥è½»æ¾è®¿é—®ä»¤ç‰Œï¼Œè€Œæ— éœ€è¿›è¡Œä»»ä½•é“å…·æ¼”ç»ƒï¼æ‚¨çš„å¦ä¸€ä¸ªé€‰æ‹©æ˜¯ä½¿ç”¨ Cookies åŠ©æ‰‹/å®ç”¨ç¨‹åºå‡½æ•°ï¼Œå¹¶åœ¨æ‚¨éœ€è¦çš„ä»»ä½•ç»„ä»¶ä¸­å†æ¬¡è·å– cookieï¼Œå¦‚ä¸Šæ‰€ç¤ºã€‚*æˆ–è€…ä½ çŸ¥é“ï¼ŒReduxã€‚*

### [](#secret-3rd-option-api-endpoints)ç§˜å¯†ç¬¬ä¸‰é€‰é¡¹:API ç«¯ç‚¹

æ—¢ç„¶æˆ‘ä»¬ä½¿ç”¨ Express æ¥åˆ›å»ºè·¯ç”±ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥è®¿é—®æœåŠ¡å™¨æ¥è¿è¡Œ Javascriptï¼Œé‚£ä¹ˆæˆ‘ä»¬æ²¡æœ‰ç†ç”±ä¸èƒ½åˆ›å»ºä¸€ä¸ªåŠ¨æ€è·¯ç”±æ¥å……å½“å¤–éƒ¨ API çš„ä¸­é—´äººã€‚æ‚¨å¯ä»¥ä»åŠ¨æ€è·¯ç”±(`app.render('/api/:endpoint', callback)`)ä¸­è·å– API ç«¯ç‚¹ï¼Œå¹¶ä½¿ç”¨å®ƒ(`req.params.endpoint`)å‘é€ä¸€ä¸ªç»è¿‡èº«ä»½éªŒè¯çš„ API è¯·æ±‚ï¼Œå…¶ä¸­åŒ…å«æˆ‘ä»¬ä¹‹å‰è·å¾—çš„ cookie(`req.cookies['seshToken']`)ã€‚

```
// Route for sending POST requests
server.post('/api/:endpoint', (req, res) => {

    // Query protected API endpoint with token
    fetch(`http://localhost/api/${req.params.endpoint}`, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
        'Authorization': `Bearer ${req.cookies['seshToken']}`
    },
    // Grabs request body (ideally Form data), converts to JSON, and sends it as POST
    body: JSON.stringify(req.query)
    })
});

// Route for sending authenticated GET requests
server.get('/api/:endpoint', (req, res) => {

    // Query protected API endpoint with token
    fetch(`http://localhost/api/${req.params.endpoint}`, {
    method: 'GET',
    headers: {
        'Content-Type': 'application/json'
        'Authorization': `Bearer ${req.cookies['seshToken']}`
    }
    })
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ ·ï¼Œå®¢æˆ·æœºå°±æ°¸è¿œä¸ä¼šæš´éœ²ç»™æºä»£ç ä¸­çš„ä»¤ç‰Œ(åªæœ‰å½“å®ƒä»¬æ£€æŸ¥å®ƒä»¬çš„ cookies æ—¶)ã€‚è¿™æ˜¯ä¸ä¼šè¯(ä¾‹å¦‚å¿«é€Ÿä¼šè¯)é…å¯¹æ—¶çš„**æœ€ä½³æƒ…å†µåœºæ™¯**ã€‚å°½ç®¡å®ƒé™åˆ¶äº†æ‚¨åœ¨æœåŠ¡å™¨ç«¯ä½¿ç”¨ NextJSï¼Œå¹¶ä¸”**è¦æ±‚æ‚¨åœ¨äº§å“ä¸­æœ‰ä¸€ä¸ªæ•°æ®å­˜å‚¨(åƒ Redis)** ã€‚

## [](#hoc-vs-functional-programming)HOC vs å‡½æ•°å¼ç¼–ç¨‹

ç‰¹è®¾çœ‹èµ·æ¥åƒè¿‡åº¦æ€ä¼¤å—ï¼Ÿä½ æƒ³è¦æ›´å®ç”¨çš„ä¸œè¥¿å—ï¼Ÿæ‚¨å¯ä»¥åœ¨é¡µé¢çš„`getInitialProps()`ä¸­æ·»åŠ ä¸€ç§â€œä¸­é—´ä»¶â€,æ£€æŸ¥ cookies ä¸­çš„ä»¤ç‰Œï¼Œå¹¶åœ¨ false æ—¶é‡å®šå‘ï¼Œè€Œä¸æ˜¯åƒæˆ‘ä»¬ä¹‹å‰é‚£æ ·å°†ç»„ä»¶åŒ…è£…åœ¨ auth HOC ä¸­ã€‚

æ‚¨çš„é¡µé¢ç»„ä»¶:

```
static async getInitialProps(ctx) { 
  // If it does not exist session, it gets redirected
  if (redirectIfNotAuthenticated(ctx)) {
    return {}; 
  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»¥åŠâ€œä¸­é—´ä»¶â€èƒŒåçš„é­”åŠ›:

```
export const getJwt = ctx => {
  return getCookie("jwt", ctx.req);
};

export const isAuthenticated = ctx => !!getJwt(ctx);

export const redirectIfAuthenticated = ctx => {
  if (isAuthenticated(ctx)) {
    redirect("/user", ctx);
    return true;
  }
  return false;
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™åŸºæœ¬ä¸Šå°±æ˜¯æˆ‘ä»¬åœ¨ HOC ä¸­æ‰€åšçš„äº‹æƒ…ï¼Œä½†æ˜¯è¢«åˆ†è§£æˆä¸åŒçš„åŠŸèƒ½ã€‚æ›´åƒæ˜¯åŒä¸€è§£å†³æ–¹æ¡ˆçš„åŠŸèƒ½æ–¹æ³•ã€‚

## [](#to-redux-or-not)è¦ä¸è¦ Reduxï¼Ÿ

**ä»æŠ€æœ¯ä¸Šæ¥è¯´ï¼Œä½ ä¸éœ€è¦ Redux** ï¼Œå› ä¸ºä½ å¯ä»¥ä½¿ç”¨ js-cookie ä»å®¢æˆ·ç«¯è®¿é—® cookieï¼Œæˆ–è€…å°†ä½ çš„åº”ç”¨åŒ…è£…åœ¨ä¸€ä¸ªä»¤ç‰Œæä¾›è€…ä¸­ã€‚ä½†æ˜¯æˆ‘å‘ç°ï¼Œå½“æˆ‘éœ€è¦å¼€å§‹ç®¡ç†æˆ‘çš„åº”ç”¨ç¨‹åºä¸­æ›´å¤æ‚çš„çŠ¶æ€æ—¶ï¼Œæˆ‘å¼€å§‹ä½¿ç”¨ Reduxï¼Œç‰¹åˆ«æ˜¯**æŒä¹…çŠ¶æ€**ã€‚ä½ å¯ä»¥æ•´å¤©ä½¿ç”¨ä¸Šä¸‹æ–‡ APIï¼Œä½†æ˜¯å¦‚æœä½ ä¸ä»`localStorage`å†™ä¸€ä¸ªå›é€€å’Œæ£€ç´¢ç³»ç»Ÿï¼Œä½ çš„åº”ç”¨ç¨‹åºçš„çŠ¶æ€å°†åœ¨æ¯æ¬¡åˆ·æ–°æ—¶è¢«æ¸…é™¤ã€‚è¿™éœ€è¦åŠ¨æ€æ•°æ®è¯·æ±‚å†æ¬¡è¿è¡Œï¼Œ*å†æ¬¡è¿è¡Œ*ã€**ã€*å†æ¬¡è¿è¡Œ*ã€**ã€‚

### [](#data-peristence)æ•°æ®æ¶ˆå¤±

ä½¿ç”¨ Redux è·å–æ•°æ®å¹¶å°†ç»“æœå­˜å‚¨åœ¨åº”ç”¨ç¨‹åºçš„çŠ¶æ€ä¸­å…è®¸æ›´å¤šçš„æ•°æ®æŒä¹…æ€§ï¼Œç‰¹åˆ«æ˜¯åœ¨åƒ NextJS è¿™æ ·çš„é€šç”¨åº”ç”¨ç¨‹åºä¸­ï¼Œå®ƒè¿è¡Œé¢‘ç¹çš„æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯è¯·æ±‚ã€‚å¦‚æœä½ çš„åº”ç”¨åªæ˜¯å®¢æˆ·ç«¯çš„(æ¯”å¦‚ SPA)ï¼ŒRedux å¯èƒ½æ˜¯å¾®ä¸è¶³é“çš„ï¼Œå› ä¸ºä½ çš„ç”¨æˆ·å¾ˆå°‘ä¼šâ€œç¡¬â€é‡æ–°åŠ è½½é¡µé¢ã€‚ä½†æ˜¯ç”±äºä¸€äº› NextJS è·¯ç”±åŠ è½½æœåŠ¡å™¨ç«¯ï¼Œå®ƒåˆ·æ–°ä½ çš„åº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼Œè¦æ±‚ä½ çš„ä¸Šä¸‹æ–‡æä¾›è€…å†æ¬¡è®¿é—® APIã€‚

ä½†æ˜¯å°±åƒæˆ‘è¯´çš„ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸Šä¸‹æ–‡æä¾›è€…å°†æ‚¨çš„çŠ¶æ€æŒä¹…åŒ–åˆ°`localStorage`ï¼Œæˆ–è€…å¦ä¸€ä¸ªæœ¬åœ°æ•°æ®å­˜å‚¨ï¼Œå¹¶ä½¿ç”¨æ¶ˆè´¹è€…åœ¨æ‚¨å†æ¬¡éœ€è¦å®ƒæ—¶è·å–å®ƒã€‚

### [](#complex-data-management)å¤æ‚æ•°æ®ç®¡ç†

æƒ³è±¡ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œå…¶ä¸­çš„ç»„ä»¶éœ€è¦è®¿é—®æ¥è‡ªæä¾›å•†çš„ 3 ä¸ª(æˆ–æ›´å¤š)ä¸åŒçš„å€¼ã€‚æ¯æ¬¡åˆ›å»ºä¸€ä¸ªç»„ä»¶ï¼Œä½ éƒ½éœ€è¦åœ¨ç»„ä»¶å‘¨å›´åŒ…è£… 3 ä¸ªä»¥ä¸Šçš„æ¶ˆè´¹è€…ï¼Œå¹¶é€‚å½“åœ°å‘ä¸‹é’»å–é“å…·(æˆ–è€…[åˆ›å»ºä¸€ä¸ª HOC æ¥å°†å®ƒä»¬ç»„åˆæˆé“å…·](https://www.npmjs.com/package/react-context-consumer-hoc))ã€‚

```
// Impractical code that doesn't work
const SomeComponent = () => (
    <ThemeContext.Consumer>
        { theme => 
            <TokenContext.Consumer theme={theme}>
                { token => 
                    ...etc
                }
            </TokenContext.Consumer>
        }
    </ThemeContext.Consumer> ) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½¿ç”¨ Reduxï¼Œæ‚¨å¯ä»¥ä¸ºç»„ä»¶åˆ›å»ºä¸€ä¸ªå®¹å™¨ç»„ä»¶ã€‚å®¹å™¨å°†ç»„ä»¶è¿æ¥åˆ° Redux å­˜å‚¨ï¼Œå¹¶å‘é€æ‚¨éœ€è¦çš„ä»»ä½•çŠ¶æ€å€¼ä½œä¸ºé“å…·ã€‚ä¸€æ—¦è¿æ¥ä¸Šï¼Œç»„ä»¶å°±å¯ä»¥è®¿é—®æ‚¨å®šä¹‰çš„å­˜å‚¨ä¸­çš„ä»»ä½•å†…å®¹ã€‚

### [](#soredux)å¦‚æ­¤...Reduxï¼Ÿ

æ²¡æœ‰ Reduxã€*å’Œ*ä½ ä¼šæƒŠè®¶è‡ªå·±èƒ½èµ°å¤šè¿œï¼Œè¿™ä¸€åˆ‡éƒ½æ˜¯ä¸ºäº†è®©*çš„æ—…ç¨‹æ›´å¹³ç¨³*ã€‚åšä½ è®¤ä¸ºæœ€é€‚åˆä½ çš„åº”ç”¨çš„äº‹æƒ…ã€‚[*Redux åˆ›å»ºè€…çš„å¼ºåˆ¶é“¾æ¥ï¼Œè¡¨ç¤ºä½ å¯èƒ½ä¸éœ€è¦å®ƒ*](https://medium.com/@dan_abramov/you-might-not-need-redux-be46360cf367)

## [](#simple-as-that)å°±è¿™ä¹ˆç®€å•

ç”±äº NextJS èƒ½å¤Ÿæ‰§è¡ŒæœåŠ¡å™¨ç«¯ä»»åŠ¡â€”â€”ç”šè‡³å¯ä»¥åˆ©ç”¨ Express ä¹‹ç±»çš„å…¶ä»–æ¡†æ¶â€”â€”è¿™ä½¿å¾—é€šè¿‡ OAuth2 ç”¨å¿…è¦çš„è·¯å¾„æ‰©å±•å‰ç«¯åº”ç”¨ç¨‹åºå˜å¾—éå¸¸ç®€å•ã€‚æœ¬æ•™ç¨‹ä½¿ç”¨ Laravel API ä½œä¸ºç¤ºä¾‹ï¼Œä½†æ˜¯å®ç°å…¶ä»–åŸºäº OAuth2 çš„ API(å¦‚ Twitter)çš„ä»£ç éå¸¸ç›¸ä¼¼ã€‚

å¦‚æœæˆ‘çš„æŒ‡å—ä»¤äººå›°æƒ‘ï¼Œæˆ‘å»ºè®®çœ‹ä¸€ä¸‹æ¥è‡ª NextJS ä¼šè®®çš„è§†é¢‘[,å®ƒåœ¨ 15 åˆ†é’Ÿå†…è§£é‡Šäº† NextJS ç”¨æˆ·è®¤è¯è¿‡ç¨‹ã€‚](https://www.youtube.com/watch?v=bo4BbGwZsWo)

[åœ¨è¿™é‡Œä¸‹è½½ Github ä¸Šçš„é¡¹ç›®](https://github.com/whoisryosuke/nextjs-oauth2-cookie-auth)

åæ´¾ğŸ»
è‰¯

* * *

**å‚è€ƒæ–‡çŒ®**:

*   [Prosper Otemuyiwa:next . js ä¸­çš„è®¤è¯å’Œæˆæƒ](https://www.youtube.com/watch?v=bo4BbGwZsWo)
*   [åŠ å¯†æ‚¨çš„ cookie](http://blog.teamtreehouse.com/encrypting-cookies-in-the-browser)
*   [js-cookie](https://github.com/js-cookie/js-cookie)
*   [Cookies åŠ©æ‰‹åŠŸèƒ½](https://github.com/carlos-peru/next-with-api/blob/master/lib/session.js)
*   [ä¸º getInitialProps åˆ›å»ºè®¤è¯ä¸­é—´ä»¶](https://medium.com/@positivecarlos/authentication-on-universal-react-with-next-js-b441ef458046)
*   [OAuth 2.0 -å®˜æ–¹](https://oauth.net/2/)