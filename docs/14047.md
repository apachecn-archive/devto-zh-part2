# Reddit 系统管理员 AMA 2013 年的笔记

> 原文:[https://dev . to/韩嫣/notes-from-a-Reddit-sysadmins-ama-in-2013-b64](https://dev.to/yanhan/notes-from-a-reddit-sysadmins-ama-in-2013-b64)

来源:[https://www . Reddit . com/r/sysadmin/comments/r6zfv/we _ are _ sysadmins _ Reddit _ ask _ us _ any/](https://www.reddit.com/r/sysadmin/comments/r6zfv/we_are_sysadmins_reddit_ask_us_anything/)

也可从以下网址获得:[https://github . com/韩嫣/notes/blob/master/Reddit-sysadmins-ama . MD](https://github.com/yanhan/notes/blob/master/reddit-sysadmins-ama.md)

不久前，我偶然发现了这个 Reddit AMA，想记下一些我在那里读到的更有趣的东西。今天终于开始做这件事了。

## 统计数据

*   峰值带宽:924.21 兆比特/秒。他们大量使用阿卡迈
*   数据库的总大小:2.4TB。似乎每周增长几 GB
*   在负载平衡器上:大约 8K 已建立的连接，大约 250K 等待时间(等待超时非常短)

## 他们用什么

*   阿卡迈
*   AWS (284 个运行实例，161 个是应用服务器)
*   木偶
*   [神经节](http://ganglia.sourceforge.net/)
*   齐诺斯
*   兔子 q
*   MCollective
*   中央 memcached 服务器(带有 pylibmc)。每个应用服务器都有小的 memcached 实例，用于不能承受网络延迟的本地缓存
*   rsyslog
*   日志整合:带有 RELP 模块的 rsyslog
*   Hadoop(用于内部数据仓库)

## 有趣的东西

*   他们在 EC2 实例上使用 HAProxy，而不是 ELB。总共 8 个实例
    *   ELB 是 HAProxy 与 API。对 ELB 实例大小的有限控制。最初设置为非常小的实例
    *   ELB 负载平衡是通过循环 DNS 完成的。当其中一个后台实例崩溃时，互联网上任何缓存的 DNS 都会崩溃。许多设备/软件/ISP 仍然不正确地缓存 DNS
    *   如果 ELB 有这些，那就有用了:
    *   静态 VIP 支持。仅仅循环 DNS 是不可接受的
    *   支持 ELB 的对实例大小的粒度控制
    *   负载平衡中的更多规则功能。与 HAProxy 相比非常有限
*   有一段时间，Postgres 复制问题经常导致网站瘫痪。
    *   这些都是由于 EBS 故障造成的。他们必须登录并立即开始解决复制问题，以防止真正严重的损坏
    *   升级到 Postgres 9 和脱离 EBS 解决了这个问题
*   当他们在 SOPA 抗议期间关闭 Reddit 时，他们不得不准备承受巨大的即时负载，因为每个人都知道该网站将重新上线
    *   因此它们不能做任何导致缓存层被清除的事情。否则，当网站重新上线时，它将彻底失败
*   负载测试:用户
    *   他们没有可以复制用户流量的负载测试基础设施
    *   在他们工作过的每个地方，最困难的问题之一是正确地模拟负载。对于像 reddit 这样的动态服务，开发一个合适的负载模拟器需要做很多工作
*   未登录的流量点击 Akamai 的缓存
*   安全焦点:确保坏人不能进入应用程序做坏事。因为他们只托管网络，所以 infra 有很少数量的载体处于良好的安全控制之下
    *   最常见的攻击:人们试图通过一次又一次地抓取一个网址来“拒绝服务”
*   对于异步的东西，使用 RabbitMQ。例如:
    *   投票
    *   注释树重新计算
    *   新评论
    *   拇指指甲
    *   搜索引擎更新
*   IPv6: Akamai 支持它，并减轻了他们的负担
*   他们密切关注谷歌分析的基础设施和实时统计的请求率
*   最糟糕的停机时间:[https://Reddit blog . com/2011/03/17/why-Reddit 在过去 24 小时内停机 6 小时/](https://redditblog.com/2011/03/17/why-reddit-was-down-for-6-of-the-last-24-hours/)
*   最愚蠢的停机时间:`iptables -t nat -L`检查主负载平衡器上的规则。这将加载所有 iptables 模块，包括 conntrack。Conntrack 表立即填满，并使站点停止运行几秒钟
*   根据需要修补服务器。他们订阅所有安全警报通知列表
*   备份策略:加密并发送到 S3。还有一个备份 Postgres 服务器，来自每个数据库集群的所有内容都被写入其中(以满足更多实时备份需求)

## 挑战

*   从零开始做很多事情
*   瓶颈不断出现。解决一个瓶颈，增加的吞吐量会引入多个新的瓶颈
*   无法接触 memcached 盒。重新加热它们会非常痛苦
    *   以他们的规模，他们必须尽可能地大量使用缓存。因此，关闭一切并重新启动一切是一个痛苦的过程
    *   需要设计一种干净的方法来重新加热缓存，而不需要用户访问网站
    *   一种想法是针对前端主机重放访问日志
    *   另一个想法是发送越来越多的真实流量。比方说，每四个请求中就有一个到达了维护页面之外的其他地方

## 建议

*   花很多时间在自己的东西上。例如，建立一个网络/数据库服务器只是为了好玩。
    *   打破东西，重建它，重复
    *   找到你能在家庭服务器上做的每一件有趣的事情，并尝试一下。即使你永远不会亲自使用它。
    *   如果有什么东西坏了或者没有意义，不要放弃它，直到你真正明白发生了什么
    *   不惜一切代价避免采取任何货物崇拜心态
    *   如果这听起来像一个极端无聊，重新考虑系统管理员的愿望
*   证书可以帮助你获得一些公司的面试机会，并在目前的工作场所获得晋升
    *   但是他们大多表现出对一个系统的肤浅理解
    *   如果你已经对一个系统了如指掌，花一点时间去获得一个证书是没有坏处的

## 裸机 vs .云

*   Bare metal:
    *   负载平衡器和数据库服务器将受益于裸机
    *   优点:可以尝试新硬件
*   云:
    *   应用服务器将受益于云计算
    *   优点:很高兴不必担心诸如网络基础设施、安装新硬件、订购新硬件、机架电源等问题

## 自己犯的错误

*   所有东西过去都在一个安全组中

## 他们在做什么

*   自动化大多数基础架构任务，例如构建新服务器
*   让网站在多个地区运行。需要在整个堆栈中进行大量工作的大型项目