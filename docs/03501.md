# è®©æˆ‘ä»¬æ„å»º Web ç»„ä»¶ï¼ç¬¬ 3 éƒ¨åˆ†:æ™®é€šç»„ä»¶

> åŸæ–‡:[https://dev . to/benny powers/let-build-we B- components-part-3-vanilla-components-4on 3](https://dev.to/bennypowers/lets-build-web-components-part-3-vanilla-components-4on3)

åŸºäºç»„ä»¶çš„ UI æœ€è¿‘éå¸¸æµè¡Œã€‚æ‚¨çŸ¥é“ web æœ‰è‡ªå·±çš„æœ¬åœ°ç»„ä»¶æ¨¡å—ï¼Œä¸éœ€è¦ä½¿ç”¨ä»»ä½•åº“å—ï¼ŸçœŸå®æ•…äº‹ï¼ä½ å¯ä»¥ç¼–å†™ã€å‘å¸ƒå’Œé‡ç”¨å•æ–‡ä»¶ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶å¯ä»¥åœ¨ä»»ä½•å¥½çš„æµè§ˆå™¨ [*](https://caniuse.com/#feat=shadowdomv1) å’Œä»»ä½•æ¡†æ¶[ä¸­å·¥ä½œ(å¦‚æœé‚£æ˜¯ä½ çš„åŒ…çš„è¯)ã€‚](https://custom-elements-everywhere.com/)

åœ¨æˆ‘ä»¬çš„[ä¸Šä¸€ç¯‡æ–‡ç« ](https://dev.to/bennypowers/lets-build-web-components-part-2-the-polyfills-dkh)ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº† JavaScript polyfillsï¼Œå®ƒå…è®¸æˆ‘ä»¬å°†ç»„ä»¶å‘é€åˆ°ä¸æ”¯æŒè¯¥è§„èŒƒçš„æµè§ˆå™¨ã€‚

[![bennypowers](../Images/57370d6f6dab8d6651a3f138a1aaaa40.png)](/bennypowers) [## è®©æˆ‘ä»¬æ„å»º Web ç»„ä»¶ï¼ç¬¬ 2 éƒ¨åˆ†:èšåˆå¡«æ–™

### æœ¬å°¼Â·é²å°”æ–¯ğŸ‡®ğŸ‡±ğŸ‡¨ğŸ‡¦9 æœˆ 29 æ—¥ 1812 åˆ†é’Ÿé˜…è¯»

#webcomponents #javascript #html #polyfill](/bennypowers/lets-build-web-components-part-2-the-polyfills-dkh)

ä»Šå¤©ï¼Œæˆ‘ä»¬å˜å¾—å®é™…äº†ğŸ‘·â€â™‚ï¸ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªæ²¡æœ‰ä»»ä½•åº“æˆ–æ¡†æ¶ä»£ç çš„å•æ–‡ä»¶ web ç»„ä»¶ã€‚æˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªå…ƒç´ æ¥å»¶è¿ŸåŠ è½½å›¾åƒï¼Œè¿™æ ·æµè§ˆå™¨åªåœ¨å›¾åƒå‡ºç°(æˆ–å³å°†å‡ºç°)åœ¨å±å¹•ä¸Šæ—¶æ‰è¯»å–å›¾åƒã€‚æˆ‘ä»¬å°†ä½¿æˆ‘ä»¬çš„å…ƒç´ **å¯è®¿é—®**ï¼Œå¹¶åˆ©ç”¨ web <abbr title="application programmer interface">API</abbr> å¦‚`IntersectionObserver`ä½¿å…¶**è½»é‡çº§**å’Œ**é«˜æ€§èƒ½**ã€‚å¦‚æœæˆ‘ä»¬å–œæ¬¢ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥æ·»åŠ ä¸€äº›é¢å¤–çš„é“ƒé“›å’Œå“¨å­ã€‚

*   [è‡ªå®šä¹‰å…ƒç´ ç±»](#the-custom-element-class)
*   [ç”Ÿå‘½å‘¨æœŸå›è°ƒ](#lifecycle-callbacks)
    *   [`constructor`](#the-constructor)
    *   [`connectedCallback`](#the-connectedCallback)
    *   [`attributeChangedCallback`](#the-attributeChangedCallback)
    *   [`disconnectedCallback`](#the-disconnectedCallback)
    *   [`adoptedCallback`](#the-adoptedCallback)
    *   [é¡µé¢ç”Ÿå‘½å‘¨æœŸ](#the-page-lifecycle)
*   [æƒ°æ€§åŠ è½½](#lazy-loading)
*   [è®¾è®¡æˆ‘ä»¬çš„ç»„ä»¶](#styling-our-component)
    *   [`:host`å’Œ`<slot>`](#host-and-slot)
    *   [CSS è‡ªå®šä¹‰å±æ€§](#css-custom-properties)
*   [å¯è®¿é—®æ€§](#accessibility)
    *   [æ‰©å±•å†…ç½®å…ƒç´ ](#extending-built-in-elements)
    *   [æ— éšœç¢è‡ªä¸»å…ƒç´ ](#accessible-autonomous-elements)
*   [ç»“è®º](#conclusions)

æˆ‘ä»¬å¼€å§‹å§ï¼æ‰“å¼€ä½ çš„ç¼–è¾‘å™¨ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º`lazy-image.js`çš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å°†åŒ…å«æˆ‘ä»¬çš„ç»„ä»¶ã€‚

## è‡ªå®šä¹‰å…ƒç´ ç±»

æ­£å¦‚æˆ‘ä»¬åœ¨å…³äº web ç»„ä»¶æ ‡å‡†çš„ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€æ­¥å°†æ˜¯åˆå§‹åŒ–å’Œæ³¨å†Œä¸€ä¸ªå®šåˆ¶å…ƒç´ ç±»ï¼Œå¹¶ä¸ºå®ƒæä¾›ä¸€ä¸ªåŸºæœ¬æ¨¡æ¿ã€‚ç¨åæˆ‘ä»¬å°†æ”¹è¿›æ¨¡æ¿ï¼Œæ·»åŠ æˆ‘ä»¬çš„è‡ªå®šä¹‰è¡Œä¸ºã€‚

```
const tagName = 'lazy-image';
const template = document.createElement('template');
template.innerHTML = `<img id="image"/>`;

class LazyImage extends HTMLElement {
  connectedCallback() {
    if (!this.shadowRoot) {
      this.attachShadow({mode: 'open'});
      this.shadowRoot.appendChild(template.content.cloneNode(true));
    }
  }
}

const register = () => customElements.define(tagName, LazyImage);
window.WebComponents ? window.WebComponents.waitFor(register) : register(); 
```

Enter fullscreen mode Exit fullscreen mode

å¥½å§ã€‚å¦‚æœä½ ä¸€ç›´åœ¨å…³æ³¨æˆ‘ä»¬ä¹‹å‰çš„å¸–å­ï¼Œè¿™äº›åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰ï¼Œä½†æ˜¯ç¨å¾®å›é¡¾ä¸€ä¸‹æ˜¯æœ‰å¿…è¦çš„:

1.  æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¨¡æ¿å…ƒç´ ï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰å…ƒç´ çš„ shadow <abbr title="document object model">DOM</abbr> ã€‚
2.  æˆ‘ä»¬åœ¨`class`ä¸­å®šä¹‰è‡ªå®šä¹‰å…ƒç´ çš„è¡Œä¸ºã€‚
3.  æˆ‘ä»¬çš„å…ƒç´ çš„`connectedCallback`æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªå½±å­æ ¹ï¼Œå¹¶å°†æ¨¡æ¿æˆ³å…¥å…¶ä¸­ã€‚

æŠŠå®ƒæ”¾è¿›ä½ çš„æ–‡æ¡£ï¼Œç„¶åç»™å‡º:

```
<!doctype html>
<html lang="en">
  <head>
    <script src="https://unpkg.com/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script type="module" src="./lazy-image.js"></script>
  </head>
  <body>
    <lazy-image></lazy-image>
  </body>
</html> 
```

Enter fullscreen mode Exit fullscreen mode[https://glitch.com/embed/#!/embed/sunset-sink?sidebarCollapsed=true&path=index.html](https://glitch.com/embed/#!/embed/sunset-sink?sidebarCollapsed=true&path=index.html)

å¾ˆåˆºæ¿€ï¼Œå¯¹å§ï¼Ÿå¥½å§ï¼Œè¿™æ˜¯ä¸€ä¸ªå‘å¾®çš„å¼€å§‹ï¼Œä½†è‡³å°‘å®ƒçš„å·¥ä½œã€‚å¦‚æœæˆ‘ä»¬ç”¨å¼€å‘å·¥å…·æ£€æŸ¥æˆ‘ä»¬çš„å…ƒç´ ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒåŒ…å«æˆ‘ä»¬çš„å½±å­ DOMï¼Œå¹¶ä¸”ä¸æˆ‘ä»¬çš„è‡ªå®šä¹‰å…ƒç´ ç±»ç›¸å…³è”ã€‚

[![Dev Tools DOM inspector showing our custom element with a 'custom' badge next to it, and the shadow root containing the img element](../Images/c99ae63dc2e36f0444552d47b484100a.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--7OcQJBYY--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/831jg8zg9zs8jy4cl3hd.png)

è¿™ä¸ªå°å¾½ç« æ˜¯ Firefox å‘Šè¯‰æˆ‘ä»¬è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰å…ƒç´ çš„æ–¹å¼ã€‚å¦‚æœæ‚¨å•å‡»å¾½ç« ï¼Œè°ƒè¯•å™¨å°†å¼¹å‡ºæ‰“å¼€æ‚¨çš„å…ƒç´ çš„å®šä¹‰ã€‚åšå¾—å¥½ï¼Œç«ç‹å¼€å‘å·¥å…·å›¢é˜Ÿï¼

åœ¨ä¸‹ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†çœŸæ­£å¼€å§‹çƒ¹é¥ªã€‚

## ç”Ÿå‘½å‘¨æœŸå›è°ƒ

è‡ªå®šä¹‰å…ƒç´ æœ‰å››ç§ç‰¹æ®Šçš„å®ä¾‹æ–¹æ³•ï¼Œå®ƒä»¬å°†åœ¨ä¸åŒçš„æ—¶é—´è¿è¡Œ:

1.  [`connectedCallback`](#the-connectedCallback) ï¼Œ
2.  [`attributeChangedCallback`](#the-attributeChangedCallback) ï¼Œ
3.  [`disconnectedCallback`](#the-disconnectedCallback) ï¼Œ
4.  [`adoptedCallback`](#the-adoptedCallback) ï¼Œ

æ‰€æœ‰é»˜è®¤å®šä¹‰ä¸º`null`ã€‚è¿™äº›ä»¥åŠ [`constructor`](#the-constructor) ï¼Œéƒ½æ˜¯å®šåˆ¶å…ƒç´ ç”Ÿå‘½å‘¨æœŸå›è°ƒã€‚

## `constructor`

ç¬¬ä¸€ä¸ªæ˜¯æ„é€ å‡½æ•°ã€‚æ¯å½“åˆ›å»ºå…ƒç´ æ—¶ï¼Œåœ¨å°†å…ƒç´ é™„åŠ åˆ°æ–‡æ¡£ä¹‹å‰ï¼Œå®ƒéƒ½ä¼šè¿è¡Œã€‚

```
// CustomElement's constructor runs
const el = document.createElement('custom-element'); 
```

Enter fullscreen mode Exit fullscreen mode

è‡ªå®šä¹‰å…ƒç´ çš„æ„é€ å‡½æ•°ä¸èƒ½æœ‰ä»»ä½•å‚æ•°ï¼Œå®ƒå¿…é¡»åœ¨ä¸»ä½“çš„ç¬¬ä¸€è¡Œè°ƒç”¨`super()`ï¼Œä»¥ä¾¿å°†è¡Œä¸ºå§”æ‰˜ç»™`HTMLElement`ã€`Node`ç­‰ã€‚ï¼›å¹¶å°†`this`ç»‘å®šåˆ°å…ƒç´ å®ä¾‹ã€‚æ„é€ å‡½æ•°ä¸åº”è¿”å›é™¤`undefined`æˆ–`this`ä¹‹å¤–çš„ä»»ä½•å€¼ï¼›

```
// Don't do this
class BustedElement extends HTMLElement {
  constructor(bar) {
    this.foo = bar;
    return bar;
  }
}

// Do This
class DecentElement extends HTMLElement {
  constructor() {
    super();
    if (!window.bar) return;
    this.foo = window.bar;
  }
} 
```

Enter fullscreen mode Exit fullscreen mode

æ‚¨å¯èƒ½æƒ³è¦è®¿é—®å…ƒç´ çš„å±æ€§`parentNode`ã€å­å…ƒç´ ç­‰ã€‚ä½†æ˜¯ä¸è¦å±ˆæœäºè¯±æƒ‘:å¦‚æœæ‚¨çš„å…ƒç´ æ²¡æœ‰è¿æ¥(å³é™„åŠ )åˆ° DOM æ ‘ï¼Œé‚£ä¹ˆå®ƒè¿˜æ²¡æœ‰å‡çº§ï¼Œè¿™æ„å‘³ç€å®ƒè¿˜æ²¡æœ‰ä»»ä½•å­å…ƒç´ æˆ–å±æ€§ã€‚å¦‚æœåœ¨å®šä¹‰å…ƒç´ ä¹‹å‰å·²ç»åœ¨æ–‡æ¡£ä¸­å®šä¹‰äº†å…ƒç´ ï¼Œé‚£ä¹ˆæ‚¨çš„ä»£ç å°†ä¼šå·¥ä½œï¼Œä½†æ˜¯å¦‚æœ JavaScript åˆ›å»ºäº†å…ƒç´ ï¼Œé‚£ä¹ˆæ‚¨çš„ä»£ç å°†ä¼šå¤±è´¥ã€‚

åœ¨æ„é€ å‡½æ•°ä¸­é™„åŠ å½±å­æ ¹å¹¶å‘å…¶è¿½åŠ å…ƒç´ ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ä½†æ˜¯ç”±äº polyfills å¿…é¡»å‘ light DOM æ·»åŠ ç±»ï¼Œå¹¶ä¸”å…ƒç´ å¯èƒ½è¿˜æ²¡æœ‰è¿æ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†åœ¨æœ¬æ•™ç¨‹çš„`connectedCallback`ä¸­ä¸€ç›´è¿™æ ·åšï¼Œ

ç”±äºè¿™äº›åŸå› ï¼Œæœ€å¥½å°†æ„é€ å‡½æ•°çš„æ´»åŠ¨é™åˆ¶åœ¨è®¾ç½®å†…éƒ¨çŠ¶æ€ï¼ŒåŒ…æ‹¬é»˜è®¤å€¼ï¼Œä»¥åŠåœ¨ä½¿ç”¨èšåˆå¡«å……æ—¶ï¼Œé™„åŠ é˜´å½±æ ¹å¹¶è°ƒç”¨`connectedCallback`ä¸­çš„`styleElement`ã€‚åªè¦ç¡®ä¿æ£€æŸ¥`shadowRoot`æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå¦åˆ™ä¸‹æ¬¡ä½ çš„å…ƒç´ è¿æ¥æ—¶(ä¾‹å¦‚é€šè¿‡`document.body.append(myLazyImage)`)å°†æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚

```
// Don't do this
class BustedImage extends HTMLElement {
  constructor() {
    super();
    this.attachShadow({mode: 'open'});
    this.shadowRoot.appendChild(template.content.cloneNode(true));
    this.shadowImage = this.shadowRoot.getElementById('image');
    // OOPS! Light DOM attributes may not yet exist!
    this.shadowImage.src = this.getAttribute('src');
  }
}

// Do This
class LazyImage extends HTMLElement {
  constructor() {
    super();
    // Set default values of properties, as needed.
    this.src = '';
    // In order to work well with the polyfill,
    // We'll set up the DOM later on, when the element connects.
  }
} 
```

Enter fullscreen mode Exit fullscreen mode

## `connectedCallback`

æ¯æ¬¡å…ƒç´ è¿æ¥åˆ° DOM æ—¶ï¼ŒåŒ…æ‹¬ç¬¬ä¸€æ¬¡å‡çº§æ—¶ï¼Œéƒ½ä¼šè§¦å‘`connectedCallback`ã€‚è¿™æ˜¯ä¸€ä¸ªå»ºç«‹å½±å­å­©å­å’Œå±æ€§çš„å¥½æ—¶æœºã€‚

```
const lazyImage = document.createElement('lazy-image'); // constructor runs
document.appendChild(lazyImage); // connectedCallback runs

const container = document.getElementById('container');
container.appendChild(lazyImage); // connectedCallback runs again 
```

Enter fullscreen mode Exit fullscreen mode

```
class LazyImage extends HTMLElement {
  constructor() {
    super();
    this.src = '';
    this.alt = '';
  }

  connectedCallback() {
    // Initialize properties that depend on light DOM
    this.src = this.getAttribute('src') || this.src;
    this.alt = this.getAttribute('alt') || this.alt;
    // Check if shadowRoot exists first
    if (!this.shadowRoot) {
      this.attachShadow({mode: 'open'});
      this.shadowRoot.appendChild(template.content.cloneNode(true));
      this.shadowImage = this.shadowRoot.getElementById('image')
    }
    // Set the shadow img attributes.
    this.shadowImage.src = this.src;
    this.shadowImage.alt = this.alt;
  }
} 
```

Enter fullscreen mode Exit fullscreen mode[https://glitch.com/embed/#!/embed/adaptable-order?previewSize=100&path=index.html](https://glitch.com/embed/#!/embed/adaptable-order?previewSize=100&path=index.html)

å—¯ï¼Œè¿™æ˜¯ä»¤äººé¼“èˆçš„ã€‚æˆ‘ä»¬å·²ç»è®¾ç½®äº†æˆ‘ä»¬çš„å½±å­ DOMï¼Œå¹¶å®ç°äº†ä¸€äº›åŸºæœ¬çš„ç®¡é“ï¼Œè¿™äº›ç®¡é“æ ¹æ®å‡çº§æ—¶åœ¨æˆ‘ä»¬çš„å…ƒç´ ä¸Šæ‰¾åˆ°çš„å±æ€§æ¥è®¾ç½®æˆ‘ä»¬çš„å†…éƒ¨`img`å…ƒç´ çš„`src`å’Œ`alt`å±æ€§ã€‚

æˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„`shadowImage`çš„`src`å±æ€§ä¸æˆ‘ä»¬çš„å…ƒç´ çš„å±æ€§åŒæ­¥ï¼Œæˆ‘ä»¬è¿˜å¸Œæœ›è¿™äº›å±æ€§ä¸`src` DOM å±æ€§åŒæ­¥ã€‚åœ¨`attributeChangedCallback`å’Œä¸€äº›è¯¾ç¨‹è®¾ç½®è€…çš„å¸®åŠ©ä¸‹ï¼Œæˆ‘ä»¬ä¼šå®ç°å®ƒã€‚

## `attributeChangedCallback`

å½“æ‚¨æ›´æ”¹æ™®é€š`<img/>`å…ƒç´ çš„`src`å±æ€§æ—¶ï¼Œæµè§ˆå™¨é€šè¿‡è·å–å¹¶æ˜¾ç¤ºæ–°å›¾åƒ <abbr title="uniform resource locator">URL</abbr> æ¥åšå‡ºå“åº”ã€‚ç±»ä¼¼åœ°ï¼Œå½“æ‚¨ä½¿ç”¨ JavaScript åœ¨è¯¥å…ƒç´ çš„ DOM å¯¹è±¡ä¸Šè®¾ç½®`src`å±æ€§æ—¶ï¼Œæ–°å€¼ä¼šåæ˜ åœ¨å±æ€§ä¸­ã€‚æˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„å…ƒç´ ä»¥åŒæ ·çš„æ–¹å¼è¿è¡Œã€‚HTML è§„èŒƒä¸ºè¿™äº›ç±»å‹çš„ä½¿ç”¨æä¾›äº†`attributeChangedCallback`ã€‚

åªè¦å…ƒç´ çš„å±æ€§å‘ç”Ÿå˜åŒ–ï¼Œå›è°ƒå°±ä¼šä»¥å±æ€§åã€æ—§å€¼å’Œæ–°å€¼ä½œä¸ºå‚æ•°è¿è¡Œã€‚ä½†æ˜¯æµè§ˆå™¨ä¸ä¼šè§‚å¯Ÿä»»ä½•å±æ€§ã€‚æ‚¨å¿…é¡»é€šè¿‡åœ¨åä¸º`observedAttributes` :
çš„é™æ€å±æ€§ä¸­å®šä¹‰ä¸€ä¸ªå±æ€§åç§°åˆ—è¡¨æ¥é¢„å…ˆæŒ‡å®šæ‚¨æƒ³è¦å¯¹å“ªäº›å±æ€§åšå‡ºååº”

```
static get observedAttributes() {
  return ['src', 'alt'];
} 
```

Enter fullscreen mode Exit fullscreen mode

æœ‰äº†è¿™ä¸ªå®šä¹‰ï¼Œæ— è®ºä»»ä½•ä¸€ä¸ª`src`æˆ–`alt`å±æ€§æ”¹å˜ï¼Œä½ çš„å…ƒç´ çš„`attributeChangedCallback`éƒ½ä¼šè¿è¡Œã€‚ç°åœ¨ï¼Œæˆ‘ä»¬åªæ˜¯å°†å€¼ä½œä¸ºå±æ€§è½¬å‘ã€‚

```
attributeChangedCallback(name, oldVal, newVal) {
  this[name] = newVal
} 
```

Enter fullscreen mode Exit fullscreen mode

æˆ‘ä»¬è¿˜å¸Œæœ›æˆ‘ä»¬çš„å…ƒç´ é€šè¿‡æ›´æ–°å®ƒçš„ shadowImage å¹¶é€šè¿‡å°†æ–°å€¼åæ˜ åˆ°å±æ€§æ¥å¯¹å±æ€§å˜åŒ–åšå‡ºååº”ã€‚æˆ‘ä»¬å°†ä¸ºæ­¤ä½¿ç”¨ setter:

```
class LazyImage extends HTMLElement {
  /**
   * Guards against loops when reflecting observed attributes.
   * @param  {String} name Attribute name
   * @param  {any} value
   * @protected
   */
  safeSetAttribute(name, value) {
    if (this.getAttribute(name) !== value) this.setAttribute(name, value);
  }

  /**
   * Image URI.
   * @type {String}
   */
  set src(value) {
    this.safeSetAttribute('src', value);
    // Set image src
    if (this.shadowImage) this.shadowImage.src = value;
  }

  get src() {
    return this.getAttribute('src')
  }

  /**
   * Image Alt tag.
   * @type {String}
   */
  set alt(value) {
    this.safeSetAttribute('alt', value);
    // Set image alt
    if (this.shadowImage) this.shadowImage.alt = value;
  }

  get alt() {
    return this.getAttribute('alt')
  }

  static get observedAttributes() {
    return ['src', 'alt'];
  }

  connectedCallback() {
    this.src = this.getAttribute('src');
    this.alt = this.getAttribute('alt');
    if (!this.shadowRoot) {
      this.attachShadow({mode: 'open'});
      this.shadowRoot.appendChild(template.content.cloneNode(true));
      this.shadowImage = this.shadowRoot.getElementById('image');
    }
  }

  attributeChangedCallback(name, oldVal, newVal) {
    this[name] = newVal;
  }
} 
```

Enter fullscreen mode Exit fullscreen mode[https://glitch.com/embed/#!/embed/guttural-tarsier?previewSize=100&path=index.html](https://glitch.com/embed/#!/embed/guttural-tarsier?previewSize=100&path=index.html)

æŒ‰ä¸‹æŒ‰é’®ä¼šæ›´æ–°å®šåˆ¶å…ƒç´ åŠå…¶é˜´å½±å­å…ƒç´ ä¸Šçš„`src`å’Œ`alt`å±æ€§ã€‚

[![inspector showing synchronized attributes](../Images/1b09e703f4d78d3edab764993173d5f3.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--l7AZurJu--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/zvwg1ew0c9x96wvw4lds.png)

æˆ‘ä»¬çš„å…ƒç´ ç°åœ¨é€æ˜åœ°å…¬å¼€äº†æœ¬æœº`<img>`å…ƒç´ çš„ä¸»è¦åŠŸèƒ½ã€‚ä¸‹ä¸€æ­¥æ˜¯æ·»åŠ æˆ‘ä»¬çš„å»¶è¿ŸåŠ è½½ç‰¹æ€§ã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼Œè®©æˆ‘ä»¬ç®€è¦è®¨è®ºä¸€ä¸‹è§„èŒƒä¸­çš„æœ€åä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸå›è°ƒã€‚

### `disconnectedCallback`

æ¯å½“ä½ çš„å…ƒç´ éœ€è¦åœ¨ä» DOM ä¸­ç§»é™¤ä¹‹å‰åšä¸€äº›æ¸…ç†å·¥ä½œæ—¶ï¼Œå®šä¹‰ä¸€ä¸ª`disconnectedCallback`æ¥å¤„ç†ä½ çš„æ¸…ç†å·¥ä½œã€‚

```
disconnectedCallback() {
  /* do cleanup stuff here */
} 
```

Enter fullscreen mode Exit fullscreen mode

å½“æˆ‘ä»¬ä¸ºå…ƒç´ çš„æ¯ä¸ªå®ä¾‹åˆ›å»ºä¸€ä¸ª`IntersectionObserver`æ—¶ï¼Œè¿™å¯¹æˆ‘ä»¬å¾ˆæ–¹ä¾¿ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†æŠŠå®ƒä½œä¸ºå­˜æ ¹ã€‚

### `adoptedCallback`

å®šåˆ¶å…ƒç´ ä¹Ÿæœ‰ä¸€ä¸ª`adoptedCallback`ï¼Œæ¯å½“æ‚¨å¯¹å¦ä¸€ä¸ªæ–‡æ¡£æˆ–æ–‡æ¡£ç‰‡æ®µä¸­çš„å®šåˆ¶å…ƒç´ è°ƒç”¨`adoptNode`æ—¶ï¼Œå®ƒå°±ä¼šè¿è¡Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“å…ƒç´ ä¸åŸå§‹æ–‡æ¡£æ–­å¼€è¿æ¥æ—¶ï¼Œé¦–å…ˆä¼šè¿è¡Œå…ƒç´ çš„`disconnectedCallback`ï¼Œç„¶åæ˜¯`adoptedCallback`ï¼Œæœ€åæ˜¯è¿æ¥åˆ°æ–‡æ¡£æ—¶çš„`connectedCallback`ã€‚

[![giant ğŸ¤·â€â™‚ï¸ emoji](../Images/23590f990dc5cf9180d3db89770c23f8.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--JaHzMcYi--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/240/facebook/138/man-shrugging_1f937-200d-2642-fe0f.png)

æˆ‘è®¤ä¸ºè¿™ä¸»è¦æ˜¯é’ˆå¯¹å·²ç»å¤±æ•ˆçš„ HTML å¯¼å…¥è§„èŒƒçš„ã€‚å¦‚æœ[æˆ–è€…](https://github.com/w3c/webcomponents/blob/gh-pages/proposals/html-modules-proposal.md)[HTML æ¨¡å—](https://github.com/w3c/webcomponents/issues/645)çš„æè®®è¢«é‡‡çº³ï¼Œå®ƒå¾ˆå¯èƒ½å˜å¾—æ›´åŠ ç›¸å…³ã€‚å¦‚æœä½ å¯¹ç”¨ä¾‹æœ‰ä»»ä½•æƒ³æ³•ï¼Œæˆ‘ä»¬ä¼šåœ¨è¯„è®ºåŒºçœ‹åˆ°ä½ ã€‚

### é¡µé¢ç”Ÿå‘½å‘¨æœŸ

å› æ­¤ï¼Œæ‚¨çš„é¡µé¢ç”Ÿå‘½å‘¨æœŸå¯èƒ½å¦‚ä¸‹æ‰€ç¤º:

1.  è·å–å…³é”®èµ„æºï¼ŒåŒ…æ‹¬èšåˆå¡«å……
2.  æ„é€  DOM
3.  è·å–å»¶è¿Ÿçš„è„šæœ¬å’Œæ¨¡å—ï¼ŒåŒ…æ‹¬`lazy-image.js`
4.  DOMContentLoaded -æ–‡æ¡£å·²å®Œæˆè§£æ
5.  Polyfills å®Œæˆè®¾ç½®ï¼Œ`WebComponents.waitFor`è°ƒç”¨å…¶å›è°ƒ
6.  å®šåˆ¶å…ƒç´ è¢«å‡çº§â€”â€”æ–‡æ¡£ä¸­çš„æ¯ä¸ª`<lazy-image>`å®ä¾‹éƒ½è¢«å‡çº§ä¸ºå®šåˆ¶å…ƒç´ ã€‚`constructor`å’Œ`connectedCallback`è·‘ã€‚
7.  å¦‚æœ JavaScript åˆ›å»ºäº†ä¸€ä¸ª`<lazy-image>`çš„å®ä¾‹ï¼Œæ„é€ å‡½æ•°å°±ä¼šè¿è¡Œã€‚å½“å®ä¾‹è¿æ¥åˆ° DOM æ ‘æ—¶ï¼Œ`connectedCallback`å°†ä¼šè¿è¡Œã€‚
8.  å¦‚æœ JavaScript ä» DOM ä¸­åˆ é™¤äº†ä¸€ä¸ª`<lazy-image>`å®ä¾‹ï¼Œé‚£ä¹ˆ`disconnectedCallback`å°†ä¼šè¿è¡Œã€‚

## æ‡’è£…

æˆ‘ä»¬å°†ä½¿ç”¨ [`IntersectionObserver` API](https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API) è¿›è¡Œå»¶è¿ŸåŠ è½½ã€‚å½“å›¾åƒä¸ä¸€ä¸ªç•¥å¤§äºå±å¹•çš„çŸ©å½¢ç›¸äº¤æ—¶ï¼Œæˆ‘ä»¬å°†å¼€å§‹åŠ è½½å®ƒï¼Œå¸Œæœ›å½“å›¾åƒæ»šåŠ¨åˆ°è§†å›¾ä¸­æ—¶ï¼Œå®ƒå°†è¢«å®Œå…¨åŠ è½½ã€‚æ˜¯åšé‚£é¡¹å·¥ä½œçš„æœ€å¥½åœ°æ–¹ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬åœ¨æ¨¡å—ä½œç”¨åŸŸçš„æ ¹å¤„å®šä¹‰ä¸€ä¸ªå¿«é€Ÿè°“è¯:

```
// isIntersecting :: IntersectionObserverEntry -> Boolean
const isIntersecting = ({isIntersecting}) => isIntersecting 
```

Enter fullscreen mode Exit fullscreen mode

ç„¶åæˆ‘ä»¬å¯ä»¥åœ¨å…ƒç´ å®ä¾‹åŒ–æ—¶è®¾ç½®è§‚å¯Ÿè€…:

```
constructor() {
  super();
  // Bind the observerCallback so it can access the element with `this`.
  this.observerCallback = this.observerCallback.bind(this);
}

connectedCallback() {
  // initialize pre-upgrade attributes
  this.src = this.getAttribute('src')
  this.alt = this.getAttribute('alt')
  // Set up shadow root.
  if (!this.shadowRoot) {
    this.attachShadow({mode: 'open'});
    this.shadowRoot.appendChild(template.content.cloneNode(true));
    this.shadowImage = this.shadowRoot.getElementById('image');
  }
  // If IntersectionObserver is available, initialize it.
  // otherwise, simply load the image.
  if ('IntersectionObserver' in window) this.initIntersectionObserver()
  else this.intersecting = true
}

/**
 * Sets the `intersecting` property when the element is on screen.
 * @param  {[IntersectionObserverEntry]} entries
 * @protected
 */
observerCallback(entries) {
  // The observer simply sets a property
  if (entries.some(isIntersecting)) this.intersecting = true
}

/**
 * Initializes the IntersectionObserver when the element instantiates.
 * @protected
 */
initIntersectionObserver() {
  if (this.observer) return;
  // Start loading the image 10px before it appears on screen
  const rootMargin = '10px';
  this.observer =
    new IntersectionObserver(this.observerCallback, { rootMargin });
  this.observer.observe(this);
} 
```

Enter fullscreen mode Exit fullscreen mode

å½“è§‚å¯Ÿè€…è§¦å‘å¹¶è®¾ç½®`intersecting`å±æ€§æ—¶ï¼Œè®©æˆ‘ä»¬å°†å…¶åæ˜ ä¸ºä¸€ä¸ªå±æ€§ï¼Œå¹¶å¼€å§‹åŠ è½½å›¾åƒã€‚å› ä¸ºè¿™ä¸ªè§‚å¯Ÿè€…åªéœ€è¦å‘å°„ä¸€æ¬¡ï¼Œæ‰€ä»¥ä¸€æ—¦å®Œæˆï¼Œæˆ‘ä»¬å°±å¯ä»¥æ–­å¼€å¹¶å¸è½½å®ƒã€‚

```
/**
 * Whether the element is on screen.
 * @type {Boolean}
 */
set intersecting(value) {
  if (value) {
    this.shadowImage.src = this.src;
    this.setAttribute('intersecting', '');
    this.disconnectObserver();
  } else {
    this.removeAttribute('intersecting')
  }
}

get intersecting() {
  return this.hasAttribute('intersecting')
}

/**
 * Disconnects and unloads the IntersectionObserver.
 * @protected
 */
disconnectObserver() {
  this.observer.disconnect();
  this.observer = null;
  delete this.observer;
} 
```

Enter fullscreen mode Exit fullscreen mode

å¦‚æœä» DOM ä¸­ç§»é™¤äº†å…ƒç´ ï¼Œæˆ‘ä»¬éœ€è¦å¸è½½è§‚å¯Ÿè€…ï¼Œå¦åˆ™æˆ‘ä»¬å¯èƒ½ä¼šæ³„æ¼å†…å­˜ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`disconnectedCallback`æ¥å®ç°ã€‚

```
disconnectedCallback() {
  this.disconnectObserver()
} 
```

Enter fullscreen mode Exit fullscreen mode

## é€ å‹æˆ‘ä»¬çš„ç»„ä»¶

ç°åœ¨ï¼Œä¸€æ—¦å›¾åƒå‡ºç°åœ¨å±å¹•ä¸Šï¼Œæˆ‘ä»¬å°±å¯ä»¥è½»æ¾åœ°åŠ è½½å®ƒï¼Œä½†æ˜¯æˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„å…ƒç´ ä¹Ÿèƒ½æä¾›ä¸€ä¸ªæ¼‚äº®çš„ <abbr title="user experience">UX</abbr> ï¼Œä¾‹å¦‚ï¼Œé€šè¿‡å†…åµŒåŠ è½½ä¸€ä¸ªå ä½ç¬¦å›¾åƒã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†é€šè¿‡åœ¨å…ƒç´ çš„å½±å­æ ¹ä¸­æ·»åŠ ä¸€ä¸ª`<style>`æ ‡ç­¾æ¥è®¾ç½®ç»„ä»¶çš„æ ·å¼ã€‚

```
const tagName = 'lazy-image';
const template = document.createElement('template');
template.innerHTML = `
  <style>
    :host {
      position: relative;
    }

    #image,
    #placeholder ::slotted(*) {
      position: absolute;
      top: 0;
      left: 0;
      transition: opacity 0.3s ease;
    }

    #placeholder ::slotted(*),
    :host([intersecting]) #image {
      opacity: 1;
    }

    #image,
    :host([intersecting]) #placeholder ::slotted(*) {
      opacity: 0;
    }
  </style>

  <div id="placeholder">
    <slot name="placeholder"></slot>
  </div>

  <img id="image"/>
`;

window.ShadyCSS && window.ShadyCSS.prepareTemplate(template, tagName); 
```

Enter fullscreen mode Exit fullscreen mode

### `:host`å’Œ`<slot>`

å“¦å“¦ï¼æ–°*å¥½ä¸œè¥¿*ï¼`:host` <abbr title="cascading style sheets">CSS</abbr> é€‰æ‹©å™¨æŒ‡çš„æ˜¯å½±å­ä¸»æœºï¼Œå³`<lazy-image>`å…ƒç´ æœ¬èº«ã€‚è¿™ä¸ä»…ä»…æ˜¯ä¸€ä¸ªä¼ªå…ƒç´ ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨`:host([intersecting])`ä¸­çœ‹åˆ°çš„ï¼Œå¦‚æœå®ƒæ˜¯ä»å½±å­æ ¹ä¹‹å¤–é€‰æ‹©çš„ï¼Œé‚£ä¹ˆå®ƒå°±ç›¸å½“äº`lazy-image[intersecting]`ã€‚

å…ƒç´ åŠå…¶ç›¸å…³çš„ CSS å‡½æ•°æ˜¯è§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼Œè®©æˆ‘ä»¬å°† DOM ä»å…‰çº¿æ ‘ä¼ é€’åˆ°é˜´å½±æ ‘ã€‚ä½ åœ¨é˜´å½±æ ‘é‡Œé¢ä½¿ç”¨`<slot>`ï¼Œå°±åƒæˆ‘ä»¬åœ¨ä¸Šé¢çœ‹åˆ°çš„ã€‚ç„¶åä½ ä»å…‰çº¿ DOM ä¸­ä¼ é€’å†…å®¹ï¼Œå°±åƒå½±å­æ ‘ä¸€æ ·:

```
<!-- light DOM -->

  <defs>
    <g id="placeholder-svg">
      <!-- ... -->
    </g>
  </defs>


<lazy-image alt="Picture of a cat" src="https://placekitten.com/400/200">
  <use xlink:href="#placeholder-svg"/>
</lazy-image> 
```

Enter fullscreen mode Exit fullscreen mode

æ³¨æ„è¿™é‡Œæˆ‘ä»¬æ˜¯å¦‚ä½•è®°ä½å¤šå¡«å……çš„[é™åˆ¶ï¼Œå¹¶å°†`<slot>`åŒ…è£…åœ¨`<div>`ä¸­ï¼Œç„¶ååœ¨ CSS ä¸­ä¸ºé‚£ä¸ª`<div>`çš„å­å…ƒç´ é€‰æ‹©ã€‚](https://dev.to/bennypowers/lets-build-web-components-part-2-the-polyfills-dkh#writing-custom-elements-that-work-with-the-polyfills)

`<slot>`å®é™…ä¸Šå¹¶ä¸ç§»åŠ¨æˆ–æ·»åŠ å¼€æ§½å…ƒç´ ï¼Œå®ƒåªæ˜¯æ˜¾ç¤ºå®ƒä»¬ï¼Œå°±åƒå®ƒä»¬åœ¨å½±å­æ ¹ä¸­ä¸€æ ·ã€‚å› æ­¤ï¼Œåº”ç”¨äºå¤–éƒ¨æ–‡æ¡£ä¸­å¼€æ§½å†…å®¹çš„æ ·å¼åœ¨å¼€æ§½æ—¶ä»ç„¶é€‚ç”¨ã€‚å€ŸåŠ©äº`::slotted()` CSS å‡½æ•°ï¼Œæ‚¨çš„å…ƒç´ å¯ä»¥å°†è‡ªå·±çš„æ ·å¼æ·»åŠ åˆ°å¼€æ§½å†…å®¹ä¸­ã€‚

```
::slotted(svg) {
  /* applies to any slotted svg element */
}

::slotted(img) {
  /* applies to any slotted img element */
} 
```

Enter fullscreen mode Exit fullscreen mode

**æ³¨æ„å¥½** : `::slotted(*)`åªä¸º*å…ƒç´ é€‰æ‹©*ï¼Œä¸é€‰æ‹©æ–‡æœ¬èŠ‚ç‚¹ã€‚å®ƒè¿˜åªé€‰æ‹©é¡¶å±‚èŠ‚ç‚¹ï¼Œè€Œä¸é€‰æ‹©å­èŠ‚ç‚¹:

```
/* Don't do this */
.wrapper ::slotted(.outer .inner) { /*...*/ }
.wrapper ::slotted(.inner) { /*...*/ }

/* Do this */
.wrapper ::slotted(.outer) { /*...*/ } 
```

Enter fullscreen mode Exit fullscreen mode

è¿™æ˜¯ä¸€ç§æµè§ˆå™¨æ€§èƒ½ä¼˜åŒ–ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå®ƒå¯èƒ½ä¼šä»¤äººè®¨åŒï¼Œä½†é€šè¿‡åˆ›é€ æ€§çš„ DOM å·¥ä½œå’Œæ™ºèƒ½åº”ç”¨ç¨‹åºåˆ†è§£ï¼Œå®ƒå¯ä»¥å¾—åˆ°å¤„ç†ã€‚

æ’æ§½å¯ä»¥æ˜¯å‘½åçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯åŒ¿åçš„ã€‚é€šè¿‡åœ¨é˜´å½± DOM ä¸­èµ‹äºˆä¸€ä¸ª`name="slotname"`å±æ€§æ¥å‘½åä¸€ä¸ªæ§½ï¼Œå¹¶é€šè¿‡åœ¨å…‰ç…§ DOM ä¸­æŒ‡å®š`<div slot="slotname"></div>`æ¥ä½¿ç”¨å®ƒã€‚å¦‚æœæ‚¨å¸Œæœ›æä¾›å¤šä¸ªç‰¹å®šçš„å¯å®šåˆ¶åŠŸèƒ½ï¼Œå‘½åæ’æ§½ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œä¸ºäº†æ¸…æ™°èµ·è§ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªå·²å‘½åçš„`<slot name="placeholder"></slot>`ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªåŒ¿åçš„`<slot></slot>`ã€‚

```
<!-- shadow DOM template -->

<style>
  #title-container ::slotted(*) {
    /* styles for title element */
  }
  #content-container ::slotted(*) {
    /* styles for body content */
  }
</style>
<article>
  <div id="title-container">
    <!-- named slot -->
    <slot name="title"></slot>
  </div>

  <div id="content-container">
    <!-- anonymous slot -->
    <slot></slot>
  </div>
</article>

<!-- light DOM -->
<super-article>
  <h2 slot="title">I'm the article title</h2>
  <p>I'm the article content</p>
  <p>I get slotted into the anonymous slot, too</p>
</super-article> 
```

Enter fullscreen mode Exit fullscreen mode

ç°åœ¨æˆ‘ä»¬å·²ç»å°†å…‰çº¿ DOM å ä½ç¬¦ä¼ é€’åˆ°äº†é˜´å½±æ ‘ä¸­ï¼Œè®©æˆ‘ä»¬æ›´æ–°ç±»çš„æ–¹æ³•æ¥å¤„ç†å ä½ç¬¦:

```
set intersecting(value) {
  if (value) {
    // Wait to apply the `intersecting` attribute until the image
    // finishes loading, then update the styles for polyfill browsers
    this.shadowImage.onload = this.setIntersecting;
    this.shadowImage.src = this.src;
    this.disconnectObserver();
  } else {
    this.removeAttribute('intersecting');
  }
}

constructor() {
  super();
  this.setIntersecting = this.setIntersecting.bind(this);
}

/**
 * Sets the intersecting attribute and reload styles if the polyfill is at play.
 * @protected
 */
setIntersecting() {
  this.setAttribute('intersecting', '');
  this.updateShadyStyles();
}

connectedCallback() {
  this.updateShadyStyles();
  /* etc. */
}

/**
 * When the polyfill is at play, ensure that styles are updated.
 * @protected
 */
updateShadyStyles() {
  window.ShadyCSS && window.ShadyCSS.styleElement(this);
} 
```

Enter fullscreen mode Exit fullscreen mode[https://glitch.com/embed/#!/embed/abalone-mongoose?previewSize=100&path=index.html](https://glitch.com/embed/#!/embed/abalone-mongoose?previewSize=100&path=index.html)

ğŸ˜ä¸é”™ï¼æˆ‘ä»¬è‡ªä¸»çš„ã€å¯é‡å¤ä½¿ç”¨çš„ã€å•æ–‡ä»¶çš„å®šåˆ¶å…ƒç´ åœ¨å±å¹•ä¸ŠåŠ è½½å›¾åƒï¼Œç„¶åä»ä¸€ä¸ªæœ‰æ§½çš„å ä½ç¬¦æ·¡å…¥æ·¡å‡ºã€‚

é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œè¿™æ˜¯ä¸€ä¸ªè¿‘è·ç¦»è§‚å¯Ÿ polyfills å¦‚ä½•å·¥ä½œçš„å¥½æœºä¼šã€‚å¦‚æœåœ¨æ”¯æŒçš„æµè§ˆå™¨ä¸ŠåŠ è½½æ­¤é¡µé¢ï¼Œæ‚¨å°†åœ¨å…ƒç´ çš„é˜´å½±æ ‘ä¸­çœ‹åˆ°ä¸€ä¸ªæ ·å¼æ ‡ç­¾ï¼Œä½†æ˜¯å¦‚æœåœ¨ Edge æˆ– Firefox 62 ç­‰å¤šå¡«å……æµè§ˆå™¨ä¸ŠåŠ è½½ï¼Œæ‚¨å°†çœ‹ä¸åˆ°ä»»ä½•æ ·å¼ï¼Œå› ä¸º ShadyCSS å¤šå¡«å……å°†é˜´å½±æ ·å¼æå‡åˆ°æ–‡æ¡£çš„å¤´éƒ¨ã€‚

| å¤šå¡«å…… | å½“åœ°çš„ |
| --- | --- |
| ![the shady tree on a polyfilled browser, containing no style element and generated classes for shadow content](../Images/f276109995d8c752ef81a72a0bdac771.png) | ![the shadow tree on a supporting browser, containing a style tag and no generated class names](../Images/f78729ef4fbb78db7e302368b5b3f481.png) |

### CSS è‡ªå®šä¹‰å±æ€§

Shadow DOM å°†æˆ‘ä»¬çš„æ ·å¼ä¸æ–‡æ¡£çš„å…¶ä»–éƒ¨åˆ†éš”ç¦»å¼€æ¥ï¼Œä½†è¿™æ„å‘³ç€ç”¨æˆ·å¾ˆéš¾å®šåˆ¶æˆ‘ä»¬çš„ç»„ä»¶ã€‚å¹¸è¿çš„æ˜¯ï¼ŒCSS è‡ªå®šä¹‰å±æ€§ç©¿é€äº†é˜´å½±è¾¹ç•Œï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒä»¬åœ¨å…ƒç´ ä¸Šæ˜¾ç¤ºå¯è‡ªå®šä¹‰çš„æ ·å¼ã€‚

æˆ‘ä»¬åªè¦ç”¨è‡ªå®šä¹‰å±æ€§å®šä¹‰æˆ‘ä»¬çš„æ ·å¼å°±å¯ä»¥äº†ã€‚è‡ªå®šä¹‰å±æ€§çš„è¯­æ³•å…è®¸åœ¨åˆ†é…é»˜è®¤å€¼æ—¶ä½¿ç”¨å£°æ˜å˜é‡:

```
.selector {
  rule: var(--custom-property-name, default);
} 
```

Enter fullscreen mode Exit fullscreen mode

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨åˆç†çš„é»˜è®¤å€¼æ¥è®¾è®¡æˆ‘ä»¬çš„å…ƒç´ ï¼ŒåŒæ—¶ä»ç„¶ç»™ç”¨æˆ·ä¸€äº›çµæ´»æ€§:

```
#image,
#placeholder ::slotted(*) {
  position: absolute;
  top: 0;
  left: 0;
  transition:
    opacity
    var(--lazy-image-fade-duration, 0.3s)
    var(--lazy-image-fade-easing, ease);
  object-fit: var(--lazy-image-fit, contain);
  width: var(--lazy-image-width, 100%);
  height: var(--lazy-image-height, 100%);
} 
```

Enter fullscreen mode Exit fullscreen mode

ç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨æˆ‘ä»¬çš„æ–‡æ¡£æ ·å¼ä¸­å®šä¹‰è¿™äº›å˜é‡æ¥è°ƒæ•´è¿™äº›æ ·å¼ï¼Œæ— è®ºæ˜¯å…¨å±€çš„è¿˜æ˜¯ç‰¹å®šçš„å…ƒç´ :

```
/* applies to the whole document. */
html {
  --lazy-image-width: 400px;
  --lazy-image-height: 200px;
}

/* applies to specific elements */
lazy-image:last-of-type {
  width: 400px;
  height: 200px;
  --lazy-image-width: 100%;
  --lazy-image-height: 100%;
  --lazy-image-fade-duration: 2s;
  --lazy-image-fade-easing: linear;
} 
```

Enter fullscreen mode Exit fullscreen mode

## å¯è¾¾æ€§

åœ¨æˆ‘ä»¬å‘å¸ƒæˆ‘ä»¬çš„ç»„ä»¶ä¹‹å‰ï¼Œè®©æˆ‘ä»¬ç¡®ä¿å®ƒå°Šé‡æˆ‘ä»¬æ‰€æœ‰çš„ç”¨æˆ·ã€‚ä½ ä¸ä¼šæä¾›ç¾å‘³çš„çƒ¤æ’éª¨(è¿˜æœ‰äººé¥¿å—ï¼Ÿ)è€Œä¸ä¿®å‰ªæ‰æŒ‚åœ¨é’»å¤´å’Œè½¯éª¨ä¸Šçš„å¤šä½™éƒ¨åˆ†ã€‚æ²¡äººæƒ³åš¼é‚£ä¸ªï¼è®©æˆ‘ä»¬ä»ç»„ä»¶çš„ <abbr title="accessibility">a11y</abbr> æ ‘ä¸Šå»æ‰è„‚è‚ªã€‚

### æ‰©å±•å†…ç½®å…ƒç´ 

å®šåˆ¶å…ƒç´ è§„èŒƒä¸º[æä¾›å®šåˆ¶å†…ç½®å…ƒç´ ](https://html.spec.whatwg.org/multipage/custom-elements.html#customized-built-in-element)ã€‚ä½œä¸ºå‚è€ƒï¼Œå®šåˆ¶çš„å†…ç½®å…ƒç´ çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:

```
<script>
  customElements.define(
    'lazy-image',
    class LazyImage extends HTMLImageElement {/*...*/},
    { extends: 'img' }
  );
</script>

<img is="lazy-image"/> 
```

Enter fullscreen mode Exit fullscreen mode

è¿™çœ‹èµ·æ¥å¾ˆæ£’ï¼Œå¯ä»¥è§£å†³è®¸å¤šä¸å¯è®¿é—®æ€§ç›¸å…³çš„é—®é¢˜ï¼Œä½†æ˜¯åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œè‹¹æœçš„å®˜æ–¹ç«‹åœºæ˜¯ä»–ä»¬ä¸ä¼šå®ç°å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬å°†æš‚æ—¶ç¼–å†™è‡ªä¸»å®šåˆ¶å…ƒç´ ã€‚

### æ— éšœç¢è‡ªä¸»å…ƒç´ 

å› ä¸ºæˆ‘ä»¬çš„ç»„ä»¶åŒ…è£…äº†`<img>`å…ƒç´ ï¼Œè€Œä¸æ˜¯æ‰©å±•å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥å°½é‡ä½¿æ‰€æœ‰çš„åŒ…è£… DOM å¯¹å±å¹•é˜…è¯»å™¨é€æ˜ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†æ›´æ–°èµ·å§‹æ ‡è®°ï¼Œä»¥ä¾¿å ä½ç¬¦æ˜¾ç¤ºåœ¨ a11y æ ‘ä¸­ï¼Œè€Œä¸æ˜¯å›¾åƒä¸­ã€‚

```
<div id="placeholder" aria-hidden="false" role="presentation">
  <slot name="placeholder"></slot>
</div>

<img id="image" aria-hidden="true"/> 
```

Enter fullscreen mode Exit fullscreen mode

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è®¾ç½®`presentation`è§’è‰²ï¼Œä»¥ä¾¿å±å¹•é˜…è¯»å™¨å¿½ç•¥æˆ‘ä»¬å…ƒç´ çš„åŒ…è£…ï¼Œè€Œæ”¯æŒå®ƒçš„å†…å®¹ã€‚

```
connectedCallback() {
  // Remove the wrapping `<lazy-image>` element from the a11y tree.
  this.setAttribute('role', 'presentation');
  /* etc. */
  this.shadowPlaceholder = this.shadowRoot.getElementById('placeholder');
} 
```

Enter fullscreen mode Exit fullscreen mode

æœ€åï¼Œä¸€æ—¦å›¾åƒåŠ è½½ï¼Œæˆ‘ä»¬å°†äº¤æ¢é˜´å½±å›¾åƒå’Œå ä½ç¬¦ä¸Šçš„`aria-hidden`å±æ€§ã€‚

```
setIntersecting() {
  /* etc. */
  this.shadowImage.setAttribute('aria-hidden', 'false')
  this.shadowPlaceholder.setAttribute('aria-hidden', 'true')
} 
```

Enter fullscreen mode Exit fullscreen mode

ç°åœ¨æˆ‘ä»¬çš„ a11y æ ‘éå¸¸æ¼‚äº®æ•´æ´ï¼Œæˆ‘ä»¬çš„å±å¹•é˜…è¯»å™¨ç”¨æˆ·ä¸ä¼šè¢«æ— å…³çš„ DOM æ‰€å›°æ‰°ã€‚

[![accessibility tree screenshot showing one button and two graphics](../Images/da7b953eb68a9aed7e3395c8aab8d0c2.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--qDEJDcuJ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/xom3p4i5xruc4w49xp1c.png)

[https://glitch.com/embed/#!/embed/cream-art?previewSize=100&path=index.html](https://glitch.com/embed/#!/embed/cream-art?previewSize=100&path=index.html)

é»‘ä»”ã€‚è¿™æ˜¯æˆ‘ä»¬çš„å®Œæ•´æ¨¡å—:

```
const isIntersecting = ({isIntersecting}) => isIntersecting;

const tagName = 'lazy-image';
const template = document.createElement('template');
template.innerHTML = `
  <style>
    :host {
      position: relative;
    }

    #image,
    #placeholder ::slotted(*) {
      position: absolute;
      top: 0;
      left: 0;
      transition:
        opacity
        var(--lazy-image-fade-duration, 0.3s)
        var(--lazy-image-fade-easing, ease);
      object-fit: var(--lazy-image-fit, contain);
      width: var(--lazy-image-width, 100%);
      height: var(--lazy-image-height, 100%);
    }

    #placeholder ::slotted(*),
    :host([intersecting]) #image {
      opacity: 1;
    }

    #image,
    :host([intersecting]) #placeholder ::slotted(*) {
      opacity: 0;
    }
  </style>
  <div id="placeholder" aria-hidden="false">
    <slot name="placeholder"></slot>
  </div>
  <img id="image" aria-hidden="true"/>
`;

window.ShadyCSS && window.ShadyCSS.prepareTemplate(template, tagName);

class LazyImage extends HTMLElement {
  /**
   * Guards against loops when reflecting observed attributes.
   * @param  {String} name Attribute name
   * @param  {any} value
   * @protected
   */
  safeSetAttribute(name, value) {
    if (this.getAttribute(name) !== value) this.setAttribute(name, value);   
  }

  static get observedAttributes() {
    return ['src', 'alt'];
  }

  /**
   * Image URI.
   * @type {String}
   */
  set src(value) {
    this.safeSetAttribute('src', value);
    if (this.shadowImage && this.intersecting) this.shadowImage.src = value;
  }

  get src() {
    return this.getAttribute('src');
  }

  /**
   * Image alt-text.
   * @type {String}
   */
  set alt(value) {
    this.safeSetAttribute('alt', value);
    if (this.shadowImage) this.shadowImage.alt = value;
  }

  get alt() {
    return this.getAttribute('alt');
  }

  set intersecting(value) {
    if (value) {
      this.shadowImage.onload = this.setIntersecting;
      this.shadowImage.src = this.src;
      this.disconnectObserver();
    } else {
      this.removeAttribute('intersecting');
    }
  }

  /**
   * Whether the element is on screen.
   * @type {Boolean}
   */
  get intersecting() {
    return this.hasAttribute('intersecting');
  }

  constructor() {
    super();
    this.observerCallback = this.observerCallback.bind(this);
    this.setIntersecting = this.setIntersecting.bind(this);
  }

  connectedCallback() {
    this.setAttribute('role', 'presentation');
    this.updateShadyStyles();
    if (!this.shadowRoot) {
      this.attachShadow({mode: 'open'});
      this.shadowRoot.appendChild(template.content.cloneNode(true));
      this.shadowImage = this.shadowRoot.getElementById('image');
      this.shadowPlaceholder = this.shadowRoot.getElementById('placeholder');
      this.src = this.getAttribute('src');
      this.alt = this.getAttribute('alt');
      this.placeholder = this.getAttribute('placeholder');
    }
    if ('IntersectionObserver' in window) this.initIntersectionObserver();
    else this.intersecting = true;
  }

  attributeChangedCallback(name, oldVal, newVal) {
    this[name] = newVal;
  }

  disconnectedCallback() {
    this.disconnectObserver();
  }

  /**
   * When the polyfill is at play, ensure that styles are updated.
   * @protected
   */
  updateShadyStyles() {
    window.ShadyCSS && window.ShadyCSS.styleElement(this);
  }

  /**
   * Sets the intersecting attribute and reload styles if the polyfill is at play.
   * @protected
   */
  setIntersecting(event) {
    this.shadowImage.removeAttribute('aria-hidden');
    this.shadowPlaceholder.setAttribute('aria-hidden', 'true');
    this.setAttribute('intersecting', '');
    this.updateShadyStyles();
  }

  /**
   * Sets the `intersecting` property when the element is on screen.
   * @param  {[IntersectionObserverEntry]} entries
   * @protected
   */
  observerCallback(entries) {
    if (entries.some(isIntersecting)) this.intersecting = true;
  }

  /**
   * Initializes the IntersectionObserver when the element instantiates.
   * @protected
   */
  initIntersectionObserver() {
    if (this.observer) return;
    // Start loading the image 10px before it appears on screen
    const rootMargin = '10px';
    this.observer = new IntersectionObserver(this.observerCallback, { rootMargin });
    this.observer.observe(this);
  }

  /**
   * Disconnects and unloads the IntersectionObserver.
   * @protected
   */
  disconnectObserver() {
    this.observer.disconnect();
    this.observer = null;
    delete this.observer;
  }
}

const register = () => customElements.define(tagName, LazyImage);
window.WebComponents ? window.WebComponents.waitFor(register) : register(); 
```

Enter fullscreen mode Exit fullscreen mode

é€šè¿‡ä» [npm](https://www.npmjs.com/package/@power-elements/lazy-image) å®‰è£…æˆ–è€…ä» [unpkg](https://unpkg.com/@power-elements/lazy-image/lazy-image.js) åŠ è½½ï¼Œä½ å¯ä»¥åœ¨ä½ çš„é¡¹ç›®ä¸­ä½¿ç”¨`<lazy-image>`ã€‚

```
npm i -S @power-elements/lazy-image 
```

Enter fullscreen mode Exit fullscreen mode

```
<script type="module" src="https://unpkg.com/@power-elements/lazy-image/lazy-image.js"></script> 
```

Enter fullscreen mode Exit fullscreen mode

æ¬¢è¿åœ¨ GitHub ä¸ŠæŠ•ç¨¿ã€‚

## ç»“è®º

æˆ‘ä»¬å·²ç»å®Œæˆäº†æˆ‘ä»¬çš„ç›®æ ‡ï¼Œç¼–å†™äº†ä¸€ä¸ªå…‰æ»‘çš„ã€å¯é‡ç”¨çš„ã€å¯è®¿é—®çš„ã€æ— ä¾èµ–æ€§çš„ã€å•æ–‡ä»¶çš„ã€å»¶è¿ŸåŠ è½½çš„å›¾åƒç»„ä»¶ã€‚è€Œä¸”åªå‹ç¼©äº† 1.94kbï¼Œæ€»å…± 4.50kbã€‚æˆ‘ä»¬å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ

### é¦™è‰æˆåˆ†åˆ©å¼Š

| èµæˆçš„æ„è§ | éª—å±€ |
| --- | --- |
| ä¸éœ€è¦ä¾èµ–ã€‚æ‚¨çš„ä»£ç æ˜¯é¢å‘æœªæ¥çš„ï¼Œå› ä¸ºå®ƒåŸºäº web æ ‡å‡†è€Œä¸æ˜¯åº“å˜åŠ¨ã€‚ | ä½ éœ€è¦æä¾›è‡ªå·±çš„åŠ©æ‰‹ã€‚å°†å±æ€§ä¸å±æ€§åŒæ­¥å¯èƒ½ä¼šå˜å¾—å¾ˆéº»çƒ¦ã€‚ |
| å› ä¸ºä¸éœ€è¦é¢å¤–çš„åº“ä»£ç å¾€è¿”ï¼Œæ‰€ä»¥åŠ è½½å ç”¨ç©ºé—´å° | 0-dep ç»„ä»¶ä¸åˆ©ç”¨ mixins æˆ–åŠ©æ‰‹åº“æ¥å‡å°‘å¤§å‹é¡¹ç›®ä¸­çš„æ–‡ä»¶å¤§å°ã€‚ |
| ä¸éœ€è¦å­¦ä¹ ã€ç»´æŠ¤æˆ–é€‚åº”éæ ‡å‡†çš„ APIã€‚åªæ˜¯ç½‘ç»œè€Œå·²ã€‚ | ä½çº§ web åŸè¯­æœ‰æ—¶ä¼šå¾ˆéº»çƒ¦ã€‚ |
| ä½çº§åˆ«çš„æƒåŠ›ç»™ä½ æ§åˆ¶å’Œçµæ´»æ€§ã€‚æ‚¨å¯ä»¥æŒ‰ç…§è‡ªå·±çš„æ„æ„¿åˆ†è§£ç»„ä»¶ã€‚ | æ‚¨å¿…é¡»å°½åŠ›æ”¯æŒ polyfill æµè§ˆå™¨ï¼Œè€Œæœ‰äº†åº“ï¼Œpolyfill çš„é™åˆ¶å’Œå·²çŸ¥é—®é¢˜éƒ½è¢«æŠ½è±¡æ‰äº†ã€‚ |

è‡ªå·±å·è‚¯å®šæœ‰åˆ©æœ‰å¼Šã€‚çœ‹èµ·æ¥æˆ‘ä»¬å¯ä»¥å¤§è‡´ç¡®å®šè¿™ä¸ªä¸€èˆ¬è§„åˆ™:å¦‚æœæ‚¨æ­£åœ¨æ„å»ºä¸€ä¸ªç®€å•çš„ã€å¯é‡ç”¨çš„ã€ç‹¬ç«‹çš„å®šåˆ¶å…ƒç´ æ¥å…¬å¼€ä¸€äº›ç‰¹å®šçš„åŠŸèƒ½ï¼›é¦™è‰æ˜¯ä¸é”™çš„é€‰æ‹©ï¼›ä½†æ˜¯å¯¹äºæ›´å¤§çš„é¡¹ç›®å’Œå›¢é˜Ÿæ¥è¯´ï¼Œåº“(ç°æˆçš„æˆ–å®šåˆ¶çš„)çš„å¥½å¤„å¾ˆå¿«å°±ä¼šæ˜¾ç°å‡ºæ¥ã€‚

éœ€è¦è€ƒè™‘çš„ä¸€ä»¶äº‹æ˜¯ï¼Œä¸€äº›æ¡†æ¶å®æ–½ç»Ÿä¸€æ€§ã€‚å¯¹äºä¸€äº›å›¢é˜Ÿæ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªä¼˜åŠ¿ï¼Œä½†æ˜¯ç»„ä»¶æ¨¡å‹å…è®¸è„±ç¦»çš„å›¢é˜Ÿç‹¬ç«‹åœ°å¤„ç†æ›´å°çš„æŠ½è±¡ï¼ŒåŒæ—¶å¯¹æ›´å¤§çš„å›¢é˜Ÿéšè—é‚£äº›ç§ç±»çš„å®ç°ç»†èŠ‚ã€‚åœ¨ä»»ä½•å¤§å‹é¡¹ç›®ä¸­ï¼Œåœ¨ä¸ºä¸€ä¸ªç»„ä»¶æˆ–ä¸€ç»„ç»„ä»¶é€‰æ‹©é€‚å½“çš„æŠ½è±¡çº§åˆ«æ—¶ï¼Œéƒ½å¿…é¡»è€ƒè™‘è¿™äº›äº‹æƒ…ã€‚

åœ¨æ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢ä¸€äº›åº“ã€å·¥å…·å’Œä¼˜åŒ–ç­–ç•¥ï¼Œå®ƒä»¬å¯ä»¥ç®€åŒ–æ‚¨çš„ web ç»„ä»¶å¼€å‘è¿‡ç¨‹å’Œåº”ç”¨ç¨‹åºæ€§èƒ½ã€‚æˆ‘ä»¬ä» <abbr title="originally grokked">OG</abbr> web ç»„ä»¶åº“å¼€å§‹:èšåˆç‰©ã€‚

è§ä½ ä¾¿äº†

æ‚¨æƒ³å°±æ­¤å¤„æ¶‰åŠçš„ä»»ä½•ä¸»é¢˜è¿›è¡Œä¸€å¯¹ä¸€çš„è¾…å¯¼å—ï¼Ÿ[![Contact me on Codementor](../Images/97f0e0737ce864c47f2412396b01e737.png)T2ã€‘](https://www.codementor.io/bennyp?utm_source=github&utm_medium=button&utm_term=bennyp&utm_campaign=github)

## é¸£è°¢

æ„Ÿè°¢ John Teagueã€Westbrook Johnsonã€ [@ruphin](https://github.com/ruphin) ã€Matt Gawarecki å’Œ Daniel Turner çš„å»ºè®®å’Œæ›´æ­£ï¼Œæ’åä¸åˆ†å…ˆåã€‚

## å‹˜è¯¯è¡¨

*   10 æœˆ 5 æ—¥ï¼Œè¾¹ç¼˜é˜Ÿ(ï¼)[æå‡ºäº†è‡ªå·±ç‰ˆæœ¬çš„ HTML æ¨¡å—](https://github.com/w3c/webcomponents/blob/gh-pages/proposals/html-modules-proposal.md)
*   è‡ªä»è¿™ç¯‡æ–‡ç« å‘è¡¨ä»¥æ¥ï¼Œ[å¾®è½¯å·²ç»å¼€å§‹åœ¨ Edge](https://developer.microsoft.com/en-us/microsoft-edge/platform/status/customelements/) ä¸­å¼€å‘ web ç»„ä»¶æ ‡å‡†ã€‚æ´¾å¯¹æ—¶é—´ï¼

æŸ¥çœ‹æœ¬ç³»åˆ—çš„ä¸‹ä¸€ç¯‡æ–‡ç« 

[![bennypowers](../Images/57370d6f6dab8d6651a3f138a1aaaa40.png)](/bennypowers) [## è®©æˆ‘ä»¬æ„å»º Web ç»„ä»¶ï¼ç¬¬ 4 éƒ¨åˆ†:èšåˆç‰©åº“

### æœ¬å°¼Â·é²å°”æ–¯ğŸ‡®ğŸ‡±ğŸ‡¨ğŸ‡¦10 æœˆ 14 æ—¥ 1816 åˆ†é’Ÿé˜…è¯»

#webcomponents #customelements #polymer #javascript](/bennypowers/lets-build-web-components-part-4-polymer-library-4dk2)