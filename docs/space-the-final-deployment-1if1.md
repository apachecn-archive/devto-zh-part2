# 太空，最终部署！

> 原文：<https://dev.to/phlash/space-the-final-deployment-1if1>

这是一篇故事格式的文章，讲述了从 2013 年的 FUNcube-1 (AO-73)到现在的 JY1SAT (JO-97，2018 年 12 月 3 日发射-终于！).

【编辑补充】澳大利亚接收到的 JY1SAT 信号，我们又多了一个工人！[http://data.amsat-uk.org/ui/jy1sat-fm](http://data.amsat-uk.org/ui/jy1sat-fm)

首先，开发航天器软件需要大量技术娴熟、经验丰富的专业人员，我认为工作卫星的功劳很小:)

## 开发团队

[FUNcube 团队](https://funcube.org.uk/overview/the-developers_/)，特别针对空间段软件:

*   邓肯·希尔斯(m 6 uck)——主角:经验丰富的黑客、不懈的工作者、实用性专家、LED 发烧友..
*   沃特·威格拉尔(pa 3 weg)——敲钟人:白天是一个温文尔雅的太空技术公司雇员，晚上是一个 AMSAT-NL 的家伙！
*   Gerard a albers——专业人士:目光锐利的评论家、标准执行者、bug 猎人、难题解决者和镇定自若的家伙。
*   Howard Long(G6LVB)-SDR 向导:算法创建者、微芯片 PIC 滥用者、RF 工程师、花式示波器所有者。
*   Jason Flynn(G7OCD)——硬件大师:PCB 布局向导、飞思卡尔 blagger、KISS guy、看门狗分层迷、Verilog 神。
*   菲尔阿什比(M6IPX) -我，麻烦制造者:愚蠢的想法，原型，失败快速突破，仓库监护人，大嘴巴。

## TL；速度三角形定位法(dead reckoning)

当设计、创建和测试卫星软件时，应用一些规则来保持你的理智:

*   保持简单愚蠢(吻)，
*   明智地使用你的语言，我们试图应用美国宇航局 JPL 编码标准 C
*   像逻辑分析仪一样追踪一切。从太空)，
*   内置远程调试功能(您将需要它们)，
*   一次创建一个经过测试的特性(敏捷行为驱动的设计)，
*   使用等幂，绝对命令，没有切换。
*   如果你认为已经完成了，再测试一次(外部变量太多)，
*   使用发光二极管卢克，因为闪光灯很有趣！

## 必修图

这就是它的工作方式..

[![FUNcube MCU software](../Images/71f141a12f5b2b98213fe776df35d01e.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--4M5MF7-_--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://ashbysoft.com/assets/FUNcube-MCU-software.png)

## 有点背景

更多信息请访问 FUNcube 网站。

AMSAT-UK 和 AMSAT-NL 于 2009 年开始开发一颗新卫星，我们的同事 Jason 是 AMSAT-UK 的成员，他自愿设计和开发指挥、控制和遥测(CCT)板，因为他以前有过其他卫星设计工作的经验。CCT 提供了“大脑”,允许地面操作员控制卫星，并从机载传感器收集大量遥测数据用于教育目的。有条件现金转移必须达到一些目标:

*   [功能规格](https://funcube.org.uk/space-segment/cct-board/):)
*   低功率(低于 100mW)，我们希望所有的果汁发射机。
*   故障安全是 Cubesat 法规的一部分，用于保护其他系统免受干扰，我们不能“耍流氓”。
*   持久存储，以满足我们随时保持历史数据可用的教育需求。
*   弹性，特别是在外围设备故障和电池耗尽时。
*   低维护，需要继续做它最后被告知的事情，而不需要地面的大量命令。

随着硬件设计的进行，Jason 请 Duncan 和我帮助开发软件，因为 AMSAT-UK / AMSAT-NL 不确定可用的开发时间(发射时间表对立方体卫星来说是棘手的事情)，并希望确保 CCT 在发射前得到充分测试。

那么，当有人问你“你愿意写代码去太空吗？”时，你会怎么回答呢？- **地狱耶！**

## 那么我们在编程什么呢？

CCT 硬件由两层设计组成(我提到过 Jason 喜欢层吗？):

*   一个可编程逻辑芯片(CPLD)，它的逻辑刚刚够:解码一个简单的命令协议(抱歉，我们不能讨论细节！2)使其它部分能够打开/关闭；提供一个数模转换器(DAC ),用于调制下行无线电。这是一个木链 CoolRunner-II。
*   微控制器(MCU ),用于:收集遥测数据，将其编码为用于 DAC /调制器的音频信号；解码和实现提供大部分功能规范的更复杂的命令。这是一款飞思卡尔(现为恩智浦)HCS08 系列 8 位器件，具有 **128k 的内存块**、 **6k 的内存块**和一条 16 位地址总线。它的最大时钟速度为 40MHz。

这些器件的选择考虑到了适当的 I/O 能力(例如 I2C、SPI)、低功耗(例如:无外部振荡器)、以前的设计经验以及可用的工具(例如:Code Warrior 免费版)。

## 从哪里开始？

Jason 专注于硬件和 CPLD，这是他的专业领域，也是故障安全设计的关键部分，需要在早期得到验证。虽然我很想通过 Verilog 与您交流，但这不是我的技能所在，让我们假设一切正常，尽管 DAC 很有挑战性:)

邓肯和我接手了 MCU:

*   与 Jason 一起定义与 CPLD 的接口协议，包括看门狗机制(我提到过 Jason 喜欢看门狗吗？)、接收命令传输和 DAC 样本输出。
*   与 Howard 合作嵌入数据编码和前向纠错(FEC)软件:我们使用 Phil Karn (KA9Q)、James Millar (G3RUH)等人为早期 AMSAT 航天器 Oscar-40(通常称为 [AO-40 FEC](http://www.amsat.org/amsat/articles/g3ruh/125.html) )创建的方案的变体
*   与 Gerard 合作，确保符合 Cubesat &编码标准，操作安全可靠。
*   与 Wouter 合作，确保正确的无线电调制和接收(Wouter 也是射频设计团队的成员)。
*   与多个集成电路(I2C)设备进行通信，用于遥测数据和其他目的。
*   通过串行外设接口(SPI)管理持久性铁电随机存取存储器设备(FRAM)。
*   通过内置模数转换器(ADC)对多个本地模拟输入引脚进行采样，以实现更多遥测。
*   控制航天器的部署:飞行前移除开关，发射延迟和天线。

我有没有提到我们的卫星电源有一个看门狗，我们需要在 I2C 重新设置，否则它会把一切都关掉再打开？似乎不能有太多的看门狗...

## 我们可以计时吗？

按照现代人的期望，我们有一个微型 MCU，它不比快速的 6805 或 Z80 大多少，它能做我们需要的所有事情吗？我们可以降低时钟频率(没错，欠频！)为了省电，我们需要走多快？

我们选择研究所需的动作、输入和输出的时序要求以及处理负载(周期计数)，以找出:

*   动作是有规律的事情:每个传感器的数据收集时间表(1/5/60 秒)，将数据打包成帧并编码以便传输，给定时钟，状态机和顺序代码可以很好地处理这些事情。
*   输入的定时并不重要:命令是异步的，响应时间以秒计，遥测数据收集是按时间表进行的，重复性比绝对采样定时更重要。
*   输出的时序变得更加严格，因为我们正在生成 9600Hz 的音频样本，必须精确到几微秒，并且遥测帧需要连续发送。
*   在数据收集期间，处理负载(以 CPU 周期衡量-由原型和时钟计数确定)最小，但是应用 FEC 需要大量工作，不能中断其他活动。

一旦我们对处理负载有了一个概念，我们就可以选择一个时钟频率，在保持低功率水平的同时给我们提供良好的余量——我们最终得到了 **14MHz** 和 **50mW** 的估计功耗，周期数是我们预期使用的两倍。

我们的 MCU 也有一个特定的省电等待指令，它会暂停 CPU 时钟，直到一个中断将其唤醒，所以通过设计繁忙等待/轮询，我们应该节省更多的功率-我们可以计时吗？是的，我们可以。

## 一个 OS 会有帮助吗？

在互联网上搜索 MCU 操作系统，可以找到像 FreeRTOS、CMX-TINY 或 uC/OS-II 这样的库。有了 RAM，这些通常可以挤进一个带有抢占、消息队列和定时器的任务管理器。

我们需要这些功能吗？我们想调试第三方 RTOS 代码吗？

应用 KISS 原则:我们选择避免复杂的、不确定的事情，如内存管理器、任务抢占/调度、优先级队列等。因为我们觉得我们的挑战可以在很大程度上由一个状态机和一些仔细的时间安排来应对。此外，我们还必须自己提供所有的设备驱动程序，所以第三方操作系统实际上帮助不大。我们选择使用裸 MCU 和工具提供的器件库(感谢 Metroworks/Freescale/NXP！)

## 事件循环&缓冲区

我们能够满足实时音频输出定时的唯一方法是在来自硬件定时器的中断下。有了这个中断，我们就有办法从等待指令中“唤醒”MCU，并通过共享变量中的一个位向它提供定时事件(实际上是 100 毫秒的脉冲)。这导致了一种设计，其中主循环是单线程事件处理器，调度定时或其他输入数据事件，在中断下传递以避免繁忙等待。在处理事件时，我们还重置了各种监视器，这允许它们检测/纠正唤醒机制中的任何故障。

见上图:)

我们的其他挑战是连续遥测和在足够的周期内应用 FEC。这些可以通过双缓冲遥测数据来满足，因此我们在编码下一帧的同时，在中断下发送一个处理过的帧作为音频输出。这增加了远程测量的延迟(一帧，5 秒)，但允许我们在一个帧周期内展开 FEC 处理，按照可预测的时间表插入突发活动。

双缓冲消耗了我们 RAM 的一大块(每个帧缓冲区是 650 字节)，在许多情况下，我们不得不重新安排变量或重构代码来删除它们，以便将所有内容放回 6k！

## 坚持不懈，坚韧不拔&意志薄弱

(几乎)所有的事件。我说过我们喜欢看门狗吗？我们的 MCU 有一个内部复位看门狗，我们很早就使能了它，必须每隔 125 毫秒清除一次。这给了我们信心，如果事情变得非常糟糕，我们在处理事件时死锁或旋转，我们会重新启动。我们利用这一点在执行 I/O 时检测坏设备，方法是在收集前存储设备 ID，并在重启时检查看门狗超时(它有效地告诉我们它必须重启 MCU)，然后检查设备 ID，如果找到，则在下一次执行时排除该设备(不过，接地命令可以重置此状态以重试失败的设备)。

我们也不太相信 RAM 会在电源故障(掉电)期间保持其值，这很可能是因为电池随着时间的推移而失去容量，因此所有重要的数据结构都有一个循环冗余校验(CRC ),在重新启动时进行检查。如果失败，我们可以采取适当的行动，要么重置为默认值，要么从持久 FRAM 获得备份。我们也检查了 FRAM 的内容——太空中有宇宙射线会破坏存储！

对于低维护需求，我们为所有系统配置结构提供了 FRAM 存储，并在重启时恢复它们，如上所述。

## 调试、跟踪和避免切换

当嵌入式设备放在你面前的桌子上时，调试它真的很容易——连接编程盒并在你的 IDE 中点击 F5。正因为如此，我们最初关于使用串口作为调试控制台的想法被放弃了，当有更好的工具可用时，这是不值得的。然而，一旦使用无法连接 pod 的人造卫星，我们发现备用 I/O 引脚上的一堆 led 非常有用，您可以显示关键状态位/重要转换(如启动事件循环)并查看计时心跳。

一旦超出 pod 或可见范围(也称为空间范围)，我们需要一种方法来检查内部状态/操纵外设/跟踪执行，因此我们包括了一些调试命令，允许内存块转储、I2C 总线事务，并可以硬重置 CCT。

我们在这方面最喜欢的特性是执行跟踪——基于硬件逻辑分析器的设计，我们在执行期间将短消息(2-4 个字符)写入跟踪缓冲区，并将该缓冲区包括在常规遥测输出中，总是从最近的消息开始，并及时返回。这使我们能够在每次复位时看到启动逻辑流或识别不寻常的数据输入，让我们有机会重现不寻常的条件，并在仍然触手可及的本地工程模型上进行调试！

从远程调试中，我们学会了永远不要使用“切换”命令，这是不安全的，也很难确定命令是否有效，你必须试着读回新旧状态来比较它们...最好总是设置一个特定的状态，并有一个命令确认方案(我们使用命令计数器)。这使得命令幂等，允许通过多次重新发送同一个命令来盲目命令(也就是对着你的卫星大喊大叫！)，如果命令是“展开天线”就非常有用...

**鳍**