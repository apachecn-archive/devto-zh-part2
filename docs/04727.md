# ä½¿ç”¨ Caddy ä¿æŠ¤ OAuth2 æä¾›è€…èƒŒåçš„å†…éƒ¨æœåŠ¡

> åŸæ–‡:[https://dev . to/Kamal n7/securing-internal-services-behind-an-oauth 2-provider-with-caddy-49nk](https://dev.to/kamaln7/securing-internal-services-behind-an-oauth2-provider-with-caddy-49nk)

<small>æœ€åæ›´æ–°äº 2019 å¹´ 3 æœˆ 1 æ—¥</small>

åœ¨ä¸‹é¢çš„è§†é¢‘ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°`secret.int.localtest.me`åœ¨ Google OAuth2 ç™»å½•ä¹‹åæ˜¯å®‰å…¨çš„ã€‚æœªç»èº«ä»½éªŒè¯çš„è¯·æ±‚è¢«é‡å®šå‘åˆ°ç™»å½•é—¨æˆ·`auth.int.localtest.me`ï¼Œè¯¥é—¨æˆ·è¦æ±‚ç”¨æˆ·ä½¿ç”¨ Google ç™»å½•ã€‚æœ‰äº†è¿™ä¸ªï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹`int.localtest.me`ä¸‹çš„æ‰€æœ‰ç«™ç‚¹è¿›è¡Œä¸€æ¬¡è®¤è¯ã€‚

[https://www.youtube.com/embed/EMr-eLJdYhE](https://www.youtube.com/embed/EMr-eLJdYhE)

`localtest.me`åŠå…¶ä»»ä½•å­åŸŸè§£æä¸º`127.0.0.1`ã€‚è¿™ä½¿å¾—æµ‹è¯•æœ¬åœ°æœåŠ¡æ›´åŠ å®¹æ˜“ã€‚è¿™ä»…ä¸è§†é¢‘æ¼”ç¤ºç›¸å…³ã€‚

## ğŸ¤”è¿™æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

åœ¨åå°ï¼Œä½¿ç”¨ JWT ä»¤ç‰Œå¤„ç†èº«ä»½éªŒè¯ï¼Œè¿™äº›ä»¤ç‰Œåœ¨`int.localtest.me`ä¸»æœºåä¸Šè®¾ç½®ä¸º cookiesï¼Œä½¿å®ƒä»¬å¯¹æ‰€æœ‰å­åŸŸå¯ç”¨ã€‚å¯¹ç»è¿‡èº«ä»½éªŒè¯çš„ URL çš„æ¯ä¸ªè¯·æ±‚éƒ½ä¼šæ£€æŸ¥ JWT ä»¤ç‰Œã€‚è¿™æ˜¯ç”±[æ’ä»¶](https://caddyserver.com/docs/http.jwt)å¤„ç†çš„ã€‚

ç™»å½•é—¨æˆ·ä½¿ç”¨ [`http.loginsrv`æ’ä»¶](https://caddyserver.com/docs/http.login)æä¾›æœåŠ¡ï¼Œè¯¥æ’ä»¶æ˜¯ç»‘å®šåˆ° [tarent/loginsrv](https://github.com/tarent/loginsrv) çš„åŠ©æ‰‹ã€‚

## ğŸ› æˆ‘è¯¥å¦‚ä½•è®¾ç½®è¿™ä¸ªï¼Ÿ

â„¹ï¸**2019 å¹´ 3 æœˆ 1 æ—¥æ›´æ–°**ç”±äº Google+è¢«å¼ƒç”¨ï¼Œä¸å†éœ€è¦å¯ç”¨å…¶ API å’Œ OAuth èŒƒå›´ã€‚æˆ‘å·²ç»åˆ é™¤äº†ä¸‹é¢ç›¸å…³çš„éƒ¨åˆ†ã€‚

æˆ‘ä»¬å°†å‡è®¾å¦‚ä¸‹:

*   æ‰€æœ‰å†…éƒ¨æœåŠ¡éƒ½æ‰˜ç®¡åœ¨`*.int.domain.tld`
*   ç™»å½•é—¨æˆ·å°†åœ¨`login.int.domain.tld`æä¾›æœåŠ¡
*   OAuth2 æä¾›è€…æ˜¯ Googleï¼Œå®ƒæœ‰ä¸€ä¸ªæ‰¹å‡†çš„ç”µå­é‚®ä»¶åœ°å€åˆ—è¡¨
*   Caddy ç”¨ä½œæ‰€æœ‰å†…éƒ¨æœåŠ¡çš„å‰ç«¯ä»£ç†æˆ– web æœåŠ¡å™¨

### ğŸ”“åŸºç¡€ä¸å®‰å…¨ç¯å¢ƒ

æˆ‘ä»¬å°†ä»å…¬å¼€çš„å†…éƒ¨æœåŠ¡å¼€å§‹:

`Caddyfile`

```
secret.int.domain.tld {
    ...
} 
```

Enter fullscreen mode Exit fullscreen mode

### ğŸ“¸å®‰è£… Caddy æ’ä»¶

ğŸ‘‹ğŸ¼**æˆ‘æ›´å–œæ¬¢åœ¨ Docker å®¹å™¨ä¸­è¿è¡Œ Caddyã€‚ä½†æ˜¯ï¼Œä½ ä¸å¿…ï¼**æ‚¨å¯ä»¥è·³è¿‡è¿™ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯è¦ç¡®ä¿æ‚¨çš„ Caddy äºŒè¿›åˆ¶æ–‡ä»¶å·²ç»ç¼–è¯‘äº†`http.jwt`å’Œ`http.login`æ’ä»¶ã€‚ä½ å¯ä»¥è‡ªå·±ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæˆ–è€…ä»[çƒç«¥ç½‘ç«™](https://caddyserver.com/download)ä¸‹è½½ä¸€ä¸ªé¢„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç¡®ä¿åŒ…å«æˆ‘æåˆ°çš„æ’ä»¶ã€‚

`abiosoft/caddy`å›¾åƒä¸åŒ…æ‹¬`http.jwt`å’Œ`http.login`æ’ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»ºç«‹è‡ªå·±çš„å›¾åƒã€‚ä¸ºæ­¤ï¼Œè¿è¡Œ:

```
docker build -t caddy-jwt-login --build-arg plugins="jwt,login" github.com/abiosoft/caddy-docker.git 
```

Enter fullscreen mode Exit fullscreen mode

å¦‚æœæ‚¨åœ¨åŒä¸€ä¸ª Caddy å®ä¾‹ä¸Šæ‰˜ç®¡å…¶ä»–ç«™ç‚¹ï¼Œè¯·ç¡®ä¿åŒ…å«æ‚¨å¯èƒ½éœ€è¦çš„ä»»ä½•å…¶ä»–æ’ä»¶ã€‚å¦‚æœå¯¹æ‚¨æœ‰æ„ä¹‰ï¼Œç”¨ä¸åŒçš„æ ‡ç­¾/å›¾åƒåç§°æ›¿æ¢`caddy-jwt-login`ã€‚

è¿™å°†æ˜¯æˆ‘ä»¬çš„ Caddy å®¹å™¨æ‰€åŸºäºçš„å›¾åƒï¼Œè€Œä¸æ˜¯`abiosoft/caddy`ã€‚

ğŸŒŸæˆ‘å·²ç»åˆ›å»ºå¹¶å‘å¸ƒäº†ä¸€ä¸ªæ‚¨å¯ä»¥ä½¿ç”¨çš„å›¾åƒï¼Œä½†æˆ‘ä¸èƒ½ä¿è¯å®ƒæ€»æ˜¯æœ€æ–°çš„ï¼`kamaln7/caddy-jwt-login`ã€‚æˆªè‡³ç›®å‰ï¼Œæœ€æ–°ç‰ˆæœ¬æ˜¯`kamaln7/caddy-jwt-login:0.11.0`ã€‚

### ğŸ”‘è®¾ç½® Google OAuth2 æä¾›ç¨‹åº

ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨ Google ä½œä¸º OAuth2 æä¾›è€…ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¼€å‘äººå‘˜æ§åˆ¶å°ä¸­åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œå¹¶å‘å…¶ä¸­æ·»åŠ ä¸€ä¸ª OAuth2 æœåŠ¡ã€‚é¦–å…ˆåœ¨è¿™é‡Œåˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®[ã€‚](https://console.developers.google.com/projectcreate)

ç„¶åï¼Œæµè§ˆåˆ°[å¼€å‘è€…æ§åˆ¶å°](https://console.developers.google.com/apis/dashboard)ã€‚ç¡®å®šæ‚¨çš„é¡¹ç›®åœ¨å·¦ä¸Šè§’è¢«é€‰å®šã€‚

è½¬åˆ°[å‡­è¯é¡µé¢](https://console.developers.google.com/apis/credentials)ï¼Œå¯ä»å·¦ä¾§è¾¹æ è®¿é—®ã€‚å•å‡»â€œOauth åŒæ„å±å¹•â€é€‰é¡¹å¡ï¼Œå¹¶å¡«å†™â€œåº”ç”¨ç¨‹åºåç§°â€ã€‚

å‘ä¸‹æ»šåŠ¨åˆ°â€œæˆæƒåŸŸâ€ï¼Œå¹¶åœ¨å­—æ®µä¸­è¾“å…¥æ‚¨çš„é¡¶çº§åŸŸå(`domain.tld`)ã€‚ä¿å­˜å¹¶è¿”å›åˆ°â€œèº«ä»½è¯æ˜â€é¡µé¢ã€‚

åœ¨ Credentials é€‰é¡¹å¡ä¸­ï¼Œå•å‡»è“è‰²çš„ Create credentials æŒ‰é’®å¹¶é€‰æ‹© OAuth client IDã€‚

[![screenshot](../Images/b42e09abe34174ec5a3a53e6d84a5e86.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--fO71eJcS--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://kmln.sr/cepfXYu)

åº”ç”¨ç¨‹åºç±»å‹å°†æ˜¯ Web åº”ç”¨ç¨‹åºã€‚éšä½ æ€ä¹ˆå‘½åï¼Œå°†`https://auth.int.domain.tld/login/google`æ·»åŠ åˆ°æˆæƒé‡å®šå‘ URIs åˆ—è¡¨ã€‚**å¡«å†™å®Œå­—æ®µåï¼Œä¸è¦ç«‹å³ç‚¹å‡»åˆ›å»ºã€‚**å•å‡»é¡µé¢ä¸Šçš„ä»»ä½•å…¶ä»–ä½ç½®å°†å…¶æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œç„¶åå•å‡»åˆ›å»ºã€‚æ„šè ¢çš„ UXï¼Œæˆ‘çŸ¥é“ã€‚ä½†è¿™æ˜¯å¿…è¦çš„ã€‚

[![screenshot](../Images/d83ce02f9f318d5f525e5376c1a7c26e.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Pcl0okKT--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://kmln.sr/CcTZauP)

åœ¨æ¥ä¸‹æ¥çš„é¡µé¢ä¸Šï¼Œæ‚¨å°†çœ‹åˆ°ä¸€ä¸ªå¼¹å‡ºçª—å£ï¼Œæ˜¾ç¤ºæ‚¨çš„å®¢æˆ·ç«¯ ID å’Œå¯†ç ã€‚æŠŠå®ƒä»¬ä¿å­˜èµ·æ¥ï¼Œå› ä¸ºæˆ‘ä»¬ä»¥åä¼šéœ€è¦å®ƒä»¬ã€‚

### ğŸŒåˆ›å»ºç™»å½•é—¨æˆ·

å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°æ‚¨çš„ Caddy é…ç½®ä¸­ã€‚å°†`YOURCLIENTID`æ›¿æ¢ä¸ºæ‚¨çš„å®¢æˆ·ç«¯ IDï¼Œå°†`YOURCLIENTSECRET`æ›¿æ¢ä¸ºå¯†ç ã€‚

```
auth.int.domain.tld {
        tls your@email.address
        redir 302 {
                if {path} is /
                / /login
        }

        login {
                google client_id=YOURCLIENTID,client_secret=YOURCLIENTSECRET
                redirect_check_referer false
                redirect_host_file /redirect_hosts.txt
                cookie_domain int.domain.tld
        }
} 
```

Enter fullscreen mode Exit fullscreen mode

è¿™å°†ä½¿ç”¨æ‚¨åˆšåˆšåˆ›å»ºçš„ Google OAuth2 æä¾›ç¨‹åºé…ç½®`http.login`æ’ä»¶ï¼Œåœ¨`int.domain.tld`è€Œä¸æ˜¯`auth.int.domain.tld`ä¸Šè®¾ç½® cookiesï¼Œå¹¶å…è®¸åœ¨`redirect_hosts.txt`æ–‡ä»¶ä¸­é‡å®šå‘åˆ°ä¸»æœºã€‚æ›´å¤šå…³äºä¸‹é¢çš„é‡å®šå‘ã€‚

âœ…:ç°åœ¨ï¼Œå½“ä½ æµè§ˆåˆ°`https://auth.int.domain.tld`ï¼Œä½ å°±å¯ä»¥ç”¨ä½ çš„è°·æ­Œè´¦æˆ·ç™»å½•äº†ã€‚è¯·æ³¨æ„ï¼Œ*ä»»ä½•äºº*éƒ½å¯ä»¥åœ¨è¿™é‡Œç™»å½•ï¼Œä½†ä¸æ˜¯æ¯ä¸ªäººéƒ½å¯ä»¥è®¿é—®å—ä¿æŠ¤çš„æœåŠ¡ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­é™åˆ¶å¯¹ç‰¹å®šç”µå­é‚®ä»¶åœ°å€çš„æœåŠ¡è®¿é—®ã€‚

### ğŸ”ä¿æŠ¤å†…éƒ¨æœåŠ¡

å‰©ä¸‹çš„å°±æ˜¯ä½¿ç”¨`http.jwt`æ’ä»¶æ¥ä¿æŠ¤å†…éƒ¨æœåŠ¡ã€‚æˆ‘ä»¬å°†æŠŠè¿™ä¸ªé…ç½®æå–åˆ°å®ƒè‡ªå·±çš„ä»£ç ç‰‡æ®µä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨å…¶ä»–æœåŠ¡ä¸­é‡ç”¨å®ƒã€‚

`Caddyfile`

```
(int-auth) {
        jwt {
                path /
                redirect https://auth.int.domain.tld/login?backTo=https%3A%2F%2F{host}{rewrite_uri_escaped}
                allow sub your@email.address
                allow sub otherpeson@gmail.com
        }
} 
```

Enter fullscreen mode Exit fullscreen mode

è¿™å°†åœ¨`/`(æ¯ä¸ªè¯·æ±‚)ä¸Šå¯ç”¨ JWT è®¤è¯ï¼Œå¹¶å°†æœªç»è®¤è¯çš„è¯·æ±‚é‡å®šå‘åˆ°æˆ‘ä»¬çš„ç™»å½•é—¨æˆ·ã€‚`backTo`å‚æ•°æŒ‡ç¤ºç™»å½•é—¨æˆ·åœ¨æˆåŠŸç™»å½•æ—¶é‡å®šå‘å›å†…éƒ¨æœåŠ¡ã€‚å¯¹æ‚¨å¸Œæœ›å…è®¸è®¿é—®çš„æ¯ä¸ªç”µå­é‚®ä»¶åœ°å€é‡å¤`allow sub ...`æŒ‡ä»¤ã€‚

ğŸ’­è¿˜è®°å¾—æˆ‘ä»¬è°ˆè¿‡çš„ä¸€ä¸ª`redirect_hosts.txt`æ–‡ä»¶å—ï¼Ÿè¿™å°±æ˜¯å®ƒçš„ç”¨æ­¦ä¹‹åœ°ã€‚è¯¥æ–‡ä»¶å°†åŒ…å«å…è®¸ç™»å½•é—¨æˆ·é‡å®šå‘å›çš„ä¸»æœºåˆ—è¡¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¸å…è®¸`auth.int.domain.tld`ä¹‹å¤–çš„ä»»ä½•å¤–éƒ¨ URLã€‚é€šè¿‡è®¾ç½®`redirect_check_referer false`å¹¶æä¾›ä¸€ä¸ªæ‰¹å‡†çš„ä¸»æœºåˆ—è¡¨ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°†ç”¨æˆ·é‡å®šå‘å›æˆ‘ä»¬çš„å†…éƒ¨æœåŠ¡ã€‚

ä¸ºæ¯ä¸ªå†…éƒ¨æœåŠ¡åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° Docker æ˜ åƒæˆ– Caddy æ­£åœ¨è¿è¡Œçš„ä»»ä½•åœ°æ–¹ã€‚åªè¦ç¡®ä¿åœ¨ä¸Šé¢çš„ Caddy é…ç½®ä¸­æ›´æ–°å®ƒçš„è·¯å¾„å°±è¡Œäº†(`login {}`å—)ã€‚

`redirect_hosts.txt`

```
secret.int.domain.tld
another-service.int.domain.tld 
```

Enter fullscreen mode Exit fullscreen mode

âœ¨æœ€åï¼Œå°†è¿™ä¸ªä»£ç ç‰‡æ®µå¯¼å…¥å†…éƒ¨æœåŠ¡é…ç½®:

`Caddyfile`

```
secret.int.domain.tld {
    import int-auth
    ...
} 
```

Enter fullscreen mode Exit fullscreen mode

### ç°åœ¨æ€ä¹ˆåŠï¼Ÿ

å°±æ˜¯è¿™æ ·ï¼æ‚¨çš„å†…éƒ¨æœåŠ¡é€šè¿‡ç™»å½•é—¨æˆ·å¾—åˆ°ä¿æŠ¤ã€‚

#### å¯é€‰çš„è·¨ Caddy é‡å¯çš„âš¡ä¼šè¯æŒä¹…æ€§

JWT ä»¤ç‰Œä½¿ç”¨ç§˜å¯†è¿›è¡Œç­¾åã€‚è¿™å…è®¸æœåŠ¡å™¨éªŒè¯ä»¤ç‰Œæ²¡æœ‰è¢«ç¯¡æ”¹(è¢«ä»»ä½•æ— æƒè®¿é—®æœºå¯†çš„äººç¯¡æ”¹)ã€‚`http.login` [å¯»æ‰¾å­˜å‚¨åœ¨`JWT_SECRET`ç¯å¢ƒå˜é‡](https://github.com/tarent/loginsrv/blob/e482109fc416fb8678befb27336ab5d08ff10252/caddy/setup.go#L51-L55)ä¸­çš„ç§˜å¯†:

*   å¦‚æœå®ƒå­˜åœ¨ï¼Œå®ƒå°±ä½¿ç”¨å®ƒ
*   å¦åˆ™ï¼Œå®ƒä½¿ç”¨`loginsrv`çš„é»˜è®¤ç§˜å¯†å¹¶æ›´æ–°ç¯å¢ƒå˜é‡ã€‚é»˜è®¤çš„ç§˜å¯†æ˜¯ä¸€ä¸ª[éšæœºç”Ÿæˆçš„å­—ç¬¦ä¸²](https://github.com/tarent/loginsrv/blob/master/login/config.go#L20)

åœ¨éªŒè¯è¯·æ±‚æ—¶ï¼Œ`http.jwt`ä½¿ç”¨`JWT_SECRET`ç¯å¢ƒå˜é‡ã€‚è¿™ä¸€åˆ‡éƒ½å¾ˆå¥½ï¼Œå› ä¸ºé»˜è®¤å¯†ç æ˜¯åœ¨å¯åŠ¨æ—¶éšæœºç”Ÿæˆçš„ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç çš„å­—ç¬¦ä¸²ã€‚ä½†æ˜¯ï¼Œè¿™æ„å‘³ç€å½“ Caddy é‡æ–°å¯åŠ¨æ—¶ï¼Œå¯†ç ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™ä¼šå¯¼è‡´æ‰€æœ‰ç”¨æˆ·è¢«æ³¨é”€ï¼Œå› ä¸ºä»–ä»¬çš„ä»¤ç‰Œä¼šå¤±æ•ˆã€‚

ä¸ºäº†ä½¿ä¼šè¯åœ¨é‡å¯åæŒç»­ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®æˆ‘ä»¬è‡ªå·±çš„å›ºå®šç§˜å¯†ã€‚ä½ å¯ä»¥åœ¨ random.org ä¸Šéšæœºç”Ÿæˆä¸¤ä¸ª 16 ä¸ªå­—ç¬¦é•¿çš„å­—ç¬¦ä¸²[ï¼Œå¹¶å°†å®ƒä»¬æ”¾åœ¨ä¸€èµ·ä½œä¸ºä¸€ä¸ª 32 ä¸ªå­—ç¬¦é•¿çš„ç§˜å¯†ã€‚(æ‚¨éœ€è¦ä¸€ä¸ªä»˜è´¹çš„ random.org å¸æˆ·æ¥ç”Ÿæˆè¶…è¿‡ 20 ä¸ªå­—ç¬¦çš„å­—ç¬¦ä¸²)ã€‚å°†ç¯å¢ƒå˜é‡`JWT_SECRET`è®¾ç½®ä¸ºè¿™ä¸ªä»¤ç‰Œï¼Œå¹¶ä½¿å…¶å¯¹ Caddy å¯ç”¨ã€‚](https://www.random.org/strings/?num=2&len=16&digits=on&upperalpha=on&loweralpha=on&unique=on&format=html&rnd=new)

# ğŸ“šèµ„æº

*   [tart/loginsrv](https://github.com/tarent/loginsrv)
*   [http.login](https://caddyserver.com/docs/http.login) - Caddy æ’ä»¶
*   [http.jwt](https://caddyserver.com/docs/http.jwt) -çƒç«¥æ’ä»¶
*   [loginsrv â† OAuth2](https://github.com/tarent/loginsrv#oauth2)

* * *

æˆ‘å¸Œæœ›ä½ ä»¬éƒ½è§‰å¾—è¿™æœ‰ç”¨ï¼æˆ‘ä¸ªäººå–œæ¬¢å‡¯è’‚ï¼Œæˆ‘æ€»æ˜¯åœ¨å¯»æ‰¾æ–°çš„é…·çš„æ–¹å¼æ¥ä½¿ç”¨å®ƒã€‚æˆ‘æ€»æ˜¯å¾ˆé«˜å…´åœ¨è¯„è®ºä¸­å¬åˆ°ä»»ä½•å½¢å¼çš„åé¦ˆğŸ˜„

*æœ¬æ–‡æœ€åˆå‘è¡¨äº [kamal.io](https://kamal.io/blog/securing-internal-services-behind-oauth2-with-caddy/) ã€‚*