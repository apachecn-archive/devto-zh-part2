# å­˜å‚¨æƒé™(å†æ¬¡)~ AoaH å

> åŸæ–‡:[https://dev.to/link2twenty/storing-permissions-again-aoah-ten-4 fdf](https://dev.to/link2twenty/storing-permissions-again--aoah-ten-4fdf)

# (å†æ¬¡)åœ¨ SQLite æ•°æ®åº“ä¸­å­˜å‚¨æƒé™

## å¼€åœº

ä¸Šå‘¨ï¼Œæˆ‘çœ‹äº†ä½¿ç”¨ SQLite ä½œä¸ºæ•°æ®åº“ï¼Œä¼—æ‰€å‘¨çŸ¥ï¼Œæˆ‘çœŸçš„ä¸çŸ¥é“æˆ‘åœ¨åšä»€ä¹ˆï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé“¾æ¥åˆ°æˆ‘ä»¥å‰çš„å¸–å­ã€‚æˆ‘ä» [@buinauskas](https://dev.to/buinauskas) å’Œ [@tiguchi](https://dev.to/tiguchi) ï¼Œè¿˜æœ‰ [@avalander](https://dev.to/avalander) é‚£é‡Œå¾—åˆ°äº†ä¸€äº›å…³äºå®‰å…¨çš„æœ‰ç”¨è¯„è®ºï¼Œç†æ‰€å½“ç„¶åœ°è´¨ç–‘æˆ‘å¯¹ä¸€ä¸ªç±»çš„ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿçœ‹äº†ä¸€ä¸‹ã€‚

## ![GitHub logo](../Images/a73f630113876d78cff79f59c2125b24.png) [ ignis-pwa ](https://github.com/ignis-pwa) / [æƒé™ _ å¸®åŠ©è€…](https://github.com/ignis-pwa/permissions_helper)

### åˆ›å»ºå’Œä¿®æ”¹ç”¨äºç®¡ç†æƒé™çš„ SQLite æ–‡ä»¶

<article class="markdown-body entry-content container-lg" itemprop="text">

# æƒé™ _ å¸®åŠ©è€…

åˆ›å»ºå’Œä¿®æ”¹ç”¨äºç®¡ç†æƒé™çš„ SQLite æ–‡ä»¶

</article>

[View on GitHub](https://github.com/ignis-pwa/permissions_helper)

## æœ‰å“ªäº›å®‰å…¨é—®é¢˜ï¼Ÿ

æˆ‘å·²ç»å‡†å¤‡å¥½çš„ä»£ç æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯æˆ‘çš„ç¼–ç é£æ ¼æœ‰é—®é¢˜ã€‚æˆ‘ä½¿ç”¨æ¨¡æ¿è‡ªç”±ä¸»ä¹‰è€…å°†å­—ç¬¦ä¸²æ”¾å…¥æŸ¥è¯¢ä¸­ï¼Œè¿™æ„å‘³ç€ä¸€ä¸ªç²¾æ˜çš„ç”¨æˆ·å¯ä»¥æ“çºµä»–ä»¬çš„è¾“å…¥æ¥è·å¾—ä»–ä»¬æƒ³è¦çš„ç»“æœã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘åœ¨ä»–ä»¬çš„ cookies ä¸­æ£€æŸ¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œçœ‹çœ‹ä»–ä»¬æ˜¯å¦ç™»å½•ï¼Œå®ƒå¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·ã€‚

```
function cookieLogin(session_id) {
  user_id = sql.get(`SELECT user_id FROM users_sessions WHERE session_id= "${session_id}"`);
  return user_id || false
} 
```

å“ªå®¶ä¼šè¿™ä¹ˆå«

```
// normal execution
cookieLogin('$2b$09$oGdnXBsnb8QPCJk/VY1JKuxG/QW66K8RB7n01kBhJsbB45nvIK0pK')
// SELECT user_id FROM users_sessions WHERE session_id="$2b$09$oGdnXBsnb8QPCJk/VY1JKuxG/QW66K8RB7n01kBhJsbB45nvIK0pK"

// problematicexecution
cookieLogin('foo" OR user_id="1')
// SELECT user_id FROM users_sessions WHERE session_id="foo" OR user_id="1" 
```

åœ¨æœ‰é—®é¢˜çš„è°ƒç”¨`cookieLogin`ä¸­ï¼Œæˆ‘ä»¬æ€»æ˜¯ä¼šå¾—åˆ° user_id 1ï¼Œä¸éœ€è¦å¯†ç ã€‚

æˆ‘è¢«å‘ŠçŸ¥è¦çœ‹â€œå‡†å¤‡å¥½çš„é™ˆè¿°â€ï¼Œè¿™æ˜¯å†…ç½®åœ¨æˆ‘æ­£åœ¨ä½¿ç”¨çš„`SQLite`åŒ…ä¸­çš„ã€‚SQL æ³¨å…¥ç°åœ¨åªä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ï¼

## ä½ ä¸ºä»€ä¹ˆä½¿ç”¨ä¸€ä¸ªç±»ï¼Ÿ

æˆ‘è®¤ä¸ºè¿™æ˜¯åº”è¯¥åšçš„äº‹æƒ…ï¼ŒAvalander å‘æˆ‘å±•ç¤ºäº†ä»–ä»¬çš„ä¸€äº›é¡¹ç›®ï¼Œåœ¨è¿™äº›é¡¹ç›®ä¸­ï¼Œä»–ä»¬æœ‰å‡½æ•°ï¼Œå¹¶å°†æ•°æ®åº“å¼•ç”¨ä¼ é€’ç»™å‡½æ•°ã€‚è¿™å¯¹æˆ‘æœ‰æ„ä¹‰ï¼Œæ‰€ä»¥æˆ‘ä¸å†ä½¿ç”¨ç±»ï¼Œè‡³å°‘åœ¨è¿™ä¸ªé¡¹ç›®ä¸­æ²¡æœ‰ã€‚

ç°åœ¨æˆ‘çš„æ–‡ä»¶æœ«å°¾æœ‰ä¸€ä¸ªå¯¼å‡ºå—ï¼Œè¿™æ­£å¸¸å—ï¼Ÿå¦‚æœæœ‰æ›´å¥½çš„æ–¹æ³•ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ã€‚

```
module.exports.actionLogin = actionLogin;
module.exports.addUser = addUser;
module.exports.checkPassword = checkPassword;
module.exports.setup = setup;
module.exports.updatePassword = updatePassword;
module.exports.userLogin = userLogin; 
```

## ç°åœ¨æ•ˆæœå¦‚ä½•ï¼Ÿ

å®ƒçš„å·¥ä½œåŸç†åŸºæœ¬ä¸Šå’Œä»¥å‰ä¸€æ ·ã€‚ç°åœ¨ï¼Œæˆ‘ä¸å¿…å®ä¾‹åŒ–ä¸€ä¸ªæ–°ç±»ï¼Œåªéœ€è¿è¡Œä¸€ä¸ª`setup`å‡½æ•°ï¼Œå‘Šè¯‰å®ƒæƒé™æ•°æ®åº“åœ¨å“ªé‡Œã€‚

```
const ph = require('./permissions_helper');

(async _ => {
  const sql = await ph.setup('perm.db');
  ph.userLogin(sql, 'admin', 'default', 1).then(key => {
    console.log(`Welcome admin you secure key is ${key}`);
  }).catch(err => {
    console.log(err);
  })
})() 
```

åƒè¿™æ ·åš`async`æ„Ÿè§‰æœ‰ç‚¹åƒé»‘å®¢ï¼Œä½†æˆ‘ä¸å–œæ¬¢æ•´ä¸ªåº”ç”¨ç¨‹åºéƒ½æœ‰ä¸€ä¸ª`.then(sql=>{})`ï¼Œä¹Ÿè®¸æœ‰æ›´å¥½çš„æ–¹æ³•æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿ

## å¸–å­ç»“æŸ

å¸Œæœ›ä»£ç ç°åœ¨æ›´å¥½ä¸€ç‚¹ï¼Œå°†æ¥ä¸å¤ªå¯èƒ½ç»™æˆ‘å¸¦æ¥é—®é¢˜ï¼Œå¦‚æœä½ çœ‹åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶ç•™ä¸‹è¯„è®ºï¼Œè®©æˆ‘çŸ¥é“æˆ‘çœŸçš„å¾ˆæ„Ÿæ¿€ã€‚

æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼

ğŸ¦„â¤ğŸ¦„ğŸ¦„â¤