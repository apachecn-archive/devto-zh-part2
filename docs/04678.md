# OTP åº”ç”¨ç¨‹åºæ˜¯å¦‚ä½•æ„é€ çš„

> åŸæ–‡:[https://dev . to/app signal/how-OTP-applications-is-structured-59e 4](https://dev.to/appsignal/how-otp-applications-are-structured-59e4)

OTP æ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œå®ƒæä¾›äº†å¸®åŠ©æ„å»º Erlang åº”ç”¨ç¨‹åºçš„æ ‡å‡†ï¼Œä½¿ç”¨ T2 åº”ç”¨ç¨‹åºå°†ä»£ç æ‰“åŒ…æˆå•å…ƒæˆ–ç»„ä»¶ã€‚è¿™ç§çº¦å®šæœ‰åŠ©äºå°†æ‚¨çš„ä»£ç ç»„ç»‡æˆæ¨¡å—çš„é€»è¾‘ç»„ï¼Œå¹¶æä¾›ä¸€ç§å¯åŠ¨å’Œåœæ­¢åº”ç”¨ç¨‹åºç›‘ç£ç¨‹åºçš„æ–¹å¼ã€‚æ‚¨çš„ Phoenix é¡¹ç›®æ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œä½†æ˜¯ Phoenix æ¡†æ¶å’Œ Ecto ä¹Ÿæ˜¯åº”ç”¨ç¨‹åºã€‚

åº”ç”¨ç¨‹åºæ˜¯å¯ä»¥è‡ªå·±ç¼–è¯‘çš„ç»„ä»¶ã€‚å®ƒå¯ä»¥ä¾èµ–äºå…¶ä»–åº”ç”¨ç¨‹åºï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨è‡ªå·±çš„é…ç½®ã€‚ä¸å…¶ä»–è¯­è¨€ä¸åŒï¼Œè¿™ç§çº¦å®šæä¾›äº†ä¸€ç§æ ‡å‡†åŒ–çš„æ–¹å¼æ¥æŒ‡å®š VM åº”è¯¥å¦‚ä½•ä¸ä¹‹äº¤äº’ã€‚

é™¤äº†åŒ…å«è™šæ‹Ÿæœºä»£ç çš„ç¼–è¯‘åçš„`.beam`æ–‡ä»¶ï¼Œç¼–è¯‘åçš„åº”ç”¨ç¨‹åºè¿˜åŒ…æ‹¬ä¸€ä¸ª*åº”ç”¨ç¨‹åºè§„èŒƒ* `.app`æ–‡ä»¶ï¼Œå®ƒå‘Šè¯‰è™šæ‹Ÿæœºå¦‚ä½•å¤„ç†åº”ç”¨ç¨‹åºï¼Œä»¥åŠä¸€ä¸ªå¯é€‰çš„*åº”ç”¨ç¨‹åºå›è°ƒæ¨¡å—*ï¼Œç”¨äºå¯åŠ¨ã€è¿è¡Œå’Œåœæ­¢åº”ç”¨ç¨‹åºã€‚

## [](#application-callback-modules)åº”ç”¨å›è°ƒæ¨¡å—

å¯¹äºæœ‰ç®¡ç†ç¨‹åºçš„åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºå›è°ƒæ¨¡å—å®šä¹‰äº†å¯åŠ¨å’Œåœæ­¢åº”ç”¨ç¨‹åºçš„å‡½æ•°ã€‚æ²¡æœ‰ç®¡ç†ç¨‹åºçš„åº”ç”¨ç¨‹åº(é€šå¸¸æ˜¯æ²¡æœ‰å†…éƒ¨çŠ¶æ€ä¹Ÿå¯ä»¥è°ƒç”¨çš„å‡½æ•°åº“)çœç•¥äº†å›è°ƒæ¨¡å—ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºä¸éœ€è¦å¯åŠ¨ã€‚

åœ¨ Elixir ä¸­ï¼Œåº”ç”¨ç¨‹åºå›è°ƒæ¨¡å—ä½¿ç”¨[å’Œ`Application`è¡Œä¸º](https://hexdocs.pm/elixir/Application.html)ã€‚è¯¥è¡Œä¸ºå®ç°äº†`start/2`å’Œ`stop/1`å›è°ƒã€‚å‰è€…å¯åŠ¨åº”ç”¨ç¨‹åºçš„ä¸»ç›‘æ§å™¨ï¼Œåè€…æ˜¯ä¸€ä¸ªå¯é€‰çš„å›è°ƒï¼Œç”¨äºåœ¨åœæ­¢ç›‘æ§å™¨åè¿›è¡Œæ¸…ç†ã€‚

å½“ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰`--sup`æ ‡å¿—çš„æ–°é¡¹ç›®æ—¶ï¼ŒElixir çš„`mix new`ä»»åŠ¡ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºå›è°ƒæ¨¡å—ã€‚

```
$ mix new --sup elixir_app 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”Ÿæˆçš„é¡¹ç›®åœ¨`lib/elixir_app/application.ex`ä¸­åŒ…å«ä¸€ä¸ªåº”ç”¨å›è°ƒæ¨¡å—ã€‚

```
defmodule ElixirApp.Application do
  # See https://hexdocs.pm/elixir/Application.html
  # for more information on OTP Applications
  @moduledoc false

  use Application

  def start(_type, _args) do
    # List all child processes to be supervised
    children = [
      # Starts a worker by calling: ElixirApp.Worker.start_link(arg)
      # {ElixirApp.Worker, arg},
    ]

    # See https://hexdocs.pm/elixir/Supervisor.html
    # for other strategies and supported options
    opts = [strategy: :one_for_one, name: ElixirApp.Supervisor]
    Supervisor.start_link(children, opts)
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½¿ç”¨æ—¶ï¼Œ`Application`æ¨¡å—æ·»åŠ ä¸€ä¸ª`stop/1`å‡½æ•°çš„[å­˜æ ¹ï¼Œè¿”å›ä¸€ä¸ª ok å…ƒç»„ã€‚ç”Ÿæˆçš„`start/2`å‡½æ•°å¯åŠ¨åº”ç”¨ç¨‹åºçš„ä¸»ç®¡ç†ç¨‹åºã€‚](https://github.com/elixir-lang/elixir/blob/0429cdd95f10abe2f5b3d188c2c3574132cae474/lib/elixir/lib/application.ex#L328-L330)

## [](#application-specifications)åº”ç”¨è§„èŒƒ

è¿è¡Œ`mix compile.app`å°†åº”ç”¨çš„è§„èŒƒæ”¾åœ¨`ebin`ç›®å½•ä¸‹çš„`.app`æ–‡ä»¶ä¸­ï¼Œæ˜¯ç”¨`mix compile`ç¼–è¯‘ app æ—¶é‡‡å–çš„æ­¥éª¤ä¹‹ä¸€ã€‚

è¯¥è§„èŒƒåŒ…å«å®šä¹‰åº”ç”¨ç¨‹åºçš„ Erlang æœ¯è¯­ã€‚å®ƒåˆ—å‡ºäº†åº”ç”¨ç¨‹åºä¸­å®šä¹‰çš„æ¨¡å—ã€ç‰ˆæœ¬å·ä»¥åŠè¯¥åº”ç”¨ç¨‹åºæ‰€ä¾èµ–çš„å…¶ä»–åº”ç”¨ç¨‹åºçš„åˆ—è¡¨ã€‚å®ƒè¿˜æŒ‡å®šè¦ç”¨ä½œå¯åŠ¨åº”ç”¨ç¨‹åºçš„å›è°ƒçš„æ¨¡å—ã€‚

è§„èŒƒæ–‡ä»¶åŸºäºåº”ç”¨ç¨‹åºçš„`mix.exs`æ–‡ä»¶ä¸­çš„è®¾ç½®ã€‚ä¸ºäº†èƒ½å¤Ÿç”Ÿæˆè§„èŒƒï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºå¿…é¡»åœ¨å…¶é¡¹ç›®å‡½æ•°ä¸­å®šä¹‰ä¸€ä¸ªåç§°å’Œç‰ˆæœ¬å·ã€‚

```
defmodule ElixirApp.MixProject do
  use Mix.Project

  def project do
    [
      app: :elixir_app,
      version: "0.1.0"
    ]
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹`mix.exs`æ–‡ä»¶ï¼Œå®ƒåªåˆ—å‡ºäº†é¡¹ç›®åç§°å’Œç‰ˆæœ¬å·ï¼Œç”Ÿæˆäº†ä¸€ä¸ªè§„èŒƒï¼Œåˆ—å‡ºäº† Elixir çš„é»˜è®¤åº”ç”¨ç¨‹åºå¹¶æŒ‡å®šäº†åº”ç”¨ç¨‹åºä¸­çš„æ¨¡å—ã€‚

```
{application,elixir_app,
             [{applications,[kernel,stdlib,elixir]},
              {description,"elixir_app"},
              {modules,['Elixir.ElixirApp','Elixir.ElixirApp.Application']},
              {registered,[]},
              {vsn,"0.1.0"}]}. 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#specifying-and-configuring-the-application-callback-module)æŒ‡å®šå’Œé…ç½®åº”ç”¨ç¨‹åºå›è°ƒæ¨¡å—

é™¤äº†åº”ç”¨ç¨‹åºçš„åç§°å’Œç‰ˆæœ¬å·ï¼Œç”¨`--sup`é€‰é¡¹ç”Ÿæˆçš„`mix.exs`æ–‡ä»¶æœ‰ä¸€ä¸ªå¸¦`mod`é”®çš„`application`åŠŸèƒ½ã€‚

```
defmodule ElixirApp.MixProject do
  # ...

  def application do
    [
      mod: {ElixirApp.Application, []}
    ]
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“ç”Ÿæˆè§„èŒƒæ—¶ï¼Œå®ƒåŒ…æ‹¬å›è°ƒæ¨¡å—ã€‚è¿™ä¸ªé”®æŒ‡å‘åº”ç”¨ç¨‹åºçš„å›è°ƒæ¨¡å—ï¼Œæ‰€ä»¥ VM çŸ¥é“ä½¿ç”¨å“ªä¸ªæ¨¡å—æ¥å¯åŠ¨åº”ç”¨ç¨‹åºã€‚

```
{application,elixir_app,
             [{applications,[kernel,stdlib,elixir,logger]},
              {description,"elixir_app"},
              {modules,['Elixir.ElixirApp','Elixir.ElixirApp.Application']},
              {registered,[]},
              {vsn,"0.1.0"},
              {mod,{'Elixir.ElixirApp.Application',[]}}]}. 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*æç¤º*:`:mod`-tuple ä¸­çš„åˆ—è¡¨ç”¨äºå°†é…ç½®é€‰é¡¹ä¼ é€’ç»™åº”ç”¨ç¨‹åºã€‚ä¼ å…¥çš„ä»»ä½•ä¸œè¥¿éƒ½ä»¥å›è°ƒæ¨¡å—çš„`start/2`å‡½æ•°çš„å‚æ•°ç»“æŸã€‚

### [](#-raw-applications-endraw-and-raw-extraapplications-endraw-)`:applications`å’Œ`:extra_applications`

è§„èŒƒä¸­çš„`applications`é”®åˆ—å‡ºäº†ä½ çš„ app æ‰€ä¾èµ–çš„æ‰€æœ‰åº”ç”¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ`mix compile.app`åŒ…æ‹¬`kernel` `stdlib`å’Œ`elixir`ã€‚

```
defmodule ElixirApp.MixProject do
  use Mix.Project

  def project do
    [
      app: :elixir_app,
      version: "0.1.0",
      deps: [{:appsignal, "~> 1.0.0"}]
    ]
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¾èµ–é¡¹è¢«è‡ªåŠ¨æ·»åŠ åˆ°`applications`åˆ—è¡¨ä¸­ï¼Œå¦‚æœå®ƒä»¬æœ‰åº”ç”¨ç¨‹åºæ¨¡å—ï¼Œå®ƒä»¬ä¼šåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨å‰è‡ªåŠ¨å¯åŠ¨ã€‚

```
{application,elixir_app,
             [{applications,[kernel,stdlib,elixir,appsignal]},
              {description,"elixir_app"},
              {modules,['Elixir.ElixirApp','Elixir.ElixirApp.Application']},
              {registered,[]},
              {vsn,"0.1.0"}]}. 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¦æ·»åŠ æ›´å¤šåƒ Elixir çš„`logger`è¿™æ ·çš„åº”ç”¨ç¨‹åºï¼Œæ‚¨å¯ä»¥å°†å®ƒä»¬æ·»åŠ åˆ°`:extra_applications`é”®ï¼Œå®ƒä»¬å°†éšåè¢«æ·»åŠ åˆ°ç°æœ‰åˆ—è¡¨ä¸­ã€‚

```
defmodule ElixirApp.MixProject do

  # ...

  def application do
    [
      extra_applications: [:logger],
      mod: {ElixirApp.Application, []}
    ]
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`:applications`é”®ç”¨äºæ˜ç¡®æŒ‡å®šè§„èŒƒä¸­åŒ…å«çš„åº”ç”¨ç¨‹åºã€‚ä½¿ç”¨æ—¶ï¼Œåªä¼šæ·»åŠ åˆ—å‡ºçš„åº”ç”¨ç¨‹åºå’Œé»˜è®¤å€¼ã€‚ä¸ä¼šè‡ªåŠ¨åŒ…æ‹¬ä»»ä½•å…¶ä»–ä¾èµ–é¡¹ã€‚

## [](#applications-all-the-way-down)ä¸€è·¯ç”³è¯·ä¸‹æ¥

æ¯ä¸ªå•ç‹¬çš„åº“ï¼Œä»¥åŠä½ çš„åº”ç”¨ç¨‹åºæœ¬èº«ï¼Œéƒ½æ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºã€‚ä¸€äº›åº”ç”¨ç¨‹åºæœ‰ä¸€ä¸ªç›‘ç£æ ‘ï¼Œè¦æ±‚å®ƒä»¬æœ‰ä¸€ä¸ªå›è°ƒæ¨¡å—æ¥è´Ÿè´£å¯åŠ¨å’Œåœæ­¢æ•´ä¸ªåº”ç”¨ç¨‹åºã€‚

æ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥ä¾èµ–äºå…¶ä»–åº”ç”¨ç¨‹åºï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½å¯ä»¥æœ‰è‡ªå·±çš„ç›‘ç£æ ‘å’Œå›è°ƒæ¨¡å—ã€‚ä¸ç®¡é‡Œé¢æœ‰ä»€ä¹ˆï¼Œå®ƒæ€»æ˜¯åœ¨åº”ç”¨ç¨‹åºè§„èŒƒæ–‡ä»¶ä¸­æŒ‡å®šçš„ã€‚æŠŠå®ƒæƒ³è±¡æˆä½ é•¿ç”Ÿä¸è€è¯çš„é…æ–¹ã€‚ğŸ˜‰

è¿™å°±ç»“æŸäº†æˆ‘ä»¬å¯¹ Elixir ä¸­ OTP åº”ç”¨ç¨‹åºçš„æ¦‚è¿°ã€‚æˆ‘ä»¬è¯•å›¾ä¼ è¾¾ OTP ä¼šè®®çš„ä¸€äº›ç¾å¦™ä¹‹å¤„ã€‚è¿™æ˜¯æˆ‘ä»¬å–œæ¬¢é•¿ç”Ÿä¸è€è¯çš„ä¼—å¤šåŸå› ä¹‹ä¸€ã€‚å¦‚æœä½ ä¹Ÿè¿™æ ·åšï¼Œè®©æˆ‘ä»¬çŸ¥é“ä½ æƒ³çœ‹åˆ°æˆ‘ä»¬å†™ä»€ä¹ˆè¯„è®ºï¼Œæˆ–è€…è®¢é˜…[ç‚¼é‡‘ç®€æŠ¥](https://appsignal.com/elixir-alchemy)ã€‚