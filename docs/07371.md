# ä½¿ç”¨ Masonite æ¡†æ¶å’Œ JSON Web ä»¤ç‰Œä»å¤´å¼€å§‹æ„å»ºç”µå­é‚®ä»¶éªŒè¯

> åŸæ–‡:[https://dev . to/nioperas 06/build-email-verification-from-scratch-with-mason ite-framework-and-JSON-we b-tokens-mf7](https://dev.to/nioperas06/build-email-verification-from-scratch-with-masonite-framework-and-json-web-tokens-mf7)

[Masonite æ¡†æ¶](https://github.com/MasoniteFramework/masonite)æ˜¯ä¸€ä¸ªç°ä»£çš„ä»¥å¼€å‘è€…ä¸ºä¸­å¿ƒçš„ Python web æ¡†æ¶ã€‚Masonite çš„æ¶æ„æ›´ç±»ä¼¼äº Laravel æ¡†æ¶ã€‚

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ä¸ºæ‚¨çš„ Masonite åº”ç”¨ç¨‹åºä»å¤´å¼€å§‹æ„å»ºç”µå­é‚®ä»¶éªŒè¯ã€‚

Masonite é™„å¸¦äº†ä¸€ä¸ªåä¸º Craft çš„ CLI å·¥å…·ã€‚Craft æä¾›äº†ä¸€ç§ç®€å•çš„æ–¹æ³•ï¼Œä½¿ç”¨ä¸€ä¸ªç®€å•çš„å‘½ä»¤:
æ¥æ­å»ºè®¤è¯æ‰€éœ€çš„ä¸œè¥¿

```
$ craft auth 
```

Enter fullscreen mode Exit fullscreen mode

ä¸Šé¢çš„å‘½ä»¤ç”Ÿæˆäº†è®¤è¯æ‰€éœ€çš„ä¸€åˆ‡:4 ä¸ªæ–°æ§åˆ¶å™¨ã€5 ä¸ªæ–°æ¨¡æ¿å’Œ 6 ä¸ªæ–°è·¯ç”±ã€‚å› æ­¤ï¼Œæ‚¨å¸Œæœ›å¤„ç†ç”¨æˆ·ç”µå­é‚®ä»¶éªŒè¯å¹¶éªŒè¯ç”µå­é‚®ä»¶ã€‚æˆ‘ä»¬èµ°å§ï¼

## åˆ›å»ºæ–°çš„ Masonite é¡¹ç›®å’Œè„šæ‰‹æ¶è®¤è¯

```
$ pipenv install masonite-cli
$ craft new masonite-app-with-user-verification 
$ cd masonite-app-with-user-verification 
$ craft install 
$ craft auth 
```

Enter fullscreen mode Exit fullscreen mode

## è®¾ç½®æ•°æ®åº“

ä¸ºäº†æ³¨å†Œç”¨æˆ·ï¼Œæˆ‘ä»¬å°†éœ€è¦ä¸€ä¸ªæ•°æ®åº“ã€‚è®©æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª MySQL æ•°æ®åº“ã€‚

```
$ pipenv install PyMySQL 
```

Enter fullscreen mode Exit fullscreen mode

## åˆ›å»ºæ–°çš„æ•°æ®åº“å¹¶å°†ä½ çš„æ•°æ®åº“å‡­è¯æ”¾å…¥ã€‚ç¯å¢ƒæ–‡ä»¶:

```
DB_DRIVER=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=masonite
DB_USERNAME=root
DB_PASSWORD=root 
```

Enter fullscreen mode Exit fullscreen mode

## ä¸ºç”¨æˆ·æ¨¡å‹æ·»åŠ â€œæ´»åŠ¨â€å±æ€§

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„è¿ç§»:

```
$ craft migration add_active_to_users_table --table=users 
```

Enter fullscreen mode Exit fullscreen mode

ç„¶åï¼Œæ·»åŠ æ–°çš„æ´»åŠ¨å±æ€§:

```
from orator.migrations import Migration
class AddActiveToUsersTable(Migration):
    def up(self):
         with self.schema.table('users') as table:
             table.boolean('active').default(False)

    def down(self):
         with self.schema.table('users') as table:
             table.drop_column('active') 
```

Enter fullscreen mode Exit fullscreen mode

åº”ç”¨æ‚¨çš„è¿ç§»ğŸ˜„

```
$ craft migrate 
```

Enter fullscreen mode Exit fullscreen mode

## ä¸ºä»€ä¹ˆä½¿ç”¨ JWT è¿›è¡Œé‚®ä»¶éªŒè¯ï¼Ÿ

JSON Web ä»¤ç‰Œæ˜¯ä¸€ç§åœ¨å„æ–¹ä¹‹é—´å®‰å…¨ä¼ è¾“ä¿¡æ¯çš„å¥½æ–¹æ³•ã€‚

å¯¹äºç”µå­é‚®ä»¶éªŒè¯ï¼Œæˆ‘ä»¬éœ€è¦å‘æ³¨å†Œç”¨æˆ·å‘é€ä¸€ä¸ªéšæœºæ•£åˆ—ã€‚

## æ³¨å†Œæ—¶ç”Ÿæˆæ–°çš„ jwt ä»¤ç‰Œ

æˆ‘ä»¬éœ€è¦ä½¿ç”¨ Python ä¸­çš„ JSON Web Token å®ç°:

```
$ pipenv install PyJWT 
```

Enter fullscreen mode Exit fullscreen mode

ç„¶å

```
data = {'email': user.email}
encoded = jwt.encode(data, os.environ.get('KEY'), algorithm='HS256')
token = str(encoded, 'utf-8') 
```

Enter fullscreen mode Exit fullscreen mode

ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å‘é€ä¸€å°é‚®ä»¶ã€‚Masonite æä¾›äº†ä¸€ä¸ªåŒ…è°ƒç”¨[é€šçŸ¥](https://docs.masoniteproject.com/official-packages/masonite-notifications)æ¥å¸®åŠ©æˆ‘ä»¬å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚

```
$ pipenv install masonite-notifications 
```

Enter fullscreen mode Exit fullscreen mode

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç”µå­é‚®ä»¶éªŒè¯é€šçŸ¥ã€‚

```
$ craft notification EmailVerificationNotification 
```

Enter fullscreen mode Exit fullscreen mode

æˆ‘ä»¬çš„é€šçŸ¥åº”è¯¥å‘é€ä¸€å°å¸¦æœ‰åŒ…å«éªŒè¯ä»¤ç‰Œçš„é“¾æ¥çš„ç”µå­é‚®ä»¶ã€‚

```
from notifications import Notifiable

class EmailVerificationNotification(Notifiable):
def mail(self):
    return self.subject('New account signup!') \
        .driver('smtp') \
        .heading('Masonite App With User Verification') \
        .line('In order to use your account, you have to validate your email address.') \
        .line('Please click on the link below.') \
        .action('Validate my account', href=self._link) 
```

Enter fullscreen mode Exit fullscreen mode

è¿˜ä¸é”™ã€‚

ç„¶åï¼Œè®©æˆ‘ä»¬å°†è¿™å°é‚®ä»¶å‘é€ç»™æˆ‘ä»¬çš„ç”¨æˆ·:

```
if token:
    Notify.mail(EmailVerificationNotification, to=user.email, link='http://localhost:8000/activate/{0}'.format(token))
    Session.flash(â€˜successâ€™, â€˜Almost done! Please check your email to complete the registration process.â€™)
    return Request.redirect(â€˜/loginâ€™) 
```

Enter fullscreen mode Exit fullscreen mode

å¦‚æœæ‚¨çš„ smtp å‡­è¯æ­£ç¡®ï¼Œæ‚¨çš„é‚®ä»¶ä¸­å°†ä¼šåŒ…å«ä»¥ä¸‹å†…å®¹:

[![Email verification](../Images/237275b4ebc7250ff1141668cf72a16f.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--yyFHZ-mz--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/p9mgktx5nsoh5uvkkof5.png)

## åˆ›å»ºé‚®ä»¶éªŒè¯è·¯å¾„

```
get('/activate/@token', 'RegisterController@validate') 
```

Enter fullscreen mode Exit fullscreen mode

## å®šä¹‰ç”¨æˆ·æ¨¡å‹ä¸Šçš„å¯å¡«å……å±æ€§â€˜æ¿€æ´»â€™

```
class User(Model):
    __fillable__ = ['name', 'email', 'password', 'active'] 
```

Enter fullscreen mode Exit fullscreen mode

## éªŒè¯ç”¨æˆ·

```
def validate(self, Request):
    if Request.param('token'):
        data = jwt.decode(Request.param('token'), os.environ.get('KEY'), algorithms=[â€˜HS256â€™])
        user = User.where('email', data['email']).first()
        if user:
            user.active = True
            user.save()
            Session.flash('success', 'You\'re in! Let\'s login!')
    return Request.redirect('/login') 
```

Enter fullscreen mode Exit fullscreen mode

## æœ€åä¸€ä»¶äº‹ï¼ç™»å½•ç”¨æˆ·:

```
def store(self, Request, Session):
    user = User.where('email', Request.input('email')).first()
    if user.active:
        if Auth(Request).login(Request.input('email'), Request.input('password')):
            return Request.redirect('/home')
        return Request.redirect('/login')
    else:
        Session.flash('warning', 'Please check your email to complete the registration process.')
        return Request.back() 
```

Enter fullscreen mode Exit fullscreen mode

## æ‚¨çš„ç”¨æˆ·ç°å·²é€šè¿‡éªŒè¯ğŸ”¥

æˆ‘ä¼šæŠŠè¿™äº›ä¸œè¥¿æ”¾åœ¨ä¸€ä¸ª Masonite åŒ…é‡Œã€‚å¦‚æœä½ æƒ³ä¸ºè½¯ä»¶åŒ…çš„å¼€å‘åšè´¡çŒ®æˆ–è€…å¯¹ Masonite çš„å¼€å‘æ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆä¸€å®šè¦åŠ å…¥ [Slack channel](http://slack.masoniteproject.com/) æˆ–è€…åœ¨ [GitHub](https://github.com/MasoniteFramework/masonite) ä¸Šå¯åŠ¨å›è´­ã€‚

è¯·éšæ„æ·»åŠ æ‚¨çš„è¯„è®ºï¼Œä»¥ä¾¿è¿›ä¸€æ­¥è®¨è®ºã€‚æœ¬æ•™ç¨‹çš„å®Œæ•´ä»£ç å¯åœ¨ Github ä¸Šè·å¾—ã€‚è°¢è°¢ï¼