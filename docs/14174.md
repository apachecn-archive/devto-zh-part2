# ç”¨ Docker å’Œ Let's åŠ å¯† Traefik

> åŸæ–‡:[https://dev . to/Joe nas/trae fik-with-docker-and-let-encrypt-35if](https://dev.to/joenas/traefik-with-docker-and-lets-encrypt-35if)

[![Traefik with Docker and Let's Encrypt](../Images/e5b7541d4a6b17f1a05de9ffc8b726e6.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--xygsb0WV--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://jonnev.se/content/images/2018/03/Screen-Shot-2018-03-13-at-22.19.45-1.png)

æˆ‘åœ¨ Docker ä¸­è¿è¡Œæˆ‘çš„å¤§éƒ¨åˆ†æœåŠ¡ï¼Œä»¥å‰æˆ‘ä½¿ç”¨`nginx`ä½œä¸ºåå‘å’Œ TLS ç»ˆæ­¢ä»£ç†ä»¥åŠ Let's Encryptã€‚è¿™éå¸¸æœ‰æ•ˆï¼Œä½†æ¯æ¬¡æˆ‘æƒ³å°è¯•æ–°çš„ä¸œè¥¿æ—¶ï¼Œæˆ‘éƒ½å¿…é¡»å¤åˆ¶ç²˜è´´å¦ä¸€ä¸ªé…ç½®å¹¶æ›´æ”¹ä¸€äº›å€¼ã€‚æˆ‘å¯èƒ½å¯ä»¥åœ¨æŸç§ç¨‹åº¦ä¸Šå®ç°è‡ªåŠ¨åŒ–ï¼Œä¹Ÿæœ‰å…¶ä»–äººè¿™æ ·åšäº†ï¼Œä½†éšç€æˆ‘æœ€è¿‘è¿ç§»åˆ° VPSesï¼Œæˆ‘æƒ³æˆ‘åº”è¯¥ç»™ [Traefik](https://traefik.io) ä¸€ä¸ªå°è¯•ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–ä¸œè¥¿æ˜¯ä¸ºäº†ä»–ä»¬**ä»¤äººæ•¬ç•çš„**æ ‡å¿—çš„è¯ï¼

åœ¨è¿™é‡Œï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨ GUIã€http é‡å®šå‘å’Œè‡ªåŠ¨åŠ å¯†è¯ä¹¦æ¥è®¾ç½® Traefikã€‚æˆ‘ä»¬è¿˜å°†æŠŠ*åŸºæœ¬èº«ä»½éªŒè¯*æ·»åŠ åˆ° Traefik GUI ä¸­ã€‚

## å…ˆå†³æ¡ä»¶

æœ¬æŒ‡å—å‡å®šæ‚¨å¯¹ Linux æœ‰ä¸€å®šçš„äº†è§£ï¼Œå¹¶ä¸”æ‚¨æœ‰ä¸€å°å®‰è£…äº†è¿™äº›æœåŠ¡çš„æœåŠ¡å™¨:

*   [ç å¤´å·¥äºº](https://docs.docker.com/engine/installation/linux/docker-ce/ubuntu/)
*   [åç«™-å¤åˆ](https://docs.docker.com/compose/install/)
*   ç”¨äºæ‰˜ç®¡æ‚¨çš„åº”ç”¨ç¨‹åºçš„**åŸŸ**

å¯¹äºä»·å»‰ç‰©ç¾çš„æœåŠ¡å™¨ï¼Œè¯·æŸ¥çœ‹æ•°å­—æµ·æ´‹æˆ– T2 çš„ç½‘ç«™ã€‚å¦å¤–ï¼Œå½“æˆ‘å»ºç«‹ä¸€ä¸ªæ–°çš„ VPS æ—¶ï¼Œæˆ‘æ€»æ˜¯æ¨è[è¿™ä¸ªæŒ‡å—](https://plusbryan.com/my-first-5-minutes-on-a-server-or-essential-security-for-linux-servers)ã€‚

*å¦‚æœä½ æƒ³ä½¿ç”¨æ•°å­—æµ·æ´‹ï¼Œè¯·éšæ„ä½¿ç”¨æˆ‘çš„[æ¨èé“¾æ¥](https://m.do.co/c/37d221e6802a)ä¸ºä½ çš„æœåŠ¡å™¨è·å¾— 10 ç¾å…ƒ*ğŸ˜Š

## è®¾ç½®

è¿™æ˜¯åœ¨å®˜æ–¹æŒ‡å—çš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€äº›å†…å®¹ã€‚æˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•æ·»åŠ  web dashboard å’Œ APIâ€”â€”å—åŸºæœ¬èº«ä»½éªŒè¯ä¿æŠ¤â€”â€”ä¸»è¦æ˜¯å› ä¸ºè¿™å¾ˆæœ‰è¶£ã€‚å¦‚æœä½ å¯¹å®ƒæ²¡æœ‰ç”¨å¤„æˆ–è€…è®¤ä¸ºå®ƒä¸å®‰å…¨ï¼Œä½ å¯ä»¥è·³è¿‡è¿™ä¸€éƒ¨åˆ†ã€‚

é¦–å…ˆï¼Œä¸ºé¢å‘ web çš„å®¹å™¨åˆ›å»ºä¸€ä¸ªè¿æ¥ç½‘ç»œã€‚

```
docker network create web 
```

Enter fullscreen mode Exit fullscreen mode

ç„¶åæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç›®å½•å’Œå¿…è¦çš„æ–‡ä»¶ï¼Œå¦‚æœéœ€è¦çš„è¯å¯ä»¥åˆ›å»º sudoã€‚

```
sudo su
mkdir -p /opt/traefik
touch /opt/traefik/docker-compose.yml
touch /opt/traefik/acme.json && chmod 600 /opt/traefik/acme.json
touch /opt/traefik/traefik.toml 
```

Enter fullscreen mode Exit fullscreen mode

ç°åœ¨è®©æˆ‘ä»¬æ·»åŠ æˆ‘ä»¬çš„`docker-compose`...

```
nano /opt/traefik/docker-compose.yml 
```

Enter fullscreen mode Exit fullscreen mode

```
version: '2'

services:
  proxy:
    image: traefik:v1.7.12-alpine
    command: --configFile=/traefik.toml
    restart: unless-stopped
    networks:
      - web
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /opt/traefik/traefik.toml:/traefik.toml
      - /opt/traefik/acme.json:/acme.json
    # REMOVE this section if you don't want the dashboard/API
    labels:
      - "traefik.enable=true"
      - "traefik.frontend.rule=Host:example.com"
      - "traefik.port=8080"

networks:
  web:
    external: true 
```

Enter fullscreen mode Exit fullscreen mode

â˜ï¸ **å¦‚æœä½ ä¿ç•™ API çš„è¯è®°å¾—æ›¿æ¢`traefik.frontend.rule`** ä¸­çš„`example.com`ã€‚

...ä»¥åŠ Traefik çš„é…ç½®...

```
nano /opt/traefik/traefik.toml 
```

Enter fullscreen mode Exit fullscreen mode

```
# Change this if needed
logLevel = "ERROR"
defaultEntryPoints = ["https","http"]

[entryPoints]
  [entryPoints.http]
    address = ":80"
    [entryPoints.http.redirect]
    entryPoint = "https"
  [entryPoints.https]
    address = ":443"
  [entryPoints.https.tls]

# REMOVE this section if you don't want the dashboard/API
[api]
entryPoint = "api"
dashboard = true

[retry]

[docker]
endpoint = "unix:///var/run/docker.sock"
domain = "mydomain"
watch = true
# I prefer to expose my containers explicitly
exposedbydefault = false

[acme]
email = "myemail"
storage = "acme.json"
entryPoint = "https"
OnHostRule = true
[acme.httpChallenge]
entryPoint = "http" 
```

Enter fullscreen mode Exit fullscreen mode

â˜ï¸ **åˆ†åˆ«åœ¨`[docker]`å’Œ`[acme]`ä¸‹æ·»åŠ ä½ çš„åŸŸåå’Œé‚®ç®±ã€‚**

...æˆ‘ä»¬åº”è¯¥å¯ä»¥å‡ºå‘äº†ï¼

```
cd /opt/traefik/
docker-compose up -d 
```

Enter fullscreen mode Exit fullscreen mode

æ£€æŸ¥æ—¥å¿—(`docker-compose logs`)å¹¶å‰å¾€æ‚¨é…ç½®çš„åŸŸï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„å†…å®¹(æˆªå›¾æ˜¯å‡ ä¸ªç‰ˆæœ¬ä¹‹å‰æ‹æ‘„çš„ï¼Œå·²ç»é‡æ–°è®¾è®¡)ã€‚

[![Screen-Shot-2018-03-13-at-22.19.45](../Images/2b8daf7330e4307be5d2c2e4c3bedf48.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--6uR448PK--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://jonnev.se/content/images/2018/03/Screen-Shot-2018-03-13-at-22.19.45.png)

### åŸºæœ¬è®¤è¯

å› ä¸ºæˆ‘ä»¬å·²ç»å…¬å¼€äº† Traefik çš„ APIï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›è¿›è¡Œä¸€äº›èº«ä»½éªŒè¯ã€‚æ”¯æŒåŸºæœ¬èº«ä»½éªŒè¯ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ·»åŠ å®ƒã€‚å¯¹æ‚¨æƒ³è¦çš„ç”¨æˆ·åè¿è¡Œè¿™ä¸ªç¨‹åºï¼Œä¾‹å¦‚`admin`ï¼Œå¹¶è¾“å…¥æ‚¨çš„å¯†ç ã€‚

```
sudo apt install apache2-utils
htpasswd -n username 
```

Enter fullscreen mode Exit fullscreen mode

è¿™æ˜¯æˆ‘ä¸ºç®¡ç†å‘˜/ç®¡ç†å‘˜å‡†å¤‡çš„ã€‚

```
admin:$apr1$IBj9Hfsd$kf7vXLpY4/9XD365jcp/n1 
```

Enter fullscreen mode Exit fullscreen mode

ç°åœ¨å®ƒéœ€è¦è¿›å…¥`traefik.toml`ä¸­ï¼Œä½†æ˜¯ä¸ºäº†å·¥ä½œï¼Œä»»ä½•`$`ç¬¦å·éƒ½å¿…é¡»ç”¨å¦ä¸€ä¸ª`$`è½¬ä¹‰ã€‚
å°†æ­¤æ·»åŠ åˆ°`[entrypoints]`éƒ¨åˆ†...

```
 [entryPoints.api]
    address = ":8080"
    [entryPoints.api.auth]
     [entryPoints.api.auth.basic]
       users = [
         "admin:$$apr1$$IBj9Hfsd$$kf7vXLpY4/9XD365jcp/n1"
       ] 
```

Enter fullscreen mode Exit fullscreen mode

ç°åœ¨åœæ­¢å¹¶é‡å»ºæ‚¨çš„æœåŠ¡...

```
docker-compose stop
docker-compose up -d 
```

Enter fullscreen mode Exit fullscreen mode

...è€Œä¸”ä½ è¦æœ‰åŸºæœ¬çš„ authï¼

[![Screen-Shot-2018-03-13-at-22.30.58](../Images/28c7a65b28a803050e23fc94ff5b287f.png)T2ã€‘](/content/images/2018/03/Screen-Shot-2018-03-13-at-22.30.58.png)

## æ·»åŠ ä¸€ä¸ªå®¹å™¨

å½“ç„¶ï¼Œè¦ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå®¹å™¨ï¼ä¸ºä»€ä¹ˆä¸æ˜¯æœ‰`ghost`çš„åšå®¢ï¼Ÿ

åˆ›å»ºä¸€ä¸ªç›®å½•å’Œä¸€ä¸ª`docker-compose.yml`ï¼Œè®°ä½è¦æ›´æ”¹åŸŸåå¹¶å°†ä¸»æœºåæ·»åŠ åˆ°æ‚¨çš„ DNS ä¸­ï¼ğŸ‘

```
mkdir -p /opt/ghost
nano /opt/ghost/docker-compose.yml 
```

Enter fullscreen mode Exit fullscreen mode

```
version: '2'
services:
  server:
    image: ghost:alpine
    container_name: ghost
    restart: unless-stopped
    networks:
      - web
    labels:
      # This one is important since we default to not expose
      - "traefik.enable=true"
      - "traefik.frontend.rule=Host:blog.example.com"
      - "traefik.port=2368"
      - "traefik.docker.network=web"
    volumes:
      - /opt/ghost/blog:/var/lib/ghost/content
    environment:
      - NODE_ENV=production
      - url=https://blog.example.com

networks:
  web:
    external: true 
```

Enter fullscreen mode Exit fullscreen mode

è¿è¡Œæ™®é€šçš„`docker-compose up -d`å’Œ *voilÃ * åšå®¢ï¼Œä½¿ç”¨ SSL/TLS å’Œæ‰€æœ‰åŠŸèƒ½ï¼Œçº¯ç²¹æ˜¯é­”æœ¯ğŸ˜€

### æ›´æ–°

2019-07-15:æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬(`v1.7.12`)ï¼Œä¹Ÿæ”¹ä¸ºåªä½¿ç”¨`traefik.toml`è€Œä¸ä¸`docker-compose.yml`ä¸­çš„`command`æ··åˆ