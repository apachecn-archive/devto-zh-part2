# å¯¹åº”ç”¨å¼•æ“ç”¨æˆ·ä½¿ç”¨ Firebase

> åŸæ–‡:[https://dev . to/samthor/using-firebase-with-app-engine-users-3 lnl](https://dev.to/samthor/using-firebase-with-app-engine-users-3lnl)

å¦‚æœæ‚¨ä» 2008 å¹´ App Engine é—®ä¸–ä»¥æ¥å°±ä¸€ç›´åœ¨ä¸ºå®ƒæ„å»ºï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½å·²ç»ä½¿ç”¨è¿‡å®ƒçš„æˆæƒæµã€‚å¾ˆç®€å•â€”â€”åœ¨`app.yaml`ä¸­æ·»åŠ `login: required`,æˆ–è€…è¦æ±‚ä»¥ç¼–ç¨‹æ–¹å¼ç™»å½•â€”â€”ç°åœ¨ä½ å°±æœ‰äº†ç”¨æˆ·çš„è°·æ­Œè´¦æˆ·ã€‚ğŸ‘

> é—®:æˆ‘å¦‚ä½•ä½¿ç”¨ Firebaseï¼Œå®ƒæœ‰è‡ªå·±çš„è®¤è¯ç³»ç»Ÿï¼Ÿ

å¾ˆç®€å•ï¼Œæ‚¨å¯ä»¥æ‰”æ‰ç°æœ‰çš„æˆæƒæµï¼Œç›´æ¥ä½¿ç”¨ Firebaseã€‚ç„¶è€Œï¼Œè¿™å°†å¹²æ‰°æ‚¨çš„ç”¨æˆ·ï¼Œä»–ä»¬å°†ä¸å¾—ä¸é‡æ–°ç™»å½•ï¼Œè¿™å¯èƒ½æ˜¯æ„æ–™ä¹‹å¤–çš„ã€‚ğŸ˜²

* * *

# [](#the-answer)ç­”æ¡ˆ

ç­”æ¡ˆæ˜¯:**ä½ ä¸èƒ½**è®©ä½ çš„ç”¨æˆ·ç”¨ä»–ä»¬çš„è°·æ­Œè´¦æˆ·è‡ªåŠ¨ç™»å½• Firebaseã€‚ä½ é—®:é‚£æˆ‘ä¸ºä»€ä¹ˆè¦è¯»è¿™ç¯‡æ–‡ç« ï¼Ÿï¼ğŸ¤”

å› æ­¤ï¼Œå°½ç®¡ Firebase æƒŠäººåœ°æ”¯æŒä¸å¤šä¸ªæä¾›å•†ä¸€èµ·ç™»å½•[â€”â€”ç”šè‡³æ˜¯ä½ çš„ç”µè¯å·ç ï¼ğŸ“â€”ä½ å®é™…ä¸Šå¯ä»¥å®Œå…¨è·³è¿‡ Firebase çš„ç™»å½•ä»£ç ï¼Œç›´æ¥åˆ›å»ºç”¨æˆ·ï¼Œä½¿ç”¨ä¸‹å›¾ä¸­çš„**ä¼˜å…ˆç­–ç•¥**ã€‚](https://fir-ui-demo-84a6c.firebaseapp.com/)

[![Two possible Firebase user flows](../Images/87de5c130d4f1b6f21d358a66a0942fd.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--xySucCJ5--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/o2m0nu1jq7f6cokeea7y.png)

å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå…¨æ–°çš„ç”¨æˆ·ï¼Œå¹¶ç”Ÿæˆæ‰€è°“çš„**è‡ªå®šä¹‰ä»¤ç‰Œ**ï¼Œä¾›è¿™äº›ç”¨æˆ·ä¸ Firebase çš„æœåŠ¡è¿›è¡Œäº¤äº’ã€‚è¿™äº›ç”¨æˆ·åœ¨æŠ€æœ¯ä¸Šä¸ç°æœ‰çš„ Google è´¦æˆ·æ²¡æœ‰å…³è”â€”â€”å› ä¸ºåªæœ‰ä½ çš„åç«¯åˆ›å»ºä»–ä»¬ï¼Œä½ å¯ä»¥æ–­è¨€ä»–ä»¬çš„æœ‰æ•ˆæ€§ã€‚

(ç¬¬äºŒç§æƒ…å†µæ˜¯æ›´ä¼ ç»Ÿçš„æ¨¡å‹â€”â€”Firebase æœ‰é’ˆå¯¹ä¸åŒç™»å½•ç³»ç»Ÿçš„â€œæä¾›è€…â€ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ç°æœ‰çš„ç™»å½•ç³»ç»Ÿï¼Œ*ï¼Œå³ä½¿*è¯¥ç™»å½•ç³»ç»Ÿâ€œåŒ¹é…â€ï¼Œæ‚¨ä¹Ÿä¸èƒ½è¿ç§»åˆ°è¿™é‡Œã€‚)

## [](#custom-token)è‡ªå®šä¹‰ä»¤ç‰Œ

è¦åˆ›å»ºè‡ªå®šä¹‰ä»¤ç‰Œï¼Œå¯ä»¥ä½¿ç”¨ Firebase Admin SDKï¼Œå®ƒæ”¯æŒ Goï¼ŒNodeã€‚JSï¼ŒPythonï¼ŒJavaã€‚

é¦–å…ˆâ€”â€”å¦‚æœä½ ä½¿ç”¨çš„æ˜¯`dev_appserver`,ä½ å¯èƒ½éœ€è¦è®¾ç½®ä½ çš„æœåŠ¡å¸æˆ·çš„å‡­è¯â€”â€”è¿™æ˜¯å®é™…ç™»å½•ä½ çš„å¸æˆ·ã€‚å‰å¾€ Firebase æ§åˆ¶å°çš„â€œè®¾ç½®â€â€œæœåŠ¡å¸æˆ·â€å¹¶ä¸‹è½½ç§é’¥ã€‚åœ¨æ‚¨çš„ shell ä¸­ï¼Œè¿è¡Œå¦‚ä¸‹ä»£ç :

```
export GOOGLE_APPLICATION_CREDENTIALS="/full/path/to/file/serviceAccountKey.json"

# then you can start your app
dev_appserver.py app.yaml 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> âš ï¸æ°¸è¿œä¸è¦æŠŠä½ çš„ç§äººé’¥åŒ™å­˜æ”¾åœ¨å…¬å…±åœºæ‰€æˆ–ç™»è®°åœ¨å†Œï¼

æˆ‘å°†æ¼”ç¤ºå¦‚ä½•åœ¨ Go åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨`CustomToken`ã€‚åœ¨ä»£ç ä¸­ï¼Œæ‚¨éœ€è¦ä½¿ç”¨[åº”ç”¨å¼•æ“ç”¨æˆ·åŒ…](https://cloud.google.com/appengine/docs/standard/go/users/reference)æ¥è®¿é—®å½“å‰ç”¨æˆ·ï¼Œå°†å®ƒçš„ ID ä¼ é€’ç»™ Firebase çš„`CustomToken`æ–¹æ³•:

```
// 0\. create firebase.App
app, err := firebase.NewApp(ctx, nil)
if err != nil { ... }

// 1\. get the current App Engine user
u := user.Current(ctx)
if u == nil || u.ID == "" { ... }

// 2\. create auth.Auth
client, err := app.Auth(ctx)
if err != nil { ... }

// 3\. use auth.Auth to mint a token for an ID, creating the account as nessecary
token, err := client.CustomToken(u.ID)
if err != nil { ... }

// 4\. send token to client- profit! 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#remember)è®°ä½

*   è¿™ä¸ª`CustomToken`æ–¹æ³•å°†**é€æ˜åœ°**ç”¨ä½ æŒ‡å®šçš„ ID åˆ›å»ºä¸€ä¸ªç”¨æˆ·å¸å·â€”â€”*è¿™æ˜¯æœ¬æŒ‡å—çš„å…³é”®ï¼*

*   è™½ç„¶è¿™ä¸ªä¾‹å­ä½¿ç”¨äº†`u.ID`(ç”¨æˆ·çš„ç”µå­é‚®ä»¶)ï¼Œä½†æ˜¯å®ƒå¯ä»¥æ˜¯ä»»ä½•å”¯ä¸€çš„å­—ç¬¦ä¸²ã€‚Firebase çš„å†…ç½®æä¾›è€…ä½¿ç”¨[uuid](https://groups.google.com/forum/#!msg/firebase-talk/s9mv4S46Qs0/UXD4Tnl2BwAJ)ï¼Œè¿™çœ‹èµ·æ¥ä¸åƒç”µå­é‚®ä»¶åœ°å€ï¼Œæ‰€ä»¥ä¸å¯èƒ½æœ‰å†²çªã€‚

## [](#client-integration)å®¢æˆ·ç«¯é›†æˆ

ä¸€æ—¦ä½ åˆ¶ä½œäº†ä»¤ç‰Œï¼Œä½ éœ€è¦æŠŠå®ƒå‘é€ç»™ä½ çš„å®¢æˆ·ã€‚æˆ‘è¦è°ˆçš„æ˜¯ç½‘ç»œï¼Œä½†æ˜¯ [Firebase çš„æ–‡æ¡£è¯¦ç»†æè¿°äº†åŸç”Ÿå®¢æˆ·ç«¯](https://firebase.google.com/docs/auth/admin/create-custom-tokens#sign_in_using_custom_tokens_on_clients)ã€‚

åœ¨æˆ‘çš„é¡¹ç›®ä¸­ï¼Œæˆ‘å€¾å‘äºå°†ä»¤ç‰ŒåŒ…å«åœ¨ç¬¬ä¸€ä¸ª HTML å“åº”ä¸­ï¼Œè¿™æ ·æ‚¨çš„ä»£ç å°±å¯ä»¥ç«‹å³ä½¿ç”¨å®ƒâ€”â€”é€šè¿‡ JS å…¨å±€å˜é‡æˆ–å±æ€§:

```
<script>window.firebaseToken = '{{TOKEN}}';</script>
<!-- or -->
<body data-firebase-token="{{TOKEN}}"> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶ååœ¨æ‚¨çš„ JS ä¸­ï¼Œæ‚¨å¯ä»¥ç­‰å¾… auth å®Œæˆ:

```
const token = window.firebaseToken || document.body.dataset.firebaseToken;
await firebase.auth().signInWithCustomToken(token);
const user = firebase.auth().currentUser;
console.info('user is', user); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»ç°åœ¨å¼€å§‹ï¼Œæ‚¨å¯¹ Firebase APIs çš„ä»»ä½•è¯·æ±‚â€”â€”æ¯”å¦‚ä»¤äººæƒŠå¹çš„å¯ä¼¸ç¼© Firestore å®æ—¶æ•°æ®åº“â€”â€”éƒ½å°†æ ¹æ®æ‚¨åˆšåˆšåˆ›å»ºçš„è¿™ä¸ªç”¨æˆ·å¸æˆ·è¿›è¡Œèº«ä»½éªŒè¯ã€‚ğŸ‰

### [](#remember)è®°ä½

*   å› ä¸ºè¿™æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ä¸€ä¸ªå¸æˆ·ï¼Œå¹¶ä¸çœŸæ­£ä¸ Google ç™»å½•ç›¸å…³è”ï¼Œæ‰€ä»¥è¿™ä¸ªä»¤ç‰Œåªé€‚ç”¨äºä¸ Firebase å¯¹è¯ã€‚ğŸ”¥

*   è¿™ä¸ªä»¤ç‰Œä¸€ä¸ªå°æ—¶åå°±è¿‡æœŸäº†ï¼Œä½ å¾—é©¬ä¸Šç”¨å®ƒå»`signInWithCustomToken`ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä»¤ç‰Œç¼“å­˜åœ¨æœåŠ¡äººå‘˜å†…éƒ¨ï¼Œè¿™å¯èƒ½ä¼šå½±å“åˆ°æ‚¨ã€‚

* * *

å°±è¿™æ ·â€”â€”ä½ å®Œæˆäº†ï¼ä½†æ˜¯æœ‰ä¸¤ä¸ªæ‰©å±•:

# [](#multiple-auth-providers)1ï¸âƒ£å¤šä¸ªæˆæƒæä¾›å•†

Firebase å…è®¸æ‚¨å°†å¤šä¸ªèº«ä»½éªŒè¯æä¾›è€…é“¾æ¥åˆ°ä¸€ä¸ªå¸æˆ·ã€‚è¿™ç»™äº†ä½ ä¸¤ä¸ªæœ‰è¶£çš„é€‰æ‹©:

*   æ‚¨å¯ä»¥ä» App Engine çš„æˆæƒæµä¸­è¿ç§»å‡ºæ¥ï¼Œå› ä¸ºç”¨æˆ·ä¼šè‡ªç„¶åœ°å†æ¬¡ç™»å½•å’Œé€€å‡º
*   ä½ å¯ä»¥è®©ç”¨æˆ·ç”¨é¢å¤–çš„è´¦æˆ·ç™»å½•ï¼Œæ¯”å¦‚è„¸ä¹¦ï¼ŒTwitter:è¿™æ˜¯ Firebase è®¤è¯æ¨¡å‹çš„ä¸€ä¸ªå¼ºå¤§åŠŸèƒ½ã€‚

è¦äº†è§£æ›´å¤šå…³äºè´¦æˆ·é“¾æ¥çš„ä¿¡æ¯ï¼Œè¯·å‚è§è°·æ­Œæ–‡æ¡£ã€‚

# [](#claims)2ï¸âƒ£å£°ç§°

å½“æ‚¨ä½¿ç”¨`CustomToken`åˆ›å»ºè´¦æˆ·æ—¶ï¼Œæ‚¨è¿˜å¯ä»¥æ³¨æ˜â€œç´¢èµ”â€ã€‚è¿™äº›åŸºæœ¬ä¸Šæ˜¯æ‚¨ä»¥åå¯ä»¥æŸ¥æ‰¾çš„æ ‡è®°ï¼Œå¯èƒ½æ˜¯åœ¨éªŒè¯ Firebase ä»¤ç‰Œæ—¶ã€‚ä¸€äº›ä¾‹å­å¯èƒ½åŒ…æ‹¬â€œæ”¯ä»˜å¸æˆ·â€ã€â€œå—é™â€ç­‰ã€‚

å‚è§å…³äº[åˆ›å»ºè‡ªå®šä¹‰ä»¤ç‰Œ](https://firebase.google.com/docs/auth/admin/create-custom-tokens#create_custom_tokens_using_the_firebase_admin_sdk)çš„å…¨éƒ¨æ–‡æ¡£ã€‚

* * *

# [](#thanks)æ„Ÿè°¢

æˆ‘å¸Œæœ›ä½ å·²ç»å­¦ä¼šäº†å¦‚ä½•å°†ä½ ç°æœ‰çš„ App Engine auth flow ä¸ Firebase é›†æˆã€‚å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ Twitter ä¸Šè”ç³»æˆ‘æˆ–åœ¨ä¸‹é¢ç•™è¨€ã€‚âœ’ï¸ğŸ‘‡