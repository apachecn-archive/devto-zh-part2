# 用 git 修复错误

> 原文:[https://dev.to/vorahsa/fixing-mistakes-with-git-27a5](https://dev.to/vorahsa/fixing-mistakes-with-git-27a5)

有时，我们都会编写不应该成为代码库一部分的代码。或者至少不应该成为它的一部分。Git 有很多方法可以删除这样的代码，了解何时使用每种方法可以让您成为更有效的 git 用户。因此，让我们来看看，根据代码中意外发生的情况，您应该做些什么。

我只在命令行上使用 git，所以我用它来显示一切。Git GUIs 可能以不同的方式显示这些信息，但是我相信术语通常不会改变，所以命令应该是可以找到的。

### [](#i-didnt-commit-yet)我还没提交

如果你没有提交代码，

`git status`

是一个有用的命令。它显示了尚未提交的所有更改的列表，还告诉您如何忽略一些未提交的更改。输出有以下几段:

```
On branch feature-user-account
Changes to be committed:
  (use "git reset HEAD <file>..." to unstage)
...
Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git checkout -- <file>..." to discard changes in working directory) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

如果您想忽略的更改在第一部分，建议的命令

`git reset HEAD`

会将它们带到第二组。而对于第二组中的变更，建议的命令

`git checkout --`

(`--`很重要)将从给定的文件中移除所有变更。因此，在运行之前，请确保这些文件中的所有更改都是您想要删除的。

### [](#i-committed-but-didnt-push)我犯了但没推

如果您还没有推送您的更改，它们目前只存在于您的本地计算机上。所以你可以随心所欲地改变事情。Git 有命令`git reset`，一种我们在上面看到的形式，将你当前的分支重置为别的东西。如果您只想回到提交前的状态，运行

`git reset HEAD^`

将当前分支设置为最近一次提交前的状态(这就是`HEAD`后的`^`的意思；您可以放置多个`^`来返回多个提交)，并将您的更改保持在未提交状态。

如果你真的想摆脱最近的提交，`git reset`有一个方法可以做到这一点。如果您运行

`git reset --hard HEAD^`

，最新的提交将被删除，就像从未发生过一样。提交中的任何代码都将被删除，所以只有在您知道整个提交是一个错误的情况下才这样做。(你可以用任何东西代替`HEAD^`来重置那里的分支；我有时用它来重置我的本地分支到远程服务器上的那个分支，因为我想删除我在本地那个分支上做的任何事情。)

### [](#i-committed-and-pushed-to-my-own-branch)我提交并推到我自己的分支

在基于特性分支的软件开发流程中，开发人员通常拥有自己的分支来处理他们正在实现的特性。如果没有其他人在一个分支上工作，您可以将该分支的远程版本视为与您的本地分支非常相似。所以只需像上面那样做`git reset`，然后是

`git push --force`

(称为强制推送)，使远程匹配您的本地重置版本的分支。

存储库管理员可以配置远程存储库来拒绝强制推送。如果是这种情况，请遵循下一个标题下的建议。

### [](#i-committed-and-pushed-to-a-shared-branch)我提交并推送到共享分支

在多人工作的分支上执行重置和强制推送的问题是，其他一些人可能已经提交了不应该发生的提交，并且已经在此基础上构建了他们的一些工作。在这种情况下，对压力的反应会变得很紧张。

幸运的是，git 还有一种方法可以在不改变历史的情况下恢复更改。要清除最近提交中的更改，运行

`git revert HEAD`

这将创建一个与`HEAD`提交完全相反的新提交，从而撤销那里所做的所有更改。

如您所料，您可以给`git revert`任何提交标识符来代替`HEAD`，它会做您所期望的事情，即创建一个提交，只撤销您指定的提交。这是你不能用`git reset`做的事情，所以即使你的工作流通常不包括使用`git revert`，它也是一个需要记住的有用工具。

### 我提交并推动了一项本不该发生的合并

假设您正在使用功能分支模型，那么您正在使用的任何功能都需要从您的分支合并到主开发分支。可能发生的情况是，您或某人在该分支准备好被合并之前意外地合并了它，所以您想要撤消合并。

同样，`git revert`可以用来撤销合并提交。但是有一个问题:一个合并提交有多个父级(通常是两个)。git 应该恢复哪些更改？用于恢复合并提交的命令是

`git revert -m 1 <commit>`

，其中`-m 1`选项表示选择父编号 1 作为要恢复到的父。

请注意，父编号不是提交标识符。相反，合并提交有一行

```
Merge: 8e2ce2d 86ac2e7 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

用`git log`或者`git show`看的时候。父编号是该行中所需父的从 1 开始的索引，即第一个标识符是编号 1，第二个是编号 2，依此类推。1 号是进行合并的分支，所以在特征分支工作流中，撤销合并意味着将选项`-m 1`给`git revert`。

### 我提交并推送了存储库中不应该存在的东西

有时你会在工作树中保留一些不应该提交的东西。一定要为你的项目建立一个合适的`.gitignore`文件，以避免不小心提交这些东西，但是可能会出现一些新的东西没有被你的`.gitignore`捕捉到，而你不小心提交并推动了它。这可能是应该保密的凭证，可能是让使用存储库不舒服的大量二进制文件，也可能是其他东西。

这里的方法是，当你提交并推送到自己的分支时，遵循 advise，也就是说，`git reset`之后是`git push --force`。但是如果你在一个共享分支上这样做，记得告诉你的团队发生了这种情况，这样他们就可以适应一个共享分支上的强制推进。

最后，如果您不小心将私有密钥、凭证、密码或类似的东西推到了公共存储库中，请将它们视为受到了威胁。立即撤销任何凭证，更改任何密码等。

### 我想要回我的代码

如果你做的改变是不成熟的，你想在以后再做，下面是根据你如何摆脱它们来恢复它们的方法:

*   如果你这样做了，你所做的改变就没了。Git 从未见过它们，所以它不能帮助你恢复它们。
*   `git reset HEAD`，`git reset`:变更保留在你的工作树中，只是处于不同的状态。如果你记得把它们保存在某个地方，就从那里拿回来。
*   变化已经消失了，但是 git 看到了它们，并且可能会记住它们。调查一下`git reflog`(这个话题太大了，我无法在这里深入讨论，而且我也无法给出好的建议)
*   `git revert`:要走的路是另一个`git revert`，这一次给出为原始恢复创建的提交的标识符。这给你带来了有趣的提交消息“还原”...“”，但这是最干净的方式。如果您正在撤销一个特征分支的过早合并，请记住在合并该特征分支的正确版本之前这样做。否则，git 将会弄不清特性分支中的哪些变更已经存在于主开发分支中。