# 9 ä¸ªæœ‰å¸Œæœ›çš„æ‰¿è¯ºæŠ€å·§

> åŸæ–‡:[https://dev.to/kepta/promising-promise-tips-c8f](https://dev.to/kepta/promising-promise-tips--c8f)

æ‰¿è¯ºæ˜¯å¾ˆå¥½çš„åˆä½œä¼™ä¼´ï¼ä½ çš„åŒäº‹ä¹Ÿæ˜¯è¿™ä¹ˆè¯´çš„ã€‚

[![prom](../Images/0833d026f88c7e53627bc1140ce41ab6.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--zlauxVhZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/6966254/36483828-3e361d88-16e5-11e8-9f11-cbe99d719066.png)

è¿™ç¯‡æ–‡ç« ä¼šå‘Šè¯‰ä½ å¦‚ä½•æ”¹å–„ä½ å’Œæ‰¿è¯ºçš„å…³ç³»ã€‚

# [](#1-you-can-return-a-promise-inside-a-then)1ã€‚ä½ å¯ä»¥åœ¨ a é‡Œé¢è¿”å›ä¸€ä¸ªæ‰¿è¯º

è®©æˆ‘çªå‡ºæœ€é‡è¦çš„æç¤º

> **æ˜¯çš„ï¼ä½ å¯ä»¥åœ¨ a é‡Œé¢è¿”å›ä¸€ä¸ªæ‰¿è¯º.ç„¶å**

åŒæ ·ï¼Œè¿”å›çš„æ‰¿è¯ºåœ¨ä¸‹ä¸€ä¸ª`.then`
ä¸­è‡ªåŠ¨å±•å¼€

```
.then(r => {
    return serverStatusPromise(r); // this is a promise of { statusCode: 200 }
})
.then(resp => {
    console.log(resp.statusCode); // 200; notice the automatic unwrapping of promise
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

# [](#2-you-create-a-new-promise-everytime-you-do-then)2ã€‚æ¯ä¸€æ¬¡ä½ éƒ½åˆ›é€ äº†ä¸€ä¸ªæ–°çš„æ‰¿è¯ºã€‚ç„¶å

å¦‚æœä½ ç†Ÿæ‚‰ javascript çš„ç‚¹é“¾æ¥é£æ ¼ï¼Œä½ ä¼šæœ‰å®¾è‡³å¦‚å½’çš„æ„Ÿè§‰ã€‚ä½†å¯¹äºä¸€ä¸ªæ–°äººæ¥è¯´ï¼Œè¿™å¯èƒ½å¹¶ä¸æ˜æ˜¾ã€‚

åœ¨æ‰¿è¯ºä¸­ï¼Œæ¯å½“ä½ `.then`æˆ–`.catch`æ—¶ï¼Œä½ éƒ½åœ¨åˆ›é€ ä¸€ä¸ªæ–°çš„æ‰¿è¯ºã€‚è¿™ä¸ªæ‰¿è¯ºæ˜¯ä½ åˆšåˆšé“¾æ¥çš„æ‰¿è¯ºå’Œä½ åˆšåˆšé™„åŠ çš„`.then` / `.catch`çš„ç»„åˆã€‚

è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­:

```
var statusProm = fetchServerStatus();

var promA = statusProm.then(r => (r.statusCode === 200 ? "good" : "bad"));

var promB = promA.then(r => (r === "good" ? "ALL OK" : "NOTOK"));

var promC = statusProm.then(r => fetchThisAnotherThing()); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸Šè¿°æ‰¿è¯ºçš„å…³ç³»å¯ä»¥ç”¨ä¸€ä¸ªæµç¨‹å›¾æ¥æè¿°:
[![image](../Images/b06f71da18487f89f983e8e81cbcc508.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--gf5-9vXv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/6966254/36400725-dac92186-15a0-11e8-8b4f-6a344e6a5229.png)

è¿™é‡Œéœ€è¦æ³¨æ„çš„é‡è¦ä¸€ç‚¹æ˜¯ï¼Œ`promA`ã€`promB`å’Œ`promC`éƒ½æ˜¯ä¸åŒçš„æ‰¿è¯ºï¼Œä½†å´æ˜¯ç›¸å…³çš„ã€‚

æˆ‘å–œæ¬¢æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªå·¨å¤§çš„ç®¡é“ï¼Œå½“çˆ¶èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œæ°´å°†åœæ­¢æµå‘å­èŠ‚ç‚¹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ`promB`å¤±è´¥ï¼Œå…¶ä»–èŠ‚ç‚¹ä¸ä¼šå—åˆ°å½±å“ï¼Œä½†å¦‚æœ`statusProm`å¤±è´¥ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šå—åˆ°å½±å“ï¼Œå³`rejected`ã€‚

# [](#3-a-promise-is-resolvedrejected-for-everyone)3ã€‚æ¯ä¸ªäººçš„æ‰¿è¯ºéƒ½è¢«è§£å†³/æ‹’ç»

æˆ‘å‘ç°è¿™æ˜¯è®©æ‰¿è¯ºå˜å¾—æ›´å¥½çš„æœ€é‡è¦çš„äº‹æƒ…ä¹‹ä¸€ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå¦‚æœä¸€ä¸ªæ‰¿è¯ºåœ¨ä½ çš„åº”ç”¨ç¨‹åºçš„å¤šä¸ªéƒ¨åˆ†ä¹‹é—´å…±äº«ï¼Œé‚£ä¹ˆå½“å®ƒåˆ°è¾¾`resolved/rejected`æ—¶ï¼Œæ‰€æœ‰çš„éƒ¨åˆ†éƒ½ä¼šå¾—åˆ°é€šçŸ¥ã€‚

> è¿™ä¹Ÿæ„å‘³ç€æ²¡æœ‰äººå¯ä»¥æ”¹å˜ä½ çš„æ‰¿è¯ºï¼Œæ‰€ä»¥è¯·æ”¾å¿ƒä¼ é€’å®ƒï¼Œä¸è¦æ‹…å¿ƒã€‚

```
function yourFunc() {
  const yourAwesomeProm = makeMeProm();

  yourEvilUncle(yourAwesomeProm); // rest assured you promise will work, regardless of how evil uncle consumes your promise

  return yourAwesomeProm.then(r => importantProcessing(r));
}

function yourEvilUncle(prom) {
  return prom.then(r => Promise.reject("destroy!!")); // your evil uncle
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œè®¾è®¡çš„æ‰¿è¯ºä½¿ä»»ä½•äººéƒ½éš¾ä»¥åšé‚ªæ¶çš„äº‹æƒ…ã€‚å¦‚æˆ‘ä¸Šé¢æ‰€è¯´ï¼Œ`Keep calm and pass the promise around`

# [](#4-promise-constructor-is-not-the-solution)4ã€‚Promise æ„é€ å‡½æ•°ä¸æ˜¯è§£å†³æ–¹æ¡ˆ

æˆ‘çœ‹åˆ°å¼€å‘äººå‘˜åˆ°å¤„åˆ©ç”¨æ„é€ å™¨é£æ ¼ï¼Œè®¤ä¸ºä»–ä»¬æ˜¯åœ¨ç”¨æ‰¿è¯ºçš„æ–¹å¼åšè¿™ä»¶äº‹ã€‚ä½†è¿™æ˜¯ä¸€ä¸ªå¼¥å¤©å¤§è°ï¼Œå®é™…åŸå› æ˜¯æ„é€ å‡½æ•° API ä¸å¥½çš„æ—§å›è°ƒ API å’Œæ—§ä¹ æƒ¯éš¾æ”¹éå¸¸ç›¸ä¼¼ã€‚

> **å¦‚æœä½ å‘ç°è‡ªå·±åˆ°å¤„å†™`Promise constructors`ï¼Œé‚£ä½ å°±åšé”™äº†ï¼**

ä¸ºäº†å‘å‰è¿ˆå‡ºä¸€æ­¥ï¼Œè¿œç¦»å›è°ƒï¼Œæ‚¨éœ€è¦å°å¿ƒåœ°å°½é‡å‡å°‘ Promise æ„é€ å‡½æ•°çš„ä½¿ç”¨é‡ã€‚

è®©æˆ‘ä»¬è·³åˆ° a `Promise constructor` :
çš„å®é™…ç”¨ä¾‹

```
return new Promise((res, rej) => {
  fs.readFile("/etc/passwd", function(err, data) {
    if (err) return rej(err);
    return res(data);
  });
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`Promise constructor`**åº”è¯¥åªåœ¨ä½ æƒ³æŠŠå›æ‹¨è½¬æ¢æˆæ‰¿è¯º**çš„æ—¶å€™ä½¿ç”¨ã€‚
ä¸€æ—¦ä½ æŒæ¡äº†è¿™ç§åˆ›é€ æ‰¿è¯ºçš„ç¾ä¸½æ–¹å¼ï¼Œå°†å®ƒç”¨åœ¨å…¶ä»–å·²ç»æ‰¿è¯ºçš„åœ°æ–¹ä¼šå˜å¾—éå¸¸è¯±äººï¼

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªå¤šä½™çš„`Promise constructor`

**ä¸å¯¹**

```
return new Promise((res, rej) => {
    var fetchPromise = fetchSomeData(.....);
    fetchPromise
        .then(data => {
            res(data); // wrong!!!
        })
        .catch(err => rej(err))
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ğŸ’–**çº æ­£**

```
return fetchSomeData(...); // when it looks right, it is right! 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”¨`Promise constructor`åŒ…è£…ä¸€ä¸ªæ‰¿è¯ºåªæ˜¯**çš„å¤šä½™ï¼Œè¿èƒŒäº†æ‰¿è¯ºæœ¬èº«çš„ç›®çš„**ã€‚

ğŸ˜ **Protip**

å¦‚æœä½ æ˜¯ä¸€ä¸ª **nodejs** çš„äººï¼Œæˆ‘æ¨èå»çœ‹çœ‹ [util.promisify](http://2ality.com/2017/05/util-promisify.html) ã€‚è¿™ä¸ªå°ä¸œè¥¿å¸®åŠ©ä½ å°†èŠ‚ç‚¹é£æ ¼çš„å›è°ƒè½¬åŒ–ä¸ºæ‰¿è¯ºã€‚

```
const {promisify} = require('util');
const fs = require('fs');

const readFileAsync = promisify(fs.readFile);

readFileAsync('myfile.txt', 'utf-8')
  .then(r => console.log(r))
  .catch(e => console.error(e)); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

# [](#5-use-promiseresolve)5ã€‚ä½¿ç”¨æ‰¿è¯ºã€‚è§£å†³

Javascript æä¾›äº†`Promise.resolve`ï¼Œè¿™æ˜¯å†™ç±»ä¼¼è¿™æ ·çš„ä¸œè¥¿çš„ç®€å†™:

```
var similarProm = new Promise(res => res(5));
// ^^ is equivalent to
var prom = Promise.resolve(5); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æœ‰å¤šä¸ªç”¨ä¾‹ï¼Œæˆ‘æœ€å–œæ¬¢çš„ä¸€ä¸ªæ˜¯èƒ½å¤Ÿå°†å¸¸è§„(åŒæ­¥)javascript å¯¹è±¡è½¬æ¢æˆæ‰¿è¯ºã€‚

```
// converting a sync function to an async function
function foo() {
  return Promise.resolve(5);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨è¿˜å¯ä»¥å°†å®ƒç”¨ä½œä¸€ä¸ªå®‰å…¨åŒ…è£…ï¼ŒåŒ…è£…æ‚¨ä¸ç¡®å®šæ˜¯æ‰¿è¯ºå€¼è¿˜æ˜¯å¸¸è§„å€¼çš„å€¼ã€‚

```
function goodProm(maybePromise) {
  return Promise.resolve(maybePromise);
}

goodProm(5).then(console.log); // 5

goodProm(Promise.resolve(Promise.resolve(5))).then(console.log); // 5, Notice it unwraps all the layers of promises automagically! 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

# [](#6use-promisereject)6ã€‚ä½¿ç”¨æ‰¿è¯ºã€‚æ‹’ç»

Javascript ä¹Ÿæä¾›äº†`Promise.reject`ï¼Œæ˜¯è¿™ä¸ª
çš„ç®€å†™

```
var rejProm = new Promise((res, reject) => reject(5));

rejProm.catch(e => console.log(e)) // 5 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘æœ€å–œæ¬¢çš„ä¸€ä¸ªç”¨ä¾‹æ˜¯ç”¨`Promise.reject`æå‰æ‹’ç»ã€‚

```
function foo(myVal) {
    if (!mVal) {
        return Promise.reject(new Error('myVal is required'))
    }
    return new Promise((res, rej) => {
        // your big callback to promie conversion!
    })
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç®€å•æ¥è¯´ï¼Œåœ¨ä»»ä½•ä½ æƒ³æ‹’ç»æ‰¿è¯ºçš„åœ°æ–¹ä½¿ç”¨`Promise.reject`ã€‚

åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­æˆ‘ä½¿ç”¨äº†ä¸€ä¸ª`.then`

```
.then(val => {
  if (val != 5) {
    return Promise.reject('Not Good');
  }
})
.catch(e => console.log(e)) // Not Good 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*æ³¨æ„:ä½ å¯ä»¥åƒ`Promise.resolve`ä¸€æ ·åœ¨`Promise.reject`é‡Œé¢æ”¾ä»»ä½•å€¼ã€‚æ‚¨ç»å¸¸åœ¨è¢«æ‹’ç»çš„æ‰¿è¯ºä¸­å‘ç°`Error`çš„åŸå› æ˜¯å®ƒä¸»è¦ç”¨äºæŠ›å‡ºå¼‚æ­¥é”™è¯¯ã€‚*

# [](#7-use-promiseall)7ã€‚ä½¿ç”¨ Promise.all

Javascript æä¾›äº† [Promise.all](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all) ï¼Œè¿™æ˜¯â€¦â€¦çš„ç®€å†™ã€‚æˆ‘æƒ³ä¸å‡ºè¿™ä¸ªğŸ˜ã€‚

åœ¨ä¼ªç®—æ³•ä¸­ï¼Œ`Promise.all`å¯ä»¥æ¦‚æ‹¬ä¸º

```
Takes an array of promises

    then waits for all of them to finish

    then returns a new Promise which resolves into an Array

    catches if even a single fails/rejects. 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†æ‰€æœ‰æ‰¿è¯ºä½•æ—¶è§£å†³:

```
var prom1 = Promise.resolve(5);
var prom2 = fetchServerStatus(); // returns a promise of {statusCode: 200}

Proimise.all([prom1, prom2])
.then([val1, val2] => { // notice that it resolves into an Array
    console.log(val1); // 5
    console.log(val2.statusCode); // 200
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªæ˜¾ç¤ºå…¶ä¸­ä¸€ä¸ªå¤±è´¥çš„æ—¶å€™:

```
var prom1 = Promise.reject(5);
var prom2 = fetchServerStatus(); // returns a promise of {statusCode: 200}

Proimise.all([prom1, prom2])
.then([val1, val2] => {
    console.log(val1); 
    console.log(val2.statusCode); 
})
.catch(e =>  console.log(e)) // 5, jumps directly to .catch 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*æ³¨æ„:`Promise.all`æ˜¯èªæ˜ï¼åœ¨æ‹’ç»çš„æƒ…å†µä¸‹ï¼Œå®ƒä¸ä¼šç­‰å¾…æ‰€æœ‰çš„æ‰¿è¯ºå®Œæˆï¼ã€‚æ¯å½“ä»»ä½•ä¸€ä¸ªæ‰¿è¯ºè¢«æ‹’ç»ï¼Œå®ƒä¼šç«‹å³ä¸­æ­¢ï¼Œè€Œä¸ç­‰å¾…å…¶ä»–æ‰¿è¯ºå®Œæˆã€‚*

ğŸ˜ **Protip**
`Promise.all`ä¸æä¾›æ‰¹é‡æ‰§è¡Œæ‰¿è¯º(å¹¶å‘)çš„æ–¹æ³•ï¼Œå› ä¸ºæ ¹æ®è®¾è®¡ï¼Œæ‰¿è¯ºåœ¨åˆ›å»ºæ—¶å°±è¢«æ‰§è¡Œã€‚å¦‚æœä½ æƒ³æ§åˆ¶æ‰§è¡ŒåŠ›ï¼Œæˆ‘æ¨èè¯•è¯•[è“é¸Ÿ. map](http://bluebirdjs.com/docs/api/promise.map.html) ã€‚( **æ„Ÿè°¢ [Mauro](https://dev.to/mgtitimoli) çš„è¿™ä¸ªæç¤ºã€‚** )

# [](#8-do-not-fear-the-rejection-or)8ã€‚ä¸è¦å®³æ€•è¢«æ‹’ç»*æˆ–*

# [](#do-not-append-redundant-raw-catch-endraw-after-every-then)ä¸è¦åœ¨æ¯ä¸ªåé¢è¿½åŠ å¤šä½™çš„`.catch`ã€‚ç„¶å

æˆ‘ä»¬æœ‰å¤šå®³æ€•é”™è¯¯åœ¨ä¸¤è€…ä¹‹é—´è¢«åå™¬ï¼Ÿ

ä¸ºäº†å…‹æœè¿™ç§ææƒ§ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸ç®€å•çš„æç¤º:

> **ä½¿æ‹’ç»å¤„ç†çˆ¶å‡½æ•°çš„é—®é¢˜ã€‚**

ç†æƒ³æƒ…å†µä¸‹ï¼Œæ‹’ç»å¤„ç†åº”è¯¥æ˜¯ä½ çš„åº”ç”¨ç¨‹åºçš„æ ¹æœ¬ï¼Œæ‰€æœ‰çš„æ‰¿è¯ºæ‹’ç»éƒ½ä¼šæ¸—é€åˆ°å…¶ä¸­ã€‚

ä¸è¦å®³æ€•å†™è¿™æ ·çš„ä¸œè¥¿

```
return fetchSomeData(...); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œå¦‚æœä½ æƒ³åœ¨ä½ çš„èŒèƒ½ä¸­å¤„ç†æ‹’ç»ï¼Œå†³å®šä½ æ˜¯æƒ³è§£å†³äº‹æƒ…è¿˜æ˜¯ç»§ç»­æ‹’ç»ã€‚

ğŸ’˜**è§£å†³æ‹’ç»**

è§£å†³æ‹’ç»å¾ˆç®€å•ï¼Œåœ¨`.catch`ä¸­ï¼Œä½ è¿”å›çš„ä»»ä½•ä¸œè¥¿éƒ½è¢«è®¤ä¸ºæ˜¯è§£å†³äº†çš„ã€‚ç„¶è€Œæœ‰ä¸€ä¸ªæ¡ä»¶(åŒå…³è¯­)ï¼Œå¦‚æœä½ åœ¨ä¸€ä¸ª`.catch`ä¸­è¿”å›ä¸€ä¸ª`Promise.reject`ï¼Œè¿™ä¸ªæ‰¿è¯ºå°†è¢«æ‹’ç»ã€‚

```
.then(() => 5.length) // <-- something wrong happenned here
.catch(e => {
        return 5;  // <-- making javascript great again
})
.then(r => {
    console.log(r); // 5
})
.catch(e => {
    console.error(e); // this function will never be called :)
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ğŸ’”**æ‹’ç»ä¸€ä¸ªæ‹’ç»**
æ‹’ç»ä¸€ä¸ªæ‹’ç»å¾ˆç®€å•ï¼Œ**ä»€ä¹ˆéƒ½ä¸åšã€‚**å¦‚æˆ‘ä¸Šé¢æ‰€è¯´ï¼Œè®©å®ƒæˆä¸ºä¸€äº›å…¶ä»–åŠŸèƒ½çš„é—®é¢˜ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œçˆ¶å‡½æ•°æ¯”å½“å‰å‡½æ•°æœ‰æ›´å¥½çš„æ–¹æ³•æ¥å¤„ç†æ‹’ç»ã€‚

é‡è¦çš„æ˜¯è¦è®°ä½ï¼Œä¸€æ—¦ä½ å†™äº†ä¸€ä¸ª catchï¼Œå°±æ„å‘³ç€ä½ åœ¨å¤„ç†é”™è¯¯ã€‚è¿™ç±»ä¼¼äº sync `try/catch`çš„å·¥ä½œæ–¹å¼ã€‚

å¦‚æœä½ ç¡®å®æƒ³æ‹¦æˆªä¸€ä¸ªæ‹’ç»:(æˆ‘å¼ºçƒˆå»ºè®®ä¸è¦ï¼)

```
.then(() => 5.length) // <-- something wrong happenned here
.catch(e => {
  errorLogger(e); // do something impure
  return Promise.reject(e); // reject it, Yes you can do that!
})
.then(r => {
    console.log(r); // this .then (or any subsequent .then) will never be called as we rejected it above :)
})
.catch(e => {
    console.error(e); //<-- it becomes this catch's problem
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**ä¹‹é—´çš„ç»†å¾®å·®åˆ«ã€‚ç„¶åæ˜¯(xï¼Œy)ç„¶åæ˜¯(x)ã€‚catch(x)**
`.then`æ¥å—ç¬¬äºŒä¸ªå›è°ƒå‚æ•°ï¼Œè¯¥å‚æ•°ä¹Ÿå¯ç”¨äºå¤„ç†é”™è¯¯ã€‚è¿™å¯èƒ½çœ‹èµ·æ¥ç±»ä¼¼äºåšç±»ä¼¼äº`then(x).catch(x)`çš„äº‹æƒ…ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªé”™è¯¯å¤„ç†ç¨‹åºåœ¨å®ƒä»¬æ•æ‰çš„é”™è¯¯æ–¹é¢æ˜¯ä¸åŒçš„ã€‚

æˆ‘å°†è®©ä¸‹é¢çš„ä¾‹å­æ¥è¯´æ˜è¿™ä¸€ç‚¹ã€‚

```
.then(function() {
   return Promise.reject(new Error('something wrong happened'));
}).catch(function(e) {
   console.error(e); // something wrong happened
});

.then(function() {
   return Promise.reject(new Error('something wrong happened'));
}, function(e) { // callback handles error coming from the chain above the current `.then`
    console.error(e); // no error logged
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“ä½ æƒ³å¤„ç†æ¥è‡ªæ‰¿è¯ºçš„é”™è¯¯æ—¶,`.then(x,y)`çœŸçš„å¾ˆæ–¹ä¾¿ã€‚`then`ing and not want handle from`.then`ä½ åˆšåˆšè¿½åŠ åˆ°æ‰¿è¯ºé“¾ä¸Šã€‚

*æ³¨æ„:99.9%çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨æ›´ç®€å•çš„`then(x).catch(x)`ä¼šæ›´å¥½ã€‚*

# [](#9-avoid-the-then-hell)9ã€‚é¿å…ã€‚ç„¶åæ˜¯åœ°ç‹±

è¿™ä¸ªæç¤ºéå¸¸ç®€å•ï¼Œå°½é‡é¿å…åœ¨`.then`æˆ–`.catch`ä¸­ä½¿ç”¨`.then`ã€‚ç›¸ä¿¡æˆ‘ï¼Œè¿™æ¯”ä½ æƒ³è±¡çš„æ›´å®¹æ˜“é¿å…ã€‚

**ä¸å¯¹**

```
request(opts)
.catch(err => {
  if (err.statusCode === 400) {
    return request(opts)
           .then(r => r.text())
           .catch(err2 => console.error(err2))
  }
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ğŸ’–**çº æ­£**

```
request(opts)
.catch(err => {
  if (err.statusCode === 400) {
    return request(opts);
  }
  return Promise.reject(err);
})
.then(r => r.text())
.catch(err => console.erro(err)); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ‰æ—¶ï¼Œæˆ‘ä»¬ç¡®å®éœ€è¦åœ¨ä¸€ä¸ª`.then`èŒƒå›´å†…æœ‰å¤šä¸ªå˜é‡ï¼Œé™¤äº†åˆ›å»ºå¦ä¸€ä¸ª`.then`é“¾ä¹‹å¤–åˆ«æ— é€‰æ‹©ã€‚

```
.then(myVal => {
    const promA = foo(myVal);
    const promB = anotherPromMake(myVal);
    return promA
          .then(valA => {
              return promB.then(valB => hungryFunc(valA, valB)); // very hungry!
          })
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘æ¨èä½¿ç”¨ ES6 ç ´ååŠ›é‡æ··åˆ`Promise.all`æ¥æ•‘æ´ï¼

```
.then(myVal => {
    const promA = foo(myVal);
    const promB = anotherPromMake(myVal);
    return Promise.all([prom, anotherProm])
})
.then(([valA, valB]) => {   // putting ES6 destructing to good use
    console.log(valA, valB) // all the resolved values
    return hungryFunc(valA, valB)
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*æ³¨æ„:å¦‚æœä½ çš„èŠ‚ç‚¹/æµè§ˆå™¨/boss/conscious å…è®¸ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ [async/await](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function) æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼*

æˆ‘çœŸçš„å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ ç†è§£æ‰¿è¯ºã€‚

è¯·æŸ¥çœ‹æˆ‘ä»¥å‰çš„åšå®¢å¸–å­ã€‚

*   Javascript ä¸­çš„å¹¼å„¿å†…å­˜æ³„æ¼æŒ‡å—
*   [äº†è§£ Javascript ä¸­çš„é»˜è®¤å‚æ•°](https://dev.to/kepta/understanding-default-parameters-in-javascript-ali)

å¦‚æœä½ â¤ï¸è¿™ç¯‡æ–‡ç« ï¼Œè¯·åˆ†äº«è¿™ç¯‡æ–‡ç« ä¼ æ’­çš„è¯ã€‚

åœ¨ Twitter ä¸Šè”ç³»æˆ‘ [@kushan2020](https://twitter.com/kushan2020) ã€‚