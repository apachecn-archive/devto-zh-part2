# 金丝雀部署介绍部署策略:蓝绿色，金丝雀，等等

> 原文：<https://dev.to/mostlyjason/intro-to-deployment-strategies-blue-green-canary-and-more-3a3>

如今，软件开发的最大变化是部署的频率。产品团队更早(更频繁)地将发布部署到生产环境中。几个月或几年的发布周期变得越来越少——尤其是在那些构建纯软件产品的人中间。

今天，使用面向服务的架构和微服务方法，开发人员可以设计模块化的代码库。这允许他们同时编写和部署代码库不同部分的变更。

缩短部署周期的业务优势显而易见:

*   上市时间缩短
*   客户在更短的时间内获得产品价值
*   客户反馈也更快地反馈到产品团队，这意味着团队可以更快地迭代功能和修复问题
*   整体开发人员士气上升

然而，这种转变也给运营或开发团队带来了新的挑战。随着部署越来越频繁，部署的代码更有可能对站点可靠性或客户体验产生负面影响。这就是为什么开发能够最小化产品和客户风险的代码部署策略非常重要。

在本文中，我们将讨论一些不同的部署策略、最佳实践和工具，它们将使您的团队工作得更快*和*更可靠。

## 现代应用的挑战

现代应用程序通常是分布式的和基于云的。它们可以弹性扩展以满足需求，并且由于高度可用的体系结构，它们对故障的恢复能力更强。他们可以利用完全托管的服务，如平台处理一些运营责任的 [AWS Lambda](https://aws.amazon.com/lambda/) 或[弹性容器服务(ECS)](https://aws.amazon.com/ecs/) 。

这些应用程序几乎总是需要频繁部署。例如，一个移动应用程序或消费者 web 应用程序可能在一个月内经历多次更改。有些甚至一天多次部署到生产中。

他们通常使用微服务架构，在该架构中，多个组件协同工作以提供完整的功能。不同的组件可以有不同的发布周期，但是它们必须无缝地协同工作。

活动部件数量的增加意味着出现问题的可能性更大。随着多个开发团队对整个代码库进行更改，当一个问题不可避免地出现时，很难确定问题的根本原因。

另一个挑战:基础设施层的抽象，现在被认为是代码。部署新的应用程序可能也需要部署新的基础结构代码。

## 流行的部署策略

为了应对这些挑战，应用程序和基础架构团队应该设计并采用适合其用例的部署策略。

我们将回顾几种部署策略，并讨论几种不同部署策略的优缺点，以便您选择适合您组织的策略。

## “大爆炸”部署

顾名思义，“大爆炸”部署可以一次性更新整个或大部分应用程序。这种策略可以追溯到软件在物理介质上发布并由客户安装的时代。

大爆炸部署要求企业在发布前进行广泛的开发和测试，通常与大型连续发布的[“瀑布模型”](https://en.wikipedia.org/wiki/Waterfall_model)相关。

现代应用程序具有在客户端或服务器端定期自动更新的优势。这使得大爆炸方法对于现代团队来说更慢，更不灵活。

大爆炸部署的特征包括:

*   所有主要部分打包在一个部署中；

*   用新的软件版本大部分或全部替换现有的软件版本；

*   部署通常导致长时间的开发和测试周期；

*   假设失败的可能性极小，因为回滚可能是不可能的或不切实际的；

*   完成时间通常很长，可能需要多个团队的努力；

*   需要客户端采取行动来更新客户端安装。

Big bang 部署不适合现代应用程序，因为这种风险对于面向公众或业务关键型应用程序来说是不可接受的，在这些应用程序中，停机意味着巨大的财务损失。回滚通常成本高昂、耗时，甚至是不可能的。

大爆炸方法可能适用于非生产系统(例如，重新创建开发环境)或供应商打包的解决方案，如桌面应用程序。

## 滚动部署

滚动、分阶段或分步部署优于大爆炸式部署，因为它们最大限度地减少了许多相关风险，包括用户面临的停机时间和不容易的回滚。

在滚动部署中，应用程序的新版本会逐渐替换旧版本。实际部署需要一段时间。在此期间，新老版本将共存，不会影响功能或用户体验。这个过程使得回滚任何与旧组件不兼容的新组件变得更加容易。

下图显示了部署模式:在集群中的每个服务器上，旧版本显示为蓝色，新版本显示为绿色。

[![Rolling deployment](../Images/d82dd50e6eca6300f58dae0f7ebb4790.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--RbA0NHA6--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/divuxihkun2p186c9mye.png)

应用程序套件升级是滚动部署的一个例子。如果最初的应用程序部署在容器中，升级可以一次处理一个容器。每个容器都被修改为从应用程序供应商的网站下载最新的图像。如果其中一个应用程序存在兼容性问题，旧映像可以重新创建容器。在这种情况下，套件应用程序的新旧版本共存，直到每个应用程序都升级。

## 蓝绿色、红黑色或 A/B 部署

这是另一个万无一失的过程。在这种方法中，两个相同的生产环境并行工作。

一个是接收所有用户流量的当前运行的生产环境(用蓝色表示)。另一个是它的克隆，但闲置(绿色)。两者都使用相同的数据库后端和应用程序配置:

[![Before blue-green deployment](../Images/ec784f4ca4d22fc1d463ad4afc350fb4.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--fJ4tYKdy--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/78dk41w8qmuy9f9pvrf6.png)

新版本的应用程序部署在绿色环境中，并经过功能和性能测试。一旦测试结果成功，应用流量就会从蓝色变为绿色。绿色成为新的产品。

[![After blue-green deployment](../Images/089074528014544dbc69bc2143e0a3fb.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--ca9C-wVZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/m664yyotixnqncprryf0.png)

如果在绿色变为活动状态后出现问题，流量可以被路由回蓝色。

在蓝绿色部署中，两个系统使用相同的持久层或数据库后端。保持应用程序数据同步很重要，但是镜像数据库可以帮助实现这一点。

您可以使用蓝色的主数据库进行写操作，使用绿色的辅助数据库进行读操作。在从蓝色切换到绿色的过程中，数据库从主数据库故障转移到辅助数据库。如果 green 在测试期间也需要写入数据，那么数据库可以处于双向复制状态。

一旦绿色变为活动，您可以关闭或回收旧的蓝色实例。您可以在这些实例上部署一个较新的版本，并使它们成为下一个版本的新绿色。

蓝绿色部署依赖于流量路由。这可以通过更新主机的 DNS CNAMES 来实现。但是，长 TTL 值会延迟这些变化。或者，您可以更改负载平衡器设置，使更改立即生效。像 ELB 的连接排水这样的特征可以用于服务飞行中的连接。

## 金丝雀部署

金丝雀部署就像蓝绿色，除了它更规避风险。你可以使用分阶段的方法，而不是一步到位地从蓝色切换到绿色。

使用 canary 部署，您可以在生产基础设施的一小部分中部署新的应用程序代码。一旦应用程序被签署发布，只有少数用户被路由到它。这将最小化任何影响。

由于没有错误报告，新版本可以逐步推广到基础设施的其余部分。下图演示了金丝雀部署:

[![Canary deployment](../Images/0b9dbaf7a3c2e1c0800e91b121590afb.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--7PmOiuG9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/zvf9rbd1x38umph98zro.png)

canary 部署的主要挑战是设计一种方法将一些用户路由到新的应用程序。此外，一些应用程序可能总是需要同一组用户进行测试，而其他应用程序可能每次都需要不同的组。

通过探索几种技术，考虑一种路由新用户的方法:

*   在允许外部用户访问之前，将内部用户暴露给 canary 部署；

*   基于源 IP 范围进行路由；

*   在特定地理区域发布应用程序；

*   使用应用程序逻辑为特定用户和组解锁新功能。当应用程序对其他用户开放时，这个逻辑就被删除了。

## 部署最佳实践

现代应用程序团队可以遵循许多最佳实践来将部署风险降至最低:

*   使用部署清单。例如，清单上的一项可能是“仅在应用服务停止后备份所有数据库”，以防止数据损坏。

*   **采用持续集成(CI)。** CI 确保签入代码库的特性分支的代码只与它的主分支合并*在*它已经通过了一系列的依赖检查、单元和集成测试，以及成功的构建之后。如果在这个过程中出现错误，构建就会失败，应用团队会得到通知。因此，使用 CI 意味着对应用程序的每一项更改都要在部署之前进行测试。CI 工具的例子有:CircleCI，Jenkins。

*   **采用连续交货(CD)。**使用 CD，CI 构建的代码工件被打包，并随时准备在一个或多个环境中部署。在我们的[低风险持续交付电子书](https://try.rollbar.com/low-risk-continuous-delivery-guide/)中阅读更多内容。

*   **使用标准操作环境(SOE)**确保环境一致性。开发工作站和服务器可以使用类似于 vagger 和 Packer 这样的工具。

*   使用构建自动化工具来自动化环境构建。借助这些工具，只需点击一个按钮，就可以轻松拆除整个基础架构堆栈并从头开始重建。这种工具的一个例子是 CloudFormation。

*   **使用目标服务器中的配置管理工具**如 Puppet、Chef 或 Ansible，自动应用操作系统设置、应用补丁或安装软件

*   使用 Slack 这样的通信渠道自动通知不成功的构建和应用程序失败

*   创建一个流程，提醒负责团队部署失败。理想情况下，您将在 CI 环境中发现这些变化，但是如果部署了这些变化，您将需要一种通知负责团队的方式

*   **为由于可用性或错误率问题而未通过运行状况检查的部署**启用自动回滚。

## 部署后监控

即使你采用了所有这些最佳实践，事情仍然可能会失败。因此，监视部署后立即发生的问题与规划和执行完美的部署一样重要。

应用程序性能监控(APM)工具可以帮助您的团队监控关键性能指标，包括部署后的服务器响应时间。应用程序或系统架构的变化会极大地影响应用程序的性能。

像 [Rollbar](http://rollbar.com/) 这样的错误监控解决方案同样重要。它将快速通知您的团队来自部署的新的或重新激活的错误，这些错误可能会发现需要立即关注的重要错误。

如果没有错误监控工具，这些错误可能永远不会被发现。虽然一些遇到错误的用户会花时间报告，但大多数人不会。随着时间的推移，负面的客户体验可能会导致满意度问题，或者更糟的是，阻止现在的业务交易。

错误监控工具还在运营/开发运维团队和开发人员之间创建了所有部署后问题的共享可见性。这种共同的理解使得团队更加协作和响应。

*原载于[rollbar.com](https://rollbar.com/blog/deployment-strategies/)T3】*