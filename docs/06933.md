# 去 Prod 之前问这些问题

> 原文:[https://dev . to/thagomizer/ask-these-questions-before-to-prod-5 CLC](https://dev.to/thagomizer/ask-these-questions-before-going-to-prod-5clc)

许多刚接触运营的人都以绝对主义的心态来看待事情。他们认为事物是正确的或不正确的，安全的或不安全的。事实上，所有类型的行动都是在平衡对立的力量。毕竟，世界上最安全的网站不会被任何人访问，当然也不会有用户。

考虑到这一点，我改变了“我如何/在哪里运行我的东西”的典型模式。我没有介绍每一种产品以及使用它的利弊，而是围绕七个问题来组织我的演讲。我根据个人将应用程序投入生产的经历来选择问题。

这些问题可能不适合使用，但我收到的反馈是，问题格式有助于人们理解权衡，并使他们更有信心做出架构决策。

## 1。我的优先事项是什么？

最关键的问题是弄清楚你的优先事项。运营就是要权衡取舍。正因为如此，你能清楚地陈述你的目标，什么是重要的，以及你不关心的事情是至关重要的。优先级可以是实际的事情，如“省钱”或“稳健”他们也可以更基于场景，比如，“通过让投资者看到我们的概念证明来支持我们的 B 轮融资。”或者，也许你优先考虑的是，“从有限的友好测试用户那里获得有价值的反馈。”大多数情况下，你会有几个优先级，对它们进行粗略的堆叠排序会很有帮助。

一旦你有了优先考虑的事情，想想它们有什么含义。例如，如果您的重点是省钱，您可能不想为高度管理的平台即服务系统支付额外费用。如果你支持测试版用户或投资轮，你的系统规模降为零可能是至关重要的，这样当没人看你的应用时，你就不用付费了。这些只是例子。优先级可以通过许多其他方式影响你的决策。

## 2。我的负荷是什么样的？

负载的形状也会对哪些计算选项产生深远的影响，甚至会影响哪些架构对您的应用有意义。许多应用程序的负载会跟随工作日。它们要么是人们在工作日使用的应用程序，要么是人们在工作之外使用的应用程序。在这两种情况下，能够随着负载的变化高效、动态地伸缩是至关重要的。一些应用程序具有突发负载。他们可能在几分钟内看到几十万个请求，然后在几个小时内每分钟只看到一百个请求。其他负载需要定期进行大量的批处理，但在其他时间对计算的要求较低。

大多数云提供商允许您的应用程序自动伸缩(以及较小程度的自动修复),以适应当前负载。使用自动缩放时，通常指定最小实例数和最大实例数。就我个人而言，我将我的最大实例数设置为我预测负载的 5 倍。我使用 5x 是因为您的前端 web 服务器不是唯一必须扩展的东西。如果我接近 5 倍上限，我应该仔细检查系统的其他部分，比如数据库和我的邮件程序是否还在正常处理负载。此外，在 5 倍时，我通常会得到足够的警告，如果一切顺利，我们正在接近这个极限，可以进一步向上调整。

并非所有计算选择都允许您缩减到零。如果你知道你有时会没有流量，缩放到零可能是省钱的一个重要方法。像 Google Cloud Functions 或 AWS Lambda 这样的无服务器计算选项可能最适合突发负载。此外，使用折扣计算选项(如可抢占虚拟机)进行批处理通常更便宜。您还可以通过在成本较低的区域运行不受延迟影响的作业来节省资金(如果数据位置要求允许的话)。负荷会在很多方面影响你的选择。您的优先级应该有助于指导现在应该优先考虑哪些事情，以便您可以选择对您的应用有意义的产品。

## 3。我有什么技能？

这是一个有些人没有意识到的问题，但当我和成功的企业家交谈时，这个问题总是会出现。想想你的团队已经知道哪些语言和框架。有人有设置、维护和保护虚拟机的经验吗？你最喜欢什么产品？

你不一定要坚持你所知道的；有时候，一个新项目是学习新事物的好机会。如果你走出你的舒适区，事情可能需要更长的时间。在你选择做一些你还不习惯的事情之前，你可能想找一些能得到实时帮助或支持的地方。

有时候，人们渴望使用某项特定的技术，仅仅是因为他们在播客或会议谈话中听说过它。这并不总是一个错误的选择，但是投入到一个不熟悉的技术中可能并不是对你的时间和金钱的最好利用。举个例子，我看到现在很多人都在嚷嚷着要使用容器。集装箱太棒了。我真的喜欢 GKE。但是容器增加了部署的间接性和复杂性。如果您对容器外的堆栈不太满意，那么您需要意识到在容器内调试它会更加困难。

## 4。幸福的道路是什么？

如果你不熟悉“快乐之路”这个术语，它的意思是你希望用户走的路。对于电子商务，这可能是购买途径。对于一个社交应用来说，这可能意味着添加好友或发送消息。一个很好的衡量你快乐路径的标准是，“如果这种情况持续下去，我应该在凌晨 2 点被呼叫吗？”

一旦你确定了你的快乐之路，你就需要用仪器测量它。大多数人都知道使用正常运行时间监控工具来确保他们的网站仍然在呈现页面。理想情况下，监视器应该确保页面上有一些内容，而不仅仅是页面返回 2XX 状态代码。您还应该考虑其他哪些指标可能会显示出问题。一些例子:成功购买的数量、登录的数量、4XX 错误的数量以及关键页面的平均加载时间。当你找到这些其他指标时，也要用仪器测量它们。它们可能并不都具有“凌晨 2 点呼我”的重要性级别，但是这些其他指示器可以检测到简单的正常运行时间检查无法发现的错误。

在我开发的一个应用程序中，我有一个仪表盘，在一周的图表上显示成功付款的数量。除了在假期期间，这两条线的趋势是一致的。有一天我们注意到“今天”线远低于“上周”线。我们进行了调查，发现我们的付款处理存在问题。由于付款是我们监控的快乐途径之一，我们能够快速解决问题。我们最终会发现问题，可能是在客户报告时。通过预先部署监控和应用程序分析，我们在太多客户受到影响之前就听说了此事。

## 5。哪里有粗糙的地方？

一旦你找到了幸福的道路，你就需要找到困难的地方。我说的粗糙点是指你没有机会彻底测试的应用程序部分。或者你集成了感觉不太靠谱的服务的地方。有时候，粗糙的地方似乎就是最容易破裂的地方。

监控这些地点可能会很棘手。他们经常以良性的方式失败，如果你不小心，你会引起警觉疲劳。我通常采取一种围绕这个问题的方法，“情况变得更糟了吗？”我将设置显示第 50 个百分点延迟的仪表板，并可能对明显超出合理范围的第 5 个百分点延迟发出警报。我还设置了应用程序分析，允许我深入研究请求，查看调用堆栈是什么样子，或者请求是如何通过一系列微服务传播的。有时，这些更详细的信息可以帮助我修复代码问题，并消除这个棘手的问题。

## 6。我的容错能力如何？

每当我在演讲中提到容错时，有些人就会有点紧张。大多数人都希望他们的应用程序能够一直运行，并且永远不会出现任何错误。我明白了。成功的感觉棒极了。与你的老板或首席执行官讨论错误预算可能会很有挑战性。但技术专业人士知道，永远在线的服务是不现实的。即使你的服务是完美的，自然灾害和鲨鱼咬海底电缆也会导致错误。

所以在你上线之前，考虑一下你能忍受多少停机时间和什么样的停机时间。半夜少量停机可以吗？可以在中午停机应用关键操作系统级别的补丁吗？当 [Heartbleed](https://en.wikipedia.org/wiki/Heartbleed) 发生时，许多运营人员不得不向他们公司的业务部门解释，为什么在这种情况下，在中午进行一次小规模停机是明智的。与业务领导一起决定什么是可接受的错误预算，以及关键错误和问题的一些基本准则。

如果你正在处理的错误预算很小，你将需要确保你的架构是有弹性的和灵活的。你可能想选择让金丝雀部署变得简单的技术。您可能需要自动回滚，并且需要定期测试回滚过程。部署到多个地区可能是谨慎的。此外，您需要提出并测试一个灾难恢复计划。

高可用性/高弹性并不是一个错误的选择，但是正确地做它需要很多前期工作。这项工作让你在事情不可避免地出错时有所准备。通过选择为支持您的目标而构建的技术、体系结构和工具，您可以减少一些准备工作。根据你的优先事项决定偶尔的停机不是什么大不了的事情也没有错。一旦你的优先事项发生变化，你可以重新审视这个决定，做出必要的改变。

## 7。我的秘密足够安全吗？

最后一个问题是提醒你审计你的代码，日志，和其他地方，以确保你的秘密是秘密。我所说的秘密主要是指 API 密钥和客户信息。大多数人都知道不要签入他们的 API 键，但是人们总是这样做。考虑一下什么级别的安全对于您的应用程序机密来说是足够的。有些人需要像哈希公司的金库或 T2 的谷歌 KMS 这样支持加密和密钥轮换的工具。其他用户满足于确保他们的 API 键位于生产服务器的环境变量中，而不是签入到源代码中。处理秘密的方法有很多；请确保您在考虑风险和用例后有目的地处理它们。

你也是客户信息的管家。信用卡号、用户名和密码很容易出现在日志、内部错误消息和警报中。即使在有安全审计的大公司中，也发生了几起引人注目的此类事件。我见过的最常见的原因是将 post 主体记录到应用程序日志、Syslog 或第三方日志服务中。我还看到一些公司使用生产数据库的下载来进行本地测试。别那样做。以某种不可逆的方式混淆数据或建立一个新的测试数据库。硬盘或笔记本电脑被入侵的风险比我们大多数人意识到的要高得多。此外，持续监控您的应用程序、日志和其他资源，以确保秘密不会进入它们不属于的地方。许多众所周知的数据泄露是由于最初推出多年后的错误修复或其他修改。