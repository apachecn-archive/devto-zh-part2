# ç”¨ AWS è·Ÿè¸ªæˆ‘çš„ Maestro å¡äº¤æ˜“

> åŸæ–‡:[https://dev . to/norus/keeping-track-of-my-maestro-card-transactions-with-AWS-4c 8](https://dev.to/norus/keeping-track-of-my-maestro-card-transactions-with-aws-4c8)

*æœ€åˆå‘å¸ƒäº:[https://dude.wait4.io/card-transactions-aws](https://dude.wait4.io/card-transactions-aws)T3ã€‘*

### ç›®çš„

æˆ‘æ˜¯é‚£ç§ä»ä¸éšèº«æºå¸¦ç°é‡‘çš„äººã€‚å—¯ï¼Œå‡ ä¹ä»æ¥æ²¡æœ‰ã€‚

ç‘å£«æ­£æœç€æ— ç°é‡‘ç¤¾ä¼šè¿ˆè¿›ã€‚ä½†æ˜¯ï¼Œä»ç„¶æœ‰è®¸å¤šåœ°æ–¹ä¸æ¥å—ä¿¡ç”¨å¡(ğŸ‘é€ƒç¨è€…)æˆ–è€…ä»–ä»¬åœ¨æŸäº›æ¡ä»¶ä¸‹æ¥å—ï¼Œæ¯”å¦‚ä½ å¿…é¡»è´­ä¹°è‡³å°‘ X çš„é‡‘é¢ã€‚

æˆ‘å¦‚ä½•è¿½è¸ªæˆ‘çš„å€Ÿè®°å¡æ¶ˆè´¹ï¼Ÿ

æˆ‘çš„é“¶è¡Œå’Œä»Šå¤©çš„è®¸å¤šå…¶ä»–é“¶è¡Œä¸€æ ·ï¼Œæä¾›ç”µå­é“¶è¡ŒæœåŠ¡ï¼Œæœ‰æ—¶æˆ‘ä¼šç”¨æ‰‹æœºæŸ¥çœ‹ä½™é¢â€”â€”ä½¿ç”¨ç‘é“¶çš„åº”ç”¨ç¨‹åºã€‚å¯¹äºæ›´é«˜çº§çš„é‡‘é’±/é¢„ç®—ç®¡ç†ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„åº”ç”¨ç¨‹åºå’Œç½‘ç«™ï¼Œæˆ‘ä¸ä¼šåœ¨è¿™ç¯‡æ–‡ç« ä¸­ä»‹ç»ã€‚

ä»¥ä¸Šçš„â€œé—®é¢˜â€æ˜¯ï¼Œå…»æˆä¸€ä¸ªä¹ æƒ¯éœ€è¦æ—¶é—´å’ŒåšæŒã€‚å¦‚æœä½ æœ‰è”åè´¦æˆ·&å€Ÿè®°å¡/ä¿¡ç”¨å¡ï¼Œäº‹æƒ…ä¼šå˜å¾—æ›´åŠ å¤æ‚ã€‚

æˆ‘æƒ³ï¼Œå¦‚æœèƒ½æ”¶åˆ°æ¯æ—¥é€šçŸ¥ï¼Œå‘ŠçŸ¥æˆ‘å½“æœˆçš„æ”¯å‡ºå’Œä½™é¢ï¼Œé‚£ä¼šå¾ˆé…·ã€‚æ˜¾ç„¶ï¼Œå¦‚æœé“¶è¡Œæœ‰å…¬å¼€/å…è´¹ä½¿ç”¨çš„ APIï¼Œå®ç°è¿™æ ·çš„äº‹æƒ…å¯èƒ½æ˜¯ä¸€ä¸ªå®¹æ˜“çš„é¡¹ç›®ã€‚æˆ–è€…æ˜¯å¦æœ‰å¯èƒ½ä»¥ç¼–ç¨‹æ–¹å¼ç™»å½•(ä¹Ÿç§°ä¸ºæ— å¤´æµè§ˆ)ï¼Œç”±äºéœ€è¦åŒå› ç´ èº«ä»½éªŒè¯ï¼Œè¿™æ— è®ºå¦‚ä½•éƒ½æ˜¯è¡Œä¸é€šçš„ã€‚å¹¸è¿çš„æ˜¯ï¼Œç‘é“¶æä¾›ç”µå­é‚®ä»¶/çŸ­ä¿¡/æ¨é€é€šçŸ¥ã€‚

[![alt text](../Images/4eeab2b475e66d6e17289e181965e96b.png "UBS Push Notification")](https://res.cloudinary.com/practicaldev/image/fetch/s--ht38UuRk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/qqxod4sk27t78c58q3le.png) 
*æ¥æº:ubs.com*

è¿™æ˜¯æˆ‘å¯ä»¥å‚¨å­˜èµ·æ¥ä¾›å°†æ¥åˆ†æçš„é‚£ç§æ•°æ®ã€‚é—®é¢˜æ˜¯å¦‚ä½•å’Œåœ¨å“ªé‡Œï¼Ÿå› æ­¤ï¼Œè¿™ç¯‡æ–‡ç« çš„ç›®çš„æœ‰ä¸¤ä¸ª:1)åœ¨æˆ‘çš„é“¶è¡Œä¸­å¯ç”¨ç”µå­é‚®ä»¶é€šçŸ¥ 2)è§£ææ•°æ®å¹¶å°†å…¶å­˜å‚¨åœ¨æŸç§æ•°æ®åº“ä¸­ã€‚

### æ‰€éœ€çš„ AWS ç»„ä»¶

> è¿‡åº¦å·¥ç¨‹åŒ–è­¦å‘Š:æˆ‘å¯ä»¥ç”¨ Python è„šæœ¬å®ç°åŒæ ·çš„ç»“æœï¼Œä½†æ˜¯è¿™æœ‰ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ

AWS ä¸­æœ‰å¤§é‡çš„[æœåŠ¡å¯ç”¨ï¼Œå°†æ¥æˆ‘å¯èƒ½ä¼šæ·»åŠ æ›´å¤šçš„ç»„ä»¶ï¼Œä½†ç°åœ¨ï¼Œæˆ‘åªéœ€è¦è¿™äº”ä¸ª:](https://docs.aws.amazon.com/aws-technical-content/latest/aws-overview/aws-overview.pdf)

*   [SES](https://aws.amazon.com/ses/) â€”é‚®ä»¶æ”¶å‘
*   [SNS](https://aws.amazon.com/sns/) â€” SNS å‘å¸ƒ/è®¢é˜…ã€ç§»åŠ¨æ¨é€å’ŒçŸ­ä¿¡
*   [Lambda](https://aws.amazon.com/lambda/) â€”è¿è¡Œä»£ç è€Œä¸è€ƒè™‘æœåŠ¡å™¨
*   [äº‘ç›‘æ§](https://aws.amazon.com/cloudwatch/) â€”ç›‘æ§èµ„æºå’Œåº”ç”¨
*   [DynamoDB](https://aws.amazon.com/dynamodb/) â€”æ‰˜ç®¡çš„ NoSQL æ•°æ®åº“

é€»è¾‘æµç¨‹éå¸¸ç®€å•:

[![alt text](../Images/5e8636449cd336569448199ea478ac03.png "AWS Workflow")T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--XSvWRND7--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/b8g1yb8b9vsexv8w7lab.png)

1.  æ”¶åˆ°é“¶è¡Œ(SES)çš„é€šçŸ¥
2.  å°†å…¶ä¼ é€’ç»™ä¸»é¢˜è®¢é˜…è€…(SNS)
3.  æå–æ—¶é—´æˆ³ã€äº¤æ˜“é‡‘é¢å’Œä½™é¢(Î»)
4.  å°†ç»“æœå­˜å‚¨åœ¨æ•°æ®åº“ä¸­(DynamoDB)

### æ¥æ”¶æ¶ˆæ¯

ç®€å•ç”µå­é‚®ä»¶æœåŠ¡(SES)æ˜¯ä¸€ç§æ¥æ”¶å’Œå‘é€ç”µå­é‚®ä»¶çš„æœåŠ¡ã€‚æ”¶åˆ°æ¶ˆæ¯åï¼ŒSES å¯ä»¥è§¦å‘æŒ‡å®šçš„æ“ä½œ:åœ¨ S3 ä¿å­˜æ¶ˆæ¯ï¼Œè¿è¡Œ Lambda å‡½æ•°ï¼Œå°†æ¶ˆæ¯å‘é€åˆ° SNS ç­‰ã€‚

ä¸ºäº†æ¥æ”¶æ¥è‡ªé“¶è¡Œçš„é€šçŸ¥ï¼Œæˆ‘çš„åŸŸçš„ MX è®°å½•å¿…é¡»æŒ‡å‘æˆ‘æ‰€åœ¨åœ°åŒºçš„ SES å…¥ç«™æœåŠ¡å™¨ã€‚

```
$ dig +short mx wait4.io
10 inbound-smtp.eu-west-1.amazonaws.com. 
```

Enter fullscreen mode Exit fullscreen mode

è¯¥åŸŸä¹Ÿæ‰˜ç®¡åœ¨ [Route 53](https://aws.amazon.com/route53/) ä¸Šï¼Œå› æ­¤ SES å¯ä»¥è‡ªåŠ¨ç”¨æ‰€éœ€çš„ TXT å’Œ MX å€¼æ›´æ–°è¯¥åŒºåŸŸï¼Œè¿™ä¸ºæˆ‘èŠ‚çœäº†ä¸€äº›æ—¶é—´ã€‚

SES å›æ‰§ *bank_alerts* è§„åˆ™é…ç½®ä¸ºåœ¨ SNS:
ä¸­å‘ *ubs_events* ä¸»é¢˜å‘å¸ƒæ¶ˆæ¯(åœ¨ [bogus@wait4.io](mailto:bogus@wait4.io) ä¸Šæ”¶åˆ°)

```
aws> ses describe-active-receipt-rule-set
{
    "Rules": [
        {
            "Name": "bank_alerts",
            "Recipients": [
                "bogus@wait4.io"
            ],
            "Enabled": true,
            "ScanEnabled": true,
            "Actions": [
                {
                    "SNSAction": {
                        "TopicArn": "arn:aws:sns:eu-west-1:0123456789:ubs_events",
                        "Encoding": "UTF-8"
                    }
                }
            ],
            "TlsPolicy": "Optional"
        }
    ],
    "Metadata": {
        "CreatedTimestamp": "2018-04-22T18:39:30.726Z",
        "Name": "default-rule-set"
    }
} 
```

Enter fullscreen mode Exit fullscreen mode

### æ¶ˆæ¯å¤„ç†

å½“åœ¨ *ubs_events* ä¸­å‘å¸ƒæ–°æ¶ˆæ¯æ—¶ï¼ŒLambda è°ƒç”¨ *parseTransaction* å‡½æ•°ã€‚è¯¥å‡½æ•°æœ‰ä¸¤ä¸ªç”¨é€”:è§£ææ¶ˆæ¯å¹¶å°†æ•°æ®å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚

```
from datetime import datetime
import json
import re
import uuid
import boto3

def lambda_handler(event, context):
    msg = json.loads(event['Records'][0]['Sns']['Message'])

    data = msg['content']
    trn = parse_data(data)

    if trn is not None:
        parse_transaction(trn) 
```

Enter fullscreen mode Exit fullscreen mode

è§£æåœ¨ *parse_data* ä¸­å®Œæˆï¼Œæ¥æ”¶åˆ°çš„æ¶ˆæ¯çš„æ ¼å¼æœ‰ä¸¤ç§å˜åŒ–â€”â€”æ¯ç§äº¤æ˜“ç±»å‹ä¸€ç§:

> ä»â€œæ”¯ç¥¨â€è´¦æˆ·ä¸­æ‰£é™¤ 100.00 ç‘å£«æ³•éƒã€‚æ–°è´¦æˆ·ä½™é¢:5775.84 ç‘å£«æ³•éƒã€‚

æˆ–è€…:

> å°† 100.00 ç‘å£«æ³•éƒè®°å…¥â€œæ”¯ç¥¨â€è´¦æˆ·ã€‚æ–°è´¦æˆ·ä½™é¢:5775.84 ç‘å£«æ³•éƒã€‚

åˆ é™¤ä¸å¿…è¦çš„å­—ç¬¦ï¼Œå¹¶å°†æ•°æ®ä¸æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…ï¼Œä»¥ç¡®å®šæ¶ˆæ¯æ˜¯å¦åŒ…å«æœ‰å…³äº¤æ˜“çš„ä¿¡æ¯ã€‚

```
def parse_data(data):
    data = data.replace('=\r\n', '').replace('\'', '')
    match = re.search(r'\w+ of CHF (.*) \w+ account \"Checking\". New account balance: CHF (.*)\.', data, re.M)

    if match:
        if 'Debit' in data:
            debit = match.group(1)
            credit = 0.00
        elif 'Credit' in data:
            credit = match.group(1)
            debit = 0.00
        balance = match.group(2)

        return {'datetime': datetime.now().isoformat(),
                'debit': format(float(debit), '.2f'),
                'credit': format(float(credit), '.2f'),
                'balance': format(float(match.group(2)), '.2f')}
    else:
        return None 
```

Enter fullscreen mode Exit fullscreen mode

æœ€ç»ˆç»“æœåŒ…å«æ’å…¥åˆ°*äº‹åŠ¡*è¡¨ä¸­çš„äº”ä¸ªé”®ã€‚è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå…¶ä¸­åŒ…å«äº¤æ˜“é‡‘é¢ã€å€Ÿæ–¹ã€è´·æ–¹ã€ä½™é¢å’Œäº¤æ˜“çš„æ—¥æœŸæ—¶é—´ã€‚è¿™ä¸ªæ•°æ®ç„¶åè¢«è½¬å‘ç»™ *parse_transaction* æ–¹æ³•ã€‚

```
def parse_transaction(trn):
    ddb = boto3.client('dynamodb')
    trn_id = uuid.uuid4().hex

    ddb.put_item(
        TableName = 'Transactions',
        Item = {'id': {'S': trn_id},
              'datetime': {'S': trn['datetime']},
              'debit': {'N': trn['debit']},
              'credit': {'N': trn['credit']},
              'balance': {'N': trn['balance']}}) 
```

Enter fullscreen mode Exit fullscreen mode

è¡¨ä¸­çš„æ¯ä¸ªäº‹åŠ¡éƒ½ç”±ä¸€ä¸ªæƒŸä¸€çš„ id æ ‡è¯†ï¼Œè¿™ä¸ª ID æ˜¯ç”± *uuid* åº“ç”Ÿæˆçš„ã€‚

[![alt text](../Images/ba082cfa6073fa466b01705a93806d04.png "Transactions Table")](https://res.cloudinary.com/practicaldev/image/fetch/s--eU1GsWrF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ate5hul3xem0giwgqu5d.png) 
*æ³¨:ç”±äºæ˜¾è€Œæ˜“è§çš„åŸå› ï¼Œæ•°å­—å¹¶éçœŸå®*

### é¢„ç®—æ›´æ–°

*æ€»è®¡*è¡¨ä¸­æ¯ä¸ªé”®çš„ç”¨é€”éå¸¸æ¸…æ¥šã€‚

*   `budget` â€”é¢„å®šä¹‰å€¼
*   `total_balance` â€”è´¦æˆ· MTD å¯ç”¨
*   `total_credit` â€”æ€»åˆ°è´¦æ“ä½œ MTD
*   `total_debit` â€”è´¦æˆ·å¤–æ“ä½œåˆè®¡ MTD

åœ¨ä»»ä½•ç»™å®šçš„æ—¶é—´ï¼Œæˆ‘æƒ³çŸ¥é“æ‰€æœ‰è¿™äº›å€¼ã€‚æ¯æ¬¡è®°å½•æ–°çš„äº¤æ˜“æ—¶ï¼Œæ€»æ•°ä¹Ÿä¼šæ›´æ–°ã€‚UBS å…è®¸é…ç½®é€šçŸ¥ï¼Œä»¥ä¾¿å‰©ä½™ä½™é¢åŒ…æ‹¬åœ¨æ¶ˆæ¯ä¸­ï¼Œä½†å¦‚æœä¸æ˜¯è¿™æ ·ï¼Œæˆ‘å°†ä¸å¾—ä¸é€šè¿‡å‡å»å€Ÿæ–¹å’Œå¢åŠ è´·æ–¹æ¥è®¡ç®—å¯ç”¨ä½™é¢ã€‚

è¿™ç§æ–¹æ³•è¦æ±‚å¯¹æ¯ä¸ªè¯·æ±‚è®¡ç®—æ€»å’Œã€‚å¯¹äºæˆ‘ä¸ªäººä½¿ç”¨æ¥è¯´ï¼Œè¿™ä¸æ˜¯é—®é¢˜ï¼Œä½†åœ¨ç‰¹å®šæƒ…å†µä¸‹ï¼Œè¿™ä¹Ÿæ„å‘³ç€æˆ‘å—åˆ°äº† DynamoDB çš„é™åˆ¶ã€‚è®¡ç®— *N* ç¬”äº¤æ˜“çš„é‡‘é¢ï¼Œéœ€è¦è¯»å– *N* æ¡è®°å½•ï¼Œå› æ­¤éœ€è¦èŠ±è´¹ *N* ä¸ªè¯»å–å®¹é‡å•ä½ã€‚æ˜¾ç„¶ï¼Œè¿™ç§è§£å†³æ–¹æ¡ˆæ˜¯ä¸å¯æ‰©å±•çš„ï¼Œå› ä¸ºå®ƒä¼šåœ¨å‡ åä¸ªäº¤æ˜“ä¸­å¯¼è‡´æ›´å¤§çš„å¤æ‚æ€§(å’Œæ›´é«˜çš„æˆæœ¬)ã€‚

åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œæ€»ä½™é¢åœ¨æ¯ç¬”äº¤æ˜“åæ›´æ–°ï¼Œå¹¶ä¸”æ€»æ˜¯æœ€æ–°çš„ï¼Œè¿™å‡å°‘äº†å¯¹æ¯ç¬”äº¤æ˜“æ±‚å’Œçš„å¿…è¦æ€§ã€‚å½“ *updateTotals* Lambda æ£€æµ‹åˆ°*äº‹åŠ¡*è¡¨ä¸­çš„å˜åŒ–æ—¶ï¼Œæ€»æ•°è¢«æ›´æ–°ã€‚å½“è€ƒè™‘å¤šçº¿ç¨‹æ—¶ï¼Œè¿™ç§æ–¹æ³•æ˜¯æœ‰æ„ä¹‰çš„ã€‚

```
from datetime import datetime
import boto3
from dateutil.parser import parse

def lambda_handler(event, context):
    for record in event['Records']:
        if record['eventName'] != 'INSERT':
            print('Unsupported event {}'.format(record))
            return

        trn = record['dynamodb']['NewImage']
        print(trn)

        parse_transaction(trn) 
```

Enter fullscreen mode Exit fullscreen mode

åœ¨è¯¥åŠŸèƒ½ä¸­ï¼Œåªæœ‰*æ’å…¥*æ“ä½œæ˜¯ç›¸å…³çš„ï¼Œå…¶ä»–æ“ä½œè¢«å¿½ç•¥ã€‚

```
def parse_transaction(trn):
    period = get_period(trn)
    if period is None:
        return

    debit = trn['debit']['N']
    credit = trn['credit']['N']
    balance = trn['balance']['N']

    refresh_totals(period, debit, credit, balance) 
```

Enter fullscreen mode Exit fullscreen mode

æœŸé—´ä»¥*å¹´æœˆ*æ ¼å¼è®¡ç®—ï¼Œè°ƒç”¨ *refresh_totals* æ–¹æ³•ã€‚

```
def get_period(trn):
    dt = parse(trn['datetime']['S'])

    return dt.strftime('%Y-%m') 
```

Enter fullscreen mode Exit fullscreen mode

åˆ·æ–°æ€»è®¡éƒ¨åˆ†:

```
def refresh_totals(period, debit, credit, balance):
    ddb = boto3.client('dynamodb')

    response = get_totals(ddb, period)

    if 'Item' not in response:
        create_totals(ddb, period, debit, credit, balance)
    else:
        total_debit = response['Item']['total_debit']['N']
        total_credit = response['Item']['total_credit']['N']
        total_balance = response['Item']['total_balance']['N']

        update_totals(ddb,
            period,
            total_debit, debit,
            total_credit, credit,
            total_balance, balance) 
```

Enter fullscreen mode Exit fullscreen mode

åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œå½“å‰æœŸé—´çš„*æ€»è®¡*ä½¿ç”¨ *get_totals* åŠ è½½ï¼Œå¹¶åœ¨å…¶ä¸­æ›´æ–°ã€‚å¦‚æœ*æ€»è®¡*ä¸å­˜åœ¨ï¼Œåˆ™ç”¨ *create_totals* åˆ›å»ºã€‚å¦‚æœå·²ç»å­˜åœ¨ï¼Œåˆ™ç”¨ *update_totals* æ›´æ–°å®ƒä»¬ã€‚

```
def get_totals(ddb, period):
    return ddb.get_item(TableName = 'Totals',
        Key = {'period': {'S': period}},
        ConsistentRead = True) 
```

Enter fullscreen mode Exit fullscreen mode

ç”±äº*æ€»æ•°*çš„æ›´æ–°å¯ä»¥ä»å‡ ä¸ªçº¿ç¨‹ä¸­è¿›è¡Œï¼Œå› æ­¤ä¸€è‡´çš„è¯»æ•°éå¸¸é‡è¦ã€‚è™½ç„¶ä»£ä»·æ›´é«˜ï¼Œä½† DynamoDB åœ¨æ“ä½œè¿‡ç¨‹ä¸­ä½¿ç”¨å¼ºä¸€è‡´æ€§è¯»å–ã€‚

```
def create_totals(ddb, period, total_debit, total_credit, total_balance):
    ddb.put_item(TableName = 'Totals',
        Item = {'period': {'S': period},
                'total_debit': {'N': total_debit},
                'total_credit': {'N': total_credit},
                'budget': {'N': '8000'},
                'total_balance': {'N': total_balance}},
        ConditionExpression = 'attribute_not_exists(period)') 
```

Enter fullscreen mode Exit fullscreen mode

å½“ä¸€ä¸ªæ–°çš„ *Totals* æ¡ç›®è¢«åˆ›å»ºæ—¶ï¼Œä¸€ä¸ª *ConditionExpression* è¢«æŒ‡å®šï¼Œä»¥é˜²æ¥è‡ªå¤šä¸ªçº¿ç¨‹çš„åŒæ—¶è¯·æ±‚ã€‚åªæœ‰å½“æ–°çš„*æ€»è®¡*ä¸å­˜åœ¨æ—¶ï¼Œ`attribute_not_exists(period)`æ‰ä¼šä¿å­˜è¯¥æ€»è®¡ã€‚
å› æ­¤ï¼Œå¦‚æœåœ¨æ­¤æœŸé—´ä»¥æŸç§æ–¹å¼åˆ›å»ºäº†å¦ä¸€ä¸ª*æ€»è®¡*(å½“è¯•å›¾å°†å…¶åŠ è½½åˆ° *load_totals* ä¸­æ—¶ï¼Œå®ƒå°†ä¸ä¼šå­˜åœ¨ï¼Œå¹¶ä¸”å½“è¯•å›¾ä½¿ç”¨ *create_totals* åˆ›å»ºå®ƒæ—¶ï¼Œ *put_item* è°ƒç”¨å°†å¯¼è‡´å¼‚å¸¸ï¼Œè¿«ä½¿æ•´ä¸ª Lambda å‡½æ•°é‡æ–°å¯åŠ¨ã€‚

```
def update_totals(ddb, period, total_debit, debit, total_credit, credit, total_balance, balance):
    ddb.update_item(TableName = 'Totals',
        Key = {'period': {'S': period}},
        UpdateExpression = 'SET #total_debit = #total_debit + :debit, #total_credit = #total_credit + :credit, #total_balance = :balance',
        ConditionExpression = '(#total_debit = :total_debit) and (#total_credit = :total_credit) and (#total_balance = :total_balance)',
        ExpressionAttributeNames = {
            '#total_debit': 'total_debit',
            '#total_credit': 'total_credit',
            '#total_balance': 'total_balance'},
        ExpressionAttributeValues = {
            ':debit': {'N': debit},
            ':total_debit': {'N': total_debit},
            ':credit': {'N': credit},
            ':total_credit': {'N': total_credit},
            ':balance': {'N': balance},
            ':total_balance': {'N': total_balance}}) 
```

Enter fullscreen mode Exit fullscreen mode

åœ¨*æ€»è®¡*è¡¨:
ä¸­æ›´æ–°*æ€»è®¡ _ å€Ÿæ–¹*çš„å€¼

```
UpdateExpression = 'SET #total_debit = #total_debit + :debit' 
```

Enter fullscreen mode Exit fullscreen mode

ä»¥ä¸Šçš„ *UpdateExpression* å¯¹äºè¿™æ¬¡æ›´æ–°æ¥è¯´å¯èƒ½å·²ç»è¶³å¤Ÿäº†(å®‰å…¨æ–¹é¢çš„),ä½†æ˜¯æˆ‘å†³å®šæ›´å®é™…ä¸€äº›ã€‚åœ¨è¿™æ ·åšçš„æ—¶å€™ï¼Œæˆ‘æ·»åŠ äº†ä¸€ä¸ª*æ¡ä»¶è¡¨è¾¾å¼*æ¥æŒ‡ç¤º DynamoDBï¼Œåªæœ‰å½“*æ€»æ•°*æ²¡æœ‰åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­æ›´æ–°æ—¶ï¼Œè®°å½•æ‰åº”è¯¥è¢«æ›´æ–°ï¼Œå¹¶ä¸”å®ƒä»ç„¶åŒ…å«ä¼ é€’çš„å€¼:

```
ConditionExpression = '(#total_debit = :total_debit)' 
```

Enter fullscreen mode Exit fullscreen mode

æœ€ç»ˆçš„æ›´æ–°å¦‚ä¸‹æ‰€ç¤º:

[![alt text](../Images/af13a8dd2410f472cde9735572baabcf.png "Summary Table")](https://res.cloudinary.com/practicaldev/image/fetch/s--9fcCBrjx--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ql8dh4n3460cn5fasifa.png) 
*æ³¨:ç”±äºæ˜¾è€Œæ˜“è§çš„åŸå› ï¼Œæ•°å­—å¹¶éçœŸå®*

### æ€»è®¡é€šçŸ¥

è®¾ç½®çš„æœ€åä¸€éƒ¨åˆ†æ˜¯è·å–æ¯æ—¥æŠ¥å‘Šï¼Œé€šçŸ¥æµç¨‹åŒæ ·éå¸¸ç®€å•:

[![alt text](../Images/50c66c8e1a70068fac8b9066d0cfa9a1.png "AWS Workflow")T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--LjoF8b_J--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/d6qmoce9qbo7g9j53rqh.png)

æˆ‘é…ç½®äº† *CloudWatch å®šæ—¶å™¨*åœ¨æ¯å¤© 19:00 GMT è§¦å‘ *dailyNotify* Lambda åŠŸèƒ½ã€‚

[![alt text](../Images/2a8de2316be88473e7dcfcb950f6e4ad.png "DailyBankingNotification")T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--E2tdqvZY--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ibyd81akjynmsr0bhwyu.png)

*load* å‡½æ•°ä» DynamoDB è¡¨ä¸­æ£€ç´¢æ•°æ®ï¼Œè€Œ *make_html* å‡½æ•°è¿”å› html ä»£ç ã€‚

```
import boto3
import decimal
from datetime import datetime
from operator import itemgetter

def load_summary(ddb, period):
    result = ddb.get_item(TableName = 'Totals',
        Key = {'period': {'S': period}},
        ConsistentRead = True)

    return result

def load_last_transactions(ddb, num_trans=5):
    table = ddb.scan(TableName = 'Transactions')

    entries = []
    for i in table['Items']:
      i['datetime']['S'] = datetime.strptime(i['datetime']['S'], '%Y-%m-%dT%H:%M:%S.%f')
      entries.append(i)

    result = sorted(entries, key=itemgetter('datetime'), reverse=True)

    return result[:num_trans]

def make_transactions_html(data):
    html_start = '''
            <h3>Last 5 transactions</h3>
            <div class="divTable">
                <div class="divTableHeading">
                    <div class="divTableRow">
                        <div class="divTableHead">Datetime</div>
                        <div class="divTableHead">Debit</div>
                        <div class="divTableHead">Credit</div>
                        <div class="divTableHead">Balance</div>
                    </div>
                </div>'''

    html_rows = ''
    for trn in data:
        html_rows += '''
                <div class="divTableRow">
                    <div class="divTableCell">{}</div>
                    <div class="divTableCell">CHF {}</div>
                    <div class="divTableCell">CHF {}</div>
                    <div class="divTableCell">CHF {}</div>
                </div>'''.format('{:%Y-%m-%dT%H:%M:%S}'.format(trn['datetime']['S']),
                    float(trn['debit']['N']),
                    float(trn['credit']['N']),
                    float(trn['balance']['N']))

    html_end = '''
            </div>'''

    return '{}{}{}'.format(html_start, html_rows, html_end)

def make_summary_html(data, period):
    html = '''
            <h3>Totals for {0}</h3>
            <div class="divTable">
                <div class="divTableHeading">
                    <div class="divTableRow">
                        <div class="divTableHead">Total Debit</div>
                        <div class="divTableHead">Total Credit</div>
                        <div class="divTableHead">Current Balance</div>
                    </div>
                </div>
                <div class="divTableRow">
                    <div class="divTableCell">CHF {1:.2f}</div>
                    <div class="divTableCell">CHF {2:.2f}</div>
                    <div class="divTableCell">CHF {3:.2f}</div>
                </div>
            </div>'''.format(period,
                    float(data['Item']['total_debit']['N']),
                    float(data['Item']['total_credit']['N']),
                    float(data['Item']['total_balance']['N']))

    return html

def lambda_handler(event, context):
    ddb = boto3.client('dynamodb')

    current_period = datetime.today().strftime('%Y-%m')

    summary_result = load_summary(ddb, current_period)
    transactions_result = load_last_transactions(ddb)

    summary_html = make_summary_html(summary_result, current_period)
    transactions_html = make_transactions_html(transactions_result)

    send_email(summary_html, transactions_html) 
```

Enter fullscreen mode Exit fullscreen mode

æœ€åï¼Œhtml ä»£ç è¢«ä¼ é€’ç»™ email å‡½æ•°ã€‚

```
def send_email(totals_html, transactions_html):
    client = boto3.client('ses', region_name = 'eu-west-1')

    MAIL_FROM = 'bogus@wait4.io'
    MAIL_TO = ['bogus@gmail.com']
    SUBJECT = 'AWS Bank Summary Daily Report'

    HTML_BODY = '''<html>
    <head>
    <style>
    .divTable {{
      display: table;
      width: 100%;
    }}
    .divTableRow {{
      display: table-row;
    }}
    .divTableCell, .divTableHead {{
      border: 1px solid #999999;
      display: table-cell;
      padding: 3px 10px;
    }}
    .divTableHeading {{
      background-color: #EEE;
      display: table-header-group;
      font-weight: bold;
    }}
    .divTableBody {{
      display: table-row-group;
    }}
    </style>
    </head>
    <body>
    {0}
    {1}
    </body>
    </html>'''.format(totals_html, transactions_html)

    response = client.send_email(
        Destination = {
            'ToAddresses': MAIL_TO
        },
        Message = {
            'Body': {
                'Html': {
                    'Charset': 'UTF-8',
                    'Data': HTML_BODY,
                },
            },
            'Subject': {
                'Charset': 'UTF-8',
                'Data': SUBJECT,
            },
        },
        Source = MAIL_FROM) 
```

Enter fullscreen mode Exit fullscreen mode

### æ€æƒ³

æš‚æ—¶å°±è¿™æ ·å§ï¼äº¤æ˜“å‘ç”Ÿåï¼Œä¼šå¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œæ›´æ–°æ€»æ•°ï¼Œå¹¶åœ¨ä¸€å¤©ç»“æŸæ—¶å‘é€ä¸€ä»½æŠ¥å‘Šã€‚

[![alt text](../Images/6b45c24c0e3563810fa6d19a23282882.png "Daily Email Report")](https://res.cloudinary.com/practicaldev/image/fetch/s--dfWp2LKr--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/4qhdn5jyibf0lvqxpk2f.png) 
*æ³¨:ç”±äºæ˜¾è€Œæ˜“è§çš„åŸå› ï¼Œæ•°å­—å¹¶éçœŸå®*

æˆ‘æœ‰æ›´å¤šçš„è®¡åˆ’æ¥æ‰©å±•åŠŸèƒ½ï¼Œå¦‚åŒ…æ‹¬å•†å®¶ä¿¡æ¯å’Œæ¯ä¸ªæˆæœ¬ç±»åˆ«çš„æ”¯å‡ºã€‚ä½¿ç”¨ D3.js æˆ–ç±»ä¼¼çš„åˆ¶ä½œä¸€äº›è§†è§‰æ•ˆæœä¹Ÿå¾ˆæ£’ï¼Œä½†æ˜¯æˆ‘ä¼šä¸ºæ­¤å†™ä¸€ç¯‡æ–°çš„å¸–å­ã€‚

æ•¬è¯·å…³æ³¨ï¼Œæ„Ÿè°¢é˜…è¯»ï¼ğŸ™Œ