# 谷歌应用程序脚本中的自定义功能的工作流程还算不错

> 原文:[https://dev . to/MW allin/something-deadline-workflow-for-custom-functions-in-Google-apps-script-57o 0](https://dev.to/mwallin/somewhat-decent-workflow-for-custom-functions-in-google-apps-script-57o0)

# [T1】简介](#intro)

这将是一篇很长的文章，详细介绍我为 Google Sheets 编写自定义函数的过程。这也是我的第一个帖子(任何地方)，所以请善待...

# TL；速度三角形定位法(dead reckoning)

[https://github.com/MWallin/GAS_insertValues](https://github.com/MWallin/GAS_insertValues)

点击此处查看完整的回购协议。克隆，安装，用扣拉，开始！

# 什么是 Google apps 脚本自定义功能？

Google apps 太棒了！我们在工作中使用它，它几乎拥有 Excel 的所有功能，但它包括实时编辑。Excel 中的大部分功能都在那里，谷歌已经添加了一些自己的功能，使其成为一个真正强大的电子表格工具。也许不是最好的，但对于 90%的常规用例来说已经足够了。

# 什么是自定义函数？

当内置功能不足以满足您的需求时，您可以添加自己的功能！

Excel 几乎从一开始就有这种功能，这也是它如此受欢迎的原因之一，它很容易扩展。当然，Google apps Sheets 也有这个。

在 Excel 中，用于编辑宏/自定义函数的 IDE 相当不错，并且有很多附加功能。然而，VBA (Visual Basic for Applications)并不是很有趣，而且 IDE 已经很久没有更新了。

在这里，人们可能会认为谷歌有一个好的 IDE 来编辑自定义功能，当然，这并不坏，只是不太好。尤其是与我在其他代码中使用的 VS 代码相比。但至少谷歌用的是 Javascript 而不是 VBA。然而，我不完全确定他们使用的是哪个版本的 Javascript，我也找不到任何相关信息...

# 为什么要自定义函数？

Excel 和 Google Sheets 中有很多内置函数，但我不时需要做一些定制。在工作中，我们共享大量的配置数据，这些数据最终会进入 SQL-database。SQL 数据库中的表本质上是工作表，工作表比数据库更容易编辑和使用。因此，我们使用工作表来共享和操作大量数据。它并不完美，但很有效。

然而，最终，数据需要返回到数据库中，这通常是以 INSERT()的形式...值()...声明。进入 values 位的内容实际上是工作表中行的串联形式，带有一些分隔符。

在工作表中使用常规函数来组合数据是可能的，但是它非常脆弱，并且不具备真正的可伸缩性。此外，当一个单元格中有一个巨大的公式时，大多数工作人员都会有点紧张。短短的两个字的公式感觉好多了。

另外，通过自定义函数，用户可以随心所欲地处理数据。删除单元格中的换行符，不用担心，转义任何字符，容易。

# 如何开始？

那么，如何开始编写自定义函数呢？

简单，只需打开工作表，进入工具，然后脚本编辑器，你已经在一个新的标签页中打开了集成的代码编辑器。

你需要的一切都在那里。但是你*想要的一切*都来自现代开发环境或 IDE，比如 Visual Studio 代码？几乎没有！从易用性上感觉像是记事本的一个端口。

我在这里写了自己的第一个自定义函数，一个计算瑞典新车税的小脚本，函数不大但也不小。所以环境是可行的，只是感觉有点次优。所以让我们解决这个问题吧！

# 获得体面的工作流程

我用 Visual Studio 代码编写我所有的 javascript，我认为这很棒。我来自崇高的文本，我从来没有真正感觉点击我。但是 VSCode，太神奇了。那么如何让我在这里写所有的自定义函数成为可能呢？

## 扣子

第一步是扣，[https://github.com/google/clasp](https://github.com/google/clasp)。

这是一个命令行工具，工作方式有点像 Git。它有很多功能，但在自定义功能的环境中，只需要学习一些命令；克隆和推送。

*克隆*复制本地脚本，*推送*将本地代码复制回工作表。

在经历了许多挫折之后，我了解到使用定制函数不可能用 CLASP 创建脚本，因为脚本被绑定到特定的 Sheets 实例(或者仅仅是 Sheet)。

所以第一步是从工作表中创建一个新的脚本，然后计算出脚本 ID。在脚本编辑器中，您可以在存档和项目属性中找到它。

在编辑器中写几行代码，让验证一切正常变得非常容易。

然后按照 GitHub 上的说明安装 CLASP。记得登录并启用应用程序脚本 API。

类型扣克隆在你选择的目录中。这个目录现在将包含这个项目。

## 林挺和其他好东西

下一步是在 VSCode 中打开项目，[https://code.visualstudio.com/](https://code.visualstudio.com/)！

我在 VSCode 中安装了很多扩展，但我最喜欢的一个毫无疑问是 ESLint，所以接下来是让林挺工作。

我喜欢在每个项目中本地安装尽可能多的依赖项，所以让我们做 *npm install eslint 和 eslint-plugin-googleappsscript-D-E*。

我使用的规则在示例 repo 中。我不会说这些是用于天然气开发的最好的 eslint 设置，但它确实有效。随意定制。大部分规则是我的 javascript 开发标准，对 GAS 做了一些调整。

## 测试...

现在，您可能已经编写了一两个函数，并希望运行它，看看它是否如您所愿地工作。但是唉，自定义函数中的调试体验甚至还不算差，就是根本没有！没有日志记录，没有调试器，当从一个表中实际输入运行定制函数时什么都没有。仔细想想，这并不奇怪。但这确实有助于努力工作。

但是，这个叫 TDD 的东西，会有帮助吗？当然可以！

这不是一个 TDD 教程，但是我会给你一些提示，让你在以这种方式使用定制函数时能够使用 TDD。

写很多测试！为了每一个可能的情况。并且对每个场景进行一次以上的测试以保证健壮性。

我用 mocha 和 chai 编写测试，效果非常好，我还在 VSCode 中使用 Mocha 侧边栏扩展。这是一个非常好的流程和体验。

但是等等，为了能够为一个函数编写测试，您必须导出它并将其导入到另一个文件中。Google Sheets 怎么会喜欢这种说法呢？

实际上一点也不！如果您推送的代码包含类似于*module . exports = insert values；*

## 建筑

但是不要担心！大口是你的朋友！

我用 webpack 做了一点试验，因为它是任何需要定制构建过程的项目的奇迹创造者。但是一点成功都没有！

Webpack 可能真的很适合这个，但几个小时后，我放弃了，并寻找替代方案。然后输入 Gulp，一个轻量级的、易于理解的工具，它非常容易配置来完成我的命令。它是不是最好的工具，可能不是，但它是有效的。

查看 repo 以了解所有细节，但总的来说，有一个简短的脚本删除了包含任何导出或导入内容的所有行，然后将所有内容连接到一个主文件和一个 utils 文件中。

main 包含添加到工作表中的自定义函数，utils 是使其工作的所有其他东西。

通过以这种方式连接一切，可以使用更小的文件和自己的功能来简化编码，然后将它们放在一起，使 Google Sheets 很高兴周围没有太多的文件。

## 出招

下一步是将所有更改推回到 Google Sheets，以使用新的自定义功能。那很简单，只需运行*扣推*即可。

但是！

首先，您需要构建代码。我们只想做到这一点，如果所有的测试都通过了，我们就全力以赴。没有必要去推动那些不起作用的代码。

那么如何在 VSCode 中做到这一点呢？

下面是我的做法，在 package.json 中，添加这一点:

"脚本":{
"发布":" npm 运行测试& & npm 运行构建& & npm 运行部署"，
"部署":"扣扣推送"，
"构建":"大口构建"，
"测试":"摩卡"
}

测试确保所有的测试运行。构建负责代码的构建。
部署推送一切。

Publish 用&&组合所有的任务，如果一个步骤失败就中止所有的任务。

如果测试没有通过，那么其他任何东西都不会执行。

## 处理输入

嗯，越来越长了，谢谢你一路看完，现在剩下的不多了。

现在最棘手的部分来了。你已经写了你的函数和大量的测试，你知道它是可靠的！唯一的问题是，当你用真实数据推动和运行它时，它就不会工作。

这是因为来自工作表的输入很可能不是您所想的那样。

阅读这个答案并运行示例中的代码，[https://stackoverflow.com/a/20288490](https://stackoverflow.com/a/20288490)。

取决于你输入的是一个单元格，同一行或同一列的几个单元格还是整个范围的单元格，输入会完全不同。

我花了太多时间才弄明白，因为我最初找到的文档说一个单元格=一个值，多个单元格=数组。但要看情况。有时你会得到一个数组的数组，现在完全一样。

请随意使用我在 repo 中的 makeArray 函数来解决这一点。我不能保证它在任何情况下都有效，但是它对我来说已经足够好了。

## 把所有的东西放在一起

这是完成的项目:[https://github.com/MWallin/GAS_insertValues](https://github.com/MWallin/GAS_insertValues)

可能不是最好的代码。但可能不是最糟糕的。

# 结论

结束了！

这差不多是我的旅程，我希望能帮助一些人弄清楚这些事情。当然，这需要对新工具进行大量的设置和学习。但我喜欢这样。我喜欢学习和让事情运转起来。因为当一切正常时，我对自己写的代码更有信心了！对所有东西都进行测试，这真是太棒了，我都不知道在开发过程中它帮我节省了多少时间。

当然，我的示例项目确实很小，但是对于我们工作中的人来说，它真的很有价值。

* * *

我想我已经把每一步都包括在内了，但是如果你认为还缺少什么，请留下评论！