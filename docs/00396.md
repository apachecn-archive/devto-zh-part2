# å¸¦ Devicons çš„ VIM fzf

> åŸæ–‡:[https://dev.to/coreyja/vim-fzf-with-devicons-11ee](https://dev.to/coreyja/vim-fzf-with-devicons-11ee)

[![Example Screenshot](../Images/a082731fc57b3fc66be30f9d86ad8417.png)T2ã€‘](https://coreyja.com/images/posts/vim-fzf-with-devicons/example-screenshot-7d212371.png)

*æ­¤æ–‡æœ€åˆå‘å¸ƒäº[coreyja.com](https://coreyja.com/vim-fzf-with-devicons/)T3ã€‘*

## [](#background)èƒŒæ™¯

å½“æˆ‘ç”¨ fzf å†™æˆ‘çš„ä¸Šä¸€ç¯‡åšæ–‡ [VIM æ‹¼å†™å»ºè®®æ—¶ï¼Œæˆ‘å¾—åˆ°äº†ä¸€äº›å…³äº](https://coreyja.com/vim-spelling-suggestions-fzf/) [dev.to](https://dev.to) çš„è¯„è®ºï¼å…¶ä¸­ä¸€æ¡æ¥è‡ª [@maxdevjs](https://dev.to/maxdevjs) ã€‚æˆ‘ä»¬äº¤æµäº†å‡ å¥ï¼Œæˆ‘åœ¨ä»–çš„ dotfiles é‡Œå‘ç°äº† [`vim-devicons`](https://github.com/ryanoasis/vim-devicons) ï¼å®ƒä¸[ä¹¦å‘†å­](https://github.com/preservim/nerdtree)å’Œ[èˆªç©ºå…¬å¸](https://github.com/vim-airline/vim-airline)ä¸€èµ·å¼€ç®±å³ç”¨ï¼Œæˆ‘çœŸçš„å¾ˆå–œæ¬¢å®ƒï¼ [@maxdevjs](https://dev.to/maxdevjs) ä¹Ÿæœ‰è¿™ä¸ª [Github é—®é¢˜](https://github.com/ryanoasis/vim-devicons/issues/106)çš„é“¾æ¥ï¼Œå…³äºäººä»¬å¦‚ä½•èƒ½å¤Ÿæ·»åŠ  fzf æ”¯æŒã€‚æˆ‘æ˜¯åœ¨ fzf è¸¢ï¼Œæ‰€ä»¥è¿™è®©æˆ‘æ„Ÿå…´è¶£ï¼

## [](#original-solution)åŸè§£

Github é—®é¢˜å·²ç»æœ‰äº†ä¸€ä¸ªåŠŸèƒ½è§£å†³æ–¹æ¡ˆï¼ä»¥ä¸‹æ˜¯æˆ‘ç”¨ä½œæ­¤åŸºç¡€çš„è¯„è®ºï¼Œ[https://github . com/ryano asis/vim-devicons/issues/106 # issue comment-354629715](https://github.com/ryanoasis/vim-devicons/issues/106#issuecomment-354629715)

ä»¥ä¸‹æ˜¯æ¥è‡ªè¯¥è¯„è®ºçš„æºä»£ç :

```
" Files + devicons
function! Fzf_dev()
  let l:fzf_files_options = '--preview "rougify {2..-1} | head -'.&lines.'"'

  function! s:files()
    let l:files = split(system($FZF_DEFAULT_COMMAND), '\n')
    return s:prepend_icon(l:files)
  endfunction

  function! s:prepend_icon(candidates)
    let l:result = []
    for l:candidate in a:candidates
      let l:filename = fnamemodify(l:candidate, ':p:t')
      let l:icon = WebDevIconsGetFileTypeSymbol(l:filename, isdirectory(l:filename))
      call add(l:result, printf('%s %s', l:icon, l:candidate))
    endfor

    return l:result
  endfunction

  function! s:edit_file(item)
    let l:pos = stridx(a:item, ' ')
    let l:file_path = a:item[pos+1:-1]
    execute 'silent e' l:file_path
  endfunction

  call fzf#run({
 \ 'source': <sid>files(),
 \ 'sink':   function('s:edit_file'),
 \ 'options': '-m ' . l:fzf_files_options,
 \ 'down':    '40%' })
endfunction 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸Šé¢åšäº†ä¸‰ä»¶åŸºæœ¬çš„äº‹æƒ…:

1.  ä½¿ç”¨ [`rouge`](https://github.com/rouge-ruby/rouge) gem åœ¨ fzf ä¸­åˆ›å»ºè¯­æ³•é«˜äº®é¢„è§ˆ
2.  å°† devicon å‰ç½®åˆ°ç”±`$FZF_DEFAULT_COMMAND`ç”Ÿæˆçš„æ¯ä¸€è¡Œï¼Œå¹¶å°†å…¶ç”¨ä½œ`fzf`æº
3.  è®¾ç½®`sink`,ä»¥ä¾¿å½“æ‚¨é€‰æ‹©ä¸€ä¸ªé€‰é¡¹æ—¶ï¼Œå›¾æ ‡è¢«å»æ‰ï¼Œæ‚¨å¯ä»¥ç¼–è¾‘ç›®æ ‡æ–‡ä»¶

å½“æˆ‘æŠŠå®ƒå¤åˆ¶åˆ°æˆ‘çš„ dotfiles ä¸­ï¼Œå¹¶æ‘†å¼„å®ƒçš„æ—¶å€™ï¼Œæˆ‘æœ‰äº†ä¸€äº›æˆ‘æƒ³æ”¹è¿›çš„åœ°æ–¹ï¼

## [](#preview)é¢„è§ˆ

æœ€åˆçš„è§£å†³æ–¹æ¡ˆä½¿ç”¨`rogue`æ¥åˆ›å»ºè¯­æ³•é«˜äº®é¢„è§ˆã€‚æˆ‘å–œæ¬¢é¢„è§ˆï¼Œä½†è§‰å¾—æµæ°“æ¸²æŸ“èŠ±äº†å¤ªé•¿æ—¶é—´ã€‚æˆ‘å¯¹ fzf çš„ä½¿ç”¨å®Œå…¨æ˜¯ä¸ºäº†é€Ÿåº¦ï¼Œæ‰€ä»¥æ¸²æŸ“æ»åäºæˆ‘é€‰æ‹©çš„é€‰é¡¹æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œä¹Ÿæ˜¯ä»¤äººè®¨åŒçš„ã€‚
æœ€è¿‘æˆ‘(é‡æ–°)å‘ç°äº† [`bat`](https://github.com/sharkdp/bat) ï¼Œæ˜¯`cat`çš„æ›¿æ¢ï¼Œè¿˜åŒ…æ‹¬è¯­æ³•é«˜äº®ï¼

æ‰€ä»¥æˆ‘åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯æŠŠ`rougify`æ›¿æ¢æˆ`bat`,å¾—åˆ°äº†å¦‚ä¸‹ä¸€è¡Œã€‚

```
let l:fzf_files_options = '--preview "bat {2..-1} | head -'.&lines.'"' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æˆåŠŸäº†ï¼æˆ‘å¾—åˆ°äº†å‡ ä¹å³æ—¶çš„ç»“æœğŸ‰ã€‚ä¸å¹¸çš„æ˜¯ï¼Œå®ƒæ²¡æœ‰çªå‡ºè¯­æ³•ã€‚æˆ‘æ„è¯†åˆ°è¿™æ˜¯å› ä¸º`bat`è¯•å›¾ä¸`cat`å…¼å®¹ï¼Œå¦‚æœå®ƒæ£€æµ‹åˆ°ä½ æ­£åœ¨é€šè¿‡ç®¡é“è¾“å‡º(å°±åƒé¢„è§ˆç‰ˆä¸­å‘ç”Ÿçš„é‚£æ ·)ï¼Œå®ƒé»˜è®¤è¡¨ç°å¾—åƒä¸€ä¸ª`cat`å…‹éš†ä½“ã€‚å¹¸è¿çš„æ˜¯ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜å°±åƒæŠŠä¸€ä¸ªé€‰é¡¹ä¼ ç»™`bat`ï¼Œ`--color always`æˆåŠŸäº†ï¼`bat`é»˜è®¤è¿˜åŒ…æ‹¬è¡Œå·å’Œè¡¨å¤´ã€‚æˆ‘å–œæ¬¢è¡Œå·ä½†ä¸å–œæ¬¢æ ‡é¢˜ï¼Œæ‰€ä»¥æˆ‘é€šè¿‡æ˜ç¡®åœ°è¯´æˆ‘åªæƒ³è¦å¸¦æœ‰`--style numbers`çš„è¡Œå·æ¥éšè—å®ƒã€‚ç°åœ¨æˆ‘çš„é¢„è§ˆçº¿çœ‹èµ·æ¥å¦‚ä¸‹:

```
let l:fzf_files_options = '--preview "bat --color always --style numbers {2..} | head -'.&lines.'"' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™ä¹‹åï¼Œæˆ‘å¯¹ fzf æä¾›çš„é¢„è§ˆæ„Ÿåˆ°å…´å¥‹ã€‚

## [](#prepending-the-devicons)å‰ç½®å›¾æ ‡

æˆ‘å–œæ¬¢ fzfï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªæµå¼æ¨¡ç³ŠæŸ¥æ‰¾å™¨ï¼Œè¿™æ„å‘³ç€ä½ ç”šè‡³å¯ä»¥åœ¨æ”¶åˆ°æ‰€æœ‰è¾“å…¥ä¹‹å‰å°±å¼€å§‹æ¨¡ç³ŠæŸ¥æ‰¾ã€‚è¿™å¾ˆé‡è¦ï¼Œå› ä¸ºæˆ‘å°†æˆ‘çš„é»˜è®¤ fzf å‘½ä»¤(`$FZF_DEFAULT_COMMAND`)è®¾ç½®ä¸ºå¦‚ä¸‹ï¼Œå®ƒåŒ…æ‹¬å¤§å¤šæ•°éšè—çš„æ–‡ä»¶å¹¶è€ƒè™‘ç¬¦å·é“¾æ¥ã€‚å› æ­¤ï¼Œåœ¨ä¸€ä¸ªå…¸å‹çš„ Rails é¡¹ç›®ä¸­ï¼Œæˆ‘ç»å¸¸ä¼šæœ‰æ•°ä¸‡ä¸ªç»“æœï¼Œå¹¶æœ‰ä¸€ä¸ª`node_modules`ç›®å½•ã€‚

```
rg --files --no-ignore --hidden --follow --glob "!.git/*" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“æˆ‘ç¬¬ä¸€æ¬¡å¼€å§‹æµ‹è¯•è¿™äº›è§£å†³æ–¹æ¡ˆæ—¶ï¼Œæˆ‘ä½¿ç”¨çš„ç›®å½•åªæœ‰æœ‰é™æ•°é‡çš„æ–‡ä»¶ã€‚åœ¨è¿™äº›ç›®å½•ä¸­ï¼Œæˆ‘æ²¡æœ‰æ³¨æ„åˆ°æ·»åŠ å›¾æ ‡æ—¶é€Ÿåº¦å˜æ…¢ã€‚ä½†æ˜¯å½“æˆ‘ç§»åŠ¨åˆ°ä¸€äº›å®é™…çš„é¡¹ç›®ç›®å½•æ—¶ï¼Œæˆ‘æ„è¯†åˆ° fzf åœ¨ä¸€æ¬¡å¡«å……æ‰€æœ‰ç»“æœä¹‹å‰ä¼šæ‰“å¼€ç©ºçš„ã€‚è¿™ç§å»¶è¿Ÿè®©æˆ‘å¾ˆçƒ¦ï¼Œæˆ‘æœ‰å¿ƒæƒ…å»ä¼˜åŒ–ï¼

## [](#streaming-bash)ä¸²æµç—›å‡»

æˆ‘ä»æœ€è¿‘åœ¨ VIM ä¸­ä¸ fzf çš„åˆä½œä¸­äº†è§£åˆ°ï¼Œå®ƒä¸ºå…¶æºä»£ç æ¥å—äº†ä¸€äº›ä¸œè¥¿ã€‚ä¸¤ä¸ªå¤§çš„æ˜¯ VIM åˆ—è¡¨æˆ–æŒ‡ç¤ºè¦è°ƒç”¨çš„ shell å‘½ä»¤çš„å­—ç¬¦ä¸²ã€‚åœ¨æœ€åˆçš„è§£å†³æ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨ fzf é»˜è®¤å‘½ä»¤ï¼Œå¹¶åœ¨ vim ä¸­ç”¨`system`æ‰§è¡Œå®ƒã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å°†è·å– fzf é»˜è®¤å‘½ä»¤çš„å…¨éƒ¨è¾“å‡ºï¼Œå¹¶åœ¨ vim ä¸­å¤„ç†å®ƒã€‚ç„¶åæˆ‘ä»¬åœ¨æ–°è¡Œä¸Šåˆ†å‰²å®ƒï¼Œå¾—åˆ°ä¸€ä¸ª vim åˆ—è¡¨ã€‚æˆ‘ä»¬éå†åˆ—è¡¨ä¸­çš„æ¯ä¸ªæ–‡ä»¶åï¼Œå¹¶é¢„å…ˆè®¾ç½®æ­£ç¡®çš„ deviconã€‚ç„¶åæˆ‘ä»¬å°†è¿™ä¸ªåˆ—è¡¨ä¼ é€’ç»™`fzf`ä½œä¸ºæºã€‚
è¿™å·¥ä½œå¾—éå¸¸å¥½ï¼Œä½†æ˜¯è¿™å°±æ˜¯æˆ‘æ³¨æ„åˆ°çš„æ»åçš„æ¥æºã€‚åœ¨ fzf å‘æˆ‘æ˜¾ç¤ºä»»ä½•ç»“æœä¹‹å‰ï¼Œrg å‘½ä»¤å¿…é¡»ç»“æŸï¼Œç„¶åæ–‡ä»¶åå¿…é¡»åŠ ä¸Šå›¾æ ‡ï¼Œæœ€åï¼Œfzf å¯ä»¥å‘ˆç°åˆ—è¡¨ã€‚è¿™æ„å‘³ç€ fzf ä¸å†èƒ½å¤Ÿâ€œæµå¼ä¼ è¾“â€,å¿…é¡»ç­‰å¾…æ‰€æœ‰è¾“å…¥å‡†å¤‡å°±ç»ªåæ‰èƒ½å¼€å§‹æ˜¾ç¤ºç»“æœã€‚

å¦‚æœä½¿ç”¨ bash å‘½ä»¤ä½œä¸º fzf æºä»£ç çš„å­—ç¬¦ä¸²ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨æµã€‚æˆ‘æ„è¯†åˆ°è¦å®ç°æµï¼Œæˆ‘éœ€è¦ä¸€ä¸ª VIM ä¹‹å¤–çš„è§£å†³æ–¹æ¡ˆã€‚ç”±äºè¾“å…¥æ˜¯ä¸€ä¸ª bash å‘½ä»¤ï¼Œbash æ˜¾ç„¶æ˜¯æˆ‘çš„ç¬¬ä¸€é€‰æ‹©ï¼Œæˆ‘æ­£åœ¨è¿›è¡Œæ¦‚å¿µéªŒè¯ï¼åŸºæœ¬çš„æƒ³æ³•æ˜¯ï¼Œæˆ‘å°†æœ‰ä¸€ä¸ªè„šæœ¬ï¼Œé€šè¿‡ STDIN æ¥æ”¶è¡Œï¼Œå¹¶ä¸ºæ¯ä¸€è¡Œé¢„å…ˆæ·»åŠ æ­£ç¡®çš„ deviconã€‚ç„¶åï¼Œå®ƒä¼šå°†æ¯ä¸€è¡Œè¾“å‡ºåˆ° STDOUTã€‚è¿™æ ·ï¼Œå®ƒå°†â€œæµâ€å‡ºå¸¦æœ‰å‰ç½® devicons çš„æ–°è¡Œã€‚

æˆ‘å†³å®šå¿«é€ŸæŸ¥çœ‹ï¼Œä»¥ç¡®ä¿æœ‰äººè¿˜æ²¡æœ‰è¿™æ ·åšï¼Œå¹¶å‘ç°äº† [ryanoasis/devicons-shell](https://github.com/ryanoasis/devicons-shell) ï¼Œå®ƒä¸ [`vim-devicons`](https://github.com/ryanoasis/vim-devicons) æ’ä»¶å‡ºè‡ªåŒä¸€ä¸ªäººä¹‹æ‰‹ï¼å®ƒå¹¶ä¸å®Œå…¨ç¬¦åˆæˆ‘çš„è¦æ±‚ï¼Œä½†ä¹Ÿå¾ˆæ¥è¿‘äº†ã€‚æˆ‘ç”¨å®ƒçš„å¤§éƒ¨åˆ†æ¥å†™æˆ‘çš„åˆå§‹åŸå‹ï¼Œæœ€ç»ˆçœ‹èµ·æ¥å¦‚ä¸‹:

```
function devicons_get_filetype_symbol {
  declare -A extensions=(
    [ai]=î´
    ... (Shortened for brevity)
    [zsh]=î•
  )

  local folder="î—¿"
  local filetype
  local default=î˜’
  local exist_check=1
  local input=$1
  local filename="$1"
  # using ## for possibly more than one "." (get after last one):
  local filetype="${filename##*.}"

  if [ -d "$filename" ]; then local symbol=$folder
  elif [ ! -z "$filetype" ] && [ ${extensions[$filetype]+$exist_check} ]; then local symbol=${extensions[$filetype]}
  else local symbol=$default
  fi echo "$symbol"
  return 0
}

while IFS= read -r line; do echo -e "$(devicons_get_filetype_symbol $line)  $line"
done 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ç”¨`ls | ./protype_script`æµ‹è¯•äº†è¿™ä¸ªï¼Œå¯¹ç»“æœéå¸¸æ»¡æ„ï¼ç°åœ¨åªéœ€å°†å®ƒé›†æˆåˆ° VIM ä¸­ï¼Œè¿™éå¸¸å®¹æ˜“ã€‚æˆ‘ä»¬å®é™…ä¸Šå·²ç»åˆ é™¤äº†ä¸€äº›`.vimrc`ä»£ç ï¼

ç°åœ¨ï¼Œä¸ºäº†åˆ©ç”¨ fzf æµï¼Œæˆ‘ä»¬ä¼ é€’ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸º fzf çš„æºã€‚æˆ‘ä»¬å°†é»˜è®¤å‘½ä»¤çš„ç»“æœé€šè¿‡ç®¡é“ä¼ è¾“åˆ°æ–°è„šæœ¬ä¸­ã€‚è¿™å…è®¸æˆ‘ä»¬åˆ é™¤`files`å’Œ`prepend_icon`å‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬ç”¨è„šæœ¬æ›¿æ¢äº†å®ƒä»¬çš„åŠŸèƒ½ã€‚

```
call fzf#run({
 \ 'source': $FZF_DEFAULT_COMMAND.' | prototype_script',
 \ 'sink':   function('s:edit_devicon_prepended_file'),
 \ 'options': '-m ' . l:fzf_files_options,
 \ 'down':    '40%' }) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘åœ¨æˆ‘çš„å°æ ·æœ¬ç›®å½•ä¸­å°è¯•äº†ä¸€ä¸‹ï¼Œçœ‹èµ·æ¥æ•ˆæœå¾ˆå¥½ï¼æˆ‘è½¬åˆ°äº†æ›´å¤§çš„ç›®å½•ï¼Œä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆå¥½ï¼æˆ‘å¯ä»¥çœ‹åˆ°ç»“æœæ­£åœ¨æµå…¥ï¼Œå› ä¸º fzf ä¸­çš„ç»“æœæ€»æ•°ä¸€ç›´åœ¨ä¸Šå‡ï¼Œä½†æˆ‘ä»ç„¶å¯ä»¥åŒæ—¶ä½¿ç”¨å®ƒï¼

åœ¨æ–‡ä»¶ä¹‹é—´è·³äº†å‡ åˆ†é’Ÿåï¼Œæˆ‘æ„è¯†åˆ°æœ‰æ—¶å€™æˆ‘ä¼šæœç´¢ä¸€ä¸ªè¿˜æ²¡æœ‰æ·»åŠ åˆ° fzf çš„æ–‡ä»¶ï¼Œåœ¨æˆ‘ç­‰å¾…çš„ç»“æœå‡ºç°ä¹‹å‰ä¼šæœ‰ä¸€ä¸ªå»¶è¿Ÿã€‚åœ¨æ·»åŠ  devicons ä¹‹å‰ï¼Œæˆ‘æ²¡æœ‰ç»å†è¿‡è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥æˆ‘æ€€ç–‘è¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨ã€‚æˆ‘ç”¨è‚¡ç¥¨`:Files`å‘½ä»¤åšäº†ä¸€ä¸ªå¹¶æ’æ¯”è¾ƒï¼Œç»“æœå¾ˆæ¸…æ¥šã€‚é»˜è®¤å®Œæˆçš„é€Ÿåº¦è¦å¿«å‡ ä¸ªæ•°é‡çº§ã€‚æˆ‘å¯ä»¥çœ‹åˆ° fzf çš„æ€»è´Ÿè½½ï¼Œä½†å®ƒæ˜¯åœ¨å‡ åˆ†ä¹‹ä¸€ç§’ã€‚ä½¿ç”¨æˆ‘çš„ bash è§£å†³æ–¹æ¡ˆï¼ŒåŠ è½½æ‰€æœ‰æ–‡ä»¶åªéœ€è¦å‡ åç§’é’Ÿã€‚è¿˜æœ‰æ”¹è¿›çš„ç©ºé—´ï¼

## [](#rust-implementation)é“é”ˆå®ç°

æˆ‘å‡ ä¹æ²¡æœ‰ä½¿ç”¨ Rust çš„ç»éªŒï¼Œä½†æ˜¯æˆ‘å¯¹å®ƒæ„Ÿå…´è¶£å·²ç»æœ‰ä¸€æ®µæ—¶é—´äº†ã€‚å·§åˆçš„æ˜¯ï¼Œ`bat`ä¹Ÿæ˜¯ç”¨ Rust ç¼–å†™çš„ï¼Œå®ƒåœ¨é¢„è§ˆéƒ¨åˆ†çš„é€Ÿåº¦è®©æˆ‘å¯¹å®ƒåœ¨è¿™é‡Œçš„å¸®åŠ©å¯„äºˆåšæœ›ã€‚

ç”±äºå¯¹ Rust ç›¸å½“é™Œç”Ÿï¼Œæˆ‘çš„ç¬¬ä¸€æ­¥æ˜¯å¼„æ¸…æ¥šå¦‚ä½•æœ€å¥½åœ°ä½¿ç”¨æ•£åˆ—æ˜ å°„æ¥æ‰©å±• devicon æ˜ å°„ã€‚æˆ‘å¶ç„¶å‘ç°çš„ç¬¬ä¸€ä¸ªä¸œè¥¿æ˜¯ [`lazy_static`](https://github.com/rust-lang-nursery/lazy-static.rs) ï¼Œå®ƒä¼¼ä¹åšäº†æˆ‘æƒ³è¦çš„äº‹æƒ…ã€‚è¿™åœ¨è¿è¡Œæ—¶æ˜¯é™æ€çš„ï¼›æˆ‘åœ¨å¯»æ‰¾ä¸€äº›ç¼–è¯‘æ—¶é™æ€çš„ä¸œè¥¿ï¼Œä½†æ˜¯ä»æˆ‘éå¸¸å¿«é€Ÿçš„ä¸€ç¥æ¥çœ‹ï¼ŒRust ä¼¼ä¹ä¸é‚£ä¹ˆå®¹æ˜“æ”¯æŒ <sup id="fnref1">[1](#fn1)</sup> ï¼Œæ‰€ä»¥è¿è¡Œæ—¶é™æ€å°±è¶³å¤Ÿå¥½äº†ï¼

```
lazy_static! {
  static ref SYMBOL_MAP: HashMap<&'static str, &'static str> = {
    let mut m = HashMap::new();
    m.insert("ai", "î´");
    ...
    m.insert("zsh", "î•");

    m
  };
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨æˆ‘è®¾ç½®å¥½ HashMap ä¹‹åï¼Œæˆ‘éœ€è¦åšå®é™…çš„æ–‡æœ¬æµéƒ¨åˆ†ã€‚æˆ‘å‘ç°[è¿™ä¸ªæ ˆæº¢å‡ºç­”æ¡ˆ](https://stackoverflow.com/a/30186553)ï¼Œæ˜¯ 80%çš„å·¥ä½œï¼è¿™æ˜¯ä»–ä»¬ç®€å•çš„æ–‡æœ¬æµä¾‹å­ã€‚

```
fn main() {
    let stdin = io::stdin();
    for line in stdin.lock().lines() {
        println!("{}", line.unwrap());
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘åªéœ€è¦è§£ææ‰©å±•å¹¶åœ¨æ•£åˆ—è¡¨ä¸­æŸ¥æ‰¾ç¬¦å·ã€‚Rust æ ‡å‡†åº“å†æ¬¡æ´¾ä¸Šäº†ç”¨åœºï¼Œå› ä¸ºè§£ææ‰©å±•æ˜¯ä¸€è¡Œç¨‹åºï¼

```
Path::new(filename).extension().and_then(OsStr::to_str) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åŠ å…¥ä¸€ç‚¹é“é”ˆè‰²çš„é­”æ³•ğŸ‰ï¼Œé“é”ˆç‰ˆæœ¬å·²ç»å‡†å¤‡å¥½æµ‹è¯•äº†ï¼

```
#[macro_use]
extern crate lazy_static;

use std::collections::HashMap;
use std::ffi::OsStr;
use std::io::{self, BufRead};
use std::path::Path;

static DEFAULT_SYMBOL: &str = & "î˜’";
lazy_static! {
  static ref SYMBOL_MAP: HashMap<&'static str, &'static str> = {
    let mut m = HashMap::new();
    m.insert("ai", "î´");
    ...
    m.insert("zsh", "î•");

    m
  };
}

fn get_extension_from_filename(filename: &str) -> Option<&str> {
  Path::new(filename)
    .extension()
    .and_then(OsStr::to_str)
}

fn main() {
  let stdin = io::stdin();
  for line in stdin.lock().lines() {
    let filename = line.unwrap();
    let extension = get_extension_from_filename(& filename);
    let symbol = match extension {
      Some(extension) => SYMBOL_MAP.get(& extension).unwrap_or(& DEFAULT_SYMBOL),
      None => DEFAULT_SYMBOL
    };
    println!("{} {}", symbol, filename);
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘å°†è¿™ä¸ªæ–°ç‰ˆæœ¬æ’å…¥åˆ° vim ä¸­ï¼Œåªæ˜¯ç®€å•åœ°å°†æºä»£ç æ”¹ä¸ºæˆ‘çš„æ–° Rust æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œä¸æ˜¯åŸå‹ bash è„šæœ¬ã€‚å¹¶ä¸”:drumroll:ï¼Œå®ƒå·¥ä½œäº†ï¼Œå¹¶ä¸”æ¯” bash ç‰ˆæœ¬å¿«å¾—å¤šï¼å®ƒç”šè‡³æ²¡æœ‰æ˜æ˜¾æ…¢äºé»˜è®¤çš„`:Files`å‘½ä»¤ï¼

## [](#performance)è¡¨ç°

è¿™æ˜¯ä¸€ä¸ªéå¸¸ä¸ç§‘å­¦çš„å•æ¬¡æµ‹è¯•ï¼Œæˆ‘åœ¨ä¸€ä¸ªå¤§ç›®å½•ä¸­å¯¹ä¸‰ä¸ªä¸åŒçš„å‘½ä»¤è®¡æ—¶ã€‚

1.  å•ç‹¬ä½¿ç”¨æˆ‘é»˜è®¤çš„ FZF å‘½ä»¤
2.  åœ¨åŸå‹ bash å®ç°ä¸­ä½¿ç”¨å®ƒ
3.  åœ¨æˆ‘çš„ Rust å®ç°ä¸­ä½¿ç”¨å®ƒ

æŒ‰ç…§è¿™ä¸ªé¡ºåºï¼Œè¿™æ˜¯æˆ‘çš„ç»“æœï¼Rust ç‰ˆæœ¬ä»…ä»…æ¯”ä¸åšä»»ä½• devicons æ…¢ä¸€ç‚¹ç‚¹ã€‚å®ƒå½»åº•æ‘§æ¯äº† bash å®ç°ï¼

```
coreyja in ~/Projects on ca/master/devicons
â˜…  time rg --files --no-ignore --hidden --follow > /dev/null

real    0m0.302s
user    0m0.627s
sys     0m1.515s

coreyja in ~/Projects on ca/master/devicons
â˜…  time rg --files --no-ignore --hidden --follow | add_devicon_before_each_file > /dev/null

real    3m55.226s
user    2m8.614s
sys     1m45.380s

coreyja in ~/Projects on ca/master/devicons
â˜…  time rg --files --no-ignore --hidden --follow | devicon-lookup > /dev/null

real    0m0.409s
user    0m0.743s
sys     0m1.535s 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ç”¨ VIM ä¸­çš„åŸå§‹å®ç°å’Œæœ€ç»ˆ rust ç‰ˆæœ¬è¿›è¡Œäº†ä¸€ä¸ªæ›´ä¸ç§‘å­¦çš„æµ‹è¯•ã€‚å› ä¸ºæˆ‘æ˜¯åœ¨ VIM å†…éƒ¨è¿›è¡Œæµ‹è¯•ï¼Œå¹¶ä¸”åœ¨ä¸€ä¸ªçª—å£å‡ºç°ä¹‹å‰ä¸€ç›´åœ¨è®¡æ—¶ï¼Œæ‰€ä»¥æ²¡æœ‰ä¸€ç§ç®€å•çš„æ–¹æ³•æ¥è‡ªåŠ¨è®¡æ—¶ã€‚æ‰€ä»¥æˆ‘æ‹¿å‡ºäº†æˆ‘çš„ç§’è¡¨ã€‚ä½¿ç”¨æˆ‘çš„ rust å®ç°`:call Fzf_files_with_dev_icons($FZF_DEFAULT_COMMAND)`ï¼Œfzf çª—å£å‡ ä¹ç¬é—´å‡ºç°ï¼Œæ‰€æœ‰çš„ç»“æœéƒ½å·²ç»è¢«å¡«å……äº†ï¼ä½¿ç”¨æœ€åˆçš„ VIM å®ç°`:call Fzf_dev()`ï¼ŒåŠ è½½çª—å£å¤§çº¦éœ€è¦ 4.5 ç§’ã€‚å½“å®ƒåŠ è½½æ—¶ï¼Œå®ƒè¢«æ‰€æœ‰çš„æ–‡ä»¶å®Œå…¨å¡«å……ã€‚

è¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„æ”¹è¿›ï¼Œæ€§èƒ½ç°åœ¨å¯¹æˆ‘æ¥è¯´è‚¯å®šæ˜¯å¯ä»¥æ¥å—çš„ï¼Œå¹¶ä¸”å·²ç»æ·»åŠ åˆ°æˆ‘çš„ç‚¹æ–‡ä»¶ä¸­äº†ï¼

## [](#final-version)æœ€ç»ˆç‰ˆæœ¬

åœ¨æˆ‘è®©è¿™ä¸ª Rust ç‰ˆæœ¬æ­£å¸¸å·¥ä½œåï¼Œæˆ‘è¿˜èŠ±äº†ä¸€äº›æ—¶é—´æ¥é‡æ„é‡ç”¨åŒä¸€ä¸ªå‡½æ•°ï¼Œåªæœç´¢ git ä¸‹çš„æ–‡ä»¶ã€‚è¿™å°±åƒæå–è°ƒç”¨å‚æ•°çš„å‡½æ•°ä¸€æ ·ç®€å•ã€‚æˆ‘ä¹Ÿå°†ç›¸åŒçš„ devicons é›†æˆåˆ°äº†`:GFiles?`ä¸­ï¼Œå®ƒåªæ˜¾ç¤ºåœ¨ git ä¸­å‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶ã€‚è¿™å€¼å¾—è‡ªå·±çš„åšå®¢å¸–å­ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸€ç‚¹æ¬ºéª—ï¼

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æœ‰å®ƒï¼Œæˆ‘çš„æœ€ç»ˆ(ç›®å‰)fzf æ–‡ä»¶æ¨¡ç³Šçš„å‘ç°ä¸è£…ç½®ä¾›ç”µçš„ Rustï¼

```
" Files + devicons
function! Fzf_files_with_dev_icons(command)
  let l:fzf_files_options = '--preview "bat --color always --style numbers {2..} | head -'.&lines.'"'
   function! s:edit_devicon_prepended_file(item)
    let l:file_path = a:item[4:-1]
    execute 'silent e' l:file_path
  endfunction
   call fzf#run({
 \ 'source': a:command.' | devicon-lookup',
 \ 'sink':   function('s:edit_devicon_prepended_file'),
 \ 'options': '-m ' . l:fzf_files_options,
 \ 'down':    '40%' })
endfunction
 function! Fzf_git_diff_files_with_dev_icons()
  let l:fzf_files_options = '--ansi --preview "sh -c \"(git diff --color=always -- {3..} | sed 1,4d; bat --color always --style numbers {3..}) | head -'.&lines.'\""'
   function! s:edit_devicon_prepended_file_diff(item)
    echom a:item
    let l:file_path = a:item[7:-1]
    echom l:file_path
    let l:first_diff_line_number = system("git diff -U0 ".l:file_path." | rg '^@@.*\+' -o | rg '[0-9]+' -o | head -1")
     execute 'silent e' l:file_path
    execute l:first_diff_line_number
  endfunction
   call fzf#run({
 \ 'source': 'git -c color.status=always status --short --untracked-files=all | devicon-lookup',
 \ 'sink':   function('s:edit_devicon_prepended_file_diff'),
 \ 'options': '-m ' . l:fzf_files_options,
 \ 'down':    '40%' })
endfunction
 " Open fzf Files " Open fzf Files
map <C-f> :call Fzf_files_with_dev_icons($FZF_DEFAULT_COMMAND)<CR> " :Files
map <C-d> :call Fzf_git_diff_files_with_dev_icons()<CR> " :GFiles?
map <C-g> :call Fzf_files_with_dev_icons("git ls-files \| uniq")<CR> " :GFiles 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘è¿˜å‘å¸ƒäº† Rust ä»£ç ä½œä¸ºä¸€ä¸ª[æœºç®±](https://crates.io/crates/devicon-lookup)ï¼Œä½ å¯ä»¥ç”¨
å®‰è£…å®ƒ

```
cargo install devicon-lookup 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å°†ä¸ºæ‚¨æä¾›å¯ä»¥åœ¨ VIM è®¾ç½®ä¸­ä½¿ç”¨çš„`devicon-lookup`äºŒè¿›åˆ¶æ–‡ä»¶ï¼

## [](#acknowledgments)é¸£è°¢

å½“æˆ‘å‡†å¤‡å‘è¡¨è¿™ç¯‡åšæ–‡æ—¶ï¼Œæˆ‘æ„è¯†åˆ°æˆ‘æ ¹æœ¬æ²¡æœ‰æåˆ° [`fzf.vim`](https://github.com/junegunn/fzf.vim) æ’ä»¶ï¼æˆ‘ç§°ä¹‹ä¸º fzf `:Files`è§†å›¾çš„â€œé»˜è®¤â€å®ç°ï¼Œè¿™æ˜¯ä¸€ä¸ªä»¤äººæƒŠå¥‡çš„æ’ä»¶ï¼æˆ‘åŸºæœ¬ä¸Šè¯•ç€å°½å¯èƒ½åœ°å¤åˆ¶è¿™ä¸ªæ’ä»¶ï¼Œå°¤å…¶æ˜¯åœ¨å°è¯•é‡æ–°å®ç°`:GFiles?`æ”¯æŒçš„æ—¶å€™ã€‚

ç¼–è¾‘:å…¶ä¸­æœ‰äº›ä¿¡æ¯ç•¥æœ‰é”™è¯¯ã€‚æˆ‘åˆå‘äº†ä¸€ä¸ªå¸–å­ï¼Œåœ¨é‚£é‡Œæˆ‘å†æ¬¡å°è¯•äº†`phf`ï¼çœ‹çœ‹è¿™é‡Œçš„ï¼

* * *

1.  ä¹‹åï¼Œæˆ‘æ‰¾åˆ°å¹¶ç ”ç©¶äº† [phf](https://github.com/sfackler/rust-phf) ï¼Œå®ƒç¡®å®æä¾›äº†ç¼–è¯‘æ—¶é™æ€æ˜ å°„ã€‚å®ƒä¸ä½¿ç”¨ Rust HashMapï¼Œè€Œæ˜¯å®ç°è‡ªå·±çš„æ•£åˆ—åŠŸèƒ½ã€‚ä»–ä»¬çš„å“ˆå¸Œå®ç°ä¹Ÿä¸åŒäº Rust HashMapï¼Œå¯¹è¿™ä¸ªé¡¹ç›®æ²¡æœ‰æ„ä¹‰ã€‚ä¸ºæ­¤æˆ‘æƒ³ä½¿ç”¨ç¨³å®šçš„ Rustï¼Œè¿™æ„å‘³ç€æˆ‘ä¸èƒ½ä½¿ç”¨è¯­æ³•æ›´æ¼‚äº®çš„`phf_macros`ã€‚å¤„äºç¨³å®šçš„ rust æ„å‘³ç€æˆ‘å°†è¢«è¿«ä½¿ç”¨ codegen é€‰é¡¹ï¼Œè¿™éœ€è¦ä¸€ä¸ªåˆæ­¥çš„â€œç¼–è¯‘â€æ­¥éª¤ï¼Œåœ¨è¿™ä¸ªæ­¥éª¤ä¸­ï¼Œæ‚¨è¿è¡Œä¸€ä¸ªæ„å»ºè„šæœ¬ï¼Œè¾“å‡ºä¸€ä¸ªåŒ…å«å“ˆå¸Œä»£ç çš„ rust æºæ–‡ä»¶ã€‚è¿™çœ‹èµ·æ¥åƒæ˜¯å¾ˆå¤šé¢å¤–çš„å·¥ä½œï¼Œæ ¹æ®[è¿™ä¸ªåšå®¢](http://siciarz.net/24-days-rust-static-initialization/)çš„è¯´æ³•ï¼Œå‡çº§çš„é€Ÿåº¦ä¼˜åŠ¿å¯èƒ½å­˜åœ¨ï¼Œä½†ä¸ä¼šæœ‰æ•°é‡çº§çš„å¢åŠ ï¼Œæˆ‘å·²ç»å¯¹æ€§èƒ½æ„Ÿåˆ°æ»¡æ„äº†ã€‚ [â†©](#fnref1)