# 真实世界分区 CosmosDb

> 原文:[https://dev.to/sogeti/real-world-partitioning-cosmosdb-2apf](https://dev.to/sogeti/real-world-partitioning-cosmosdb-2apf)

> Azure Cosmos DB 是一个全球分布式多模式数据库服务，旨在帮助您实现快速、可预测的性能。随着应用程序的增长，它可以无缝扩展。

这篇博客确切地解释了它是如何工作的，以及在某些情况下该怎么做。但是在我作为云架构师的工作中，我有时需要更深入地挖掘，并弄清楚我的解决方案是否适合特定的情况。

例如，一个“分区”的最大大小是 10GB，所以理解这是如何工作的，以及如何计算出一段时间内的分区大小是非常重要的。

这篇博客将使用最近的真实场景解释如何确定分区键和伸缩性。

请注意，您的场景可能会有很大的不同，但在本博客中有一些方法可以帮助您设计解决方案。

## 命案

在我的场景中，我从遥测传感器获取数据。这些传感器每 15 分钟有一次使用读数。一天的数据大小大约为每天 10kb；都是 JSON 格式的。

总共 96 个数据点中的 4 个数据点的 JSON 样本:

[https://gist . github . com/prom bouts/ea A8 BCF 5887 CD f1 ab 9 d6d 35164 c 73d 79 . js](https://gist.github.com/prombouts/eaa8bcf5887cdf1ab9d6d35164c73d79.js)

我的 CosmosDb(它调用一个 API，该 API 又调用 CosmosDb)的用户有几个需求:

1.  每月获取每组传感器的数据(最多 20 个)(所有日期的合计总数)
2.  获取完整一个月内每组传感器(最多 20 个)每天的数据(每天的合计总数)

### 确定分区键和大小

在这种情况下，我们应该研究应该使用什么样的分区键。因为所有通话都是按月进行的，所以一个合理的关键字是“月”。如果您只查询一个分区，CosmosDb 的工作速度会非常快，并且会非常快地将文档返回给您。

在我们的示例中，分区在 2016 年 1 月为“201601 ”,在 2 月为“201602 ”,依此类推。

如果我们只是把所有的数据，比如每天每小时 10 千字节的 json 数据，放入这个方案中，会发生什么呢？为了便于讨论，我们将一个月的天数定为 31 天(因为这是一个月的最大天数)。每个传感器每月的总容量将为 310KB。

我们知道一个分区最大为 10GB。因此，如果我们将其除以 310KB，我们可以在一个分区中存储多达 **33825** 个唯一传感器。在某些情况下这很好，但是在我的场景中，我有多达 **250000** 个传感器…

### 优化您的收藏

可以通过以下任何方式进行优化:

1.  选择另一个分区键
2.  减小 JSON 文档的大小
3.  保存汇总数据而不是所有粗略值

在我的案例中，合理的解决方案是保存聚合数据。粗略的数据也被保存，尽管是保存到另一个集合或 blob 中以供将来参考。

通过聚合数据，文档突然看起来像这样:

JSON 样本，总共 31 天中有 4 天的数据点:

[https://gist . github . com/prom bouts/8d 6126556 ef 2ee 61 ADF 006870 b 0861 CD . js](https://gist.github.com/prombouts/8d6126556ef2ee61adf006870b0861cd.js)

这种聚合使得一个月的文档总大小大约为。5 KB。如果我们现在划分 10GB，我们会发现每个分区可以容纳**200 万**个独特的传感器。这很容易适合 25 万个所需的传感器，并且我的解决方案现在很快，并且可扩展用于该系统中未来的额外传感器。其次，5 KB 显然比 310 KB 在互联网上提供得更快，如果你想同时获得大量的每月传感器数据，这也是一个巨大的优势。

## 结论

CosmosDb 非常适合存储大量数据。但这并不意味着您可以在不考虑隐含意义和不设计适当的解决方案架构的情况下将任何东西塞进您的集合。

1.  始终确保您的数据适合您的集合，并记住最大分区大小。
2.  跟踪您的数据是如何被查询的。
    1.  如果由于某种原因，基于年份而不是月份的查询成为新的默认查询，那么重构您的解决方案或创建一个额外的集合可能会很有用。
3.  为您的消费者使用 API 可能是有用的，这样您就创建了一个外观，而您的消费者不需要知道您的设置的内部工作方式。
    1.  如果集合或文档发生变化，您的 API 不必如此！