# JavaScript ä¸­å¯å–æ¶ˆçš„å¼‚æ­¥å‡½æ•°

> åŸæ–‡:[https://dev . to/chromiumdev/cancellable-async-functions-in-JavaScript-5gp 7](https://dev.to/chromiumdev/cancellable-async-functions-in-javascript-5gp7)

<small>(è¿™ç¯‡æ–‡ç« è§£é‡Šäº†å¦‚ä½•ä½¿ç”¨ç”Ÿæˆå™¨æ¥é¿å…å¯¹`async`å‡½æ•°çš„é‡å¤è°ƒç”¨ã€‚[æŸ¥çœ‹æœ€ç»ˆè¿›åœºçš„è¦ç‚¹](https://gist.github.com/samthor/8f72127e3cf44bca1fc6527ce7e47023)æˆ–ç»§ç»­é˜…è¯»äº†è§£æ›´å¤šï¼ğŸ“)</small>

JavaScript æ˜¯ä¸€ä¸ªå¯æ€•çš„å¼‚æ­¥è°ƒç”¨çš„è¿·å®«ï¼Œæ‰€æœ‰çš„è°ƒç”¨éƒ½ä¸€æ ·ã€‚æˆ‘ä»¬éƒ½å†™è¿‡è¿™æ ·çš„ä»£ç â€”â€”ä½†æ˜¯åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è®¨è®º`async`å’Œ`await`ã€‚è¿™äº›æ˜¯[å¹¿æ³›æ”¯æŒçš„](https://medium.com/dev-channel/es6-modules-in-chrome-canary-m60-ba588dfb8ab7)å…³é”®è¯ï¼Œå¸®åŠ©ä½ å°†ä»£ç ç§»æ¤åˆ°å¯è¯»æ€§æ›´å¼ºçš„åœ°æ–¹ã€‚ğŸ“–ğŸ‘€

æœ€é‡è¦çš„æ˜¯ï¼Œæˆ‘å°†è¦†ç›–ä¸€ä¸ªå…³é”®çš„é™·é˜±:å¦‚ä½•å¤„ç†ä¸€ä¸ªè¢«å¤šæ¬¡è¿è¡Œçš„å¼‚æ­¥æ–¹æ³•ï¼Œä»¥ä¾¿å®ƒä¸ä¼šå½±å“å…¶ä»–å·¥ä½œã€‚ğŸ‘ğŸ’¥

å…ˆè¯´ä¾‹å­ã€‚è¯¥å‡½æ•°å°†è·å–ä¸€äº›å†…å®¹ï¼Œå°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œå¹¶ç­‰å¾…å‡ ç§’é’Ÿï¼Œç„¶åå¼•èµ·ç”¨æˆ·çš„æ³¨æ„:

```
function fetchAndFlash(page) {
  const jsonPromise = fetch('/api/info?p=' + page)
      .then((response) => response.json());
  jsonPromise.then((json) => {
    infoNode.innerHTML = json.html;

    setTimeout(() => {
      flashForAttention(infoNode);
    }, 5000);
  });
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬å¯ä»¥åƒè¿™æ ·ç”¨`async`å’Œ`await`é‡å†™è¿™ä¸ªï¼Œæ²¡æœ‰å›è°ƒ:

```
async function fetchAndFlash(page) {
  const response = await fetch('/api/info?p=' + page);
  const json = await response.json();
  infoNode.innerHTML = json.html;

  // a bit awkward, but you can make this a helper method
  await new Promise((resolve) => setTimeout(resolve, 5000));

  flashForAttention(infoNode);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é‚£ä¸æ˜¯æ›´å¥½å—ï¼Ÿå®ƒè·³æ¥è·³å»ï¼Œå¾ˆå®¹æ˜“çœ‹åˆ°ä»ä¸Šåˆ°ä¸‹çš„æ­¥éª¤:è·å–èµ„æºï¼Œå°†å…¶è½¬æ¢ä¸º JSONï¼Œå†™å…¥é¡µé¢ï¼Œç­‰å¾…äº”ç§’é’Ÿï¼Œç„¶åè°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ã€‚ğŸ”œ

## [](#its-a-trap)è¿™æ˜¯ä¸ªé™·é˜±ï¼

ä½†æ˜¯è¿™é‡Œæœ‰äº›ä¸œè¥¿ä¼šè®©è¯»è€…å›°æƒ‘ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªâ€œä¸€æ¬¡æ‰§è¡Œâ€çš„å¸¸è§„å‡½æ•°â€”â€”æ¯æ¬¡æˆ‘ä»¬è°ƒç”¨`await`ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šéƒ½éµä»æµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯ï¼Œè¿™æ ·å®ƒå°±èƒ½ç»§ç»­å·¥ä½œã€‚âš¡ğŸ¤–

æ¢å¥è¯è¯´:å‡è®¾æ‚¨æ­£åœ¨é˜…è¯»ä½¿ç”¨`fetchAndFlash()`çš„ä»£ç ã€‚å¦‚æœæ‚¨æ²¡æœ‰é˜…è¯»è¿™ç¯‡æ–‡ç« çš„æ ‡é¢˜ï¼Œé‚£ä¹ˆè¿è¡Œè¿™æ®µä»£ç ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ

```
fetchAndFlash('page1');
fetchAndFlash('page2'); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½ å¯èƒ½æœŸæœ›ä¸€ä¸ªæ¥ä¸€ä¸ªå‘ç”Ÿï¼Œæˆ–è€…ä¸€ä¸ªä¼šæŠµæ¶ˆå¦ä¸€ä¸ªã€‚äº‹å®å¹¶éå¦‚æ­¤â€”â€”ä¸¤è€…æˆ–å¤šæˆ–å°‘ä¼šå¹¶è¡Œè¿è¡Œ(å› ä¸º JavaScript ä¸èƒ½åœ¨æˆ‘ä»¬ç­‰å¾…æ—¶é˜»å¡),ä»¥*æˆ–*çš„é¡ºåºç»“æŸï¼Œå¹¶ä¸”ä¸æ¸…æ¥šä»€ä¹ˆ HTML ä¼šå‡ºç°åœ¨æ‚¨çš„é¡µé¢ä¸Šã€‚âš ï¸

[![How two tasks can run in parallel and overwrite one another](../Images/d5418988d4f145dfb47ea387a8694af6.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--LGn-CUAv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/yqpfeca7xv1d4podbyfj.png)

æ˜ç¡®åœ°è¯´ï¼Œè¿™ç§æ–¹æ³•çš„åŸºäºå›è°ƒçš„ç‰ˆæœ¬æœ‰å®Œå…¨ç›¸åŒçš„é—®é¢˜ï¼Œä½†æ˜¯å®ƒæ›´æ˜æ˜¾â€”â€”ä»¥ä¸€ç§éå¸¸ä»¤äººåŒæ¶çš„æ–¹å¼ã€‚åœ¨ä½¿æˆ‘ä»¬çš„ä»£ç ç°ä»£åŒ–ä»¥ä½¿ç”¨`async`å’Œ`await`çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä½¿å®ƒå˜å¾—æ›´åŠ æ¨¡ç³Šã€‚ğŸ˜•

* * *

è®©æˆ‘ä»¬æ¥çœ‹çœ‹è§£å†³è¿™ä¸ªé—®é¢˜çš„å‡ ç§ä¸åŒçš„æ–¹æ³•ã€‚ç³»å¥½å®‰å…¨å¸¦ã€‚ğŸ¢

## [](#approach-1-the-chain)æ–¹æ³• 1:è¿é”

æ ¹æ®ä½ è°ƒç”¨ä¸€ä¸ª`async`æ–¹æ³•çš„æ–¹å¼å’ŒåŸå› ï¼Œå®ƒå¯èƒ½èƒ½å¤Ÿä¸€ä¸ªæ¥ä¸€ä¸ªåœ°â€œé“¾æ¥â€å®ƒä»¬ã€‚å‡è®¾æ‚¨æ­£åœ¨å¤„ç†ä¸€ä¸ªç‚¹å‡»äº‹ä»¶:

```
let p = Promise.resolve(true);
loadButton.onclick = () => {
  const pageToLoad = pageToLoadInput.value;
  // wait for previous task to finish before doing more work
  p = p.then(() => fetchAndFlash(pageToLoad));
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¯å•å‡»ä¸€æ¬¡ï¼Œå°±å‘é“¾ä¸­æ·»åŠ äº†å¦ä¸€ä¸ªä»»åŠ¡ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ä¸€ä¸ªè¾…åŠ©å‡½æ•°æ¥æ¦‚æ‹¬è¿™ä¸€ç‚¹:

```
// makes any function a chainable function
function makeChainable(fn) {
  let p = Promise.resolve(true);
  return (...args) => {
    p = p.then(() => fn(...args));
    return p;
  };
}
const fetchAndFlashChain = makeChainable(fetchAndFlash); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œä½ å¯ä»¥åªè°ƒç”¨`fetchAndFlashChain()`ï¼Œå®ƒä¼šåœ¨ä»»ä½•*å’Œå…¶ä»–*è°ƒç”¨`fetchAndFlashChain()`ä¹‹åæŒ‰é¡ºåºå‘ç”Ÿã€‚ğŸ”—

ä½†è¿™å¹¶ä¸æ˜¯è¿™ç¯‡åšæ–‡ä¸­çš„å»ºè®®â€”â€”å¦‚æœæˆ‘ä»¬æƒ³å–æ¶ˆä¹‹å‰çš„æ“ä½œå‘¢ï¼Ÿä½ çš„ç”¨æˆ·åˆšåˆšç‚¹å‡»äº†ä¸€ä¸ª*ä¸åŒçš„*åŠ è½½æŒ‰é’®ï¼Œæ‰€ä»¥ä»–ä»¬å¯èƒ½ä¸å…³å¿ƒä¹‹å‰çš„äº‹æƒ…ã€‚ğŸ™…

## [](#approach-2-barrier-checks)æ–¹æ³• 2:éšœç¢æ£€æŸ¥

åœ¨æˆ‘ä»¬çš„ç°ä»£åŒ–çš„`fetchAndFlash()`ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†`await`å…³é”®å­—ä¸‰æ¬¡ï¼Œä»…ä»…æ˜¯å› ä¸ºä¸¤ä¸ªä¸åŒçš„åŸå› :

1.  è¿›è¡Œç½‘ç»œè·å–
2.  ç­‰å¾… 5 ç§’åé—ªçƒ

åœ¨è¿™ä¸¤ç‚¹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åœä¸‹æ¥é—®â€”â€”â€œå˜¿ï¼Œæˆ‘ä»¬ä»ç„¶æ˜¯æœ€æ´»è·ƒçš„ä»»åŠ¡å—ï¼Ÿç”¨æˆ·*æœ€è¿‘*æƒ³åšçš„äº‹æƒ…ï¼Ÿâ€ğŸ¤”ğŸ’­

æˆ‘ä»¬å¯ä»¥é€šè¿‡ç”¨éšæœºæ•°æ ‡è®°æ¯ä¸ªä¸åŒçš„æ“ä½œæ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚è¿™æ„å‘³ç€åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„å¯¹è±¡ï¼Œåœ¨æœ¬åœ°å’Œå…¨å±€å­˜å‚¨å®ƒï¼Œå¹¶æŸ¥çœ‹å…¨å±€ç‰ˆæœ¬æ˜¯å¦åç¦»æœ¬åœ°ç‰ˆæœ¬â€”â€”å› ä¸º*å¦ä¸€ä¸ª*æ“ä½œå·²ç»å¼€å§‹ã€‚

ä¸‹é¢æ˜¯æˆ‘ä»¬æ›´æ–°çš„`fetchAndFlash()`æ–¹æ³•:

```
let globalFetchAndFlashNonce;
async function fetchAndFlash(page) {
  const localNonce = globalFetchAndFlashNonce = new Object();

  const response = await fetch('/api/info?p=' + page);
  const json = await response.json();
  // IMMEDIATELY check
  if (localNonce !== globalFetchAndFlashNonce) { return; }

  infoNode.innerHTML = json.html;

  await new Promise((resolve) => setTimeout(resolve, 5000));
  // IMMEDIATELY check
  if (localNonce !== globalFetchAndFlashNonce) { return; }

  flashForAttention(infoNode);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å¾ˆå¥½ï¼Œä½†æœ‰ç‚¹æ‹—å£ã€‚æ¦‚æ‹¬èµ·æ¥ä¹Ÿä¸å®¹æ˜“ï¼Œä½ å¿…é¡»*è®°ä½*åœ¨æ‰€æœ‰é‡è¦çš„åœ°æ–¹æ·»åŠ æ£€æŸ¥ï¼

ä¸è¿‡ï¼Œæœ‰ä¸€ç§æ–¹æ³•â€”â€”ä½¿ç”¨[ç”Ÿæˆå™¨](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_Generators)ä¸ºæˆ‘ä»¬è¿›è¡Œå½’çº³ã€‚

## [](#background-generators)èƒŒæ™¯:å‘ç”µæœº

å½“`await`æ¨è¿Ÿæ‰§è¡Œç›´åˆ°å®ƒç­‰å¾…çš„äº‹æƒ…*å®Œæˆ*æ—¶â€”â€”åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¦ä¹ˆæ˜¯ç½‘ç»œè¯·æ±‚ï¼Œè¦ä¹ˆåªæ˜¯ç­‰å¾…è¶…æ—¶â€”â€”ç”Ÿæˆå™¨å‡½æ•°åŸºæœ¬ä¸Šåšç›¸åçš„äº‹æƒ…ï¼Œå°†æ‰§è¡Œç§»å›åˆ°å®ƒè¢«*è°ƒç”¨*çš„åœ°æ–¹ã€‚

è¿·èŒ«ï¼Ÿè¿™å€¼å¾—ä¸€æ

```
function* myGenerator() {
  const finalOut = 300;
  yield 1;
  yield 20;
  yield finalOut;
}
for (const x of myGenerator()) {
  console.info(x);
}
// or, slightly longer (but exactly the same output)
const iterator = myGenerator();
for (;;) {
  const next = iterator.next();
  if (next.done) {
    break;
  }
  console.info(next.value);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªç¨‹åºï¼Œä¸¤ä¸ªç‰ˆæœ¬ï¼Œå°†æ‰“å° 1ï¼Œ20 å’Œ 300ã€‚æœ‰è¶£çš„æ˜¯ï¼Œæˆ‘å¯ä»¥åœ¨ä»»ä½•ä¸€ä¸ª`for`å¾ªç¯ä¸­åšä»»ä½•æˆ‘å–œæ¬¢çš„äº‹æƒ…ï¼ŒåŒ…æ‹¬æ—©æœŸçš„`break`ï¼Œè€Œ`myGenerator`ä¸­çš„æ‰€æœ‰çŠ¶æ€éƒ½ä¿æŒä¸å˜â€”â€”æˆ‘å£°æ˜çš„ä»»ä½•å˜é‡ï¼Œä»¥åŠæˆ‘åœ¨å“ªé‡Œã€‚

è¿™é‡Œçœ‹ä¸åˆ°ï¼Œä½†æ˜¯è°ƒç”¨ç”Ÿæˆå™¨çš„ä»£ç *(ç‰¹åˆ«æ˜¯å®ƒè¿”å›çš„è¿­ä»£å™¨çš„`.next()`å‡½æ•°)ä¹Ÿå¯ä»¥ç”¨ä¸€ä¸ªå˜é‡æ¢å¤å®ƒã€‚æˆ‘ä»¬ä¼šçœ‹åˆ°å¤šå¿«ã€‚*

å¦‚æœæˆ‘ä»¬å†³å®šåœæ­¢ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€èµ·ä½¿ç”¨è¿™äº›éƒ¨åˆ†ï¼Œåªæ˜¯*è€Œä¸æ˜¯*ç»§ç»­æ‰§è¡ŒæŸä¸ªä»»åŠ¡ï¼Œå¹¶ä¸”è¿˜å¯ä»¥é€šè¿‡ä¸€äº›è¾“å‡ºæ¥æ¢å¤æ‰§è¡Œã€‚å—¯â€”â€”å¬èµ·æ¥å¾ˆé€‚åˆæˆ‘ä»¬çš„é—®é¢˜ï¼âœ…

## [](#the-solution)è§£ğŸ‰

è®©æˆ‘ä»¬æœ€åä¸€æ¬¡é‡å†™`fetchAndFlash()`ã€‚æˆ‘ä»¬å®é™…ä¸Šåªæ˜¯æ”¹å˜å‡½æ•°ç±»å‹æœ¬èº«ï¼Œå¹¶å°†`await`ä¸`yield`äº¤æ¢:è°ƒç”¨è€…å¯ä»¥ç­‰å¾…æˆ‘ä»¬â€”â€”æˆ‘ä»¬å°†çœ‹åˆ°ä¸‹ä¸€æ­¥å¦‚ä½•:

```
function* fetchAndFlash(page) {
  const response = yield fetch('/api/info?p=' + page);
  const json = yield response.json();

  infoNode.innerHTML = json.html;

  yield new Promise((resolve) => setTimeout(resolve, 5000));

  flashForAttention(infoNode);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ®µä»£ç ç°åœ¨çœŸçš„æ²¡æœ‰æ„ä¹‰ï¼Œå¦‚æœæˆ‘ä»¬è¯•å›¾ä½¿ç”¨å®ƒï¼Œå®ƒä¼šå´©æºƒã€‚äº§ç”Ÿæ¯ä¸ª`Promise`çš„è¦ç‚¹æ˜¯ï¼Œç°åœ¨ï¼Œä¸€äº›è°ƒç”¨è¿™ä¸ªç”Ÿæˆå™¨çš„å‡½æ•°å¯ä»¥ä¸ºæˆ‘ä»¬åš`await` *ï¼ŒåŒ…æ‹¬æ£€æŸ¥ä¸€ä¸ªéšæœºæ•°ã€‚ä½ ç°åœ¨ä¸å¿…åœ¨æ„åœ¨ç­‰å¾…çš„æ—¶å€™æ’å…¥è¿™äº›è¡Œâ€”â€”ä½ åªéœ€è¦ä½¿ç”¨`yield`ã€‚*

æœ€é‡è¦çš„æ˜¯ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•ç°åœ¨æ˜¯ä¸€ä¸ª*ç”Ÿæˆå™¨*ï¼Œè€Œä¸æ˜¯ä¸€ä¸ª`async`å‡½æ•°ï¼Œæ‰€ä»¥`await`å…³é”®å­—å®é™…ä¸Šæ˜¯ä¸€ä¸ªé”™è¯¯ã€‚è¿™ç»å¯¹æ˜¯ç¡®ä¿æ‚¨ç¼–å†™æ­£ç¡®ä»£ç çš„æœ€ä½³æ–¹å¼ï¼ğŸš¨

æˆ‘ä»¬éœ€è¦çš„åŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿå¥½äº†ï¼Œè¿™å°±æ˜¯è¿™ç¯‡æ–‡ç« çš„çœŸæ­£é­”åŠ›:

```
function makeSingle(generator) {
  let globalNonce;
  return async function(...args) {
    const localNonce = globalNonce = new Object();

    const iter = generator(...args);
    let resumeValue;
    for (;;) {
      const n = iter.next(resumeValue);
      if (n.done) {
        return n.value;  // final return value of passed generator
      }

      // whatever the generator yielded, _now_ run await on it
      resumeValue = await n.value;
      if (localNonce !== globalNonce) {
        return;  // a new call was made
      }
      // next loop, we give resumeValue back to the generator
    }
  };
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å¾ˆç¥å¥‡ï¼Œä½†å¸Œæœ›ä¹Ÿæœ‰æ„ä¹‰ã€‚æˆ‘ä»¬è°ƒç”¨ä¼ é€’çš„ç”Ÿæˆå™¨ï¼Œå¾—åˆ°ä¸€ä¸ªè¿­ä»£å™¨ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯¹å®ƒäº§ç”Ÿçš„æ¯ä¸€ä¸ªå€¼è¿›è¡Œ`await`,åƒç½‘ç»œå“åº”ä¸€æ ·æ¢å¤ç»“æœå€¼â€”â€”ç›´åˆ°ç”Ÿæˆå™¨å®Œæˆã€‚**é‡è¦çš„æ˜¯**ï¼Œè¿™è®©æˆ‘ä»¬èƒ½å¤Ÿåœ¨æ¯æ¬¡å¼‚æ­¥æ“ä½œåæ£€æŸ¥å…¨å±€å’Œå±€éƒ¨éšæœºæ•°ã€‚

<small>ä¸€ä¸ªæ‰©å±•:å¦‚æœæœ‰æ–°çš„å‘¼å«ï¼Œè¿”å›ä¸€ä¸ªç‰¹æ®Šçš„å€¼ï¼Œå› ä¸ºçŸ¥é“å•ç‹¬çš„å‘¼å«æ˜¯å¦è¢«å–æ¶ˆå¾ˆæœ‰ç”¨ã€‚åœ¨[ç¤ºä¾‹è¦ç‚¹](https://gist.github.com/samthor/8f72127e3cf44bca1fc6527ce7e47023)ä¸­ï¼Œæˆ‘è¿”å›äº†ä¸€ä¸ª`Symbol`ï¼Œä¸€ä¸ªä½ å¯ä»¥æ¯”è¾ƒçš„ç‹¬ç‰¹å¯¹è±¡ã€‚</small>

æœ€åï¼Œæˆ‘ä»¬å®é™…ä¸Šä½¿ç”¨äº†`makeSingle`å¹¶åŒ…è£…äº†æˆ‘ä»¬çš„ç”Ÿæˆå™¨ä¾›å…¶ä»–äººä½¿ç”¨ï¼Œæ‰€ä»¥ç°åœ¨å®ƒçš„å·¥ä½œå°±åƒä¸€ä¸ªå¸¸è§„çš„å¼‚æ­¥æ–¹æ³•:

```
// replaces fetchAndFlash so all callers use it as an async method
fetchAndFlash = makeSingle(fetchAndFlash);

// ... later, call it
loadButton.onclick = () => {
  const pageToLoad = pageToLoadInput.value;
  fetchAndFlash(pageToLoad);  // will cancel previous work
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸‡å²ï¼ç°åœ¨ï¼Œä½ å¯ä»¥åœ¨ä»»ä½•ä½ å–œæ¬¢çš„åœ°æ–¹æ‰“ç”µè¯ç»™`fetchAndFlash()`ï¼Œå¹¶ä¸”çŸ¥é“ä¹‹å‰çš„ä»»ä½•ç”µè¯éƒ½ä¼šå°½å¿«å–æ¶ˆã€‚

* * *

## [](#aside-abortable-fetch)é è¾¹:é è¾¹å–

çƒ­å¿ƒçš„äººå¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œæˆ‘ä¸Šé¢æåˆ°çš„åªæ˜¯*å–æ¶ˆäº†*ä¸€ä¸ªæ–¹æ³•ï¼Œä½†æ²¡æœ‰ä¸­æ­¢ä»»ä½•æ­£åœ¨è¿›è¡Œçš„å·¥ä½œã€‚æˆ‘è¯´çš„æ˜¯`fetch`ï¼Œå®ƒæœ‰æŸç§æ”¯æŒçš„æ–¹å¼[æ¥ä¸­æ­¢ç½‘ç»œè¯·æ±‚](https://developers.google.com/web/updates/2017/09/abortable-fetch)ã€‚å¦‚æœå¼‚æ­¥åŠŸèƒ½æ˜¯ä¸‹è½½ä¸€ä¸ªéå¸¸å¤§çš„æ–‡ä»¶ï¼Œè¿™å¯èƒ½ä¼šèŠ‚çœç”¨æˆ·çš„å¸¦å®½ï¼Œè¿™ä¸ä¼šè¢«æˆ‘ä»¬æ‰€åšçš„äº‹æƒ…æ‰€é˜»æ­¢â€”â€”ä¸€æ—¦æ–‡ä»¶å·²ç»ç”¨å®Œäº†å®è´µçš„å­—èŠ‚ï¼Œæˆ‘ä»¬å°±ä¼šå–æ¶ˆã€‚

## [](#done)æå®š

å¦‚æœä½ è¯»åˆ°è¿™é‡Œï¼Œå¸Œæœ›ä½ å¯¹ JavaScript çš„å·¥ä½œæ–¹å¼æœ‰äº†æ›´å¤šçš„æ€è€ƒã€‚

å½“ä½ éœ€è¦åšå¼‚æ­¥å·¥ä½œæ—¶ï¼ŒJS ä¸èƒ½é˜»å¡ï¼Œå¯¹ä½ çš„æ–¹æ³•çš„å¤šæ¬¡è°ƒç”¨å¯èƒ½å‘ç”Ÿï¼Œä½ å¯ä»¥æœ‰ç­–ç•¥æ¥å¤„ç†è¿™ç§æƒ…å†µâ€”â€”è¦ä¹ˆæ˜¯é“¾æ¥ï¼Œè¦ä¹ˆå°±åƒè¿™ç¯‡æ–‡ç« çš„ä¸»é¢˜ä¸€æ ·ï¼Œå–æ¶ˆä»¥å‰çš„è°ƒç”¨ã€‚

æ„Ÿè°¢é˜…è¯»ï¼ğŸ‘‹