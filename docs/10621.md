# ç”¨ Ruby å’Œ Pusher æ„å»º Instagram å…‹éš†

> åŸæ–‡:[https://dev . to/troy 34/build-an-insta gram-clone-with-ruby-and-pusher-54ik](https://dev.to/troy34/build-an-instagram-clone-with-ruby-and-pusher-54ik)

[https://thepractical dev . S3 . Amazon AWS . com/I/nxqfrbmepu 3 pwj 7 fmb 1d . gif](https://thepracticaldev.s3.amazonaws.com/i/nxqfrbmepu3pwj7fmb1d.gif)

ä¸Šå‘¨ï¼Œæˆ‘å‚åŠ äº†[é¦–å±Šå¼€å‘ç«èµ›](https://dev.to/devteam/first-ever-dev-contest-build-a-realtime-app-with-pusher-4nhp?utm_source=additional_box&utm_medium=internal&utm_campaign=devteam_boosted&booster_org=devteam)ï¼Œç”¨ Pusher å¼€å‘äº†ä¸€ä¸ªå®æ—¶åº”ç”¨ã€‚åœ¨éå¸¸å¿™ç¢Œçš„ä¸€å¤©å’Œå¤§çº¦ 4 ä¸ªå°æ—¶çš„ç¼–ç åï¼Œæˆ‘æäº¤äº†ä¸€ä¸ª Instagram å…‹éš†ã€‚

ä½ å¯ä»¥çœ‹çœ‹æˆ‘ä¸‹é¢çš„æ¡ç›®ï¼Œçœ‹çœ‹ç›´æ’­ app å’Œ Github repoã€‚ä¹Ÿå¾ˆé«˜å…´å¾—åˆ°ä½ çš„â¤ï¸ &ğŸ¦„åœ¨æˆ‘çš„å…¥é—¨å¸–ä¸Šã€‚

[![troy34 image](../Images/9ff20fd28c97d3e5978574e8151c1682.png)](/troy34) [## [è¯æ¡] Instagram å…‹éš†

### Chuks Opia

#pushercontest#rubyrails#instagram#pusher](/troy34/entry-instagram-clone-2gbp)

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å¸¦ä½ äº†è§£æˆ‘æ˜¯å¦‚ä½•æ„å»º Instagram å…‹éš†åº”ç”¨çš„ã€‚

### [](#setting-up-the-application)è®¾ç½®åº”ç”¨ç¨‹åº

æˆ‘ä½¿ç”¨ Ruby on Rails æ„å»ºäº†è¿™ä¸ªåº”ç”¨ç¨‹åºã€‚æˆ‘åˆ©ç”¨[è®¾å¤‡](Devise)è¿›è¡Œç”¨æˆ·è®¤è¯ï¼Œåˆ©ç”¨[è½½æ³¢](https://github.com/carrierwaveuploader/carrierwave)è¿›è¡Œå›¾åƒä¸Šä¼ ã€‚
å¦‚æœä½ å·²ç»å®‰è£…äº† Ruby å’Œ Railsï¼Œå¹¶ä¸”æƒ³ç»§ç»­ä½¿ç”¨ï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤æ¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ Rails åº”ç”¨ç¨‹åºã€‚

```
$    rails new instaclone -T --database=postgresql 
```

åœ¨åº”ç”¨ç¨‹åºçš„æ ¹ç›®å½•ä¸­ï¼Œæ‰“å¼€ Gemfile å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼Œç„¶ååœ¨ç»ˆç«¯ä¸­è¿è¡Œ`bundle install`:

```
# Gemfile

gem 'bootstrap', '~> 4.1.0'
gem 'jquery-rails'
gem 'pusher'
gem 'figaro'
gem 'devise'
gem 'will_paginate', '~> 3.1.0'
gem 'carrierwave'
gem "fog-aws" 
```

### [](#database-setup)æ•°æ®åº“è®¾ç½®

ä¸ºäº†è®©æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¯åŠ¨å¹¶è¿è¡Œï¼Œæˆ‘ä»¬å°†ä¸ºå®ƒåˆ›å»ºä¸€ä¸ªæ•°æ®åº“ã€‚æ‚¨å¯ä»¥æŸ¥çœ‹è¿™ç¯‡å…³äºå¦‚ä½•åˆ›å»º Postgres æ•°æ®åº“ä»¥åŠç›¸å…³ç”¨æˆ·å’Œå¯†ç çš„æ–‡ç« ã€‚

ä¸€æ—¦æ‚¨æœ‰äº†æ•°æ®åº“çš„è¯¦ç»†ä¿¡æ¯ï¼Œåœ¨æ‚¨çš„`database.yml`æ–‡ä»¶ä¸­ï¼Œåœ¨ development é”®ä¸‹ï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç :

```
# config/database.yml

...
development:
  <<: *default
  database: instaclone_development // add this line if it isn't already there
  username: database_user // add this line
  password: user_password // add this line
... 
```

ç¡®ä¿ä¸Šé¢ä»£ç ä¸­è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç å¯ä»¥è®¿é—®`instaclone_development`æ•°æ®åº“ã€‚ä¹‹åï¼Œè¿è¡Œä»¥ä¸‹ä»£ç æ¥è®¾ç½®æ•°æ®åº“:

```
#    setup database
$    rails db:setup 
```

### [](#user-authentication)ç”¨æˆ·è®¤è¯

è®¾ç½®å¥½æ•°æ®åº“åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Devise è®¾ç½®ç”¨æˆ·èº«ä»½éªŒè¯ã€‚Devise æ˜¯ä¸€ä¸ªçµæ´»çš„ Ruby on Rails è®¤è¯è§£å†³æ–¹æ¡ˆã€‚å®ƒå¯ä»¥å¸®åŠ©æ‚¨åœ¨å‡ ç§’é’Ÿå†…è®¾ç½®ç”¨æˆ·èº«ä»½éªŒè¯ã€‚åœ¨æ‚¨çš„ç»ˆç«¯ä¸­ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
$    rails generate devise:install 
```

ä»¥ä¸Šå‘½ä»¤å°†å®‰è£… Deviseã€‚æ­¤æ—¶ï¼Œæ§åˆ¶å°ä¸­ä¼šå‡ºç°ä¸€äº›æŒ‡ä»¤ï¼Œå…¶ä¸­ä¸€æ¡æ¶‰åŠåˆ°å‘æ‚¨çš„`application.html.erb`æ–‡ä»¶æ·»åŠ ä¸€äº›ä»£ç ã€‚æˆ‘ä»¬è¿˜å°†æŠŠæˆ‘ä»¬çš„ Pusher è„šæœ¬æ·»åŠ åˆ°æ–‡ä»¶ä¸­ã€‚

ç”¨è¿™é‡Œçš„ä¸­çš„[æ›¿æ¢ä½ çš„`app/views/layouts/application.html.erb`æ–‡ä»¶ä¸­çš„ä»£ç ](https://github.com/9jaswag/instaclone/blob/develop/app/views/layouts/application.html.erb)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ç”Ÿæˆæˆ‘ä»¬çš„èº«ä»½éªŒè¯è§†å›¾é¡µé¢ï¼Œç„¶åä½¿ç”¨ Devise åˆ›å»ºç”¨æˆ·æ¨¡å‹ã€‚åœ¨æ‚¨çš„ç»ˆç«¯ä¸­ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
#    generate Devise view pages
$    rails generate devise:views

#    generate user model
$    rails generate devise user

#    generate migration to add extra columns to the user model
$    rails generate migration add_username_to_users username:string:uniq

#    generate a likes model
$    rails generate model like like_count:integer post:references 
```

ç°åœ¨æˆ‘ä»¬å·²ç»ç”Ÿæˆäº†è¿ç§»æ–‡ä»¶ï¼Œè®©æˆ‘ä»¬åœ¨è¿è¡Œè¿ç§»ä¹‹å‰å¯¹ä¸€äº›æ–‡ä»¶è¿›è¡Œä¸€äº›ä¿®æ”¹ã€‚

ä½¿ç”¨ä»¥ä¸‹å†…å®¹æ›´æ–°åº”ç”¨ç¨‹åºæ§åˆ¶å™¨ä¸­çš„ä»£ç :

```
# app/controllers/application_controller.rb

class ApplicationController < ActionController::Base
  protect_from_forgery with: :exception
  before_action :configure_permitted_parameters, if: :devise_controller?
  before_action :authenticate_user!

  protected

  def configure_permitted_parameters
    added_attrs = [:username, :email, :password, :password_confirmation, :remember_me]
    devise_parameter_sanitizer.permit :sign_up, keys: added_attrs
    devise_parameter_sanitizer.permit :account_update, keys: added_attrs
  end
end 
```

æ­¤å¤–ï¼Œç”¨ä»¥ä¸‹å†…å®¹æ›´æ–° likes è¿ç§»æ–‡ä»¶ä¸­çš„ä»£ç 

```
# db/migrate/20180524215616_create_likes.rb

class CreateLikes < ActiveRecord::Migration[5.1]
  def change
    create_table :likes do |t|
      t.integer :like_count, default: 0
      t.references :post, foreign_key: true

      t.timestamps
    end
  end
end 
```

ç°åœ¨ï¼Œæˆ‘ä»¬å‡†å¤‡å¥½è¿è¡Œæˆ‘ä»¬çš„è¿ç§»å¹¶æŸ¥çœ‹æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚åœ¨æ‚¨çš„ç»ˆç«¯ä¸­ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
#    run database migrations
$    rails db:migrate 
```

è¿è¡Œè¿ç§»ä¹‹åï¼Œé€šè¿‡è¿è¡Œ rails s åœ¨æ‚¨çš„ç»ˆç«¯ä¸Šå¯åŠ¨å¼€å‘æœåŠ¡å™¨ã€‚åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­è®¿é—® [http://localhost:3000](http://localhost:3000) ä»¥æŸ¥çœ‹æ‚¨çš„å…¨æ–°åº”ç”¨ç¨‹åº:

### [](#pusher-account-setup)æ¨æ†è´¦æˆ·è®¾ç½®

ç°åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå·²ç»å¯åŠ¨å¹¶è¿è¡Œäº†ï¼Œå» Pusher å’Œ[æ³¨å†Œä¸€ä¸ªå…è´¹è´¦æˆ·](https://dashboard.pusher.com/accounts/sign_up)ã€‚
åˆ›å»ºæ¨é€è´¦æˆ·åï¼Œé€‰æ‹©ä¾§è¾¹æ ä¸Šçš„**æ¸ é“åº”ç”¨**ï¼Œç‚¹å‡»ä¾§è¾¹æ åº•éƒ¨çš„**åˆ›å»ºæ¸ é“åº”ç”¨**æŒ‰é’®ï¼Œå³å¯åˆ›å»ºæ–°çš„åº”ç”¨ã€‚
é€šè¿‡æä¾›è¡¨æ ¼ä¸­è¦æ±‚çš„åŸºæœ¬ä¿¡æ¯æ¥é…ç½®æ‚¨çš„åº”ç”¨ç¨‹åºã€‚æ‚¨è¿˜å¯ä»¥é€‰æ‹©æƒ³è¦ä¸ Pusher é›†æˆçš„ç¯å¢ƒï¼Œå¹¶æä¾›ä¸€äº›æ ·æ¿è®¾ç½®ä»£ç ã€‚ä¹‹åï¼Œç‚¹å‡»**åº”ç”¨ç¨‹åºå¯†é’¥**é€‰é¡¹å¡å–å›æ‚¨çš„å¯†é’¥ã€‚

### [](#styling-the-pages)é¡µé¢æ ·å¼

ä¸ºäº†è®¾è®¡æˆ‘ä»¬çš„é¡µé¢ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Bootstrapã€‚æˆ‘ä»¬å·²ç»åœ¨è®¾ç½®åº”ç”¨ç¨‹åºæ—¶æ·»åŠ äº† Bootstrapï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯è¯·æ±‚å®ƒå¹¶æ·»åŠ æˆ‘ä»¬çš„æ ‡è®°å’Œæ ·å¼ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä¸ºæˆ‘ä»¬çš„å¸–å­ç”Ÿæˆä¸€ä¸ªæ§åˆ¶å™¨ï¼›åœ¨æ‚¨çš„ç»ˆç«¯ä¸­ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
#    generate a posts controller
$    rails g controller posts 
```

ç”¨ä¸‹é¢æä¾›çš„æ¯ä¸ªé“¾æ¥ä¸­çš„ä»£ç æ›´æ–°ä»¥ä¸‹æ–‡ä»¶ä¸­çš„ä»£ç :

*   å°†`app/assets/javascripts/application.js`ä¸­çš„ä»£ç æ›¿æ¢ä¸º[ä¸­çš„ä»£ç ](https://github.com/9jaswag/instaclone/blob/develop/app/assets/javascripts/application.js)
*   å°†`app/views/devise/registrations/new.html.erb`ä¸­çš„ä»£ç æ›¿æ¢ä¸º[ä¸­çš„ä»£ç ](https://github.com/9jaswag/instaclone/blob/develop/app/views/devise/registrations/new.html.erb)
*   å°†`app/views/devise/sessions/new.html.erb`ä¸­çš„ä»£ç æ›¿æ¢ä¸º[ä¸­çš„ä»£ç ](https://github.com/9jaswag/instaclone/blob/develop/app/views/devise/sessions/new.html.erb)
*   å°†æ‚¨çš„`app/assets/stylesheets/application.css`æ–‡ä»¶é‡å‘½åä¸º`app/assets/stylesheets/application.scss`ï¼Œå¹¶å°†é‚£é‡Œçš„ä»£ç æ›¿æ¢ä¸ºè¿™é‡Œçš„ä»£ç 
*   å°†è¿™é‡Œçš„ä»£ç æ·»åŠ åˆ°æ‚¨çš„`app/controllers/posts_controller.rb`æ–‡ä»¶ä¸­ã€‚
*   å°†è¿™é‡Œçš„ä»£ç æ·»åŠ åˆ°æ‚¨çš„`config/routes.rb`æ–‡ä»¶ä¸­ã€‚

å¦‚æœæˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­é‡æ–°åŠ è½½æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬åº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ªå¯çˆ±çš„æ™¯è±¡ã€‚ç»§ç»­åˆ›å»ºä¸€ä¸ªå¸æˆ·ã€‚

å¦‚æœé‡åˆ°ä»»ä½•ä¸ application.html.erb ç›¸å…³çš„é”™è¯¯ï¼Œåœ¨ config/boot.rb ä¸­ï¼Œå°† ExecJS è¿è¡Œæ—¶ä» Duktape æ›´æ”¹ä¸º Nodeã€‚

```
# config/boot.rb
ENV['EXECJS_RUNTIME'] ='Node' 
```

### [](#realtime-posts-with-pusher)å®æ—¶å‘å¸ƒä¸æ¨é€

ä¸ºäº†è®©ç”¨æˆ·å®æ—¶çœ‹åˆ°æˆ‘ä»¬çš„å¸–å­ï¼Œæ¯å½“ç”¨æˆ·æ·»åŠ ä¸€ä¸ªå¸–å­ï¼Œæˆ‘ä»¬éƒ½ä¼šå°†å…¶ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œå¹¶é€šè¿‡åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå‰ç«¯å¹¿æ’­æ–°å¸–å­å¹¶è®¢é˜…å®ƒæ¥é€šçŸ¥ Pusherã€‚
è®©æˆ‘ä»¬åˆå§‹åŒ–æˆ‘ä»¬çš„æ¨é€å®¢æˆ·ç«¯ã€‚åœ¨`config/initializers`æ–‡ä»¶å¤¹ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª`pusher.rb`æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹ä»£ç :

```
# config/initializers/pusher.rb

require 'pusher'

Pusher.app_id = ENV["PUSHER_APP_ID"]
Pusher.key = ENV["PUSHER_KEY"]
Pusher.secret = ENV["PUSHER_SECRET"]
Pusher.cluster = ENV["PUSHER_CLUSTER"]
Pusher.logger = Rails.logger
Pusher.encrypted = true 
```

ç”±äºæˆ‘ä»¬ä¸æƒ³è®©æˆ‘ä»¬çš„æŒ‰é”®å¯¹å…¬ä¼—å¯è§ï¼Œæˆ‘ä»¬å°†æ·»åŠ  save å®ƒä»¬ä½œä¸ºç¯å¢ƒå˜é‡ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨ Figaroã€‚
åœ¨æ‚¨çš„ç»ˆç«¯ä¸­è¿è¡Œ`figaro install`ã€‚å®ƒå°†ç”Ÿæˆä¸€ä¸ª`application.yml`æ–‡ä»¶ã€‚åœ¨`application.yml`æ–‡ä»¶ä¸­æ·»åŠ æ‚¨çš„æŒ‰é”®:

```
# config/application.yml

PUSHER_APP_ID: '11234'
PUSHER_KEY: '1234567890'
PUSHER_SECRET: '1234556677'
PUSHER_CLUSTER: 'us' 
```

Pusher ç°åœ¨å·²ç»åˆå§‹åŒ–ï¼Œæ¯å½“ä¿å­˜ä¸€ä¸ªæ–°å¸–å­æ—¶ï¼Œè®©æˆ‘ä»¬é€šçŸ¥ Pusherã€‚å°†ä¸‹é¢çš„ä»£ç æ·»åŠ åˆ°æ‚¨çš„å¸–å­æ¨¡å‹ä¸­:

```
# app/models/post.rb

class Post < ApplicationRecord
  belongs_to :user
  has_many :likes
  after_create :notify_pusher

  mount_uploader :image, ImageUploader

  validates :caption, presence: true

  def serialised
    {
      id: self.id,
      caption: self.caption,
      user: self.user.username,
      image: self.image_url,
      likes: self.likes[0].like_count
    }
  end

  def notify_pusher
    Pusher.trigger('post', 'new', self.serialised)
  end
end 
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåœ¨æ–°å¸–å­åˆ›å»ºåè°ƒç”¨çš„`notify_pusher`åŠ¨ä½œã€‚åœ¨`notify_pusher`åŠ¨ä½œä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è§¦å‘æ–°å¸–å­äº‹ä»¶å¹¶ä¼ å…¥æ–°å¸–å­æ¥é€šçŸ¥ pusher æœ‰æ–°å¸–å­ã€‚

æ­¤å¤–ï¼Œæ¯å½“æœ‰æ–°çš„å›¾åƒæ—¶ï¼Œæˆ‘ä»¬éƒ½å¿…é¡»é€šçŸ¥ Pusherã€‚å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ° likes æ¨¡å‹ä¸­

```
# app/models/like.rb

class Like < ApplicationRecord
  after_save :notify_pusher, on: :create
  belongs_to :post

  def notify_pusher
    Pusher.trigger('post', 'new-like', self.post.serialised)
  end
end 
```

ä¸ç”¨æˆ·æ¨¡å‹ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿé€šè¿‡å¹¿æ’­ä¸€ä¸ª`new-like`äº‹ä»¶æ¥é€šçŸ¥ Pusher ä¸€ä¸ªæ–°çš„ likeã€‚

ä¸ºäº†åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå‰ç«¯å®æ—¶æ›´æ–°ï¼Œæˆ‘ä»¬å¿…é¡»è®¢é˜…æˆ‘ä»¬åœ¨æœåŠ¡å™¨ç«¯å¹¿æ’­çš„æ–°å‘å¸ƒäº‹ä»¶ã€‚è®©æˆ‘ä»¬å°†æˆ‘ä»¬çš„`app/assets/javascripts/posts.coffee`æ–‡ä»¶é‡å‘½åä¸º`app/assets/javascripts/posts.coffee.erb`ï¼Œå¹¶å°†ä»£ç [æ·»åŠ åˆ°æ–‡ä»¶ä¸­ã€‚åœ¨æˆ‘ä»¬æ·»åŠ åˆ°ä¸Šé¢æ–‡ä»¶ä¸­çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸º Pusher å®¢æˆ·ç«¯è®¢é˜…äº†åˆ†åˆ«é’ˆå¯¹å¸–å­å’Œèµçš„`new`å’Œ`new-like`äº‹ä»¶ã€‚æ¯å½“æœ‰æ–°çš„æ´»åŠ¨ï¼Œæˆ‘ä»¬éƒ½ä¼šç”¨æ–°çš„å¸–å­å’Œèµæ¥æ›´æ–°é¡µé¢ã€‚](https://github.com/9jaswag/instaclone/blob/develop/app/assets/javascripts/posts.coffee.erb)

### [](#conclusion)ç»“è®º

å¥½äº†ï¼Œå¦‚æœä½ å·²ç»æŒ‰ç…§æœ¬æ•™ç¨‹å­¦ä¹ åˆ°è¿™ä¸€æ­¥ï¼Œä½ åº”è¯¥æ‹¥æœ‰è‡ªå·±çš„å…¨åŠŸèƒ½ Instagram å…‹éš†ã€‚Pusher æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„è½¯ä»¶ï¼Œå¯ä»¥å¸®åŠ©ä½ å®ç°ä»»ä½•ä½ èƒ½æƒ³åˆ°çš„å®æ—¶åŠŸèƒ½ã€‚

å¦‚æœä½ è§‰å¾—è¿™ä¸ªå¸–å­æœ‰ç”¨ï¼Œè¯·æ·»åŠ â¤ï¸ &ğŸ¦„åœ¨è¿™é‡Œå’Œæˆ‘çš„å…¥å£èŒä½ã€‚

[![troy34 image](../Images/9ff20fd28c97d3e5978574e8151c1682.png)](/troy34) [## [è¯æ¡] Instagram å…‹éš†

### Chuks Opia

#pushercontest#rubyrails#instagram#pusher](/troy34/entry-instagram-clone-2gbp)