# Kubernetes å®‰å…¨æœ€ä½³å®è·µ

> åŸæ–‡:[https://dev.to/pbnj/kubernetes-security-best-practices-hlk](https://dev.to/pbnj/kubernetes-security-best-practices-hlk)

[![cargo ship](../Images/7e50b9cbf04b9a2e31cbfed6da6daf29.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--1wHwhagU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.logisticsmgmt.com/images/LM1710_SUP_Ocean_wideImage2.jpg)

## ç›®å½•

*   [æ¦‚è¿°](#overview)
*   [å®‰å…¨åŸºçº¿](#secure-baseline)
*   [è®¤è¯](#authentication)
*   [æˆæƒ](#authorization)
*   [å‡†å…¥æ§åˆ¶](#admission-controls)
*   [å†’åé¡¶æ›¿](#impersonation)
*   [Pod å®‰å…¨ç­–ç•¥](#pod-security-policies)
*   [ç½‘ç»œç­–ç•¥](#network-policies)
*   [é™„åŠ å®‰å…¨æªæ–½](#additional-security)
*   [é™„åŠ å‚è€ƒæ–‡çŒ®](#additional-references)
*   [ç»“è®º](#conclusion)

## 

æ‰€ä»¥ï¼Œä½ å¯¹å®¹å™¨æŠ€æœ¯äº†å¦‚æŒ‡æŒã€‚æ‚¨å¯èƒ½åœ¨æœ¬åœ°æœºå™¨ä¸Šä¸ºæ‚¨çš„åº”ç”¨ç¨‹åºæ„å»ºäº†ä¸€ä¸ªå®¹å™¨ï¼Œå¹¶ä¸ºæ•°æ®åº“æ„å»ºäº†å¦ä¸€ä¸ªå®¹å™¨ï¼Œä½†æ˜¯æ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿä½ éœ€è¦ç³»ç»Ÿæ¥æ„å»ºä½ çš„å®¹å™¨ã€‚æ‚¨éœ€è¦ç³»ç»Ÿæ¥éƒ¨ç½²æ‚¨çš„å®¹å™¨ã€‚ä½ éœ€è¦ç³»ç»Ÿæ¥è¿è¡Œä½ çš„å®¹å™¨ã€‚ä½ å¦‚ä½•ç®¡ç†è¿™ç§è§„æ¨¡çš„é›†è£…ç®±ï¼Ÿ

è¿›æ¥å§ï¼Œåº“ä¼¯å†…ç‰¹æ–¯ï¼

Kubernetes æ˜¯æ–°çš„åº”ç”¨æœåŠ¡å™¨ã€‚Kubernetes ä¸ºå¼€å‘å›¢é˜Ÿã€è¿è¥å›¢é˜Ÿç”šè‡³å®‰å…¨å›¢é˜Ÿæä¾›äº†ä¸€ä¸ª API æ¥å£ï¼Œç”¨äºä¸åº”ç”¨ç¨‹åºå’Œå¹³å°è¿›è¡Œäº¤äº’ã€‚

Kubernetes æ˜¯ä¸€ä¸ªå¿«é€Ÿå‘å±•çš„å¼€æºé¡¹ç›®ï¼Œæ­£åœ¨ä¸æ–­å–å¾—è¿›å±•ã€‚å› æ­¤ï¼Œæˆ‘åœ¨æœ¬æ–‡ä¸­çš„ç›®æ ‡æ˜¯æ¶µç›–æˆ‘è§‚å¯Ÿåˆ°çš„ä¸€äº›å¸¸è§å®‰å…¨é”™è¯¯ï¼Œå¹¶æä¾›ä¸€äº›å…³äºä¿æŠ¤ Kubernetes é›†ç¾¤å’Œå·¥ä½œè´Ÿè½½çš„é€šç”¨æœ€ä½³å®è·µã€‚

**å›¾ä¾‹:**

| å›¾æ ‡ | æ„ä¹‰ |
| --- | --- |
| -å¥½çš„ | ä¸æ¨è |
| ğŸ—’ï¸ | åŸºæœ¬åŸç† |
| 981 å·æˆ¿ | å»ºè®® |
| âš ï¸ | è­¦å‘Š |

## 

âœ…ç¡®ä¿æ‚¨çš„åº•å±‚ä¸»æœºæ˜¯åŠ å›ºå’Œå®‰å…¨çš„ã€‚æˆ‘å»ºè®®å°† CIS åŸºå‡†ä½œä¸ºèµ·ç‚¹ã€‚

âœ…ç¡®ä¿ Docker æœ¬èº«æŒ‰ç…§å®‰å…¨æœ€ä½³å®è·µè¿›è¡Œé…ç½®ã€‚æŸ¥çœ‹æˆ‘ä»¥å‰çš„æ–‡ç« : [Docker å®‰å…¨æœ€ä½³å®è·µ](https://dev.to/petermbenjamin/docker-security-best-practices-45ih)

âœ…ç¡®ä¿æ‚¨ä» Kubernetes å¼€å§‹æ—¶æœ‰ä¸€ä¸ªå®‰å…¨çš„åŸºçº¿ã€‚

*   äº’è”ç½‘å®‰å…¨ä¸­å¿ƒ(CIS)å…è´¹ç»´æŠ¤[æ–‡æ¡£](https://downloads.cisecurity.org/)ã€‚
*   Aqua Security çš„ä¼˜ç§€äººå‘˜è¿˜å¼€æºäº†ä¸€ä¸ªåŸºäº CIS å»ºè®®çš„è‡ªåŠ¨æ£€æŸ¥å™¨ã€‚æ¥çœ‹çœ‹: [kube-bench](https://github.com/aquasecurity/kube-bench)

```
# recommended - on master node
$ kubectl run                         \
    --rm                              \
    -it                               \
    kube-bench-master                 \
    --image=aquasec/kube-bench:latest \
    --restart=Never                   \
    --overrides="{ \"apiVersion\": \"v1\", \"spec\": { \"hostPID\": true, \"nodeSelector\": { \"kubernetes.io/role\": \"master\" }, \"tolerations\": [ { \"key\": \"node-role.kubernetes.io/master\", \"operator\": \"Exists\", \"effect\": \"NoSchedule\" } ] } }"               \
    -- master                         \
    --version 1.8

# recommended - on worker nodes
$ kubectl run                         \
    --rm                              \
    -it                               \
    kube-bench-node                   \
    --image=aquasec/kube-bench:latest \
    --restart=Never                   \
    --overrides="{ \"apiVersion\": \"v1\", \"spec\": { \"hostPID\": true } }" \
    -- node                           \
    --version 1.8 
```

Enter fullscreen mode Exit fullscreen mode

* * *

## 

ä¸ Kubernetes çš„å¤§å¤šæ•°äº¤äº’éƒ½æ˜¯é€šè¿‡ä¸æ§åˆ¶å¹³é¢å¯¹è¯æ¥å®Œæˆçš„ï¼Œç‰¹åˆ«æ˜¯æ§åˆ¶å¹³é¢çš„ **kube-apiserver** ç»„ä»¶ã€‚åœ¨è¯·æ±‚è¢«æœåŠ¡æˆ–æ‹’ç»ä¹‹å‰ï¼Œè¯·æ±‚åœ¨ kube-apiserver ä¸­ç»è¿‡ 3 ä¸ªæ­¥éª¤:èº«ä»½éªŒè¯ã€æˆæƒå’Œå‡†å…¥æ§åˆ¶ã€‚ä¸€æ—¦è¯·æ±‚é€šè¿‡äº†è¿™ä¸‰ä¸ªæ­¥éª¤ï¼Œkube-apiserver å°±ä¼šé€šè¿‡ç½‘ç»œä¸ [Kubelets](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) è¿›è¡Œé€šä¿¡ã€‚å› æ­¤ï¼ŒKubelets è¿˜å¿…é¡»æ£€æŸ¥è®¤è¯å’Œæˆæƒã€‚

é€šè¿‡ä½¿ç”¨æŸäº›å‘½ä»¤è¡Œæ ‡å¿—å¯åŠ¨å®ƒä»¬ï¼Œå¯ä»¥æ§åˆ¶æˆ–ä¿®æ”¹`kube-apiserver`å’Œ`kubelet`çš„è¡Œä¸ºã€‚æ­¤å¤„è®°å½•äº†å—æ”¯æŒçš„å‘½ä»¤è¡Œæ ‡å¿—çš„å®Œæ•´åˆ—è¡¨:

*   [kube-apiserver](https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/)
*   åº“ä¼¯è±

è®©æˆ‘ä»¬æ£€æŸ¥ä¸€äº›å¸¸è§çš„ Kubernetes èº«ä»½éªŒè¯å®‰å…¨é”™è¯¯:

âŒé»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒ¿åèº«ä»½éªŒè¯å¤„äºå¯ç”¨çŠ¶æ€

ğŸ—’ï¸ Kubernetes å…è®¸å¼€ç®±å³ç”¨çš„åŒ¿åè®¤è¯ã€‚æœ‰ä¸€äº›`kube-apiserver`è®¾ç½®çš„ç»„åˆå¯ä»¥ä½¿åŒ¿åè®¤è¯å˜å¾—å®‰å…¨ï¼Œæ¯”å¦‚ [`--authorization-mode=RBAC`](#authorization) ï¼Œå› ä¸ºæ‚¨éœ€è¦æ˜ç¡®åœ°å‘`system:anonymous`ç”¨æˆ·å’Œ`system:unauthenticated`ç»„æˆäºˆ RBAC ç‰¹æƒã€‚
**æ³¨**:æˆäºˆ`*`ç”¨æˆ·æˆ–`*`ç»„çš„ RBAC æƒé™ä¸åŒ…æ‹¬åŒ¿åç”¨æˆ·ã€‚

âœ…é€šè¿‡ä¼ é€’`--anonymous-auth=false`æ ‡å¿—
æ¥ç¦ç”¨åŒ¿åè®¤è¯

```
# not recommended - on master node
$ kube-apiserver       \
    <... other flags>  \
    --anonymous-auth=true

# recommended - on master node
$ kube-apiserver       \
    <... other flags>  \
    --anonymous-auth=false

# not recommended - on worker nodes
$ kubelet             \
    <... other flags> \
    --anonymous-auth=true

# recommended - on worker nodes
$ kubelet             \
    <... other flags> \
    --anonymous-auth=false 
```

Enter fullscreen mode Exit fullscreen mode

* * *

âŒå¸¦ç€`--insecure-port=<PORT>`è·‘`kube-apiserver`

ğŸ—’ï¸åœ¨æ—§ç‰ˆæœ¬çš„ Kubernetes ä¸­ï¼Œä½ å¯ä»¥ç”¨ä¸€ä¸ªæ²¡æœ‰ä»»ä½•ä¿æŠ¤çš„ API ç«¯å£è¿è¡Œ`kube-apiserver`

âœ…é€šè¿‡ä¼ é€’`--insecure-port=0`æ ‡å¿—æ¥ç¦ç”¨ä¸å®‰å…¨çš„ç«¯å£ã€‚åœ¨æœ€è¿‘çš„ç‰ˆæœ¬ä¸­ï¼Œè¿™å·²ç»è¢«é»˜è®¤ä¸ºç¦ç”¨ï¼Œç›®çš„æ˜¯å®Œå…¨å¦å®šå®ƒ

```
# not recommended
$ kube-apiserver         \
    <... other flags>    \
    --insecure-port=6443

# recommended
$ kube-apiserver      \
    <... other flags> \
    --insecure-port=0 
```

Enter fullscreen mode Exit fullscreen mode

* * *

åœ¨å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯æ—¶ï¼Œâœ…æ›´å–œæ¬¢åŸºäº OpenID Connect æˆ– X509 å®¢æˆ·ç«¯è¯ä¹¦çš„èº«ä»½éªŒè¯ç­–ç•¥

ğŸ—’ï¸ Kubernetes æ”¯æŒä¸åŒçš„è®¤è¯ç­–ç•¥:

*   X509 å®¢æˆ·ç«¯è¯ä¹¦:ä¸é”™çš„è®¤è¯ç­–ç•¥ï¼Œä½†æ˜¯æ‚¨å¿…é¡»å®šæœŸæ›´æ–°å’Œé‡æ–°åˆ†å‘å®¢æˆ·ç«¯è¯ä¹¦
*   é™æ€ä»¤ç‰Œ:é¿å…ä½¿ç”¨å®ƒä»¬ï¼Œå› ä¸ºå®ƒä»¬ä¸æ˜¯çŸ­æš‚çš„
*   **å¼•å¯¼ä»¤ç‰Œ**:ä¸ä¸Šè¿°é™æ€ä»¤ç‰Œç›¸åŒ
*   **åŸºæœ¬è®¤è¯**:é¿å…å®ƒä»¬ï¼Œå› ä¸ºå‡­è¯ä»¥æ˜æ–‡å½¢å¼åœ¨ç½‘ç»œä¸Šä¼ è¾“
*   **æœåŠ¡å¸æˆ·ä»¤ç‰Œ**:ä¸åº”è¯¥ç”¨äºè¯•å›¾ä¸ Kubernetes é›†ç¾¤äº¤äº’çš„æœ€ç»ˆç”¨æˆ·ï¼Œä½†æ˜¯å®ƒä»¬æ˜¯åœ¨ Kubernetes ä¸Šè¿è¡Œçš„åº”ç”¨&å·¥ä½œè´Ÿè½½çš„é¦–é€‰èº«ä»½éªŒè¯ç­–ç•¥
*   **OpenID Connect (OIDC)ä»¤ç‰Œ**:OIDC ä¸æ‚¨çš„èº«ä»½æä¾›å•†(å¦‚ ADã€AWS IAMã€GCP IAM)é›†æˆåï¼Œæœ€ç»ˆç”¨æˆ·çš„æœ€ä½³èº«ä»½è®¤è¯ç­–ç•¥...ç­‰ç­‰)

```
# recommended - OIDC
$ kube-apiserver                                                        \
    <... other flags>                                                   \
    --oidc-issuer-url="https://domain/.well-known/openid-configuration" \
    --oidc-client-id="example"

# recommended - X509 cert
$ kube-apiserver                               \
    <... other flags>                          \
    --client-ca-file=/path/to/ca.crt           \
    --tls-cert-file=/path/to/server.crt        \
    --tls-private-key-file=/path/to/server.key 
```

Enter fullscreen mode Exit fullscreen mode

* * *

## 

âŒé»˜è®¤æƒ…å†µä¸‹ï¼Œæˆæƒæ¨¡å¼æ˜¯æ€»æ˜¯æˆæƒæ‰€æœ‰è¯·æ±‚ç»™`kube-apiserver`

âœ…å¯ç”¨[åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)

ğŸ—’ï¸ Kubernetes æ”¯æŒä¸åŒçš„æˆæƒç­–ç•¥ï¼Œä½†åœ¨ 1.8 ç‰ˆä¸­å¼•å…¥äº†**åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶** (RBAC)ï¼Œå®ƒå…è®¸ç®¡ç†å‘˜å®šä¹‰ç”¨æˆ·å’ŒæœåŠ¡å¸æˆ·å¯ä»¥æˆ–ä¸å¯ä»¥åœ¨æ•´ä¸ª Kubernetes é›†ç¾¤ä¸­æˆ–åœ¨ç‰¹å®šçš„ Kubernetes [åç§°ç©ºé—´](https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/)
ä¸­åšä»€ä¹ˆ

```
# not recommended
$ kube-apiserver      \
    <... other flags> \
    --authorization-mode=AlwaysAllow

# recommended
$ kube-apiserver      \
    <... other flags> \
    --authorization-mode=RBAC 
```

Enter fullscreen mode Exit fullscreen mode

* * *

âŒé»˜è®¤æƒ…å†µä¸‹ï¼Œ`default`æœåŠ¡å¸æˆ·ä¼šè‡ªåŠ¨æŒ‚è½½åˆ° Kubernetes ä¸­æ‰€æœ‰å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸­

ğŸ—’ï¸`default`æœåŠ¡å¸æˆ·æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æœåŠ¡å¸æˆ·ä»¤ç‰Œï¼Œå¯ä»¥ç”¨æ¥æŸ¥è¯¢ Kubernetes API ä½œä¸ºä¸€ä¸ªç»è¿‡èº«ä»½éªŒè¯çš„å·¥ä½œè´Ÿè½½ã€‚å¯ç”¨ RBAC åï¼Œè¿™ä»ç„¶æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œä½†æ²¡æœ‰å¯ç”¨ RBAC æ—¶çš„é—®é¢˜å¤§ã€‚æ²¡æœ‰ RBACï¼Œè¿™ä¸ªä»¤ç‰Œå¯ä»¥ç”¨æ¥åœ¨ kubernetes é›†ç¾¤ä¸­åšå‡ ä¹ä»»ä½•äº‹æƒ…

âœ…ç¦æ­¢è‡ªåŠ¨å®‰è£…`default`æœåŠ¡å¸æˆ·ä»¤ç‰Œ

```
# recommended
$ kubectl patch serviceaccount default -p "automountServiceAccountToken: false" 
```

Enter fullscreen mode Exit fullscreen mode

* * *

## 

å‡†å…¥æ§åˆ¶å™¨æ˜¯åœ¨è®¤è¯/æˆæƒè¿‡ç¨‹çš„ç¬¬ä¸‰æ­¥ï¼Œä¹Ÿæ˜¯æœ€åä¸€æ­¥ï¼Œæ‹¦æˆªå¯¹ Kubernetes API çš„è¯·æ±‚çš„ä»£ç ç‰‡æ®µã€‚è®¸å¯æ§åˆ¶é€‰é¡¹çš„å®Œæ•´åˆ—è¡¨è®°å½•åœ¨æ­¤:

*   [å‡†å…¥æ§åˆ¶å™¨](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/)

* * *

âœ…é…ç½®å‡†å…¥æ§åˆ¶ï¼Œé€šè¿‡åœ¨ç‰¹æƒå®¹å™¨ä¸Šå¯åŠ¨äº¤äº’å¼å¤–å£³æˆ–é™„åŠ åˆ°ç‰¹æƒå®¹å™¨æ¥æ‹’ç»ç‰¹æƒæå‡

ğŸ—’ï¸:åœ¨ä¸€äº›æœ‰æ•ˆçš„ç”¨ä¾‹ä¸­ï¼Œä½ éœ€è¦è¿è¡Œç‰¹æƒå®¹å™¨æ¥ä¸åº•å±‚ä¸»æœºçš„å†…æ ¸è¿›è¡Œäº¤äº’ï¼Œä½†è¿™æ„å‘³ç€ç”¨æˆ·æœ‰å¯èƒ½`kubectl attach`æˆ–`kubectl exec`è¿›å…¥é‚£äº›ç‰¹æƒå®¹å™¨ã€‚

```
# recommended
kube-apiserver       \
    <...other flags> \
    --admission-control=...,DenyEscalatingExec 
```

Enter fullscreen mode Exit fullscreen mode

* * *

âœ…é…ç½®å‡†å…¥æ§åˆ¶ä»¥å¯ç”¨ Pod å®‰å…¨ç­–ç•¥

ğŸ—’ï¸ Pod å®‰å…¨ç­–ç•¥æ˜¯ Pod å¿…é¡»éµå®ˆçš„å®‰å…¨è§„åˆ™ï¼Œä»¥ä¾¿åœ¨æ‚¨çš„é›†ç¾¤ä¸Šè¢«æ¥å—å’Œå®‰æ’ã€‚

âš ï¸ **ç¡®ä¿ä½ æœ‰ PodSecurityPolicy å¯¹è±¡(å³ yaml æ–‡ä»¶),ä¸€æ—¦ä½ æ‰“å¼€å®ƒï¼Œä½ å°±å¯ä»¥åº”ç”¨ï¼Œå¦åˆ™å°±ä¸ä¼šå®‰æ’ä»»ä½• podã€‚**å‚è§æœ¬æ–‡ä¸­çš„ [Pod å®‰å…¨ç­–ç•¥](#pod-security-policy)å»ºè®®ä»¥è·å–ç¤ºä¾‹ã€‚

```
# recommended
$ kube-apiserver      \
    <... other flags> \
    --addmission-control=...,PodSecurityPolicy

# example PodSecurityPolicy
$ kubectl create -f- <<EOF 
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: example
spec:
  privileged: false  # Don't allow privileged pods!
EOF

# let's try to request a privileged pod to be scheduled on our cluster
$ kubectl create -f- <<EOF
apiVersion: v1
kind: Pod
metadata:
  name:      pause
spec:
  containers:
    - name:  pause
      image: k8s.gcr.io/pause
EOF

# throws error as expected
Error from server (Forbidden): error when creating "STDIN": pods "privileged" is forbidden: unable to validate against any pod security policy: [spec.containers[0].securityContext.privileged: Invalid value: true: Privileged containers are not allowed] 
```

Enter fullscreen mode Exit fullscreen mode

* * *

âœ…å°†å‡†å…¥æ§åˆ¶é…ç½®ä¸ºæ€»æ˜¯æ‹‰å–å›¾åƒ

ğŸ—’ï¸ Kubernetes å°†ç¼“å­˜ä»ä»»ä½•æ³¨å†Œè¡¨(ç§äººæˆ–å…¬å…±)æå–çš„å®¹å™¨å›¾åƒã€‚ä»»ä½•ç¼“å­˜çš„å®¹å™¨æ˜ åƒéƒ½å¯ä»¥è¢«é›†ç¾¤ä¸Šçš„ä»»ä½• pod é‡ç”¨ã€‚å› æ­¤ï¼Œpod å¯èƒ½ä¼šè·å¾—å¯¹æ½œåœ¨æ•æ„Ÿä¿¡æ¯çš„æœªæˆæƒè®¿é—®ã€‚å¼ºåˆ¶ Kubernetes æ€»æ˜¯è·å–å›¾åƒå°†è¦æ±‚ä»ç§æœ‰æ³¨å†Œä¸­å¿ƒè·å–å›¾åƒæ‰€éœ€çš„å‡­è¯ç”±æ¯ä¸ªè¯·æ±‚èµ„æºæä¾›

```
# recommended
$ kube-apiserver      \
    <... other flags> \
    --admission-control=...,AlwaysPullImages 
```

Enter fullscreen mode Exit fullscreen mode

* * *

## 

Kubernetes æœ‰ä¸€ä¸ªç‰¹æ€§ï¼Œå…è®¸ä»»ä½•ç”¨æˆ·æ¨¡æ‹Ÿ Kubernetes é›†ç¾¤ä¸Šçš„ä»»ä½•å…¶ä»–ç”¨æˆ·ã€‚è¿™ä¸ªç‰¹æ€§å¯¹äºè°ƒè¯•æ¥è¯´å¾ˆå¥½ï¼Œä½†æ˜¯å¦‚æœæ§åˆ¶ä¸å½“ï¼Œå¯èƒ½ä¼šå¸¦æ¥æ„æƒ³ä¸åˆ°çš„å®‰å…¨éšæ‚£ã€‚

ä¸ºäº†è¯æ˜å…¶å«ä¹‰:

```
$ kubectl drain test-node
Error from server (Forbidden): User "foo" cannot get nodes at the cluster scope. (get nodes test-node)

$ kubectl drain test-node --as=admin --as-group=system:admins
node "test-node" cordoned
node "test-node" drained 
```

Enter fullscreen mode Exit fullscreen mode

ä½ å¯ä»¥åœ¨è¿™é‡Œäº†è§£æ›´å¤šä¿¡æ¯:

*   [ç”¨æˆ·æ¨¡æ‹Ÿ](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation)

âœ…é™åˆ¶äº†è°å¯ä»¥å†’å……ä»¥åŠä½œä¸ºè¢«å†’å……çš„ç”¨æˆ·ä»–ä»¬å¯ä»¥åšä»€ä¹ˆ

```
# not recommended
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: impersonator
rules:
# allows users to impersonate any "users", "groups", and "serviceaccounts"
- apiGroups: [""]
  resources: ["users", "groups", "serviceaccounts"]
  verbs: ["impersonate"]

# recommended
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: limited-impersonator
rules:
# Can impersonate the group "developers"
- apiGroups: [""]
  resources: ["groups"]
  verbs: ["impersonate"]
  resourceNames: ["developers"] 
```

Enter fullscreen mode Exit fullscreen mode

* * *

## 

Pod å®‰å…¨ç­–ç•¥å®šä¹‰äº†ä¸€ç»„æ¡ä»¶ï¼Œpod å¿…é¡»éµå®ˆè¿™äº›æ¡ä»¶æ‰èƒ½è¢«ç³»ç»Ÿæ¥å—ã€‚

âœ…ä¸å…è®¸ç‰¹è®¸é›†è£…ç®±

```
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted
spec:
  privileged: false 
```

Enter fullscreen mode Exit fullscreen mode

âœ…ä¸å…è®¸å…±äº«ä¸»æœºè¿›ç¨‹ ID åç§°ç©ºé—´
âš ï¸ **å¦‚æœ`hostPID`è¢«è®¾ç½®ä¸º`true`å¹¶ä¸”å®¹å™¨è¢«æˆäºˆ`SYS_PTRACE`èƒ½åŠ›ï¼Œåˆ™æœ‰å¯èƒ½æå‡å®¹å™¨**ä¹‹å¤–çš„ç‰¹æƒ

```
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted
spec:
  hostPID: false 
```

Enter fullscreen mode Exit fullscreen mode

âœ…ä¸å…è®¸å…±äº«ä¸»æœº IPC å‘½åç©ºé—´(å³å†…å­˜)

```
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted
spec:
  hostIPC: false 
```

Enter fullscreen mode Exit fullscreen mode

âœ…ä¸å…è®¸å…±äº«ä¸»æœºç½‘ç»œå †æ ˆ(å³è®¿é—®å›ç¯ã€æœ¬åœ°ä¸»æœºã€çª¥æ¢æœ¬åœ°èŠ‚ç‚¹ä¸Šçš„ç½‘ç»œæµé‡)

```
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted
spec:
  hostNetwork: false 
```

Enter fullscreen mode Exit fullscreen mode

âœ…ç™½åå•å…è®¸çš„å·ç±»å‹

```
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted
spec:
  # It's recommended to allow the core volume types.
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    # Assume that persistentVolumes set up by the cluster admin are safe to use.
    - 'persistentVolumeClaim' 
```

Enter fullscreen mode Exit fullscreen mode

âœ…è¦æ±‚å®¹å™¨ä»¥éæ ¹ç”¨æˆ·èº«ä»½è¿è¡Œ

```
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted
spec:
  runAsUser:
    # Require the container to run without root privileges.
    rule: 'MustRunAsNonRoot'
  supplementalGroups:
    rule: 'MustRunAs'
    ranges:
      # Forbid adding the root group.
      - min: 1
        max: 65535 
```

Enter fullscreen mode Exit fullscreen mode

âœ…æŠŠ`defaultAllowPrivilegeEscalation`è®¾ç½®ä¸º`false`åˆ°

```
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted
spec:
  defautlAllowPrivilegeEscalation: false 
```

Enter fullscreen mode Exit fullscreen mode

âœ…åº”ç”¨å®‰å…¨å¢å¼ºçš„ Linux ( `seLinux`)ã€`seccomp`æˆ–`apparmor`é…ç½®æ–‡ä»¶

```
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted
  annotations:
    # applying default seccomp and apparmor profiles
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: 'docker/default'
    apparmor.security.beta.kubernetes.io/allowedProfileNames: 'runtime/default'
    seccomp.security.alpha.kubernetes.io/defaultProfileName:  'docker/default'
    apparmor.security.beta.kubernetes.io/defaultProfileName:  'runtime/default' 
```

Enter fullscreen mode Exit fullscreen mode

### å…¨ Pod å®‰å…¨ç­–ç•¥ç¤ºä¾‹

```
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted
  annotations:
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: 'docker/default'
    apparmor.security.beta.kubernetes.io/allowedProfileNames: 'runtime/default'
    seccomp.security.alpha.kubernetes.io/defaultProfileName:  'docker/default'
    apparmor.security.beta.kubernetes.io/defaultProfileName:  'runtime/default'
spec:
  privileged: false
  # Required to prevent escalations to root.
  defautlAllowPrivilegeEscalation: false
  # This is redundant with non-root + disallow privilege escalation,
  # but we can provide it for defense in depth.
  requiredDropCapabilities:
    - ALL
  # Allow core volume types.
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    # Assume that persistentVolumes set up by the cluster admin are safe to use.
    - 'persistentVolumeClaim'
  hostNetwork: false
  hostIPC: false
  hostPID: false
  runAsUser:
    # Require the container to run without root privileges.
    rule: 'MustRunAsNonRoot'
  seLinux:
    # This policy assumes the nodes are using AppArmor rather than SELinux.
    rule: 'RunAsAny'
  supplementalGroups:
    rule: 'MustRunAs'
    ranges:
      # Forbid adding the root group.
      - min: 1
        max: 65535
  fsGroup:
    rule: 'MustRunAs'
    ranges:
      # Forbid adding the root group.
      - min: 1
        max: 65535
  readOnlyRootFilesystem: false 
```

Enter fullscreen mode Exit fullscreen mode

* * *

## 

Kubernetes å…è®¸ç”¨æˆ·éƒ¨ç½²ä»–ä»¬é€‰æ‹©çš„ç½‘ç»œé™„ä»¶ã€‚

âœ…é€‰æ‹©ä¸€ä¸ªå…è®¸ä½ åˆ©ç”¨ç½‘ç»œç­–ç•¥çš„ç½‘ç»œé™„ä»¶ï¼Œåƒ [Calico](https://docs.projectcalico.org/v3.1/introduction/) æˆ– [Canal](https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/flannel) ï¼Œå®ƒé€šè¿‡æ³•å…°ç»’ä¸ºä½ æä¾›ç½‘ç»œï¼Œé€šè¿‡ Calico æä¾›ç½‘ç»œç­–ç•¥ã€‚

```
# Canal Example 
$ kube-apiserver                 \
    <... other flags>            \
    --cluster-cidr=10.244.0.0/16 \
    --allocate-node-cidrs=true

# install RBAC
$ kubectl apply -f \
    https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/canal/rbac.yaml

# install Calico
$ kubectl apply -f \
    https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/canal/canal.yaml 
```

Enter fullscreen mode Exit fullscreen mode

## 

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‰€æœ‰çš„å»ºè®®éƒ½åªæ˜¯ä¸ºäº†è®©ä½ å¼€å§‹å·¥ä½œã€‚åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘å°†ä»‹ç»ä¸€äº›é¢å¤–çš„å®‰å…¨æªæ–½ï¼

âœ…Â·åº“ä¼¯å†…ç‰¹[ç§˜å¯†](https://kubernetes.io/docs/concepts/configuration/secret/)å¯¹äºä¸€äº›æœ‰é™çš„ç”¨ä¾‹æ˜¯æœ‰ç”¨çš„ã€‚æˆ‘ä¸ä¼šä¾èµ–å®ƒä½œä¸ºç§˜å¯†ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚ç›¸åï¼Œè€ƒè™‘å“ˆå¸Œå…¬å¸[é‡‘åº“](https://www.vaultproject.io/)åšè¿™ä¸ªã€‚

âœ…ç”¨ [Anchore](https://anchore.com/) æˆ– [Clair](https://coreos.com/clair/docs/latest/) æŒç»­æ‰«æä½ çš„å®¹å™¨ä¸­çš„å®‰å…¨æ¼æ´ã€‚

âœ…è®©æ‚¨çš„åŸºç¡€è®¾æ–½åœ¨å®‰å…¨è¡¥ä¸ä¸Šä¿æŒæœ€æ–°ï¼Œæˆ–è€…åœ¨ä¿æŒè‡ªèº«æœ€æ–°çš„æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œ Kubernetes(ä¾‹å¦‚ CoreOS)

âœ…ä»…éƒ¨ç½²æ‚¨å·²åˆ†æã€æ‰«æå’Œç­¾åçš„æˆæƒå®¹å™¨æ˜ åƒ(å³è½¯ä»¶ä¾›åº”é“¾å®‰å…¨)ã€‚[å…¬è¯äºº](https://github.com/theupdateframework/notary)å¯ä»¥åœ¨è¿™é‡Œå¸®å¿™ã€‚

âœ…é™åˆ¶å¯¹ Kubernetes èŠ‚ç‚¹çš„ç›´æ¥è®¿é—®ã€‚

âœ…é¿å…åµé—¹çš„é‚»å±…é—®é¢˜ã€‚å®šä¹‰èµ„æºé…é¢ã€‚

âœ…ç›‘è§†å¹¶è®°å½•æ™®ç½—ç±³ä¿®æ–¯å’Œæ ¼æ‹‰å¤«çº³çš„ä¸€åˆ‡ã€‚Sysdig Falco å°†æ£€æµ‹å¼‚å¸¸å®¹å™¨è¡Œä¸ºå¹¶å‘å‡ºè­¦æŠ¥ï¼Œå¦‚å®¹å™¨ä¸­çš„å¤–å£³æ‰§è¡Œã€å®¹å™¨æƒé™æå‡ã€æ„å¤–å­è¿›ç¨‹çš„äº§ç”Ÿã€å®‰è£…æ•æ„Ÿè·¯å¾„ã€è¿›è¡Œç½‘ç»œè¿æ¥çš„ç³»ç»ŸäºŒè¿›åˆ¶æ–‡ä»¶...ç­‰ç­‰

* * *

## 

*   [ä¿æŠ¤é›†ç¾¤](https://kubernetes.io/docs/tasks/administer-cluster/securing-a-cluster/)
*   ã€Kubernetes éƒ¨ç½²çš„å®‰å…¨æœ€ä½³å®è·µ
*   [Kubernetes å®‰å…¨æœ€ä½³å®è·µ](https://github.com/freach/kubernetes-security-best-practice)

* * *

## 

å®¹å™¨å’Œç¼–æ’å™¨æœ¬è´¨ä¸Šå¹¶ä¸æ¯”ä¼ ç»Ÿè™šæ‹ŸåŒ–æŠ€æœ¯æ›´å®‰å…¨æˆ–æ›´ä¸å®‰å…¨ã€‚å¦‚æœæœ‰çš„è¯ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºå®¹å™¨å’Œç¼–æ’å™¨æœ‰å¯èƒ½å½»åº•æ”¹å˜å®‰å…¨è¡Œä¸šï¼Œå¹¶çœŸæ­£ä»¥ devo PS çš„é€Ÿåº¦å®ç°*å®‰å…¨ã€‚*

å¦‚æœä½ è§‰å¾—æˆ‘é”™è¿‡äº†ä»€ä¹ˆï¼Œå¼„é”™äº†ä¸€äº›ç»†èŠ‚ï¼Œæˆ–è€…åªæ˜¯æƒ³æ‰“ä¸ªæ‹›å‘¼ï¼Œè¯·éšæ—¶åœ¨ä¸‹é¢ç•™ä¸‹è¯„è®ºæˆ–è€…åœ¨ GitHub ä¸Šè”ç³»æˆ‘ğŸ™ï¼Œ[æ¨ç‰¹ğŸ¦](https://twitter.com/petermbenjamin)ï¼Œæˆ– [LinkedInğŸ”—](https://www.linkedin.com/in/pmbenjamin)