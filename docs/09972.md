# ã€‚Net æ ¸å¿ƒå•å…ƒæµ‹è¯•å’Œ Visual Studio ä»£ç çš„ä»£ç è¦†ç›–ç‡

> åŸæ–‡:[https://dev . to/equi man/net-core-unit-test-and-code-coverage-with-visual studio-code-37bp](https://dev.to/equiman/net-core-unit-test-and-code-coverage-with-visual-studio-code-37bp)

æœ‰ä¸€ç§ä¸å¥½çš„è§‚å¿µè®¤ä¸ºä½ ä¸èƒ½åœ¨ã€‚Mac ä¸Šçš„ Net Coreï¼Œå› ä¸º OpenCover å·¥å…·åªåœ¨ Windows ä¸Šå·¥ä½œã€‚

ä½†æ˜¯æˆ‘å‘ç°äº†ä¸€ä¸ªæ–°çš„ NuGet åŒ…ï¼Œå«åš Coverletï¼Œæ˜¯ä¸€ä¸ªè·¨å¹³å°çš„ä»£ç è¦†ç›–åº“ã€‚ç½‘èŠ¯ã€‚æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç›¸åŒçš„å‘½ä»¤è¿›è¡Œä»£ç è¦†ç›–ï¼Œæ— è®ºæ‚¨æ˜¯åœ¨ Macã€Linux è¿˜æ˜¯ Windows ä¸Šå·¥ä½œã€‚

# åºŠç½©

ç”¨äºè·¨å¹³å°ä»£ç è¦†ç›–çš„å·¥å…·ã€‚ç½‘ç»œæ ¸å¿ƒ

ä¸ OpenCover ç›¸æ¯”ï¼Œå®ƒçš„æ˜“ç”¨æ€§ä»¤äººéš¾ä»¥ç½®ä¿¡ã€‚å°†è¿™ä¸ª NuGet åŒ…æ·»åŠ åˆ°æ‚¨çš„**æµ‹è¯•**é¡¹ç›®:

```
dotnet add package coverlet.msbuild 
```

Enter fullscreen mode Exit fullscreen mode

ç°åœ¨æ·»åŠ ä¸€äº›è¿è¡Œæµ‹è¯•é¡¹ç›®æ—¶çš„å‚æ•°:

```
dotnet test /p:CollectCoverage=true 
```

Enter fullscreen mode Exit fullscreen mode

ä»…æ­¤è€Œå·²ã€‚ä½†æ˜¯å¦‚æœä½ æƒ³æ ¹æ®ä½ çš„éœ€è¦ä¸ªæ€§åŒ–å®ƒ:

```
dotnet test Project.Tests/Project.Tests.csproj /p:CollectCoverage=true /p:CoverletOutputFormat=\"opencover,lcov\" /p:CoverletOutput=../lcov 
```

Enter fullscreen mode Exit fullscreen mode

æˆ‘éœ€è¦ä¸€ä»½`opencover`å’Œ`lcov`æ ¼å¼çš„ä»£ç è¦†ç›–ç‡æŠ¥å‘Šã€‚ç¬¬ä¸€ä¸ªæ˜¯ä¸Šä¼ åˆ°å£°çº³äº‘ï¼Œç¬¬äºŒä¸ªæ˜¯ç”¨äºè¦†ç›– Gutters Visual Studio ä»£ç æ‰©å±•ã€‚

# Visual Studio ä»£ç æ‰©å±•

å¦‚æœå°æ™ºæ˜¯ç¨‹åºå‘˜ï¼Œè‚¯å®šä¼šè¯´: **Visual Studio ä»£ç ...**

[![Alt I Choose You!](../Images/16884c3d13c6981dae4e5ae24d984c59.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--07-tclIq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/j0gssgbhtbylpixd320l.gif)

å®ƒå¯ä»¥æ ¹æ®æ‚¨çš„éœ€è¦è¿›è¡Œæ‰©å±•ã€‚å®ƒæ˜¯å®Œç¾çš„ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªæ‰©å±•ç»™äº†ä½ å•å…ƒæµ‹è¯•çš„è¶…èƒ½åŠ›:

*   [Coverage Gutters-Visual Studio market place](https://marketplace.visualstudio.com/items?itemName=ryanluker.vscode-coverage-gutters)
*   [ã€‚NET æ ¸å¿ƒæµ‹è¯•èµ„æºç®¡ç†å™¨- Visual Studio Marketplace](https://marketplace.visualstudio.com/items?itemName=formulahendry.dotnet-test-explorer)

**Coverage Gutter** åœ¨å±å¹•ä¸Šç”¨é¢œè‰²æ˜¾ç¤ºè¦†ç›–ç»“æœï¼Œæ‚¨å¯ä»¥æ¿€æ´»æˆ–ç¦ç”¨å®ƒã€‚å¹¶ä¸”**æµ‹è¯•èµ„æºç®¡ç†å™¨**ç»™ä½ ä¸€ä¸ªå¯è§†åŒ–çš„èµ„æºç®¡ç†å™¨é¢æ¿ï¼Œå½“ä½ å¯ä»¥è¿è¡Œæµ‹è¯•æ—¶:æ‰€æœ‰çš„ï¼Œä¸Šä¸‹æ–‡ä¸­çš„ä¸€ä¸ªç»„æˆ–è€…å•ç‹¬çš„æµ‹è¯•ã€‚æ›´å¥½çš„æ˜¯åœ¨æ¯æ¬¡æµ‹è¯•ä¸­ç‚¹äº® code lens styleï¼Œä½ å¯ä»¥çœ‹åˆ°ä»–çš„ç»“æœã€‚

# å•å…ƒæµ‹è¯•æ¡†æ¶

æ‚¨å¯ä»¥åœ¨ä¸­æ‰¾åˆ°è®¸å¤šå…³äºå•å…ƒæµ‹è¯•æ¡†æ¶(xUnitã€nUnit å’Œ MSTest)çš„æ–‡çŒ®ã€‚Netï¼Œå®é™…ä¸Šï¼Œæ— è®ºæ‚¨é€‰æ‹©ä»€ä¹ˆï¼Œå®ƒä»¬ä¹‹é—´éƒ½æ²¡æœ‰æ˜¾è‘—çš„å·®å¼‚ã€‚

æˆ‘ä¸ºä»€ä¹ˆé€‰æ‹© xUnitï¼Ÿå› ä¸ºå®ƒæ˜¯ã€‚Net åŸºç¡€ï¼Œæˆ‘å–œæ¬¢ä»–çš„ syntaxis å’Œå·¥ä½œåƒä¸€ä¸ªæµ‹è¯•æµè§ˆå™¨æ’ä»¶çš„é­…åŠ›ã€‚

å…³äº xUnit æœ‰ä¸€ä¸ªå¾ˆå¥½çš„è§£é‡Šã€‚ç½‘èŠ¯ã€‚å¦‚æœä½ æ­£åœ¨åˆ¶ä½œå©´å„¿æµ¸æ³¡æ¶²ï¼Œæˆ‘å¼ºçƒˆæ¨èä½ é˜…è¯»:

[å•å…ƒæµ‹è¯•ä¸­çš„ C#ä»£ç ã€‚NET Core ä½¿ç”¨ dotnet test å’Œ xUnit](https://docs.microsoft.com/en-us/dotnet/core/testing/unit-testing-with-dotnet-test)

# å£°çº³äº‘

æˆ‘æ— æ³•æƒ³è±¡åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ä¸ä½¿ç”¨ SonarQube è¿™æ ·çš„å·¥å…·çš„ç¤¼ç‰©ã€‚æˆ‘åˆ›å»ºäº†ä¸¤ä¸ªè„šæœ¬æ¥è¿è¡Œ Sonar Scanner å¹¶ä¸Šä¼ ç»“æœï¼ŒåŒ…æ‹¬ä»£ç è¦†ç›–ç‡ã€‚

ä¸º MSBuild å®‰è£…[sonar scanner](https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner+for+MSBuild):

```
dotnet tool install --global dotnet-sonarscanner 
```

Enter fullscreen mode Exit fullscreen mode

åœ¨`Profile > Security > Generate Token`çš„ [SonarCloud](https://sonarcloud.io/) ä¸Šåˆ›å»ºä¸€ä¸ªå£°çº³ç™»å½•ä»¤ç‰Œã€‚ä¿å­˜åœ¨ **`sonar.txt`** æ–‡ä»¶ä¸­ï¼Œå¹¶å°†è¯¥æ–‡ä»¶æ·»åŠ åˆ°`.gitignore`ä¸­ã€‚ç°åœ¨å¯ä»¥å±€éƒ¨ä½¿ç”¨ï¼Œä¸èƒ½é€éœ²ç»™å¥½å¥‡çš„çœ¼ç›ã€‚

åœ¨ Windows ä¸Šä½¿ç”¨è¿™ä¸ª(Bat):

<figure>

```
@echo off
set /p token=<sonar.txt
dotnet sonarscanner begin /k:"company:project" /n:"Project" /v:"#.#.#" /o:"companyname" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.login="%token%" /d:sonar.language="cs" /d:sonar.exclusions="**/bin/**/*,**/obj/**/*" /d:sonar.coverage.exclusions="Project.Tests/**,**/*Tests.cs" /d:sonar.cs.opencover.reportsPaths="%cd%\lcov.opencover.xml"
dotnet restore
dotnet build
dotnet test Project.Tests/Project.Tests.csproj /p:CollectCoverage=true /p:CoverletOutputFormat=\"opencover,lcov\" /p:CoverletOutput=../lcov
dotnet sonarscanner end /d:sonar.login="%token%" 
```

Enter fullscreen mode Exit fullscreen mode

<figcaption>sonar.bat</figcaption>

</figure>

åœ¨ Mac/Linux (bash)ä¸Šä½¿ç”¨å®ƒï¼Œå¹¶è®°ä½ç»™äºˆæ‰§è¡Œæƒé™:

<figure>

```
#!/bin/bash
token="$(cat sonar.txt)"
dir="$(pwd)"
dotnet sonarscanner begin /k:"company:project" /n:"Project" /v:"#.#.#" /o:"company" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.login="${token}" /d:sonar.language="cs" /d:sonar.exclusions="**/bin/**/*,**/obj/**/*" /d:sonar.cs.opencover.reportsPaths="${dir}/lcov.opencover.xml"
dotnet restore
dotnet build
dotnet test Project.Tests/Project.Tests.csproj /p:CollectCoverage=true /p:CoverletOutputFormat=\"opencover,lcov\" /p:CoverletOutput=../lcov
dotnet sonarscanner end /d:sonar.login="${token}" 
```

Enter fullscreen mode Exit fullscreen mode

<figcaption>sonar.sh</figcaption>

</figure>

> å˜æ›´**å…¬å¸**ã€**é¡¹ç›®**ã€ **#ã€‚#.#** å’Œ**é¡¹ç›®**ç”¨ä½ çš„ã€‚

[åˆ†æå‚æ•°-sonar cube æ–‡æ¡£-Doc sonar cube](https://docs.sonarqube.org/display/SONAR/Analysis+Parameters)

# å¥–é‡‘è¿½è¸ª

## ä»»åŠ¡

Visual Studio ä»£ç çš„å¦ä¸€ä¸ªå—æ¬¢è¿çš„ç‰¹æ€§æ˜¯ï¼Œæ‚¨å¯ä»¥è‡ªåŠ¨æ‰§è¡Œå’Œåˆ›å»ºä»»åŠ¡ï¼Œå¹¶ä¸”å¯ä»¥è½»æ¾å¯åŠ¨ã€‚

é‚£æ˜¯æˆ‘çš„é…ç½® task.json æ–‡ä»¶ã€‚æˆ‘æœ‰è‡ªåŠ¨åŒ–çš„æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒã€æ‰“åŒ…å’Œå£°çº³ä»»åŠ¡ã€‚

<figure>

```
{  "version":  "2.0.0",  "tasks":  [  {  "label":  "build",  "command":  "dotnet",  "type":  "process",  "group":  {  "kind":  "build",  "isDefault":  true  },  "args":  [  "build",  "${workspaceFolder}/Project/Project.csproj"  ],  "problemMatcher":  "$msCompile"  },  {  "label":  "build tests",  "command":  "dotnet",  "type":  "process",  "group":  "build",  "args":  [  "build",  "${workspaceFolder}/Project.Tests/Project.Tests.csproj"  ],  "problemMatcher":  "$msCompile"  },  {  "label":  "test",  "command":  "dotnet",  "type":  "process",  "group":  {  "kind":  "test",  "isDefault":  true  },  "args":  [  "test",  "${workspaceFolder}/Project.Tests/Project.Tests.csproj",  "/p:CollectCoverage=true",  "/p:CoverletOutputFormat=\"opencover,lcov\"",  "/p:CoverletOutput=../lcov"  ],  "problemMatcher":  "$msCompile"  },  {  "label":  "publish win",  "command":  "dotnet",  "group":  "none",  "args":  [  "publish",  "${workspaceRoot}/Project/Project.csproj",  "-o",  "${workspaceRoot}/Library/win/",  "-c",  "release",  "-r",  "win10-x64"  ],  "problemMatcher":  "$msCompile"  },  {  "label":  "publish mac",  "command":  "dotnet",  "args":  [  "publish",  "${workspaceRoot}/Project/Project.csproj",  "-o",  "${workspaceRoot}/Library/mac/",  "-c",  "release",  "-r",  "osx.10.12-x64"  ],  "problemMatcher":  "$msCompile"  },  {  "label":  "pack",  "command":  "dotnet",  "args":  [  "pack",  "${workspaceRoot}/Project/Project.csproj",  "/p:NuspecFile=${workspaceRoot}/Project/Project.nuspec",  "-o",  "${workspaceRoot}/Package/",  "-c",  "release"  ],  "problemMatcher":  "$msCompile"  },  {  "label":  "permissions",  "type":  "shell",  "osx":  {  "command":  "chmod +x ${workspaceRoot}/sonar.sh"  },  "presentation":  {  "reveal":  "always",  "panel":  "new"  },  "problemMatcher":  []  },  {  "label":  "sonar",  "type":  "shell",  "windows":  {  "command":  "${workspaceRoot}\\sonar.bat"  },  "osx":  {  "command":  "${workspaceRoot}/sonar.sh"  },  "presentation":  {  "reveal":  "always",  "panel":  "new"  },  "problemMatcher":  []  }  ]  } 
```

Enter fullscreen mode Exit fullscreen mode

<figcaption>tasks.json</figcaption>

</figure>

> å˜æ›´**å…¬å¸**ã€**é¡¹ç›®**ã€ **#ã€‚#.#** å’Œ**é¡¹ç›®**ç”¨ä½ çš„ã€‚

## ç‰¹æ‹‰ç»´æ–¯è¯

å¯¹ç‰¹æ‹‰ç»´æ–¯è¿›è¡Œå£°çº³æ‰«ææœ‰ç‚¹é—®é¢˜ã€‚è¯€çªæ˜¯åœ¨å®‰è£…æ—¶å¯¼å‡ºè·¯å¾„ã€‚

ä¸ºäº†å¯¹ sonar é”®ä¿å¯†ï¼Œåœ¨ Travis ä¸Šåˆ›å»ºä¸€ä¸ªç¯å¢ƒå˜é‡ä½œä¸º`SONAR_KEY`ã€‚

```
language: csharp
mono: none
dotnet: 3.1.201

solution: Project/Project.csproj

install:
  - dotnet tool install --global dotnet-sonarscanner
  - dotnet restore Project/Project.csproj
  - dotnet restore Project.Tests/Project.Tests.csproj

before_script:
  - export PATH="$PATH:$HOME/.dotnet/tools"

script:
  - dotnet sonarscanner begin /k:"company:project" /n:"Project" /v:"#.#.#" /o:"companyname" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.login="$SONAR_KEY" /d:sonar.language="cs" /d:sonar.exclusions="**/bin/**/*,**/obj/**/*" /d:sonar.cs.opencover.reportsPaths="lcov.opencover.xml" || true
  - dotnet build Project/Project.csproj
  - dotnet test Project.Tests/Project.Tests.csproj /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:CoverletOutput=../lcov
  - dotnet sonarscanner end /d:sonar.login="$SONAR_KEY" || true

cache:
  directories:
    - '$HOME/.nuget/packages'
    - '$HOME/.local/share/NuGet/Cache'
    - '$HOME/.sonar/cache' 
```

Enter fullscreen mode Exit fullscreen mode

> å˜æ›´**å…¬å¸**ã€**é¡¹ç›®**ã€ **#ã€‚#.#** å’Œ**é¡¹ç›®**ç”¨ä½ çš„ã€‚

## GitHub åŠ¨ä½œ

ä¸ºäº†å¯¹å£°çº³é”®ä¿å¯†ï¼Œåœ¨`Settings -> Secrets`ä¸Šåˆ›å»ºä¸€ä¸ªåä¸º`SONAR_KEY`çš„ç¯å¢ƒå˜é‡ã€‚

åœ¨æ‚¨çš„é¡¹ç›®:
ä¸Šåˆ›å»ºè¿™ä¸ªæ–‡ä»¶`/.github/workflows/build.yml`

```
name: build

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  dotnet: 3.1.201
  version: #.#.#
  key: company:project
  organization: company:project
  name: Project

jobs:
  build:
    runs-on: ${{ matrix.platform }}
    strategy:
      matrix:
        platform: [ubuntu-latest, macos-latest, windows-latest]
    name: build on ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v2
      - name: setup .Net Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ env.dotnet }}
      - name: restore
        run: dotnet restore Project/Project.csproj
      - name: build
        run: dotnet build Project/Project.csproj --no-restore
  test:
    runs-on: ubuntu-latest
    name: test
    steps:
      - uses: actions/checkout@v2
      - name: setup .Net Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ env.dotnet }}
      - name: install sonar-scanner
        run: dotnet tool install --global dotnet-sonarscanner
      - name: restore
        run: dotnet restore Project/Project.csproj
      - name: build
        run: dotnet build Project/Project.csproj --no-restore
      - name: restore test
        run: dotnet restore Project.Tests/Project.Tests.csproj
      - name: build test
        run: dotnet build Project.Tests/Project.Tests.csproj --no-restore
      - name: scanner begin
        run: dotnet sonarscanner begin /k:"${{ env.key }}" /n:"${{ env.name }}" /v:"${{ env.version }}" /o:"${{ env.organization }}" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.login="${{ secrets.SONAR_TOKEN }}" /d:sonar.language="cs" /d:sonar.exclusions="**/bin/**/*,**/obj/**/*" /d:sonar.cs.opencover.reportsPaths="lcov.opencover.xml"
      - name: scanner build
        run: dotnet build Project/Project.csproj
      - name: scanner test
        run: dotnet test Project.Tests/Project.Tests.csproj /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:CoverletOutput=../lcov
      - name: scanner end
        run: dotnet sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
```

Enter fullscreen mode Exit fullscreen mode

> å˜æ›´**å…¬å¸**ã€**é¡¹ç›®**ã€ **#ã€‚#.#** å’Œ**é¡¹ç›®**ç”¨ä½ çš„ã€‚

æäº¤å¹¶å°†æ–‡ä»¶æ¨é€åˆ°`master`åˆ†æ”¯ï¼Œå¹¶åœ¨`Actions`é€‰é¡¹å¡ä¸Šçœ‹åˆ°è¿™ä¸ªè„šæœ¬æ­£åœ¨è¿è¡Œã€‚

* * *

## æµ‹è¯•ç”¨ä¾‹

å¦‚æœä½ æƒ³çœ‹åˆ°æ‰€æœ‰è¿™äº›åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ä¸€èµ·å·¥ä½œï¼Œçœ‹çœ‹è¿™ä¸ª GitHub repo [Kata: TDD é˜¿æ‹‰ä¼¯æ•°å­—åˆ°ç½—é©¬æ•°å­—çš„ C#](https://github.com/equiman/tdd_roman) ã€‚

* * *

**éƒ½æ˜¯ä¹¡äº²ä»¬ï¼**
**å¿«ä¹ç¼–ç ** ğŸ––

[![beer](../Images/192892baef71a32ea4a5e98a4927b05e.png)T2ã€‘](https://github.com/sponsors/deinsoftware)