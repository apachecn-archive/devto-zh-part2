# ç”¨ Docker Compose è®¾ç½® Express å’Œ Redis

> åŸæ–‡:[https://dev . to/Hugo _ _ df/setting-up-express-and-redis-with-docker-compose-AAA](https://dev.to/hugo__df/setting-up-express-and-redis-with-docker-compose-aaa)

Redis å’Œ Express æ˜¯ä¸ºä»–ä»¬çš„é—®é¢˜åŸŸæä¾›ä¸€ç§ç®€å•è€Œæ¸…æ™°çš„æ–¹æ³•çš„å·¥å…·ã€‚

å¯åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ° rest:https://github . com/hugodf/express-redis åœé ç«™ã€‚

[Redis](https://redis.io/) æ˜¯â€œä¸€ä¸ªå¼€æºçš„ã€å†…å­˜ä¸­çš„æ•°æ®ç»“æ„å­˜å‚¨ï¼Œç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä»£ç†â€ã€‚å®ƒå°±åƒæ•°æ®åº“ä¸€æ ·ç®€å•ï¼Œå®ƒä»¥å…¶ä½œä¸ºé”®å€¼å­˜å‚¨çš„æ€§èƒ½å’Œç®€å•æ€§è€Œé—»åã€‚å®ƒå…·æœ‰å¾ˆå¤§çš„çµæ´»æ€§ï¼Œè¿˜å¯ä»¥ç”¨ä½œæ¶ˆæ¯é˜Ÿåˆ—ã€å¾ªç¯ç¼“å†²åŒº(ä»¥åŠå¼€å‘äººå‘˜é™¤äº†å…³ç³»æ•°æ®åº“ä¹‹å¤–å¯ä»¥æƒ³åˆ°çš„ä»»ä½•ä¸œè¥¿)ã€‚

Express æ˜¯ä¸€ä¸ªâ€œå¿«é€Ÿçš„ã€éä¸ªæ€§åŒ–çš„ã€æç®€çš„ Node.js ç½‘ç»œæ¡†æ¶â€ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒæ˜¯èŠ‚ç‚¹æœåŠ¡å™¨çš„åŒ…è£…å™¨ï¼Œæä¾›äº†ä¸€ç§ç¼–å†™æ‰€è°“çš„â€œä¸­é—´ä»¶â€çš„æ–¹å¼ï¼Œä»¥è·¨ HTTP ç«¯ç‚¹å…±äº«å’Œç»„åˆåŠŸèƒ½ï¼Œå¹¶å®šä¹‰æ‰€è¿°ç«¯ç‚¹ã€‚

è®© Redis å’Œ Express ä¸€èµ·å·¥ä½œæ˜¯å¾®ä¸è¶³é“çš„ã€‚è®© Redis å’Œ Express ä»¥ä¸€ç§ç®€å•çš„ã€é¢å‘æœªæ¥çš„ã€å¯è·¨æœ¬åœ°å’Œéƒ¨ç½²ç¯å¢ƒå¤åˆ¶çš„æ–¹å¼ååŒå·¥ä½œï¼Œè¦ç¨å¾®å›°éš¾ä¸€äº›ã€‚è¿™å°±æ˜¯ Docker å’Œ Docker Compose çš„ç”¨æ­¦ä¹‹åœ°ã€‚

Docker æ˜¯ä¸€ä¸ªå®¹å™¨åŒ–ç³»ç»Ÿï¼ŒDocker Compose æ˜¯ä¸€ç§å®šä¹‰å¤šä¸ª Docker å®¹å™¨å¦‚ä½•äº¤äº’çš„æ–¹æ³•ã€‚åœ¨ Node web åº”ç”¨ç¨‹åºå¼€å‘çš„ä¸Šä¸‹æ–‡ä¸­ï¼ŒDocker å€¾å‘äºç”¨æ¥å®šä¹‰ä¸€ä¸ªå…·æœ‰æ‰€éœ€ç³»ç»Ÿçº§ä¾èµ–å…³ç³»çš„å®¹å™¨(ä¾‹å¦‚ï¼ŒèŠ‚ç‚¹ç‰ˆæœ¬ã€ä»»ä½•é¢å¤–çš„æ•°æ®åº“é©±åŠ¨ç¨‹åº)ã€‚Docker Compose å°†ç”¨äºå®šä¹‰èŠ‚ç‚¹åº”ç”¨ç¨‹åºä¹‹å¤–çš„ä¾èµ–å…³ç³»ï¼Œä¾‹å¦‚æ•°æ®åº“ã€‚

*   [ç¼©å†™å¿«é€’ğŸš…](https://codewithhugo.com/setting-up-express-and-redis-with-docker-compose#initialising-express)
*   [Docker å†…éƒ¨çš„è¿è¡ŒèŠ‚ç‚¹ğŸŒŠ](https://codewithhugo.com/setting-up-express-and-redis-with-docker-compose#running-node-inside-of-docker)
*   [å¢åŠ æ­Œè¯](https://codewithhugo.com/setting-up-express-and-redis-with-docker-compose#adding-redis)
*   [åˆ›å»º blob å­˜å‚¨ğŸ“’](https://codewithhugo.com/setting-up-express-and-redis-with-docker-compose/#creating-a-blob-store)

[è®¢é˜…](https://buttondown.email/hugo)åœ¨ä½ çš„æ”¶ä»¶ç®±é‡Œè·å¾—æœ€æ–°çš„å¸–å­(æ¯”ä»»ä½•äººéƒ½è¦æ—©)ã€‚

# [](#initialising-express)åˆå§‹åŒ–å¿«é€’ğŸš…

é¦–å…ˆï¼Œæˆ‘ä»¬åº”è¯¥åˆ›å»ºä¸€ä¸ªæ–°ç›®å½•/åˆå§‹åŒ– npm:

```
mkdir express-redis
cd express-redis
npm init -y 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åæˆ‘ä»¬å¯ä»¥å®‰è£… Express:

```
npm i --save express 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¹¶åˆ›å»ºä¸€ä¸ªç±»ä¼¼å¦‚ä¸‹çš„`server.js`æ–‡ä»¶:

```
// server.js
const express = require('express');
const app = express();

app.get('/', (req, res) => {
    return res.send('Hello world');
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`Server listening on port ${PORT}`);
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯ä»¥ä½¿ç”¨
è¿è¡Œ

```
node server.js 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å¯ä»¥æ£€æŸ¥å®ƒæ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œ

```
curl http://localhost:3000/
Hello world 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

# Docker å†…éƒ¨è¿è¡ŒèŠ‚ç‚¹ğŸŒŠ

é¦–å…ˆï¼Œä½ éœ€è¦å®‰è£… [Docker ç¤¾åŒºç‰ˆ](https://www.docker.com/community-edition)([https://www.docker.com/community-edition](https://www.docker.com/community-edition))ã€‚
ç„¶åæˆ‘ä»¬å¯ä»¥åŠ ä¸€ä¸ª`Dockerfile`å’Œä¸€ä¸ª`docker-compose.yml` :

```
# Dockerfile
FROM node:9-alpine
# Or whatever Node version/image you want
WORKDIR '/var/www/app' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
# docker-compose.yml
app:
    build: ./
    volumes:
    - ./:/var/www/app
    ports:
    - 3000:3000
    environment:
    - NODE_ENV=development
    - PORT=3000
    command:
    sh -c 'npm i && node server.js' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œåœ¨ Docker/Docker Compose:
ä¸­è¿è¡Œåº”ç”¨ç¨‹åº

```
docker-compose up 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¹¶æ£€æŸ¥å®ƒæ˜¯å¦è¿˜èƒ½å·¥ä½œ

```
curl http://localhost:3000/
Hello world 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€äº›é¢å¤–çš„èƒŒæ™¯:

*   `Dockerfile`å®šä¹‰äº†åº”ç”¨ç¨‹åºå°†åœ¨å“ªä¸ªå®¹å™¨ä¸­è¿è¡Œ(è¿™é‡Œæ˜¯æ„å»ºåœ¨ alpine ä¹‹ä¸Šçš„ Node 9 å®¹å™¨)
*   `docker-compose.yml`:
    *   `build`è§£é‡Šäº†å“ªä¸ªæ˜ åƒåº”è¯¥è¢«`app`æœåŠ¡å®šä¹‰ä½¿ç”¨(åœ¨æœ¬ä¾‹ä¸­ï¼Œå®ƒæŒ‡å‘è¿è¡Œ`Dockerfile`å°†ä¼šåˆ›å»ºçš„å†…å®¹)
    *   `volumes`å®šä¹‰ä»€ä¹ˆåº”è¯¥æŒ‚è½½åœ¨å“ªé‡Œ(åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†æ•´ä¸ªç›®å½•æŒ‚è½½ä¸º`/var/www/app`
    *   `ports`å°†ä¸»æœºç³»ç»Ÿçš„ç«¯å£æ˜ å°„åˆ°å®¹å™¨å†…éƒ¨çš„ç«¯å£
    *   `environment`ä¸ºå®¹å™¨è®¾ç½®ç¯å¢ƒå˜é‡
    *   `command`å†³å®šäº†å®¹å™¨å¯åŠ¨æ—¶å°†è¿è¡Œä»€ä¹ˆï¼Œè¿™é‡Œå®ƒè¿è¡Œ`npm install`,åè·ŸæœåŠ¡å™¨å¯åŠ¨å‘½ä»¤

# [](#adding-redis)å¢åˆ å°è¯

è¦å°† Redis æ·»åŠ åˆ°æˆ‘ä»¬çš„ Express åº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨`redis`åŒ…:

```
npm install --save redis 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åæˆ‘ä»¬å¯èƒ½åº”è¯¥åŒ…è£…æ‰€æœ‰æˆ‘ä»¬æƒ³è¦ä½¿ç”¨çš„åŸºäºå›è°ƒçš„æ–¹æ³•(å‚è§ redis åŒ…çš„ api æ–‡æ¡£ï¼Œ[https://github.com/NodeRedis/node_redis#api](https://github.com/NodeRedis/node_redis#api))ã€‚
è®©æˆ‘ä»¬ä½¿ç”¨`redis-client.js`æ¨¡å—:
æ¥åšè¿™ä»¶äº‹

```
// redis-client.js
const redis = require('redis');
const {promisify} = require('util');
const client = redis.createClient(process.env.REDIS_URL);

module.exports = {
  ...client,
  getAsync: promisify(client.get).bind(client),
  setAsync: promisify(client.set).bind(client),
  keysAsync: promisify(client.keys).bind(client)
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ Docker Compose ä¸­è¿è¡Œ Redisï¼Œä½¿æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¯ä»¥è®¿é—®å®ƒ:

```
# docker-compose.yml
# Add this top-level entry
redis:
    image: redis
    container_name: cache
    expose:
    - 6379

app:
    # some definitions
    links:
    - redis
    environment:
    - REDIS_URL=redis://cache
    # rest of the environment definitions 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ç°åœ¨å¯ä»¥ä»åº”ç”¨ç¨‹åºå®¹å™¨:
è®¿é—® Redis å®¢æˆ·ç«¯

```
docker-compose run app node
> require('./redis-client') // doesn't crash 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

# [](#creating-a-blob-store)åˆ›å»º blob å­˜å‚¨ğŸ“’

æˆ‘ä»¬ç°åœ¨å¯ä»¥åˆ›å»ºä¸€ä¸ª HTTP APIï¼Œå®ƒå°†å…è®¸æˆ‘ä»¬ä½¿ç”¨æŸ¥è¯¢å‚æ•°å­˜å‚¨æ•°æ®ï¼Œå¹¶ä½¿ç”¨ get è¯·æ±‚æ£€ç´¢å®ƒä»¬(è¿™ä¸€ç‚¹ä¹Ÿä¸ RESTfulï¼Œä½†æ˜¯å¾ˆå¥½ğŸ™‚ ).

```
// server.js
// imports and app definition

const redisClient = require('./redis-client');
app.get('/store/:key', async (req, res) => {
    const { key } = req.params;
    const value = req.query;
    await redisClient.setAsync(key, JSON.stringify(value));
    return res.send('Success');
});
app.get('/:key', async (req, res) => {
    const { key } = req.params;
    const rawData = await redisClient.getAsync(key);
    return res.json(JSON.parse(rawData));
});

// code that starts the app... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœä½ å¯¹ä»¥ä¸Šä»£ç æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·å‘Šè¯‰æˆ‘ [@hugo__df](https://twitter.com/hugo__df) ã€‚å®ƒä½¿ç”¨äº†ä¸€äº›æ›´é«˜çº§çš„ç‰¹æ€§ï¼Œæ¯”å¦‚ async/await å’Œ destructuringï¼Œä»¥åŠ Express ç‰¹æ€§æ¥è·å–æŸ¥è¯¢å’Œè·¯å¾„å‚æ•°(å‚è§ https://expressjs.com/en/api.html#req.queryã€[https://expressjs.com/en/api.html#req.params](https://expressjs.com/en/api.html#req.params))ã€‚

è®©åº”ç”¨ç¨‹åºå†æ¬¡è¿è¡Œ:`docker-compose up`

1.  å­˜å‚¨ä¸€äº›æ•°æ®

```
curl http://localhost:3000/store/my-key\?some\=value\&some-other\=other-value
Success 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

1.  æ£€ç´¢æ•°æ®:

```
curl http://localhost:3000/my-key
{
    "some": "value",
    "some-other": "other-value"
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> æ›´é«˜çº§çš„ Express ç”¨æˆ·å’Œ API è®¾è®¡å¤§å¸ˆè¯·æ³¨æ„ã€‚
> æˆ‘ä½¿ç”¨è€å¼çš„åŸºäºæŸ¥è¯¢å‚æ•°çš„ç³»ç»Ÿçš„åŸå› æ˜¯ä¸ºäº†é¿å…åœ¨ POST è¯·æ±‚ä¸­ä½¿ç”¨`body-parser`çš„æ ·æ¿æ–‡ä»¶

å®Œæ•´å‚¨å­˜åº“å¯ç”¨äº:https://github . com/hugodf/express-redis åœé ç‚¹

[è®¢é˜…](https://buttondown.email/hugo)åœ¨ä½ çš„æ”¶ä»¶ç®±é‡Œè·å¾—æœ€æ–°çš„å¸–å­(æ¯”ä»»ä½•äººéƒ½è¦æ—©)ã€‚
æœ¬Â·åº“ä¼¦æ ¼éŸ¦å°”åœ¨ [Unsplash](https://unsplash.com/search/photos/boats?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) æ‹æ‘„çš„å°é¢ç…§ç‰‡