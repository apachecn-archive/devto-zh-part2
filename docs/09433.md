# 我从红宝石到水晶的旅程

> 原文:[https://dev . to/jwoertink/my-journey-in-to-crystal-from-ruby-3bmm](https://dev.to/jwoertink/my-journey-in-to-crystal-from-ruby-3bmm)

我从 2006 年就开始使用 Ruby 和 Rails，那时候还是旧的 Rails 1.1.6 版本。我看到它经历了许多不同的迭代，每一步都很棒。回到 2016 年，我遇到了[水晶郎](https://crystal-lang.org/)。这看起来是开始学习编译语言如何工作的一个非常好的方法，所以我想我应该试一试！

一晃几年过去了，现在我实际上正在开发一个应用程序，它将使用 Crystal 投入生产。一些框架和 ORM 需要一段时间才能足够成熟，但是现在已经有一些很棒的可以使用了！我选定的那个人(我指的是“我们这个团队”)是幸运的。

我只想谈谈我从 Ruby 和 Rails 到使用 Crystal 和 Lucky 的旅程

## [](#the-pain-of-ruby)红宝石的痛苦

我在工作中使用的应用程序实际上是从 PHP 迁移到 Rails，然后通过 Rails 2 -> 5+升级的旧应用程序。所以这些年来，代码库经历了大量不同的迭代。数据库模式也经历了从现有字段到不再需要字段的变化。最重要的是，维护这些应用的团队在过去几年里发生了很大的变化。你可以看到“聪明”代码的残余，或者“嗯，随便什么”代码，当然还有“天哪，应用程序坏了，补丁补丁补丁！”代码。

ruby 的美妙之处在于，你可以写一些快速更新，事情会变得很棒。有大量的工具使用起来很有趣，并且不需要数学博士学位就可以设置。我真的很喜欢这样的时刻，当我写一些代码的时候，我不知道它是否会工作，但是看起来它应该工作，而且它工作了！

我承认，我确实有一个软件工程学位，但我真的不认为自己是一个了不起的开发人员。我只是不像我的很多同事那样思考问题。我编写我的测试，并确保我有一个好的开发人员应该有的代码覆盖率，但是我经常听到“你为什么不像这样做呢？”请看一个例子，与我的 20 行相比，只有 2 行。我对自己说“哦，对了，我忘了你可以这么做……”。在大多数情况下，这是好的。我们的应用程序工作，他们赚钱，用户大多很高兴。

问题是当我开始看到类似`Undefined method xxx for NilClass`的错误时。这是我们很常见的错误，因为我们的数据不可信。我最近开始在我们的代码库中添加像`thing&.do_stuff`这样的东西。我们也从我们的 API 中使用了很多散列，所以另一个到处都是的东西看起来像`Hash(thing.dig(:a, :b, :c))[:d]`或`Array(thing).each`。基本上类型转换只是为了避免所有的零错误。[滚动条](https://rollbar.com/blog/top-10-ruby-on-rails-errors/)甚至贴出了这篇关于常见错误的博文。也许你已经看过一些了？

现在，这些虫子是节目的终结者吗？不。你用任何语言写都会有问题，而且这些问题只会随着你写代码的方式而增加。我有其他 rails 应用没有这些相同的问题。但是让我们来分解一个开启水晶之旅的清单。

1.  大量的零错误
2.  10 秒以上的加载时间
3.  使用 Varnish 的大规模缓存设置
4.  清漆真的是太过时了，而且不容易更新
5.  意外清除了应用缓存，并在重新启动时使整个应用瘫痪了 2 小时
6.  错别字！我从来没有第一次拼对过`initialize`。即使那次我也试了两次。
7.  我们推送破坏其中一个应用程序的代码的次数。
8.  运行规格几乎需要一分钟
9.  聪明的代码兔子洞找到一个错误实际上是生活在哪里。
10.  等待 nokogiri 建立，这样我就可以确保应用程序仍然运行，这样我就可以回家了。
11.  激活了错误版本的 rake。
12.  循环依赖错误。(这个我还是不太懂)。

## [](#here-comes-crystal)水晶来了

我知道通过使用编译语言，我们将获得速度。我们已经看过几个了。铁锈、围棋和长生不老药摆在桌子上。我们的团队“技术上”有 4 个人，但是只有 3 个人真正写代码。我们中有两个人熟悉长生不老药，并且喜欢它。然而，我们担心的是，一旦一个应用程序投入生产，我们将没有任何线索来处理扩展、错误等问题...如果我们尝试的话，我们需要从小事开始。另外两个对围棋很熟悉，并且有一些不错的经验。这意味着如果我们走那条路，我将不得不赶上。对于 Rust，我们三个都不熟悉，所以可能不是一个好的选择。

几年前当我看到 Crystal 时，我喜欢它如此接近 Ruby 语法。这将让我们所有人在学习曲线上有一个巨大的提升。我们决定用它做一些小的宠物项目，我们很快就喜欢上了写它。甚至在我们启动应用程序之前，就能看到那些针对 NilClass 错误的未定义方法，这种感觉太棒了。因此，在这一点上，我们得到了速度和类型检查。仅仅通过使用 Crystal，我们在 Ruby 上遇到的一半问题都解决了。

1.  编译时捕获的错误为零
2.  应用程序加载时间从 10 秒以上缩短到 1.5 秒
3.  不需要缓存(目前还不需要)。这也节省了一些钱
4.  不需要清漆(见 3)
5.  没有缓存清除要做(还没有)
6.  错别字是在编译时被发现的，所以我从不犯错别字
7.  我们仍然推出一些破坏应用程序的代码，但这还不是完全的“生产”，随着我们制定新的流程，这种情况越来越少。
8.  运行规格几乎需要一秒钟
9.  仍然有一些带有宏的兔子洞有点烦人
10.  编译需要一些时间，所以部署也需要同样长的时间。
11.  尚未看到任何版本不匹配错误。
12.  还没有循环依赖错误。

## [](#using-lucky)利用幸运

既然我们决定使用 Lucky，那么它的目标之一就是在产品化之前捕捉错误。Lucky 也非常关注这个事实。这可能是世界上最令人沮丧的事情，试图运行一个单一的规格，并不断得到`no method matches with type String, overloads are....`，或得到`undefined method for compile time String | Nil`。在第 20 个错误之后，你只想翻转你的桌子，去做玉米饼谋生。

但是你最终明白了。您的 100 个测试的 spec 套件在 10ms 内运行，应用程序编译并启动。然后神圣的狗屎！这东西很结实。就是这一刻，你觉得这东西的骄傲无处可去。这就像挂一个架子，你的螺栓直接插在立柱上。你可以在这个东西上做引体向上，它不会动。有了轨道，它就像一对小螺丝钉。只要不被滥用，它还能挺得住。不幸的是，你不能告诉你的用户不要滥用你的网站。他们会是混蛋。

除了速度和类型安全之外，能够为 Lucky 这样的不同碎片做出贡献并真正发挥作用也很不错。作为一名开发人员，使用 Crystal 给了我一种新的成就感。不幸的是，这一边也不全是阳光和彩虹。

1.  Crystal 还不是 1.0，所以几乎每次更新都会破坏你的应用。
2.  破碎的碎片意味着大量的分叉和 PRs，或者在碎片维护者更新它的时候需要大量的耐心。
3.  丢失的碎片...我们在 rails 中使用了太多我们认为理所当然的东西，这些东西并不存在，或者在 crystal 中已经可以生产了
4.  重新学习东西。这是一种新的语言和新的环境，所以需要时间。
5.  兼容性(参见 2)。您想要使用的碎片可能在 Linux 的一些随机发行版上工作得很好，但是在 mac 上就不行了，因为维护者不使用 mac。
6.  理解错误。我见过这种索引越界错误，其中堆栈跟踪用`??`代替行号。这是其中之一，只是站起来，休息一会儿。
7.  医生，或者缺乏医生。事实上，这已经开始变得更好了，但是再次，只是需要时间，因为事情仍然是新的。

## [](#conclusion)结论

总的来说，我对 Crystal 很满意，我对我们的团队走上这条道路感到非常兴奋。让事情运转起来需要一些时间，但从长远来看，我觉得这将是一个伟大的决定。在我的下一篇帖子中，我想谈谈 LuckyRecord 与 ActiveRecord 相比的样子。