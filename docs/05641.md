# C#æ³›å‹å’Œå§”æ‰˜:ä¸€ä¸ªç®€å•ä½†çœŸå®çš„ä¾‹å­

> åŸæ–‡:[https://dev . to/stevebrownlee/c-generics-and-delegates-a-simple-but-real-example-1 hoo](https://dev.to/stevebrownlee/c-generics-and-delegates-a-simple-but-real-example-1hoo)

*æœ€åˆå‘è¡¨äº[å²è’‚å¤«Â·å¸ƒæœ—åˆ©](https://stevebrownlee.com/generics-delegates-simple-real-example/)T3ã€‘*

* * *

å¦‚æœä½ æœç´¢å…³äº C#æ³›å‹è¯­è¨€ç‰¹æ€§çš„ä¿¡æ¯ï¼Œä½ ä¼šä¸€éåˆä¸€éåœ°çœ‹åˆ°åŒæ ·çš„å…³äºåˆ¶ä½œè‡ªå·±çš„`RedundantList<T>` ( *)çš„æŠ½è±¡ä»£ç ä¾‹å­ï¼Œä½†ä¸è¦è¿™æ ·åšï¼Œè¿™åªæ˜¯æˆ‘ä»¬çš„ä¾‹å­*ã€‚å¾ˆéš¾æ‰¾åˆ°æœ‰äººå±•ç¤ºä»–ä»¬å¦‚ä½•å®é™…ä½¿ç”¨**æ¥ä½¿ä»–ä»¬çš„ä»£ç æ›´åŠ å¯é‡ç”¨çš„å†…å®¹ã€‚**

 **å—¯ï¼Œæœ¬å‘¨åœ¨ä¸æˆ‘çš„å­¦ç”Ÿåœ¨[çº³ä»€ç»´å°”è½¯ä»¶å­¦æ ¡](http://nashvillesoftwareschool.com)ç¬¬ 26 å¤©çš„ä¸€æ¬¡è®¨è®ºä¸­ï¼Œå‡ºç°äº†å…³äº[ä»¿åˆ¶è¯](https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/generics/)çš„è¯é¢˜ï¼Œæ‰€ä»¥æˆ‘å»çœ‹äº†çœ‹ï¼Œæ„è¯†åˆ°å¤§å¤šæ•°å†…å®¹å¯¹å­¦ç”Ÿæ¥è¯´æ˜¯ä¸å¯ç”¨çš„ã€‚å½“ç„¶ï¼Œæ³›å‹çš„ç›®çš„å’Œç”¨æ³•å¾ˆå¤§ç¨‹åº¦ä¸Šè¶…å‡ºäº†ä¸€ä¸ªæœ‰ 4 ä¸ªæœˆå¼€å‘ç»éªŒçš„å­¦ç”Ÿçš„ç†è§£èƒ½åŠ›ï¼Œä½†æ˜¯æˆ‘æƒ³ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­å‘ä»–ä»¬å±•ç¤º**ä¸ºä»€ä¹ˆ**ä½¿ç”¨å®ƒä»¬ã€‚

æˆ‘ä¸€ç›´åœ¨ä½¿ç”¨ä¸€ä¸ªç®€å•çš„ CLI åº”ç”¨ç¨‹åºæ¥æ•™ä»–ä»¬è¯­è¨€è¯­æ³•ã€LINQã€ç±»ã€OOP å’Œ SQL çš„åŸºç¡€çŸ¥è¯†ã€‚æˆ‘æ­£è¦é€šè¿‡ä½¿ç”¨ [Dapper](http://dapper-tutorial.net/) ORM æ¥æŸ¥è¯¢ä¸€ä¸ªå°å‹ SQLite æ•°æ®åº“ï¼Œä»è€Œå°†è¿™äº›ç‚¹è¿æ¥èµ·æ¥ã€‚

ä¸ºäº†åˆ›å»ºè¡¨ï¼Œå¹¶ç”¨åˆå§‹æ•°æ®æ’­ç§å®ƒä»¬ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥ä½¿ç”¨ SQLï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ª`DatabaseInterface.cs`æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«ä¸€ç³»åˆ—é™æ€æ–¹æ³•æ¥æ‰§è¡Œè¿™äº›ä»»åŠ¡ã€‚

> æ•°æ®/æ•°æ®åº“æ¥å£. cs

```
...

/*
    Purpose: Check the database to see if the `Exercise` table 
    has been defined. If not, create it and seed it.
*/
public static void CheckExerciseTable()
{
    SqliteConnection db = DatabaseInterface.Connection;

    try
    {
        // Select the ids from the table to see if it exists
        IEnumerable<Exercise> exercises = db.Query<Exercise>
            ("SELECT Id FROM Exercise");
    }
    catch (System.Exception ex)
    {
        /*
            If an exception was thrown with the text "no such table"
            then the table doesn't exist. Execute a CREATE TABLE
            statement to create it.
        */
        if (ex.Message.Contains("no such table"))
        {
            db.Execute(@"CREATE TABLE Exercise (
                `Id`    INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
                `Name`  TEXT NOT NULL,
                `Language` TEXT NOT NULL
            )");

            /*
                Seed the table with some initial entries
            */
            db.Execute(@"INSERT INTO Exercise
                VALUES (null, 'ChickenMonkey', 'JavaScript')");
            db.Execute(@"INSERT INTO Exercise
                VALUES (null, 'Overly Excited', 'JavaScript')");
            db.Execute(@"INSERT INTO Exercise
                VALUES (null, 'Boy Bands & Vegetables', 'JavaScript')");

        }
    }
}

... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘å¯¹æ•°æ®åº“ä¸­éœ€è¦çš„æ¯ä¸ªè¡¨éƒ½ç»§ç»­è¿™æ ·åšã€‚ä¾‹å¦‚ï¼Œæˆ‘ç„¶åæ£€æŸ¥`Instructors`è¡¨ã€‚

> Data/DatabaseInterface.cs

```
...

public static void CheckInstructorsTable()
{
    SqliteConnection db = DatabaseInterface.Connection;

    try
    {
        IEnumerable<Instructor> instructors = db.Query<Instructor>
            ("SELECT Id FROM Instructor");
    }
    catch (System.Exception ex)
    {
        if (ex.Message.Contains("no such table"))
        {
            db.Execute($@"CREATE TABLE Instructor (  `Id`          INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,  `FirstName`   TEXT NOT NULL,  `LastName`    TEXT NOT NULL,  `SlackHandle` TEXT NOT NULL,  `Specialty`   TEXT,  `CohortId`    INTEGER NOT NULL,  FOREIGN KEY(`CohortId`) REFERENCES `Cohort`(`Id`)  )");

            db.Execute($@"INSERT INTO Instructor  SELECT null,  'Steve',  'Brownlee',  '@coach',  'Dad jokes',  c.Id  FROM Cohort c WHERE c.Name = 'Evening Cohort 1'  ");

            db.Execute($@"INSERT INTO Instructor  SELECT null,  'Joe',  'Shepherd',  '@joes',  'Analogies',  c.Id  FROM Cohort c WHERE c.Name = 'Day Cohort 13'  ");

            db.Execute($@"INSERT INTO Instructor  SELECT null,  'Jisie',  'David',  '@jisie',  'Student success',  c.Id  FROM Cohort c WHERE c.Name = 'Day Cohort 21'  ");

            db.Execute($@"INSERT INTO Instructor  SELECT null,  'Emily',  'Lemmon',  '@emlem',  'Memes',  c.Id  FROM Cohort c WHERE c.Name = 'Day Cohort 21'  ");
        }
    }
}

... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘æ€»å…±åˆ›å»ºå’Œæ’­ç§äº†äº”ä¸ªè¡¨ã€‚

1.  æ•™å¸ˆ
2.  å­¦ç”Ÿ
3.  é”»ç‚¼
4.  æ”¯æŒè€…
5.  å­¦ç”Ÿç»ƒä¹ 

è¿™æ˜¯äº”ç§æ–¹æ³•ï¼Œéƒ½åšå®Œå…¨ç›¸åŒçš„äº‹æƒ…ï¼Œä½†åªæ˜¯é’ˆå¯¹ä¸åŒçš„èµ„æºã€‚ä¸ºäº†æé«˜ä»£ç çš„å¯é‡ç”¨æ€§ï¼Œæˆ‘ç»å†äº†ä¸€ä¸ªä¸‰æ­¥çš„è¿‡ç¨‹ã€‚

## [](#step-1-create-and-seed-static-methods)æ­¥éª¤ 1:åˆ›å»ºå’Œæ’­ç§é™æ€æ–¹æ³•

ç¬¬ä¸€æ­¥æ˜¯å°†åˆ›å»ºè¡¨å’Œæ’­ç§è¡¨çš„å‘½ä»¤è½¬ç§»åˆ°æ•°æ®åº“æ¨¡å‹çš„é™æ€æ–¹æ³•ä¸­ã€‚è¿™æœ‰åŠ©äºæˆ‘å®æ–½å•ä¸€è´£ä»»åŸåˆ™ã€‚å¦åˆ™ï¼Œ`DatabaseInterface`ç±»æœ‰æ— æ•°çš„ç†ç”±æ”¹å˜ã€‚

> /Models/Exercise.cs

```
using System.Collections.Generic;
using Dapper;
using Microsoft.Data.Sqlite;

namespace nss.Data.Models
{
    public class Exercise
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Language { get; set; }
        public List<Student> AssignedStudents { get; set; }

        public static void Create(SqliteConnection db)
        {
            db.Execute(@"CREATE TABLE Exercise (
                        `Id`       INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
                        `Name`     TEXT NOT NULL,
                        `Language` TEXT NOT NULL
                    )");
        }

        public static void Seed(SqliteConnection db)
        {
            db.Execute(@"INSERT INTO Exercise
                        VALUES (null, 'ChickenMonkey', 'JavaScript')");
            db.Execute(@"INSERT INTO Exercise
                        VALUES (null, 'Overly Excited', 'JavaScript')");
            db.Execute(@"INSERT INTO Exercise
                        VALUES (null, 'Boy Bands & Vegetables', 'JavaScript')");
        }

    }

} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä½¿å¾—`DatabaseInterface`ç±»ä¸­çš„`CheckExerciseTable()`æ–¹æ³•æ›´åŠ æ¸…æ™°ï¼Œåº”ç”¨ç¨‹åºæ›´åŠ æ¨¡å—åŒ–ã€‚

> Data/DatabaseInterface.cs

```
...

public static void CheckExerciseTable()
{
    SqliteConnection db = DatabaseInterface.Connection;

    try
    {
        // This part still tightly coupled to Exercise type  :(
        IEnumerable<Exercise> exercises = db.Query<Exercise>
            ("SELECT Id FROM Exercise");
    }
    catch (System.Exception ex)
    {
        if (ex.Message.Contains("no such table"))
        {
            // Et voilÃ ... Very cleaner! Much modular!  :)
            Exercise.Create(db);
            Exercise.Seed(db);
        }
    }
}

... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#step-2-generic-checktable-method)ç¬¬äºŒæ­¥:é€šç”¨æ£€æŸ¥è¡¨æ³•

æ¥ä¸‹æ¥ï¼Œæˆ‘å¼€å§‹åˆ›å»ºä¸€ä¸ªæ–¹æ³•æ¥æ£€æŸ¥ä»»ä½• è¡¨çš„ ***æ˜¯å¦å­˜åœ¨ï¼Œå¹¶åœ¨éœ€è¦æ—¶åˆ›å»º/æ’­ç§å®ƒã€‚*** 

```
public static void CheckTable<T>()
{
    SqliteConnection db = DatabaseInterface.Connection;

    try
    {
        // Coupling to Exercise type eliminated, but SQL still coupled  :(
        IEnumerable<T> exercises = db.Query<T>("SELECT Id FROM Exercise");
    }
    catch (System.Exception ex)
    {
        if (ex.Message.Contains("no such table"))
        {
            // Made it modular, but still coupled to Exercise type  :(
            Exercise.Create(db);
            Exercise.Seed(db);
        }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é€šè¿‡ä½¿ç”¨`T`é€šç”¨ç±»å‹ï¼Œæˆ‘ç°åœ¨å¯ä»¥è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¹¶ä¸ºç»“æœçš„`List`å’ŒçŸ­å°ç²¾æ‚çš„`Query`æ–¹æ³•ä½¿ç”¨æŒ‡å®šçš„ç±»å‹ã€‚

> Program.cs

```
DatabaseInterface.CheckTable<Exercise>(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘çš„ SQL è¯­å¥ä»ç„¶åœ¨æŸ¥è¯¢`Exercise`è¡¨ï¼Œæ‰€ä»¥æˆ‘éœ€è¦å°†è¡¨åä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œä»¥ä½¿è¿™ä¸ªæ–¹æ³•å¯é‡ç”¨ã€‚ç„¶åæˆ‘é‡æ„äº† SQL è¯­å¥ä»¥ä½¿ç”¨å‚æ•°ã€‚

```
// When invoked with the code above, T = Exercise
public static void CheckTable<T>(string table)
{
    SqliteConnection db = DatabaseInterface.Connection;

    try
    {
        // More generic! Coupling eliminated here!  :)
        IEnumerable<T> resources = db.Query<T>($"SELECT Id FROM {table}");
    }
    catch (System.Exception ex)
    {
        if (ex.Message.Contains("no such table"))
        {
            // Still tightly coupled to Exercise type  :(
            Exercise.Create(db);
            Exercise.Seed(db);
        }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#step-3-action-delegates-to-create-and-seed)ç¬¬ä¸‰æ­¥:åŠ¨ä½œå§”æ‰˜äººåˆ›å»ºå’Œæ’­ç§

æœ€åä¸€ä¸ªéœ€è¦é‡ç”¨çš„éƒ¨åˆ†æ˜¯åœ¨é€‚å½“çš„ç±»å‹ä¸Šè°ƒç”¨`Create()`å’Œ`Seed()`é™æ€æ–¹æ³•ã€‚ä¸å¹¸çš„æ˜¯ï¼Œåœ¨ C#ä¸­è°ƒç”¨æ³›å‹ç±»å‹çš„é™æ€æ–¹æ³•æ˜¯éæ³•çš„ã€‚

```
// T represents the type used (i.e. Student, Exercise, etc.)
T.Create(db);  // Illegal. Much sad.
T.Seed(db);    // Also illegal. Still frown. 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘å”¯ä¸€èƒ½æƒ³åˆ°çš„å…¶ä»–é€‰æ‹©å°±æ˜¯åšä¸€ä¸ª`delegate`ï¼›ç¡®åˆ‡åœ°è¯´ï¼Œæ˜¯ä¸€å[è¡ŒåŠ¨ä»£è¡¨](https://docs.microsoft.com/en-us/dotnet/api/system.action-1?view=netcore-2.1)ã€‚ä¸ºä»€ä¹ˆï¼Ÿ

> å°è£…å…·æœ‰å•ä¸ªå‚æ•°ä¸”ä¸è¿”å›å€¼çš„æ–¹æ³•ã€‚

è¿™å®Œç¾åœ°æè¿°äº†æˆ‘åœ¨æ•°æ®æ¨¡å‹ä¸Šçš„`Create()`å’Œ`Seed()`é™æ€æ–¹æ³•ã€‚

```
// Hey, look! This method has a single parameter and is void
public static void Create(SqliteConnection db)
{
    db.Execute(@"CREATE TABLE Exercise (
        `Id`       INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
        `Name`     TEXT NOT NULL,
        `Language` TEXT NOT NULL
    )");
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªæœºåˆ¶å…è®¸æˆ‘åšçš„æ˜¯å°†å¯¹æ­£ç¡®é™æ€æ–¹æ³•çš„å¼•ç”¨ä¼ é€’ç»™`CheckTable<T>`æ–¹æ³•ã€‚çœ‹ä¸€çœ‹ã€‚

```
public static void CheckTable<T>(
    string table,
    Action<SqliteConnection> create,  // <-- Delegate to the correct `Create()`
    Action<SqliteConnection> seed     // <-- Delegate to the correct `Seed()`
)
{
    SqliteConnection db = DatabaseInterface.Connection;

    try
    {
        IEnumerable<T> resources = db.Query<T>($"SELECT Id FROM {table}");
    }
    catch (System.Exception ex)
    {
        if (ex.Message.Contains("no such table"))
        {
            create(db);  // Invoke the Create() reference
            seed(db);    // Invoke the Seed() reference
        }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘å¯ä»¥ä½¿ç”¨`CheckTable<T>()`æ–¹æ³•æ¥éªŒè¯ã€åˆ›å»ºå’Œæ’­ç§**æˆ‘æƒ³è¦ä½¿ç”¨çš„ä»»ä½•**æ•°æ®åº“è¡¨ã€‚æˆ‘ä¼ å…¥ä»¥ä¸‹å‚æ•°ã€‚

1.  ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒåŒ…å«æˆ‘è¦åœ¨ SQL ä¸­ä½¿ç”¨çš„è¡¨çš„åç§°
2.  å¯¹ç›¸åº”ç±»ä¸Šé™æ€`Create()`æ–¹æ³•çš„å¼•ç”¨
3.  å¯¹ç›¸åº”ç±»ä¸Šé™æ€`Seed()`æ–¹æ³•çš„å¼•ç”¨

```
DatabaseInterface.CheckTable<Exercise>("Exercise", Exercise.Create, Exercise.Seed);
DatabaseInterface.CheckTable<Cohort>("Cohort", Cohort.Create, Cohort.Seed);
DatabaseInterface.CheckTable<Instructor>("Instructor", Instructor.Create, Instructor.Seed);
DatabaseInterface.CheckTable<Student>("Student", Student.Create, Student.Seed);
DatabaseInterface.CheckTable<StudentExercise>("StudentExercise", StudentExercise.Create, StudentExercise.Seed); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#simple-and-real)ç®€å•è€ŒçœŸå®

æ²¡æœ‰è®¨è®ºå‡ ä¹æ²¡æœ‰äººä¼šåœ¨æ—¥å¸¸å·¥ä½œä¸­ä½¿ç”¨çš„æ™¦æ¶©çš„æ•°æ®ç»“æ„ã€‚æ²¡æœ‰æŠ½è±¡çš„ç¤ºä¾‹ä»£ç ä¸èƒ½å‘å¼€å‘äººå‘˜ä¼ è¾¾ä»»ä½•çœŸæ­£çš„ä»·å€¼ã€‚è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„çœŸå®åº”ç”¨ç¨‹åºçš„ä¾‹å­ï¼Œç”¨äºåŸ¹è®­åˆçº§å¼€å‘äººå‘˜ä½¿ç”¨ C#å’Œ SQLï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨æ³›å‹ä½¿ä»£ç å¯é‡ç”¨ï¼Œå¹¶ä¸”æ›´å®¹æ˜“é˜…è¯»/ç»´æŠ¤ã€‚

ğŸ´Github ä¸Šçš„ fork:[https://Github . com/NSS-day-cohort-26/student-exercises/tree/dapper-SQL-advanced](https://github.com/nss-day-cohort-26/student-exercises/tree/dapper-sql-advanced)**