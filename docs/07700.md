# LDAP 的痛苦

> 原文:[https://dev.to/ferricoxide/the-pain-of-ldap-41cb](https://dev.to/ferricoxide/the-pain-of-ldap-41cb)

最近，我们一直在推动在我们提供的所有面向互联网的服务上启用 2FA。一个经理问:“我们要担心多少用户？”我们有三种基本类型的用户:

*   那些只能访问远程桌面的人
*   那些只能访问各种应用程序的人
*   能够访问远程桌面和各种应用程序的人

所有此类访问都是无特权的。所有访问都通过 Active Directory 组成员身份进行管理。

*   我们的 RDSH 用户属于“远程桌面”组。
*   我们的应用程序用户属于不同的群体。幸运的是，我们很久以前就为我们的组实现了标准命名。一个应用程序类的所有组名都以“`T_`”开头；其他应用程序类的所有组名都以“`E_`开头

幸运的是，上述内容意味着我可以通过 LDAP 查询的方式为经理获得答案。用户在 Active Directory 中的成员身份是通过用户对象的 meberOf 属性传递的。这意味着我需要考虑的基本查询对象是:

*   *RDSH 用户:*在 LDAP 语言中，这相当于`CN=<RDSH_GROUP>,cn=users,dc=<F>,dc=<Q>,dc=<D>,dc=<N>`
*   *“T _”应用程序组:*在 LDAP 语言中，这相当于`CN=T_*`
*   *“E _”应用程序组:*在 LDAP 语言中，这相当于`CN=E_*`

LDAP 查询通常对对象集进行操作。集合用括号表示。使用前面提到的组，我的每个组成员资格的单元素集将是:

*   `(memberof=CN=<RDSH_GROUP>,cn=users,dc=<F>,dc=<Q>,dc=<D>,dc=<N>)`
*   `(memberof=CN=T_*)`
*   `(memberof=CN=E_*)`

当你需要将这些组合成适当的查询时，事情变得非常糟糕。组合查询对象就是使用布尔的问题:

*   " & ":逻辑 AND 运算符
*   " | ":逻辑或运算符
*   "!":逻辑非运算符
*   如果你熟悉逻辑运算符，你会注意到没有内置的异或类型的运算符。

我之所以说事情很糟糕，是因为你在一个集合中应用了一个给定的运算符，而且语法有点不直观:

*   and 运算集合:使用语法`(&(SET1)(SET2)(...)(SET_N))`。基本上，这是说，“以及这个 AND 集合中的所有集合。“与”集合可以由 2+个集合组成，用于评估
*   ORing 集合:类似地，这使用语法`(|(SET1)(SET2)(...)(SET_N))`。基本上，这是说，“或者这个或集合中的所有下列集合。“或”集合可以由 2+个集合组成，用于评估
*   NOTin sets:类似地，这使用语法`(!(SET1)(SET2)(...)(SET_N))`。基本上，这是说，“或者这个非集合中的所有集合。一个非集合可以包含 2 个以上的集合进行评估

当一个逻辑运算需要两个或更多的子运算时，情况就变得非常糟糕了。例如:

*   当你想知道一个用户是否是一个组的成员，但是*不是另一个组的成员*时，你需要做如下事情:`(&(GROUP1)(!(GROUP2))`
*   类似地，当你想知道一个用户是否是一个组的成员，但是*不是*是另外两个组的成员，你可以做类似`(&(GROUP1)(!(&(GROUP2)(GROUP3))`的事情
*   类似地，当你想知道一个用户是否是一个组的成员，但是*不是*的成员*或者*是另外两个组的成员，你可以做类似`(&(GROUP1)(!(|(GROUP2)(GROUP3))`的事情

你可能知道，随着选择器数量的增加，丑陋也在增加。

无论如何，回到我最初的疑问:

*   获取所有拥有 RDSH 访问权限的人的列表，我的查询如下:`(memberof=CN=<RDSH_GROUP>,cn=users,dc=<F>,dc=<Q>,dc=<D>,dc=<N>)`
*   获取任一应用程序组的成员列表，我的查询如下:`(|(memberof=CN=T_*)(memberof=CN=T_*))`
*   获取具有 RDSH 访问权限并且是任何一个应用程序组成员的人员列表，我的查询如下:`(&(memberof=CN=<RDSH_GROUP>,cn=users,dc=<F>,dc=<Q>,dc=<D>,dc=<N>)(|(memberof=CN=T_*)(memberof=CN=T_*)))`
*   得到一个具有 RDSH 访问权限但不具有其他任何一个组的访问权限的人员列表，我的查询现在看起来像:`(&(memberof=CN=<RDSH_GROUP>,cn=users,dc=<F>,dc=<Q>,dc=<D>,dc=<N>)(!(|(memberof=CN=T_*)(memberof=CN=T_*))))`
*   相反，得到一个没有 RDSH 访问权限但可以访问其他任何一个组的人的列表，我的查询现在看起来像:`(&(!(memberof=CN=<RDSH_GROUP>,cn=users,dc=<F>,dc=<Q>,dc=<D>,dc=<N>))(|(memberof=CN=T_*)(memberof=CN=T_*)))`

抛开那些丑陋不谈，我能够让经理回答他的问题，而且能够很快地做到。这篇文章主要是因为他在我向他发送问题时问他“那些官样文章到底是什么意思”，我跑去给他答案。出于与我写这篇文章相同的原因，我已经把它作为主题的一部分发送出去了:这样，下次再次请求信息时，我就有了疑问(而不必再在我的脑海中重新思考)。