# ä½¿ç”¨æœ¨å¶å¸ˆå®ç°å‰ç«¯å¼€å‘è‡ªåŠ¨åŒ–ã€‚ç¬¬ä¸‰éƒ¨åˆ†

> åŸæ–‡:[https://dev . to/papaponmx/front-end-development-automation-with-puppet er-part-3-3pl 6](https://dev.to/papaponmx/front-end-development-automation-with-puppeteer-part-3-3pl6)

## [T1ã€‘ç®€ä»‹](#intro)

*   [è¿™ä¸ªç³»åˆ—çš„ç¬¬ä¸€éƒ¨åˆ†](https://dev.to/papaponmx/front-end-development-automation-with-puppeteer-part-1-2k9n)
*   [æœ¬ç³»åˆ—çš„ç¬¬äºŒéƒ¨åˆ†](https://dev.to/papaponmx/front-end-automation-with-puppeteer-part-2-2pmb)
*   [é“¾æ¥åˆ°å›è´­](https://github.com/papaponmx/visual-regresion-test)

è¿™ç¯‡æ–‡ç« é¢‡å…·è®½åˆºæ„å‘³ï¼Œå› ä¸ºåœ¨è¿™å‘¨çš„å·¥ä½œä¸­ï¼Œæˆ‘åœ¨äº§å“ä¸­åšäº†ä¸€äº›æ”¹å˜ï¼Œè€Œè¿™äº›æ”¹å˜æœ¬å¯ä»¥è¢«ä½ åœ¨è¿™ç¯‡æ–‡ç« ä¸­è¯»åˆ°çš„å†…å®¹æ‰€é˜»æ­¢ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½è®©ä½ ä»æˆ‘çš„é”™è¯¯ä¸­å¸å–æ•™è®­ã€‚

## [](#scenario-3-compare-a-snapshot-of-local-vs-test)åœºæ™¯ 3:æ¯”è¾ƒæœ¬åœ°ä¸æµ‹è¯•çš„å¿«ç…§ã€‚

ä½ æ­£åœ¨æ”¹å˜ä½ çš„åº”ç”¨çš„æ ¸å¿ƒï¼Œä¹Ÿè®¸æ˜¯ä¸€äº›åœ¨åç«¯ä½¿ç”¨çš„ç«¯ç‚¹ï¼Œä½†æ˜¯ä¸šåŠ¡é€»è¾‘å’Œæ ¸å¿ƒåŠŸèƒ½åº”è¯¥ä¿æŒä¸å˜ã€‚åº”ç”¨ç¨‹åºçš„æ¸²æŸ“å¿…é¡»ä¿æŒä¸å˜ã€‚ç°åœ¨æˆ‘ä»¬å°†åˆ¶ä½œä¸€ä¸ªè„šæœ¬æ¥æ¯”è¾ƒè¿™ä¸¤ç§ç¯å¢ƒï¼Œå¹¶ä¿è¯å®ƒä¼šå‘ç”Ÿã€‚

## [](#application-outline)åº”ç”¨æ¦‚è¦ã€‚

ä½œä¸ºæ ·æ¿æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†ä»åˆ›å»º React åº”ç”¨ç¨‹åºå’ŒåŒ…å¼€å§‹ï¼Œåªæ˜¯ä¸ºäº†åœ¨é¡µé¢ä¸Šå‘ˆç°ä¸€äº›å†…å®¹ï¼Œåªæœ‰èµ·å§‹é¡µé¢å°±è¶³å¤Ÿäº†ã€‚

```
app
â”œâ”€â”€ src
â”‚   â””â”€â”€ App.js         # The single component we'll render.
â”œâ”€â”€ scripts
    â””â”€â”€ visual-regresion-test
        â”œâ”€â”€|actions    # All the DOM traversing functions.
        |  â””â”€â”€getPageScreenshot.js
        |  â””â”€â”€generateDateString.js
        |  â””â”€â”€compareScreenshots.js
        â”œâ”€â”€ images     # Here we will store our evidence.
        â”œâ”€â”€ index.js  # The main script were we will run our tests.   
        â”œâ”€â”€ config.json # For the url, viewport sizes, etc. 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#project-setup)é¡¹ç›®è®¾ç½®ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ [`parcel-react-app`](https://github.com/miljan-fsd/parcel-react-app) æ¥æ­å»ºæˆ‘ä»¬çš„é¡¹ç›®ã€‚

1.  å®‰è£… parcel-react-app
    T0ã€‘

2.  å®‰è£…ä¾èµ–é¡¹
    `yarn add puppeteer chalk signale pixelmatch pngjs`

æˆ‘ä»¬ä½¿ç”¨`chalk`å’Œ`signale`æ˜¯ä¸ºäº†å¾—åˆ°ä¸€ä¸ªæ›´å¥½çš„`console.log`ã€‚å¦‚æœä½ éœ€è¦çš„è¯ï¼Œè¿™é‡Œè¿˜æœ‰è¿™äº›ç³»åˆ—ç¬¬ä¸€éƒ¨åˆ†çš„[é“¾æ¥ã€‚](https://dev.to/papaponmx/front-end-development-automation-with-puppeteer-part-1-2k9n)

æˆ‘ä»¬è¿˜æœ‰`pngjs`æ¥ç¼–ç /è§£ç æˆ‘ä»¬çš„å›¾åƒï¼Œè¿˜æœ‰`pixmatch`æ¥ä¸ºæˆ‘ä»¬æä¾›å›¾åƒæ¯”è¾ƒã€‚

1.  å°†æˆ‘ä»¬çš„æµ‹è¯•è„šæœ¬æ·»åŠ åˆ°`package.json`

```
// package.json
scripts: {
//...
    "vrt": "node --experimental-modules ./scripts/visual-regresion-tests/index.js"
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*æ³¨æ„*:æˆ‘ä»¬ä½¿ç”¨`--experimental-modules`æ˜¯ä¸ºäº†æ— éœ€é¢å¤–è®¾ç½®å³å¯ä½¿ç”¨ ESMğŸ¤“

ç„¶åæˆ‘ä»¬ä¼šæŠŠå®ƒéƒ¨ç½²åˆ° https://visual-regresion-testing.firebaseapp.com/çš„ç«åŠ›åŸºåœ°

## [](#writting-our-action-script)ä¹¦å†™æˆ‘ä»¬çš„è¡ŒåŠ¨è„šæœ¬

1.  å®ƒçœ‹èµ·æ¥ä¸æœ¬ç³»åˆ—çš„ç¬¬ä¸€éƒ¨åˆ†å’Œç¬¬äºŒéƒ¨åˆ†éå¸¸ç›¸ä¼¼ã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€äº›å‚æ•°å¹¶è·å–å±å¹•æˆªå›¾

```
// actions/getPageScreenshots.js
export const getPageScreenshot = async (url, env, viewportConfig) => {
  const { height, width } = viewportConfig;
  const dateString = generateDateString();
  const selector = 'h1' // This could be any valid CSS Selector

  await signale.success('Initializing browser')

  const browser = await puppeteer.launch()
  const page = await browser.newPage()

  await page.setViewport({ width, height })
  await signale.success('Opening browser...')
  await signale.success('Navigating to the site ');
  await page.goto(url);
  await page.waitForSelector(selector)
    .then(async () => {
      signale.success('Form was submitted successfully');
      await page.screenshot({ path: `./scripts/visual-regresion-tests/images/${env}_${dateString}.png` });
      browser.close();
    })
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“`getPageScreenshot`åœ¨ä¸¤ä¸ªç¯å¢ƒä¸­è¿è¡Œåï¼Œæˆ‘ä»¬å¿…é¡»å°†æ–‡ä»¶å‘½åä¸ºè¿™æ ·çš„åå­—:
`Production_7_21h30.png`
`Test_7_21h30.png`

## [](#comparing-both-images)æ¯”è¾ƒä¸¤å¹…å›¾åƒ

ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å°ºå¯¸å®Œå…¨ç›¸åŒçš„å›¾åƒï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨`config.json`ä¸Šå®šä¹‰å®ƒ

ä¸ºäº†æ¯”è¾ƒè¿™ä¸¤ä¸ªå›¾åƒï¼Œæˆ‘ä»¬å°†ä» ä¸­é€‰å–ç¤ºä¾‹ï¼Œå¹¶å°†ä»£ç æ”¹ä¸º ES6ã€‚

å¦‚æœä½ æƒ³çŸ¥é“å®ƒåœ¨å¼•æ“ç›–ä¸‹åšä»€ä¹ˆï¼Œè¿™é‡Œæœ‰è§£é‡Š:

1.  å°†ä¸¤å¹…ç›¸åŒå¤§å°çš„å›¾åƒä½œä¸ºè¾“å…¥ã€‚
2.  å°†å®ƒä»¬è§£ç å¹¶ä½œä¸ºæµè¿›è¡Œå¤„ç†ã€‚
3.  ä¸€æ—¦å®Œæˆï¼Œå®ƒå°†å¯¹å®ƒä»¬è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶åˆ›å»ºç¬¬ä¸‰ä¸ªæµï¼Œè¯¥æµè¢«è½¬æ¢ä¸ºå›¾åƒï¼Œä»¥ä¾¿æˆ‘ä»¬èƒ½å¤Ÿæ›´å¥½åœ°æ¬£èµå·®å¼‚ã€‚æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨æ¥è‡ªç¬¬ä¸‰ä¸ªæµçš„ä¿¡æ¯æ¥äº†è§£æœ‰å¤šå°‘åƒç´ æ˜¯ä¸åŒçš„ï¼Œå¹¶å¯¹å®ƒä»¬é‡‡å–è¡ŒåŠ¨ã€‚

```
//actions/compareScreenshots.js

const imageFromFile = filename =>
  new Promise(resolve => {
    const img = fs
      .createReadStream(filename)
      .pipe(new PNG())
      .on('parsed', () => {
        resolve(img.data)
      })
  })

const compareScreenShots = async (FILENAME_A, FILENAME_B, viewportConfig) => {
  const IMAGES_FOLDER_PATH = './scripts/visual-regresion-tests/images/'
  const { height, width } = viewportConfig

  const newLayout = await imageFromFile(IMAGES_FOLDER_PATH + FILENAME_A + '.png') // './automation/images/local_host_layout.png'
  const oldLayout = await imageFromFile(IMAGES_FOLDER_PATH + FILENAME_B + '.png') // './automation/images/local_host_layout.png'

  const diff = await new PNG(viewportConfig)
  const diffPixels = await pixelmatch(
    newLayout,
    oldLayout,
    diff.data,
    width,
    height,
    {
      threshold: 0
    }
  )

  if (diffPixels === 0) {
    console.log('Success! No difference in rendering'.green)
  } else {
    console.log(
      `Uh-oh! Ther are ${diffPixels} different pixels in new render!`.bgRed
    )
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#putting-it-all-together)æŠŠæ‰€æœ‰çš„ä¸œè¥¿æ”¾åœ¨ä¸€èµ·

è°¢è°¢ä½ åšæŒè¿™ä¹ˆä¹…ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦æŠŠæ‰€æœ‰ä¸œè¥¿æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç„¶åç®€å•åœ°è¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•ã€‚æˆ‘ä»¬å°†åœ¨`scripts/visual-regresion-tests/index.js`åšè¿™ä»¶äº‹ã€‚è¿™æ˜¯æˆ‘ä»¬åœ¨è¿è¡Œ`yarn vrt`æ—¶æŒ‡å‘çš„æ–‡ä»¶å¤¹ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸­çš„ä»£ç :

```
// scripts/visual-regresion-tests/index.js
const signale = require('signale')
const colors = require('colors')
const config = require('./config.json')
const { generateDateString }= require('./actions/generateDateString.js');
const { getPageScreenshot } = require('./actions/getPageScreenshot.js');
const { compareScreenShots } = require('./actions/compareScreenShots.js');

let testImage;
let productionImage;

const runLocalTest = async (device = 'default', config, dateString) => {
  const { env, viewport } = config
  // await signale.success(`Running production on ${device}`)
  await signale.success(
    `Running production test on ${device} on a ${
      config.browser.clientName
    } viewport`
  )
  await getPageScreenshot(env.local, 'Test', config.viewport[device], dateString)
  await signale.success('Files are now created')
}

const runProductionTest = async (device = 'default', config, dateString) => {
  const { env, viewport } = config
  // await signale.success(`Running production on ${device}`)
  await signale.success(
    `Running production test on ${device} on a ${
      config.browser.clientName
    } viewport`
  )
  await getPageScreenshot(env.stagging, 'Production', config.viewport[device], dateString)
  await signale.success('Files are now created')
}

const runItAll = async (config) => {
  const dateString = await generateDateString();
  await console.log(`Generating date for ${dateString}`.green);
  productionImage = await `Production${dateString}`;
  testImage = await `Test${dateString}`;

  await runLocalTest('mobile', config, dateString);
  await runProductionTest('mobile', config, dateString).then(() => {
  compareScreenShots(testImage, productionImage, config.viewport.default)
  });
}

runItAll(config)
  .catch(error => console.log('error'.red, error)); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬æ­£åœ¨åšçš„æ˜¯:

1.  é¦–å…ˆå£°æ˜æµ‹è¯•æ–‡ä»¶å’Œæœ¬åœ°æ–‡ä»¶çš„åç§°ã€‚æˆ‘ä»¬åœ¨æœ€å¤–é¢çš„èŒƒå›´ä¸­å£°æ˜å®ƒä»¬ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦è·å–å±å¹•æˆªå›¾çš„å‡½æ•°å’Œæ¯”è¾ƒä¸¤å¹…å›¾åƒçš„å‡½æ•°ä¹‹é—´çš„æ—¥æœŸä¸€è‡´ã€‚
2.  å£°æ˜`runProductionTest`å’Œ`runLocalTest`ã€‚å”¯ä¸€ä¸åŒçš„æ˜¯ç¯å¢ƒï¼Œä»–ä»¬åˆå§‹åŒ–`puppeteer`ï¼Œè½¬åˆ°ç›¸åº”çš„ url å¹¶ä¸ºæ¯ä¸ªç¯å¢ƒç”Ÿæˆä¸€ä¸ªæˆªå›¾ã€‚æ³¨æ„ï¼Œä¸¤ä¸ªå‡½æ•°éƒ½å°†`dateString`ä½œä¸ºå‚æ•°ï¼Œ*å¿…é¡»ä½¿ç”¨ç›¸åŒçš„è§†çª—*æ¥æ¯”è¾ƒä¸¤å¹…å›¾åƒã€‚
3.  æˆ‘ä»¬å®šä¹‰äº†`runItAll`å‡½æ•°ï¼Œå®ƒç”Ÿæˆä¸¤ç§ç¯å¢ƒéƒ½ä½¿ç”¨çš„ä¸»è¦é…ç½®ã€‚
4.  æˆ‘ä»¬ç”¨`config.json`ä¸­å®šä¹‰çš„é…ç½®æ‰§è¡Œ`runItAll(config)`ã€‚

æ­£å¦‚æˆ‘åœ¨è¿™ç¯‡æ–‡ç« çš„å¼€å¤´æ‰€è¯´çš„ï¼Œæˆ‘ä»¬çš„æƒ³æ³•æ˜¯èƒ½å¤Ÿç”¨ä¸€ä¸ªå‘½ä»¤æ¥æµ‹è¯•æˆ‘ä»¬çš„æ”¹å˜ä¸ä¼šç»™åº”ç”¨ç¨‹åºå¸¦æ¥ä»»ä½•è§†è§‰ä¸Šçš„æ”¹å˜ã€‚

ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿è¡Œ`yarn vrt`ï¼Œåº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„å†…å®¹:

[![Console screenshot](../Images/3f19a5e2346c64c4ab66faccaf5fd7a7.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--hgxTCb5r--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/j2m7rbb9xl6w99e6dzig.png)

### [](#conclusion)ç»“è®º

`puppeteer`å’Œ`Nodejs`å¾ˆæœ‰æ½œåŠ›ã€‚åœ¨æ¥ä¸‹æ¥çš„å‡ å‘¨é‡Œï¼Œæˆ‘ä¼šå‘ä¸€ç¯‡å…³äºå¦‚ä½•å°†è¿™äº›å·¥å…·ä¸ Github æŒ‚é’©å’Œ Conitinous é›†æˆç”¨äºå‰ç«¯çš„å¸–å­ã€‚

åœ¨è¿™ä¸ªé¡¹ç›®çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘è¯•ç€ä½¿ç”¨ ES æ¨¡å—ï¼Œä½†æ˜¯å®ƒä»¬åœ¨ä¸€äº›åº“ä¸Šä¸èƒ½å¾ˆå¥½åœ°è¿è¡Œï¼Œè‡³å°‘ç°åœ¨è¿˜ä¸èƒ½ã€‚æˆ‘æ­£åœ¨ç”¨æˆ‘çš„å°è±¡å†™ä¸€ç¯‡åšå®¢ã€‚

**æœ‰ç”¨çš„é“¾æ¥**

*   [è¿™ä¸ªç³»åˆ—çš„ç¬¬ä¸€éƒ¨åˆ†](https://dev.to/papaponmx/front-end-development-automation-with-puppeteer-part-1-2k9n)
*   [æœ¬ç³»åˆ—çš„ç¬¬äºŒéƒ¨åˆ†](https://dev.to/papaponmx/front-end-automation-with-puppeteer-part-2-2pmb)
*   [å›è´­ä¸æ‰€æœ‰ä»£ç ](https://github.com/papaponmx/visual-regresion-test/)

æ„Ÿè°¢é˜…è¯»ï¼Œä¼™è®¡ä»¬ã€‚

å¹²æ¯ã€‚