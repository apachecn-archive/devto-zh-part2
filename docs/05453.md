# ä½¿ç”¨ Vanna çš„ JavaScript ä¸­çš„ç‰¹æ€§æ ‡å¿—

> åŸæ–‡:[https://dev . to/Accel delivery/feature-flags-in-JavaScript-with vanna-20ng](https://dev.to/acceldelivery/feature-flags-in-javascript-withvanna-20ng)

## [](#i-see-a-red-button)æˆ‘çœ‹åˆ°ä¸€ä¸ªçº¢è‰²æŒ‰é’®

Vanna æ˜¯ä¸€ä¸ªå¼€æºç‰¹æ€§æ ‡è®°åº“ï¼Œåœ¨ [PBS](https://www.pbs.org) ç¼–å†™å’Œä½¿ç”¨ã€‚è®©æˆ‘ä»¬æ·±å…¥ç ”ç©¶ä¸€ä¸‹ [JavaScript å®¢æˆ·ç«¯](https://github.com/pbs/vanna-js-client)ã€‚æ¥è®¾ç½®æˆ‘ä»¬çš„æ•™ç¨‹ï¼Œä¸€ä¸ªæ•…äº‹ã€‚

Mick æ˜¯å‰ç«¯å¼€å‘äººå‘˜ã€‚è®¾è®¡å›¢é˜Ÿè¦æ±‚ Mick å°†ä¸€ä¸ªçº¢è‰²æŒ‰é’®çš„é¢œè‰²æ”¹ä¸ºé»‘è‰²ã€‚äº§å“ç®¡ç†è¿˜æ²¡æœ‰å‡†å¤‡å¥½å…¨åŠ›ä»¥èµ´ã€‚è®¾è®¡å’Œäº§å“ç®¡ç†éƒ¨é—¨è¯¢é—®æˆ‘ä»¬æŒ¥éœçš„å·¥ç¨‹å¸ˆæ˜¯å¦æœ‰åŠæ³•æ¥å¯¹å†²æˆ‘ä»¬çš„èµŒæ³¨ã€‚ä»–ä»¬æƒ³å‘ä¸€å°ç¾¤ç”¨æˆ·å±•ç¤ºå®éªŒæ€§çš„é»‘è‰²æŒ‰é’®ã€‚ç±³å…‹å¾®ç¬‘ç€æˆ´ä¸Šå¢¨é•œã€‚ğŸ˜

è¿™é‡Œæœ‰ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è¯´æ˜ Vanna æ˜¯å¦‚ä½•è®©ä½ åšåˆ°è¿™ä¸€ç‚¹çš„:

```
// ğŸ‘‡ An instance of vanna client - implementation to come
import features from "app/features"; 

const paintItBlack = features.variation("paint-it-black")

if (paintItBlack) {
  // Render experimental black button
} else {
  // Render red button
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ˜¯æœ€ç®€å•çš„ç‰¹å¾æ ‡è®°ã€‚é€šè¿‡ç‰¹å¾æ ‡è®°ï¼Œæ‚¨å¯ä»¥æ›´é¢‘ç¹åœ°å°†[åˆå¹¶åˆ°ä¸»å¹²](https://accelerate.delivery/trunk-development-feature-flags/)ä¸­ã€‚æ‚¨å¯ä»¥é€šè¿‡å°†æ–°çš„ã€æ˜“å˜çš„ä»£ç é™åˆ¶åœ¨ä¸€éƒ¨åˆ†ç”¨æˆ·ä¸­æ¥é™ä½é£é™©ã€‚Vanna è®©æ‚¨å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä»£ç ä¹‹å¤–æ§åˆ¶è¿™ä¸€ç‚¹ã€‚è¿™å¼€å¯äº†æŒç»­äº¤ä»˜çš„å¦ä¸€ä¸ªç‰¹ç‚¹ã€‚

è¿ç»­äº¤ä»˜çš„ä¸€ä¸ªç†æƒ³ç›®æ ‡æ˜¯ä»å‘å¸ƒä¸­åˆ†ç¦»éƒ¨ç½²ã€‚éƒ¨ç½²æ˜¯å°†ä»£ç ç§»åŠ¨åˆ°æœåŠ¡å™¨çš„è¡Œä¸ºã€‚å‘å¸ƒæ˜¯å‘ç”¨æˆ·æä¾›ä»£ç è·¯å¾„çš„è¡Œä¸ºã€‚ä½ å¯ä»¥åœ¨[è¿™ç¯‡é»‘å®¢åˆé—´æ–‡ç« ](https://hackernoon.com/decouple-deployment-from-release-b4b9182b6a46)ä¸­äº†è§£æ›´å¤šã€‚ä¸ºäº†ä»éƒ¨ç½²ä¸­åˆ†ç¦»å‘å¸ƒï¼ŒVanna ä» JSON å“åº”ä¸­æ¥æ”¶å…¶ç‰¹æ€§ã€‚è¿™å…è®¸æˆ‘ä»¬åœ¨ä¸è¿›è¡Œä»£ç éƒ¨ç½²çš„æƒ…å†µä¸‹æ›´æ–°ç‰¹æ€§å¯ç”¨æ€§ã€‚

## [](#creating-features)åˆ›å»ºç‰¹å¾

è®©æˆ‘ä»¬æ·±å…¥äº†è§£ç‰¹æ€§å“åº”çš„å½¢çŠ¶ã€‚å“åº”å¦‚ä¸‹:

```
{
  "features": {
    "paint-it-black": {
      "slug": "i-want-to-paint-it-black",
      "enabled": true,
      "targetSegment": ["alpha-tester"]
    }
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç‰¹å¾å“åº”åŒ…å«ä»»æ„æ•°é‡çš„ç‰¹å¾å¯¹è±¡ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹
ä¸­ï¼Œæœ‰ä¸€ä¸ªç‰¹å¾`"paint-it-black"`ã€‚è¯¥ç‰¹æ€§æœ‰ä¸‰ä¸ª
å±æ€§:

*   `"slug"` -ä¸ºç‰¹å¾å‘½åã€‚å½“åªç»™å‡ºç‰¹å¾å€¼æ—¶ï¼Œå®ƒå¯¹ç‰¹å¾è¯†åˆ«å¾ˆæœ‰ç”¨ã€‚åœ¨æˆ‘ä»¬çš„é«˜çº§ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥è¦†ç›–ç‰¹æ€§å¯ç”¨æ€§ã€‚
*   `"enabled"` -è¯¥é”®ä½¿è¯¥åŠŸèƒ½å¯ç”¨ã€‚æŠŠå®ƒæƒ³è±¡æˆä¸»æ–­è·¯å™¨ã€‚å¦‚æœè¿™æ˜¯`false`ï¼Œè¯¥åŠŸèƒ½å°†å¯¹æ‰€æœ‰äººå…³é—­ã€‚
*   `"targetSegment"` -åŠŸèƒ½ç›®æ ‡ç”¨æˆ·ã€‚æ‚¨å¯ä»¥ä½¿ç”¨æ­¤å¯†é’¥ä¸ºç”¨æˆ·ç»„æä¾›ä¸€é¡¹åŠŸèƒ½ã€‚æˆ‘ä»¬å°†çœ‹åˆ°å½“æˆ‘ä»¬å®ä¾‹åŒ–ä¸€ä¸ª`new VannaClient`æ—¶ï¼Œç”¨æˆ·å¦‚ä½•è¯†åˆ«ä¸ºä¸€ä¸ª`userSegment`ã€‚

ç›®å‰æ²¡æœ‰æ§åˆ¶å°ç•Œé¢æ¥åˆ›å»ºè¿™ä¸ª JSON å“åº”ã€‚ç°åœ¨æˆ‘ä»¬å°†æ‰‹åŠ¨ç¼–å†™ JSONï¼Œå¹¶é€šè¿‡ CDN è®¿é—®å®ƒã€‚åˆ›å»ºè¯¥å“åº”çš„ç®¡ç†ç•Œé¢å’Œ API æœåŠ¡æ˜¯æœªæ¥çš„å¢å¼ºåŠŸèƒ½ã€‚æ‰‹å·¥åˆ¶ä½œ JSON æ˜¯æˆ‘ä»¬åœ¨å¼€å‘ Vanna åº“çš„è¿‡ç¨‹ä¸­è¿ˆå‡ºçš„æœ€å°çš„ä¸€æ­¥ã€‚é‡‡ç”¨è¿™ç§ MVP æ–¹æ³•ä½¿æˆ‘ä»¬æ›´å®¹æ˜“è¯•éªŒå’Œè¿­ä»£ã€‚

## [](#using-vannajs)ä½¿ç”¨ vanna-js

åœ¨æˆ‘ä»¬çš„ç®€å•ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å‡è®¾å®¢æˆ·ç«¯åº“æ˜¯å¯ç”¨çš„ã€‚æˆ‘ä»¬æ¥å®æ–½å§ã€‚

æˆ‘ä»¬å°†åŸºäº cookie çš„å­˜åœ¨æ¥è®¾ç½®`userSegment`ã€‚å‚è§æˆ‘ä»¬ä¹‹å‰çš„[å¸–å­](https://accelerate.delivery/setting-cookie-flags-django/)å…³äºä¸ºåŠŸèƒ½æ ‡å¿—è®¾ç½® cookiesã€‚

```
// app/features.js
import { VannaClient } from "@pbs/vanna";
import Cookies from "js-cookie";

const isAlphaTester = Cookies.get("alpha-tester");

const client = new VannaClient({                                              
  uri: "https://cdn.com/features.json",                    
  userSegment:  isAlphaTester ? "alpha-tester" : "regular",           
  fallbacks: {                                                                
    "paint-it-black": false                                              
  }                                                                          
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“æ‚¨å®ä¾‹åŒ–ä¸€ä¸ª`new VannaClient`æ—¶ï¼Œæ‚¨è´Ÿè´£:

*   `uri` -è¿™æ˜¯ JSON ç‰¹æ€§æ§åˆ¶å“åº”çš„ä½ç½®ã€‚
*   `userSegment` -è¿™æ˜¯ç”¨æˆ·ç»„ã€‚Vanna åœ¨ä¸å·²å¯ç”¨çš„`"targetSegment"`åŒ¹é…æ—¶ä¸ºè¯¥ç”¨æˆ·å¯ç”¨è¯¥åŠŸèƒ½ã€‚
*   `fallbacks` -è®¾ç½®ç‰¹å¾æ ‡å¿—çš„é»˜è®¤è¡Œä¸ºã€‚æ³¨æ„ï¼Œå¿…é¡»ä¸º JSON å“åº”ä¸­çš„æ¯ä¸ªç‰¹æ€§è®¾ç½®å›é€€ã€‚

æˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨ Vanna æ¥å®Œæˆæˆ‘ä»¬çš„ä»»åŠ¡ã€‚åœ¨æˆ‘ä»¬æœ€åˆçš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå¸ƒå°”å€¼æ¥åˆ†å‰²æˆ‘ä»¬çš„ä»£ç è·¯å¾„ï¼Œç”¨:

```
const paintItBlack = features.variation("paint-it-black") 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

Vanna çš„`variation()`æ–¹æ³•è€ƒè™‘äº†ç‰¹å¾çš„`"targetSegment"`å’Œå®¢æˆ·ç«¯çš„`userSegment`ã€‚åœ¨ä¸¤è€…åŒ¹é…æ—¶ï¼Œè¯¥æ–¹æ³•è¿”å›`true`ã€‚

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œæ‚¨å¯ä»¥å°† Vanna ç”¨ä½œç‰¹å¾æ ‡è®°åº“ã€‚æ‚¨å¯ä»¥å°†éƒ¨ç½²ä¸å‘å¸ƒåˆ†ç¦»ã€‚æ‚¨å¯ä»¥ä»¥æ›´ä½çš„é£é™©æ›´å¿«åœ°äº¤ä»˜è½¯ä»¶ã€‚ä»¥è¿™ç§æ–¹å¼ä½¿ç”¨ Vanna è¿›è¡Œç‰¹æ€§æ ‡è®°éå¸¸é€‚åˆç®€å•çš„ç”¨ä¾‹ã€‚éœ€è¦æ›´å¤šå®šåˆ¶çš„é«˜çº§ç”¨æˆ·å¯ä»¥ä½¿ç”¨é«˜çº§é€‰é¡¹ã€‚

## [](#overriding-variations)å‹å€’å˜åŒ–

ç”¨ä¸€ä¸ª`userSegment`æ¥æ§åˆ¶ç‰¹æ€§ä¼¼ä¹æœ‰äº›ç²—ç³™ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦æ›´å¥½çš„æ§åˆ¶å‘¢ï¼Ÿå¦‚æœä¸ç®¡æˆ‘çš„`userSegment`å¦‚ä½•ï¼Œæˆ‘éƒ½æƒ³å¯ç”¨ä¸€ä¸ªç‰¹å®šçš„åŠŸèƒ½æ€ä¹ˆåŠï¼ŸVanna å®¢æˆ·ç«¯å…è®¸æ‚¨è¦†ç›–å˜ä½“èµ„æ ¼ã€‚æˆ‘ä»¬å¯ä»¥æ‰©å±•æˆ‘ä»¬ä¹‹å‰çš„[å¸–å­](https://accelerate.delivery/toggle-django-views-with-cookie-flags/)å…³äºåˆ‡æ¢ç‰¹å®šåŠŸèƒ½ cookies ä¸Šçš„æ ‡å¿—ã€‚æˆ‘ä»¬å°†å…è®¸ Vanna åŸºäºå‘½å cookies çš„å­˜åœ¨é€‰æ‹©åŠ å…¥ä¸€ä¸ªç‰¹æ€§ã€‚ä»¥ä¸‹çªå‡ºæ˜¾ç¤ºçš„æ¨¡å—æ˜¾ç¤ºäº†æˆ‘ä»¬å¦‚ä½•æ·»åŠ åˆ°æˆ‘ä»¬ä»¥å‰çš„ Vanna å®¢æˆ·ç«¯:

```
// app/features.js
import _ from "lodash";
import { VannaClient, getFeatureVariation } from "@pbs/vanna";
import Cookies from "js-cookie";

function getVariationOverride(featureSlug) {
  const featureKey = `feature:${featureSlug}`;
  const overrideValue = Cookies.get(featureKey);
  if (overrideValue) {
    return overrideValue === "true";
  }
  return undefined;
}

const isAlphaTester = Cookies.get("alpha-tester");

const client = new VannaClient({                                              
  uri: "https://cdn.com/features.json",                    
  userSegment:  isAlphaTester ? "alpha-tester" : "regular",           
  fallbacks: {                                                                
    "paint-it-black": false                                              
  },
  _overrides: {
    getFeatureVariation: (feature, { userSegment }) => {
      const variation = getFeatureVariation(feature, { userSegment });
      const overrideVariation = getVariationOverride(feature.slug);
      return _.isUndefined(overrideVariation) ? variation : overrideVariation;
    }
  }
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ‰äº†è¿™äº›é¢å¤–çš„ä»£ç ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©åŠ å…¥ä¸å±äºä»–ä»¬`userSegment`çš„åŠŸèƒ½ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰`"alpha-tester"` cookieï¼Œä½†æ˜¯æœ‰ä¸€ä¸ª`"feature:i-want-to-paint-it-black"` cookieï¼Œä»–ä»¬å°†ä¼šçœ‹åˆ°é»‘è‰²æŒ‰é’®ã€‚ç›¸åçš„ç”¨ä¾‹ä¹Ÿé€‚ç”¨ã€‚ä¸€ä¸ª`"alpha-tester"`å¯ä»¥é€šè¿‡å°†ä¸€ä¸ªå‘½åçš„ cookie è®¾ç½®ä¸º`"false"`æ¥é€€å‡ºä¸€ä¸ªç‰¹æ€§ã€‚è¿™ç§å˜åŒ–è¦†ç›–å…è®¸å¯¹åŠŸèƒ½å¯ç”¨æ€§è¿›è¡Œæ›´ç²¾ç»†çš„æ§åˆ¶ã€‚æˆ‘ä»¬ä½¿ç”¨ cookies æ¥è¦†ç›–è¿™ç§å˜åŒ–ï¼Œä½†æ˜¯æ‚¨å¯ä»¥ä½¿ç”¨æœ¬åœ°å­˜å‚¨æˆ– JavaScript ä¸­å¯ç”¨çš„ä»»ä½•ä¸œè¥¿ã€‚

vanna-js-client æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ã€‚è¯·æŸ¥çœ‹ç®€å•æ˜“è¯»çš„æºä»£ç ã€‚è¿™æ˜¯ä¸€ç§å‘ JS é¡¹ç›®æ·»åŠ ç‰¹æ€§æ ‡å¿—çš„è½»é‡çº§æ–¹æ³•ã€‚