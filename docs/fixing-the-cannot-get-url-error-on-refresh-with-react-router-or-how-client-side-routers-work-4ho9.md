# ä½¿ç”¨ React è·¯ç”±å™¨(æˆ–å®¢æˆ·ç«¯è·¯ç”±å™¨å¦‚ä½•å·¥ä½œ)åˆ·æ–°æ—¶ä¿®å¤â€œæ— æ³•è·å–/URLâ€é”™è¯¯

> åŸæ–‡ï¼š<https://dev.to/tylermcginnis/fixing-the-cannot-get-url-error-on-refresh-with-react-router-or-how-client-side-routers-work-4ho9>

å¼€å‘äººå‘˜åœ¨ä½¿ç”¨ React Router æ„å»º(ç‰¹åˆ«æ˜¯åˆ·æ–°)åº”ç”¨æ—¶é‡åˆ°çš„ä¸€ä¸ªéå¸¸å¸¸è§çš„é”™è¯¯æ˜¯â€œæ— æ³•è·å–/urlâ€ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹çœ‹ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™ç§é”™è¯¯ï¼Œä»¥åŠå¦‚ä½•å¤„ç†å®ƒã€‚

ä½ ä¸€ç›´åœ¨åŠªåŠ›å¼€å‘ä¸€æ¬¾ä½¿ç”¨ React è·¯ç”±å™¨çš„ React åº”ç”¨ã€‚äº‹æƒ…è¿›å±•å¾—å¾ˆé¡ºåˆ©ã€‚ä½ æå‰å®Œæˆäº†æœ€åæœŸé™ï¼Œä½ å¯èƒ½ä¼šæå‰ä¸‹ç­å»äº«å—å‘¨æœ«çš„é¢å¤–å‡ ä¸ªå°æ—¶ã€‚ä½ å†³å®šåœ¨èµ·é£å‰æœ€åæ£€æŸ¥ä¸€ä¸‹ä½ çš„åº”ç”¨ç¨‹åºã€‚"é‚£ä¸ªæŒ‰é’®åº”è¯¥æœ‰å¤šä¸€ç‚¹çš„è¾¹æ¡†åŠå¾„."ä½ è®¤ä¸ºã€‚ä½ æ”¹å˜å®ƒï¼Œç‚¹å‡»åˆ·æ–°ï¼Œä½ çš„åº”ç”¨ç¨‹åºå´©æºƒã€‚è¿™ä¸æ˜¯ä½ çš„å…¸å‹é”™è¯¯ã€‚å¦‚æœæ˜¯çš„è¯ï¼Œä½ å°±ä¸ä¼šä½å£°å‘èª“äº†ã€‚`Cannot read property 'state' of undefined`ï¼Œæ— å¿§æ— è™‘ã€‚ä½ å·²ç»çœ‹è¿‡å¾ˆå¤šæ¬¡äº†ã€‚è¿™ä¸ªä¸ä¸€æ ·ã€‚è¿™ç”šè‡³ä¸æ˜¯åº”ç”¨ç¨‹åºå´©æºƒï¼Œè€Œæ˜¯æ›´æ·±å±‚æ¬¡çš„é—®é¢˜ã€‚ä½ é€è¿‡æ‰‹æŒ‡ç›¯ç€ä½ çš„æ˜¾ç¤ºå™¨ã€‚å°±æ˜¯è¿™æ ·ã€‚ä½ åªèƒ½å¾—åˆ°è¿™äº›ã€‚ä½ çš„æ•´ä¸ªåº”ç”¨ç¨‹åºåœ¨åˆ·æ–°æ—¶ä¸­æ–­ï¼Œä½ å¾—åˆ°çš„åªæ˜¯ä¸‰ä¸ªå­—ã€‚

> æ— æ³•è·å–/ä»ªè¡¨æ¿

â€œå¯èƒ½æ˜¯çƒ­æ¨¡å—æ›´æ¢é—®é¢˜ã€‚åªæ˜¯ä¸€ä¸ªå¼‚å¸¸â€â€”â€”ä½ ä¹è§‚åœ°è¯´æœè‡ªå·±ã€‚ä¸ºäº†éªŒè¯ä½ çš„å‡è®¾ï¼Œä½ é‡å¯åº”ç”¨ç¨‹åºã€‚â€œä¸»é¡µçœ‹èµ·æ¥ä¸é”™ã€‚å¯¼èˆªå·¥ä½œæ­£å¸¸ã€‚è®©æˆ‘ä»¬å†æ¬¡å°è¯•åˆ·æ–°ã€‚â€

> æ— æ³•è·å–/è®¾ç½®

å¤±è´¥ã€‚æ²¡æœ‰å…¶ä»–è¯è¯­èƒ½å¦‚æ­¤å®Œç¾åœ°æè¿°å®ƒã€‚ä½ çš„é•¿å‘¨æœ«æ³¡æ±¤äº†ã€‚ç”šè‡³å¯èƒ½ä¼šèŠ±æ‰ä½ æ•´ä¸ªå‘¨æœ«çš„æ—¶é—´ï¼Œå› ä¸ºä½ æ ¹æœ¬ä¸çŸ¥é“ä¼šå‘ç”Ÿä»€ä¹ˆã€‚å¹¸è¿çš„æ˜¯ï¼Œä½ æ‰¾åˆ°äº†è¿™ç¯‡æ–‡ç« ã€‚Meta å¯¹å§ï¼Ÿ

é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç¡®å®šæ‚¨é‡åˆ°çš„é—®é¢˜ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦è®¨è®ºæµè§ˆå™¨å’Œå®¢æˆ·ç«¯è·¯ç”±å™¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

åœ¨è¿‡å»ï¼Œäº‹æƒ…å¾ˆç®€å•ã€‚å¦‚æœæ‚¨æƒ³è·å–`/dashboard`çš„å†…å®¹ï¼Œæµè§ˆå™¨ä¼šå‘æ‚¨çš„æœåŠ¡å™¨å‘å‡º get è¯·æ±‚ï¼Œé€šè¿‡æ£€æŸ¥ URL çš„è·¯å¾„éƒ¨åˆ†ï¼ŒæœåŠ¡å™¨ä¼šåˆ¤æ–­å‡ºç”¨æˆ·æ­£åœ¨è¯·æ±‚`/dashboard`é¡µé¢ã€‚ç„¶åï¼Œå®ƒä¼šæŠ“å–è¯¥é¡µé¢å¹¶ä½œä¸ºå“åº”å‘é€å›æµè§ˆå™¨ã€‚ç„¶åè¿™äº›è¢«ç§°ä¸ºå®¢æˆ·ç«¯è·¯ç”±å™¨(CSR)çš„ä¸œè¥¿å‡ºç°äº†ã€‚æœ‰äº† CSR(å°±åƒ React è·¯ç”±å™¨ä¸€æ ·)ï¼Œæ‚¨ä¸å†éœ€è¦æ¯æ¬¡æ›´æ”¹è·¯ç”±æ—¶éƒ½å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ã€‚ç›¸åï¼Œæ‚¨çš„ CSR åªæ˜¯åœ¨æœ¬åœ°æµè§ˆå™¨ä¸Šä¸ºæ‚¨å¤„ç†ã€‚å› æ­¤ï¼Œå½“æ‚¨è®¿é—®`/dashboard`æ—¶ï¼Œæ‚¨çš„ CSR ä¸æ˜¯å‘æ‚¨çš„æœåŠ¡å™¨å‘å‡º GET è¯·æ±‚ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ä¸ªåä¸º`history.pushState`çš„æµè§ˆå™¨ API æ¥æ‰‹åŠ¨æ›´æ”¹ URLï¼Œç„¶åå®ƒä¼šå‘ˆç°è¯¥ç‰¹å®šè·¯çº¿çš„è§†å›¾â€”â€”æ‰€æœ‰è¿™äº›éƒ½ä¸ä¼šå¯¼è‡´é¡µé¢åˆ·æ–°ã€‚

è®©æˆ‘ä»¬æ›´æ·±å…¥åœ°çœ‹çœ‹è¿™ä¸ªè¿‡ç¨‹ã€‚

ç”¨æˆ·ç¬¬ä¸€æ¬¡åŠ è½½ä½ çš„åº”ç”¨ç¨‹åº(ä¾‹å¦‚ï¼Œè®¿é—®ä½ çš„ç½‘ç«™)æ—¶ï¼Œä»–ä»¬æ²¡æœ‰åŠ è½½ä»»ä½• JavaScriptã€‚è¿™æ„å‘³ç€æ²¡æœ‰ Reactï¼Œä¹Ÿæ²¡æœ‰ React è·¯ç”±å™¨â€”â€”æ‰€ä»¥ç¬¬ä¸€ä¸ªè¯·æ±‚æ€»æ˜¯å‘ç»™ä½ çš„æœåŠ¡å™¨ã€‚ç„¶åï¼Œå‡è®¾æœ‰ä¸€ä¸ªæˆåŠŸçš„ GET è¯·æ±‚ï¼Œæ‰€æœ‰çš„ JavaScript åŠ è½½å’Œ React Router è‡ªä¿¡åœ°åŠ«æŒæ‚¨çš„è·¯ç”±ã€‚ä»ç°åœ¨å¼€å§‹ï¼Œåº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•å…¶ä»–è·¯ç”±æ›´æ”¹éƒ½å°†ç”± React Router å¤„ç†ã€‚

æ³¨æ„åˆ°é—®é¢˜äº†å—ï¼ŸReact è·¯ç”±å™¨åªèƒ½åœ¨ç¬¬ä¸€ä¸ªæˆåŠŸçš„ GET è¯·æ±‚å‘é€åˆ°ä½ çš„æœåŠ¡å™¨ååŠ è½½(æˆ–è€…`/`)ã€‚å¯æ€•çš„`Cannot GET /*`é”™è¯¯çš„åŸå› æ˜¯ï¼Œå¦‚æœä½ åœ¨`/dashboard`ç„¶åç‚¹å‡»åˆ·æ–°ï¼Œæµè§ˆå™¨å°†å‘`/dashboard`å‘å‡º GET è¯·æ±‚ï¼Œè¿™å°†å¤±è´¥ï¼Œå› ä¸ºä½ çš„æœåŠ¡å™¨ä¸Šæ²¡æœ‰å¤„ç†è¯¥è¯·æ±‚çš„é€»è¾‘(å› ä¸º React è·¯ç”±å™¨åº”è¯¥è¿™æ ·åš)ã€‚

å¦‚æœè¿™ä¸ªé—®é¢˜ä»ç„¶æ¨¡ç³Šä¸æ¸…ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªä¾‹å­ã€‚è¯´ä½ çœŸçš„ä¸ºä½ æ­£åœ¨å¼€å‘çš„åº”ç”¨ç¨‹åºæ„Ÿåˆ°éª„å‚²ï¼Œä½ æƒ³å’Œä½ å¦ˆå¦ˆåˆ†äº«å®ƒã€‚è¯¥åº”ç”¨ç¨‹åºæ˜¯äº•å­—æ¸¸æˆï¼Œæœ‰ä¸‰æ¡è·¯çº¿ï¼Œ`/`ã€`/play`å’Œ`leaderboard`ã€‚ä½ æŠŠé“¾æ¥`https://tictactyler.com/play`å‘ç»™ä½ å¦ˆå¦ˆï¼Œå› ä¸ºä½ æƒ³å’Œå¥¹ä¸€èµ·ç©ã€‚å½“å¥¹åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ç½‘å€å¹¶ç‚¹å‡»å›è½¦æ—¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿæ­¤æ—¶ï¼Œå¥¹æ²¡æœ‰ JavaScriptï¼Œæ²¡æœ‰ Reactï¼Œä¹Ÿæ²¡æœ‰ React è·¯ç”±å™¨ã€‚æµè§ˆå™¨å‘`/play`å‘å‡º GET è¯·æ±‚ï¼Œç”±äºä½ ä¾èµ– React è·¯ç”±å™¨æ¥å¤„ç†æ‰€æœ‰è·¯ç”±é€»è¾‘(ä½†å¥¹è¿˜æ²¡æœ‰ React è·¯ç”±å™¨)ï¼Œåº”ç”¨ç¨‹åºå´©æºƒï¼Œå¥¹å¾—åˆ°`Cannot GET /play`ã€‚

> â€œå¥½å§ï¼Œå¥½å§ï¼Œå¥½å§ã€‚â€é©¬ä¿®Â·éº¦åº·çº³

ç°åœ¨æœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ

é—®é¢˜çš„æ ¹æºåœ¨äºï¼Œæ‚¨å®Œå…¨ä¾èµ–å®¢æˆ·ç«¯è·¯ç”±ï¼Œè€Œæ²¡æœ‰è®¾ç½®ä»»ä½•é€»è¾‘æ¥å¤„ç†æœåŠ¡å™¨ç«¯è·¯ç”±ã€‚è§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ä¸ªä¸»è¦æ€è·¯ã€‚é¦–å…ˆï¼Œè®¾ç½®å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯è·¯ç”±ã€‚ç¬¬äºŒï¼Œå°†æ‰€æœ‰æœåŠ¡å™¨è¯·æ±‚é‡å®šå‘åˆ°`/index.html`,å®ƒå°†ä¸‹è½½æ‰€æœ‰ JS èµ„æºï¼Œå¹¶å…è®¸ React Router ä»é‚£é‡Œè·å–èµ„æºã€‚æˆ‘ä»¬å°†çœ‹åˆ°çš„å¤§å¤šæ•°è§£å†³æ–¹æ¡ˆéƒ½æ¶‰åŠåè€…ï¼Œå› ä¸ºåè€…æ›´ç®€å•ã€‚

* * *

### å“ˆå¸Œå†å²

TBHï¼Œè¿™æ˜¯ä¸€ç§é»‘å®¢ã€‚ä½ è§è¿‡é‚£äº›å¸¦`#`çš„ç½‘å€å—ï¼Ÿä»–ä»¬ä½¿ç”¨å“ˆå¸Œå†å²ã€‚è¿™ä¸ªæƒ³æ³•æ˜¯é€šè¿‡æ·»åŠ ä¸€ä¸ª`#`åˆ°ä½ çš„ URL çš„æ ¹çš„æœ«å°¾ï¼Œåœ¨è¿™ä¸ª`#`ä¹‹åçš„ä»»ä½•ä¸œè¥¿éƒ½ä¸ä¼šè¢«å‘é€åˆ°æœåŠ¡å™¨ã€‚å› æ­¤ï¼Œå¦‚æœ URL æ˜¯`https://tm.io/#/courses`ï¼Œæµè§ˆå™¨å°†å‘`https://tm.io`å‘å‡º GET è¯·æ±‚ï¼Œå–å›æ‰€æœ‰çš„ JavaScriptï¼Œç„¶å React Router å°†åŠ è½½ï¼Œè§`/courses`ï¼Œå¹¶æ˜¾ç¤ºè¯¥è·¯ç”±çš„æ­£ç¡®è§†å›¾ã€‚React Router æä¾›äº†ä¸€ä¸ª [HashRouter](https://reacttraining.com/react-router/web/api/HashRouter) ç»„ä»¶ï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥è·å¾—åŸºäºæ•£åˆ—çš„è·¯ç”±ï¼Œä½†æ˜¯è€å®è¯´ï¼Œé™¤éä½ çœŸçš„éœ€è¦å®ƒï¼Œå¦åˆ™è¿˜æœ‰æ›´å¥½çš„é€‰æ‹©ã€‚

* * *

### åŒ…ç½—ä¸‡è±¡

å¦‚æœæ‚¨å·²ç»æœ‰ä¸€å°æ­£åœ¨ä½¿ç”¨çš„æœåŠ¡å™¨ï¼Œè¿™å¯èƒ½æ˜¯æ‚¨çš„æœ€ä½³é€‰æ‹©ã€‚è¿™é‡Œçš„ä¸»è¦æ€æƒ³æ˜¯å°†æ‰€æœ‰æœåŠ¡å™¨è¯·æ±‚é‡å®šå‘åˆ°`/index.html`ã€‚ç»“æœç±»ä¼¼äºå“ˆå¸Œå†å²ã€‚å¯¹æ‚¨çš„æœåŠ¡å™¨çš„ä»»ä½•è¯·æ±‚éƒ½å°†ä½¿ç”¨ç´¢å¼•é¡µé¢è¿›è¡Œå“åº”(ç„¶åè·å–æ‚¨éœ€è¦çš„ä»»ä½• JS èµ„æº)ï¼ŒReact Router å°†æ¥ç®¡å¹¶åŠ è½½é€‚å½“çš„è§†å›¾ã€‚å®é™…çš„ä»£ç æ ¹æ®æ‚¨æ‹¥æœ‰çš„ç±»å‹è€Œæœ‰æ‰€ä¸åŒã€‚è¿™é‡Œæœ‰ä¸€äº›ä¾‹å­

##### å¿«é€’

```
app.get('/*', function(req, res) {
  res.sendFile(path.join(__dirname, 'path/to/your/index.html'), function(err) {
    if (err) {
      res.status(500).send(err)
    }
  })
}) 
```

#### Appacheã€‚htaccess

```
RewriteBase /
RewriteRule ^index\.html$ - [L]
 RewriteCond %{REQUEST_FILENAME} !-f
 RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.html [L] 
```

#### åŸºå°¼ç³»æ•°ã€‚conf æ–‡ä»¶

```
location / {
  if (!-e $request_filename){
    rewrite ^(.*)$ /index.html break;
  }
} 
```

* * *

### æ²¡æœ‰æœåŠ¡å™¨

å¯¹äºé‚£äº›ä¸å¿…æ‹…å¿ƒç®¡ç†æœåŠ¡å™¨çš„å—ç¥ç¦çš„å¼€å‘è€…æ¥è¯´ï¼Œä¹Ÿæœ‰ä¸€äº›é€‰é¡¹ç»™ä½ ï¼Œå®ƒä»¬(é€šå¸¸)è¢«åµŒå…¥åˆ°ä½ æ­£åœ¨ä½¿ç”¨çš„æ‰˜ç®¡æœåŠ¡ä¸­ã€‚è¿™é‡Œæ˜¾ç„¶æœ‰å¾ˆå¤šä¸åŒçš„å˜ä½“ï¼Œä½†æ˜¯ä½ éœ€è¦æ‰¾åˆ°ä¸€ä¸ªæ”¯æŒå®¢æˆ·ç«¯è·¯ç”±å™¨çš„æœåŠ¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ ç”¨ Firebase åšä¸»æœºï¼Œæœ‰ä¸€ä¸ªé—®é¢˜ä¼šé—®ä½ 

> é…ç½®ä¸ºå•é¡µ app(å°†æ‰€æœ‰ URL é‡å†™ä¸º/index.html)ï¼Ÿ

Netlify ä¹Ÿæ”¯æŒå®¢æˆ·ç«¯è·¯ç”±ï¼Œä½ åªéœ€è¦ç”¨ä¸‹é¢çš„è§„åˆ™åˆ›å»ºä¸€ä¸ª`/_redirects`æ–‡ä»¶

```
/*  /index.html  200 
```

æ­£å¦‚æ‚¨å¯èƒ½çŒœåˆ°çš„ï¼Œè¿™å‘Šè¯‰ Netlify å°†æ‰€æœ‰è¯·æ±‚é‡å®šå‘åˆ°`.index.html`ã€‚

* * *

### Webpack /å¼€å‘

è¿™ä¸€èŠ‚æ˜¯ä¸ºåœ¨ä½¿ç”¨`webpack-dev-server.`å¼€å‘ä¸­é‡åˆ°è¿™ä¸ªé—®é¢˜çš„æ¯ä¸ªäººå‡†å¤‡çš„ã€‚å°±åƒä¸Šé¢ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯å‘Šè¯‰ Webpack Dev Sever å°†æ‰€æœ‰æœåŠ¡å™¨è¯·æ±‚é‡å®šå‘åˆ°`/index.html`ã€‚åœ¨æ‚¨çš„ webpack é…ç½®ä¸­ï¼Œåªæœ‰ä¸¤ä¸ªå±æ€§éœ€è¦è®¾ç½®ï¼Œå³`publicPath`å’Œ`historyApiFallback`ã€‚

```
publicPath: '/',
historyApiFallback: true, 
```

`publicPath`å…è®¸æ‚¨æŒ‡å®šåº”ç”¨ç¨‹åºä¸­æ‰€æœ‰èµ„äº§çš„åŸºæœ¬è·¯å¾„ã€‚`historyAPIFallback`ä¼šå°† 404s é‡å®šå‘åˆ°`/index.html`ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªåŸºæœ¬çš„ webpack é…ç½®æ–‡ä»¶çš„ä¾‹å­ï¼Œå¦‚æœä½ éœ€è¦çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªé€‰é¡¹ã€‚

```
var path = require('path');
var HtmlWebpackPlugin = require('html-webpack-plugin');

module.exports = {
  entry: './app/index.js',
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'index_bundle.js',
    publicPath: '/'
  },
  module: {
    rules: [
      { test: /\.(js)$/, use: 'babel-loader' },
      { test: /\.css$/, use: [ 'style-loader', 'css-loader' ]}
    ]
  },
  devServer: {
    historyApiFallback: true,
  },
  plugins: [
    new HtmlWebpackPlugin({
      template: 'app/index.html'
    })
  ]
}; 
```

å°±æ˜¯è¿™æ ·ã€‚ç°åœ¨å»äº«å—ä½ çš„å‘¨æœ«å§ğŸ»ã€‚

* * *

è¿™ç¯‡æ–‡ç« æœ€åˆå‘è¡¨åœ¨ TylerMcGinnis.com å¤§å­¦ï¼Œæ˜¯ä»–ä»¬ T2 ååº”è·¯ç”±å™¨è¯¾ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚