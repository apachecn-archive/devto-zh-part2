# äº‘å‡½æ•°ä¸­çš„ TDD ç”¨äºä½¿ç”¨æ•‘æ´æ¶ˆé˜²çš„æ¶ˆé˜²åŸºåœ°

> åŸæ–‡:[https://dev . to/star _ _ hoshi/TDD-in-cloud-functions-for-fire base-use-rescue-fire-413d](https://dev.to/star__hoshi/tdd-in-cloud-functions-for-firebase-using-rescue-fire--413d)

äº‘åŠŸèƒ½éƒ¨ç½²éå¸¸æ…¢ã€‚éƒ¨ç½²é€šå¸¸åœ¨ 30 ç§’å†…å®Œæˆï¼Œä½†æœ‰æ—¶éœ€è¦ 10 åˆ†é’Ÿä»¥ä¸Šã€‚ä»…ä»…é‡å†™ä¸€è¡Œå°±ç­‰å‡ åˆ†é’Ÿæ˜¯æµªè´¹æ—¶é—´ã€‚

[äº‘å‡½æ•°æ¨¡æ‹Ÿå™¨](https://firebase.google.com/docs/functions/local-emulator)å¾ˆæœ‰ç”¨ã€‚ç„¶è€Œï¼Œå¾ˆéš¾åˆ›å»ºæµ‹è¯•æ•°æ® jsonï¼Œä¹Ÿä¸å¯èƒ½ç¼–å†™æµ‹è¯•ã€‚

è®©æˆ‘ä»¬ç”¨ [rescue-fire](https://github.com/starhoshi/rescue-fire) åœ¨æœ¬åœ°æ¨¡æ‹ŸåŠŸèƒ½ï¼Œå¹¶è¿›è¡Œ TDDã€‚

[![logo\.png \(733Ã—207\)](../Images/458a2ca1754eca138dd8a8e9f9b133bc.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--I6pPzl35--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://raw.githubusercontent.com/starhoshi/rescue-fire/master/docs/logo.png)

# å¦‚ä½•

äº‘å‡½æ•°ä»ä¸€ä¸ªåä¸º`event`çš„å˜é‡å¼€å§‹ã€‚

```
exports.updateUser = functions.firestore.document('users/{userId}')
  .onCreate(event => {
    console.log('old name', event.data.data().name)
    return event.data.ref.update({name: 'new name'})
}) 
```

Enter fullscreen mode Exit fullscreen mode

å¦‚æœä½ èƒ½åˆ›å»ºè¿™ä¸ª`event`ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨[ç®¡ç†è½¯ä»¶å¼€å‘å·¥å…·åŒ…](https://firebase.google.com/docs/admin/setup)æ¥è¿è¡Œå‡ ä¹å’Œäº‘å‡½æ•°ä¸€æ ·çš„ä»£ç ã€‚
[æ•‘-ç«](https://github.com/starhoshi/rescue-fire)ä½¿æ­¤`event`ã€‚

## 1ã€‚è£…ç½®

```
npm install rescue-fire --only=dev
yarn add --dev rescue-fire 
```

Enter fullscreen mode Exit fullscreen mode

## 2ã€‚å‡†å¤‡ Google äº‘å¸æˆ·å‡­æ®

ä¸‹è½½æœåŠ¡å¸æˆ·å¯†é’¥ json æ–‡ä»¶ã€‚

[https://firebase.google.com/docs/admin/setup?authuser = 0 # add _ firebase _ to _ your _ app](https://firebase.google.com/docs/admin/setup?authuser=0#add_firebase_to_your_app)

è¿™ä¸ª json æ–‡ä»¶å¾ˆæ•æ„Ÿï¼Œè¦å°å¿ƒã€‚

> é‡è¦äº‹é¡¹:æ­¤æ–‡ä»¶åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‚¨çš„æœåŠ¡å¸æˆ·çš„ç§æœ‰åŠ å¯†å¯†é’¥ã€‚è¯·ä¿å¯†ï¼Œä¸è¦å°†å®ƒå­˜å‚¨åœ¨å…¬å…±å­˜å‚¨åº“ä¸­ã€‚

## 3ã€‚å®‰è£…æµ‹è¯•åº“

è¯·ä½¿ç”¨æ‚¨å–œæ¬¢çš„æµ‹è¯•åº“ã€‚

æ¯”å¦‚åœ¨ [Jest](https://facebook.github.io/jest/) çš„æƒ…å†µä¸‹:

```
npm install jest --only=dev
yarn add --dev jest 
```

Enter fullscreen mode Exit fullscreen mode

### 4ã€‚å†™ä¸€ä¸ªæµ‹è¯•

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œåœ¨åˆ›å»ºç”¨æˆ·æ—¶æ›´æ–°åç§°ã€‚è¯¥å‡½æ•°çš„ä»£ç å¦‚ä¸‹ã€‚

æ­¤ç¤ºä¾‹æ˜¯ç”¨ TypeScript ç¼–å†™çš„ã€‚

```
const changeName = (event: functions.Event<DeltaDocumentSnapshot>) => {
  console.log('old name', event.data.data().name)
  return event.data.ref.update({ name: 'new name' })
} 
```

Enter fullscreen mode Exit fullscreen mode

æµ‹è¯•ä¼šæ˜¯è¿™æ ·çš„ã€‚

```
import 'jest'
import * as admin from 'firebase-admin'
import * as functions from 'firebase-functions'
import * as Rescue from 'rescue-fire'

// Set up to run firebase in local.
beforeAll(() => {
  const serviceAccount = require('./your-firebase-adminsdk.json')
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount)
  })
})

test('update name', async () => {
  // prepare
  const data = {name: 'name'}
  const user = await admin.firestore().collection('user').add(data)
  const event = Rescue.event(user, data)

  // start Cloud Functions
  await changeName(event)

  // expect name changed
  const updatedUser = await admin.firestore().collection('user').doc(user.id).get()
  expect(updatedUser.data()!.name).toBe('new name')
}) 
```

Enter fullscreen mode Exit fullscreen mode

äº‘åŠŸèƒ½å¯ä»¥ç”¨ TDD å¼€å‘ã€‚(ä¸¥æ ¼æ¥è¯´ä¸æ˜¯ TDDğŸ™ƒ)

è¿™æ˜¯ä¸€ä¸ªå¾ˆå°çš„åŠŸèƒ½ï¼Œä½†æ˜¯ [orderable.test.ts](https://github.com/starhoshi/orderable.ts/blob/master/orderable/src/__tests__/orderable.test.ts) æ­£åœ¨ç”¨ rescue-fire æµ‹è¯•å·¨å¤§çš„åŠŸèƒ½ã€‚

å¯é€‰å‚æ•° defenitions æ˜¯[è¿™é‡Œçš„](https://github.com/starhoshi/rescue-fire/blob/master/src/index.ts#L18)ã€‚

### 4ã€‚æœ€åï¼Œåˆ›å»ºå‡½æ•°

```
exports.updateUser = functions.firestore
  .document('users/{userId}')
  .onCreate(event => {
    return changeName(event)
}) 
```

Enter fullscreen mode Exit fullscreen mode

ğŸ‰

## å¤‡æ³¨

æ•‘æ´ç«ç¾é€ æˆçš„äº‹ä»¶å°šæœªå®Œæˆã€‚æˆ‘è®¤ä¸ºå†™æµ‹è¯•å°±è¶³å¤Ÿäº†ï¼Œä½†æ˜¯è¦è®°ä½å®ƒä¸åŒäºå®é™…äº‹ä»¶ã€‚

è¯·ä½¿ç”¨ [starhoshi/rescue-fire:äº‘åŠŸèƒ½çš„æµ‹è¯•åŠ©æ‰‹ã€‚](https://github.com/starhoshi/rescue-fire)ï¼