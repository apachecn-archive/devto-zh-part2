# æœ€åæ˜¯æ‰¿è¯º&å°è¯•/æŠ“ä½

> åŸæ–‡:[https://dev.to/annarankin/finally-in-promises-try catch-2c 44](https://dev.to/annarankin/finally-in-promises--trycatch-2c44)

æœ€è¿‘ï¼Œæˆ‘å¯¹ JavaScript ä¸­çš„`async` / `await`å…³é”®å­—è¿›è¡Œäº†æ›´å¤šçš„è¯•éªŒã€‚æˆ‘æ³¨æ„åˆ°ï¼Œæœ‰æ—¶æˆ‘å¾ˆéš¾å°†æˆ‘ä½¿ç”¨çš„æ‰¿è¯ºç­–ç•¥ä¸æˆ‘éœ€è¦ç”¨æ–°è¯­æ³•ç¼–å†™ä»£ç çš„æ–¹å¼åè°ƒèµ·æ¥ã€‚æœ€è¿‘ï¼Œæˆ‘å’Œ`finally`åœ¨ä¸€äº›`try` / `catch`è¡—åŒºç©è€ï¼Œå‘ç°äº†ä¸€äº›æˆ‘æ²¡æœ‰é¢„æ–™åˆ°çš„è¡Œä¸ºã€‚

è¿™ç¯‡æ–‡ç« å‡è®¾å¯¹å¼‚æ­¥ JavaScript ä»£ç çš„å·¥ä½œåŸç†æœ‰ä¸€ä¸ªå¤§è‡´çš„äº†è§£â€”â€”ç‰¹åˆ«æ˜¯æ‰¿è¯ºçš„å·¥ä½œåŸç†ã€‚(å¦‚æœä½ æƒ³ä»å¯¹ async/await å…³é”®å­—çš„å›è°ƒä¸­å¯»æ‰¾å¯¹ async JS çš„æ·±å…¥è§£é‡Šï¼Œåœ¨ [javascript.info](https://javascript.info/async) ä¸Šæœ‰ä¸€ä¸ªå¾ˆå¥½çš„æ¦‚è¿°â€”â€”ä½ ä¹Ÿå¯ä»¥æŸ¥çœ‹[ç©†æ–¯å¡”æ³•Â·åŠ æ³•å°”çš„æ–‡ç« ](https://hackernoon.com/6-reasons-why-javascripts-async-await-blows-promises-away-tutorial-c7ec10518dd9)ï¼Œäº†è§£ async/await çš„ä¸€äº›ç®€æ´ç‰¹æ€§ã€‚)

å¯¹äºä¸Šä¸‹æ–‡â€”â€”åœ¨æˆ‘èŠ±å¤§é‡æ—¶é—´ç ”ç©¶çš„ JavaScript ä»£ç åº“ä¸­ï¼Œæˆ‘ä»¬ä¸€ç›´é€šè¿‡å¤§é‡ä½¿ç”¨æ‰¿è¯ºæ¥å¤„ç†å¼‚æ­¥æ“ä½œã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ç§æ¨¡å¼å¯¹æˆ‘æ¥è¯´è¦ç†Ÿæ‚‰å¾—å¤š:

```
const loadSomething = () => {
  return fetchSomeData()
    .then(data => doSomethingWith(data))
    .catch(error => logAndReport(error))
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿˜æœ‰è¿™ä¸ªä¸å¤ªç†Ÿæ‚‰:

```
const loadSomething = async () => {
  try {
    const data = await fetchSomeData()
    return doSomethingWith(data)
  } catch (error) {
    logAndReport(error)
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

# [](#-raw-finally-endraw-)`finally`...ï¼Ÿ

æ‚¨ä¼šæ³¨æ„åˆ°åœ¨ä¸Šé¢çš„ä¸¤ä¸ªä¾‹å­ä¸­éƒ½ç¼ºå°‘äº†ä¸€ä¸ª`finally`å›è°ƒ/å—ã€‚æˆ‘åœ¨ä»£ç ä¸­ä¸ç»å¸¸ä½¿ç”¨è¿™ä¸¤ä¸ªè¯ï¼Œè¿™å¯¼è‡´äº†æˆ‘çš„è¯¯è§£(å®é™…ä¸Šæ˜¯å¯¹ä¸¤è€…çš„è¯¯è§£)ã€‚è®©æˆ‘ä»¬æ·±å…¥äº†è§£è¿™ä¸ªæ¦‚å¿µåœ¨æ‰¿è¯ºå’Œå°è¯•/æ•æ‰ä¸­çš„åŒºåˆ«ï¼

## [](#-raw-finally-endraw-in-promises)`finally`è¨€è€Œæ— ä¿¡

å½“ä½ ä½¿ç”¨`somePromise.then(x).catch(y).finally(z)`æ¨¡å¼æ—¶ï¼Œä½ çš„ä¸šåŠ¡é€»è¾‘é€šå¸¸å‘ç”Ÿåœ¨`then`å›è°ƒ(ä¸Šé¢çš„`x`â€”â€”ä¸€æ—¦`somePromise`è§£å†³åä½ æƒ³åšçš„äº‹æƒ…)æˆ–`catch`å›è°ƒ(ä¸Šé¢çš„ã€T5â€”â€”ä¸‡ä¸€å‡ºç°å¯æ€•çš„é”™è¯¯ï¼Œè¿”å›ä½ æƒ³ä¼ é€’çš„ä¸œè¥¿)ä¸­ã€‚æ‚¨å¯èƒ½ä»æœªåœ¨ä»£ç ä¸­ä½¿ç”¨è¿‡`finally`â€”â€”è¿™æ²¡å…³ç³»ã€‚

æ ¹æ® [MDN docs](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/finally#Description) çš„è¯´æ³•ï¼Œ`finally`å›è°ƒå…è®¸ä½ åœ¨ä½ çš„æ‰¿è¯ºè¢«è§£å†³â€”â€”è§£å†³æˆ–æ‹’ç»â€”â€”æ— è®ºå¦‚ä½•â€”â€”åæ‰§è¡Œé€»è¾‘ã€‚å®ƒå¯¹ä½ çš„æ‰¿è¯ºå°†è¦è§£å†³çš„*å€¼*å®Œå…¨æ²¡æœ‰å½±å“â€”â€”å®ƒç”šè‡³æ²¡æœ‰è®¿é—®å®ƒçš„æƒé™ã€‚äº‹å®ä¸Šï¼Œæ–‡ä»¶æŒ‡å‡º:

> `Promise.resolve(2).finally(() => {})`å°†é€šè¿‡`2`è§£å†³ã€‚

è¿™æ„å‘³ç€(æœ‰ç‚¹è¿åç›´è§‰)ï¼Œä½ å¯ä»¥åœ¨ä½ çš„æ‰¿è¯ºé“¾ä¸­éšæ„åœ°æ’’ä¸Š`finally`æ¬¡å›ç”µï¼Œè€Œä¸ä¼šæ”¹å˜æœ€ç»ˆç»“æœ:

```
// Please don't do this ğŸ˜…

Promise.resolve({ some: 'data' })
  .finally(() => { console.log('WHALE HELLO THERE ğŸ‹') })
  .then(data => ({ ...data, anAdditional: 'key'  }))
  .finally(() => { console.log('Looks like we made it past the first step ğŸ™') })
  .then(data => ({ ...data, yetAnother: 'thing added' }))
  .finally(() => { console.log("We're done I think ğŸ™Œ") })
  .then(data => {
    console.log('Final result:', data)
  }) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœæ‚¨è¿è¡Œè¿™æ®µä»£ç ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°:

[![result of executing the above code: Each step is logged to the console sequentially; the final result is an object containing three keys](../Images/2748effbee32858ed786a1f25fecf20e.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--zXvumFEb--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/7o2uc2fv1nv5wll9hbrl.png)

## [](#-raw-finally-endraw-in-trycatch-blocks)`finally`åœ¨å°è¯•/æ•æ‰å—ä¸­

try/catch/finally æ¨¡å¼åœ¨ JavaScript ä¸­å·²ç»å­˜åœ¨äº†å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œä» 1.4 ç‰ˆ(ES3 è§„èŒƒï¼Œå¤§çº¦åœ¨ 1999 å¹´)å¼€å§‹ã€‚æˆ‘åœ¨è¿™ç§æ¨¡å¼å’Œå¦‚ä½•å¤„ç†æ‰¿è¯ºä¹‹é—´ç”»å‡ºäº†ä¸€äº›é€»è¾‘ä¸Šçš„ç›¸ä¼¼ä¹‹å¤„:

**`try` / `then` :**
è¿™å°±æ˜¯æˆ‘ä»¬çš„â€œå¿«ä¹ä¹‹è·¯â€é€»è¾‘æ‰€å»çš„åœ°æ–¹â€”â€”å¦‚æœä»€ä¹ˆéƒ½æ²¡æœ‰å‘ç”Ÿï¼Œæ‰€æœ‰çš„è¡ŒåŠ¨éƒ½åœ¨è¿™é‡Œå‘ç”Ÿï¼

**`catch` :** ğŸ™

**`finally` :**
è¯¥é€»è¾‘å°†åœ¨`try` / `then`(å¯èƒ½è¿˜æœ‰`catch`)é€»è¾‘å®Œæˆåæ‰§è¡Œã€‚æ— è®ºæˆ‘ä»¬æ˜¯å¦é‡åˆ°é”™è¯¯ï¼Œè¿™æ®µä»£ç éƒ½ä¼šè¿è¡Œã€‚

è¿™é‡Œè®©æˆ‘çŠ¯é”™è¯¯çš„å·®å¼‚ä¸`return`è¯­å¥æœ‰å…³ã€‚å¦‚æœä½ çš„`finally`å—*ä¸*åŒ…å«è¿”å›è¯­å¥ï¼Œé‚£ä¹ˆ*å¯¹è¿”å›å€¼æ²¡æœ‰å½±å“*ã€‚ç„¶è€Œï¼Œå¦‚æœä½ ä»ä¸€ä¸ª`finally`å—è¿”å›ä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼å°†è¦†ç›–æ‰€æœ‰å…¶ä»–çš„è¿”å›ï¼Œå¹¶æˆä¸ºä½ çš„å‡½æ•°çš„æœ€ç»ˆç»“æœã€‚(æŸ¥çœ‹æ–‡æ¡£ä¸­çš„[ç¤ºä¾‹](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/try...catch#Returning_from_a_finally_block)ï¼)

```
// This worked as I expected.
const returnFromTryCatch = (someFunction) => {
  try {
    return someFunction()
  } catch (error) {
    return `Caught an error: ${error}`
  } finally {
    // This block has no effect on the return value.
    console.log('All done!')
  }
}

// This was a surprise to me!
const returnFromFinally = (someFunction) => {
  try {
    return someFunction()
  } catch (error) {
    return `Caught an error: ${error}`
  } finally {
    // Wait... so I'm just swallowing my return and error handling?
    return 'All done!'
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ˜¯æœ‰é“ç†çš„ï¼Œä½†æˆ‘è§‰å¾—ä¸ä¸€è‡´ã€‚æˆ‘åœ¨æ‰¿è¯ºæ–¹é¢çš„ç»éªŒè®©æˆ‘æŠ¬èµ·äº†å¤´â€”â€”ä¸ºä»€ä¹ˆä¸€ä¸ª`finally`å—*æ›¾ç»*è¢«å…è®¸è¦†ç›–ä¸€ä¸ªå‡½æ•°è¿”å›å€¼ï¼Ÿ

[![pixel art of a woman looking at her laptop in deep thought](../Images/9fd2b827072bd31a668f5cb3df3b551c.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s---s2UJNZP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/h26k6giyyy38p4v6y8w9.png)

# [](#finding-the-reason)å¯»æ‰¾åŸå› 

[*æœ€åï¼Œ*](https://en.wikipedia.org/wiki/Semantic_satiation) æˆ‘å‘æˆ‘çš„æŠ€æœ¯ä¸»ç®¡æŠ¥å‘Šäº†æˆ‘çš„çƒ¦æ¼ï¼Œä»–å‘ç»™æˆ‘[ä¸€ä¸ªç›¸å…³ StackOverflow è®¨è®ºçš„é“¾æ¥](https://stackoverflow.com/questions/3837994/why-does-a-return-in-finally-override-try)ã€‚çœ‹åˆ° ECMAScript å¯¹æ­¤è¡Œä¸ºçš„è§„èŒƒ(é‡ç‚¹æ˜¯æˆ‘çš„),å¸®åŠ©å®ƒåœ¨æˆ‘çš„å¤§è„‘ä¸­å°±ä½:

> äº§é‡`TryStatement : try Block Finally`è¯„ä¼°å¦‚ä¸‹:
> 
> è®¾ B æ˜¯è¯„ä¼° Block çš„ç»“æœã€‚
> è®¾ F ä¸ºæœ€ç»ˆæ±‚å€¼ç»“æœã€‚
> **å¦‚æœ F.type æ­£å¸¸ï¼Œè¿”å› B.**
> è¿”å› f

(å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ ¹æ® [ECMAScript è§„èŒƒ](https://tc39.github.io/ecma262/#sec-completion-record-specification-type)ï¼Œå®Œæˆç±»å‹æ˜¯â€œæ­£å¸¸ã€ä¸­æ–­ã€ç»§ç»­ã€è¿”å›æˆ–æŠ›å‡ºä¸­çš„ä¸€ç§â€â€”â€”æˆ‘å‡è®¾ä¸åŒ…å«`break`ã€`continue`ã€`return`æˆ–`throw`å…³é”®å­—çš„å‡½æ•°ç¬¦åˆâ€œæ­£å¸¸â€çš„æ¡ä»¶æœ‰ç‚¹å¥‡æ€ªçš„è¯­ä¹‰ã€‚)

### [](#note-on-multiple-return-statements)å¤šå¼ é€€è´§å•ä¸Šçš„å¤‡æ³¨

æœ¬æ–‡ä¸­çš„ä»£ç ç¤ºä¾‹æ²¡æœ‰ä½¿ç”¨å•ä¸ªå›è½¦ã€‚æˆ‘ä¸æ‰“ç®—è¿‡å¤šåœ°è®¨è®ºå¤šä¸ª return è¯­å¥â€”â€”æˆ‘è¦è¯´çš„æ˜¯ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¯¹è¾ƒé•¿çš„å‡½æ•°ä½¿ç”¨å•ä¸ª return è¿‡å»å¯¹æˆ‘å¾ˆæœ‰ç”¨ï¼Œä½†æˆ‘å‘ç°å®ƒä»¬åœ¨è¾ƒçŸ­çš„å—ä¸­ç”¨å¤„ä¸å¤§ã€‚ä¸è¿‡ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™å¯èƒ½ä¼šè®©æˆ‘çš„ç”Ÿæ´»æ›´è½»æ¾ï¼