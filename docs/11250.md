# ç”¨ Dartã€Aqueduct å’Œ PostgreSQL æ„å»º RESTful Web APIs ç¬¬ 2 éƒ¨åˆ†:è·¯ç”±

> åŸæ–‡:[https://dev . to/graphic beacon/building-restful-we B- API-with-dart-aqueduct-and-PostgreSQL part-2-routing-53ip](https://dev.to/graphicbeacon/building-restful-web-apis-with-dart-aqueduct-and-postgresqlpart-2-routing-53ip)

[![Featured image for Building RESTful Web APIs with Dart, Aqueduct and PostgreSQL](../Images/cbdf930372b6e08ad5ad2b8c1296074d.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--PZk7TA-r--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/dv19znif0x9wpvdcdt13.jpg)

* * *

***è¯·æ³¨æ„:ä» Dart 2 å¼€å§‹ï¼Œå¯¼æ°´ç®¡çš„ API å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯¼è‡´äº†é‡å¤§å˜åŒ–ã€‚æœ¬æ–‡åŸºäº Dart v1 çš„ Aqueduct 2.5.0ã€‚**T3ã€‘*

***æˆ‘å·²ç»æ›´æ–°äº†è¿™ä¸ªä½œä¸ºæ–°çš„è§†é¢‘ç³»åˆ—:ã€http://bit.ly/aqueduct-tutorialã€‘***

* * *

åœ¨ç¬¬ 1 éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ç®€è¦æ¦‚è¿°äº† Aqueduct åŠå…¶ç‰¹æ€§ï¼Œå¹¶å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨å…¶ CLI å·¥å…·è®¾ç½®ç¤ºä¾‹é¡¹ç›®ã€‚

æœ¬æ–‡æ˜¯ç³»åˆ—æ–‡ç« çš„ä¸€éƒ¨åˆ†ï¼Œæ¶µç›–ä»¥ä¸‹ä¸»é¢˜:

*   [ç¬¬ 1 éƒ¨åˆ†:è®¾ç½®å¹¶è¿è¡Œç¤ºä¾‹](https://dev.to/graphicbeacon/building-restful-web-apis-with-dart-aqueduct-and-postgresql-55k)
*   **ç¬¬ 2 éƒ¨åˆ†:ç”¨ CRUD æ“ä½œå®ç°è·¯ç”±**(æˆ‘ä»¬åœ¨è¿™é‡Œ)
*   [ç¬¬ 3 éƒ¨åˆ†:å°† Web APIs è¿æ¥åˆ° PostgreSQL æ•°æ®åº“](https://dev.to/graphicbeacon/building-restful-web-apis-with-dart-aqueduct-and-postgresqlpart-3-postgres-9c7)
*   ç¬¬ 4 éƒ¨åˆ†:ç¼–å†™è‡ªåŠ¨åŒ–æµ‹è¯•
*   [***å¥–åŠ±å†…å®¹*** DB è¿ç§»å’Œæ¨¡å‹å…³ç³»](https://dev.to/graphicbeacon/building-restful-web-apis-with-dart-aqueduct-and-postgresqlbonus-content-551g)ğŸ˜„

åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªå…·æœ‰ CRUD( *åˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤*)åŠŸèƒ½çš„å®šåˆ¶è·¯ç”±ã€‚

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£è·¯ç”±å™¨å’Œ HTTPControllers çš„æ¦‚å¿µã€‚è¿™å°†å‘Šè¯‰æˆ‘ä»¬å‰è¿›çš„æ–¹å‘ã€‚åœ¨è¿™ä¸€éƒ¨åˆ†çš„æœ€åï¼Œæˆ‘ä»¬å°†æœ‰æˆ‘ä»¬çš„ç«¯ç‚¹ï¼Œæœ‰èƒ½åŠ›é€šè¿‡æˆ‘ä»¬å®šä¹‰çš„ CRUD æ“ä½œæ¥æ“ä½œæˆ‘ä»¬çš„æ•°æ®æºã€‚

* * *

## [](#what-is-a-router)ä»€ä¹ˆæ˜¯è·¯ç”±å™¨ï¼Ÿ

è·¯ç”±å™¨è´Ÿè´£æ•è·è¯·æ±‚è·¯å¾„ï¼Œå¹¶ç¡®å®šåŸºäºè¯¥è·¯å¾„è¿è¡Œçš„é€»è¾‘ã€‚å½“åœ¨æä¾›ç»™æˆ‘ä»¬çš„`Router`å¯¹è±¡ä¸Šè°ƒç”¨`route`æ–¹æ³•æ—¶ï¼Œé€šè¿‡æ³¨å†Œä¸€ä¸ªè·¯ç”±æ¥å®šä¹‰è¯·æ±‚è·¯å¾„ã€‚æ³¨å†Œå‘ç”Ÿåœ¨æˆ‘ä»¬çš„***favereadsink***å­ç±»ä¸­çš„`setupRouter`æ–¹æ³•è¢«è°ƒç”¨æ—¶:

```
// lib/fave_reads_sink.dart
@override
void setupRouter(Router router) {...} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`setupRouter`æ–¹æ³•æä¾›äº†ä¸€ä¸ªè·¯ç”±å™¨å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œç„¶åæˆ‘ä»¬ç”¨å®ƒæ¥å®šä¹‰æˆ‘ä»¬çš„æ¯æ¡è·¯ç”±:

```
@override
void setupRouter(Router router) {
  router.route('/router-1').listen(...);
  router.route('/router-2').listen(...);
  router.route('/router-3').listen(...); // and so on
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è°ƒç”¨ route æ–¹æ³•æ¥å—ä¸€ä¸ªåŒ…å«è·¯å¾„åçš„å­—ç¬¦ä¸²ï¼Œåè·Ÿä¸€ä¸ª`listen`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å…è®¸æˆ‘ä»¬å®šä¹‰å‘è¯¥è·¯å¾„å‘å‡ºè¯·æ±‚æ—¶è¿è¡Œçš„é€»è¾‘ã€‚è·¯ç”±å¯ä»¥åŒ…å«*è·¯å¾„å˜é‡*ï¼Œè¿™äº›å˜é‡æ˜¯å ä½ç¬¦æ ‡è®°ï¼Œä»£è¡¨è·¯å¾„æ®µä¸­çš„ä»»ä½•å€¼:

```
router.route('/items/:itemID'); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸Šé¢çš„ä¾‹å­å£°æ˜äº†ä¸€ä¸ªè·¯å¾„å˜é‡`itemID`ï¼ŒåŒ¹é…â€œ **/items/0** â€ã€â€œ **/items/1** â€ã€â€œ **/items/foo** â€ç­‰ç­‰ã€‚`itemID`çš„å€¼å°†åˆ†åˆ«ä¸ºâ€œ **0** â€ã€â€œ **1** â€å’Œâ€œ **foo** â€ã€‚

è·¯å¾„å˜é‡ä¹Ÿå¯ä»¥æ˜¯å¯é€‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·è®¾ç½®å®ƒä»¬:

```
router.route('/items/[:itemID]'); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ„å‘³ç€è·¯çº¿åŒ¹é…ä¹Ÿå°†åŒ…æ‹¬â€œ **/items** â€ä½œä¸ºè·¯å¾„åã€‚

å…³äºè·¯ç”±å™¨çš„æ–‡æ¡£éå¸¸å…¨é¢ï¼Œæˆ‘å»ºè®®[å»](https://aqueduct.io/docs/http/routing)çœ‹çœ‹ã€‚

## [](#so-how-do-i-apply-this)é‚£ä¹ˆï¼Œæˆ‘è¯¥å¦‚ä½•åº”ç”¨è¿™ä¸ªå‘¢ï¼Ÿ

æœ‰äº†è¿™äº›çŸ¥è¯†ï¼Œè®©æˆ‘ä»¬ä»é¡¹ç›®ä¸­æ‰“å¼€`lib/fave_reads_sink.dart`ï¼Œå¹¶å¦‚ä¸‹ä¿®æ”¹`setupRouter`å®ç°:

```
@override
void setupRouter((Router router) async {
  router.route('/books[/:index]').listen((Request incomingRequest) async {
    return new Response.ok('Showing all books.');
  });
  router.route('/').listen((Request incomingRequest) async {
    return new Response.ok('<h1>Welcome to FaveReads</h1>')
      ..contentType = ContentType.HTML;
  });
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ ¹è·¯å¾„(/)ç°åœ¨è¿”å› HTML å†…å®¹ã€‚æˆ‘ä»¬è¿˜å®šä¹‰äº†ä¸€ä¸ªâ€œ **/books** â€è·¯ç”±ï¼Œå®ƒæ¥å—ä¸€ä¸ªåä¸º`index`çš„å¯é€‰è·¯å¾„å˜é‡ã€‚è¿™å°†æ˜¯æˆ‘ä»¬ CRUD æ“ä½œçš„ç»ˆç‚¹ã€‚

è°ƒç”¨ route æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª`RouteController`ï¼Œå®ƒå…¬å¼€äº†`listen`æ–¹æ³•ï¼Œè®©æˆ‘ä»¬å®šä¹‰è¦è¿è¡Œçš„é€»è¾‘ã€‚æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å¦å¤–ä¸¤ç§æ–¹æ³•ï¼Œå³`pipe`å’Œ`generate`ã€‚åè€…å…è®¸æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ HTTPController å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ä»¥æ›´å¥½åœ°å¤„ç†æˆ‘ä»¬çš„è¯·æ±‚(ç¨åçš„å°†è¯¦ç»†ä»‹ç»*)ã€‚*

`listen`æ–¹æ³•æ¥å—ä¸€ä¸ªåŒ…å«ä»£è¡¨ä¼ å…¥è¯·æ±‚çš„`Request`å¯¹è±¡çš„é—­åŒ…ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸­æå–æˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯ï¼Œæ‰§è¡Œè½¬æ¢ï¼Œå¹¶è¿”å›å“åº”ã€‚

ä¸ç®¡è¯·æ±‚åŠ¨ä½œå¦‚ä½•ï¼Œâ€œ **/books** â€çš„å½“å‰é€»è¾‘è¿”å›ç›¸åŒçš„å“åº”ã€‚è®©æˆ‘ä»¬ä¿®æ”¹å®ƒï¼Œä¸ºæˆ‘ä»¬çš„æ¯ä¸ªåŠ¨ä½œè¿”å›ä¸åŒçš„å“åº”:

```
router.route('/books[/:index]').listen((Request incomingRequest) async {
  String reqMethod = incomingRequest.innerRequest.method;
  String index = incomingRequest.path.variables["index"];

  if (reqMethod == 'GET') {
    if(index != null) {
      return new Response.ok('Showing book by index: $index');
    }
    return new Response.ok('Showing all books.');
  } else if (reqMethod == 'POST') {
    return new Response.ok('Added a book.');
  } else if (reqMethod == 'PUT') {
    return new Response.ok('Added a book.');
  } else if (reqMethod == 'DELETE') {
    return new Response.ok('Added a book.');
  }
  // If all else fails
  return new Response(405, null, 'Not sure what you\'re asking here');
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»£ç è´¨é‡å¾ˆå¿«å˜å¾—ç›¸å½“ç³Ÿç³•ã€‚è¿™æ˜¯é‡å¤çš„ï¼Œå®¹æ˜“æŠŠäº‹æƒ…å¼„å¾—ä¸€å›¢ç³Ÿ:

[![Image of spaghetti meatballs via Giphy](../Images/57c9c2ccdec84775b80d93dbf6b43187.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--LWh_GNfZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/e99xrgpufaerqzi0sdep.gif)

è¿™å¯ä»¥ç”¨`HTTPController`æ¸…ç†ï¼

## [](#what-is-an-httpcontroller)ä»€ä¹ˆæ˜¯ HTTPControllerï¼Ÿ

HTTPControllers é€šè¿‡å°† HTTP è¯·æ±‚æ˜ å°„åˆ°ç‰¹å®šçš„â€œå¤„ç†ç¨‹åºæ–¹æ³•â€æ¥ç”Ÿæˆå“åº”ï¼Œä»è€Œå¯¹ HTTP è¯·æ±‚åšå‡ºå“åº”ã€‚åªè¦è·¯å¾„åŒ¹é…ï¼Œè·¯ç”±å™¨å°±ä¼šå‘ HTTPController å‘é€è¯·æ±‚ã€‚

ä¸ºäº†åˆ›å»ºä¸€ä¸ªï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ‰©å±•`HTTPController`çš„`BooksController`ï¼Œä»¥ä¾¿æ·»åŠ æˆ‘ä»¬æƒ³è¦çš„è¡Œä¸ºã€‚æˆ‘ä»¬ç°åœ¨å°±å¼€å§‹å§ã€‚åœ¨`lib`ç›®å½•ä¸‹åˆ›å»º`controller/books_controller.dart`ï¼Œå†…å®¹å¦‚ä¸‹:

```
import '../fave_reads.dart';

class BooksController extends HTTPController {
  // invoked for GET /books
  @httpGet // HTTPMethod meta data
  Future<Response> getAllBooks() async => new Response.ok('Showing all books');

  // invoked for GET /books/:index
  @httpGet // HTTPMethod meta data
  Future<Response> getBook(@HTTPPath("index") int idx) async => new Response.ok('Showing single book');

  // invoked for POST /books
  @httpPost // HTTPMethod meta data
  Future<Response> addBook() async => new Response.ok('Added a book');

  // invoked for PUT /books
  @httpPut // HTTPMethod meta data
  Future<Response> updateBook() async => new Response.ok('Updated a book');

  // invoked for DELETE /books
  @httpDelete  // HTTPMethod meta data
  Future<Response> deleteBook() async => new Response.ok('Deleted a book');
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ˜¯æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…çš„æ€»ç»“:

1.  BooksController å­ç±»åŒ…å« 5 ä¸ªå¤„ç†ç¨‹åºæ–¹æ³•ï¼Œç§°ä¸º responder æ–¹æ³•ã€‚
2.  æ¯ä¸ªå“åº”å™¨æ–¹æ³•éƒ½ç”¨ä¸€ä¸ªå¸¸é‡æ¥æ³¨é‡Šï¼Œè¯¥å¸¸é‡åæ˜ äº†é€‚å½“çš„è¯·æ±‚æ–¹æ³•:`@httpGet`ã€`@httpPost`ã€`@httpPut`ã€`@httpDelete`ã€‚å…¶ä»–æ–¹æ³•ä¼šä½¿ç”¨`HTTPMethod`ï¼Œæ¯”å¦‚`@HTTPMethod('PATCH')`ã€‚
3.  æ¯ä¸ª responder æ–¹æ³•è¿”å›ä¸€ä¸ªç±»å‹ä¸º`Response`çš„ Futureã€‚æœªæ¥ä¹‹äºé£é•–å°±åƒæ‰¿è¯ºä¹‹äº JavaScript ã€‚
4.  responder æ–¹æ³•å¯ä»¥å°†è¯·æ±‚ä¸­çš„å€¼ç»‘å®šåˆ°å®ƒçš„å‚æ•°ã€‚æˆ‘ä»¬åœ¨`getBook()` responder æ–¹æ³•å‚æ•°ä¸­çœ‹åˆ°äº†è¿™ä¸€ç‚¹:`@HTTPPath("index") int idx`ã€‚å®ƒçš„è·¯å¾„å˜é‡`index`è¢«è½¬æ¢æˆä¸€ä¸ªæ•´æ•°ï¼Œå¹¶èµ‹ç»™ä¸€ä¸ªåä¸º`idx`çš„å˜é‡ã€‚

å¦‚æœæ²¡æœ‰ä¸€ä¸ªå“åº”æ–¹æ³•ä¸è¯·æ±‚æ–¹æ³•åŒ¹é…(*ï¼Œä¾‹å¦‚è¡¥ä¸*)ï¼Œåˆ™è¿”å›ä¸€ä¸ª`405 Method Not Allowed`å“åº”ã€‚

è®©æˆ‘ä»¬è½¬åˆ°`lib/fave_reads_sink.dart`å¹¶ä½¿ç”¨è¿™ä¸ªæ§åˆ¶å™¨:

```
import 'fave_reads.dart';
import 'controller/books_controller.dart'; // don't forget to import!
// ...
// ...
@override
void setupRouter((Router router) async {
  router
    .route('/books/[:index]')
    .generate(() => new BooksController()); // replaces `listen` method
// ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¹¶é€šè¿‡åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œ`aqueduct serve`æˆ–`dart bin/main.dart`æ¥è¿è¡Œæˆ‘ä»¬çš„é¡¹ç›®ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ [Postman](https://www.getpostman.com/apps) æ¥æµ‹è¯•æˆ‘ä»¬çš„å“åº”ã€‚

[![Image of Postman app](../Images/d6dfa5609ea0470a5bbc9f3aca6b26d8.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--CNBEbQG9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/df8jwytrzh6lrr3agguz.png)

## [](#mocking-our-datasource)å˜²è®½æˆ‘ä»¬çš„æ•°æ®æº

å¯¹äºæˆ‘ä»¬çš„æ•°æ®æºï¼Œè®©æˆ‘ä»¬åœ¨`controller/books_controller.dart` :
ä¸­åˆ›å»ºä¸€ä¸ªæ•°ç»„

```
import '../fave_reads.dart';

List books = [
  {
    'title': 'Head First Design Patterns',
    'author': 'Eric Freeman',
    'year': 2004
  },
  {
    'title': 'Clean Code: A handbook of Agile Software Craftsmanship',
    'author': 'Robert C. Martin',
    'year': 2008
  },
  {
    'title': 'Code Complete: A Practical Handbook of Software Construction',
    'author': 'Steve McConnell',
    'year': 2004
  },
];

class BooksController extends HTTPController {...} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åï¼Œæˆ‘ä»¬å°†æ›´æ–°`BooksController`ä¸­çš„ responder æ–¹æ³•æ¥æ“ä½œè¿™ä¸ªæ•°æ®é›†:

```
class BooksController extends HTTPController {
  @httpGet
  Future<Response> getAll() async => new Response.ok(books);

  @httpGet
  Future<Response> getSingle(@HTTPPath("index") int idx) async {
    if (idx < 0 || idx > books.length - 1) { // index out of range
      return new Response.notFound(body: 'Book does not exist');
    }
    return new Response.ok(books[idx]);
  }

  @httpPost
  Future<Response> addSingle() async {
    var book = request.body.asMap(); // `request` represents the current request. This is a property inside HTTPController base class
    books.add(book);
    return new Response.ok(book);
  }

  @httpPut
  Future<Response> replaceSingle(@HTTPPath("index") int idx) async {
    if (idx < 0 || idx > books.length - 1) { // index out of range
      return new Response.notFound(body: 'Book does not exist');
    }
    var body = request.body.asMap();
    for (var i = 0; i < books.length; i++) {
      if (i == idx) {
        books[i]["title"] = body["title"];
        books[i]["author"] = body["author"];
        books[i]["year"] = body["year"];
      }
    }
    return new Response.ok(body);
  }

  @httpDelete
  Future<Response> delete(@HTTPPath("index") int idx) async {
    if (idx < 0 || idx > books.length - 1) { // index out of range
      return new Response.notFound(body: 'Book does not exist');
    }
    books.removeAt(idx);
    return new Response.ok('Book successfully deleted.');
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*[äº†è§£é•–çš„æ•°ç»„/åˆ—è¡¨æ–¹æ³•](https://api.dartlang.org/stable/1.24.3/dart-core/List-class.html)*

å†æ¬¡é‡å¯æœåŠ¡å™¨ï¼Œå¹¶ç”¨ [Postman](https://www.getpostman.com/apps) è¿›è¡Œæµ‹è¯•ã€‚

è¯·æ³¨æ„:è¿™æ˜¯åœ¨éš”ç¦»çŠ¶æ€ä¸‹è¿è¡Œçš„ï¼Œè¿™æ„å‘³ç€ä»»ä½•å‰¯ä½œç”¨åªèƒ½åœ¨ Postman(*æˆ–ä»»ä½•å·¥å…·*)ä¼šè¯ä¸­çœ‹åˆ°ã€‚æ‰“å¼€ä¸€ä¸ªå•ç‹¬çš„ä¼šè¯(*åƒæµè§ˆå™¨*)ä¸ä¼šæ˜¾ç¤ºè¿™äº›å˜åŒ–ã€‚è¿™æ˜¯å› ä¸ºè®¾è®¡çš„éš”ç¦»ä¸å…±äº«çŠ¶æ€ã€‚ä¸è¿‡ä¸è¦æ‹…å¿ƒâ€”â€”è¿™å°†åœ¨æˆ‘ä»¬å®ç°çœŸæ­£çš„æ•°æ®åº“æ—¶å¾—åˆ°è§£å†³ã€‚

## [](#refactoring-the-solution)é‡æ„æ–¹æ¡ˆ

æˆ‘åº”è¯¥å·²ç»å®Œæˆäº†ï¼Œä½†æ˜¯è¿™å°†åœ¨ç¬¬ 3 éƒ¨åˆ†ç»™æˆ‘ä»¬å¸¦æ¥æ›´å¤šçš„å·¥ä½œã€‚æˆ‘ä¸å¸Œæœ›è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œæ‰€ä»¥è¯·åœ¨è¿™æœ€åä¸€æ®µæ—¶é—´é‡Œå®¹å¿æˆ‘ğŸ˜Š

è¿˜è®°å¾—æˆ‘è¯´è¿‡å¯ä»¥å°†è¯·æ±‚ä¸­çš„å€¼ç»‘å®šåˆ° responder æ–¹æ³•çš„å‚æ•°å—ï¼Ÿå—¯ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ„æˆ‘ä»¬çš„ POST æ“ä½œï¼Œé€šè¿‡`@HTTPBody()`å…ƒæ•°æ®:
å°†å®ƒçš„æœ‰æ•ˆè´Ÿè½½è½¬æ¢æˆ map

```
@httpPost
Future<Response> addSingle(@HTTPBody() Map book) async {
  books.add(book);
  return new Response.ok('Added new book.');
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œï¼Œå°è¯•å°†è¯·æ±‚æœ‰æ•ˆè´Ÿè½½è§£æä¸º`Map`ç±»å‹ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªè‡ªå®šä¹‰ç±»å‹ï¼Œè€Œä¸ä»…ä»…æ˜¯ä½¿ç”¨å†…ç½®ç±»å‹ï¼Œåªè¦è‡ªå®šä¹‰ç±»å‹æ‰©å±•äº†ä¸€ä¸ª`HTTPSerializable`ç±»å‹ã€‚è®©æˆ‘ä»¬é€šè¿‡åœ¨`lib/model/book.dart` :
ä¸­å¼•å…¥ä¸€ä¸ªå›¾ä¹¦æ¨¡å‹æ¥åšåˆ°è¿™ä¸€ç‚¹

```
import '../fave_reads.dart';

class Book extends HTTPSerializable {
  String title;
  String author;
  int year;

  Book({this.title, this.author, this.year});

  @override
  Map<String, dynamic> asMap() => {
    "title": title,
    "author": author,
    "year": year,
  };

  @override
  void readFromMap(Map requestBody) {
    title = requestBody["title"];
    author = requestBody["author"];
    year = requestBody["year"];
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸‹é¢æ˜¯æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…çš„æ€»ç»“:

1.  æˆ‘ä»¬çš„å›¾ä¹¦æ¨¡å‹å®ç°äº†`HTTPSerializable`ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºè§£æ HTTP è¯·æ±‚ä¿¡æ¯çš„å®ç”¨ç¨‹åº
2.  å®šä¹‰`asMap`å’Œ`readFromMap(Map requestBody)`æ–¹æ³•ã€‚ç¬¬ä¸€ä¸ªå°†åœ¨ JSON å“åº”è¢«å‘é€å›å®¢æˆ·æœºæ—¶ä½¿ç”¨ï¼Œè€Œåè€…æ£€ç´¢è¯·æ±‚ä½“å¹¶æå–æ•°æ®ä»¥å¡«å……æ¨¡å‹çš„å±æ€§ã€‚

ç°åœ¨æˆ‘ä»¬åªéœ€è¦ä½¿ç”¨è¿™ä¸ªæ¨¡å‹:

```
// lib/controller/book_controller.dart

import '../fave_reads.dart';
import 'model/book.dart';

List books = [
  new Book(
    title: 'Head First Design Patterns',
    author: 'Eric Freeman',
    year: 2004
  ),
  new Book(
    title: 'Clean Code: A handbook of Agile Software Craftsmanship', 
    author: 'Robert C. Martin', 
    year: 2008
  ),
  new Book(
    title: 'Code Complete: A Practical Handbook of Software Construction',
    author: 'Steve McConnell',
    year: 2004
  ),
];

class BooksController extends HTTPController {
  // ...
  // ...
  Future<Response> addSingle(@HTTPbody() Book book) async { // note the `Book` type being used
    books.add(book);
    return new Response.ok(book);
  }
  //...
  //...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é‡å¯æœåŠ¡å™¨ï¼Œç”¨ Postman æµ‹è¯•ç»“æœã€‚

## [](#conclusion)ç»“è®º

é€šè¿‡å……å® web APIs çš„æ¡†æ¶ï¼Œæˆ‘ä»¬å·²ç»å–å¾—äº†ä¸€äº›é‡å¤§è¿›å±•ã€‚æˆ‘å¸Œæœ›è¿™æ¬¡æ—…ç¨‹åˆ°ç›®å‰ä¸ºæ­¢æ˜¯ä¸€æ¬¡æœ‰è¶£çš„æŒ‘æˆ˜ã€‚æˆ‘é¼“åŠ±ä½ æµè§ˆä¸‹é¢çš„è¿›ä¸€æ­¥é˜…è¯»ææ–™ï¼Œä»¥æŒæ¡æˆ‘ä»¬å·²ç»è®¨è®ºè¿‡çš„æ¦‚å¿µã€‚

ä¸€å¦‚æ—¢å¾€**æˆ‘ä¹äºæ¥å—åé¦ˆ**ã€‚è®©æˆ‘çŸ¥é“ä½ å–œæ¬¢è¿™ä¸ªæ•™ç¨‹çš„ä»€ä¹ˆï¼Œä½ ä¸å–œæ¬¢ä»€ä¹ˆï¼Œä½ å¸Œæœ›åœ¨æœªæ¥çœ‹åˆ°ä»€ä¹ˆã€‚æˆ‘çœŸçš„å¾ˆæ„Ÿæ¿€ã€‚

æœ¬ç³»åˆ—çš„ç¬¬ 2 éƒ¨åˆ†åˆ°æ­¤ç»“æŸã€‚æºä»£ç åœ¨ github ä¸Š[å¯ä»¥è·å¾—ï¼Œå¹¶ä¸”ä¼šéšç€æˆ‘ä»¬åœ¨è¿™ä¸ªç³»åˆ—ä¸­çš„è¿›å±•è€Œæ›´æ–°ã€‚æ•¬è¯·å…³æ³¨æ›´å¤šå†…å®¹ã€‚](https://github.com/graphicbeacon/favereads)

* * *

## [](#further-reading)è¿›ä¸€æ­¥é˜…è¯»

*   [è·¯ç”±å’Œè·¯å¾„å˜é‡](https://aqueduct.io/docs/http/routing/)
*   [å¤„ç†è¯·æ±‚:HTTPController](https://aqueduct.io/docs/http/http_controller/)

* * *

[![graphicbeacon image](../Images/ebd69e31cdafde0c3cc551828feae27a.png)](/graphicbeacon) [## ç”¨ Dartã€Aqueduct å’Œ PostgreSQL æ„å»º RESTful Web APIs ç¬¬ 3 éƒ¨åˆ†:Postgres

### æ°æ¢…å› å¥¥è“¬ 5 æœˆ 22 æ—¥ 186 åˆ†é’Ÿé˜…è¯»

#api #webdev #dart #sql](/graphicbeacon/building-restful-web-apis-with-dart-aqueduct-and-postgresqlpart-3-postgres-9c7)

* * *

*æœ€åˆè´´åœ¨[ä»‹è´¨ä¸Š](https://itnext.io/building-restful-web-apis-with-dart-aqueduct-and-postgresql-part-2-routing-with-crud-operations-629fe58114fa)T3ã€‘*