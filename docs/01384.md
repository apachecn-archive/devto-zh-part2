# pnpm vs Yarn: monorepo èŠ‚ç‚¹æ¨¡å—

> åŸæ–‡:[https://dev . to/zkochan/pnpm-vs-yarn-monorepo-node modules-54hg](https://dev.to/zkochan/pnpm-vs-yarn-monorepo-nodemodules-54hg)

[pnpm](https://pnpm.js.org/) (ä» v2.17 å¼€å§‹)å’Œ [Yarn](https://yarnpkg.com/en/) (ä» v1.12 å¼€å§‹)éƒ½æ”¯æŒ monorepos ä¸­çš„å¿«é€Ÿå¹¶å‘å®‰è£…ã€‚ç„¶è€Œï¼Œå®ƒä»¬åœ¨ monorepos ä¸­å­˜å‚¨ä¾èµ–å…³ç³»çš„æ–¹å¼æœ‰å¾ˆå¤§çš„ä¸åŒã€‚Yarn è¯•å›¾å°†æ‰€æœ‰å·¥ä½œç©ºé—´åŒ…ä¸­çš„æ‰€æœ‰ä¾èµ–é¡¹æå‡åˆ° monorepo çš„æ ¹`node_modules`ä¸­ï¼Œè¿™æ„å‘³ç€åŒ…å¯ä»¥è®¿é—®å·¥ä½œç©ºé—´ä¸­å…¶ä»–åŒ…çš„ä¾èµ–é¡¹ã€‚è¿™åœ¨[çº±çº¿æ–‡æ¡£](https://yarnpkg.com/lang/en/docs/workspaces/#toc-limitations-caveats)ä¸­æœ‰æè¿°:

> åœ¨å·¥ä½œåŒºä¸­å‘å¸ƒåŒ…æ—¶è¦å°å¿ƒã€‚å¦‚æœæ‚¨æ­£åœ¨å‡†å¤‡æ‚¨çš„ä¸‹ä¸€ä¸ªç‰ˆæœ¬ï¼Œå¹¶ä¸”æ‚¨å†³å®šä½¿ç”¨ä¸€ä¸ªæ–°çš„ä¾èµ–é¡¹ï¼Œä½†æ˜¯å¿˜è®°åœ¨ package.json æ–‡ä»¶ä¸­å£°æ˜å®ƒï¼Œé‚£ä¹ˆå¦‚æœå¦ä¸€ä¸ªåŒ…å·²ç»å°†è¯¥ä¾èµ–é¡¹ä¸‹è½½åˆ°å·¥ä½œåŒºæ ¹ç›®å½•ä¸­ï¼Œæ‚¨çš„æµ‹è¯•ä»ç„¶å¯èƒ½åœ¨æœ¬åœ°é€šè¿‡ã€‚ç„¶è€Œï¼Œå¯¹äºä»æ³¨å†Œè¡¨ä¸­æå–å®ƒçš„æ¶ˆè´¹è€…æ¥è¯´ï¼Œå®ƒå°†è¢«ç ´åï¼Œå› ä¸ºä¾èµ–é¡¹åˆ—è¡¨ç°åœ¨ä¸å®Œæ•´ï¼Œæ‰€ä»¥ä»–ä»¬æ²¡æœ‰åŠæ³•ä¸‹è½½æ–°çš„ä¾èµ–é¡¹ã€‚ç›®å‰ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ²¡æœ‰åŠæ³•æŠ›å‡ºè­¦å‘Šã€‚

åƒçº±çº¿ä¸€æ ·ï¼Œpnpm å°†æ‰€æœ‰åŒ…è£…æå‡è‡³æ ¹éƒ¨ã€‚ç„¶è€Œï¼Œpnpm å°†æ‰€æœ‰ä¾èµ–é¡¹å­˜å‚¨åœ¨ä¸€ä¸ªéšè—çš„æ–‡ä»¶å¤¹ä¸­ï¼Œå¹¶ä¸”åªå°†æ¯ä¸ªåŒ…çš„ç›´æ¥ä¾èµ–é¡¹é“¾æ¥åˆ°å®ƒä»¬çš„`node_modules`ä¸­ã€‚

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹çœ‹ Yarn å’Œ pnpm æ˜¯å¦‚ä½•å·¥ä½œçš„:

*   æœ‰ä¸€ä¸ªå°çš„ monorepo æœ‰ä¸¤ä¸ªåŒ…:`foo`å’Œ`bar`
*   `foo`æœ‰`is-negative@1.0.0`ä½œä¸ºä¾èµ–
*   `bar`æœ‰`is-positive@1.0.0`ä½œä¸ºä¾èµ–

## çº±çº¿åœ¨è¡ŒåŠ¨

è¦ä½¿è¿™ä¸ªå›è´­ä¸ Yarn ä¸€èµ·å·¥ä½œï¼Œåœ¨å›è´­çš„æ ¹ä¸­åº”è¯¥æœ‰ä¸€ä¸ª`package.json`ï¼Œå…¶å†…å®¹å¦‚ä¸‹:

```
{  "private":  true,  "workspaces":  ["foo",  "bar"]  } 
```

Enter fullscreen mode Exit fullscreen mode

è¦å®‰è£…æ‰€æœ‰å·¥ä½œç©ºé—´åŒ…çš„æ‰€æœ‰ä¾èµ–é¡¹ï¼Œæ‚¨åº”è¯¥è¿è¡Œ`yarn install`ã€‚

> åœ¨æ­¤æŸ¥çœ‹ç»“æœ

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒYarn å°†åœ¨å›è´­çš„æ ¹ä¸­åˆ›å»ºä¸€ä¸ªåŒ…å«`is-negative`å’Œ`is-positive`çš„å•ä¸ª`node_modules`ã€‚è¿™æ„å‘³ç€`foo`å’Œ`bar`éƒ½å¯ä»¥è®¿é—®å½¼æ­¤çš„ä¾èµ–å…³ç³»ã€‚

## pnpm åœ¨è¡ŒåŠ¨

è¦è®© pnpm åœ¨è¿™ä¸ª repo ä¸­å®‰è£…ä¾èµ–é¡¹ï¼Œæ‚¨éœ€è¦åœ¨ repo çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª`pnpm-workspace.yaml`(å¯ä»¥ä¸ºç©º)å’Œä¸€ä¸ª`.npmrc`æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

```
shared-workspace-shrinkwrap = true
link-workspace-packages = true 
```

Enter fullscreen mode Exit fullscreen mode

è¦ç”¨ pnpm å®‰è£…æ‰€æœ‰å·¥ä½œç©ºé—´åŒ…çš„æ‰€æœ‰ä¾èµ–é¡¹ï¼Œåº”è¯¥è¿è¡Œ`pnpm multi install`(æˆ–è€…åªè¿è¡Œ`pnpm m i`)ã€‚

> åœ¨æ­¤æŸ¥çœ‹ç»“æœ

åƒ Yarn ä¸€æ ·ï¼Œpnpm åœ¨å›è´­çš„æ ¹ä¸­åˆ›å»ºä¸€ä¸ª`node_modules`ã€‚ç„¶è€Œï¼Œå¦‚æœä½ æ‰“å¼€é‚£ä¸ªæ–‡ä»¶å¤¹ï¼Œä½ ä¼šçœ‹åˆ°æ‰€æœ‰çš„ç›®å½•å’Œæ–‡ä»¶éƒ½éšè—åœ¨é‚£é‡Œ:

```
node_modules
+ .registry.npmjs.org
+ .modules.yaml
+ .shrinkwrap.yaml 
```

Enter fullscreen mode Exit fullscreen mode

è¿™ä¸ª`node_modules`å­˜å‚¨äº†æ‰€æœ‰çš„ä¾èµ–é¡¹ï¼Œä½†æ˜¯å®ƒä»¬è¢«éšè—åœ¨`.registry.npmjs.org`ä¸­ã€‚èŠ‚ç‚¹çš„è§£æç®—æ³•ä¸ä¼šæ‰¾åˆ°å®ƒä»¬ã€‚

ç°åœ¨ï¼Œå¦‚æœæ‚¨æ£€æŸ¥ bar çš„[ç›®å½•ï¼Œæ‚¨ä¹Ÿä¼šåœ¨é‚£é‡Œçœ‹åˆ°ä¸€ä¸ª`node_modules`ï¼Œå¸¦æœ‰ä¸€ä¸ªåä¸º`is-negative`çš„ç¬¦å·é“¾æ¥ã€‚è¿™ä¸ªç¬¦å·é“¾æ¥æŒ‡å‘`../../node_modules/.registry.npmjs.org/is-negative/1.0.0/node_modules/is-negative`ã€‚åŒæ ·ï¼Œåœ¨`foo`çš„`node_modules`ç›®å½•ä¸­æœ‰ä¸€ä¸ªæŒ‡å‘`is-positive`çš„ç¬¦å·é“¾æ¥ã€‚æ‰€ä»¥`foo`åªèƒ½è§£æ`is-positive`ï¼Œè€Œ`bar`åªèƒ½è§£æ`is-negative`ğŸ‰ğŸ˜Š](https://github.com/zkochan/comparing-monorepo-node-modules/tree/master/pnpm-example/foo)

* * *

å¦‚æ‚¨æ‰€è§ï¼Œpnpm ä¸ä»…åœ¨ä¸å•ä¸ª`package.json` ä¸€èµ·ä½¿ç”¨æ—¶æ˜¯ä¸¥æ ¼çš„[ï¼Œåœ¨å¤šåŒ…å­˜å‚¨åº“ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ã€‚](https://medium.com/pnpm/pnpms-strictness-helps-to-avoid-silly-bugs-9a15fb306308)