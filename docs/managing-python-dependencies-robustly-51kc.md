# 稳健地管理 Python 依赖关系。

> 原文：<https://dev.to/svemaraju/managing-python-dependencies-robustly-51kc>

我想写一篇关于我这周学到的一些东西的博文。我们在项目中使用一套标准的开源软件包。几乎所有这些都非常稳定，不会引起任何问题，但是在一些罕见的情况下，比我编写的代码更罕见，会有一两个 bug 被推入 PyPi。或者它甚至可能不是一个 bug，就像一个停止支持 Python 2 的新版本。

所以在这个特殊的例子中，我们的项目使用了 django-scarface 包，它帮助我们非常容易地发送 SNS 消息。我们犯的错误是没有在 requirements.txt 文件中确定版本。

```
. . 
django-scarface
. . 
```

Enter fullscreen mode Exit fullscreen mode

我之所以要谈这个，是为了演示这样的错误是如何在生产中偷袭你的。python 打包管理器 PIP 的工作方式是，每当您不指定包名的版本时，它总是安装包的最新版本。这部分大概是大家所期待的。但是如果这个包已经安装了，而你没有指定一个版本，那么即使有一个更新的版本，它也不会做任何事情。

因此，这里有一个场景，将使这个错误直到很晚才被注意到:

*   在本地-> PIP 安装->完全安装和部署-> Awesome 中创建新项目。
*   一段时间后，你部署到一个开发/质量保证/临时服务器-> PIP 安装->所有的设置在这里也很完美->太好了。
*   你手里有可发货的产品。我们去直播吧！-> PIP 安装->代码部署->它是活的乡亲！
*   现在，如果您的生产设置运行在一台服务器上，该服务器可以根据需要进行纵向扩展，那么您可能不会注意到这个错误，除非您出于某种原因必须迁移到另一台服务器。但是在很多情况下，高流量是通过水平扩展系统来处理的，方法是配置一个触发器来相应地生成或关闭系统。这意味着一个新系统总是需要全新安装整个项目，包括依赖项。现在，当 django-scarface 在其 3.2 版本中放弃对 Python 2.7 的支持时，生产设置中的下一个自动缩放触发器将导致如下所示的非常难看的错误。

```
IOError: [Errno 2] No such file or directory: '/tmp/pip-install-ji4l4h/django-scarface/django_scarface/__init__.py’ 
```

Enter fullscreen mode Exit fullscreen mode

所以我们所需要做的就是指定我们作为依赖项使用的所有包的稳定版本，这个问题将永远不会发生。你再也不用担心了。对吗？不完全是。

我们用来简化生活的这些令人敬畏的 OSS 软件包，也可能犯和我们一样的错误。他们也可能忽略了确定其依赖关系的需要，在这种情况下，您将会遇到与上面相同的问题，甚至更糟。这方面的一个例子是，芹菜使用的消息库 Kombu 发布了他们的 4.2 版本，打破了芹菜。芹菜在他们的`requirements.txt`中小心翼翼地没有为 Kombu 留下一个版本范围，当他们的`requirements.txt`阅读类似`kombu>=4.0.2,<5.0`的东西时，仍然不得不面对这个问题。

我们如何检测这样的破损？在某些情况下，构建和运行测试的 CI/CD 管道可以帮助我们检测 PIP 安装错误。这里的问题是，我们 CI/CD 管道只有在新代码被推送时才会被触发。同样在芹菜的情况下，安装没有引发任何错误，只是当芹菜服务试图启动它抛出一个错误。在这些情况下，拥有像 Sentry 这样的错误记录服务会有所帮助。处理这一问题的另一种方法是监控服务，运行详细的健康检查，如执行系统的关键部分，并确保一切按预期工作。我们强烈推荐这些实践来处理一般的生产中断/错误，它们也适用于我们的案例。

就是这样！这就是我要说的。更年轻、更天真的 python 程序员可能很难注意到这些细节。但是我现在聪明多了。我在《哨兵》中目睹了一些非常丑陋的堆栈痕迹。堆栈跟踪有助于调试，但是它们也揭示了一些看似无害的错误会导致多么可怕的结果。他们会强迫你改正错误。😂