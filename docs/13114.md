# é€šè¿‡è§‚å¯Ÿé¢‘è°±ï¼Œå­¦ä¹ å¦‚ä½•æ„å»ºå’Œæµ‹è¯• GraphQL æœåŠ¡å™¨

> åŸæ–‡:[https://dev . to/iwilsonq/learn-to-architect-and-test-graphql-servers-by-observing-spectrum-5d in](https://dev.to/iwilsonq/learn-to-architect-and-test-graphql-servers-by-observing-spectrum-5din)

# [](#learn-to-architect-and-test-graphql-servers-by-observing-spectrum)é€šè¿‡è§‚å¯Ÿé¢‘è°±å­¦ä¹ æ¶æ„å’Œæµ‹è¯• GraphQL æœåŠ¡å™¨

[![alan King](../Images/9fac27c99ed6ce2707ab296e8bc539e8.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--taG948Tp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://images.unsplash.com/photo-1501041158226-5842bd1f76ac%3Fixlib%3Drb-0.3.5%26s%3D13803e446342e7d1dd138ad63adc12f2%26dpr%3D1%26auto%3Dformat%26fit%3Dcrop%26w%3D1000%26q%3D80%26cs%3Dtinysrgb) 
ç…§ç‰‡ç”±è‰¾ä¼¦Â·é‡‘åœ¨ Unsplash ä¸Šæ‹æ‘„

æœ€è¿‘ï¼Œæˆ‘ä¸€ç›´åœ¨å¯»æ‰¾æ›´å¥½çš„æ–¹æ³•æ¥æ„å»ºå’Œæµ‹è¯• JavaScript åº”ç”¨ç¨‹åºï¼Œå°¤å…¶æ˜¯é‚£äº›ä½¿ç”¨ GraphQL çš„åº”ç”¨ç¨‹åºã€‚

å‡è®¾æˆ‘æœ‰ä¸€ä¸ªç”¨ Node.js ç¼–å†™çš„ GraphQL æœåŠ¡å™¨ï¼Œæˆ‘åº”è¯¥å¦‚ä½•å®‰æ’æˆ‘çš„æ–‡ä»¶å¤¹ç»“æ„ï¼Ÿæˆ‘åº”è¯¥æŠŠæˆ‘çš„æ¨¡å¼å’Œè§£æå™¨æ”¾åœ¨å“ªé‡Œï¼Ÿæˆ‘çš„ç±»å‹å®šä¹‰åº”è¯¥å’Œå®ƒä»¬å„è‡ªçš„è§£æå™¨æ”¾åœ¨ä¸€èµ·å—ï¼Ÿ

å¯¹äºæ‰€æœ‰ä¸åŒçš„æŸ¥è¯¢å’Œå˜å¼‚ï¼Œæµ‹è¯•æˆ‘çš„ */graphql* ç«¯ç‚¹çš„å¥½æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Ÿ

æœ€è¿‘ï¼Œ [spectrum.chat](https://spectrum.chat) å¼€æºäº†ä»–ä»¬çš„æ•´ä¸ªæ ˆã€‚è¿™æ„å‘³ç€ä½ å’Œæˆ‘å¯ä»¥å»ä»–ä»¬çš„å›è´­å¤„ç ”ç©¶ä»–ä»¬çš„æºä»£ç ã€‚æˆ‘çš„è®¡åˆ’æ˜¯è§‚å¯Ÿä»–ä»¬å¦‚ä½•æ„å»ºä»–ä»¬çš„ JavaScript åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸ºæˆ‘è‡ªå·±çš„åº”ç”¨ç¨‹åºçªƒå–ä¸€äº›æƒ³æ³•ã€‚å¸Œæœ›æˆ‘ä»¬èƒ½å¤Ÿå›ç­”æˆ‘ä¸Šé¢æå‡ºçš„ä¸€äº›é—®é¢˜ã€‚

é€šè¿‡æ·±å…¥è¿™ä¸ªå¼€æºè¯¾å ‚ï¼Œæ‚¨å¯ä»¥åƒä¸“ä¸šäººå£«ä¸€æ ·å­¦ä¹ å¦‚ä½•ä½¿ç”¨è¿™äº›æŠ€æœ¯(æ— è€»åœ°ä»ä»–ä»¬çš„è‡ªè¿°æ–‡ä»¶ä¸­çªƒå–):

*   RethinkDB:æ•°æ®å­˜å‚¨
*   Redis:åå°ä½œä¸šå’Œç¼“å­˜
*   GraphQL: APIï¼Œç”±æ•´ä¸ª Apollo å·¥å…·é“¾æä¾›æ”¯æŒ
*   Flowtype:ç±»å‹å®‰å…¨çš„ JavaScript
*   PassportJS:éªŒè¯
*   React:å‰ç«¯å’Œç§»åŠ¨åº”ç”¨
*   åšè§ˆä¼š:ç§»åŠ¨åº”ç”¨(React Native)
*   DraftJS:ç½‘ä¸Šæ‰€è§å³æ‰€å¾—çš„å†™ä½œä½“éªŒ

ä»Šå¤©ï¼Œæˆ‘ä»¬å°†ä»äº†è§£ä»–ä»¬å¸ƒå±€ GraphQL API çš„æ–¹å¼å¼€å§‹ã€‚

# [](#graphql-folder-structure)GraphQL æ–‡ä»¶å¤¹ç»“æ„

æˆ‘ä»¬é¦–å…ˆè¦çœ‹çš„æ˜¯ Spectrum çš„æ–‡ä»¶å¤¹ç»“æ„æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

```
server/
â”œâ”€â”€ loaders
â”œâ”€â”€ migrations
â”œâ”€â”€ models
â”œâ”€â”€ mutations
â”œâ”€â”€ queries
â”œâ”€â”€ routes
â”œâ”€â”€ subscriptions
â”œâ”€â”€ test
â”œâ”€â”€ types
â”‚   â””â”€â”€ scalars.js
â”œâ”€â”€ README.md
â”œâ”€â”€ index.js       # Runs the actual servers
â””â”€â”€ schema.js 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é¦–å…ˆï¼Œæˆ‘ä»¬æ³¨æ„åˆ°å·²ç»æœ‰æ–‡æ¡£æè¿°äº†åº”ç”¨ç¨‹åºçš„æ¯ä¸ªéƒ¨åˆ†åœ¨å¤„ç†ä»€ä¹ˆã€‚åœ¨é‚£é‡Œï¼Œä½ è¿˜å¯ä»¥äº†è§£åˆ°æ‰€æœ‰åç«¯æœåŠ¡çš„å¥‡æ€ªçš„å¸Œè…Šå‘½åæƒ¯ä¾‹ã€‚

*   *åŠ è½½å™¨*ä¸ºæ¯ä¸ªé¢‘è°±èµ„æºå®ç°[è„¸ä¹¦çš„æ•°æ®åŠ è½½å™¨](https://github.com/facebook/dataloader)ï¼Œä»¥ä¾¿æ‰¹é‡&ç¼“å­˜ã€‚ä¼˜åŒ–çš„ä¸œè¥¿ï¼Œä½†æˆ‘ä»¬æ‰åˆšåˆšå¼€å§‹ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä¸è¦æ‹…å¿ƒå®ƒã€‚

*   *è¿ç§»*å…è®¸å¼€å‘äººå‘˜æ’­ç§æ•°æ®ä»¥æµ‹è¯•åº”ç”¨ç¨‹åºã€‚å®ƒåŒ…å«ä¸€å †é™æ€é»˜è®¤æ•°æ®ï¼Œä½†å®ƒä¹Ÿä½¿ç”¨ [faker](https://github.com/Marak/faker.js) åº“ï¼Œå…è®¸ä½ ä¼ªé€ ä¸€å¤§å †æ•°æ®ï¼Œå¦‚ç”¨æˆ·ã€æ¸ é“å’Œæ¶ˆæ¯çº¿ç¨‹ã€‚

*   *æ¨¡å‹*æè¿° API å¦‚ä½•ä¸æ•°æ®åº“æ¥å£ï¼›å¯¹äºæ¯ä¸ªèµ„æº(ç”¨æˆ·ã€é¢‘é“ç­‰)ï¼Œéƒ½å­˜åœ¨ä¸€ç»„å‡½æ•°ï¼Œå¯ç”¨äºæŸ¥è¯¢æˆ–æ”¹å˜æ•°æ®åº“ä¸­æ•°æ®ã€‚

*   *æŸ¥è¯¢*ä¿å­˜è§£æå™¨å‡½æ•°ï¼Œæè¿°å¦‚ä½•è·å–æ•°æ®ã€å“ªäº›é¡¹ç›®ã€å­—æ®µä»¥åŠå¦‚ä½•å¯¹å®ƒä»¬è¿›è¡Œåˆ†é¡µã€‚

*   *çªå˜*ä¿å­˜è§£æå™¨å‡½æ•°ï¼Œæè¿°å¦‚ä½•åˆ›å»ºæ–°æ•°æ®ã€åˆ é™¤æˆ–æ›´æ–°ç°æœ‰æ•°æ®ã€‚

è§£æå™¨æ˜¯ä¸€ç§ç®€æ´çš„æ–¹å¼æ¥æè¿°è°ƒç”¨é€‚å½“çš„æœåŠ¡æ¥è·å–å®¢æˆ·ç«¯æ‰€éœ€æ•°æ®çš„å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘è¿™ä¸ªæŸ¥è¯¢:

```
query  GetChannelsByUser  {  user(id:  "some-user-id")  {  channels  {  members  }  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªç‰¹å®šçš„æŸ¥è¯¢é€šè¿‡ ID è·å–å•ä¸ªç”¨æˆ·ï¼ŒåŒæ—¶è¿˜è·å–ä»–ä»¬æ‰€å±çš„æ‰€æœ‰é€šé“ä»¥åŠè¿™äº›é€šé“çš„æˆå‘˜ã€‚è¦å¼„æ¸…æ¥šå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ï¼Œè¿™å°±æ˜¯è§£æå™¨åŠŸèƒ½çš„ä½œç”¨ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ‰ 3 ä¸ªè§£æå™¨å‡½æ•°:ä¸€ä¸ªè·å–ç”¨æˆ·ï¼Œä¸€ä¸ªè·å–è¯¥ç”¨æˆ·çš„é€šé“ï¼Œå¦ä¸€ä¸ªè·å–æ¯ä¸ªè·å–çš„é€šé“çš„æ‰€æœ‰æˆå‘˜ã€‚æœ€åä¸€ä¸ªè§£æå™¨åŠŸèƒ½ç”šè‡³å¯èƒ½ä¸ºæ¯ä¸ªé€šé“è¿è¡Œ n æ¬¡ã€‚

æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°è¿™ä¸ªæŸ¥è¯¢ä¼šå˜å¾—éå¸¸ç¹é‡ã€‚å¦‚æœå¤šä¸ªæ¸ é“æœ‰å‡ åƒä¸ªä¼šå‘˜å‘¢ï¼Ÿè¿™å°±æ˜¯è£…è½½æœºæ´¾ä¸Šç”¨åœºçš„åœ°æ–¹ã€‚ä½†æ˜¯æˆ‘ä»¬ä»Šå¤©ä¸å»é‚£é‡Œã€‚

*   *è®¢é˜…*å…è®¸æœåŠ¡å™¨ä½¿ç”¨ WebSocket æœåŠ¡å™¨å°†æ¶ˆæ¯å’Œé€šçŸ¥æ¨é€åˆ°ç§»åŠ¨æˆ– web å®¢æˆ·ç«¯ä¸Šçš„ç”¨æˆ·ã€‚

*   *Test* åŒ…å«å¯¹æŸ¥è¯¢å’Œå˜å¼‚æœ¬èº«çš„æµ‹è¯•ï¼Œé€šè¿‡å¯¹å®é™…æ•°æ®åº“å°è¯•æŸ¥è¯¢æ¥è¿›è¡Œã€‚æˆ‘ä»¬ç¨åä¼šè®¨è®ºå‡ ä¸ªé—®é¢˜ã€‚

*   *ç±»å‹*æ˜¯æŒ‡ GraphQL æ¨¡å¼ç±»å‹ï¼Œå¯ä»¥æŸ¥è¯¢çš„å­—æ®µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚å½“æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œé€šè¿‡å°†ç±»å‹åˆå¹¶åœ¨ä¸€èµ·æ¥åˆ›å»ºæ¨¡å¼ã€‚

*   *Routes* åŒ…å«è·¯ç”±å¤„ç†å™¨å’Œä¸­é—´ä»¶ï¼Œç”¨äºæ›´ä¼ ç»Ÿçš„ RESTful webhooksã€‚ä¾‹å­åŒ…æ‹¬æ¾å¼›é›†æˆå’Œç”µå­é‚®ä»¶é€€è®¢ã€‚

ä¸è¿™äº›æ–‡ä»¶å¤¹åœ¨åŒä¸€å±‚çš„æ˜¯`schema.js`æ–‡ä»¶ï¼Œå®ƒå°†æ‰€æœ‰çš„ç±»å‹å®šä¹‰å’Œè§£æå™¨åˆå¹¶åˆ°ä¸€ä¸ªå¯ç”¨çš„ GraphQL æ¨¡å¼ä¸­ã€‚

æœ€åæ˜¯`index.js`,å®ƒå¯åŠ¨äº†æˆ‘ä»¬çš„åç«¯ API ä»¥åŠç”¨äºå¤„ç†è®¢é˜…çš„ WebSocket æœåŠ¡å™¨ã€‚æˆ‘å¯¹æœ€åä¸€ä¸ªæ–‡ä»¶ä¸æ„Ÿå…´è¶£ï¼›æˆ‘å·²ç»çŸ¥é“å¦‚ä½•ç”¨ä¸­é—´ä»¶è®¾ç½® Node.js æœåŠ¡å™¨ã€‚

# [](#schemafirst-development)å›¾å¼ä¼˜å…ˆå‘å±•

æ ¹æ®è„¸ä¹¦çš„è§‚ç‚¹ï¼Œåœ¨å¼€å§‹ä»»ä½•ä¸šåŠ¡é€»è¾‘ä¹‹å‰ï¼Œä½ åº”è¯¥å…ˆæ„å»ºå¥½ä½ çš„æ¨¡å¼ã€‚å¦‚æœæ‚¨çš„æ¨¡å¼åšå¾—å¾ˆå¥½ï¼Œæ‚¨å¯ä»¥æ›´æœ‰ä¿¡å¿ƒæ‰§è¡Œæ‚¨çš„ä¸šåŠ¡é€»è¾‘ã€‚

## [](#extending-the-root%C2%A0types)æ‰©å±•æ ¹ç±»å‹

è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ ¹ schema.js æ–‡ä»¶ï¼Œå…¶ä¸­æ‰€æœ‰çš„æŸ¥è¯¢ã€çªå˜å’Œç±»å‹å®šä¹‰éƒ½è¢«å¯¼å…¥åˆ°é¡¹ç›®ä¸­ã€‚æˆ‘è¦æ³¨æ„æ ¹æŸ¥è¯¢çš„å½¢çŠ¶:

```
type  Query  {  dummy:  String  }  type  Mutation  {  dummy:  String  }  type  Subscription  {  dummy:  String  }  schema  {  query:  Query  mutation:  Mutation  subscription:  Subscription  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨é¡¹ç›®æ‰€æœ‰è€…çš„è¯„è®ºä¸­ï¼Œä»–ä»¬åªæ˜¯åœ¨å®šä¹‰ç±»å‹æ—¶æ‰©å±•äº†æ ¹æŸ¥è¯¢ï¼è¿™å¤ªç¥å¥‡äº†ï¼Œå› ä¸ºåœ¨æˆ‘çœ‹åˆ°è¿™ä¸ªé¡¹ç›®ä¹‹å‰ï¼Œæˆ‘ä¸€ç›´åœ¨åšè¿™æ ·çš„äº‹æƒ…:

```
type  Query  {  contents(offset:  Int  =  0,  limit:  Int  =  10):  [Content]  tags(offset:  Int  =  0,  limit:  Int  =  10):  [Tag]  users(offset:  Int  =  0,  limit:  Int  =  20,  field:  String):  [User]  # And many more queries...  }  type  Mutation  {  createContent(text:  String):  Content  updateContent(id:  ID!,  text:  String):  Content  deleteContent(id:  ID!):  Content  createUser(username:  String!):  User  updateUser(id:  ID!,  username:  String!):  User  # I don't want to write all of these here...  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°½ç®¡æˆ‘å¾ˆå–œæ¬¢æ„å¤§åˆ©é¢æ¡ï¼Œä½†è¿™ç§æ¨¡å¼åœ¨å¤§å‹åº”ç”¨ç¨‹åºä¸­è‚¯å®šä¼šå¤±æ§ã€‚è¿™å°±æ˜¯ Spectrum å¦‚ä½•æ‰©å±•ä»–ä»¬çš„æŸ¥è¯¢ï¼Œä½ ä¹Ÿå¯ä»¥ä»é˜…è¯»æ–‡æ¡£åˆ°æœ€åå­¦åˆ°è¿™ä¸€ç‚¹ã€‚

```
extend  type  Query  {  channel(id:  ID,  channelSlug:  String,  communitySlug:  String):  Channel  @cost(complexity:  1)  }  extend  type  Mutation  {  createChannel(input:  CreateChannelInput!):  Channel  editChannel(input:  EditChannelInput!):  Channel  deleteChannel(channelId:  ID!):  Boolean  # ...more Channel mutations  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#defining-input%C2%A0types)å®šä¹‰è¾“å…¥ç±»å‹

å…³äºä¸Šè¿°è¦ç‚¹ï¼Œä½ å¯èƒ½æ³¨æ„åˆ°çš„å¦ä¸€ç‚¹æ˜¯ï¼Œå®ƒä»¬çš„è¾“å…¥ç±»å‹æ²¡æœ‰åˆ—å‡ºå®ƒä»¬éœ€è¦çš„æ¯ä¸€ä¸ªå­—æ®µ(åƒæˆ‘ä¸Šé¢é‚£æ ·ğŸ˜®).

ç›¸åï¼Œä»–ä»¬ä¸ºæ¯ä¸ªä¸åŒçš„çªå˜åˆ›å»ºç‰¹å®šçš„ç±»å‹ï¼Œè¿™äº›ç±»å‹éœ€è¦æ›´å¤šçš„å‚æ•°ï¼Œè€Œä¸ä»…ä»…æ˜¯ IDã€‚è¿™äº›ç±»å‹åœ¨ GraphQL æ¨¡å¼ä¸­è¢«å®šä¹‰ä¸ºè¾“å…¥ç±»å‹ã€‚

```
input  CreateChannelInput  {  name:  String!  slug:  String!  description:  String  communityId:  ID!  isPrivate:  Boolean  isDefault:  Boolean  }  input  EditChannelInput  {  name:  String  slug:  String  description:  String  isPrivate:  Boolean  channelId:  ID!  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœä¸å…¶ç„¶ï¼Œå¦‚æœæˆ‘çœŸçš„é˜…è¯»äº†æ‰€æœ‰çš„æ–‡ä»¶ï¼Œæˆ‘å¯èƒ½ä¼šçœ‹åˆ°è¿™ä¸ªã€‚å½“æˆ‘åœ¨å†™ GraphQL APIs æ—¶ï¼Œæˆ‘è§‰å¾—æœ‰äº›éƒ¨åˆ†å¾ˆæœ‰è¶£ï¼Œâ€œä¸ºä»€ä¹ˆæˆ‘å¿…é¡»åœ¨è¿™é‡Œå†™æ‰€æœ‰è¿™äº›è¾“å…¥å­—æ®µï¼â€ï¼Œæˆ‘æƒ³ã€‚

> å½“ä½ ç”¨è›®åŠ›åšä¸€ä»¶äº‹å¾ˆå¤šæ¬¡ï¼Œç„¶åæ‰¾åˆ°æ­£ç¡®çš„æ–¹æ³•å»åšçš„æ—¶å€™ï¼Œè¿™å¯¹ä½ çœŸçš„æœ‰å¸®åŠ©ã€‚

è¿™é€‚ç”¨äºè½¯ä»¶å¼€å‘é¢†åŸŸä»¥åŠå…¶ä»–é¢†åŸŸçš„è®¸å¤šäº‹æƒ…ã€‚è¿™å°±åƒå½“ä½ å‘ç°ä½ çš„ä¹’ä¹“çƒå‡»çƒä¸€ç›´æ˜¯é”™è¯¯çš„ï¼Œå°½ç®¡å®ƒä¸ºä½ èµ¢å¾—äº†å‡ åœºæ¯”èµ›ã€‚å—¯ï¼Œæˆ‘çš„åˆ’æ°´è¿˜æ˜¯ä¸å¯¹ï¼Œä½†è‡³å°‘æˆ‘æ„è¯†åˆ°äº†ã€‚ğŸ˜…

## [](#connections-and%C2%A0edges)è¿æ¥å’Œè¾¹ç¼˜

æ„å»ºè‰¯å¥½çš„ GraphQL APIs å€¾å‘äºä¸ºå…¶æ•°æ®é›†ä¸­çš„é¡¹ç›®æä¾›ä¸€ç§æ¥å£ï¼Œè¿™ç§æ¥å£åœ¨è·å–æ•°æ®æ—¶æœ‰åŠ©äºæ¸¸æ ‡æˆ–åˆ†é¡µã€‚ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æƒ³è¦æŠ“å–ç‰¹å®šé¢‘é“ä¸­çš„æ‰€æœ‰æˆå‘˜:

```
type  Channel  {  id:  ID!  createdAt:  Date!  modifiedAt:  Date  name:  String!  description:  String!  slug:  String!  memberConnection(first:  Int  =  10,  after:  String):  ChannelMembersConnection!  @cost(complexity:  1,  multiplier:  "first")  memberCount:  Int!  # other fields omitted for brevity  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é€šè¿‡æŒ‡å®šæˆå‘˜ç±»å‹æ˜¯ä¸€ä¸ª*è¿æ¥*ï¼ŒAPI çš„æ¶ˆè´¹è€…å°†çŸ¥é“ä»–ä»¬æ­£åœ¨å¤„ç†ä¸€ä¸ªå®šåˆ¶çš„éåŸå§‹ç±»å‹ï¼Œä¸€ä¸ªç¬¦åˆä»–ä»¬çš„æ¸¸æ ‡å·¥ä½œæ–¹å¼çš„ç±»å‹ã€‚

åœ¨ spectrum API ä¸­ï¼Œä»–ä»¬ä½¿ç”¨å‚æ•°`first`å’Œ`after`æ¥å¤„ç†å…‰æ ‡ç§»åŠ¨ã€‚

*   `first`åªæ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå‘Šè¯‰æŸ¥è¯¢è¦è·å–å¤šå°‘é¡¹ï¼›ä¸€äº› API å¯¹æ­¤æœ‰é™åˆ¶ã€‚
*   `after`æ˜¯ä¸€ä¸ªä½œä¸ºåç§»é‡çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘æŒ‡å®šäº†ä¸€ä¸ªå­—ç¬¦ä¸²â€œsome-item-idâ€ï¼Œé‚£ä¹ˆå®ƒå°†è·å–è¯¥é¡¹ç›®ä¹‹åçš„ç¬¬ä¸€ä¸ª *n ä¸ª*é¡¹ç›®ã€‚åŸºæœ¬ä¸Šï¼Œé™¤äº†åœ¨ Spectrum API ä¸­ï¼Œä»–ä»¬å®é™…ä¸Šç”¨ base64 ç¼–ç ã€‚

`ChannelMembersConnection`å‹æ˜¯è¿™æ ·çš„:

```
type  ChannelMembersConnection  {  pageInfo:  PageInfo!  edges:  [ChannelMemberEdge!]  }  type  ChannelMemberEdge  {  cursor:  String!  node:  User!  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“æˆ‘ä»¬åœ¨ GraphQL ä¸­å®šä¹‰çš„ä¸€ä¸ªç±»å‹å¼•ç”¨å¦ä¸€ä¸ªè‡ªå®šä¹‰ç±»å‹æ—¶ï¼Œå°±åƒæˆ‘ä»¬çš„`Channel`å¼•ç”¨ä¸€ä¸ªæˆå‘˜(å®ƒåªæ˜¯ä¸€ä¸ª`User`)ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥åƒè¿™æ ·å®šä¹‰ç±»å‹ï¼Œä»¥ä¾¿ä¸å…¶ä»–ç±»å‹ä¸€èµ·å·¥ä½œã€‚æˆ‘ä»¬å¯èƒ½å…³å¿ƒçš„æ•°æ®åœ¨ edge çš„`node`å­—æ®µä¸­ï¼Œedge åªæ˜¯ä¸€ä¸ªè¢«è·å–çš„é¡¹ç›®çš„èŠ±å“¨æœ¯è¯­ã€‚

è¿æ¥çš„`pageInfo`å¸¦å›ä¸€äº›å…ƒæ•°æ®ï¼Œå…³äºé›†åˆä¸­æ˜¯å¦æœ‰ä¸‹ä¸€é¡µæˆ–ä¸Šä¸€é¡µã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ª membersConnection çš„è¿è¡Œæƒ…å†µã€‚

## [](#example-query-membersconnection)ç¤ºä¾‹æŸ¥è¯¢:æˆå‘˜è¿æ¥

```
export default (
  { id }: DBChannel,
  { first, after }: PaginationOptions,
  { loaders }: GraphQLContext
) => {
  const cursor = decode(after);

  const lastDigits = cursor.match(/-(\d+)$/);
  const lastUserIndex = lastDigits && lastDigits.length > 0 && parseInt(lastDigits[1], 10);

  return getMembersInChannel(id, { first, after: lastUserIndex })
    .then(users => loaders.user.loadMany(users))
    .then(result => ({
      pageInfo: {
        hasNextPage: result && result.length >= first,
      },
      edges: result.filter(Boolean).map((user, index) => ({
        cursor: encode(`${user.id}-${lastUserIndex + index + 1}`),
        node: user,
      })),
    }));
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“æˆ‘ä»¬å‘é€ä¸€ä¸ªæŸ¥è¯¢æ¥è·å–ä¸€ä¸ª`Channel`å¹¶è¯·æ±‚`membersConnection`æ—¶ï¼ŒæœåŠ¡å™¨å°†æ‰§è¡Œè¿™ä¸ªè§£æå™¨å‡½æ•°ã€‚

ä½ ä¼šæ³¨æ„åˆ°å®ƒåœ¨é¡¶éƒ¨çš„å‡½æ•°å‚æ•°ä¸­æœ‰ä¸€äº›å¥‡æ€ªçš„è¯­æ³•ã€‚æ— éœ€æƒŠæ…Œï¼›ä»–ä»¬ä½¿ç”¨[æµå‹](https://flow.org)ã€‚

è¯¥å‡½æ•°é¦–å…ˆé€šè¿‡å¯¹ after å‚æ•°è¿›è¡Œç¼–ç æ¥åˆ›å»ºä¸€ä¸ªæ¸¸æ ‡ï¼Œç„¶ååœ¨ç¼–ç åçš„å­—ç¬¦ä¸²ä¸­æœç´¢æœ€åä¸€ä½æ•°å­—ã€‚å®ƒä½¿ç”¨è¿™äº›æ•°å­—æ¥è®¡ç®—ä½•æ—¶å¼€å§‹æŸ¥è¯¢ã€‚

ç„¶åï¼Œå®ƒä»å¤„ç†ä¸æ•°æ®åº“äº¤äº’çš„å±‚ä¸­è°ƒç”¨ä¸€ä¸ªå‡½æ•°ã€‚å½“æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢æ—¶ï¼Œè¿™ä¸ªå‡½æ•°è·å–ç»“æœå¹¶æ„å»ºæˆ‘ä»¬å‰é¢æåˆ°çš„`pageInfo`å’Œ`edges`ã€‚

ä¹Ÿå¯ä»¥ä¸€çª¥å…‰æ ‡æ˜¯å¦‚ä½•ç¼–ç çš„ï¼›è¿™äº›è¾¹ç”¨é¡¹ç›®çš„ id å’Œå®ƒä»¬åœ¨æŸ¥è¯¢ç»“æœä¸­å‡ºç°çš„ç´¢å¼•ç»„æˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚è¿™æ ·ï¼Œå½“å…‰æ ‡è¢«è§£ç æ—¶ï¼Œå®ƒå°†çŸ¥é“å®ƒæ­£åœ¨æŸ¥çœ‹çš„ç±»å‹å’Œç´¢å¼•ã€‚

# [](#testing-graphql%C2%A0queries)æµ‹è¯• GraphQL æŸ¥è¯¢

æœ€è¿‘æˆ‘ä¸€ç›´åœ¨æƒ³ï¼Œæˆ‘åº”è¯¥å¦‚ä½•æµ‹è¯•æˆ‘çš„ GraphQL æœåŠ¡å™¨ï¼Ÿæˆ‘åº”è¯¥åªå¯¹è§£æå™¨åŠŸèƒ½è¿›è¡Œå•å…ƒæµ‹è¯•å—ï¼Ÿçœ‹çœ‹ Spectrumï¼Œä»–ä»¬å®é™…ä¸Šé€šè¿‡ç›´æ¥è°ƒç”¨æµ‹è¯•æ•°æ®åº“æ¥æµ‹è¯•ä»–ä»¬çš„æŸ¥è¯¢ã€‚æ ¹æ®ä»–ä»¬å›¢é˜Ÿçš„è¯´æ³•ï¼Œå½“å•å…ƒæµ‹è¯•å¥—ä»¶è¿è¡Œæ—¶ï¼Œ

> åœ¨è¿è¡Œæµ‹è¯•ä¹‹å‰ï¼Œè¿™å°†åœ¨æœ¬åœ°å»ºç«‹ä¸€ä¸ªåä¸ºâ€œtestingâ€çš„ RethinkDB æ•°æ®åº“ã€‚å®ƒå°†åœ¨å…¶ä¸Šè¿è¡Œè¿ç§»ï¼Œç„¶åæ’å…¥ä¸€äº›è™šæ‹Ÿæ•°æ®ã€‚è¿™å¾ˆé‡è¦ï¼Œå› ä¸ºæˆ‘ä»¬é’ˆå¯¹çœŸå®çš„æ•°æ®åº“æµ‹è¯•æˆ‘ä»¬çš„ GraphQL APIï¼Œæˆ‘ä»¬ä¸æ¨¡ä»¿ä»»ä½•ä¸œè¥¿ï¼Œä»¥ç¡®ä¿ä¸€åˆ‡éƒ½ 100%å·¥ä½œã€‚

åœ¨ä»–ä»¬è¿™æ ·åšä¹‹åï¼Œä»–ä»¬å¯ä»¥åˆ©ç”¨ä¸€ä¸ªè¯·æ±‚å®ç”¨ç¨‹åºå‡½æ•°ä½œä¸ºè·¯ç”±å¤„ç†ç¨‹åºï¼Œå¦åˆ™å°±ä¼šå‘½ä¸­ API çš„`/graphql`è·¯ç”±ã€‚

```
// @flow
import { graphql } from 'graphql';
import createLoaders from '../loaders';

import schema from '../schema';

type Options = {
  context?: {
    user?: ?Object,
  },
  variables?: ?Object,
};

// Nice little helper function for tests
export const request = (query: mixed, { context, variables }: Options = {}) =>
  graphql(
    schema,
    query,
    undefined,
    { loaders: createLoaders(), ...context },
    variables
); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ‰äº†è¿™ä¸ªå·¥å…·ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å¯¹æˆ‘ä»¬çš„æœåŠ¡å™¨æ‰§è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•æŸ¥è¯¢ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªç¤ºä¾‹æŸ¥è¯¢ï¼Œå¯ä»¥æµ‹è¯•æˆ‘ä»¬ä¹‹å‰æ£€æŸ¥çš„`membersConnection`æŸ¥è¯¢ã€‚

```
import { request } from '../../utils';
import { SPECTRUM_GENERAL_CHANNEL_ID } from '../../../migrations/seed/default/constants';

it('should fetch a channels member connection', async () => {
  const query = /* GraphQL */ `
    {
      channel(id: "${SPECTRUM_GENERAL_CHANNEL_ID}") {
        id
        memberConnection(after: null) {
          pageInfo {
            hasNextPage
            hasPreviousPage
          }
          edges {
            cursor
            node {
              id
              name
              contextPermissions {
                communityId
                reputation
              }
            }
          }
        }
      }
    }
  `;

  expect.assertions(1);
  const result = await request(query);

  expect(result).toMatchSnapshot();
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å‡è®¾å®ƒä»¬çš„æµ‹è¯•æ•°æ®åœ¨ä¸¤æ¬¡æ‰§è¡Œä¹‹é—´æ˜¯ç›¸åŒçš„ï¼Œæˆ‘ä»¬å®é™…ä¸Šå¯ä»¥åœ¨è¿™é‡Œåˆ©ç”¨å¿«ç…§ï¼æˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ç”¨ä¾‹ï¼›ç»™å®šä¸€äº›é»˜è®¤æ•°æ®é›†ï¼Œæ‚¨æ€»æ˜¯å¸Œæœ›æŸ¥è¯¢è¿”å›ç‰¹å®šå½¢å¼çš„æ•°æ®ã€‚

å¦‚æœä¸è¯¥æŸ¥è¯¢ç›¸å…³çš„æŸä¸ªè§£æå™¨å‡½æ•°å‘ç”Ÿäº†å˜åŒ–ï¼ŒJest ä¼šæé†’æˆ‘ä»¬æ³¨æ„å¿«ç…§ä¸­çš„å·®å¼‚ã€‚

å¤šæ£’å•Šã€‚

* * *

å¯¹æˆ‘æ¥è¯´å·®ä¸å¤šäº†ï¼Œé€šè¿‡æ¢³ç† Spectrum çš„ APIï¼Œæˆ‘ç¡®å®å­¦åˆ°äº†å¾ˆå¤šå…³äºæ„å»ºæ›´å¥½çš„ GraphQL æœåŠ¡å™¨çš„çŸ¥è¯†ã€‚

æœ‰å‡ ä»¶äº‹æˆ‘æ²¡æœ‰çœŸæ­£æ¶‰åŠï¼Œæ¯”å¦‚è®¢é˜…ã€æŒ‡ä»¤æˆ–è®¤è¯ã€‚

å¦‚æœä½ æ¸´æœ›äº†è§£è¿™äº›ä¸»é¢˜ï¼Œä¹Ÿè®¸å¯ä»¥æŸ¥çœ‹ä»¥ä¸‹é“¾æ¥:

*   é©¬å…‹æ–¯Â·æ–¯æ‰˜ä¼Šä¼¯çš„ã€Š[ä¿æŠ¤ä½ çš„ GraphQL API å…å—æ¶æ„æŸ¥è¯¢](https://dev-blog.apollodata.com/securing-your-graphql-api-from-malicious-queries-16130a324a6b)
*   Jonas Helfer çš„ã€ŠGraphQL è®¤è¯æŒ‡å—ã€‹
*   Ben Newman çš„â€œå¯é‡ç”¨çš„ GraphQL æ¨¡å¼æŒ‡ä»¤â€
*   åˆ˜å°æºçš„ã€Šé˜¿æ³¢ç½—å®¢æˆ·ç«¯ä¸­çš„ GraphQL è®¢é˜…ã€‹

å¥½å¥‡æ›´å¤šå¸–å­æˆ–è€…å¦™è¯­è¿ç ï¼Ÿåœ¨[åª’ä½“](https://medium.com/@iwilsonq)ã€ [Github](https://github.com/iwilsonq) å’Œ [Twitter](https://twitter.com/iwilsonq) ä¸Šå…³æ³¨æˆ‘å§ï¼