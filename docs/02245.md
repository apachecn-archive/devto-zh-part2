# 用一个奇怪的技巧加速你的 PostgreSQL 单元测试！

> 原文:[https://dev . to/the jessleigh/speed-up-your-PostgreSQL-unit-tests-with-one-verged-trick-364 p](https://dev.to/thejessleigh/speed-up-your-postgresql-unit-tests-with-one-weird-trick-364p)

大约几年前，我开发了一个产品，我们的单元测试像 tar 一样快。我的同事正在向她的 DBA 朋友抱怨测试，在一起探讨后，他们发现了一个 PostgreSQL 设置，它在禁用时将我们的 Jenkins 构建时间减半。经过几个月的优化尝试，这是我们的单元测试中最大的一次性能提升。

## [](#-raw-fsync-endraw-)`fsync`

`fsync`是一种 PostgreSQL 配置设置，有助于可靠性和灾难恢复。这是一个改变 PostgreSQL 写设置的布尔标志。启用时，它会尝试确保更新以物理方式写入磁盘。如果您想保护您的数据免受硬件崩溃或操作系统故障的影响，这是一个很好的安全措施。但是，它会导致显著的性能下降。

## [](#why-enable-raw-fsync-endraw-)为什么启用`fsync`？

如果您发现自己的数据库遭到破坏，这对于恢复非常有价值。默认情况下它是启用的，这是有原因的。如果您的生产性能需要改进，可以进行更安全的优化。万一发生最坏的情况，它可以将您从不可恢复的损坏数据中拯救出来。除非你有可靠的方法从外部数据源恢复数据，否则在生产中关闭`fsync`是危险的。

## [](#why-disable-raw-fsync-endraw-)为什么禁用`fsync`？

在大多数测试环境中不需要`fsync`。运行单元测试时，您可能希望至少建立和拆除一次数据库。对于您无论如何都要丢弃的东西来说，写入磁盘是一项昂贵的操作。

## [](#how-to-change-your-postgresql-config)如何更改 PostgreSQL 配置

如果您以前从未更改过 PostgreSQL 设置，那么从找出配置文件所在的位置开始。如果你不知道，你可以通过跑步找到它

`SHOW config_file;`

在您的`psql`互动终端中。这将打印出 PostgreSQL 配置文件的路径。

接下来，找到`fsync`选项。它通常位于其他预写日志选项附近。确保该行没有被注释掉，因为它默认为`on`。将`fsync`的布尔标志切换到`off`。请注意，对配置的更改需要重新启动 PostgreSQL 才能生效。

> 注意:PosgreSQL 在为服务器配置设置分配布尔值时非常灵活。`TRUE`值为`on`、`true`、`yes`、`1`。`FALSE`值为`off`、`false`、`no`和`0`。所有这些值都不区分大小写，任何一个都可以。只要确保选择一种风格，并保持一致。

最后，坐下来享受你赢回的所有时间，因为默认情况下，对测试数据库的更新不会写入磁盘。