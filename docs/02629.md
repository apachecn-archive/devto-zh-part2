# ä¼˜åŒ– Docker å›¾åƒç”¨äºç”Ÿäº§çš„é€Ÿæˆè¯¾ç¨‹

> åŸæ–‡:[https://dev . to/adnanrahic/a-crash-course-on-optimizing-your-docker-images-for-production-2f9l](https://dev.to/adnanrahic/a-crash-course-on-optimizing-your-docker-images-for-production-2f9l)

[![This months sponsor is Zeet.](../Images/a4da9440f5519d3156594813d3a02017.png)T2ã€‘](https://bit.ly/adnan-zeet)

å…è´£å£°æ˜: [Zeet](https://bit.ly/adnan-zeet) å°†åœ¨ä¸‹ä¸ªæœˆèµåŠ©è¿™ç¯‡åšå®¢ã€‚å‰å‡ å¤©æˆ‘è¯•è¿‡äº†ã€‚è¿™å°±åƒæ— æœåŠ¡å™¨ï¼Œä½†è¿è¡Œæ•´ä¸ªåç«¯ã€‚ä½ å¯ä»¥è‡ªåŠ¨æ‰˜ç®¡å’Œæ‰©å±•åº”ç”¨ã€‚ç›¸å½“æ•´æ´ã€‚

* * *

ä½ ä¸è®¨åŒéƒ¨ç½²ä½ çš„åº”ç”¨éœ€è¦å¾ˆé•¿æ—¶é—´å—ï¼Ÿå•ä¸ªå®¹å™¨æ˜ åƒè¶…è¿‡ 1gb å¹¶ä¸è¢«è§†ä¸ºæœ€ä½³å®è·µã€‚æ¯æ¬¡ä½ éƒ¨ç½²ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„æ—¶å€™éƒ½æ¨å‡ åäº¿å­—èŠ‚å¯¹æˆ‘æ¥è¯´å¬èµ·æ¥ä¸å¤ªå¯¹ã€‚

### TLï¼›é€Ÿåº¦ä¸‰è§’å½¢å®šä½æ³•(dead reckoning)

æœ¬æ–‡å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ä¼˜åŒ– Docker å›¾åƒçš„å‡ ä¸ªç®€å•æ­¥éª¤ï¼Œä½¿å®ƒä»¬æ›´å°ã€æ›´å¿«ã€æ›´é€‚åˆç”Ÿäº§ã€‚

ç›®çš„æ˜¯å‘æ‚¨å±•ç¤ºä½¿ç”¨é»˜è®¤ Node.js å›¾åƒå’Œå®ƒä»¬çš„ä¼˜åŒ–å¯¹åº”å›¾åƒä¹‹é—´çš„å¤§å°å’Œæ€§èƒ½å·®å¼‚ã€‚è¿™æ˜¯è®®ç¨‹ã€‚

*   ä¸ºä»€ä¹ˆæ˜¯ Node.jsï¼Ÿ
*   ä½¿ç”¨é»˜è®¤ Node.js å›¾åƒ
*   ä½¿ç”¨ Node.js Alpine å›¾åƒ
*   æ’é™¤å¼€å‘ä¾èµ–é¡¹
*   ä½¿ç”¨åŸºæœ¬çš„é˜¿å°”å‘æ–¯å±±å›¾åƒ
*   ä½¿ç”¨å¤šé˜¶æ®µæ„ä»¶

è®©æˆ‘ä»¬è·³è¿›æ¥ã€‚

### ä¸ºä»€ä¹ˆæ˜¯ Node.jsï¼Ÿ

Node.js æ˜¯ç›®å‰æœ€é€šç”¨å’Œåˆå­¦è€…å‹å¥½çš„åç«¯å…¥é—¨ç¯å¢ƒï¼Œæˆ‘æŠŠå®ƒä½œä¸ºæˆ‘çš„ä¸»è¦è¯­è¨€ç¼–å†™ï¼Œæ‰€ä»¥ä½ å¿…é¡»å¿å—å®ƒã€‚å‘Šæˆ‘å§ï¼Œå¯¹ã€‚ğŸ˜™

ä½œä¸ºä¸€ç§è§£é‡Šå‹è¯­è¨€ï¼ŒJavaScript æ²¡æœ‰ç¼–è¯‘ç›®æ ‡ï¼Œæ¯”å¦‚ Goã€‚æ‚¨æ— æ³•å‡å°‘ Node.js å›¾åƒçš„å¤§å°ã€‚è¿˜æ˜¯æœ‰ï¼Ÿ

æˆ‘æ¥è¯æ˜è¿™æ˜¯é”™è¯¯çš„ã€‚ä¸ºå·¥ä½œé€‰æ‹©æ­£ç¡®çš„åŸºç¡€æ˜ åƒï¼Œåªä¸ºç”Ÿäº§æ˜ åƒå®‰è£…ç”Ÿäº§ä¾èµ–é¡¹ï¼Œå½“ç„¶ï¼Œä½¿ç”¨å¤šé˜¶æ®µæ„å»ºéƒ½æ˜¯å¯ä»¥å¤§å¹…å‡è½»æ˜ åƒé‡é‡çš„æ–¹æ³•ã€‚

åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†æˆ‘ä¸ä¹…å‰ç¼–å†™çš„ä¸€ä¸ªç®€å•çš„ [Node.js API](https://github.com/adnanrahic/boilerplate-api) ã€‚

### ä½¿ç”¨é»˜è®¤çš„ Node.js å›¾åƒ

å½“ç„¶ï¼Œä»ä¸€å¼€å§‹ï¼Œæˆ‘ä½¿ç”¨äº†é»˜è®¤çš„ Node.js æ˜ åƒï¼Œå®ƒæ¥è‡ª Docker hub çš„[ã€‚å“¦ï¼Œæˆ‘æ˜¯å¤šä¹ˆçš„æ— çŸ¥ã€‚](https://hub.docker.com/) 

```
FROM node
WORKDIR /usr/src/app
COPY package.json package-lock.json ./
RUN npm install
COPY . .
EXPOSE 3000
CMD ["node", "app.js"] 
```

Enter fullscreen mode Exit fullscreen mode

æƒ³çŒœçŒœå°ºå¯¸å—ï¼Ÿæˆ‘æƒŠè®¶å¾—ç›®çªå£å‘†ã€‚ **727MB** ä¸€ä¸ªç®€å•çš„ APIï¼ï¼Ÿ

[![](../Images/db7670255b2371ae81efa88faff9411d.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--wx0QS_sJ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2A3Gvi08t7bP-agD26yk2VLQ.png)

è¯·ä¸è¦è¿™æ ·åšã€‚ä½ ä¸éœ€è¦è¿™ä¹ˆåšï¼ŒçœŸçš„ï¼Œä¸è¦ã€‚

### ä½¿ç”¨ Node.js é«˜å±±å½±åƒ

æœ€ç®€å•å¿«æ·çš„å¤§å¹…ç¼©å‡å›¾åƒå°ºå¯¸çš„æ–¹æ³•æ˜¯é€‰æ‹©ä¸€ä¸ªæ›´å°çš„åŸºç¡€å›¾åƒã€‚Alpine æ˜¯ä¸€ä¸ªå°å‹çš„ Linux å‘è¡Œç‰ˆï¼Œå¯ä»¥å®Œæˆè¿™é¡¹å·¥ä½œã€‚åªè¦é€‰æ‹© Alpine ç‰ˆæœ¬çš„ Node.js å°±ä¼šæ˜¾ç¤ºå‡ºå·¨å¤§çš„æå‡ã€‚

```
FROM node:alpine # adding the alpine tag
WORKDIR /usr/src/app
COPY package.json package-lock.json ./
RUN npm install
COPY . .
EXPOSE 3000
CMD ["node", "app.js"] 
```

Enter fullscreen mode Exit fullscreen mode

æ•´æ•´å°äº†å…­å€ï¼ä¸‹é™åˆ° **123.1MB** ã€‚è¿™è¿˜å·®ä¸å¤šã€‚

[![](../Images/010681cf746aed9df5b17014afe50e70.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Qiss6V5J--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AhLJYuKXsRHMdCtKUhk14nA.png)

### æ’é™¤å¼€å‘ä¾èµ–

å—¯â€¦â€¦ä½†æ˜¯æˆ‘ä»¬è‚¯å®šè¿˜èƒ½åšäº›åˆ«çš„ä»€ä¹ˆã€‚æˆ‘ä»¬æ­£åœ¨å®‰è£…æ‰€æœ‰ä¾èµ–é¡¹ï¼Œå°½ç®¡æˆ‘ä»¬åªéœ€è¦æœ€ç»ˆæ˜ åƒçš„ç”Ÿäº§ä¾èµ–é¡¹ã€‚æˆ‘ä»¬æ”¹å˜ä¸€ä¸‹æ€ä¹ˆæ ·ï¼Ÿ

```
FROM node:alpine
WORKDIR /usr/src/app
COPY package.json package-lock.json ./
RUN npm install --production # Only install prod deps
COPY . .
EXPOSE 3000
CMD ["node", "app.js"] 
```

Enter fullscreen mode Exit fullscreen mode

æˆ‘ä»¬èµ°å§ã€‚æˆ‘ä»¬åˆç æ‰äº† 30MBï¼ç°åœ¨é™åˆ°äº† **91.6MB** ã€‚æˆ‘ä»¬æœ‰è¿›å±•äº†ã€‚

[![](../Images/83c506707f7de14ee5a1a9ee9736954d.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--JvHMaJ4M--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2ASktWUx5Y1y8O4PirwqSvFw.png)

è¿™è®©æˆ‘æ„Ÿåˆ°éå¸¸è‡ªè±ªï¼Œæˆ‘å‡†å¤‡å°±æ­¤æ”¶å·¥ã€‚ä½†æ˜¯æˆ‘çªç„¶æƒ³åˆ°ã€‚å¦‚æœæˆ‘ä»åŸå§‹çš„é˜¿å°”å‘æ–¯å±±å›¾ç‰‡å¼€å§‹å‘¢ï¼Ÿå¦‚æœæˆ‘è‡ªå·±æŠ“å–åŸºæœ¬ Alpine æ˜ åƒå¹¶å®‰è£… Node.jsï¼Œå®ƒå¯èƒ½ä¼šæ›´å°ã€‚æˆ‘æ˜¯å¯¹çš„ï¼

### ä½¿ç”¨åŸºåœ°é«˜å±±å½±åƒ

ä½ å¯èƒ½ä¼šè®¤ä¸ºåƒè¿™æ ·çš„æ”¹å˜ä¸ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œä½†å®ƒæ¯”ä¹‹å‰çš„ç‰ˆæœ¬åˆå‡å°‘äº† 20MBã€‚

```
FROM alpine # base alpine
WORKDIR /usr/src/app
RUN apk add --no-cache --update nodejs nodejs-npm # install Node.js and npm
COPY package.json package-lock.json ./
RUN npm install --production
COPY . .
EXPOSE 3000
CMD ["node", "app.js"] 
```

Enter fullscreen mode Exit fullscreen mode

é™åˆ°ç°åœ¨çš„ **70.4MB** ã€‚è¿™æ¯”æˆ‘ä»¬å¼€å§‹çš„åœ°æ–¹å°äº† 10 å€ï¼

[![](../Images/7b41c3daebbac209c4367b2eaffebb4b.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--7zrgdqWn--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2A31zcUa1Qi34tnV-_3OMTVQ.png)

æˆ‘ä»¬ç°åœ¨èƒ½åšçš„ä¸å¤šäº†ï¼Œå¯¹å§ï¼Ÿå¯¹ä¸å¯¹â€¦ï¼Ÿ

### ä½¿ç”¨å¤šçº§æ„å»º

å—¯ï¼Œå®é™…ä¸Šï¼Œæœ‰ã€‚è®©æˆ‘ä»¬è°ˆä¸€è°ˆå±‚æ¬¡ã€‚

æ¯ä¸ª Docker å›¾åƒéƒ½æ˜¯ç”±å±‚æ„å»ºè€Œæˆçš„ã€‚æ¯ä¸€å±‚éƒ½æ˜¯ docker æ–‡ä»¶ä¸­çš„ä¸€ä¸ªå‘½ä»¤ã€‚è¿™æ˜¯ä¸Šé¢çš„æ–‡ä»¶:

```
FROM alpine # base alpine
WORKDIR /usr/src/app
RUN apk add --no-cache --update nodejs nodejs-npm # install Node.js and npm
COPY package.json package-lock.json ./
RUN npm install --production
COPY . .
EXPOSE 3000
CMD ["node", "app.js"] 
```

Enter fullscreen mode Exit fullscreen mode

FROM æŒ‡ä»¤åˆ›å»ºä¸€ä¸ªå±‚ï¼ŒWORKDIR ä¹Ÿæ˜¯ï¼ŒRUN ä¹Ÿæ˜¯ï¼Œç­‰ç­‰ã€‚æ‰€æœ‰å±‚éƒ½æ˜¯åªè¯»çš„ï¼Œé™¤äº†æœ€åä¸€å±‚ CMDï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯å†™å±‚ã€‚åªè¯»å›¾å±‚å¯ä»¥åœ¨å®¹å™¨ä¹‹é—´å…±äº«ï¼Œè¿™æ„å‘³ç€ä¸€ä¸ªå›¾åƒå¯ä»¥åœ¨å®¹å™¨ä¹‹é—´å…±äº«ã€‚

è¿™é‡Œå‘ç”Ÿçš„äº‹æƒ…æ˜¯ Docker ä½¿ç”¨å­˜å‚¨é©±åŠ¨ç¨‹åºæ¥ç®¡ç†åªè¯»å±‚å’Œå¯å†™å®¹å™¨å±‚ã€‚ä¸€æ—¦å®¹å™¨è¢«åˆ é™¤ï¼Œè¿™æ˜¯è¢«åˆ é™¤çš„çŸ­æš‚å±‚ã€‚å¾ˆé…·çš„ä¸œè¥¿ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦å‘¢ï¼Ÿ

é€šè¿‡å‡å°‘å±‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°æ›´å°çš„å›¾åƒã€‚è¿™å°±æ˜¯ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºçš„åˆ‡å…¥ç‚¹ã€‚

```
FROM  alpine  AS  multistage
WORKDIR /usr/src/app
RUN apk add --no-cache --update nodejs nodejs-npm
COPY package.json package-lock.json ./
RUN npm install --production
â€‹
#
â€‹
FROM alpine
WORKDIR /usr/src/app
RUN apk add --no-cache --update nodejs
COPY --from=multistage /usr/src/app/node\_modules ./node\_modules
COPY . .
EXPOSE 3000
CMD ["node", "app.js"] 
```

Enter fullscreen mode Exit fullscreen mode

æˆ‘ä»¬åªä½¿ç”¨ç¬¬ä¸€ä¸ªæ˜ åƒæ¥å®‰è£…ä¾èµ–é¡¹ï¼Œç„¶ååœ¨æˆ‘ä»¬çš„æœ€ç»ˆæ˜ åƒä¸­ï¼Œæˆ‘ä»¬å¤åˆ¶æ‰€æœ‰ node_modulesï¼Œè€Œä¸æ„å»ºæˆ–å®‰è£…ä»»ä½•ä¸œè¥¿ã€‚æˆ‘ä»¬ç”šè‡³å¯ä»¥è·³è¿‡åœ¨æœ€ç»ˆæ˜ åƒä¸­å®‰è£… **npm** ï¼

æƒ³çŒœçŒœæœ€ç»ˆå°ºå¯¸å—ï¼Ÿå»å§ï¼

[![](../Images/a604c51d2b45d68e4c31d787bead194d.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--lEm2-Ppg--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AW-3Dyv-HSeBvZVoXfoySFw.png)

æˆ‘è¦è¯´æˆ‘ä»¬åšå¾—å¾ˆå¥½ï¼Œå°†å®ƒé™åˆ°äº† 48.6 MB(T1)ï¼Œè¿™æ˜¯ T2 çš„ 15 å€(T3)ï¼Œæ˜¯ä¸€ä»¶å€¼å¾—éª„å‚²çš„äº‹æƒ…ã€‚

### åˆ¤å†³ç»“æœ

åˆ«å¤©çœŸäº†ï¼Œç»å¯¹æ²¡æœ‰ç†ç”±åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨åƒå…†å­—èŠ‚å¤§å°çš„å›¾åƒã€‚ä¸€ä¸ªå¾ˆå¥½çš„ç¬¬ä¸€æ­¥æ˜¯ä½¿ç”¨ä¸€ä¸ªå¾®å°çš„åŸºç¡€å›¾åƒã€‚ä»å°å¤„ç€æ‰‹ï¼Œå¾ªåºæ¸è¿›ã€‚

é€šè¿‡é€‰æ‹©ä¼˜åŒ–çš„åŸºæœ¬å›¾åƒï¼Œä½ ä¼šèµ°å¾—å¾ˆè¿œã€‚å¦‚æœä½ çœŸçš„éœ€è¦éƒ¨ç½²é€Ÿåº¦çš„æå‡ï¼Œå¹¶ä¸”è¢«ç¼“æ…¢çš„ CI/CD ç®¡é“æ‰€å›°æ‰°ï¼Œçœ‹çœ‹[å¤šé˜¶æ®µæ„å»º](https://docs.docker.com/develop/develop-images/multistage-build/)ã€‚ä½ ä»¥åä¸ä¼šæƒ³ç”¨å…¶ä»–æ–¹å¼ã€‚

***æ³¨æ„*** *:æˆ‘ç¡®å®é—æ¼äº†ä¸€ä¸ªç¤ºä¾‹ï¼Œå…¶ä¸­åŒ…å«äº†éƒ¨ç½²åˆ°ç”Ÿäº§ä¹‹å‰è¿è¡Œæµ‹è¯•çš„å¼€å‘ä¾èµ–é¡¹ï¼Œå› ä¸ºå®ƒä¸ç”Ÿäº§ä¸­è¿è¡Œçš„æœ€ç»ˆè§„æ¨¡ç¼©å‡æ— å…³ã€‚å½“ç„¶ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ç”¨ä¾‹ï¼æ¬¢è¿åœ¨ä¸‹é¢çš„è¯„è®ºä¸­åŠ å…¥ä½ çš„æƒ³æ³•ã€‚æˆ‘å¾ˆæƒ³å¬å¬ä½ çš„æƒ³æ³•ï¼*

å¦‚æœä½ æƒ³æŸ¥çœ‹æˆ‘ä»¥å‰å…³äº Docker å’Œ Kubernetes çš„ DevOps ç›¸å…³æ–‡ç« ï¼Œè¯·éšæ„å‰å¾€[æˆ‘çš„ä¸ªäººèµ„æ–™](https://dev.to/adnanrahic)ã€‚

å¸Œæœ›ä½ ä»¬å–œæ¬¢è¯»è¿™ç¯‡æ–‡ç« ï¼Œå°±åƒæˆ‘å–œæ¬¢å†™è¿™ç¯‡æ–‡ç« ä¸€æ ·ã€‚ä½ è§‰å¾—è¿™ä¸ªæ•™ç¨‹ä¼šå¯¹æŸä¸ªäººæœ‰å¸®åŠ©å—ï¼Ÿä¸è¦çŠ¹è±«åˆ†äº«ã€‚å¦‚æœä½ å–œæ¬¢å®ƒï¼Œç²‰ç¢ä¸‹é¢çš„ç‹¬è§’å…½ï¼Œè¿™æ ·å…¶ä»–äººå°±ä¼šåœ¨ DEV.to. ä¸Šçœ‹åˆ°å®ƒ

* * *