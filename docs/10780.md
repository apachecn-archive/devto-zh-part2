# æ¨å®¢å®šåˆ¶è®¤è¯

> åŸæ–‡:[https://dev.to/kayis/pusher-custom-authentication-o0n](https://dev.to/kayis/pusher-custom-authentication-o0n)

ä¸Šå‘¨ï¼Œæˆ‘å‚åŠ äº†æœ‰å²ä»¥æ¥ç¬¬ä¸€æ¬¡å¼€å‘ç«èµ›ï¼Œå¹¶æäº¤äº†ä¸€ä¸ªæ— æœåŠ¡å™¨çš„å¤šäººç‚¹å‡»å™¨æ¸¸æˆã€‚

### [è¦æ˜¯èƒ½æ‹¿åˆ°ä½ çš„â¤ï¸å°±å¤ªæ£’äº†&ğŸ¦„åœ¨æˆ‘çš„å…¥é—¨å¸–ä¸Š](https://dev.to/kayis/startup-clix-serverless-pusher-contest-entry-written-in-javascript-1jai)

ä½œä¸ºå›æŠ¥ï¼Œæˆ‘ä¹Ÿæƒ³ç»™ä½ ä¸€äº›è¯€çªã€‚

# ä¸ºæ¨é€å™¨å®šåˆ¶è®¤è¯

Pusher å…è®¸è‡ªå®šä¹‰æˆæƒè€…ï¼Œå¯ä»¥ä¸ºæ‚¨èŠ‚çœå¤§é‡è¯·æ±‚ã€‚

## ä»€ä¹ˆ

Pusher çš„æˆæƒè€…åªæ˜¯ä¸€ä¸ªä»¥ä¸€ä¸ª`context`ã€ä¸€ä¸ª`socketId`å’Œä¸€ä¸ª`callback`ä¸ºå‚æ•°çš„å‡½æ•°ã€‚

```
function customAuth(context, socketId, callback) {
  ... 
} 
```

Enter fullscreen mode Exit fullscreen mode

å½“ä½ è¯•å›¾åŠ å…¥ä¸€ä¸ªç§æœ‰çš„æˆ–è€…åœ¨çº¿çš„é€šé“æ—¶ï¼Œå®ƒè¢«æ¨é€å®¢æˆ·ç«¯è°ƒç”¨ã€‚

å¸¸è§„å®ç°å‘æ‚¨çš„åç«¯å‘é€ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œæ‚¨å¿…é¡»è¿”å›ä¸€ä¸ªä»¤ç‰Œï¼Œå®¢æˆ·ç«¯å°†ä½¿ç”¨è¯¥ä»¤ç‰Œè¿æ¥ Pusherã€‚

`socketId`æ˜¯å®¢æˆ·ç«¯çš„å½“å‰å¥—æ¥å­— IDã€‚

è®¤è¯å®Œæˆåéœ€è¦è°ƒç”¨`callback`ã€‚

```
// The first argument needs to be false if everything went well
// and the second one needs to include the credentials from the server
callback(false, authCredentials);

// The first argument needs to be true if the authentication failed
// and the second one can be a error description
callback(true, errorText); 
```

Enter fullscreen mode Exit fullscreen mode

## ä¸ºä»€ä¹ˆ

æ¯æ¬¡å®¢æˆ·ç«¯è®¢é˜…ç§æœ‰æˆ–åœ¨çº¿é€šé“æ—¶éƒ½ä¼šè°ƒç”¨ authoriser å‡½æ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯æ¬¡éƒ½ä¼šå‘é€ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œå› æ­¤ï¼Œæ ¹æ®ä¸€ä¸ªå®¢æˆ·ç«¯åœ¨çŸ­æ—¶é—´å†…åŠ å…¥çš„é€šé“æ•°é‡ï¼Œåˆå¹¶è¿™äº›è¯·æ±‚å¯èƒ½æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚

æ­¤å¤–ï¼Œåœ¨æˆ‘åˆ›å»ºçš„æ¸¸æˆä¸­ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä»æœåŠ¡å™¨è·å¾—å…³äºåŠ å…¥å“ªä¸ªé¢‘é“çš„ä¿¡æ¯ã€‚å› æ­¤ï¼Œæ‚¨æœ€ç»ˆä¼šæ”¶åˆ°ä¸€ä¸ªè·å–é€šé“çš„è¯·æ±‚å’Œä¸€ä¸ªéªŒè¯é€šé“çš„è¯·æ±‚ã€‚ä½¿ç”¨è‡ªå®šä¹‰æˆæƒå™¨ï¼Œæ‚¨å¯ä»¥åœ¨é€‰æ‹©é€šé“çš„åŒä¸€ä¸ªè¯·æ±‚ä¸­åˆ›å»º`authCredentials`ã€‚

## å¦‚ä½•

### å¸¸è§„è®¤è¯

å¸¸è§„è®¤è¯è¿‡ç¨‹å¦‚ä¸‹:

1.  å®¢æˆ·ç«¯è¿æ¥åˆ°æ¨é€å™¨å¹¶è·å¾—ä¸€ä¸ª`socketId`
2.  å®¢æˆ·ç«¯å°è¯•è®¢é˜…ç§æœ‰æˆ–åœ¨çº¿é¢‘é“
3.  å®¢æˆ·ç«¯å°†å…¶`socketId`å’Œ`channelName`å‘é€ç»™æœåŠ¡å™¨(æ‚¨çš„æœåŠ¡å™¨ï¼Œè€Œä¸æ˜¯æ¨é€æœåŠ¡å™¨)
4.  æœåŠ¡å™¨è¦æ±‚æ¨é€å™¨ API ä¸º`channelName`è®¤è¯`socketId`
5.  Pusher API åˆ›å»ºäº†`authCredentials`,å®ƒè¢«å‘é€å›å®¢æˆ·ç«¯
6.  å®¢æˆ·ç«¯ä½¿ç”¨`authCredenatials`æ¥è®¢é˜…é¢‘é“

æœåŠ¡å™¨ç«¯è®¤è¯çœ‹èµ·æ¥åƒè¿™æ ·

```
const authCredentials = pusher.authenticate(
  socketId,
  channelName,
  {user_id: socketId}
); 
```

Enter fullscreen mode Exit fullscreen mode

å‚æ•°å¯ä»¥é€šè¿‡ HTTP æŸ¥è¯¢å‚æ•°æˆ–ä¸»ä½“è¿›å…¥ï¼Œè€Œ`authCredentials`éœ€è¦é€šè¿‡ HTTP å‘é€å›å®¢æˆ·ç«¯ã€‚

### è‡ªå®šä¹‰éªŒè¯

ä¸€ä¸ªè‡ªå®šä¹‰ç‰ˆæœ¬ï¼Œå°±åƒæˆ‘åœ¨æ¸¸æˆä¸­ä½¿ç”¨çš„ä¸€æ ·ï¼Œçœ‹èµ·æ¥ä¼šæœ‰æ‰€ä¸åŒã€‚

ä»¥å‰

1.  å®¢æˆ·ç«¯è¿æ¥åˆ°æ¨é€å™¨å¹¶è·å¾—ä¸€ä¸ª`socketId`
2.  å®¢æˆ·ç«¯å‘æœåŠ¡å™¨è¯·æ±‚ä¸€ä¸ª`channelName`
3.  å®¢æˆ·ç«¯ä»æœåŠ¡å™¨è·å¾—ä¸€ä¸ª`channelName`
4.  å®¢æˆ·ç«¯å°è¯•ä½¿ç”¨`channelName`è®¢é˜…æ¨é€é¢‘é“
5.  å®¢æˆ·ç«¯ä»æœåŠ¡å™¨è·å–`authCredentials`
6.  å®¢æˆ·ç«¯é€šè¿‡`authCredentials`è®¢é˜…æ¨é€é¢‘é“

åœ¨...ä¹‹å

1.  å®¢æˆ·ç«¯è¿æ¥åˆ°æ¨é€å™¨å¹¶è·å¾—ä¸€ä¸ª`socketId`
2.  å®¢æˆ·ç«¯å‘æœåŠ¡å™¨è¯·æ±‚ä¸€ä¸ª`channelName`
3.  å®¢æˆ·ç«¯ä»æœåŠ¡å™¨è·å¾—ä¸€ä¸ª`channelName`å’Œ`authCredentials`
4.  å®¢æˆ·ç«¯é€šè¿‡`authCredentials`è®¢é˜…æ¨é€é¢‘é“

æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸¤ä¸ªæ–°é›¶ä»¶ã€‚ä¸€ä¸ªæ–°çš„æˆæƒè€…ï¼Œå®ƒä¸ä¼šè°ƒç”¨æœåŠ¡å™¨ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€äº›æœ¬åœ°æ•°æ®è¿›è¡Œè®¤è¯ï¼Œå¹¶åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­ä»æœåŠ¡å™¨è·å–`channelName`å’Œ`authCredentials`ã€‚

è®©æˆ‘ä»¬ä»åé¢å¼€å§‹ï¼Œå¦‚ä½•ä»æœåŠ¡å™¨è·å–è¿™ä¸¤ä¸ªä¿¡æ¯ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å‘ Pusher å®¢æˆ·ç«¯æ·»åŠ ä¸€ä¸ªæ–°æ–¹æ³•ã€‚

```
pusher.subscribeServerChannel = function() {
  const {socket_id} = pusher.connection;

  return fetch("/getChannel?socketId=" + socket_id)
  .then(r => r.json())
  .then(({channelName, authCredentials}) => {
    // used by the authoriser later
    pusher.config.auth.preAuth[channelName] = authCredentials;

    // calls the autoriser
    return pusher.subscribe(channelName);
  })
}; 
```

Enter fullscreen mode Exit fullscreen mode

è¿™ä¸ªå‡½æ•°å°è¯•è®¢é˜…å®ƒä»æœåŠ¡å™¨(æ‚¨çš„åç«¯)è¯·æ±‚çš„é¢‘é“ã€‚`GET /getChannel`ç«¯ç‚¹éœ€è¦`socketId`æ¥åˆ›å»º`authCredentials`ï¼Œç„¶å`channelName`ä¹Ÿå°†åœ¨æœåŠ¡å™¨ç«¯åˆ›å»ºã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ–°çš„æˆæƒäººï¼Œä¹Ÿæ˜¯å®¢æˆ·ç«¯ã€‚

é¦–å…ˆè·å–æ—§çš„ï¼Œç„¶åå°†æ–°çš„æ·»åŠ åˆ°å…¶ä¸­ã€‚åœ¨ä¹‹å‰çš„æ‰€æœ‰*æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè¿æ¥ã€‚* 

```
const supportedAuthorizers = Pusher.Runtime.getAuthorizers();

supportedAuthorizers.preAuthenticated = function(context, socketId, callback) {
  const { authOptions, channel } = this;

  // getting the credentials we saved in subscribeServerChannel
  const authCredentials = authOptions.preAuth[channel.name];

  if (authCredentials) return callback(false, authCredentials);

  callback(true, "You need to pre-authenticate for channel: " + channel.name);
};

Pusher.Runtime.getAuthorizers = () => supportedAuthorizers;

// Later when the connection is created

const pusher = new Pusher(APP_KEY, {
  auth: {
    preAuth: {} // where the auth credentials will be stored
  },
  // set the transport to the new authoriser
  authTransport: "preAuthenticated",
}); 
```

Enter fullscreen mode Exit fullscreen mode

æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼Œåˆ›å»º`channelName`å¹¶å¤„ç†è®¤è¯çš„æœåŠ¡å™¨ç«¯ç‚¹ã€‚

```
server.get("/getChannel", (req, res) => {
  const {socketId} = req.query;
  const channelName = "private-" + Math.random();

  const authCredentials = pusher.authenticate(socketId, channelName, {user_id: socketId});

  res.send({channelName, authCredentials});
}); 
```

Enter fullscreen mode Exit fullscreen mode

åœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ç®€å•åœ°è°ƒç”¨`subscribeServerChannel`å¹¶å¾—åˆ°ä¸€ä¸ªæ¨é€é€šé“ä½œä¸ºå›æŠ¥ã€‚

```
 const pusher = new Pusher(APP_KEY, {
    auth: { preAuth: {} },
    authTransport: "preAuthenticated",
    ...
  });

  pusher.connection.bind("connected", async () =>
    const channel = await pusher.subscribeServerChannel();
    channel.bind("my:event", ...);
  ); 
```

Enter fullscreen mode Exit fullscreen mode

åŸºæœ¬ä¸Šå°±æ˜¯è¿™æ ·ã€‚

æ‚¨åªéœ€å‘å‡ºä¸€ä¸ªè¯·æ±‚ï¼Œå°±å¯ä»¥è·å¾—åŠ å…¥å®¢æˆ·ç«¯é€šé“æ‰€éœ€çš„æ‰€æœ‰æ•°æ®ã€‚

## ç»“è®º

Pusher å®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªéå¸¸çµæ´»çš„è½¯ä»¶ï¼Œå…è®¸æ‚¨æ ¹æ®è‡ªå·±çš„å–œå¥½ä¿®æ”¹è®¤è¯æµç¨‹ã€‚è¿™å¤§å¤§ç®€åŒ–äº†é›†æˆï¼Œå¹¶ä¸”ä»é•¿è¿œæ¥çœ‹å…è®¸ä¸€äº›æ€§èƒ½è°ƒæ•´ã€‚

## ç«èµ›

å¦å¤–ï¼Œå¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« :

### [æˆ‘å¾ˆæ¬£èµä½ çš„â¤ï¸ &ğŸ¦„åœ¨æˆ‘çš„å…¥é—¨å¸–ä¸Š](https://dev.to/kayis/startup-clix-serverless-pusher-contest-entry-written-in-javascript-1jai)