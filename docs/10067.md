# å¦‚ä½•ä¸º Docker å®¹å™¨è®¾ç½®æ—¥å¿—å¾ªç¯

> åŸæ–‡:[https://dev . to/yk yuen/how-to-setup-log-rotation-for-docker-container-4alp](https://dev.to/ykyuen/how-to-setup-log-rotation-for-docker-container-4alp)

*æœ€åˆå‘å¸ƒåœ¨[æ°´æ‰‹é•¿åšå®¢](https://blog.boatswain.io/post/docker-container-log-rotation/)ä¸Šã€‚*

* * *

## æˆ‘ä»¬éƒ½éœ€è¦æ—¥å¿—ï¼

æœ‰æ—¶å€™å’Œ [Docker](https://www.docker.com/) ä¸€èµ·å·¥ä½œè®©æˆ‘æ„Ÿè§‰åƒæ˜¯åœ¨å’Œä¸€ä¸ªé»‘ç›’ä¸€èµ·å·¥ä½œï¼Œå°¤å…¶æ˜¯åœ¨ç©æ¥è‡ªç¤¾åŒºçš„ [Docker](https://www.docker.com/) å›¾ç‰‡çš„æ—¶å€™ï¼Œå®ƒå¹¶æ²¡æœ‰æŒ‰ç…§é¢„æœŸçš„æ–¹å¼è¿›è¡Œã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè¯»å–æ—¥å¿—ä¼šå ç”¨è°ƒè¯•çš„å¾ˆå¤§ä¸€éƒ¨åˆ†æ—¶é—´ã€‚

[![](../Images/c7a954d7fc7d8c2bdca973726a398a16.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--0NTA-1ye--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/iwf9nqcvpp6bp8e4av5x.jpg)

è¿™ç¯‡æ–‡ç« æ˜¯å…³äºä¸º [Docker](https://www.docker.com/) å®¹å™¨è®¾ç½®æ—¥å¿—è½®æ¢çš„ã€‚

## é»˜è®¤çš„æ—¥å¿—è®°å½•é©±åŠ¨

æˆ‘ä»¬å¯ä»¥ä¸ºå®¹å™¨é…ç½®ä¸åŒçš„æ—¥å¿—é©±åŠ¨ç¨‹åºï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹å™¨çš„ **stdout** å’Œ **stderr** è¢«å†™å…¥ä½äº */var/lib/docker/containers/ã€å®¹å™¨æ ‡è¯†ã€‘/ã€å®¹å™¨æ ‡è¯†ã€‘-json.log* çš„ json æ–‡ä»¶ä¸­ã€‚å¦‚æœæ‚¨è®©å®ƒæ— äººçœ‹ç®¡ï¼Œå®ƒå¯èƒ½ä¼šå ç”¨å¤§é‡çš„ç£ç›˜ç©ºé—´ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

[![A large log file in json format](../Images/a2c389ab594b07b339050d9166e477a0.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--5vV0Aro0--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ewyzkc6d6pjiorzwaszz.jpg)

### æ‰‹åŠ¨æ¸…é™¤æ—¥å¿—

å¦‚æœè¿™ä¸ª json æ—¥å¿—æ–‡ä»¶å ç”¨äº†å¤§é‡ç£ç›˜ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¸…é™¤å®ƒã€‚

```
truncate -s 0 <logfile> 
```

Enter fullscreen mode Exit fullscreen mode

æˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ª cronjob æ¥å®šæœŸæ¸…é™¤è¿™äº› json æ—¥å¿—æ–‡ä»¶ï¼Œä½†æ˜¯ä»é•¿è¿œæ¥çœ‹ï¼Œè®¾ç½®æ—¥å¿—è½®æ¢ä¼šæ›´å¥½ã€‚

## è®¾ç½®æ—¥å¿—æ—‹è½¬

### é…ç½®é»˜è®¤çš„æ—¥å¿—è®°å½•é©±åŠ¨

è¿™å¯ä»¥é€šè¿‡åœ¨ */etc/docker/daemon.json* ä¸­æ·»åŠ ä»¥ä¸‹å€¼æ¥å®Œæˆã€‚å¦‚æœè¯¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·åˆ›å»ºå®ƒã€‚

```
{  "log-driver":  "json-file",  "log-opts":  {  "max-size":  "10m",  "max-file":  "10"  }  } 
```

Enter fullscreen mode Exit fullscreen mode

json-file æ—¥å¿—é©±åŠ¨æœ‰æ›´å¤šçš„é€‰é¡¹ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥æ¢æˆå…¶ä»–æ—¥å¿—é©±åŠ¨ï¼Œæ¯”å¦‚ *syslog* ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ [Docker æ–‡æ¡£-é…ç½®æ—¥å¿—é©±åŠ¨](https://docs.docker.com/config/containers/logging/configure/)ã€‚

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥é‡æ–°åŠ è½½æ›´æ–°åçš„ *daemon.json* ã€‚é‡æ–°å¯åŠ¨åï¼Œæ–°é…ç½®å°†åº”ç”¨äºæ‰€æœ‰æ–°åˆ›å»ºçš„å®¹å™¨ã€‚

```
$ systemctl daemon-reload

$ systemctl restart docker 
```

Enter fullscreen mode Exit fullscreen mode

### ä¸ºå®¹å™¨é…ç½®æ—¥å¿—é©±åŠ¨

å¦‚æœæ‚¨ä¸æƒ³å…¨å±€åº”ç”¨å®ƒï¼Œä¹Ÿå¯ä»¥åœ¨å®¹å™¨çº§åˆ«è¿›è¡Œé…ç½®ã€‚

#### docker è¿è¡Œå‘½ä»¤

æˆ‘ä»¬å¯ä»¥åœ¨ *docker run* å‘½ä»¤ä¸­æŒ‡å®šæ—¥å¿—é©±åŠ¨ç¨‹åºå’Œé€‰é¡¹ã€‚æ¯”å¦‚:

```
$ docker run \
    --log-driver json-file \
    --log-opt max-size=10m \
    --log-opt max-file=10 \
    alpine echo hello world 
```

Enter fullscreen mode Exit fullscreen mode

#### ä½¿ç”¨ docker-compose

ä¹Ÿå¯ä»¥ä½¿ç”¨ docker-compose é…ç½®æ—¥å¿—é©±åŠ¨ç¨‹åºå’Œé€‰é¡¹ã€‚ä¾‹å¦‚:

```
version: '3.2'
services:
  nginx:
    image: 'nginx:latest'
    ports:
      - '80:80'
    logging:
      driver: "json-file"
      options:
        max-size: "1k"
        max-file: "3" 
```

Enter fullscreen mode Exit fullscreen mode

éªŒè¯è®¾ç½®æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

[![The logs are broken down into 1k files](../Images/09779e6ae8b7e34f31b48fcc33ed0581.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--bE2wId7I--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/8rmiccbwvjvkn6a0rvh3.jpg)

## æ€»ç»“

å°½ç®¡é»˜è®¤è®¾ç½®å¾ˆå¥½ï¼Œä½†æ‚¨æ°¸è¿œä¸çŸ¥é“å®¹å™¨æ—¥å¿—ä½•æ—¶ä¼šå ç”¨æ‰€æœ‰ç£ç›˜ç©ºé—´ï¼Œè¿™å¯ä»¥é€šè¿‡ä¸Šé¢çš„å‡ ä¸ªæ­¥éª¤æ¥é¿å…ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ—¥å¿—æ˜¯é‡è¦çš„èµ„äº§ï¼Œå®ƒä¸ä»…åœ¨å‡ºé”™æ—¶æœ‰ç”¨ï¼Œè€Œä¸”åŒ…å«è®¸å¤šéšè—çš„ä»·å€¼ã€‚æ‰€ä»¥æ°¸è¿œä¸è¦è®©åŸæœ¨ç¦»å¼€ã€‚

å¦‚æœä½ æ­£åœ¨å¯»æ‰¾ä¸€ä¸ª**æ—¥å¿—ç®¡ç† SAAS è§£å†³æ–¹æ¡ˆ**ï¼Œè€ƒè™‘ä½¿ç”¨[æ°´æ‰‹é•¿](https://boatswain.io/)ï¼Œæˆ‘ä»¬ä¼šå¸®åŠ©ä½ ç®¡ç†æ‰€æœ‰çš„æ—¥å¿—ä»¥åŠç›‘æ§ä½ çš„ [Docker](https://www.docker.com/) æœåŠ¡å™¨ã€‚ğŸ’«

[![Insufficient facts always invite danger](../Images/1f44622856f03aaaf0489fe420fc32b8.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--lVE4ZvxZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/bq2s1t4uivetgtremwxg.jpg)

> äº‹å®ä¸è¶³æ€»æ˜¯æ‹›è‡´å±é™©ã€‚
> -æ–¯æ³¢å…‹@æ˜Ÿé™…è¿·èˆª