# ä½¿ç”¨â€œesmâ€åœ¨æ²¡æœ‰ Babel/Webpack çš„èŠ‚ç‚¹ä¸­ä½¿ç”¨ ES æ¨¡å—

> åŸæ–‡:[https://dev . to/Hugo _ _ df/use-es-modules-in-node-without-babel webpack-using-ESM-1 obk](https://dev.to/hugo__df/use-es-modules-in-node-without-babelwebpack-using-esm-1obk)

Node å·²ç»åœ¨æœ¬æœºå®ç°è¶Šæ¥è¶Šå¤šçš„ ES6+ (ESNext)ç‰¹æ€§ã€‚å®ç°æ—¶é—´æœ€é•¿çš„ç‰¹æ€§ä¹‹ä¸€æ˜¯æ¨¡å—ã€‚è¿™æ ·åšçš„åŸå› æ˜¯ Node å’Œ npm è¿è¡Œåœ¨æ‰€è°“çš„ CommonJS ä¸Šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`require(` `'` `module-name` `'` `)`ä»å…¶ä»–æ¨¡å—å¯¼å…¥ï¼Œå¹¶ä½¿ç”¨`module.exports`å¯¹è±¡ä»æ¨¡å—ä¸­å…¬å¼€å®ä½“ã€‚

Node çš„ CommonJS å®é™…ä¸Šæ˜¯ JavaScript ä¸­æœ€å…ˆè¢«å¹¿æ³›é‡‡ç”¨çš„æ¨¡å—ç³»ç»Ÿä¹‹ä¸€ã€‚äººä»¬å¯ä»¥è½»æ¾åœ°æ†ç»‘ CommonJSï¼ŒåŠ ä¸Šå®ƒåœ¨èŠ‚ç‚¹åº”ç”¨ç¨‹åºå’Œå·¥å…·ä¸­çš„å¹¿æ³›ä½¿ç”¨ï¼Œè¿™æ„å‘³ç€ CommonJS å¾ˆå¿«å–ä»£äº† RequireJS å’Œ SystemJSï¼Œç”¨äºå‰ç«¯åº”ç”¨ç¨‹åºä¾èµ–å’Œæ¨¡å—ç®¡ç†

CommonJS æœ‰ä¸€äº›ç¼ºç‚¹ï¼Œæ¯”å¦‚éš¾ä»¥è¿›è¡Œé™æ€åˆ†æï¼Œè¿™å¯¼è‡´äº†è‡ƒè‚¿çš„åŒ…ã€‚å®ƒä¹Ÿä¸æ˜¯ ECMAScript è§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼Œè€Œ ES æ¨¡å—æ˜¯ã€‚

å¯¹äºé‚£äº›ä»ç„¶æ„Ÿåˆ°ç–‘æƒ‘çš„äººï¼ŒECMAScript(æˆ– ES)æ¨¡å—ä½¿ç”¨å¸¦æœ‰`import thing from 'my-module';`æˆ–`import { something } from 'my-module'`çš„è¯­æ³•æ¥å¯¼å…¥å†…å®¹ï¼Œä½¿ç”¨`export default`æˆ–`export something`æ¥å…¬å¼€æ¨¡å—ä¸­çš„å®ä½“ã€‚

åƒ Webpackã€Rollup å’Œ package è¿™æ ·çš„æ†æ‰æœºæ”¯æŒ ES æ¨¡å—ã€‚å¯¹äºèŠ‚ç‚¹æœåŠ¡å™¨ï¼Œæˆ‘ä»ç„¶å€¾å‘äºç”¨ CommonJS é£æ ¼ç¼–å†™ï¼Œå› ä¸º Node å¯¹å¤§å¤šæ•° ESNext ç‰¹æ€§éƒ½æœ‰å¾ˆå¥½çš„ç°æˆæ”¯æŒ(ä¾‹å¦‚ rest/spreadã€async/awaitã€destructuringã€classã€é€Ÿè®°å¯¹è±¡è¯­æ³•),è€Œä¸”æˆ‘ä¸å–œæ¬¢æä¹± bundlers å’Œ transpilersã€‚

æˆ‘å‘ç°äº† [esm](https://github.com/standard-things/esm) æ¨¡å—ï¼Œâ€œä»Šå¤©çš„æ˜å¤©çš„ ECMAScript æ¨¡å—ï¼â€ç”±[çº¦ç¿°-å¤§å«Â·é“å°”é¡¿](https://github.com/jdalton)(æ´›è¾¾ä»€ğŸ˜„).å®ƒå…è®¸æ‚¨åœ¨ Node ä¸­ä½¿ç”¨ ES æ¨¡å—ï¼Œè€Œæ— éœ€ç¼–è¯‘æ­¥éª¤ã€‚å®ƒå¾ˆå°ï¼Œå ç”¨ç©ºé—´å¾ˆå°ï¼Œå¹¶ä¸”é™„å¸¦äº†ä¸€äº›é¢å¤–çš„å¥½ä¸œè¥¿

ä»¥ä¸‹æ˜¯ä¸€äº›æ²¡æœ‰ä¸¥æ ¼è®°å½•çš„ä½¿ç”¨æ–¹æ³•ã€‚è¿™æ¶µç›–äº†ç”¨ä¾‹ï¼Œå¦‚ es æ¨¡å—çš„å¢é‡é‡‡ç”¨(å³å°†ä¸€äº›æ¨¡å—è½¬æ¢ä¸º ESMï¼Œä½†ä¸æ˜¯æ•´ä¸ªåº”ç”¨ç¨‹åº)ã€‚ä½¿ç”¨è¿™ä¸ªå°†å¸®åŠ©ä½ åˆ†äº«

## [](#import-default-export-from-an-es-module-in-commonjs)å¯¼å…¥é»˜è®¤ä» CommonJS ä¸­çš„ ES æ¨¡å—å¯¼å‡º

```
const esmImport = require('esm')(module);
const foo = esmImport('./my-foo');
console.log(foo); 
```

## [](#import-named-exports-from-an-es-module-in-commonjs)ä» CommonJS ä¸­çš„ ES æ¨¡å—å¯¼å…¥å‘½åå¯¼å‡º

```
const esmImport = require('esm')(module);
const { bar, baz } = esmImport('./my-foo');
console.log(bar, baz); 
```

## [](#reexport-an-es-module-as-commonjs)å°† ES æ¨¡å—é‡æ–°å¯¼å‡ºä¸º CommonJS

è¿™åœ¨æ–‡æ¡£ä¸­æœ‰è®°å½•ï¼Œä½†æˆ‘æƒ³ä¸ºäº†å®Œæ•´èµ·è§æˆ‘ä¼šæŠŠå®ƒåŒ…æ‹¬åœ¨å†…

```
module.exports = require('esm')(module)('./my-es-module');
// see the docs
// https://github.com/standard-things/esm#getting-started 
```

## [](#load-whole-application-using-es-modules)ä½¿ç”¨ ES æ¨¡å—åŠ è½½æ•´ä¸ªåº”ç”¨

åŒæ ·ï¼Œè¿™åœ¨æ–‡æ¡£ä¸­ï¼Œä½†ä¸ºäº†å®Œæ•´èµ·è§å°†å…¶åŒ…æ‹¬åœ¨å†…

```
node -r esm app.js
// see the docs
// https://github.com/standard-things/esm#getting-started 
```

## [](#using-toplevel-await)ä½¿ç”¨é¡¶çº§ await

å‡è®¾æˆ‘ä»¬æœ‰è¿™ä¸ªæ¨¡å—`cli.module.js`(å–è‡ª[github.com/HugoDF/wait-for-pg](https://github.com/HugoDF/wait-for-pg/blob/master/wait-for-pg-cli.module.js#L35-L44)):

```
const waitForPostgres = () => Promise.resolve();

try {
  await waitForPostgres();
  console.log('Success');
  process.exit(0);
} catch (error) {
  process.exit(1);
} 
```

æœ‰è¶£çš„æ˜¯ï¼Œè¿™æ˜¯åœ¨æ²¡æœ‰ä½¿ç”¨`async`å‡½æ•°çš„æƒ…å†µä¸‹ä½¿ç”¨`await`ã€‚è¿™æ˜¯`esm`å…è®¸ä½ åšçš„äº‹æƒ…ã€‚è¿™å¯ä»¥é€šè¿‡åœ¨`package.json`ä¸­è®¾ç½®`"``esm``"``: {``"``await``"``: true }`æ¥å¯ç”¨ï¼Œä½†ä¹Ÿå¯ä»¥åœ¨è½¬æ¢æ—¶é—´`cli.js` :
æ—¶å¯ç”¨

```
const esmImport = require('esm')(module, { await: true });
module.exports = esmImport('./cli.module'); 
```

ç§ï¼Œå®ƒå·¥ä½œäº†:

```
$ node cli.js
Success 
```

è¿™å°±ç»“æŸäº†å¦‚ä½•ä½¿ç”¨ ES æ¨¡å—ï¼Œè€Œä¸éœ€è¦ç¿»è¯‘ã€‚é€šè¿‡ä¸€ä¸ªæ¨¡å—/å‘½ä»¤è¡Œç•Œé¢çš„ä¾‹å­ï¼Œå¯ä»¥æ›´å…¨é¢åœ°äº†è§£è¿™åœ¨ [ES6 ä¸­æ„å‘³ç€ä»€ä¹ˆã€‚](https://dev.to/hugo__df/es6-by-example-a-modulecli-to-wait-for-postgres-in-docker-compose-902)

å¦‚æœä½ å¯¹â€œJavaScript æ¨¡å—ã€æ†ç»‘+ä¾èµ–ç®¡ç†çš„å†å²â€è¿™ç¯‡æ–‡ç« æ„Ÿå…´è¶£ï¼Œè¯·é€šè¿‡[è®¢é˜…](https://buttondown.email/hugo)å‘Šè¯‰æˆ‘ã€‚