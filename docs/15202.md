# å¦‚ä½•ä½¿ç”¨ Swift æ„å»ºå®æ—¶è¡¨æ ¼

> åŸæ–‡:[https://dev . to/neo/how-to-build-a-real time-table-using-swift-cje](https://dev.to/neo/how-to-build-a-realtime-table-using-swift--cje)

é€šå¸¸ï¼Œå½“æ‚¨æ„å»ºä¾›ä»–äººä½¿ç”¨çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œæ‚¨éœ€è¦åœ¨æŸç§è¡¨æˆ–åˆ—è¡¨ä¸­è¡¨ç¤ºæ•°æ®ã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸€ä¸ªç”¨æˆ·åˆ—è¡¨ï¼Œæˆ–è€…ä¸€ä¸ªå……æ»¡è¶³çƒè”ç›Ÿæ•°æ®çš„è¡¨ã€‚ç°åœ¨ï¼Œå‡è®¾å¡«å……è¡¨çš„æ•°æ®å°†è¢«é‡æ–°æ’åºæˆ–æ›´æ”¹ï¼Œå¦‚æœæŸ¥çœ‹è¡¨ä¸Šæ•°æ®çš„æ¯ä¸ªäººéƒ½èƒ½ç«‹å³çœ‹åˆ°æ‰€åšçš„æ›´æ”¹ï¼Œé‚£å°±å¤ªå¥½äº†ã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæ‚¨å°†çœ‹åˆ°å¦‚ä½•ä½¿ç”¨ iOS å’Œ Pusher åˆ›å»ºä¸€ä¸ªåœ¨æ‰€æœ‰è®¾å¤‡ä¸Šå®æ—¶æ›´æ–°çš„è¡¨æ ¼ã€‚ä½ å¯ä»¥åœ¨ä¸‹é¢çœ‹åˆ°åº”ç”¨ç¨‹åºå¦‚ä½•å·¥ä½œçš„å±å¹•è®°å½•ã€‚

[![](../Images/e069d38fd884f295afd9cdeee7feccac.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--vA5uoWfv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://blog.pusher.com/wp-content/uploads/2017/11/How-to-build-a-realtime-table-using-Swift-6.gif)

åœ¨ä¸Šé¢çš„è®°å½•ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°åœ¨ä¸€ä¸ªè®¾å¤‡ä¸Šå¯¹è¡¨æ‰€åšçš„æ›´æ”¹æ˜¯å¦‚ä½•ç«‹å³é•œåƒåˆ°å¦ä¸€ä¸ªè®¾å¤‡ä¸Šçš„ã€‚è®©æˆ‘ä»¬è€ƒè™‘å¦‚ä½•ä½¿ç”¨ Pusher å’Œ Swift æ¥å®ç°è¿™ä¸€ç‚¹ã€‚

## [](#requirements-for-building-a-realtime-table-on-ios)åœ¨ iOS ä¸Šæ„å»ºå®æ—¶è¡¨æ ¼çš„è¦æ±‚

ä¸ºäº†å®Œæˆæœ¬æ•™ç¨‹ï¼Œæ‚¨éœ€è¦æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰è¦æ±‚:
â€“å®‰è£…åœ¨æ‚¨æœºå™¨ä¸Šçš„ MacBook Pro
â€“[Xcode](https://developer.apple.com/xcode/)â€“[Swift](https://developer.apple.com/swift/)å’Œä½¿ç”¨ Xcode
çš„åŸºæœ¬çŸ¥è¯†â€“å®‰è£…åœ¨æ‚¨æœºå™¨ä¸Šçš„ JavaScript(node . js)
â€“[node . js](https://docs.npmjs.com/getting-started/installing-node)å’Œ NPM
â€“[Cocoapods](http://www.raywenderlich.com/12139/introduction-to-cocoapods)* * * *çš„åŸºæœ¬çŸ¥è¯†ã€‚
â€“ä¸€ä¸ª[æ¨æ†](https://pusher.com)åº”ç”¨ã€‚

ä¸€æ—¦ä½ å…·å¤‡äº†ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶ï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬ç»§ç»­è¿™ç¯‡æ–‡ç« ã€‚

## [](#preparing-our-environment-to-create-our-application)å‡†å¤‡æˆ‘ä»¬çš„ç¯å¢ƒä»¥åˆ›å»ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åº

å¯åŠ¨ Xcode å¹¶åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ã€‚éµå¾ªæ–°å»ºåº”ç”¨ç¨‹åºå‘å¯¼ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„**å•é¡µåº”ç”¨ç¨‹åº**ã€‚åˆ›å»ºé¡¹ç›®åï¼Œå…³é—­ Xcode å¹¶å¯åŠ¨ç»ˆç«¯ã€‚

åœ¨ç»ˆç«¯çª—å£ä¸­ï¼Œ`cd`åˆ° app ç›®å½•çš„æ ¹ç›®å½•ï¼Œè¿è¡Œå‘½ä»¤`pod init`ã€‚è¿™å°†ç”Ÿæˆä¸€ä¸ª **Podfile** ã€‚

å°† **Podfile** çš„å†…å®¹æ›´æ–°ä¸ºä»¥ä¸‹å†…å®¹(å°†`PROJECT_NAME`æ›¿æ¢ä¸ºæ‚¨çš„é¡¹ç›®åç§°):

```
 platform :ios, '9.0'
    target 'PROJECT_NAME' do
      use_frameworks!
      pod 'PusherSwift', '~> 4.1.0'
      pod 'Alamofire', '~> 4.4.0'
    end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¿å­˜ **Podfile** ï¼Œç„¶ååœ¨æ‚¨çš„ç»ˆç«¯çª—å£ä¸Šè¿è¡Œå‘½ä»¤:`pod install`ã€‚è¿è¡Œè¿™ä¸ªå‘½ä»¤å°†å®‰è£…æˆ‘ä»¬æ„å»ºå®æ—¶åº”ç”¨ç¨‹åºæ‰€éœ€çš„æ‰€æœ‰ç¬¬ä¸‰æ–¹åŒ…ã€‚

å®‰è£…å®Œæˆåï¼Œæ‰“å¼€é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„`**.xcworkspace**`æ–‡ä»¶ã€‚è¿™åº”è¯¥ä¼šå¯åŠ¨ Xcodeã€‚ç°åœ¨æˆ‘ä»¬å‡†å¤‡å¼€å§‹åˆ›å»ºæˆ‘ä»¬çš„ iOS åº”ç”¨ç¨‹åºã€‚

## [](#building-the-user-interface-of-our-realtime-table-on-ios)åœ¨ iOS ä¸Šæ„å»ºæˆ‘ä»¬çš„å®æ—¶è¡¨æ ¼çš„ç”¨æˆ·ç•Œé¢

ä¸€æ—¦ Xcode å®ŒæˆåŠ è½½ï¼Œæˆ‘ä»¬ç°åœ¨å°±å¯ä»¥å¼€å§‹æ„å»ºæˆ‘ä»¬çš„ç•Œé¢äº†ã€‚

æ‰“å¼€`Main.storyboard`æ–‡ä»¶ã€‚å°†å¯¼èˆªæ§åˆ¶å™¨æ‹–æ”¾åˆ°æƒ…èŠ‚æè¦ä¸­ï¼Œå¹¶å°†å…¥å£ç‚¹è®¾ç½®ä¸ºæ–°çš„å¯¼èˆªæ§åˆ¶å™¨ã€‚ç°åœ¨ï¼Œæ‚¨çš„æ•…äº‹æ¿ä¸­åº”è¯¥æœ‰è¿™æ ·çš„å†…å®¹:

[![](../Images/762db5c6e8cdd2ee8ee041c420762711.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--RoracnMA--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.pusher.com/wp-content/uploads/2017/11/How-to-build-a-realtime-table-using-Swift-1.png)

æ­£å¦‚åœ¨æˆªå›¾ä¸­çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„å¯¼èˆªæ§åˆ¶å™¨ï¼Œæˆ‘ä»¬å·²ç»å°†é™„åŠ åˆ°å®ƒçš„è¡¨æ ¼è§†å›¾æ§åˆ¶å™¨ä½œä¸ºæˆ‘ä»¬çš„æ ¹è§†å›¾æ§åˆ¶å™¨ã€‚

ç°åœ¨æˆ‘ä»¬éœ€è¦å‘è¡¨æ ¼å•å…ƒæ ¼æ·»åŠ ä¸€ä¸ªé‡ç”¨æ ‡è¯†ç¬¦ã€‚å•å‡»åŸå‹å•å…ƒæ ¼ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªæ–°çš„é‡ç”¨æ ‡è¯†ç¬¦ã€‚

[![](../Images/a11ba904ca2ef1016ee8f6c4d49fe992.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--U1RfBh4n--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.pusher.com/wp-content/uploads/2017/11/How-to-build-a-realtime-table-using-Swift-2.png)

æˆ‘ä»¬å·²ç»å°†æˆ‘ä»¬çš„é‡ç”¨æ ‡è¯†ç¬¦å‘½åä¸ºç”¨æˆ·**T2ï¼Œä½†æ˜¯æ‚¨å¯ä»¥éšæ„ç§°å‘¼è¿™ä¸ªé‡ç”¨æ ‡è¯†ç¬¦ã€‚æ¥ä¸‹æ¥ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„`TableViewController`ï¼Œå¹¶ä½¿ç”¨æ•…äº‹æ¿çš„èº«ä»½æ£€æŸ¥å™¨å°†å®ƒé™„åŠ åˆ°æ ¹è§†å›¾æ§åˆ¶å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤º:**

[![](../Images/a7eaff1d61138d953ed29f1eea73e4c6.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--4mnDGx0z--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.pusher.com/wp-content/uploads/2017/11/How-to-build-a-realtime-table-using-Swift-3.png)

å¤ªå¥½äº†ï¼ç°åœ¨æˆ‘ä»¬å·²ç»å®Œæˆäº†åº”ç”¨ç¨‹åºçš„ç”¨æˆ·ç•Œé¢ï¼Œè®©æˆ‘ä»¬å¼€å§‹åˆ›å»ºå°†å¡«å……å¹¶ä½¿æˆ‘ä»¬çš„ iOS è¡¨å®æ—¶åŒ–çš„é€»è¾‘ã€‚

## [](#populating-our-ios-table-with-user-data-and-manipulating-it)ç”¨ç”¨æˆ·æ•°æ®å¡«å……æˆ‘ä»¬çš„ iOS è¡¨å¹¶æ“ä½œå®ƒ

æˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯ç”¨ä¸€äº›æ¨¡æ‹Ÿæ•°æ®å¡«å……æˆ‘ä»¬çš„è¡¨ã€‚ä¸€æ—¦æˆ‘ä»¬åšåˆ°äº†è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ·»åŠ å’Œæµ‹è¯•æˆ‘ä»¬å¸Œæœ›è¡¨æ‹¥æœ‰çš„æ‰€æœ‰å¯èƒ½çš„æ“ä½œï¼Œæ¯”å¦‚ç§»åŠ¨è¡Œã€åˆ é™¤è¡Œå’Œå‘è¡¨ä¸­æ·»åŠ æ–°è¡Œã€‚

æ‰“å¼€ä½ çš„`UserTableViewController`ã€‚ç°åœ¨åˆ é™¤æ–‡ä»¶ä¸­é™¤äº†`viewDidLoad`ä¹‹å¤–çš„æ‰€æœ‰å‡½æ•°ï¼Œè¿™æ ·æ–‡ä»¶å°±æ¸…æ™°äº†ã€‚ä½ åº”è¯¥æœ‰è¿™æ ·çš„ä¸œè¥¿ï¼Œå½“ä½ å®Œæˆ:

```
 import UIKit

    class UserTableViewController: UITableViewController {

        override func viewDidLoad() {
            super.viewDidLoad()
        }
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨è®©æˆ‘ä»¬æ·»åŠ ä¸€äº›æ¨¡æ‹Ÿæ•°æ®ã€‚åˆ›å»ºä¸€ä¸ªæ–°å‡½æ•°ï¼Œè¯¥å‡½æ•°åº”è¯¥ä» API åŠ è½½æ•°æ®ã€‚ä½†æ˜¯ç°åœ¨ï¼Œæˆ‘ä»¬å°†å¯¹æ•°æ®è¿›è¡Œç¡¬ç¼–ç ã€‚å°†ä»¥ä¸‹åŠŸèƒ½æ·»åŠ åˆ°æ§åˆ¶å™¨:

```
 private func loadUsersFromApi() {
        users = [
            [
                "id": 1,
                "name" : "John Doe",
            ],
            [
                "id": 2,
                "name": "Jane Doe"
            ]
        ]
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨å®ä¾‹åŒ–ç±»å£°æ˜ä¸‹ç±»å³è¾¹çš„`users`å±æ€§:

```
 var users:[NSDictionary] = [] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ€åï¼Œåœ¨`viewDidLoad`å‡½æ•°ä¸­ï¼Œè°ƒç”¨`loadUsersFromApi`æ–¹æ³•:

```
 override func viewDidLoad() {
        super.viewDidLoad()

        loadUsersFromApi()
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ æ‰€æœ‰çš„å‡½æ•°ï¼Œä½¿æˆ‘ä»¬çš„è¡¨è§†å›¾æ§åˆ¶å™¨ä¸
`UITableViewController`å…¼å®¹ï¼Œä»è€Œæ˜¾ç¤ºæˆ‘ä»¬çš„æ•°æ®ã€‚å°†ä»¥ä¸‹å‡½æ•°æ·»åŠ åˆ°è§†å›¾æ§åˆ¶å™¨:

```
 // MARK: - Table view data source

    override func numberOfSections(in tableView: UITableView) -> Int {
        return 1
    }

    override func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return users.count
    }

    override func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let cell = tableView.dequeueReusableCell(withIdentifier: "user", for: indexPath)
        cell.textLabel?.text = users[indexPath.row]["name"] as! String?
        return cell
    }

    override func tableView(_ tableView: UITableView, moveRowAt sourceIndexPath: IndexPath, to destinationIndexPath: IndexPath) {
        let movedObject = users[sourceIndexPath.row]
        users.remove(at: sourceIndexPath.row)
        users.insert(movedObject, at: destinationIndexPath.row)
    }

    override func tableView(_ tableView: UITableView, commit editingStyle: UITableViewCellEditingStyle, forRowAt indexPath: IndexPath) {
        if editingStyle == .delete {
            self.users.remove(at: indexPath.row)
            self.tableView.deleteRows(at: [indexPath], with: .automatic)
        }
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸Šé¢çš„ä»£ç æœ‰ 5 ä¸ªåŠŸèƒ½ã€‚ç¬¬ä¸€ä¸ªå‡½æ•°å‘Šè¯‰è¡¨æ ¼æˆ‘ä»¬çš„è¡¨æ ¼æœ‰å¤šå°‘éƒ¨åˆ†ã€‚ä¸‹ä¸€ä¸ªå‡½æ•°å‘Šè¯‰è¡¨æœ‰å¤šå°‘ç”¨æˆ·(æˆ–è¡Œ)ã€‚ç¬¬ä¸‰ä¸ªå‡½æ•°åœ¨æ¯æ¬¡åˆ›å»ºä¸€è¡Œæ—¶è¢«è°ƒç”¨ï¼Œè´Ÿè´£ç”¨æ•°æ®å¡«å……å•å…ƒæ ¼ã€‚ç¬¬å››ä¸ªå’Œç¬¬äº”ä¸ªå‡½æ•°æ˜¯å›è°ƒå‡½æ•°ï¼Œåˆ†åˆ«åœ¨ç§»åŠ¨æˆ–åˆ é™¤æ•°æ®æ—¶è°ƒç”¨ã€‚

ç°åœ¨ï¼Œå¦‚æœæ‚¨è¿è¡Œæ‚¨çš„åº”ç”¨ç¨‹åºï¼Œæ‚¨åº”è¯¥çœ‹åˆ°æ˜¾ç¤ºçš„æ¨¡æ‹Ÿæ•°æ®ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬çœ‹ä¸åˆ°â€œæ·»åŠ â€æˆ–â€œç¼–è¾‘â€æŒ‰é’®ã€‚å› æ­¤ï¼Œè®©æˆ‘ä»¬æ·»åŠ è¯¥åŠŸèƒ½ã€‚

åœ¨`viewDidLoad`å‡½æ•°ä¸­æ·»åŠ ä»¥ä¸‹å‡ è¡Œ:

```
 navigationItem.title = "Users List"
    navigationItem.rightBarButtonItem = self.editButtonItem
    navigationItem.leftBarButtonItem = UIBarButtonItem(barButtonSystemItem: .add, target: self, action: #selector(showAddUserAlertController)) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸¤ä¸ªæŒ‰é’®ï¼Œå·¦æŒ‰é’®å’Œå³æŒ‰é’®ã€‚å·¦è¾¹æ˜¯æ·»åŠ æŒ‰é’®ï¼Œå³è¾¹æ˜¯ç¼–è¾‘æŒ‰é’®ã€‚

åœ¨ add æŒ‰é’®ä¸­ï¼Œå®ƒè°ƒç”¨ä¸€ä¸ª`showAddUserAlertController`æ–¹æ³•ã€‚æˆ‘ä»¬çš„ä»£ç ä¸­è¿˜æ²¡æœ‰å®šä¹‰ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ·»åŠ å®ƒã€‚å°†ä»¥ä¸‹åŠŸèƒ½æ·»åŠ åˆ°æ‚¨çš„è§†å›¾æ§åˆ¶å™¨:

```
 public func showAddUserAlertController() {
        let alertCtrl = UIAlertController(title: "Add User", message: "Add a user to the list", preferredStyle: .alert)

        // Add text field to alert controller
        alertCtrl.addTextField { (textField) in
            self.textField = textField
            self.textField.autocapitalizationType = .words
            self.textField.placeholder = "e.g John Doe"
        }

        // Add cancel button to alert controller
        alertCtrl.addAction(UIAlertAction(title: "Cancel", style: .cancel, handler: nil))

        // "Add" button with callback
        alertCtrl.addAction(UIAlertAction(title: "Add", style: .default, handler: { action in
            if let name = self.textField.text, name != "" {
                self.users.append(["id": self.users.count, "name" :name])
                self.tableView.reloadData()
            }
        }))

        present(alertCtrl, animated: true, completion: nil)
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“å•å‡» add æŒ‰é’®æ—¶ï¼Œä»£ç åªæ˜¯åˆ›å»ºä¸€ä¸ªè­¦å‘Šã€‚è¯¥è­¦æŠ¥æœ‰ä¸€ä¸ª`textField`ï¼Œå®ƒå°†è·å–æ‚¨æƒ³è¦æ·»åŠ çš„ç”¨æˆ·çš„åç§°ï¼Œå¹¶å°†å…¶é™„åŠ åˆ°`users`å±æ€§ä¸­ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨ç±»å£°æ˜:
ä¹‹åå£°æ˜æ§åˆ¶å™¨ä¸Šçš„`textField`å±æ€§

```
 var textField: UITextField! 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰äº†ä¸€ä¸ªæ²¡æœ‰è¿æ¥åˆ°ä»»ä½• API çš„å·¥ä½œåŸå‹ã€‚å¦‚æœæ‚¨åœ¨æ­¤æ—¶è¿è¡Œåº”ç”¨ç¨‹åºï¼Œæ‚¨å°†èƒ½å¤Ÿçœ‹åˆ°æ‰€æœ‰çš„å‡½æ•°ï¼Œå®ƒä»¬å°†ä¼šå·¥ä½œï¼Œä½†æ˜¯ä¸ä¼šè¢«æŒä¹…åŒ–ï¼Œå› ä¸ºå®ƒæ˜¯ç¡¬ç¼–ç çš„ã€‚

[![](../Images/8d1e69a5da2b036c389ca86751b58b60.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--BaSpmWzc--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.pusher.com/wp-content/uploads/2017/11/How-to-build-a-realtime-table-using-Swift-4.png)

å¾ˆå¥½ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªæ•°æ®æºã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†éœ€è¦åˆ›å»ºä¸€ä¸ª Node.js åç«¯ï¼Œç„¶åæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°†èƒ½å¤Ÿè°ƒç”¨å®ƒæ¥æ£€ç´¢æ•°æ®ã€‚æ­¤å¤–ï¼Œå½“é€šè¿‡é‡æ–°æ’åºæˆ–åˆ é™¤ä¿®æ”¹æ•°æ®æ—¶ï¼Œè¯·æ±‚è¢«å‘é€åˆ°åç«¯ï¼Œæ›´æ”¹è¢«å­˜å‚¨åœ¨é‚£é‡Œã€‚

## [](#adding-api-calls-to-our-ios-table-application)å‘æˆ‘ä»¬çš„ iOS è¡¨æ ¼åº”ç”¨ç¨‹åºæ·»åŠ  API è°ƒç”¨

ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä»å°šæœªåˆ›å»ºçš„è¿œç¨‹æ•°æ®æºä¸­æ£€ç´¢æ•°æ®å¼€å§‹(æˆ‘ä»¬å°†åœ¨æœ¬æ–‡åé¢åˆ›å»ºå®ƒ)ã€‚

**ä» API** åŠ è½½ç”¨æˆ·
è¿”å›åˆ°`loadUsersFromApi`æ–¹æ³•ï¼Œç”¨ä¸‹é¢çš„ä»£ç æ›¿æ¢å†…å®¹:

```
 private func loadUsersFromApi() {
        indicator.startAnimating()

        Alamofire.request(self.endpoint + "/users").validate().responseJSON { (response) in
            switch response.result {
            case .success(let JSON):
                self.users = JSON as! [NSDictionary]
                self.tableView.reloadData()
                self.indicator.stopAnimating()
            case .failure(let error):
                print(error)
            }
        }
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸Šé¢çš„æ–¹æ³•ä½¿ç”¨ **Alamofire** æ¥è°ƒç”¨ a `self.endpoint`ï¼Œç„¶åå°†å“åº”å­˜å‚¨åˆ°`self.users`ã€‚å®ƒè¿˜è°ƒç”¨äº†ä¸€ä¸ª`indicator.startAnimating()`ï¼Œè¿™åº”è¯¥æ˜¾ç¤ºä¸€ä¸ªæ•°æ®æ­£åœ¨åŠ è½½çš„æŒ‡ç¤ºå™¨ã€‚

åœ¨æˆ‘ä»¬åˆ›å»ºåŠ è½½æŒ‡ç¤ºå™¨ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹`import Alamofire`ã€‚åœ¨`import UIKit`è¯­å¥ä¸‹ï¼Œæ·»åŠ ä¸‹é¢çš„ä»£ç è¡Œ:

```
 import Alamofire 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»…æ­¤è€Œå·²ï¼ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»ºå·²ç»åœ¨ä¸Šé¢çš„`loadUsersFromApi`å‡½æ•°ä¸­è¢«è°ƒç”¨çš„åŠ è½½æŒ‡ç¤ºå™¨ã€‚

é¦–å…ˆï¼Œåœ¨æ§åˆ¶å™¨ç±»å£°æ˜:
ä¹‹åå£°æ˜ç±»ä¸­çš„`indicator`å’Œ`endpoint`

```
 var endpoint = "http://localhost:4000"
    var indicator = UIActivityIndicatorView() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> ğŸ’¡**`**endpoint**`**åœ¨æ‚¨ä¸ºçœŸå®ç¯å¢ƒè¿›è¡Œå¼€å‘æ—¶ï¼Œéœ€è¦å°†å®ƒæ”¹ä¸ºæ‚¨çš„ web æœåŠ¡å™¨çš„ URLã€‚****

 **ç°åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªå‡½æ•°æ¥åˆå§‹åŒ–å’Œé…ç½®åŠ è½½æŒ‡ç¤ºå™¨ã€‚å°†ä»¥ä¸‹åŠŸèƒ½æ·»åŠ åˆ°æ§åˆ¶å™¨:

```
 private func setupActivityIndicator() {
        indicator = UIActivityIndicatorView(frame: CGRect(x: 0, y: 0, width: 50, height: 50))
        indicator.activityIndicatorViewStyle = .white
        indicator.backgroundColor = UIColor.darkGray
        indicator.center = self.view.center
        indicator.layer.cornerRadius = 05
        indicator.hidesWhenStopped = true
        indicator.layer.zPosition = 1
        indicator.isOpaque = false
        indicator.tag = 999
        tableView.addSubview(indicator)
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸Šé¢çš„å‡½æ•°å°†ç®€å•åœ°è®¾ç½®æˆ‘ä»¬çš„`UIActivityIndicatorView`ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæŒ‡ç¤ºæˆ‘ä»¬çš„æ•°æ®æ­£åœ¨åŠ è½½çš„å¾®è°ƒå™¨ã€‚è®¾ç½®è£…è½½è§†å›¾åï¼Œæˆ‘ä»¬å°†å®ƒæ·»åŠ åˆ°è¡¨æ ¼è§†å›¾ä¸­ã€‚

> ğŸ’¡**æˆ‘ä»¬å°†** `**hidesWhenStopped**` **å±æ€§è®¾ç½®ä¸º** `**true**` **ï¼Œè¿™æ„å‘³ç€æ¯æ¬¡æˆ‘ä»¬ä½¿ç”¨** `**stopAnimating**` **åœæ­¢æŒ‡æ ‡æ—¶ï¼ŒæŒ‡æ ‡ä¼šè‡ªåŠ¨éšè—ã€‚**

ç°åœ¨ï¼Œåœ¨`viewDidLoad`å‡½æ•°ä¸­ï¼Œåœ¨å¯¹`loadUsersFromApi`çš„è°ƒç”¨ä¹‹ä¸Šï¼Œæ·»åŠ å¯¹`setupActivityIndicator` :
çš„è°ƒç”¨

```
 override func viewDidLoad() {
        // other stuff...
        setupActivityIndicator()
        loadUsersFromApi()
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è°ƒç”¨`loadUsersFromApi`è°ƒç”¨ä¹‹å‰æ·»åŠ å®ƒå°†ç¡®ä¿åœ¨åŠ è½½ç”¨æˆ·å‡½æ•°è°ƒç”¨ä¸­å¼•ç”¨å®ƒä¹‹å‰å·²ç»åˆ›å»ºäº†æŒ‡ç¤ºå™¨ã€‚

**å°†ç”¨æˆ·æ·»åŠ åˆ° APIï¼Œç„¶åæœ¬åœ°æ·»åŠ åˆ°è¡¨ä¸­**
ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°†â€œAddâ€æŒ‰é’®æŒ‚æ¥åˆ°æˆ‘ä»¬çš„åç«¯ï¼Œè¿™æ ·å½“ä½¿ç”¨ textfield æ·»åŠ ç”¨æˆ·æ—¶ï¼Œä¸€ä¸ªè¯·æ±‚å°†è¢«å‘é€åˆ°ç«¯ç‚¹ã€‚

åœ¨`showAddUserAlertController`ä¸­æˆ‘ä»¬ä¼šåšä¸€äº›ä¿®æ”¹ã€‚æ›¿æ¢ä¸‹é¢çš„è¡Œ:

```
 if let name = self.textField.text, name != "" {
        self.users.append(["id": self.users.count, "name" :name])
        self.tableView.reloadData()
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”¨è¿™ä¸ª:

```
 if let name = self.textField.text, name != "" {
        let payload: Parameters = ["name": name, "deviceId": self.deviceId]

        Alamofire.request(self.endpoint + "/add", method: .post, parameters:payload).validate().responseJSON { (response) in
            switch response.result {
            case .success(_):
                self.users.append(["id": self.users.count, "name" :name])
                self.tableView.reloadData()
            case .failure(let error):
                print(error)
            }
        }
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œåœ¨ä¸Šé¢çš„ä»£ç å—ä¸­ï¼Œæˆ‘ä»¬å‘ç«¯ç‚¹å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œ`users`å±æ€§ã€‚å¦‚æœè¯·æ±‚æˆåŠŸï¼Œæˆ‘ä»¬å°±å°†æ–°æ•°æ®è¿½åŠ åˆ°`users`å±æ€§ä¸­ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ æ³¨æ„åˆ°ï¼Œåœ¨`payload`ä¸­æˆ‘ä»¬å¼•ç”¨äº†`self.deviceId`ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ›å»ºè¿™ä¸ªå±æ€§ã€‚åœ¨ç±»å£°æ˜ä¹‹åæ·»åŠ ä¸‹é¢çš„ä»£ç :

```
 let deviceId = UIDevice.current.identifierForVendor!.uuidString 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> ğŸ’¡**æˆ‘ä»¬æ­£åœ¨æ·»åŠ è®¾å¤‡ IDï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥åŒºåˆ†è°å¯¹åç«¯è¿›è¡Œäº†ä»€ä¹ˆè°ƒç”¨ï¼Œå¹¶é¿å…åœ¨å‘é€è¯·æ±‚çš„æ˜¯åŒä¸€ä¸ª** **è®¾å¤‡** **çš„æƒ…å†µä¸‹å¤šæ¬¡æ“çºµæ•°æ®ã€‚å½“æˆ‘ä»¬é›†æˆ Pusher æ—¶ï¼Œç›‘å¬å™¨å°†å¯¹** `**user**` **å±æ€§è¿›è¡ŒåŒæ ·çš„æ“ä½œã€‚** **ç„¶è€Œï¼Œå¦‚æœæ˜¯åŒä¸€å°è®¾å¤‡å‘å‡ºäº†è¯·æ±‚ï¼Œé‚£ä¹ˆå®ƒåº”è¯¥è·³è¿‡æ›´æ–°å±æ€§****ã€‚**

**åœ¨ API ä¸­ç§»åŠ¨ç”¨æˆ·ï¼Œç„¶åæœ¬åœ°ç§»åŠ¨åˆ°è¡¨ä¸­**
æ¥ä¸‹æ¥æ˜¯æ·»åŠ è¿œç¨‹ç§»åŠ¨åŠŸèƒ½ã€‚è®©æˆ‘ä»¬æŠŠå®ƒè¿æ¥èµ·æ¥ï¼Œä¸ç«¯ç‚¹è¿›è¡Œé€šä¿¡ã€‚

åœ¨æ‚¨çš„ä»£ç ä¸­ï¼Œæ›¿æ¢ä¸‹é¢çš„å‡½æ•°:

```
 override func tableView(_ tableView: UITableView, moveRowAt sourceIndexPath: IndexPath, to destinationIndexPath: IndexPath) {
        let movedObject = users[sourceIndexPath.row]
        users.remove(at: sourceIndexPath.row)
        users.insert(movedObject, at: destinationIndexPath.row)
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ‰äº†è¿™ä¸ª:

```
 override func tableView(_ tableView: UITableView, moveRowAt sourceIndexPath: IndexPath, to destinationIndexPath: IndexPath) {
        let movedObject = users[sourceIndexPath.row]

        let payload:Parameters = [
            "deviceId": self.deviceId,
            "src":sourceIndexPath.row,
            "dest": destinationIndexPath.row,
            "src_id": users[sourceIndexPath.row]["id"]!,
            "dest_id": users[destinationIndexPath.row]["id"]!
        ]

        Alamofire.request(self.endpoint+"/move", method: .post, parameters: payload).validate().responseJSON { (response) in
            switch response.result {
            case .success(_):
                self.users.remove(at: sourceIndexPath.row)
                self.users.insert(movedObject, at: destinationIndexPath.row)
            case .failure(let error):
                print(error)
            }
        }
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†æœ‰æ•ˆè´Ÿè½½è®¾ç½®ä¸ºå‘é€åˆ°ç«¯ç‚¹ï¼Œå¹¶ä½¿ç”¨ **Alamofire** å‘é€å®ƒã€‚ç„¶åï¼Œå¦‚æœæˆ‘ä»¬ä» API æ”¶åˆ°ä¸€ä¸ªæˆåŠŸçš„å“åº”ï¼Œæˆ‘ä»¬å°±å¯¹`user`å±æ€§è¿›è¡Œä¿®æ”¹ã€‚

**åœ¨ API ä¸­åˆ é™¤ä¸€è¡Œï¼Œç„¶ååœ¨æœ¬åœ°åˆ é™¤è¡¨ä¸­çš„ä¸€è¡Œ**
æ¥ä¸‹æ¥æˆ‘ä»¬è¦åšçš„æ˜¯åœ¨æœ¬åœ°åˆ é™¤ä¹‹å‰ä» API ä¸­åˆ é™¤æ•°æ®ã€‚ä¸ºæ­¤ï¼Œè¯·æŸ¥æ‰¾ä¸‹é¢çš„å‡½æ•°:

```
 override func tableView(_ tableView: UITableView, commit editingStyle: UITableViewCellEditingStyle, forRowAt indexPath: IndexPath) {
        if editingStyle == .delete {
            self.users.remove(at: indexPath.row)
            self.tableView.deleteRows(at: [indexPath], with: .automatic)
        }
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¹¶å°†å…¶æ›¿æ¢ä¸ºä»¥ä¸‹ä»£ç :

```
 override func tableView(_ tableView: UITableView, commit editingStyle: UITableViewCellEditingStyle, forRowAt indexPath: IndexPath) {
        if editingStyle == .delete {
            let payload: Parameters = [
                "index":indexPath.row,
                "deviceId": self.deviceId,
                "id": self.users[indexPath.row]["id"]!
            ]

            Alamofire.request(self.endpoint + "/delete", method: .post, parameters:payload).validate().responseJSON { (response) in
                switch response.result {
                case .success(_):
                    self.users.remove(at: indexPath.row)
                    self.tableView.deleteRows(at: [indexPath], with: .automatic)
                case .failure(let err):
                    print(err)
                }
            }
        }
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°±åƒå…¶ä»–äººä¸€æ ·ï¼Œæˆ‘ä»¬åˆšåˆšå°†ç”Ÿæˆçš„æœ‰æ•ˆè´Ÿè½½å‘é€ç»™ APIï¼Œç„¶åï¼Œå¦‚æœæœ‰æˆåŠŸçš„å“åº”ï¼Œæˆ‘ä»¬å°±ä»`users`å±æ€§ä¸­åˆ é™¤è¯¥è¡Œã€‚

ç°åœ¨ï¼Œä¸‹ä¸€ä»¶äº‹æ˜¯åˆ›å»ºåç«¯ APIã€‚ç„¶è€Œï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨ Pusher å°†å®æ—¶åŠŸèƒ½æ·»åŠ åˆ°åº”ç”¨ç¨‹åºä¸­ã€‚

## [](#adding-realtime-functionality-to-our-table-on-ios)åœ¨ iOS ä¸Šä¸ºæˆ‘ä»¬çš„è¡¨æ ¼æ·»åŠ å®æ—¶åŠŸèƒ½

ç°åœ¨æˆ‘ä»¬å·²ç»å®Œæˆäº† API çš„è¿æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€äº›å®æ—¶åŠŸèƒ½ï¼Œä»¥ä¾¿ä»»ä½•å…¶ä»–è®¾å¤‡éƒ½å¯ä»¥ç«‹å³è·å¾—æ›´æ”¹ï¼Œè€Œä¸å¿…æ‰‹åŠ¨é‡æ–°åŠ è½½è¡¨ã€‚

é¦–å…ˆï¼Œå°† Pusher SDK å¯¼å…¥æ‚¨çš„åº”ç”¨ç¨‹åºã€‚åœ¨`import Alamofire`è¯­å¥ä¸‹ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹:

```
 import PusherSwift 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨ç±»å£°æ˜:
ä¸‹çš„ç±»æƒé™ä¸­å£°æ˜`pusher`å±æ€§

```
 var pusher: Pusher! 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¤ªå¥½äº†ã€‚ç°åœ¨å°†ä¸‹é¢çš„å‡½æ•°æ·»åŠ åˆ°æ§åˆ¶å™¨:

```
 private func listenToChangesFromPusher() {
        // Instantiate Pusher
        pusher = Pusher(key: "PUSHER_APP_KEY", options: PusherClientOptions(host: .cluster("PUSHER_APP_CLUSTER")))

        // Subscribe to a pusher channel
        let channel = pusher.subscribe("userslist")

        // Bind to an event called "addUser" on the event channel and fire 
        // the callback when the event is triggerred
        let _ = channel.bind(eventName: "addUser", callback: { (data: Any?) -> Void in
            if let data = data as? [String : AnyObject] {
                if let name = data["name"] as? String {

                    // We only want to run this block if the update was from a 
                    // different device
                    if (data["deviceId"] as! String) != self.deviceId {
                        self.users.append(["id": self.users.count, "name": name])
                        self.tableView.reloadData()
                    }
                }
            }
        })

        // Bind to an event called "removeUser" on the event channel and fire 
        // the callback when the event is triggerred
        let _ = channel.bind(eventName: "removeUser", callback: { (data: Any?) -> Void in
            if let data = data as? [String : AnyObject] {
                if let _ = data["index"] as? Int {
                    let indexPath = IndexPath(item: (data["index"] as! Int), section:0)

                    // We only want to run this block if the update was from a 
                    // different device
                    if (data["deviceId"] as! String) != self.deviceId {
                        self.users.remove(at: indexPath.row)
                        self.tableView.deleteRows(at: [indexPath], with: .automatic)
                    }
                }
            }
        })

        // Bind to an event called "moveUser" on the event channel and fire 
        // the callback when the event is triggerred
        let _ = channel.bind(eventName: "moveUser", callback: { (data: Any?) -> Void in
            if let data = data as? [String : AnyObject] {
                if let _ = data["deviceId"] as? String {
                    let sourceIndexPath = IndexPath(item:(data["src"] as! Int), section:0)
                    let destinationIndexPath = IndexPath(item:(data["dest"] as! Int), section:0)
                    let movedObject = self.users[sourceIndexPath.row]

                    // We only want to run this block if the update was from a 
                    // different device
                    if (data["deviceId"] as! String) != self.deviceId {
                        self.users.remove(at: sourceIndexPath.row)
                        self.users.insert(movedObject, at: destinationIndexPath.row)
                        self.tableView.reloadData()
                    }
                }
            }
        })

        pusher.connect()
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å·²ç»åšäº†å¾ˆå¤šã€‚é¦–å…ˆï¼Œæˆ‘ä»¬ç”¨åº”ç”¨ç¨‹åºçš„é”®å’Œé›†ç¾¤å®ä¾‹åŒ– Pusher(æ›¿æ¢ä¸º Pusher åº”ç”¨ç¨‹åºä»ªè¡¨æ¿ä¸Šæä¾›çš„è¯¦ç»†ä¿¡æ¯)ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®¢é˜…äº†é¢‘é“`userslist`ã€‚æˆ‘ä»¬å°†ç›‘å¬è¯¥é¢‘é“ä¸Šçš„äº‹ä»¶ã€‚

åœ¨ç¬¬ä¸€ä¸ª`channel.bind`å—ä¸­ï¼Œæˆ‘ä»¬ç»‘å®šåˆ°`addUser`äº‹ä»¶ï¼Œç„¶åå½“ä¸€ä¸ªäº‹ä»¶è¢«æ‹¾å–æ—¶ï¼Œå›è°ƒè¿è¡Œã€‚

åœ¨å›è°ƒä¸­ï¼Œæˆ‘ä»¬æ£€æŸ¥è®¾å¤‡ IDï¼Œå¦‚æœä¸åŒ¹é…ï¼Œæˆ‘ä»¬å°†æ–°ç”¨æˆ·é™„åŠ åˆ°æœ¬åœ°`user`å±æ€§ã€‚å¯¹äº`channel.bind`çš„ä¸‹ä¸¤ä¸ªå—ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ç„¶è€Œï¼Œåœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œå®ƒåˆ†åˆ«åˆ é™¤å’Œç§»åŠ¨ä½ç½®ã€‚

æœ€åä¸€éƒ¨åˆ†æ˜¯`pusher.connect`,å®ƒå®Œå…¨æŒ‰ç…§å®ƒæ‰€è¯´çš„å»åšã€‚

è¦å¬è¿™äº›å˜åŒ–ï¼Œå°†è°ƒç”¨æ·»åŠ åˆ°`viewDidLoad`å‡½æ•°çš„åº•éƒ¨:

```
 override func viewDidLoad() {
        // other stuff...
        listenToChangesFromPusher()
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»…æ­¤è€Œå·²ï¼æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå®æ—¶è¡¨ï¼Œå½“æ•°æ®è¢«æ“ä½œæ—¶ï¼Œå®ƒä¼šå¯¹æ”¶åˆ°çš„æ›´æ”¹åšå‡ºå“åº”ã€‚æœ€åä¸€éƒ¨åˆ†æ˜¯åˆ›å»ºç”¨äºä¿å­˜æ•°æ®å’Œè§¦å‘æ¨é€äº‹ä»¶çš„åç«¯ã€‚

## [](#creating-the-backend-for-our-realtime-ios-table)ä¸ºæˆ‘ä»¬çš„å®æ—¶ iOS è¡¨åˆ›å»ºåç«¯

é¦–å…ˆï¼Œä¸º web åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œç„¶ååœ¨ç›®å½•ä¸­åˆ›å»ºä¸€äº›æ–°æ–‡ä»¶:

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªåä¸º **package.json:**
çš„æ–‡ä»¶

```
 {
      "main": "index.js",
      "dependencies": {
        "bluebird": "^3.5.0",
        "body-parser": "^1.16.0",
        "express": "^4.14.1",
        "pusher": "^1.5.1",
        "sqlite": "^2.8.0"
      }
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªæ–‡ä»¶å°†åŒ…å«æˆ‘ä»¬æ‰“ç®—ç”¨æ¥æ„å»ºåç«¯åº”ç”¨ç¨‹åºçš„æ‰€æœ‰åŒ…ã€‚

ä¸‹ä¸€ä¸ªè¦åˆ›å»ºçš„æ–‡ä»¶å°†æ˜¯ **config.js:**

```
 module.exports = {
        appId: 'PUSHER_APP_ID',
        key: 'PUSHER_APP_KEY',
        secret: 'PUSHER_APP_SECRET',
        cluster: 'PUSHER_APP_CLUSTER',
    }; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å°†æ˜¯æ‰€æœ‰é…ç½®å€¼çš„ä½ç½®ã€‚ä½¿ç”¨ Pusher åº”ç”¨ç¨‹åºä»ªè¡¨æ¿ä¸­çš„æ•°æ®å¡«å†™æ•°å€¼ã€‚

æ¥ä¸‹æ¥ï¼Œåœ¨ web åº”ç”¨ç¨‹åºç›®å½•çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªç©ºçš„`database.sqlite`æ–‡ä»¶ã€‚

æ¥ä¸‹æ¥ï¼Œåœ¨ web åº”ç”¨ç¨‹åºç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`migrations`çš„ç›®å½•ï¼Œåœ¨å…¶ä¸­åˆ›å»ºä¸‹ä¸€ä¸ªæ–‡ä»¶ **001-initial-schema.sql** ï¼Œå¹¶ç²˜è´´ä¸‹é¢çš„å†…å®¹:

```
 -- Up
    CREATE TABLE Users (
        id INTEGER NOT NULL,
        name TEXT,
        position INTEGER NOT NULL,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (id)
    );
    INSERT INTO Users (id, name, position) VALUES (1, 'John Doe', 1);
    -- Down
    DROP TABLE Users; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ä¸Šé¢ï¼Œæˆ‘ä»¬å£°æ˜äº†åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è¦è¿è¡Œçš„è¿ç§»ã€‚

> ğŸ’¡**`**-- Up**`**æ ‡è®°åº”è¯¥è¿è¡Œçš„è¿ç§»ï¼Œ** `**-- Down**` **æ˜¯è¿ç§»çš„å›æ»šï¼Œå¦‚æœæ‚¨æƒ³åé€€å¹¶æ’¤æ¶ˆè¿ç§»ã€‚****

 **æ¥ä¸‹æ¥æˆ‘ä»¬å°†åˆ›å»ºä¸»æ–‡ä»¶ **index.js:**

```
 // ------------------------------------------------------
    // Import all required packages and files
    // ------------------------------------------------------
    let Pusher     = require('pusher');
    let express    = require('express');
    let bodyParser = require('body-parser');
    let Promise    = require('bluebird');
    let db         = require('sqlite');
    let app        = express();
    let pusher     = new Pusher(require('./config.js'));
    // ------------------------------------------------------
    // Set up Express
    // ------------------------------------------------------
    app.use(bodyParser.json());
    app.use(bodyParser.urlencoded({ extended: false }));
    // ------------------------------------------------------
    // Define routes and logic
    // ------------------------------------------------------
    app.get('/users', (req, res, next) => {
      try {
        // Fetch all users from the database
        db.all('SELECT * FROM Users ORDER BY position ASC, updated_at DESC')
          .then(result => res.json(result))
      } catch (err) {
        next(err)
      }
    })
    app.post("/add", (req, res, next) => {
      try {
        let payload = {name:req.body.name, deviceId: req.body.deviceId}
        // Add the user to the database
        db.run("INSERT INTO Users (name, position) VALUES (?, (SELECT MAX(id) + 1 FROM Users))", payload.name).then(query => {
          payload.id = query.stmt.lastID
          pusher.trigger('userslist', 'addUser', payload)
          return res.json(payload)
        })
      } catch (err) {
        next(err)
      }
    })
    app.post("/delete", (req, res, next) => {
      try {
        let payload = {id:parseInt(req.body.id), index:parseInt(req.body.index), deviceId: req.body.deviceId}
        // Delete the user from the database
        db.run(`DELETE FROM Users WHERE id=${payload.id}`).then(query => {
          pusher.trigger('userslist', 'removeUser', payload)
          return res.json(payload)
        })
      } catch (err) {
        next(err)
      }
    })
    app.post("/move", (req, res, next) => {
      try {
        let payload = {
          deviceId: req.body.deviceId,
          src: parseInt(req.body.src),
          dest: parseInt(req.body.dest),
          src_id: parseInt(req.body.src_id),
          dest_id: parseInt(req.body.dest_id),
        }
        // Update the position of the user
        db.run(`UPDATE Users SET position=${payload.dest + 1}, updated_at=CURRENT_TIMESTAMP WHERE id=${payload.src_id}`).then(query => {
          pusher.trigger('userslist', 'moveUser', payload)
          res.json(payload)
        })
      } catch (err) {
        next(err)
      }
    })
    app.get('/', (req, res) => {
      res.json("It works!");
    });

    // ------------------------------------------------------
    // Catch errors
    // ------------------------------------------------------
    app.use((req, res, next) => {
        let err = new Error('Not Found');
        err.status = 404;
        next(err);
    });

    // ------------------------------------------------------
    // Start application
    // ------------------------------------------------------
    Promise.resolve()
      .then(() => db.open('./database.sqlite', { Promise }))
      .then(() => db.migrate({ force: 'last' }))
      .catch(err => console.error(err.stack))
      .finally(() => app.listen(4000, function(){
        console.log('App listening on port 4000!')
      })); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åŠ è½½äº†æ‰€æœ‰éœ€è¦çš„åŒ…ï¼ŒåŒ…æ‹¬ Express å’Œ Pusherã€‚åœ¨å®ä¾‹åŒ–å®ƒä»¬ä¹‹åï¼Œæˆ‘ä»¬åˆ›å»ºæˆ‘ä»¬éœ€è¦çš„è·¯ç”±ã€‚

è¿™äº›è·¯ç”±è¢«è®¾è®¡ç”¨æ¥åšä¸€äº›éå¸¸åŸºæœ¬çš„äº‹æƒ…ï¼Œæ¯”å¦‚å‘æ•°æ®åº“ä¸­æ·»åŠ ä¸€è¡Œã€ä»æ•°æ®åº“ä¸­åˆ é™¤ä¸€è¡Œä»¥åŠæ›´æ–°æ•°æ®åº“ä¸­çš„è¡Œã€‚å¯¹äºæ•°æ®åº“ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ [SQLite NPM åŒ…](https://www.npmjs.com/package/sqlite)ã€‚

åœ¨æœ€åä¸€ä¸ªå—ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`/migrations/001-initial-schema.sql`æ–‡ä»¶å°†æ•°æ®åº“è¿ç§»åˆ°`database.sqlite`æ–‡ä»¶ä¸­ã€‚ç„¶åæˆ‘ä»¬åœ¨ä¸€åˆ‡å®Œæˆåå¯åŠ¨ express åº”ç”¨ç¨‹åºã€‚

æ‰“å¼€ç»ˆç«¯ï¼Œ`cd`åˆ° web åº”ç”¨ç›®å½•çš„æ ¹ç›®å½•ï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤åˆ†åˆ«å®‰è£… NPM ä¾èµ–é¡¹å’Œè¿è¡Œåº”ç”¨:

```
 $ npm install
    $ node index.js 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“å®‰è£…å®Œæˆï¼Œåº”ç”¨ç¨‹åºå‡†å¤‡å°±ç»ªæ—¶ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°æ¶ˆæ¯ **App ä¾¦å¬ç«¯å£ 4000ï¼**

## [](#testing-the-application)æµ‹è¯•åº”ç”¨ç¨‹åº

ä¸€æ—¦æ‚¨çš„æœ¬åœ°èŠ‚ç‚¹ web æœåŠ¡å™¨å¼€å§‹è¿è¡Œï¼Œæ‚¨å°†éœ€è¦è¿›è¡Œä¸€äº›æ›´æ”¹ï¼Œä»¥ä¾¿æ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥ä¸æœ¬åœ° web æœåŠ¡å™¨é€šä¿¡ã€‚åœ¨`info.plist`æ–‡ä»¶ä¸­ï¼Œè¿›è¡Œä»¥ä¸‹æ›´æ”¹:

[![](../Images/ff8941a2c355ba94a7b549bd259b34fe.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--D8dzqj3V--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.pusher.com/wp-content/uploads/2017/11/How-to-build-a-realtime-table-using-Swift-5.png)

é€šè¿‡è¿™ä¸€æ›´æ”¹ï¼Œæ‚¨å¯ä»¥æ„å»ºå¹¶è¿è¡Œæ‚¨çš„åº”ç”¨ç¨‹åºï¼Œå®ƒå°†ç›´æ¥ä¸æ‚¨çš„æœ¬åœ° web åº”ç”¨ç¨‹åºå¯¹è¯ã€‚

## [](#conclusion)ç»“è®º

æœ¬æ–‡æ¼”ç¤ºäº†å¦‚ä½•åœ¨ iOS ä¸­åˆ›å»ºè¡¨æ ¼ï¼Œä»¥å®æ—¶å“åº”å…¶ä»–è®¾å¤‡ä¸Šçš„æ›´æ”¹ã€‚è¿™éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥åº”ç”¨äºéœ€è¦åœ¨æ‰€æœ‰è®¾å¤‡ä¸ŠåŠ¨æ€å³æ—¶æ›´æ–°çš„æ•°æ®ã€‚

å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œåé¦ˆæˆ–æ›´æ­£ï¼Œä½ å¯ä»¥åœ¨ä¸‹é¢çš„è¯„è®ºåŒºå‘è¡¨ã€‚

ä»¥ä¸Šæ•™ç¨‹çš„æºä»£ç å¯ä»¥åœ¨ [GitHub](https://github.com/neoighodaro/Build-a-realtime-table-using-Swift) è·å¾—ã€‚

## [](#this-post-first-appeared-on-the-pusher-blog)è¿™ä¸ªå¸–å­æœ€æ—©å‡ºç°åœ¨[æ¨æ‰‹åšå®¢](https://blog.pusher.com/how-to-build-a-realtime-table-using-swift/)ä¸Šã€‚****