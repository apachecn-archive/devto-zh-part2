# å¦‚ä½•å°†ä¸€ä¸ª express app è½¬æ¢æˆ AWS Lambdaï¼Ÿ

> åŸæ–‡:[https://dev . to/bright devs/how-to-convert-an-express-app-to-AWS-lambda-44gc](https://dev.to/brightdevs/how-to-convert-an-express-app-to-aws-lambda--44gc)

åœ¨æœ¬å¸–ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•å°†ç°æœ‰çš„ [express](https://expressjs.com/) åº”ç”¨ç¨‹åºè½¬æ¢ä¸º AWS Lambdaã€‚è¿™æœ‰åŠ©äºå‡å°‘ AWS è´¦å•ï¼Œç”šè‡³å‡å°‘ä¸€ä¸ªæ•°é‡çº§ã€‚æˆ‘ä»¬ä¹Ÿå°†ä½¿ç”¨[äº‘å½¢](https://github.com/bright/cloudform)æ¥æè¿°[äº‘å½¢](https://aws.amazon.com/cloudformation/)å †æ ˆã€‚

[![express.js](../Images/8ec8799e2dfbabbdcc803ee25818fbcc.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--8v1OhUUv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/cixfubqtggza96d88v2r.png)

## [](#an-express-app)æŸå¿«é€’ app

ä¸ºäº†ä½¿æˆ‘ä»¬çš„ä¾‹å­å®Œæ•´ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª express åº”ç”¨ç¨‹åºã€‚è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªå•ç‹¬çš„`index.js`æ–‡ä»¶æ¥å®šä¹‰å®ƒ:

```
const express = require('express');

function apiRoutes(){
    const routes = new express.Router();

    routes.get('/v1/version', (req, res) => res.send({version: '1'}));

    routes.post('/v1/echo', (req, res) => res.send({...req.body}));

    return routes;
}

const app = express()
    .use(express.json())
    .use(apiRoutes());

app.listen(3000, () => console.log(`Listening on 3000`)); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸Šè¿°åº”ç”¨ç¨‹åºåªæœ‰ä¸¤ä¸ªç«¯ç‚¹:

*   `GET /v1/version`è¿”å› API ç‰ˆæœ¬
*   `POST /v1/echo`å‘å›è¯·æ±‚æ­£æ–‡

æˆ‘ä»¬ç”¨`node index.js`å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œå°±åƒå…¶ä»–èŠ‚ç‚¹åº”ç”¨ç¨‹åºä¸€æ ·ã€‚

## [](#convert-the-express-app-to-aws-lambda)å°† express app è½¬æ¢ä¸º AWS Lambda

[AWS Lambda node . js](https://docs.aws.amazon.com/lambda/latest/dg/nodejs-prog-model-handler.html)è¿è¡Œæ—¶æ¨¡å‹ä¸åŒäºç®€å•çš„`node fileName.js`è°ƒç”¨ã€‚ä¸ºäº†è®© AWS Lambda è°ƒç”¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä»£ç ï¼Œæˆ‘ä»¬éœ€è¦é€‚å½“åœ°æ„å»ºå®ƒã€‚è°¢å¤©è°¢åœ°ï¼Œ [aws-serverless-express](https://github.com/awslabs/aws-serverless-express) æ¨¡å—ä½¿ express é€‚åº” AWS Lambda Node.js è¿è¡Œæ—¶æ¨¡å‹ã€‚

è®©æˆ‘ä»¬ä¿®æ”¹æˆ‘ä»¬çš„`index.js`æ–‡ä»¶æ¥æ”¯æŒ`aws-serverless-express` :

```
const isInLambda = !!process.env.LAMBDA_TASK_ROOT;
if (isInLambda) {
    const serverlessExpress = require('aws-serverless-express');
    const server = serverlessExpress.createServer(app);
    exports.main = (event, context) => serverlessExpress.proxy(server, event, context)
} else {
    app.listen(3000, () => console.log(`Listening on 3000`));
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`main`å‡½æ•°ç”± AWS Lambda Node.js è¿è¡Œæ—¶è°ƒç”¨ã€‚æ³¨æ„ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† [`LAMBDA_TASK_ROOT`](https://docs.aws.amazon.com/lambda/latest/dg/current-supported-versions.html#lambda-environment-variables) ç¯å¢ƒå˜é‡æ¥æ£€æµ‹åº”ç”¨ç¨‹åºæ˜¯å¦åœ¨ AWS Lambda ä¸­è¿è¡Œã€‚æœ€å¥½å°†å¿«é€Ÿåº”ç”¨ç¨‹åºè®¾ç½®å’Œ`listen`è°ƒç”¨åˆ†æˆå•ç‹¬çš„æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ 2 ä¸ªä¸åŒçš„*ä¸»*æ–‡ä»¶ï¼Œä¾‹å¦‚`development.js`è°ƒç”¨`listen(port)`å’Œ`lambda.js`ä½¿ç”¨`aws-serverless-express`ã€‚ç„¶è€Œï¼Œè¿™ä¼šä¸å¿…è¦åœ°ä½¿æˆ‘ä»¬çš„ä¾‹å­å˜å¾—å¤æ‚ã€‚

## [](#deploy-the-express-app-to-aws-lambda)å°† express app éƒ¨ç½²åˆ° AWS Lambda

æˆ‘å·²ç»å‘[å±•ç¤ºäº†æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ cloudform](https://dev.to%20post_url%202018-03-12-deploy-lambda-with-cloudformation%20) éƒ¨ç½² lambdaã€‚æˆ‘ä»¬å°†ä»¥å‰é¢çš„ä¾‹å­ä¸ºåŸºç¡€:

```
import cloudform, { Lambda, IAM, Fn, ApiGateway, Refs,  } from 'cloudform';
import { FunctionProperties } from 'cloudform/types/lambda/function';
import { readFileSync } from 'fs';

const
    LambdaExecutionRole = 'LambdaExecutionRole',
    ExpressMain = 'ExpressMain',
    RestApi = 'RestApi',
    RestApiMainResource = 'RestApiMainResource',
    PackageKey = 'PackageKey',
    RestApiDeployment = 'RestApiDeployment';

export default cloudform({
    Parameters: {
        PackageKey: {
            Type: 'String',
            Default: 'express-lambda.zip'
        }
    },
    Resources: {
        [ExpressMain]: new Lambda.Function({
            Code: { S3Bucket: 'bright-tmp', S3Key: Fn.Ref(PackageKey) },
            Handler: "index.main",
            Role: Fn.GetAtt(LambdaExecutionRole, "Arn"),
            Runtime: "nodejs6.10"
        }),
        [LambdaExecutionRole]: new IAM.Role({
            AssumeRolePolicyDocument: {
                Statement: [{
                    Effect: "Allow",
                    Principal: { Service: ["lambda.amazonaws.com"] },
                    Action: ["sts:AssumeRole"]
                }]
            },
            ManagedPolicyArns: ["arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"]
        }),
        PermissionToInvokeLambda: new Lambda.Permission({
            Action: 'lambda:InvokeFunction',
            FunctionName: Fn.GetAtt(ExpressMain, 'Arn'),
            Principal: 'apigateway.amazonaws.com',
            SourceArn: Fn.Join('', [
                'arn:aws:execute-api:', Refs.Region, ':', Refs.AccountId, ':', Fn.Ref(RestApi), '/*']
            )
        })
        ... // Rest Api Gateway see below
    }
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯¹äº AWS Lambda å‡½æ•°æºä»£ç ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª zip æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¿å­˜åœ¨ä¸€ä¸ªåä¸º`packages`çš„ S3 æ¡¶ä¸­ï¼Œåœ¨æ¨¡æ¿å‚æ•°`PackageKey`ä¸­æŒ‡å®šäº†å…³é”®å­—ã€‚åŒ… zip æ–‡ä»¶å¿…é¡»åŒ…å«æ‰€æœ‰åº”ç”¨ç¨‹åºæºä»£ç ï¼ŒåŒ…æ‹¬`node_modules`ã€‚æˆ‘ä»¬è¿˜å®šä¹‰äº†`PermissionToInvokeLambda`ï¼Œä»¥ä¾¿ API Gateway å¯ä»¥è°ƒç”¨ lambda å‡½æ•°ã€‚

## [](#add-api-gateway-to-call-aws-lambda)æ·»åŠ  API ç½‘å…³è°ƒç”¨ AWS Lambda

ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨ HTTP åè®®è°ƒç”¨ AWS Lambda å‡½æ•°ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [API ç½‘å…³](https://aws.amazon.com/api-gateway/)ã€‚è®¾ç½® API ç½‘å…³æœ‰å¤šç§æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ç§æˆ‘è®¤ä¸ºæœ€ç®€å•çš„æ–¹æ³•ã€‚

```
[RestApi]: new ApiGateway.RestApi({ Name: "Express API" }),
[RestApiMainResource]: new ApiGateway.Resource({
    RestApiId: Fn.Ref(RestApi),
    ParentId: Fn.GetAtt(RestApi, 'RootResourceId'),
    PathPart: "{proxy+}",
}),
RestApiMethod: new ApiGateway.Method({
    HttpMethod: 'ANY',
    ResourceId: Fn.Ref(RestApiMainResource),
    RestApiId: Fn.Ref(RestApi),
    AuthorizationType: 'NONE',
    Integration: {
        Type: "AWS_PROXY",
        IntegrationHttpMethod: "POST",
        Uri: Fn.Sub("arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExpressMain.Arn}/invocations", {})
    }
}),
[RestApiDeployment]: new ApiGateway.Deployment({
    RestApiId: Fn.Ref(RestApi),
    StageName: 'test'
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬é¦–å…ˆå®šä¹‰ä¸€ä¸ª [`RestApi`](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-restapi.html) ï¼Œå®ƒæ˜¯ä¸€ä¸ªèµ„æºé›†åˆï¼Œå…·æœ‰æè¿° API çš„å„ç§é…ç½®é€‰é¡¹ã€‚æ¥ä¸‹æ¥æ˜¯æè¿°å•ä¸ª REST èµ„æºçš„ [`RestApiMainResource`](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-resource.html) ã€‚ç„¶è€Œï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨é€šé…ç¬¦`PathPart`æ¥åŒ¹é…æ‰€æœ‰çš„è·¯å¾„ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªåŒ…å«æ‰€æœ‰ API ç«¯ç‚¹çš„å•ä¸€èµ„æºã€‚å¯¹äº`RestApiMainResource`æˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªå•ç‹¬çš„ [`RestApiMethod`](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-method.html) ã€‚æ³¨æ„`HttpMethod`è¢«è®¾ç½®ä¸º`ANY`ï¼Œå®ƒåŒ¹é…æ‰€æœ‰åŠ¨è¯ã€‚`Integration`æŒ‡å®šæˆ‘ä»¬å¸Œæœ›å°†è¯·æ±‚ä»£ç†ç»™`ExpressMain` AWS Lambda å‡½æ•°ã€‚æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª [`RestApiDeployment`](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-deployment.html) ä»¥ä¾¿æˆ‘ä»¬æœ‰ä¸€ä¸ª URL æ¥è°ƒç”¨ APIã€‚

åœ¨æˆ‘ä»¬çš„æ¨¡æ¿ä¸­å®šä¹‰`Outputs`å¾ˆæ–¹ä¾¿ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è½»æ¾åœ°è®¿é—® API url:

```
Outputs: {
    RestApiUrl: {
        Value: Fn.Join('', [Fn.Ref(RestApi), '.execute-api.', Refs.Region, '.amazonaws.com/test'])
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#test-api-gateway-calling-aws-lambda)æµ‹è¯• API ç½‘å…³è°ƒç”¨ AWS Lambda

ä½¿ç”¨ä¸€ä¸ªå‘½ä»¤éƒ¨ç½²æˆ‘ä»¬çš„ cloudform æ¨¡æ¿:

```
aws cloudformation update-stack \
  --stack-name lambda-example \
  --capabilities CAPABILITY_IAM \
  --template-body file://<(./node_modules/.bin/cloudform aws-template.ts) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬è¿˜å¯ä»¥è·å– API url:

```
API_URL=$(aws cloudformation describe-stacks \
  --stack-name lambda-example \
  --query 'Stacks[0].Outputs[?OutputKey==`RestApiUrl`].OutputValue' \
  --output text) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ€åï¼Œå€ŸåŠ© [`httpie`](https://httpie.org/) æˆ‘ä»¬å¯ä»¥æµ‹è¯•æˆ‘ä»¬çš„ API:

```
> http https://${API_URL}/v1/version

HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 15
Content-Type: application/json; charset=utf-8
Date: Mon, 28 May 2018 19:58:13 GMT
Via: 1.1 XXXXXXXXXXXXX.cloudfront.net (CloudFront)
X-Amz-Cf-Id: XXXXXXXXXXXXX==
X-Amzn-Trace-Id: Root=1-5b0c5f54-806e190d437c7d31a4a0d4ba
X-Cache: Miss from cloudfront
etag: W/"f-sHigu4BMVa0IJ0LR3NDJ5y8l4sc"
x-amz-apigw-id: HnPVQH4yjoEF8-w=
x-amzn-Remapped-connection: close
x-amzn-Remapped-content-length: 15
x-amzn-Remapped-date: Mon, 28 May 2018 19:58:13 GMT
x-amzn-RequestId: 73eff8a6-62b1-11e8-907c-79117668835e
x-powered-by: Express

{
    "version": "1"
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»¥åŠä¸€ä¸ª`POST`åˆ°å›å£°ç«¯ç‚¹:

```
http https://${API_URL}/v1/echo message="Hello ğŸ‘‹ My name is Piotr"

HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 41
Content-Type: application/json; charset=utf-8
Date: Mon, 28 May 2018 20:00:31 GMT
Via: 1.1 XXXXXXXXXXXXX.cloudfront.net (CloudFront)
X-Amz-Cf-Id: XXXXXXXXXXXXX==
X-Amzn-Trace-Id: Root=1-5b0c5fdf-802178cceb5160684ef2cc34
X-Cache: Miss from cloudfront
etag: W/"29-SKqhJThIfjmVId6IIeTilD7Mkk0"
x-amz-apigw-id: HnPq5HeJjoEFuRQ=
x-amzn-Remapped-connection: close
x-amzn-Remapped-content-length: 41
x-amzn-Remapped-date: Mon, 28 May 2018 20:00:31 GMT
x-amzn-RequestId: c67b41c0-62b1-11e8-a23f-c7cbebde15f2
x-powered-by: Express

{
    "message": "Hello ğŸ‘‹ My name is Piotr"
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#reduced-infrastructure-cost)é™ä½åŸºç¡€è®¾æ–½æˆæœ¬

æœ‰äº†ä¸Šé¢çš„è®¾ç½®ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦ä¸ºä¸€ç›´è¿è¡Œçš„ EC2 å®ä¾‹ä»˜è´¹ã€‚æˆ‘ä»¬æ¯æœˆçš„è´¦å•å–å†³äºé’ˆå¯¹å…¬å¼€çš„ API æ‰§è¡Œçš„è¯·æ±‚æ•°é‡ã€‚ä¸ä»…å¦‚æ­¤ï¼Œæˆ‘ä»¬è¿˜è·å¾—äº†æ›´å¥½çš„å¯ä¼¸ç¼©æ€§ï¼Œç‰¹åˆ«æ˜¯å½“æˆ‘ä»¬æœ‰éçº¿æ€§è¯·æ±‚ç‡æ—¶ã€‚

æœ€åˆå‘å¸ƒäº [brightinventions.pl](https://brightinventions.pl/blog/)

ä½œè€… Piotr Mionskowskiï¼Œè½¯ä»¶å·¥ç¨‹å¸ˆ@å…‰æ˜å‘æ˜
[é‚®ç®±](//piotr.mionskowski@brightinventions.pl) [Stackoverflow](https://stackoverflow.com/users/155213/miensol) [ä¸ªäººåšå®¢](https://miensol.pl/)