# 我不需要类型

> 原文：<https://dev.to/dmerejkowsky/i-dont-need-types-4oi8>

*最初发表于[我的博客](https://dmerej.info/blog/post/trying-mypy/)。*

这是一个关于我在测试和类型系统上犯错误的故事。

这也是我尝试新事物和学习一些东西的故事。

让我们从头开始。

# C++ vs Python

几年前，我在一个团队工作，团队中使用的两种主要语言是 C++和 Python。

以下是我过去的想法:

C++烂透了:

*   我必须到处指定类型:
    *   我需要知道`int`、`long`、`uin8_t`、`size_t`之间的区别，即使我想要的只是一个该死的整数。
    *   我必须在头文件和源文件中复制方法和函数的签名
*   我从来不知道编译器警告或错误是否表明有错误
*   仍然有很多编译器没有捕捉到的错误(竞争条件，悬空指针…)
*   重构是困难的:当你改变一个函数签名时，你必须在运行一些测试之前修正所有的代码。
*   硬写测试:你不能真的写隔离测试，因为 C++中的模仿和依赖注入并不真的有效。另外，`gtest`烂透了。

蟒蛇石:

*   如果我不愿意，我可以不考虑类型。如果我真的需要，我可以写一个抽象基类，但是大多数时候鸭式输入“就可以了”。
*   我不需要编译时检查，因为如果我拼错了一个变量或函数名，或者如果我忘记导入一个模块，我会立即得到一个测试失败。
*   对于每个 bug，我可以快速添加一个非回归测试。
*   重构很容易:你所要做的就是运行测试，查看故障并修复代码。当测试通过时，你就知道你完成了。
*   编写测试很容易:依赖注入由于鸭子类型化而变得微不足道，并且您可以对任何东西进行猴子修补或模仿！另外，`pytest`很牛逼！
*   Python 的静态分析不起作用，pylint 很慢，而且很难配置。它没有捕捉到大量的错误，而且常常是错误的。
*   类型注释是没有用的(毕竟，解释器对它们几乎不做任何事情)，除非是为了文档的目的。

*注*:我现在认为**这些说法大部分都是错的**，但那是我当时相信的。

# 改变主意

所以我在那里。工具和类型系统并不重要，重要的是测试以及编写它们有多容易。我不需要类型系统，因为测试已经足够了。

<center>⁂</center>

天哪，难道我错了…这里有一个导致我泡沫破灭的事情清单。

## 一些棉绒

### pyflakes

我开始用 [pyflakes](https://github.com/PyCQA/pyflakes) 搭配 [vim-ale](https://github.com/w0rp/ale) <sup id="fnref1">[1](#fn1)</sup> 。

pyflakes 非常容易使用，不需要配置，速度很快。

突然一大堆 bug 消失了:pyflakes 非常擅长发现拼错的变量或者遗漏的导入。

因此，编写测试仅仅是为了查找拼写错误的变量或缺失的导入可能有些矫枉过正？

当然，pyflakes 不会捕捉其他错误，比如调用参数数量不正确的函数，但是在文件保存后立即捕捉这些错误*还是很好的，而不是在测试失败后。*

### pylint

我已经提到过 [pylint 是如何非常有用的](https://dmerej.info/blog/post/some-pylint-tips/)，如果你花时间正确地配置它，所以我不会在这里重复。

尽管如此，我还是了解到 Python 静态分析器并不一定要糟糕，而且可以比测试更快地发现缺陷。

今天，我在所有的 Python 项目中使用 pyflakes、pylint 和其他一些 linters。你可以在[我如何 lint 我的 Python](https://dmerej.info/blog/post/how-i-lint/) 中读到更多。

在这一点上，我改变了一点想法。它们是有用的工具，而不是测试。但是我仍然认为类型并不像测试那样有用。

## 一次谈话

然后我看了加里·伯恩哈特的一个名为[意识形态](https://www.destroyallsoftware.com/talks/ideology)的演讲。我强烈推荐。

摘录:

> [这很重要]主要是因为它会让你成为更好的程序员，但也因为它会阻止你发表愤怒的黑客新闻评论。

我不会在这里总结这个演讲，但是它帮助我认识到当我声称“我有测试，所以我不需要类型”时我真正的意思。

但这相当抽象。改变我对测试的看法需要我使用 C++和 Python 之外的编程语言。

## Javascript

去年，我不得不在一个 Javascript 项目中进行重构。

根本没有测试，添加它们将会是相当具有挑战性的。

但是到处都有[流](https://flow.org/)类型的注释。这些错误并不总是容易理解，有时甚至是误导性的，但是 flow 确实帮助我获得了信心，在重构过程中我没有破坏所有的东西。

这向我展示了“动态”语言中的类型注释实际上是值得的。

尽管如此，我确信我们应该从第一天开始就为这个项目编写测试，不要让产品代码在没有测试的情况下增长。

类型注释是必需的*，因为*它们不是测试，当然测试本身就足够了。

## 生锈

铁锈是棺材上的最后一颗钉子。

我开始在 Rust 中重新编写一个 Python 项目，突然之间，所有这些关于“如果它能编译，它就能工作”和“类型系统使单元测试变得不必要”的东西终于开始变得有意义了。

以下是我使用 Rust 学到的东西:

*   指定类型很容易:您需要注释的只是函数参数和返回值，其他一切都由编译器推断出来。
*   错误消息和警告几乎总是指示一个错误或一种低效的做事方式。
*   而类型其实可以帮到你！

让我举几个例子:

*   任何可能失败的东西都会返回一个*类型*(比如`Option`或`Result`)，迫使你处理错误。
*   有一个`Copy` *特征*告诉你一个类型是否有复制语义和移动语义。
*   `Send`和`Sync`特征定义了如何跨线程使用一个类型。
*   还有更多！

同时，在 Rust 上使用 TDD 是令人愉快的，甚至在 Rust book 的[中被推荐。我甚至写了一个测试来确保某个 bug 会在编译时被捕获*。*](https://doc.rust-lang.org/stable/book/second-edition/index.html)

这就是我如何完全改变了我的想法:类型系统不一定很糟糕，它们可能非常有用，你可以将它们与测试结合起来，以获得两个世界的最佳效果。

# 结论和引子

你看，我们很难发现自己代码中的错误。

这就是为什么我们尝试并增加这些技术，希望每种技术都能发现不同类型的错误:

*   在代码评审或同行编程期间，我们要求其他人查看我们的代码
*   我们让其他人帮我们找出代码中的缺陷，我们称之为“QA 过程”
*   我们使用静态分析器来自动发现代码中的问题
*   我们使用测试来尝试和证明代码能够正常工作
*   我们使用 TDD 从“生产”的角度(当我们从红色到绿色)和“质量”的角度(当我们从绿色到重构)来看代码。
*   我们使用静态类型或类型注释，以补充上述所有方法的方式来提高代码的正确性。

今天到此为止。

如果你仍然相信 Python 不需要类型，只要你有一个好的测试，我会在以后的博客文章中给你一些非常具体的例子。

干杯！

*感谢您阅读到目前为止:)*

我很想听听你的想法，所以请在下面留下你的评论，或者阅读[反馈页面](https://dmerej.info/blog/pages/feedback/)，了解更多与我联系的方式。

* * *

1.  如果你对使用这种棉绒感兴趣，你可以看看我关于这个主题的博客文章